(function(){"use strict";try{if(typeof document<"u"){var a=document.createElement("style");a.appendChild(document.createTextNode(`.maptalks-zoom-slider a.maptalks-zoom-zoomin{background-image:url("data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='12'%20height='12'%20viewBox='0%200%2012%2012'%3e%3crect%20width='2'%20height='12'%20transform='translate(5)'%20fill='%23868686'/%3e%3crect%20width='2'%20height='12'%20transform='translate(12%205)%20rotate(90)'%20fill='%23868686'/%3e%3c/svg%3e")}.maptalks-zoom-slider a.maptalks-zoom-zoomout{height:29px;background-image:url("data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='12'%20height='2'%20viewBox='0%200%2012%202'%3e%3crect%20id='矩形_2'%20data-name='矩形%202'%20width='2'%20height='12'%20transform='translate(12)%20rotate(90)'%20fill='%23868686'/%3e%3c/svg%3e");border-top:none}.maptalks-compass{width:30px;height:30px;background:#fff;border:1px solid #9d9d9d;border-radius:50%;box-sizing:border-box;background-image:url("data:image/svg+xml,%3csvg%20id='指南针10x18'%20xmlns='http://www.w3.org/2000/svg'%20width='10'%20height='18'%20viewBox='0%200%2010%2018'%3e%3cpath%20id='路径_1'%20data-name='路径%201'%20d='M3,9H0L5,0l5,9H7A2,2,0,0,0,3,9Z'%20fill='red'/%3e%3cpath%20id='路径_2'%20data-name='路径%202'%20d='M5,11H5L0,2H3A2,2,0,1,0,7,2h3Z'%20transform='translate(0%207)'%20fill='%239d9d9d'/%3e%3c/svg%3e");background-repeat:no-repeat;background-position:center;cursor:pointer}.maptalks-reset{width:30px;height:30px;background:#fff;border:1px solid #9d9d9d;box-sizing:border-box;background-image:url("data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='13.997'%20height='14'%20viewBox='0%200%2013.997%2014'%3e%3cpath%20id='路径_1'%20data-name='路径%201'%20d='M-1610.58-1267.16a5.468,5.468,0,0,1,3.521,1.421l.192.175-1.713,1.776c-.1.128-.179.284.008.389a.587.587,0,0,0,.172.049h4.454a.257.257,0,0,0,.183-.07.252.252,0,0,0,.071-.182v-4.481c0-.188-.089-.374-.208-.344a.342.342,0,0,0-.157.09l-1.565,1.549-.182-.173a7.078,7.078,0,0,0-3.151-1.737,6.758,6.758,0,0,0-3.535.063,7.3,7.3,0,0,0-3.1,1.816,7.192,7.192,0,0,0-1.833,3.069h0a6.846,6.846,0,0,0,.632,5.279,7.017,7.017,0,0,0,4.229,3.3h0a7,7,0,0,0,5.293-.6,7.055,7.055,0,0,0,3.369-4.14.871.871,0,0,0-.07-.626.84.84,0,0,0-1.113-.294.726.726,0,0,0-.365.471h0a5.542,5.542,0,0,1-1.7,2.661,5.585,5.585,0,0,1-2.9,1.287,5.468,5.468,0,0,1-3.143-.5,5.31,5.31,0,0,1-2.3-2.158h0a5.169,5.169,0,0,1-.645-3.649,5.489,5.489,0,0,1,1.948-3.249,5.454,5.454,0,0,1,3.608-1.192Z'%20transform='translate(1617.689%201268.903)'%20fill='%23868686'%20fill-rule='evenodd'/%3e%3c/svg%3e");background-repeat:no-repeat;background-position:center;cursor:pointer}.maptalks-layer-switcher button{width:28px;height:28px;background:url("data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='18'%20height='16'%20viewBox='0%200%2018%2016'%3e%3cpath%20id='图层'%20d='M17.156,74.864a.833.833,0,0,0-.323.065h-.007L9,78.222l-7.826-3.29H1.166A.839.839,0,0,0,.088,75.4a.862.862,0,0,0,.433,1.109h0L8.67,79.939h.008a.825.825,0,0,0,.645,0H9.33l8.149-3.425h0a.86.86,0,0,0,.5-.959A.847.847,0,0,0,17.156,74.864ZM.521,69.085h0L8.67,72.51h.008a.822.822,0,0,0,.645,0H9.33l8.149-3.425h0a.862.862,0,0,0,0-1.584h0L9.33,64.075H9.323a.827.827,0,0,0-.645,0H8.67L.521,67.5h0a.862.862,0,0,0,0,1.583ZM17.156,71.15a.833.833,0,0,0-.323.065h0l0,0h0L9,74.508l-7.826-3.29h0l0,0h0a.839.839,0,0,0-1.082.472A.862.862,0,0,0,.521,72.8h0L8.67,76.225h.008a.825.825,0,0,0,.645,0H9.33L17.479,72.8h0a.86.86,0,0,0,.5-.959A.847.847,0,0,0,17.156,71.15Z'%20transform='translate(0%20-64.007)'%20fill='%236a97d9'/%3e%3c/svg%3e") no-repeat;background-position:center;background-color:#fff;border:1px solid #b8b8b8}.maptalks-attribution{display:none!important}.maptalks-zoom{text-align:center}.maptalks-zoom .maptalks-zoom-zoomlevel{display:block;width:30px;height:30px;background:#fff;color:#868686;border:1px solid #9d9d9d;line-height:26px;text-align:center;box-sizing:border-box}.maptalks-zoom .maptalks-zoom-zoomlevel .maptalks-zoom-zoomlevel-text{display:inline-block;font-size:12px;transform:scale(.8)}.maptalks-zoom-slider{margin-top:6px}.maptalks-zoom-slider a.maptalks-zoom-zoomin,.maptalks-zoom-slider a.maptalks-zoom-zoomout{display:block;font-size:16px;width:30px;height:30px;border:1px solid #9d9d9d;background:#fff;line-height:28px;text-decoration:none;background-repeat:no-repeat;background-position:center;box-sizing:border-box}.maptalks-zoom-slider a.maptalks-zoom-zoomin{background-image:url("data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='12'%20height='12'%20viewBox='0%200%2012%2012'%3e%3crect%20width='2'%20height='12'%20transform='translate(5)'%20fill='%23868686'/%3e%3crect%20width='2'%20height='12'%20transform='translate(12%205)%20rotate(90)'%20fill='%23868686'/%3e%3c/svg%3e")}.maptalks-zoom-slider a.maptalks-zoom-zoomout{height:29px;background-image:url("data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='12'%20height='2'%20viewBox='0%200%2012%202'%3e%3crect%20id='矩形_2'%20data-name='矩形%202'%20width='2'%20height='12'%20transform='translate(12)%20rotate(90)'%20fill='%23868686'/%3e%3c/svg%3e");border-top:none}.maptalks-compass{width:30px;height:30px;background:#fff;border:1px solid #9d9d9d;border-radius:50%;box-sizing:border-box;background-image:url("data:image/svg+xml,%3csvg%20id='指南针10x18'%20xmlns='http://www.w3.org/2000/svg'%20width='10'%20height='18'%20viewBox='0%200%2010%2018'%3e%3cpath%20id='路径_1'%20data-name='路径%201'%20d='M3,9H0L5,0l5,9H7A2,2,0,0,0,3,9Z'%20fill='red'/%3e%3cpath%20id='路径_2'%20data-name='路径%202'%20d='M5,11H5L0,2H3A2,2,0,1,0,7,2h3Z'%20transform='translate(0%207)'%20fill='%239d9d9d'/%3e%3c/svg%3e");background-repeat:no-repeat;background-position:center;cursor:pointer}.maptalks-reset{width:30px;height:30px;background:#fff;border:1px solid #9d9d9d;box-sizing:border-box;background-image:url("data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='13.997'%20height='14'%20viewBox='0%200%2013.997%2014'%3e%3cpath%20id='路径_1'%20data-name='路径%201'%20d='M-1610.58-1267.16a5.468,5.468,0,0,1,3.521,1.421l.192.175-1.713,1.776c-.1.128-.179.284.008.389a.587.587,0,0,0,.172.049h4.454a.257.257,0,0,0,.183-.07.252.252,0,0,0,.071-.182v-4.481c0-.188-.089-.374-.208-.344a.342.342,0,0,0-.157.09l-1.565,1.549-.182-.173a7.078,7.078,0,0,0-3.151-1.737,6.758,6.758,0,0,0-3.535.063,7.3,7.3,0,0,0-3.1,1.816,7.192,7.192,0,0,0-1.833,3.069h0a6.846,6.846,0,0,0,.632,5.279,7.017,7.017,0,0,0,4.229,3.3h0a7,7,0,0,0,5.293-.6,7.055,7.055,0,0,0,3.369-4.14.871.871,0,0,0-.07-.626.84.84,0,0,0-1.113-.294.726.726,0,0,0-.365.471h0a5.542,5.542,0,0,1-1.7,2.661,5.585,5.585,0,0,1-2.9,1.287,5.468,5.468,0,0,1-3.143-.5,5.31,5.31,0,0,1-2.3-2.158h0a5.169,5.169,0,0,1-.645-3.649,5.489,5.489,0,0,1,1.948-3.249,5.454,5.454,0,0,1,3.608-1.192Z'%20transform='translate(1617.689%201268.903)'%20fill='%23868686'%20fill-rule='evenodd'/%3e%3c/svg%3e");background-repeat:no-repeat;background-position:center;cursor:pointer}.maptalks-toolbar-vertical{margin:0;border:1px solid #b8b8b8;overflow:visible}.maptalks-toolbar-vertical ul,.maptalks-toolbar-horizonal ul{margin:0;padding:0}.maptalks-toolbar-vertical ul li+li{border-top:1px solid #ddd}.maptalks-toolbar-vertical li{text-align:center;list-style:none;line-height:28px;font-size:12px;color:#5a5a5a;background:#fff;min-width:10px;min-height:28px;position:relative;padding:0 10px}.maptalks-toolbar-vertical li:hover{color:#fff;background:#6a97d9}.maptalks-toolbar-vertical li .maptalks-dropMenu{padding:0;position:absolute;top:-1px;overflow:visible;border:1px solid #b8b8b8}.maptalks-toolbar-vertical li .maptalks-dropMenu li{list-style:none;min-width:95px;background:#606976;height:28px}.maptalks-toolbar-vertical li .maptalks-dropMenu li+li{border-top:1px solid #ddd}.maptalks-toolbar-vertical li .maptalks-dropMenu li a{color:#fff;display:block;line-height:27px;text-indent:33px;text-decoration:none;font-size:12px}.maptalks-toolbar-vertical li .maptalks-dropMenu em.maptalks-ico{display:block;width:5px;height:6px;position:absolute;top:12px;right:-4px}.maptalks-toolbar-vertical li .maptalks-dropMenu li.maptalks-on,.maptalks-toolbar-vertical li .maptalks-dropMenu li:hover{background:#4b545f}.maptalks-toolbar-horizonal{margin:0;overflow:visible}.maptalks-toolbar-horizonal li{text-align:left;line-height:28px;font-size:12px;color:#5a5a5a;padding:0 10px;list-style:none;min-width:28px;min-height:28px;float:left;background:#fff;border:1px solid #b8b8b8;position:relative}.maptalks-toolbar-horizonal ul li:not(:last-child){border-right-color:#ddd}.maptalks-toolbar-horizonal ul li+li{border-left:none}.maptalks-toolbar-horizonal li:hover{color:#fff;background:#6a97d9}.maptalks-toolbar-horizonal li .maptalks-dropMenu{display:block;position:absolute;left:-1px;overflow:visible}.maptalks-toolbar-horizonal li .maptalks-dropMenu li{list-style:none;min-width:95px;background:#606976;height:28px;border:1px solid #b8b8b8}.maptalks-toolbar-horizonal li .maptalks-dropMenu ul li:first-child{border-top:none}.maptalks-toolbar-horizonal li .maptalks-dropMenu ul li:not(:last-child){border-bottom-color:#ddd}.maptalks-toolbar-horizonal li .maptalks-dropMenu li+li{border-top:none}.maptalks-toolbar-horizonal li .maptalks-dropMenu li a{color:#fff;display:block;line-height:27px;text-indent:20px;text-decoration:none;font-size:12px}.maptalks-toolbar-horizonal li .maptalks-dropMenu em.maptalks-ico{display:block;width:5px;height:6px;position:absolute;top:-4px;left:12px}.maptalks-toolbar-horizonal .maptalks-dropMenu li:hover{background:#4b545f}.maptalks-toolbar-vertical li .maptalks-dropMenu li a:before,.maptalks-toolbar-horizonal li .maptalks-dropMenu li a:before{content:"";width:0;height:0;position:absolute;top:10px;left:14px;border-top:4px solid transparent;border-left:6px solid #fff;border-bottom:4px solid transparent}.maptalks-menu{background:#fff;padding:1px;width:172px;border:1px solid #b4b3b3}.maptalks-menu .maptalks-menu-items{color:#5a5756;margin:0;padding:0;font-size:12px}.maptalks-menu .maptalks-menu-items li{list-style:none;height:30px;line-height:30px;text-indent:16px}.maptalks-menu .maptalks-menu-items li:hover{background:#007fbe;color:#fff;cursor:pointer}.maptalks-menu .maptalks-menu-items li.maptalks-menu-splitter{list-style:none;height:2px;background:#ddd}.maptalks-msgBox{background:#fff;border:1px solid #b4b3b3;border-radius:3px}.maptalks-msgBox em.maptalks-ico{display:block;position:absolute;left:50%;margin-left:-5px;bottom:-10px;width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-top:10px solid #b4b3b3}.maptalks-msgBox em.maptalks-ico:after{content:"";width:0;height:0;position:absolute;left:-7px;top:-10px;border-left:7px solid transparent;border-right:7px solid transparent;border-top:9px solid #fff}.maptalks-msgBox h2{display:block;height:auto;line-height:30px;font-weight:700;font-size:14px;padding:0 30px 0 10px;margin:0;white-space:nowrap}.maptalks-msgBox a.maptalks-close{display:block;width:13px;height:13px;text-decoration:none;font-size:14px;color:#a5a5a5;font-weight:700;position:absolute;top:3px;right:6px}.maptalks-msgBox .maptalks-msgContent{font-size:12px;padding:10px;min-width:200px}.maptalks-panel{background:#fff;border:1px solid #b4b3b3;border-radius:3px}.maptalks-panel .maptalks-panel-content{padding:10px;min-width:200px;min-height:60px}.maptalks-panel a.maptalks-close{display:block;width:13px;height:13px;text-decoration:none;font-size:14px;color:#a5a5a5;font-weight:700;position:absolute;top:3px;right:6px}.maptalks-attribution{display:inline-block;opacity:1;color:#aeaeae;background:#fff;background-color:#ffffffb3;padding:0;font-size:13px;font-family:microsoft yahei,Helvetica Neue,Helvetica,sans-serif}.maptalks-attribution a{text-decoration:none;color:#8eafbe}.maptalks-attribution a:hover{text-decoration:underline}.maptalks-overview{background:#fff;border:1px solid #b4b3b3;width:100%;height:100%}.maptalks-overview-button{cursor:pointer;background:#fff;width:18px;height:18px;position:absolute;bottom:1px;right:1px;font:16px sans-serif;text-align:center;line-height:16px;border:1px solid #b4b3b3;color:#363539}.maptalks-layer-switcher ul{list-style:none}.maptalks-layer-switcher .panel>ul{padding-left:1em}.maptalks-layer-switcher .group>ul{padding-left:10px}.maptalks-layer-switcher .group+.group{padding-top:1em}.maptalks-layer-switcher label{text-overflow:ellipsis;overflow:hidden;display:inline-block;font-size:14px;white-space:nowrap;color:#5a5a5a}.maptalks-layer-switcher .group>label{font-weight:700;color:#5a5a5a;width:100%}.maptalks-layer-switcher .layer label{padding-top:5px;width:92%}.maptalks-layer-switcher input{margin:0 5px;position:relative;top:-2px}.maptalks-layer-switcher input[disabled=disabled]{cursor:not-allowed}.maptalks-layer-switcher input[disabled=disabled]+label{color:#666}.maptalks-layer-switcher button,.maptalks-layer-switcher .panel{border-radius:4px}.maptalks-layer-switcher button{width:28px;height:28px;background:url("data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='18'%20height='16'%20viewBox='0%200%2018%2016'%3e%3cpath%20id='图层'%20d='M17.156,74.864a.833.833,0,0,0-.323.065h-.007L9,78.222l-7.826-3.29H1.166A.839.839,0,0,0,.088,75.4a.862.862,0,0,0,.433,1.109h0L8.67,79.939h.008a.825.825,0,0,0,.645,0H9.33l8.149-3.425h0a.86.86,0,0,0,.5-.959A.847.847,0,0,0,17.156,74.864ZM.521,69.085h0L8.67,72.51h.008a.822.822,0,0,0,.645,0H9.33l8.149-3.425h0a.862.862,0,0,0,0-1.584h0L9.33,64.075H9.323a.827.827,0,0,0-.645,0H8.67L.521,67.5h0a.862.862,0,0,0,0,1.583ZM17.156,71.15a.833.833,0,0,0-.323.065h0l0,0h0L9,74.508l-7.826-3.29h0l0,0h0a.839.839,0,0,0-1.082.472A.862.862,0,0,0,.521,72.8h0L8.67,76.225h.008a.825.825,0,0,0,.645,0H9.33L17.479,72.8h0a.86.86,0,0,0,.5-.959A.847.847,0,0,0,17.156,71.15Z'%20transform='translate(0%20-64.007)'%20fill='%236a97d9'/%3e%3c/svg%3e") no-repeat;background-position:center;background-color:#fff;border:1px solid #b8b8b8}.maptalks-layer-switcher.shown button{display:none}.maptalks-layer-switcher .panel{background-color:#fff;display:none;overflow-y:auto;overflow-x:hidden;min-width:120px;max-width:400px;max-height:500px}.maptalks-layer-switcher li{white-space:nowrap}.maptalks-layer-switcher li.group{margin-right:1em}.maptalks-layer-switcher.shown .panel{display:block}.maptalks-layer-switcher ::-webkit-scrollbar{width:6px}.maptalks-layer-switcher ::-webkit-scrollbar-track{background-color:#1f1f1f}.maptalks-layer-switcher ::-webkit-scrollbar-thumb{border-radius:5px;background-color:#777}.maptalks-tooltip{display:block;background:#fff;border:1px solid #b4b3b3;padding:0 4px;height:24px;line-height:24px;font-size:14px;white-space:nowrap}@keyframes maptalksfadeIn{0%{opacity:0}to{opacity:1}}.mtk-ui-fadein{animation:maptalksfadeIn 2s}`)),document.head.appendChild(a)}}catch(t){console.error("vite-plugin-css-injected-by-js",t)}})();
(function(Fi,Fe){typeof exports=="object"&&typeof module<"u"?Fe(exports,require("vue")):typeof define=="function"&&define.amd?define(["exports","vue"],Fe):(Fi=typeof globalThis<"u"?globalThis:Fi||self,Fe(Fi["v-map"]={},Fi.Vue))})(this,function(Fi,Fe){"use strict";/*!
 * maptalks v1.0.0-rc.37
 * LICENSE : BSD-3-Clause
 * (c) 2016-2024 maptalks.org
 */var X3="1.0.0-rc.37",Kn=Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]"&&!process.versions.electron&&!process.versions.nw&&!process.versions["node-webkit"];function A1(){return typeof globalThis<"u"?globalThis:global||self}var Li={isTest:!1,idleLog:!1,idleForceTimeThreshold:48,workerCount:A1().MAPTALKS_WORKER_COUNT||0,messagePostRatioPerWorker:.3,maxFPS:0};function Qe(){return Date.now()}function Gt(r){for(var t=[],e=1;e<arguments.length;e++)t[e-1]=arguments[e];for(var n=0;n<t.length;n++){var i=t[n];for(var o in i)r[o]=i[o]}return r}function U(r){return r==null}function It(r){return typeof r=="number"&&!isNaN(r)}function Cs(r){return(r|0)===r}function kr(r){return typeof r=="object"&&!!r}function Se(r){return U(r)?!1:typeof r=="string"||r.constructor!==null&&r.constructor===String}function ze(r){return U(r)?!1:typeof r=="function"||r.constructor!==null&&r.constructor===Function}var Y3=Object.prototype.hasOwnProperty;function ga(r,t){return Y3.call(r,t)}function q3(r,t){return r.join?r.join(t||","):Array.prototype.join.call(r,t||",")}function J3(r){var t;for(t in r)return!1;return!t}var T1=Math.PI/180;function Gn(r){return r*T1}function Dp(r){return r/T1}var sh={};function M1(){return window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI}if(!Kn){var zi=navigator.userAgent.toLowerCase(),Fp=document.documentElement||{style:{}},ma="ActiveXObject"in window,Lp=zi.indexOf("webkit")!==-1,zp=zi.indexOf("phantom")!==-1,S1=zi.search("android [23]")!==-1,Hp=zi.indexOf("chrome")!==-1,C1=zi.indexOf("gecko")!==-1&&!Lp&&!window.opera&&!ma,K3=/iphone/i.test(zi)&&/micromessenger/i.test(zi),ah=typeof orientation<"u"||zi.indexOf("mobile")!==-1,P1=!window.PointerEvent&&window.MSPointerEvent,E1=window.PointerEvent&&navigator.pointerEnabled||P1,O1=ma&&"transition"in Fp.style,Np="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix&&!S1,k1="MozPerspective"in Fp.style,I1="OTransition"in Fp.style,Q3=(O1||Np||k1)&&!I1&&!zp,t5=typeof window<"u"&&ze(window.createImageBitmap),e5=typeof window<"u"&&ze(window.ResizeObserver),n5=typeof window<"u"&&ze(window.btoa),r5=typeof window<"u"&&ze(window.Proxy),i5=typeof window<"u"&&ze(window.requestIdleCallback),R1=0;Hp&&(R1=zi.match(/chrome\/([\d.]+)/)[1]);var o5=!zp&&(E1||"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch),s5=typeof window<"u"&&"WebGLRenderingContext"in window,D1=M1(),Bp=!1;try{var a5=new OffscreenCanvas(2,2);a5.getContext("2d"),Bp=!0}catch{Bp=!1}var F1=!1;try{window.addEventListener("testPassive",function(){},{get passive(){return F1=!0,!0}})}catch{}sh={IS_NODE:Kn,isTest:!1,ie:ma,ielt9:ma&&!document.addEventListener,edge:"msLaunchUri"in navigator&&!("documentMode"in document),webkit:Lp,gecko:C1,android:zi.indexOf("android")!==-1,android23:S1,chrome:Hp,chromeVersion:R1,safari:!Hp&&zi.indexOf("safari")!==-1,phantomjs:zp,ie3d:O1,webkit3d:Np,gecko3d:k1,opera12:I1,any3d:Q3,iosWeixin:K3,mobile:ah,mobileWebkit:ah&&Lp,mobileWebkit3d:ah&&Np,mobileOpera:ah&&window.opera,mobileGecko:ah&&C1,touch:!!o5,msPointer:!!P1,pointer:!!E1,retina:D1>1,devicePixelRatio:D1,language:navigator.browserLanguage?navigator.browserLanguage:navigator.language,ie9:ma&&document.documentMode===9,ie10:ma&&document.documentMode===10,webgl:s5,imageBitMap:t5,resizeObserver:e5,btoa:n5,decodeImageInWorker:Bp,monitorDPRChange:!0,supportsPassive:F1,proxy:r5,requestIdleCallback:i5,checkDevicePixelRatio:function(){if(typeof window<"u"&&sh.monitorDPRChange){var r=M1(),t=r!==sh.devicePixelRatio;return t&&(sh.devicePixelRatio=r),t}return!1}}}var be=sh,jp=function(r,t){return jp=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,n){e.__proto__=n}||function(e,n){for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])},jp(r,t)};function Et(r,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");jp(r,t);function e(){this.constructor=r}r.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}var Vp=function(){return Vp=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++){e=arguments[n];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o])}return t},Vp.apply(this,arguments)};function L1(r){var t=typeof Symbol=="function"&&Symbol.iterator,e=t&&r[t],n=0;if(e)return e.call(r);if(r&&typeof r.length=="number")return{next:function(){return r&&n>=r.length&&(r=void 0),{value:r&&r[n++],done:!r}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function te(r,t){var e=typeof Symbol=="function"&&r[Symbol.iterator];if(!e)return r;var n=e.call(r),i,o=[],s;try{for(;(t===void 0||t-- >0)&&!(i=n.next()).done;)o.push(i.value)}catch(a){s={error:a}}finally{try{i&&!i.done&&(e=n.return)&&e.call(n)}finally{if(s)throw s.error}}return o}function Ee(r,t,e){if(arguments.length===2)for(var n=0,i=t.length,o;n<i;n++)(o||!(n in t))&&(o||(o=Array.prototype.slice.call(t,0,n)),o[n]=t[n]);return r.concat(o||Array.prototype.slice.call(t))}typeof SuppressedError=="function"&&SuppressedError;var z1=function(){function r(t,e,n){if(!U(t)&&!U(e)?(this.x=+t,this.y=+e,this.z=n):!U(t.x)&&!U(t.y)?(this.x=+t.x,this.y=+t.y,this.z=t.z):Array.isArray(t)&&(this.x=+t[0],this.y=+t[1],this.z=t[2]),this._isNaN())throw new Error("Position is NaN")}return r.prototype.set=function(t,e,n){return this.x=t,this.y=e,this.z=n||0,this},r.prototype._abs=function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this},r.prototype._round=function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},r.prototype._ceil=function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},r.prototype.distanceTo=function(t){var e=t.x-this.x,n=t.y-this.y;return Math.sqrt(e*e+n*n)},r.prototype.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},r.prototype._floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},r.prototype._add=function(t,e){return U(t.x)?U(t[0])?(this.x+=t,this.y+=e):(this.x+=t[0],this.y+=t[1]):(this.x+=t.x,this.y+=t.y),this},r.prototype._sub=function(t,e){return U(t.x)?U(t[0])?(this.x-=t,this.y-=e):(this.x-=t[0],this.y-=t[1]):(this.x-=t.x,this.y-=t.y),this},r.prototype._substract=function(t,e){return It(e)?this._sub(t,e):this._sub(t)},r.prototype.substract=function(t,e){return this.sub(t,e)},r.prototype._multi=function(t){return this.x*=t,this.y*=t,this},r.prototype.div=function(t){return this.multi(1/t)},r.prototype._div=function(t){return this._multi(1/t)},r.prototype._isNaN=function(){return isNaN(this.x)||isNaN(this.y)||It(this.z)&&isNaN(this.z)},r.prototype.isZero=function(){return this.x===0&&this.y===0},r.prototype.toArray=function(){return It(this.z)?[this.x,this.y,this.z]:[this.x,this.y]},r.prototype.toJSON=function(){var t={x:this.x,y:this.y};return It(this.z)&&(t.z=this.z),t},r}(),W=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.closeTo=function(e,n){return n||(n=0),this.x>=e.x-n&&this.x<=e.x+n&&this.y>=e.y-n&&this.y<=e.y+n},t.prototype.unit=function(){return this.copy()._unit()},t.prototype._unit=function(){return this._div(this.mag()),this},t.prototype.perp=function(){return this.copy()._perp()},t.prototype._perp=function(){var e;return e=te([-this.y,this.x],2),this.x=e[0],this.y=e[1],this},t.prototype.angleWith=function(e){return this.angleWithSep(e.x,e.y)},t.prototype.angleWithSep=function(e,n){return Math.atan2(this.x*n-this.y*e,this.x*e+this.y*n)},t.prototype._rotate=function(e){var n=Math.cos(e),i=Math.sin(e),o=n*this.x-i*this.y,s=i*this.x+n*this.y;return this.x=o,this.y=s,this},t.prototype.rotate=function(e){return this.copy()._rotate(e)},t.prototype.abs=function(){return new t(Math.abs(this.x),Math.abs(this.y))},t.prototype.round=function(){return new t(Math.round(this.x),Math.round(this.y))},t.prototype.ceil=function(){return new t(Math.ceil(this.x),Math.ceil(this.y))},t.prototype.floor=function(){return new t(Math.floor(this.x),Math.floor(this.y))},t.prototype.copy=function(){return new t(this.x,this.y,this.z)},t.prototype.toFixed=function(e){return new t(this.x.toFixed(e),this.y.toFixed(e),It(this.z)?this.z.toFixed(e):void 0)},t.prototype.add=function(e,n){var i,o;return U(e.x)?U(e[0])?(i=this.x+e,o=this.y+n):(i=this.x+e[0],o=this.y+e[1]):(i=this.x+e.x,o=this.y+e.y),new t(i,o)},t.prototype.sub=function(e,n){var i,o;return U(e.x)?U(e[0])?(i=this.x-e,o=this.y-n):(i=this.x-e[0],o=this.y-e[1]):(i=this.x-e.x,o=this.y-e.y),new t(i,o)},t.prototype.multi=function(e){return new t(this.x*e,this.y*e)},t.prototype.equals=function(e){return e instanceof this.constructor?this.x===e.x&&this.y===e.y&&this.z===e.z:!1},t}(z1),_o,lh;(function(){if(Kn){_o=function(o){return setTimeout(o,16)},lh=clearTimeout;return}var r,t,e=1e3/30;function n(o){return setTimeout(o,e)}function i(o){return window["webkit"+o]||window["moz"+o]||window["ms"+o]}typeof window<"u"?(r=window.requestAnimationFrame||i("RequestAnimationFrame")||n,t=window.cancelAnimationFrame||i("CancelAnimationFrame")||i("CancelRequestAnimationFrame")||function(o){window.clearTimeout(o)}):(r=n,t=clearTimeout),_o=function(o){return r(o)},lh=function(o){o&&t(o)}})();function Ps(r){var t="data:image/svg+xml";return r.length>4&&r.slice(-4)===".svg"?1:r.slice(0,t.length)===t?2:0}function hh(r,t){if(Kn&&hh.node){hh.node(r,t);return}r.src=t[0]}var l5=0;function bo(){return l5++}var H1=bo;function uh(r){return!r||!Se(r)?r:JSON.parse(r)}function ai(){for(var r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];for(var e=r[0],n=1;n<r.length;n++){var i=r[n];if(i&&i.length)for(var o=0,s=i.length;o<s;o++)e.push(i[o])}return e.length}function uc(r,t){var e=t.indexOf(r);e>-1&&t.splice(e,1)}function Es(r,t,e){if(!Array.isArray(r))return e?t.call(e,r):t(r);for(var n=[],i,o,s=0,a=r.length;s<a;s++){if(i=r[s],U(i)){n.push(null);continue}Array.isArray(i)?n.push(Es(i,t,e)):(o=e?t.call(e,i):t(i),n.push(o))}return n}function se(r,t){return r===void 0?t:r}function Br(r){return Math.sign?Math.sign(r):(r=+r,r===0||isNaN(r)?Number(r):r>0?1:-1)}function h5(r){if(Math.log2)return Math.log2(r);var t=Math.log(r)*Math.LOG2E,e=Math.round(t);return Math.abs(e-t)<1e-14?e:t}function cc(r,t,e){return r*(1-e)+t*e}function Os(r,t,e){if(r===e||r===t)return r;var n=e-t,i=((r-t)%n+n)%n+t;return i}function fc(r,t,e){return Math.min(e,Math.max(t,r))}function on(r){return Array.isArray(r)&&r.length>0}var u5=/^([a-z][a-z\d+\-.]*:)?\/\//i;function N1(r){return u5.test(r)}var B1=/^url\((['"])(.+)\1\)$/i,j1=/^url\(([^'"].*[^'"])\)$/i;function V1(r){return Se(r)?j1.test(r)?1:B1.test(r)?2:3:0}function dc(r){var t=V1(r),e;return t===3?r:t===1?(e=j1.exec(r),e[1]):t===2?(e=B1.exec(r),e[2]):r}var c5="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function G1(r){if(be.btoa)return window.btoa(r);for(var t=String(r),e="",n=void 0,i=void 0,o=0,s=c5;t.charAt(o|0)||(s="=",o%1);e+=s.charAt(63&n>>8-o%1*8)){if(i=t.charCodeAt(o+=3/4),i>255)throw new Error("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");n=n<<8|i}return e}function U1(r,t){for(var e=atob(r),n=new ArrayBuffer(e.length),i=new Uint8Array(n),o=0;o<e.length;o++)i[o]=e.charCodeAt(o)&255;var s=new Blob([n],{type:t});return s}function pc(r,t,e,n){var i=e-r,o=n-t;return Math.atan2(o,i)}var Gp="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";function gc(r,t){if(!r&&!t)return!0;if(!r||!t)return!1;for(var e in r)if(e==="center"){if(!t[e]||!$1(r[e][0],t[e][0])||!$1(r[e][1],t[e][1]))return!1}else if(r[e]!==t[e])return!1;return!0}function $1(r,t,e){return e==null&&(e=1e-6),r>=t-e&&r<=t+e}function Up(r,t,e,n){r===void 0&&(r=100),t===void 0&&(t=4),e===void 0&&(e=null),n===void 0&&(n=null),r||(r=100),t||(t=4);var i=this,o=this.isVisible();t*=2,this._flashTimeout&&clearTimeout(this._flashTimeout);function s(){if(t===0){o?i.show():i.hide(),e&&(n?e.call(n):e());return}t%2===0?i.hide():i.show(),t--,i._flashTimeout=setTimeout(s,r)}return this._flashTimeout=setTimeout(s,r),this}function f5(r,t){for(var e=Object.getOwnPropertyNames(t),n=0;n<e.length;n++){var i=e[n],o=Object.getOwnPropertyDescriptor(t,i);o&&o.configurable&&r[i]===void 0&&Object.defineProperty(r,i,o)}return r}function ch(r,t){r===void 0&&(r=[]),t===void 0&&(t="_pt");for(var e=[],n=0,i=r.length;n<i;n++){var o=r[n];if(!o){e.push(null);continue}o[t]||(o[t]=new W(0,0));var s=o[t];s.x=0,s.y=0,e.push(s)}return e}function $p(r,t){t(r.data)}function mc(r){if(r&&r.indexOf("http://")===0||r.indexOf("https://")===0)return r;var t=document.createElement("a");return t.href=r,r=t.href,t=null,r}var fh={cssWidth:"1px",cssHeight:"1px",width:1,height:1};function Wp(r,t){t===void 0&&(t=1);var e=r.width,n=r.height;return fh.cssWidth=e+"px",fh.cssHeight=n+"px",fh.width=Math.round(e*t),fh.height=Math.round(n*t),fh}var dh="_maptalks__internal_layer_",W1=["MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"],Z1=["FeatureCollection","Feature","Point","LineString","Polygon"].concat(W1),X1=["markerFile","polygonPatternFile","linePatternFile","markerFillPatternFile","markerLinePatternFile"],d5=[["markerWidth","markerHeight"],[],[null,"lineWidth"],[],[null,"markerLineWidth"]],p5={lineWidth:1,lineOpacity:1,lineDx:1,lineDy:1,polygonOpacity:1,markerWidth:1,markerHeight:1,markerDx:1,markerDy:1,markerOpacity:1,markerFillOpacity:1,markerLineWidth:1,markerLineOpacity:1,textSize:1,textOpacity:1,textHaloRadius:1,textWrapWidth:1,textLineSpacing:1,textDx:1,textDy:1},g5=["lineColor","polygonFill","markerFill","markerLineColor","textFill"],Y1=14,kn=function(){function r(t,e){It(t)&&It(e)?(this.width=t,this.height=e):It(t.width)?(this.width=t.width,this.height=t.height):Array.isArray(t)&&(this.width=t[0],this.height=t[1])}return r.prototype.copy=function(){return new r(this.width,this.height)},r.prototype.add=function(t,e){var n,i;return t instanceof r?(n=this.width+t.width,i=this.height+t.height):(n=this.width+t,i=this.height+e),new r(n,i)},r.prototype.equals=function(t){return this.width===t.width&&this.height===t.height},r.prototype.multi=function(t){return new r(this.width*t,this.height*t)},r.prototype._multi=function(t){return this.width*=t,this.height*=t,this},r.prototype._round=function(){return this.width=Math.round(this.width),this.height=Math.round(this.height),this},r.prototype.toPoint=function(){return new W(this.width,this.height)},r.prototype.toArray=function(){return[this.width,this.height]},r.prototype.toJSON=function(){return{width:this.width,height:this.height}},r}(),Xo="";function Zp(r){return r.trim?r.trim():r.replace(/^\s+|\s+$/g,"")}function q1(r,t,e){if(!r)return r;for(;r.indexOf(t)>-1;)r=r.replace(t,e);return r}var m5=/[\b\t\r\v\f]/igm;function yc(r){return Se(r)?r.replace(m5,Xo):r}function J1(r){return Zp(r).split(/\s+/)}var K1=typeof document<"u"?document.createElement("canvas").getContext("2d"):null;function Yo(r,t){return Yo.node?Yo.node(r,t):(K1.font=t,K1.measureText(r).width)}function Xp(r,t,e){var n=Yo(r,t);return new kn(n,e||Y1)}function Yp(r,t,e,n){if(!r||r.length===0)return[{text:"",width:0}];var i=U(n)?Yo(r,t):n,o=i/r.length,s=Math.floor(e/o/2);if(o>=e||s<=0)return[{text:"",width:e}];if(i<=e)return[{text:r,width:i}];for(var a=[],l=r.substring(0,s),h=o*s,u=s,c=r.length;u<c;u++){var f=r[u],d=Yo(l+f);d>=e?(a.push({text:l,width:h}),l=r.substring(u,s+u),u+=s-1,h=o*s):(l+=f,h=d),u>=c-1&&(h=Yo(l),a.push({text:l,width:h}))}return a}var Q1=["{","}"];function vc(r,t){if(!Se(r))return r;function e(c){if(!t)return Xo;var f=t[c];return U(f)?Xo:Array.isArray(f)?f.join():f}for(var n=te(Q1,2),i=n[0],o=n[1],s=y5(r),a=0,l=s.length;a<l;a++){var h=s[a],u=e(h);r=q1(r,"".concat(i).concat(h).concat(o),u)}return r}function y5(r){r+=Xo;for(var t=te(Q1,2),e=t[0],n=t[1],i=[],o=!1,s=Xo,a=0,l=r.length;a<l;a++){var h=r[a];!o&&h===e&&(o=!0),h===e&&o&&(s=Xo),o&&h!==e&&h!==n&&(s+=h),h===n&&s&&(o=!1,i.push(s),s=Xo)}return i}function xc(r,t){It(r)&&(r+=""),r=r||"";var e=t.textMaxHeight||0,n=Jp(r,t);return e&&e<n.size.height&&(n.size.height=e),n}function wo(r,t,e){var n=r.width,i=r.height,o,s;return t==="left"?o=-n:t==="right"?o=0:o=-n/2,e==="top"?s=-i:e==="bottom"?s=0:s=-i/2,new W(o,s)}var tx="sans-serif",ex=14;function qp(r){if(r.textFont)return r.textFont;var t=r.textSize;return U(t)&&(t=ex),(r.textStyle&&r.textStyle!=="normal"?r.textStyle+" ":"")+(r.textWeight&&r.textWeight!=="normal"?r.textWeight+" ":"")+t+"px "+(r.textFaceName&&v5(r.textFaceName)||tx)}function v5(r){for(var t=r.split(","),e=0;e<t.length;e++)t[e].trim&&(t[e]=t[e].trim()),t[e].indexOf(" ")>0&&t[e][0]!=='"'&&t[e][0]!=="'"&&(t[e]='"'+t[e]+'"');return t.join(",")}function Jp(r,t){var e=qp(t),n=t.textLineSpacing||0,i=Xp(r,e,t.textSize),o=i.width,s=i.height,a=t.textWrapCharacter||`
`,l=[],h=t.textWrapWidth;(!h||h>o)&&(h=o),Se(r)||(r+="");var u=0;if(a&&r.indexOf(a)>=0)for(var c=r.split(a),f=0,d=c.length;f<d;f++){var p=c[f],g=Yo(p,e);if(g>h)for(var m=Yp(p,e,h,g),y=0,x=m.length;y<x;y++){var v=m[y].width;v>u&&(u=v),l.push({text:m[y].text,size:new kn(v,s)})}else g>u&&(u=g),l.push({text:p,size:new kn(g,s)})}else if(o>h)for(var m=Yp(r,e,h,o),f=0;f<m.length;f++){var v=m[f].width;v>u&&(u=v),l.push({text:m[f].text,size:new kn(v,s)})}else o>u&&(u=o),l.push({text:r,size:i});var _=l.length,w=new kn(u,s*_+n*(_-1));return{total:_,size:w,rows:l,rawSize:i}}function Kp(r){var t=0,e=r&&r.length||0;if(!e)return t;for(var n,i=0;i<e;i++)n=r.charCodeAt(i),t=(t<<5)-t+n,t=t&t;return t}var x5=function(r){return r[0]},_c=Kn?x5:function(r){for(var t=document.documentElement&&document.documentElement.style||{},e=0;e<r.length;e++)if(r[e]in t)return r[e];return!1},ya=_c(["transform","WebkitTransform","OTransform","MozTransform","msTransform"]),_5=_c(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"]),bc=_c(["transition","WebkitTransition","OTransition","MozTransition","msTransition"]);_c(["filter","WebkitFilter","OFilter","MozFilter","msFilter"]);function de(r,t){var e=document.createElement(r);return t&&Qp(e,t),e}function nx(r,t,e){var n=de(r);return t&&Tc(n,t),e&&e.appendChild(n),n}function va(r){if(!r)return this;if(be.ielt9||be.ie9){var t=de("div");t.appendChild(r),t.innerHTML="",t=null}else r.parentNode&&r.parentNode.removeChild(r);return this}function Hi(r,t,e,n){if(!r||!r.addEventListener||!t||!e)return this;for(var i=function(h){h||(h=window.event),e.call(n||r,h)},o=t.split(" "),s=o.length-1;s>=0;s--){var a=o[s];if(a){r["Z__"+a]||(r["Z__"+a]=[]);var l=rx(r,a,e);l>=0&&(console.warn(r,"find '".concat(a,"' handler:"),e," The old listener function will be removed"),ks(r,a,e)),r["Z__"+a].push({callback:i,src:e}),r.addEventListener(a,i,be.supportsPassive?{capture:!1,passive:!1}:!1)}}return this}function ks(r,t,e){function n(f,d){f==="mousewheel"&&be.gecko&&(f="DOMMouseScroll"),r.removeEventListener(f,d,!1)}if(!r||!r.removeEventListener||!t)return this;for(var i=t.split(" "),o=i.length-1;o>=0;o--){var s=i[o];if(s){if(!e&&r["Z__"+s]){for(var a=r["Z__"+s],l=0,h=a.length;l<h;l++)n(a[l].callback);return delete r["Z__"+s],this}var u=rx(r,s,e);if(u<0)return this;var c=r["Z__"+s][u];n(s,c.callback),r["Z__"+s].splice(u,1)}}return this}function rx(r,t,e){if(!r||!r["Z__"+t]||!e)return-1;for(var n=r["Z__"+t],i=0,o=n.length;i<o;i++)if(n[i].src===e)return i;return-1}function Qi(r){return r.preventDefault?r.preventDefault():r.returnValue=!1,this}function jr(r){return r._cancelBubble=!0,r.stopPropagation?r.stopPropagation():r.cancelBubble=!0,this}function b5(r){return r.onselectstart=function(){return!1},r.ondragstart=function(){return!1},r.setAttribute("unselectable","on"),this}function wc(r,t){return r?(be.any3d?A5(r,t):(r.style.left=t.x+"px",r.style.top=t.y+"px"),t):null}function Ac(r){var t=window.getComputedStyle(r),e=[parseInt(t["padding-left"]),parseInt(t["padding-top"])],n=r.getBoundingClientRect(),i=r.offsetWidth,o=r.offsetHeight,s=i?n.width/i:1,a=o?n.height/o:1;return r.__position=[n.left+e[0],n.top+e[1],s,a],r.__position}function li(r,t){r||(r=window.event);var e=t.__position;e||(e=Ac(t));var n=r;return n.touches&&n.touches.length&&(r=n.touches[0]),n.changedTouches&&n.changedTouches.length&&(r=n.changedTouches[0]),new W((r.clientX-e[0]-t.clientLeft)/e[2],(r.clientY-e[1]-t.clientTop)/e[3])}function w5(r,t){var e=r.length-t.length;return e>=0&&r.indexOf(t,e)===e}function Tc(r,t){var e=r.style.cssText;return w5(e,";")||(e+=";"),r.style.cssText=e+t,this}function ix(r,t){if(r.classList!==void 0)return r.classList.contains(t);var e=ox(r);return e.length>0&&new RegExp("(^|\\s)"+t+"(\\s|$)").test(e)}function xa(r,t){if(r.classList!==void 0&&!ix(r,t))for(var e=J1(t),n=0,i=e.length;n<i;n++)r.classList.add(e[n]);else{var o=ox(r);Qp(r,(o?o+" ":"")+t)}return this}function Qp(r,t){return U(r.className.baseVal)?r.className=t:r.className.baseVal=t,this}function ox(r){return U(r.className.baseVal)?r.className:r.className.baseVal}function A5(r,t){var e=t||new W(0,0);return r.style[ya]=be.any3d?"translate3d("+e.x+"px,"+e.y+"px,0px)":"translate("+e.x+"px,"+e.y+"px)",this}function T5(r){return/<[a-z\][\s\S]*>/i.test(r)}function M5(r,t){var e=S5(r);Se(t)?e.innerHTML=t:e.appendChild(t);var n=new kn(e.clientWidth,e.clientHeight);return va(e),n}function S5(r){var t=document.createElement(r);return t.style.cssText="position:absolute;left:-10000px;top:-10000px;",document.body.appendChild(t),t}var Ln=Hi,Un=ks;function Mc(r){return r&&(r==="mousemove"||r==="touchmove")}var sx=48;function ax(r,t){var e=Qe(),n=t||sx;return r._mousemoveTime&&e-r._mousemoveTime<n?!0:(r._mousemoveTime=e,!1)}var Ir={jsonp:function(r,t){var e="_maptalks_jsonp_"+bo();r.match(/\?/)?r+="&callback="+e:r+="?callback="+e;var n=document.createElement("script");return n.type="text/javascript",n.src=r,window[e]=function(i){t(null,i),document.getElementsByTagName("head")[0].removeChild(n),n=null,delete window[e]},document.getElementsByTagName("head")[0].appendChild(n),this},get:function(r,t,e){if(ze(t)){var n=e;e=t,t=n}if(Kn&&Ir.get.node)return Ir.get.node(r,e,t);var i=Ir._getClient(e);if(i.open("GET",r,!0),t){for(var o in t.headers)i.setRequestHeader(o,t.headers[o]);i.withCredentials=t.credentials==="include",t.responseType&&(i.responseType=t.responseType)}return i.send(null),i},post:function(r,t,e){var n;if(Se(r)){if(ze(t)){var i=e;e=t,t=i}t=t||{},n=t.postData}else{var i=e;n=t,t=r,r=t.url,e=i}if(Kn&&Ir.post.node)return t.url=r,Ir.post.node(t,n,e);var o=Ir._getClient(e);if(o.open("POST",t.url,!0),t.headers||(t.headers={}),t.headers["Content-Type"]||(t.headers["Content-Type"]="application/x-www-form-urlencoded"),"setRequestHeader"in o)for(var s in t.headers)t.headers.hasOwnProperty(s)&&o.setRequestHeader(s,t.headers[s]);return Se(n)||(n=JSON.stringify(n)),o.send(n),o},_wrapCallback:function(r,t){return function(){if(r.readyState===4)if(r.status===200)if(r.responseType==="arraybuffer"){var e=r.response;e.byteLength===0?t(new Error("http status 200 returned without content.")):t(null,{data:r.response,cacheControl:r.getResponseHeader("Cache-Control"),expires:r.getResponseHeader("Expires"),contentType:r.getResponseHeader("Content-Type")})}else t(null,r.responseText);else t(new Error(r.statusText+","+r.status))}},_getClient:function(r){var t;try{t=new XMLHttpRequest}catch{try{t=new ActiveXObject("Msxml2.XMLHTTP")}catch{try{t=new ActiveXObject("Microsoft.XMLHTTP")}catch{}}}return t.onreadystatechange=Ir._wrapCallback(t,r),t},getArrayBuffer:function(r,t,e){if(ze(t)){var n=e;e=t,t=n}return t||(t={}),t.responseType="arraybuffer",Ir.get(r,t,e)},getImage:function(r,t,e){return Ir.getArrayBuffer(t,e,function(n,i){if(n)r.onerror&&r.onerror(n);else if(i){var o=window.URL||window.webkitURL,s=r.onload;r.onload=function(){s&&s(),o.revokeObjectURL(r.src)};var a=new Blob([new Uint8Array(i.data)],{type:i.contentType});r.cacheControl=i.cacheControl,r.expires=i.expires,r.src=i.data.byteLength?o.createObjectURL(a):Gp}})},getJSON:function(r,t,e){}};Ir.getJSON=function(r,t,e){if(ze(t)){var n=e;e=t,t=n}var i=function(o,s){var a=s?uh(s):null;e(o,a)};return t&&t.jsonp?Ir.jsonp(r,i):Ir.get(r,t,i)};var ph="",C5=/data:image\/.*;base64,/;function P5(){var r;return be.IS_NODE?console.error("Current environment does not support canvas dom"):r=de("canvas"),r}function E5(){var r;return be.decodeImageInWorker&&(r=new OffscreenCanvas(2,2)),r}function O5(r){return C5.test(r)}function k5(r){return r.indexOf("blob:")===0}function I5(r,t){return It(r)&&(r+=ph),It(t)&&(t+=ph),!r||!t?!1:r.includes?r.includes(t):r.indexOf(t)>-1}function lx(r,t){t===void 0&&(t={});for(var e in t){var n=t[e];if(!(!n||!n.target)&&I5(r,e)){var i=n.target;return r.replace(e,i)}}return ph}function R5(r){return r===void 0&&(r={imgUrl:"",jsonUrl:""}),new Promise(function(t,e){var n=r.imgUrl,i=r.jsonUrl;if(!n||!i){e(new Error("not find imgUrl/jsonUrl from options")),console.error(r);return}function o(a,l,h){a.width=l,a.height=h;var u=a.getContext("2d");return u.clearRect(0,0,l,h),u}function s(a,l){a===void 0&&(a={});var h=P5();if(!h){e(new Error("can not create canvas"));return}var u=[];for(var c in a){var f=a[c];u.push({name:c,spriteItem:f})}var d=E5(),p=r.sourceName||"";u.forEach(function(g){var m=g.name,y=g.spriteItem,x=y.x,v=y.y,_=y.width,w=y.height,b;if(d){var A=o(d,_,w);A.drawImage(l,x,v,_,w,0,0,_,w),b=d.transferToImageBitmap()}else{var A=o(h,_,w);A.drawImage(l,x,v,_,w,0,0,_,w),b=h.toDataURL()}g.resource=b,br.addResource(p+m,b)}),t(u)}Ir.getJSON(i,{},function(a,l){if(a){e(a);return}var h=new Image;h.onload=function(){s(l,h)},h.onerror=function(u){e(u)},Ir.getImage(h,n,{})})})}function D5(r){return new Promise(function(t,e){var n="",i=[],o="",s="",a="";if(Array.isArray(r)||r instanceof NodeList)i=r;else if(kr(r)){var l=r;n=l.url,i=l.symbols,o=l.fill,s=l.stroke,a=l.sourceName||""}else Se(r)&&(n=r);if(!n&&i&&i.length===0){e(new Error("not find svgs data"));return}var h=[],u=function(y,x){var v=L5(x);v&&(v.forEach(function(w){o&&(w.fill=o),s&&(w.stroke=s)}),br.addResource(a+y,v));var _={name:y,paths:v,body:x};h.push(_)};if(n&&Se(n)){fetch(n).then(function(y){return y.json()}).then(function(y){y.forEach(function(x){var v=x.name,_=x.body;u(v,_)}),t(h)}).catch(function(y){console.log(y),e(y)});return}if(i){for(var c=0,f=i.length;c<f;c++){var d=i[c],p=d.id,g=d.innerHTML,m="<xml><svg>".concat(g,"</svg></xml>");p&&u(p,m)}t(h);return}e(new Error("not support svgs params type"))})}var br={host:ph,resources:{},proxy:{},origin:{},fromJSON:function(r){try{Se(r)&&(r=JSON.parse(r)),kr(r)&&Gt(br,r)}catch(t){console.error(t)}},toJSON:function(){return{host:br.host,proxy:Gt({},br.proxy||{}),origin:Gt({},br.origin||{})}},getResource:function(r){return br.resources[r]},removeResource:function(r){delete br.resources[r]},addResource:function(r,t){if(br.resources[r]){console.warn("".concat(r," resource Already exists,the ").concat(r," Cannot be added,the resource name Cannot repeat "));return}br.resources[r]=t},updateResource:function(r,t){br.resources[r]=t},allResource:function(){return br.resources},loadSprite:R5,loadSvgs:D5};function hx(r){if(It(r)&&(r+=ph),!r)return console.error("resouce path is null,path:",r),r;if(!Se(r)||O5(r)||k5(r))return r;if(r[0]==="$")return br.getResource(r.substring(1,1/0))||"";var t=br.origin||{},e=N1(r);if(e&&kr(t)){var n=lx(r,t);return n||r}var i=br.proxy||{};if(kr(i)){var n=lx(r,i);if(n)return n}var o=br.host;return!e&&o&&Se(o)?"".concat(o).concat(r):mc(r)}var F5=new DOMParser;function Ni(r,t){return r?r[t]&&r[t].value:null}function L5(r){var t=F5.parseFromString(r,"text/xml"),e=t.querySelector("svg");if(!e)return null;for(var n=e.childNodes,i=[],o=e.attributes,s=Ni(o,"fill"),a=Ni(o,"fill-opacity"),l=Ni(o,"stroke"),h=Ni(o,"stroke-opacity"),u=Ni(o,"stroke-width"),c=0,f=n.length;c<f;c++){var d=n[c],p=d.attributes;if(p){var g=void 0,m=d.tagName||"",y=m.toLowerCase()==="path";if(y?g=Ni(p,"d"):g=d,!!g){var x=Ni(p,"fill")||s,v=Ni(p,"stroke")||l,_={path:g};if(x&&(_.fill=x,_["fill-opacity"]=Ni(p,"fill-opacity")||a||1),v&&(_.stroke=v,_["stroke-opacity"]=Ni(p,"stroke-opacity")||h||1,_["stroke-width"]=Ni(p,"stroke-width")||u||1),i.push(_),!y)for(var w in _)w!=="path"&&_.hasOwnProperty(w)&&d.setAttribute(w,_[w])}}}return i}let _a;const ux={width:100,height:10};function z5(){if(!_a){const{width:r,height:t}=ux;OffscreenCanvas?_a=new OffscreenCanvas(r,t):(_a=document.createElement("canvas"),_a.width=r,_a.height=t)}return _a}let cx=class{constructor(t,e={}){if(!Array.isArray(t)){console.error("colors is not array");return}if(t.length<2){console.error("colors.length should >1");return}this.colors=t;let n=1/0,i=-1/0;for(let o=0,s=t.length;o<s;o++){const a=t[o][0];n=Math.min(a,n),i=Math.max(a,i)}this.min=n,this.max=i,this.valueOffset=this.max-this.min,this.options=Object.assign({},ux,e),this._initImgData()}getImageData(){return this.imgData}_initImgData(){const t=z5(),{width:e,height:n}=this.options;t.width=e,t.height=n;const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);const o=i.createLinearGradient(0,0,t.width,0),{colors:s,valueOffset:a}=this;for(let l=0,h=s.length;l<h;l++){const[u,c]=s[l],f=(u-this.min)/a;o.addColorStop(f,c)}i.fillStyle=o,i.fillRect(0,0,t.width,t.height),this.imgData=i.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t),t=Math.min(t,this.max);const e=(t-this.min)/this.valueOffset;let n=Math.round(e*this.imgData.width);n=Math.min(n,this.imgData.width-1);const i=n*4,o=this.imgData.data[i],s=this.imgData.data[i+1],a=this.imgData.data[i+2],l=this.imgData.data[i+3];return[o,s,a,l]}};var H5=typeof Map=="function",gh;H5&&(gh=new Map);function fx(r,t){var e,n,i;if(!Cn(r))e=function(){return r},n=!0,i=!0;else{var o=r.stops&&typeof r.stops[0][0]=="object",s=o||r.property!==void 0,a=o||!s,l=r.type||t||"exponential",h;if(l==="exponential")h=dx;else if(l==="interval")h=j5;else if(l==="categorical")h=B5;else if(l==="identity")h=G5;else if(l==="color-interpolate")h=V5;else throw new Error('Unknown function type "'+l+'"');if(o){var u={},c=[];for(let d=0;d<r.stops.length;d++){var f=r.stops[d];u[f[0].zoom]===void 0&&(u[f[0].zoom]={zoom:f[0].zoom,type:r.type,property:r.property,default:r.default,stops:[]}),u[f[0].zoom].stops.push([f[0].value,f[1]])}for(let d in u)c.push([u[d].zoom,fx(u[d])]);e=function(d,p){const g=dx({stops:c,base:r.base},d)(d,p);return typeof g=="function"?g(d,p):g},n=!1,i=!1}else a?(e=function(d){const p=h(r,d);return typeof p=="function"?p(d):p},n=!0,i=!1):(e=function(d,p){const g=h(r,p?p[r.property]:null);return typeof g=="function"?g(d,p):g},n=!1,i=!0)}return e.isZoomConstant=i,e.isFeatureConstant=n,e}function N5(r,t,e){return r!==void 0?r:t!==void 0?t:null}function B5(r,t){for(let e=0;e<r.stops.length;e++)if(t===r.stops[e][0])return r.stops[e][1];return r.default}function j5(r,t){for(var e=0;e<r.stops.length&&!(t<r.stops[e][0]);e++);return r.stops[Math.max(e-1,0)][1]}function dx(r,t){for(var e=r.base!==void 0?r.base:1,n=0;!(n>=r.stops.length);){if(t<=r.stops[n][0])break;n++}return n===0?r.stops[n][1]:n===r.stops.length?r.stops[n-1][1]:gx(t,e,r.stops[n-1][0],r.stops[n][0],r.stops[n-1][1],r.stops[n][1])}const px={width:100,height:1};function V5(r,t){const e=r.stops;if(e&&e.length>1){let n;if(gh){const l=JSON.stringify(e);if(!gh.has(l)){const h=new cx(e,px);gh.set(l,h)}n=gh.get(l)}else n=new cx(e,px);const[i,o,s,a]=n.getColor(t);return[i/255,o/255,s/255,a/255]}else if(e&&e.length===1)return e[0][1];return null}function G5(r,t){return N5(t,r.default)}function gx(r,t,e,n,i,o){return typeof i=="function"?function(){var s=i.apply(void 0,arguments),a=o.apply(void 0,arguments);return gx(r,t,e,n,s,a)}:i.length?U5(r,t,e,n,i,o):mx(r,t,e,n,i,o)}function mx(r,t,e,n,i,o){var s=n-e,a=r-e,l;return t===1?l=a/s:l=(Math.pow(t,a)-1)/(Math.pow(t,s)-1),i*(1-l)+o*l}function U5(r,t,e,n,i,o){var s=[];for(let a=0;a<i.length;a++)s[a]=mx(r,t,e,n,i[a],o[a]);return s}function Cn(r){return r&&typeof r=="object"&&(r.stops||r.property&&r.type==="identity")}function yx(r){for(const t in r)if(Cn(r[t]))return!0;return!1}function Sc(r){return xx(r,"exponential")}function tg(r,t){if(!r)return null;var e=!1;if(Array.isArray(r)){var n=[],i;for(let h=0;h<r.length;h++)i=tg(r[h],t),i?(n.push(i),e=!0):n.push(r[h]);return e?n:r}var o={__fn_types_loaded:!0},s=[],a;for(a in r)r.hasOwnProperty(a)&&s.push(a);const l=function(h){Object.defineProperty(o,h,{get:function(){return this["__fn_"+h]||(this["__fn_"+h]=Sc(this["_"+h])),this["__fn_"+h].apply(this,t())},set:function(u){this["_"+h]=u},configurable:!0,enumerable:!0})};for(let h=0,u=s.length;h<u;h++)a=s[h],Cn(r[a])?(e=!0,o["_"+a]=r[a],l(a)):o[a]=r[a];return e?o:r}function vx(r){if(!r||!r.stops)return[];const t=[];for(let e=0,n=r.stops.length;e<n;e++)t.push(r.stops[e][1]);return t}function xx(r,t){if(!Cn(r))return function(){return r};r=JSON.parse(JSON.stringify(r));let e=!0,n=!0;const i=r.stops;if(i){for(let s=0;s<i.length;s++)if(Cn(i[s][1])){const a=xx(i[s][1],t);e=e&&a.isZoomConstant,n=n&&a.isFeatureConstant,i[s]=[i[s][0],a]}}const o=fx(r,t);return o.isZoomConstant=e&&o.isZoomConstant,o.isFeatureConstant=n&&o.isFeatureConstant,o}/*!
      Feature Filter by

      (c) mapbox 2016 and maptalks 2018
      www.mapbox.com | www.maptalks.org
      License: MIT, header required.
  */const eg=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function $5(r){return typeof r=="object"&&!!r}function ng(r){return new Function("f",`var p = (f && f.properties || {}); return ${_x(r)}`)}function _x(r){if(!r)return"true";const t=r[0];return r.length<=1?t==="any"?"false":"true":`(${t==="=="?rg(r[1],r[2],"===",!1):t==="!="?rg(r[1],r[2],"!==",!1):t==="<"||t===">"||t==="<="||t===">="?rg(r[1],r[2],t,!0):t==="any"?ig(r.slice(1),"||"):t==="all"?ig(r.slice(1),"&&"):t==="none"?og(ig(r.slice(1),"||")):t==="in"?wx(r[1],r.slice(2)):t==="!in"?og(wx(r[1],r.slice(2))):t==="has"?Ax(r[1]):t==="!has"?og(Ax(r[1])):t==="contains"?Z5(r[1],r[2],r[3]):"true"})`}function W5(r,t,e,n){const i=r.property,o=r.op;let s=Cc(i);if(o==="length")s=`((${s}+='').length)`;else return console.error(`not support ${o} op`),"false";return bx(s,i,t,e,n)}function Z5(r,t,e){const n=Cc(r);return e!==void 0?`(${n} + '').indexOf("${t}") === ${e}`:`(${n} + '').indexOf("${t}") >= 0`}function Cc(r){return r[0]==="$"?"f."+r.substring(1):"p["+JSON.stringify(r)+"]"}function rg(r,t,e,n){if($5(r)&&r.op)return W5(r,t,e,n);const i=Cc(r);return bx(i,r,t,e,n)}function bx(r,t,e,n,i){const o=t==="$type"?eg.indexOf(e):JSON.stringify(e);return(i?`typeof ${r}=== typeof ${o}&&`:"")+r+n+o}function ig(r,t){return r.map(_x).join(t)}function wx(r,t){r==="$type"&&(t=t.map(i=>eg.indexOf(i)));const e=JSON.stringify(t.sort(X5)),n=Cc(r);return t.length<=200?`${e}.indexOf(${n}) !== -1`:`function(v, a, i, j) {
        while (i <= j) { var m = (i + j) >> 1;
            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;
        }
    return false; }(${n}, ${e},0,${t.length-1})`}function Ax(r){return r==="$id"?'"id" in f':`${JSON.stringify(r)} in p`}function og(r){return`!(${r})`}function X5(r,t){return r<t?-1:r>t?1:0}function sg(r){const t=r._toJSON(),e=t.feature;return e.type=eg.indexOf(e.geometry.type),e.subType=t.subType,e}function Tx(r){if(!Array.isArray(r))return Tx([r]);const t=[];for(let e=0;e<r.length;e++){let n;r[e].filter===!0?n=function(){return!0}:n=ng(r[e].filter),t.push(Y5({},r[e],{filter:n}))}return t}function Y5(r){for(let t=1;t<arguments.length;t++){const e=arguments[t];for(const n in e)r[n]=e[n]}return r}var q5=[],J5={};function Pc(r,t){return tg(r,function(){var e=t.getMap();return K5(q5,e?e.getZoom():12,Gt({},t.getProperties(),Q5(J5,e&&e.getBearing()||0,e&&e.getPitch()||0,e?e.getZoom():10)))})}function K5(r,t,e){return r[0]=t,r[1]=e,r}function Q5(r,t,e,n){return r["{bearing}"]=t,r["{pitch}"]=e,r["{zoom}"]=n,r}function Mx(r){var t={stroke:{stroke:r.markerLineColor,"stroke-width":r.markerLineWidth,"stroke-opacity":r.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:r.markerFill,"fill-opacity":r.markerFillOpacity}};return t.stroke["stroke-width"]===0&&(t.stroke["stroke-opacity"]=0),t}function mh(r,t,e){if(!r.markerPath)return null;var n=1,i=Mx(r);It(r.markerOpacity)&&(n=r.markerOpacity),It(r.opacity)&&(n*=r.opacity);var o={};if(i){for(var s in i.stroke)i.stroke.hasOwnProperty(s)&&(U(i.stroke[s])||(o[s]=i.stroke[s]));for(var s in i.fill)i.fill.hasOwnProperty(s)&&(U(i.fill[s])||(o[s]=i.fill[s]))}var a,l=r.markerPath;Se(l)&&l[0]==="$"?a=br.getResource(l.substring(1,1/0))||[]:a=Array.isArray(r.markerPath)?r.markerPath:[r.markerPath];for(var h,u=[],c=0;c<a.length;c++)h=Se(a[c])?{path:a[c]}:a[c],h=Gt({},h,o),h.d=h.path,delete h.path,u.push(h);var f=['<svg version="1.1"','xmlns="http://www.w3.org/2000/svg"'];n<1&&f.push('opacity="'+n+'"'),r.markerPathWidth&&r.markerPathHeight&&f.push('viewBox="0 0 '+r.markerPathWidth+" "+r.markerPathHeight+'"'),f.push('preserveAspectRatio="none"'),t&&f.push('width="'+t+'"'),e&&f.push('height="'+e+'"'),f.push("><defs></defs>");for(var c=0;c<u.length;c++){if(u[c].d instanceof Element){f.push(u[c].d.outerHTML);continue}var d="<path ";for(var s in u[c])u[c].hasOwnProperty(s)&&(d+=" "+s+'="'+u[c][s]+'"');d+="></path>",f.push(d)}f.push("</svg>");var p="data:image/svg+xml;base64,"+G1(f.join(" "));return p}function yh(r,t){if(!r)return[];var e=r;Array.isArray(r)||(e=[r]);for(var n=[],i=X1,o,s,a,l,h=e.length-1;h>=0;h--)if(r=e[h],!!r){t&&(r=Ec(r));for(var u=0;u<i.length;u++)if(o=r[i[u]],Cn(o)&&(o=vx(o)),!!o){Array.isArray(o)||(o=[o]);for(var c=0;c<o.length;c++)o[c].slice(0,4)==="url("&&(o[c]=dc(o[c])),s=d5[u],n.push([o[c],r[s[0]],r[s[1]]])}if(r.markerType==="path"&&r.markerPath)if(a=Cn(r.markerWidth)?200:r.markerWidth,l=Cn(r.markerHeight)?200:r.markerHeight,Cn(r.markerPath)){o=vx(r.markerPath);for(var f=r.markerPath,c=0;c<o.length;c++)r.markerPath=o[c],n.push([mh(r),a,l]);r.markerPath=f}else n.push([mh(r),a,l])}return n}function Ec(r){if(!r)return null;var t=r;if(Kn)return t;for(var e=X1,n,i=0,o=e.length;i<o;i++)n=t[e[i]],n&&(t[e[i]]=Sx(n));return t}function Sx(r){if(Cn(r)&&r.stops){for(var t=r.stops,e=0;e<t.length;e++)t[e][1]=Sx(t[e][1]);return r}return r.slice(0,4)==="url("&&(r=dc(r)),r}function Cx(r){return r&&be.decodeImageInWorker&&r instanceof ImageBitmap}function Ao(r){return r&&r.colorStops}function ag(r){var t=[r.type];if(r.places&&t.push(r.places.join()),r.colorStops){for(var e=[],n=r.colorStops.length-1;n>=0;n--)e.push(r.colorStops[n].join());t.push(e.join(","))}return t.join("_")}function tE(r,t){return vh(r,t)}function vh(r,t){if(!r)return 1;var e=[];if(Array.isArray(r)){for(var n=0;n<r.length;n++)e.push(vh(r[n],t));return e.sort().join(",")}var i=Object.keys(r).sort(),o=i.reduce(function(a,l){return(!t||l.indexOf(t)===0)&&(a[l]=r[l]),a},{}),s=Kp(JSON.stringify(o));return s}function Oc(r,t){function e(s,a){var l=s.opacity;U(l)?s.opacity=a:s.opacity*=a}var n;if(Array.isArray(r)){n=[];for(var i=0;i<r.length;i++){var o=Gt({},r[i]);e(o,t),n.push(o)}}else n=Gt({},r),e(n,t);return n}function Bi(){for(var r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];var e=r[0],n=Array.prototype.slice.call(r,1);if((!n||!n.length)&&(n=[{}]),Array.isArray(e)){for(var i=void 0,o=void 0,s=[],a=0,l=e.length;a<l;a++){i=e[a],o={};for(var h=0,u=n.length;h<u;h++)Array.isArray(n[h])?U(n[h][a])?Gt(o,i||{}):Gt(o,i,n[h][a]):Gt(o,i,n[h]?n[h]:{});s.push(o)}return s}else{var c=[{},e];return c.push.apply(c,n),Gt.apply(this,c)}}function Px(r){if(r.symbol&&(r=[r]),Array.isArray(r))return r;var t=r.$root,e=r.$iconset;if(r=r.style,t||e){t&&t[t.length-1]==="/"&&(t=t.substring(0,t.length-1)),e&&e[e.length-1]==="/"&&(e=e.substring(0,e.length-1));var n=function(o){return o==="{$root}"?t:o==="{$iconset}"?e:null};Ex(r,n)}return r}function Ex(r,t){for(var e=0;e<r.length;e++){var n=r[e].symbol;n&&hg(n,t)}}var lg=/(\{\$root\}|\{\$iconset\})/g;function hg(r,t){for(var e in r)r.hasOwnProperty(e)&&e!=="textName"&&(Se(r[e])&&r[e].length>2?r[e]=r[e].replace(lg,t):Cn(r[e])?r[e]=Ox(r[e],t):kr(r[e])&&hg(r[e],t))}function Ox(r,t){var e=r.default;Se(e)&&(r.default=e.replace(lg,t));var n=r.stops;if(!n)return r;for(var i=0;i<n.length;i++)Array.isArray(n[i])&&(Se(n[i][1])?n[i][1]=n[i][1].replace(lg,t):Cn(n[i][1])&&(n[i][1]=Ox(n[i][1],t)));return r}function kx(r){r===void 0&&(r=[]),Array.isArray(r)||(r=[r]);for(var t=r.length,e=0;e<t;e++){var n=r[e];if(n.style){var i=n.style,o=i.lineDasharray,s=i.lineWidth;if(s&&It(s)&&s>0&&o&&Array.isArray(o)&&o.length)return!0}}return!1}function ug(r,t,e,n,i){var o=1/Math.tan(t/2),s=1/(n-i);return r[0]=o/e,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=o,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=(i+n)*s,r[11]=-1,r[12]=0,r[13]=0,r[14]=2*i*n*s,r[15]=0,r}function cg(r,t,e){var n=e[0],i=e[1],o=e[2],s,a,l,h,u,c,f,d,p,g,m,y;return t===r?(r[12]=t[0]*n+t[4]*i+t[8]*o+t[12],r[13]=t[1]*n+t[5]*i+t[9]*o+t[13],r[14]=t[2]*n+t[6]*i+t[10]*o+t[14],r[15]=t[3]*n+t[7]*i+t[11]*o+t[15]):(s=t[0],a=t[1],l=t[2],h=t[3],u=t[4],c=t[5],f=t[6],d=t[7],p=t[8],g=t[9],m=t[10],y=t[11],r[0]=s,r[1]=a,r[2]=l,r[3]=h,r[4]=u,r[5]=c,r[6]=f,r[7]=d,r[8]=p,r[9]=g,r[10]=m,r[11]=y,r[12]=s*n+u*i+p*o+t[12],r[13]=a*n+c*i+g*o+t[13],r[14]=l*n+f*i+m*o+t[14],r[15]=h*n+d*i+y*o+t[15]),r}function kc(r,t,e){var n=e[0],i=e[1],o=e[2];return r[0]=t[0]*n,r[1]=t[1]*n,r[2]=t[2]*n,r[3]=t[3]*n,r[4]=t[4]*i,r[5]=t[5]*i,r[6]=t[6]*i,r[7]=t[7]*i,r[8]=t[8]*o,r[9]=t[9]*o,r[10]=t[10]*o,r[11]=t[11]*o,r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15],r}function Ix(r,t,e){var n=Math.sin(e),i=Math.cos(e),o=t[4],s=t[5],a=t[6],l=t[7],h=t[8],u=t[9],c=t[10],f=t[11];return t!==r&&(r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r[4]=o*i+h*n,r[5]=s*i+u*n,r[6]=a*i+c*n,r[7]=l*i+f*n,r[8]=h*i-o*n,r[9]=u*i-s*n,r[10]=c*i-a*n,r[11]=f*i-l*n,r}function Rx(r,t,e){var n=Math.sin(e),i=Math.cos(e),o=t[0],s=t[1],a=t[2],l=t[3],h=t[4],u=t[5],c=t[6],f=t[7];return t!==r&&(r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r[0]=o*i+h*n,r[1]=s*i+u*n,r[2]=a*i+c*n,r[3]=l*i+f*n,r[4]=h*i-o*n,r[5]=u*i-s*n,r[6]=c*i-a*n,r[7]=f*i-l*n,r}function ba(r,t,e){var n=t[0],i=t[1],o=t[2],s=t[3],a=t[4],l=t[5],h=t[6],u=t[7],c=t[8],f=t[9],d=t[10],p=t[11],g=t[12],m=t[13],y=t[14],x=t[15],v=e[0],_=e[1],w=e[2],b=e[3];return r[0]=v*n+_*a+w*c+b*g,r[1]=v*i+_*l+w*f+b*m,r[2]=v*o+_*h+w*d+b*y,r[3]=v*s+_*u+w*p+b*x,v=e[4],_=e[5],w=e[6],b=e[7],r[4]=v*n+_*a+w*c+b*g,r[5]=v*i+_*l+w*f+b*m,r[6]=v*o+_*h+w*d+b*y,r[7]=v*s+_*u+w*p+b*x,v=e[8],_=e[9],w=e[10],b=e[11],r[8]=v*n+_*a+w*c+b*g,r[9]=v*i+_*l+w*f+b*m,r[10]=v*o+_*h+w*d+b*y,r[11]=v*s+_*u+w*p+b*x,v=e[12],_=e[13],w=e[14],b=e[15],r[12]=v*n+_*a+w*c+b*g,r[13]=v*i+_*l+w*f+b*m,r[14]=v*o+_*h+w*d+b*y,r[15]=v*s+_*u+w*p+b*x,r}function fg(r,t){var e=t[0],n=t[1],i=t[2],o=t[3],s=t[4],a=t[5],l=t[6],h=t[7],u=t[8],c=t[9],f=t[10],d=t[11],p=t[12],g=t[13],m=t[14],y=t[15],x=e*a-n*s,v=e*l-i*s,_=e*h-o*s,w=n*l-i*a,b=n*h-o*a,A=i*h-o*l,T=u*g-c*p,S=u*m-f*p,M=u*y-d*p,E=c*m-f*g,P=c*y-d*g,k=f*y-d*m,O=x*k-v*P+_*E+w*M-b*S+A*T;return O?(O=1/O,r[0]=(a*k-l*P+h*E)*O,r[1]=(i*P-n*k-o*E)*O,r[2]=(g*A-m*b+y*w)*O,r[3]=(f*b-c*A-d*w)*O,r[4]=(l*M-s*k-h*S)*O,r[5]=(e*k-i*M+o*S)*O,r[6]=(m*_-p*A-y*v)*O,r[7]=(u*A-f*_+d*v)*O,r[8]=(s*P-a*M+h*T)*O,r[9]=(n*M-e*P-o*T)*O,r[10]=(p*b-g*_+y*x)*O,r[11]=(c*_-u*b-d*x)*O,r[12]=(a*S-s*E-l*T)*O,r[13]=(e*E-n*S+i*T)*O,r[14]=(g*v-p*w-m*x)*O,r[15]=(u*w-c*v+f*x)*O,r):null}function Ic(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function dg(r,t){return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15],r}var Jr=Object.freeze({__proto__:null,DEFAULT_FONT:tx,DEFAULT_TEXTSIZE:ex,EMPTY_STRING:Xo,GUID:H1,IS_NODE:Kn,UID:bo,_defaults:f5,b64toBlob:U1,btoa:G1,calCanvasSize:Wp,get cancelAnimFrame(){return lh},clamp:fc,computeDegree:pc,convertResourceUrl:Ec,convertStylePath:Ex,copy:dg,describeText:xc,emptyImageUrl:Gp,equalMapView:gc,escapeSpecialChars:yc,extend:Gt,extendSymbol:Bi,extractCssUrl:dc,flash:Up,forEachCoord:Es,getAbsoluteURL:mc,getAlignPoint:wo,getExternalResources:yh,getFont:qp,getGlobalThis:A1,getGradientStamp:ag,getImageBitMap:$p,getMarkerPathBase64:mh,getPointsResultPts:ch,getSymbolHash:vh,getSymbolStamp:tE,getValueOrDefault:se,hasOwn:ga,hashCode:Kp,identity:Ic,interpolate:cc,invert:fg,isArrayHasData:on,isCssUrl:V1,isDashLine:kx,isEmpty:J3,isFunction:ze,isGradient:Ao,isImageBitMap:Cx,isInteger:Cs,isNil:U,isNumber:It,isObject:kr,isSVG:Ps,isString:Se,isURL:N1,join:q3,loadImage:hh,log2:h5,lowerSymbolOpacity:Oc,multiply:ba,now:Qe,parseJSON:uh,parseStyleRootPath:Px,parseSymbolPath:hg,perspective:ug,pushIn:ai,removeFromArray:uc,replaceAll:q1,replaceVariable:vc,get requestAnimFrame(){return _o},rotateX:Ix,rotateZ:Rx,scale:kc,sign:Br,splitContent:Yp,splitTextToRow:Jp,splitWords:J1,stringLength:Xp,stringWidth:Yo,toDegree:Dp,toRadian:Gn,translate:cg,translateToSVGStyles:Mx,trim:Zp,wrap:Os}),eE=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function pg(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var nE=Rc;Rc.polyline=Rc,Rc.polygon=rE;function Rc(r,t,e){var n=r.length,i=wa(r[0],t),o=[],s,a,l,h,u;for(e||(e=[]),s=1;s<n;s++){for(a=r[s-1],l=r[s],h=u=wa(l,t);;)if(i|h){if(i&h)break;i?(a=gg(a,l,i,t),i=wa(a,t)):(l=gg(a,l,h,t),h=wa(l,t))}else{o.push(a),h!==u?(o.push(l),s<n-1&&(e.push(o),o=[])):s===n-1&&o.push(l);break}i=u}return o.length&&e.push(o),e}function rE(r,t){var e,n,i,o,s,a,l;for(n=1;n<=8;n*=2){for(e=[],i=r[r.length-1],o=!(wa(i,t)&n),s=0;s<r.length;s++)a=r[s],l=!(wa(a,t)&n),l!==o&&e.push(gg(i,a,n,t)),l&&e.push(a),i=a,o=l;if(r=e,!r.length)break}return e}function gg(r,t,e,n){return e&8?[r[0]+(t[0]-r[0])*(n[3]-r[1])/(t[1]-r[1]),n[3]]:e&4?[r[0]+(t[0]-r[0])*(n[1]-r[1])/(t[1]-r[1]),n[1]]:e&2?[n[2],r[1]+(t[1]-r[1])*(n[2]-r[0])/(t[0]-r[0])]:e&1?[n[0],r[1]+(t[1]-r[1])*(n[0]-r[0])/(t[0]-r[0])]:null}function wa(r,t){var e=0;return r[0]<t[0]?e|=1:r[0]>t[2]&&(e|=2),r[1]<t[1]?e|=4:r[1]>t[3]&&(e|=8),e}var iE=pg(nE),Dx=1/0,Fx=1/0,Lx=-1/0,zx=-1/0;function qo(){return[Dx,Fx,Lx,zx]}var Aa=qo();function xh(r){r[0]=Dx,r[1]=Fx,r[2]=Lx,r[3]=zx}function _h(r,t){if(r)if(Array.isArray(r[0]))for(var e=0,n=r.length;e<n;e++)_h(r[e],t);else if(Array.isArray(r))for(var e=0,n=r.length;e<n;e++){var i=r[e],o=i.x,s=i.y;t[0]=Math.min(o,t[0]),t[1]=Math.min(s,t[1]),t[2]=Math.max(o,t[2]),t[3]=Math.max(s,t[3])}else{var o=r.x,s=r.y;t[0]=Math.min(o,t[0]),t[1]=Math.min(s,t[1]),t[2]=Math.max(o,t[2]),t[3]=Math.max(s,t[3])}}function Dc(r,t,e,n,i){t!==0&&!t||(Array.isArray(t)&&(e=t[1],n=t[2],i=t[3],t=t[0]),r[0]=Math.min(t,r[0]),r[1]=Math.min(e,r[1]),r[2]=Math.max(n,r[2]),r[3]=Math.max(i,r[3]))}function Fc(r){return r&&r[0]!==1/0&&r[0]!==void 0}function Hx(r,t){t===void 0&&(t=0),r[0]-=t,r[1]-=t,r[2]+=t,r[3]+=t}function oE(r,t){return!(r[2]<t[0]||r[1]>t[3]||r[0]>t[2]||r[3]<t[1])}function Nx(r,t){var e=te(r,4),n=e[0],i=e[1],o=e[2],s=e[3];return n>=t[0]&&o<=t[2]&&i>=t[1]&&s<=t[3]}function sE(r,t){var e=t.bbox;if(!e)return console.error("maskGeoJSON bbox is null:",t),!1;if(oE(e,r)){var n=t.geometry;if(!n)return console.error("maskGeoJSON is error,not find geometry.",t),!1;var i=n.coordinates,o=n.type;o==="Polygon"&&(i=[i]);for(var s=0,a=i.length;s<a;s++){var l=i[s],h=l[0],u=iE.polygon(h,r);if(u.length>0){for(var c=1/0,f=-1/0,d=1/0,p=-1/0,g=0,m=u.length;g<m;g++){var y=te(u[g],2),x=y[0],v=y[1];c=Math.min(x,c),d=Math.min(v,d),f=Math.max(x,f),p=Math.max(v,p)}if(c!==f&&d!==p)return!0}}return!1}else return!1}var mg="core-fetch-image",Bx;function aE(r){Bx=r}function lE(){return Bx}var jx=!1;function hE(){jx=!0}function uE(){return jx}var Vx=[];function Gx(r){return Vx.indexOf(r)>-1}function Ux(r){Gx(r)||Vx.push(r)}var Is={};function Rs(r,t){Is[r]=t}var cE=`
    var adapters = {};
    // Dynamic Create Adapter
    function createAdapter(key,code){
        if(adapters[key]||!code){
            return;
        }
        var func=new Function('exports',code+'(exports)');
        var workerExports={};
        func(workerExports,self);
        adapters[key]=workerExports;
        workerExports.initialize && workerExports.initialize(self);

    }
    onmessage = function (msg) {
        msg = msg.data;
        //createAdapter
        if (msg.messageType === 'createAdapter') {
           var key=msg.key;
           var code=msg.code;
           createAdapter(key,code);
           postMessage({adapterName:key});
           return;
        }
        // postMessage when main thread idle
        if(msg.messageType==='idle'){
            var messageRatio = msg.messageRatio;
            handleMessageQueue(messageRatio);
            return;
        }
        if (msg.messageType === 'batch') {
            const messages = msg.messages;
            if (messages) {
                for (let i = 0; i < messages.length; i++) {
                    dispatch(messages[i]);
                }
            }
        } else {
            dispatch(msg);
        }
    };

    function dispatch(msg) {
        var workerKey = msg.workerKey;
        var adapter = adapters[workerKey];
        if (!adapter) {
            post(msg.callback, 'Unregistered worker adapters for ' + workerKey);
            return;
        }
        try {
            adapter.onmessage(msg, wrap(msg.callback));
        } catch (err) {
            post(msg.callback, workerKey + ':' + err.message);
            console.error(err);
            throw err;
        }
    }

    var messageResultQueue = [];

    function handleMessageQueue(messageRatio){
       if(messageResultQueue.length===0){
          return;
       }
       var count = Math.ceil((messageRatio || 1) * messageResultQueue.length);
       var queues = messageResultQueue.slice(0, count);
       queues.forEach(function(queue){
          post(queue.callback,queue.err,queue.data,queue.buffers);
       });
       messageResultQueue=messageResultQueue.slice(count, Infinity);
    }

    function post(callback, err, data, buffers) {
        var msg = {
            callback : callback
        };
        if (err) {
            msg.error = err;
        } else {
            msg.data = data;
        }
        if (buffers && buffers.length > 0) {
            postMessage(msg, buffers);
        } else {
            postMessage(msg);
        }
    }

    function joinQueue(callback,err,data,buffers){
        messageResultQueue.push({
            callback:callback,
            err:err,
            data:data,
            buffers:buffers
        });
    }

    function wrap(callback) {
        return function (err, data, buffers) {
            joinQueue(callback, err, data, buffers);
        };
    }
    var workerExports;
`,fE=`
    workerExports = null;
`;function dE(){var r=cE;for(var t in Is){var e=Is[t];Ux(t),ze(e)&&e.length===0&&(e=e()),r+=`
    workerExports = {};
    (`.concat(e,`)(workerExports, self);
    adapters['`).concat(t,"'] = workerExports"),r+=`
    workerExports.initialize && workerExports.initialize(self);
        `}return r+=fE,r}var yg;function pE(){if(typeof window>"u")return null;if(!yg){var r=dE();yg=window.URL.createObjectURL(new Blob([r],{type:"text/javascript"})),Is={}}return yg}function gE(r,t){if(!Is[r]){console.error("not find ".concat(r," adapter"));return}var e=Is[r];ze(e)&&e.length===0&&(e=e()),e="(".concat(e,")");var n=lE();if(n){var i=n.workers||[];i.length===0&&console.error("workerpool workers count is 0");var o=0,s=function(a){a=a.data||{},a.adapterName===r&&(o++,o===i.length&&(i.forEach(function(l){l.removeEventListener("message",s)}),delete Is[r],t()))};i.forEach(function(a){a.addEventListener("message",s),a.postMessage({key:r,code:e,messageType:"createAdapter"})})}}var mE=typeof window<"u"?window.navigator.hardwareConcurrency||4:0,yE=Math.max(Math.floor(mE/2),1),$x=function(){function r(t){t===void 0&&(t=50),this._limit=t,this._messages=[],this.buffers=[]}return r.prototype.addMessage=function(t,e){if(this._messages.push(t),!!Array.isArray(e))for(var n=0;n<e.length;n++)this.buffers.indexOf(e[n])<0&&this.buffers.push(e[n])},r.prototype.isFull=function(){return this._messages.length>=this._limit},r.prototype.getMessage=function(){return{messageType:"batch",messages:this._messages}},r}(),vE=function(){function r(){this.active={},this.workerCount=typeof window<"u"?Li.workerCount||yE:0,this._messages=[],this._messageBuffers=[]}return r.prototype.acquire=function(t){if(!this.workers){this.workers=[];for(var e=pE(),n=0;n<this.workerCount;n++){var i=new Worker(e);i.id=n,this.workers.push(i)}URL.revokeObjectURL(e),hE()}return this.active[t]=!0,this.workers.slice()},r.prototype.release=function(t){delete this.active[t],Object.keys(this.active).length===0&&(this.workers.forEach(function(e){e.terminate()}),this.workers=null)},r.prototype.addMessage=function(t,e,n){var i=this._messages[t];(!i||!i.length)&&(i=this._messages[t]=[new $x]);var o=i[i.length-1];o.isFull()&&(o=new $x,this._messages[t].push(o)),o.addMessage(e,n)},r.prototype.commit=function(){if(this.workers&&this._messages.length){for(var t=0;t<this._messages.length;t++)if(!(!this._messages[t]||!this._messages[t].length)){var e=this._messages[t].shift();this.workers[t].postMessage(e.getMessage(),e.buffers)}}},r.prototype.getWorkers=function(){return this.workers||[]},r.prototype.broadcastIdleMessage=function(t){var e=this.getWorkers();return e.forEach(function(n){n.postMessage({messageType:"idle",messageRatio:t})}),this},r}(),Lc;function vg(){return Lc||(Lc=new vE,aE(Lc)),Lc}var bh=[],xg=[];function Wx(r){wg();var t=new Promise(function(e,n){if(!r){n(new Error("task is null"));return}if(ze(r)&&(r={count:1,run:r}),!r.run){n(new Error("task.run is null"));return}if(U(r.count)&&(r.count=1),r.count=Math.ceil(r.count),!It(r.count)){n(new Error("task.count is not number"));return}var i=r;i.results=[],bh.push(i),i.resolve=e});return t}function xE(){if(bh.length!==0){for(var r=[],t=[],e=bh.length,n=0;n<e;n++){var i=bh[n];if(i.count--,i.count===-1)t.push(i);else{r.push(i);var o=i.run();i.results.push(o)}}bh=r,e=t.length;for(var n=0;n<e;n++){var i=t[n];i.resolve&&i.resolve(i.results)}}}function _g(r){var t=Li.messagePostRatioPerWorker*(r?.5:1);vg().commit(),vg().broadcastIdleMessage(t),xE(),xg.forEach(function(e){e()})}var bg=Qe();function Zx(){_g(),bg=Qe(),requestIdleCallback(Zx)}function Xx(){if(be.requestIdleCallback){var r=Li.idleForceTimeThreshold,t=Li.idleLog,e=Qe();e-bg>r&&(_g(!0),bg=Qe(),t&&console.warn("did not apply for availability, forced run idle"))}else _g();_o(Xx)}var Yx=!1;function wg(){Yx||(Yx=!0,be.requestIdleCallback&&requestIdleCallback(Zx),_o(Xx))}function qx(r){xg.indexOf(r)>-1||ze(r)&&xg.push(r)}var Jx=Object.freeze({__proto__:null,pushLoopHook:qx,runTaskAsync:Wx,startTasks:wg}),Kx=typeof Map=="function",Qx=function(){},_E=function(){function r(t,e){this.max=t,this.onRemove=e||Qx,this.reset()}return r.prototype.reset=function(){for(var t in this.data)this.onRemove(this.data[t]);return this.data={},this.order=[],this},r.prototype.clear=function(){this.reset(),delete this.onRemove},r.prototype.add=function(t,e){if(this.has(t))this.order.splice(this.order.indexOf(t),1),this.data[t]=e,this.order.push(t);else if(this.data[t]=e,this.order.push(t),this.order.length>this.max){var n=this.getAndRemove(this.order[0]);n&&this.onRemove(n)}return this},r.prototype.has=function(t){return t in this.data},r.prototype.keys=function(){return this.order},r.prototype.getAndRemove=function(t){if(!this.has(t))return null;var e=this.data[t];return delete this.data[t],this.order.splice(this.order.indexOf(t),1),e},r.prototype.get=function(t){if(!this.has(t))return null;var e=this.data[t];return e},r.prototype.remove=function(t){if(!this.has(t))return this;var e=this.data[t];return delete this.data[t],this.onRemove(e),this.order.splice(this.order.indexOf(t),1),this},r.prototype.setMaxSize=function(t){for(this.max=t;this.order.length>this.max;){var e=this.getAndRemove(this.order[0]);e&&this.onRemove(e)}return this},r}(),t_;Kx&&(t_=function(){function r(t,e){this.max=t,this.onRemove=e||Qx,this.reset()}return r.prototype.reset=function(){var t,e;if(this.data){var n=this.data.values();try{for(var i=L1(n),o=i.next();!o.done;o=i.next()){var s=o.value;this.onRemove(s)}}catch(a){t={error:a}}finally{try{o&&!o.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}}return this.data=new Map,this},r.prototype.clear=function(){this.reset(),delete this.onRemove},r.prototype.add=function(t,e){return e?(this.has(t)?(this.data.delete(t),this.data.set(t,e)):this.data.set(t,e),this):this},r.prototype.keys=function(){var t,e,n=new Array(this.data.size),i=0,o=this.data.keys();try{for(var s=L1(o),a=s.next();!a.done;a=s.next()){var l=a.value;n[i++]=l}}catch(h){t={error:h}}finally{try{a&&!a.done&&(e=s.return)&&e.call(s)}finally{if(t)throw t.error}}return n},r.prototype.shrink=function(){for(var t=this.data.keys(),e=t.next();this.data.size>this.max;){var n=this.getAndRemove(e.value);n&&this.onRemove(n),e=t.next()}},r.prototype.has=function(t){return this.data.has(t)},r.prototype.getAndRemove=function(t){if(!this.has(t))return null;var e=this.data.get(t);return this.data.delete(t),e},r.prototype.get=function(t){if(!this.has(t))return null;var e=this.data.get(t);return e},r.prototype.remove=function(t){if(!this.has(t))return this;var e=this.data.get(t);return this.data.delete(t),this.onRemove(e),this},r.prototype.setMaxSize=function(t){return this.max=t,this.data.size>this.max&&this.shrink(),this},r}());var Ag=Kx?t_:_E,e_="#000",bE="rgba(255,255,255,0)",wE="#000",zc=!1,Ta=null,Ma=Math.PI/180,n_=1,r_="top";function AE(r,t,e,n,i,o,s,a,l,h){var u=1-r,c=1-t,f=e*u*u+i*2*r*u+s*r*r,d=e*c*c+i*2*t*c+s*t*t,p=i*u*u+s*2*r*u+l*r*r,g=i*c*c+s*2*t*c+l*t*t,m=n*u*u+o*2*r*u+a*r*r,y=n*c*c+o*2*t*c+a*t*t,x=o*u*u+a*2*r*u+h*r*r,v=o*c*c+a*2*t*c+h*t*t,_=f*c+p*t,w=d*u+g*r,b=d*c+g*t,A=m*c+x*t,T=y*u+v*r,S=y*c+v*t;return[_,A,w,T,b,S]}function i_(r,t,e,n,i,o,s,a,l,h){var u=(r+e)/2,c=(t+n)/2,f=(e+i)/2,d=(n+o)/2,p=(i+s)/2,g=(o+a)/2,m=Math.sqrt((e-r)*(e-r)+(n-t)*(n-t)),y=Math.sqrt((i-e)*(i-e)+(o-n)*(o-n)),x=Math.sqrt((s-i)*(s-i)+(a-o)*(a-o)),v=m/(m+y),_=y/(y+x),w=u+(f-u)*v,b=c+(d-c)*v,A=f+(p-f)*_,T=d+(g-d)*_,S=w+(f-w)*l+e-w,M=b+(d-b)*l+n-b,E=A+(f-A)*l+i-A,P=T+(d-T)*l+o-T,k=[S,M,E,P];return h<1?AE(0,h,e,n,S,M,E,P,i,o):k}var Mt={getCanvas2DContext:function(r){return r.getContext("2d",{willReadFrequently:!0})},setHitTesting:function(r){zc=r},createCanvas:function(r,t,e){var n;return Kn?n=new e(r,t):(n=de("canvas"),n.width=r,n.height=t),n},prepareCanvasFont:function(r,t){r.textBaseline!==r_&&(r.textBaseline=r_);var e=qp(t);r.font!==e&&(r.font=e);var n=t.textFill;n||(n=wE);var i=Mt.getRgba(n,t.textOpacity);r.fillStyle!==i&&(r.fillStyle=i)},prepareCanvas:function(r,t,e,n){if(t){var i=t.lineWidth;!U(i)&&r.lineWidth!==i&&(r.lineWidth=i);var o=t.linePatternFile,s=t.lineColor||e_;if(n)r.strokeStyle="#000";else if(o&&e){var a=void 0;(t.linePatternDx||t.linePatternDy)&&(a=[t.linePatternDx,t.linePatternDy]),Mt._setStrokePattern(r,o,i,a,e),t.lineDasharray=[]}else Ao(s)?t.lineGradientExtent?r.strokeStyle=Mt._createGradient(r,s,t.lineGradientExtent):r.strokeStyle=e_:(Array.isArray(s)&&(s=Mt.normalizeColorToRGBA(s)),r.strokeStyle=s);t.lineJoin&&(r.lineJoin=t.lineJoin),t.lineCap&&(r.lineCap=t.lineCap),r.setLineDash&&on(t.lineDasharray)&&r.setLineDash(t.lineDasharray);var l=t.polygonPatternFile,h=t.polygonFill||bE;if(n)r.fillStyle="#000";else if(l&&e){var u=s_(l),c=e.getImage([u,null,null]);if(c||(c=e.getImage([u+"-texture",null,i])),Ps(u)&&c instanceof Image&&(be.edge||be.ie)){var f=c.width||20,d=c.height||20,p=Mt.createCanvas(f,d);Mt.image(p.getContext("2d"),c,0,0,f,d),c=p}c?(r.fillStyle=r.createPattern(c,"repeat"),(t.polygonPatternDx||t.polygonPatternDy)&&(r.fillStyle.polygonPatternOffset=[t.polygonPatternDx,t.polygonPatternDy])):typeof console<"u"&&console.warn("img not found for",u)}else Ao(h)?t.polygonGradientExtent?r.fillStyle=Mt._createGradient(r,h,t.polygonGradientExtent):r.fillStyle="rgba(255,255,255,0)":(Array.isArray(h)&&(h=Mt.normalizeColorToRGBA(h)),r.fillStyle=h)}},_createGradient:function(r,t,e){var n=null,i=t.places,o=e.getMin(),s=e.getMax(),a=e.getWidth(),l=e.getHeight();if(!t.type||t.type==="linear"){if(!i)i=[o.x,o.y,s.x,o.y];else{if(i.length!==4)throw new Error("A linear gradient's places should have 4 numbers.");i=[o.x+i[0]*a,o.y+i[1]*l,o.x+i[2]*a,o.y+i[3]*l]}n=r.createLinearGradient.apply(r,i)}else if(t.type==="radial"){if(i){if(i.length!==6)throw new Error("A radial gradient's places should have 6 numbers.");i=[o.x+i[0]*a,o.y+i[1]*l,a*i[2],o.x+i[3]*a,o.y+i[4]*l,a*i[5]]}else{var h=e.getCenter()._round();i=[h.x,h.y,Math.abs(h.x-o.x),h.x,h.y,0]}n=r.createRadialGradient.apply(r,i)}return t.colorStops.forEach(function(u){n.addColorStop.apply(n,u)}),n},_setStrokePattern:function(r,t,e,n,i){var o=s_(t),s;if(Kn)s=i.getImage([o,null,e]);else{var a=o+"-texture-"+e;if(s=i.getImage(a),!s){var l=i.getImage([o,null,null]);if(l){var h=void 0;!l.width||!l.height?h=e:h=Math.round(l.width*e/l.height);var u=Mt.createCanvas(h,e,r.canvas.constructor);Mt.image(u.getContext("2d"),l,0,0,h,e),i.addResource([a,null,e],u),s=u}}}s?(r.strokeStyle=r.createPattern(s,"repeat"),r.strokeStyle.linePatternOffset=n):typeof console<"u"&&console.warn("img not found for",o)},clearRect:function(r,t,e,n,i){r.canvas._drawn=!1,r.clearRect(t,e,n,i)},fillCanvas:function(r,t,e,n){if(zc&&(t=1),r.canvas._drawn=!0,t!==0){var i=Mt._isPattern(r.fillStyle),o=r.fillStyle&&r.fillStyle.polygonPatternOffset,s=o?o[0]:0,a=o?o[1]:0;U(t)&&(t=1);var l;t<1&&(l=r.globalAlpha,r.globalAlpha*=t),i&&(e=e||0,n=n||0,r.translate(e+s,n+a)),r.fill(),i&&r.translate(-e-s,-n-a),t<1&&(r.globalAlpha=l)}},getRgba:function(r,t){if(U(t)&&(t=1),r[0]!=="#")return Array.isArray(r)&&(r=Mt.normalizeColorToRGBA(r,t)),r;var e,n,i;return r.length===7?(e=parseInt(r.substring(1,3),16),n=parseInt(r.substring(3,5),16),i=parseInt(r.substring(5,7),16)):(e=parseInt(r.substring(1,2),16)*17,n=parseInt(r.substring(2,3),16)*17,i=parseInt(r.substring(3,4),16)*17),"rgba("+e+","+n+","+i+","+t+")"},normalizeColorToRGBA:function(r,t){return t===void 0&&(t=1),"rgba(".concat(r[0]*255,",").concat(r[1]*255,",").concat(r[2]*255,",").concat((r.length===4?r[3]:1)*t,")")},image:function(r,t,e,n,i,o){r.canvas._drawn=!0;try{It(i)&&It(o)?r.drawImage(t,e,n,i,o):r.drawImage(t,e,n)}catch(s){console&&(console.warn("error when drawing image on canvas:",s),console.warn(t))}},text:function(r,t,e,n,i){return Mt._textOnMultiRow(r,i.rows,n,e,i.size,i.rawSize)},_textOnMultiRow:function(r,t,e,n,i,o){var s=wo(i,e.textHorizontalAlignment,e.textVerticalAlignment),a=o.height+e.textLineSpacing,l=n.add(0,s.y),h=e.textMaxHeight,u,c,f=0;xh(Aa);for(var d=0,p=t.length;d<p;d++){u=t[d].text,c=wo(t[d].size,e.textHorizontalAlignment,e.textVerticalAlignment);var g=l.add(c.x,d*a);Mt._textOnLine(r,u,g,e.textHaloRadius,e.textHaloFill,e.textHaloOpacity);var m=t[d].size,y=g.x,x=g.y,v=y+m.width,_=x+m.height;if(Dc(Aa,y,x,v,_),h>0&&(f+=a,f+m.height>=h))break}return Aa},_textOnLine:function(r,t,e,n,i,o){zc&&(o=1);var s=o!==0&&n!==0;r.textBaseline="top";var a,l,h=r.shadowBlur,u=r.shadowOffsetX,c=r.shadowOffsetY;if(s){var f=r.globalAlpha;r.globalAlpha*=o,r.miterLimit=2,r.lineJoin="round",r.lineCap="round",r.lineWidth=n*2,Array.isArray(i)&&(i=Mt.normalizeColorToRGBA(i)),r.strokeStyle=i,r.strokeText(t,e.x,e.y+n_),r.miterLimit=10,r.globalAlpha=f,a=r.globalCompositeOperation,r.globalCompositeOperation="destination-out",l=r.fillStyle,r.fillStyle="#000"}h&&s&&(r.shadowBlur=r.shadowOffsetX=r.shadowOffsetY=0),Mt.fillText(r,t,e),a&&(r.globalCompositeOperation=a,Mt.fillText(r,t,e,l),h&&(r.shadowBlur=h,r.shadowOffsetX=u,r.shadowOffsetY=c))},fillText:function(r,t,e,n){r.canvas._drawn=!0,n&&(r.fillStyle=n),r.fillText(t,e.x,e.y+n_)},_stroke:function(r,t,e,n){if(zc&&(t=1),r.canvas._drawn=!0,t!==0){var i=r.strokeStyle&&r.strokeStyle.linePatternOffset,o=i?i[0]:0,s=i?i[1]:0,a=Mt._isPattern(r.strokeStyle)&&(!U(e)&&!U(n)||!U(o)&&!U(s));U(t)&&(t=1);var l;t<1&&(l=r.globalAlpha,r.globalAlpha*=t),a&&(e=e||0,n=n||0,r.translate(e+o,n+s)),r.stroke(),a&&r.translate(-e-o,-n-s),t<1&&(r.globalAlpha=l)}},_path:function(r,t,e,n,i){if(!on(t))return;function o(d,p){var g=pc(d.x,d.y,p.x,p.y);r.save();var m=Math.cos(g);Math.abs(m)<1e-7?r.translate(d.x-r.lineWidth/2,d.y):r.translate(d.x,d.y-r.lineWidth/2/m),r.rotate(g),Mt._stroke(r,n),r.restore()}for(var s=on(e),a=i===!0?!1:Mt._isPattern(r.strokeStyle),l,h,u,c=0,f=t.length;c<f;c++)if(l=t[c],!s||r.setLineDash)r.lineTo(l.x,l.y),a&&c>0&&(h=t[c-1],o(h,l),r.beginPath(),r.moveTo(l.x,l.y));else if(s){if(c===f-1)break;u=t[c+1],TE(r,l,u,e)}},path:function(r,t,e,n,i){on(t)&&(r.beginPath(),r.moveTo(t[0].x,t[0].y),Mt._path(r,t,i,e),Mt._stroke(r,e))},_multiClip:function(r,t){!t||t.length===0||t.forEach(function(e){for(var n=0,i=e.length;n<i;n++){var o=e[n],s=o.x,a=o.y;n===0?r.moveTo(s,a):r.lineTo(s,a),n===i-1&&(s=e[0].x,a=e[0].y,r.lineTo(s,a))}})},polygon:function(r,t,e,n,i,o){if(r.isMultiClip){Mt._multiClip(r,t);return}if(r.isClip){Mt._multiClip(r,Array.isArray(t[0])?t:[t]);return}if(on(t)){var s=Mt._isPattern(r.strokeStyle),a=on(i)&&!r.setLineDash||s&&!o;on(t[0])||(t=[t]);var l=r,h=r.dpr||1,u=h!==1;t.length>1&&!Kn&&(Ta||(Ta=Mt.createCanvas(1,1)),r.canvas._drawn=!1,Ta.width=r.canvas.width,Ta.height=r.canvas.height,r=Ta.getContext("2d"),l_(r,[]),l_(r,i),a_(r,l),u&&r.scale(h,h));var c,f,d;if(a){for(r.save(),f=0,d=t.length;f<d;f++)on(t[f])&&(Mt._ring(r,t[f],null,0,!0),c=n,f>0&&(r.globalCompositeOperation="destination-out",c=1),Mt.fillCanvas(r,c,t[f][0].x,t[f][0].y),f>0?r.globalCompositeOperation="source-over":d>1&&(r.fillStyle="#fff"),Mt._stroke(r,0));r.restore()}var p=r.fillStyle;for(f=0,d=t.length;f<d;f++)on(t[f])&&(o?(Mt.paintSmoothLine(r,t[f],e,o,!0),r.closePath()):Mt._ring(r,t[f],i,e),a||(c=n,f>0&&(r.globalCompositeOperation="destination-out",c=1),Mt.fillCanvas(r,c,t[f][0].x,t[f][0].y),f>0?r.globalCompositeOperation="source-over":d>1&&(r.fillStyle="#fff")),Mt._stroke(r,e));if(r.fillStyle!==p&&(r.fillStyle=p),t.length>1&&!Kn){if(u){var g=1/h;l.scale(g,g)}l.drawImage(Ta,0,0),u&&l.scale(h,h),l.canvas._drawn=r.canvas._drawn,a_(l,r)}}},_ring:function(r,t,e,n,i){var o=Mt._isPattern(r.strokeStyle);!i&&o&&!t[0].equals(t[t.length-1])&&(t=t.concat([t[0]])),r.beginPath(),r.moveTo(t[0].x,t[0].y),Mt._path(r,t,e,n,i),o||r.closePath()},paintSmoothLine_bak:function(r,t,e,n,i,o,s){if(t){if(t.length<=2||!n){Mt.path(r,t,e);return}var a=t.length,l=i?a:a-1;r.beginPath(),r.moveTo(t[0].x,t[0].y),s!==void 0&&(l-=Math.max(l-o-1,0));for(var h,u=0;u<l;u++){var c=t[u].x,f=t[u].y,d=void 0,p=void 0,g=void 0,m=void 0,y=void 0,x=void 0;u-1<0?i?(d=t[l-1].x,p=t[l-1].y):(d=t[u+1].x,p=t[u+1].y):(d=t[u-1].x,p=t[u-1].y),u+1<a?(g=t[u+1].x,m=t[u+1].y):(g=t[u+1-a].x,m=t[u+1-a].y),u+2<a?(y=t[u+2].x,x=t[u+2].y):i?(y=t[u+2-a].x,x=t[u+2-a].y):(y=t[u].x,x=t[u].y);var v=i_(d,p,c,f,g,m,y,x,n,u===l-1?s:1);if(u===l-1&&s>=0&&s<1){r.bezierCurveTo(v[0],v[1],v[2],v[3],v[4],v[5]),t.splice(l-1,a-(l-1)-1);var _=new W(v[4],v[5]);_.prevCtrlPoint=new W(v[2],v[3]),t.push(_),a=t.length}else r.bezierCurveTo(v[0],v[1],v[2],v[3],g,m);t[u].nextCtrlPoint=v.slice(0,2),t[u].prevCtrlPoint=h?h.slice(2):null,h=v}!i&&t[1].prevCtrlPoint&&(t[0].nextCtrlPoint=t[1].prevCtrlPoint,delete t[0].prevCtrlPoint),t[a-1].prevCtrlPoint||(t[a-1].prevCtrlPoint=t[a-2].nextCtrlPoint),Mt._stroke(r,e)}},paintSmoothLine:function(r,t,e,n,i,o,s){if(t){if(t.length<=2||!n){Mt.path(r,t,e);return}var a=t.length,l=i?a:a-1;r.beginPath(),r.moveTo(t[0].x,t[0].y),s!==void 0&&(l-=Math.max(l-o-1,0));for(var h,u,c=0;c<l;c++){var f=t[c].x,d=t[c].y,p=void 0,g=void 0,m=void 0,y=void 0,x=void 0,v=void 0;c-1<0?i?(p=t[l-1].x,g=t[l-1].y):(p=t[c+1].x,g=t[c+1].y):(p=t[c-1].x,g=t[c-1].y),c+1<a?(m=t[c+1].x,y=t[c+1].y):(m=t[c+1-a].x,y=t[c+1-a].y),c+2<a?(x=t[c+2].x,v=t[c+2].y):i?(x=t[c+2-a].x,v=t[c+2-a].y):(x=t[c].x,v=t[c].y);var _=t[c],w=i_(p,g,f,d,m,y,x,v,n,c===l-1?s:1);if(c===l-1&&s>=0&&s<1){r.bezierCurveTo(w[0],w[1],w[2],w[3],w[4],w[5]),t.splice(l-1,a-(l-1)-1);var b=new W(w[4],w[5]);t.push(b),a=t.length}else r.bezierCurveTo(w[0],w[1],w[2],w[3],m,y);c===0?(_.arrowNextPoint=_.arrowNextPoint||new W(0,0),h=w[2],u=w[3],_.arrowNextPoint.x=h,_.arrowNextPoint.y=u):(_.arrowPrePoint=_.arrowPrePoint||new W(0,0),_.arrowPrePoint.x=h,_.arrowPrePoint.y=u,h=w[2],u=w[3],c===l-1&&t[c+1]&&(t[c+1].arrowPrePoint=t[c+1].arrowPrePoint||new W(0,0),t[c+1].arrowPrePoint.x=w[0],t[c+1].arrowPrePoint.y=w[1]))}Mt._stroke(r,e)}},_arcBetween:function(r,t,e,n){var i=Math.abs(n),o=t.distanceTo(e),s=Math.abs(o/2/Math.sin(i/2)),a=Math.asin((e.y-t.y)/o);t.x>e.x&&(a=Math.PI-a);var l=90*Ma-i/2,h=a-l,u=Math.cos(h)*s,c=Math.sin(h)*s,f=t.x+u,d=t.y+c,p=Math.asin((e.y-d)/s);f>e.x&&(p=Math.PI-p);var g=p+i;if(n<0){p+=Math.PI,g+=Math.PI;var m=(t.x+e.x)/2,y=(t.y+e.y)/2,x=f-m,v=d-y;f=m-x,d=y-v}r.beginPath(),r.arc(f,d,s,p,g);var _=(g-p)/100,w=Math.cos(p+_)*s+f,b=Math.sin(p+_)*s+d,A=Math.cos(g-_)*s+f,T=Math.sin(g-_)*s+d;return t.arrowNextPoint=t.arrowNextPoint||new W(0,0),e.arrowPrePoint=e.arrowPrePoint||new W(0,0),n<0?(t.arrowNextPoint.x=w,t.arrowNextPoint.y=b,e.arrowPrePoint.x=A,e.arrowPrePoint.y=T):(t.arrowNextPoint.x=A,t.arrowNextPoint.y=T,e.arrowPrePoint.x=w,e.arrowPrePoint.y=b),[f,d]},_lineTo:function(r,t){r.lineTo(t.x,t.y)},bezierCurveAndFill:function(r,t,e,n){r.beginPath();var i=t[0];r.moveTo(i.x,i.y);var o=[r];o.push.apply(o,t.splice(1)),Mt._bezierCurveTo.apply(Mt,o),Mt.fillCanvas(r,n),Mt._stroke(r,e)},_bezierCurveTo:function(r,t,e,n){r.bezierCurveTo(t.x,t.y,e.x,e.y,n.x,n.y)},ellipse:function(r,t,e,n,i,o,s){function a(l,h,u,c,f){var d=.5522848,p=u*d,g=c*d,m=f*d;r.moveTo(l-u,h),r.bezierCurveTo(l-u,h-g,l-p,h-c,l,h-c),r.bezierCurveTo(l+p,h-c,l+u,h-g,l+u,h),r.bezierCurveTo(l+u,h+m,l+p,h+f,l,h+f),r.bezierCurveTo(l-p,h+f,l-u,h+m,l-u,h),r.closePath()}r.beginPath(),e===n&&e===i?r.arc(t.x,t.y,e,0,2*Math.PI):r.ellipse?n!==i?(r.ellipse(t.x,t.y,e,n,0,Ma*180,Ma*360,!1),r.ellipse(t.x,t.y,e,i,0,0,Ma*180,!1)):r.ellipse(t.x,t.y,e,n,0,0,Ma*360,!1):a(t.x,t.y,e,n,i),Mt.fillCanvas(r,s,t.x-e,t.y-n),Mt._stroke(r,o,t.x-e,t.y-n)},rectangle:function(r,t,e,n,i){var o=t.x,s=t.y;r.beginPath(),r.rect(o,s,e.width,e.height),Mt.fillCanvas(r,i,o,s),Mt._stroke(r,n,o,s)},sector:function(r,t,e,n,i,o){var s=Ma,a=n[0],l=n[1];function h(u,c,f,d,p,g){var m=s*-g,y=s*-p;u.beginPath(),u.moveTo(c,f),u.arc(c,f,d,m,y),u.lineTo(c,f),Mt.fillCanvas(u,o,c-d,f-d),Mt._stroke(u,i,c-d,f-d)}h(r,t.x,t.y,e,a,l)},_isPattern:function(r){return!Se(r)&&!("addColorStop"in r)},drawCross:function(r,t,e,n,i){r.canvas._drawn=!0,r.strokeStyle=i,r.lineWidth=n,r.beginPath(),r.moveTo(t-5,e),r.lineTo(t+5,e),r.moveTo(t,e-5),r.lineTo(t,e+5),r.stroke()},copy:function(r,t){var e=t||de("canvas");return e.width=r.width,e.height=r.height,e.getContext("2d").drawImage(r,0,0),e},pixelRect:function(r,t,e,n){var i=r.lineWidth,o=r.globalAlpha,s=!1;if(i>0&&e>0)s=!0,e<1&&(r.globalAlpha*=e);else if(n>0)n<1&&(r.globalAlpha*=n);else return;r.canvas._drawn=!0,s?r.strokeRect(t[0],t[1],1,1):r.fillRect(t[0],t[1],1,1),r.globalAlpha!==o&&(r.globalAlpha=o)}};function TE(r,t,e,n){var i=t.x,o=t.y,s=e.x,a=e.y,l=n,h=function(w,b){return w<=b},u=function(w,b){return w>=b},c=function(w,b){return Math.min(w,b)},f=function(w,b){return Math.max(w,b)},d={thereYet:u,cap:c},p={thereYet:u,cap:c};o-a>0&&(p.thereYet=h,p.cap=f),i-s>0&&(d.thereYet=h,d.cap=f),r.moveTo(i,o);for(var g=i,m=o,y=0,x=!0,v,_;!(d.thereYet(g,s)&&p.thereYet(m,a));)v=Math.atan2(a-o,s-i),_=l[y],g=d.cap(s,g+Math.cos(v)*_),m=p.cap(a,m+Math.sin(v)*_),x?r.lineTo(g,m):r.moveTo(g,m),y=(y+1)%l.length,x=!x}var o_="data:image/";function s_(r){return r.substring(0,o_.length)===o_?r:dc(r)}function a_(r,t){r.filter=t.filter,r.fillStyle=t.fillStyle,r.globalAlpha=t.globalAlpha,r.lineCap=t.lineCap,r.lineDashOffset=t.lineDashOffset,r.lineJoin=t.lineJoin,r.lineWidth=t.lineWidth,r.shadowBlur=t.shadowBlur,r.shadowColor=t.shadowColor,r.shadowOffsetX=t.shadowOffsetX,r.shadowOffsetY=t.shadowOffsetY,r.strokeStyle=t.strokeStyle}function l_(r,t){!t||!r.setLineDash||!Array.isArray(t)||r.setLineDash(t)}function Tg(r){return"Z__"+r}function to(r){return function(t){Et(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}return e.prototype.on=function(n,i,o){if(!n)return this;if(!Se(n))return this._switch("on",n,i);if(!i)return this;this._eventMap||(this._eventMap={}),n=n;var s=n.toLowerCase().split(" "),a;o||(o=this);var l=It(i._id);i._id=bo();for(var h,u=0,c=s.length;u<c;u++){a=s[u];var f=Tg(a);if(i[f]&&(i[f]._id=i._id),h=this._eventMap[a],h||(h=[],this._eventMap[a]=h),!l){h.push({handler:i,context:o});continue}var d=h.length;if(d>0){for(var p=0;p<d;p++)if(i===h[p].handler&&h[p].context===o)return console.warn(this,"find '".concat(n,"' handler:"),i," The old listener function will be removed"),this}h.push({handler:i,context:o})}return this},e.prototype.addEventListener=function(){for(var n,i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];return(n=this.on).call.apply(n,Ee([this],te(i),!1))},e.prototype.once=function(n,i,o){if(!Se(n)){n=n;var s={};for(var a in n)n.hasOwnProperty(a)&&(s[a]=this._wrapOnceHandler(a,n[a],i));return this._switch("on",s)}n=n;for(var l=n.split(" "),h=0,u=l.length;h<u;h++)this.on(l[h],this._wrapOnceHandler(l[h],i,o));return this},e.prototype.off=function(n,i,o){if(!this._eventMap||!n)return this;if(!Se(n))return this._switch("off",n,i);if(!i)return this;if(!It(i._id))return this;n=n;var s=n.split(" "),a,l,h;o||(o=this);for(var u=0,c=s.length;u<c;u++)if(a=s[u].toLowerCase(),h=Tg(a),l=this._eventMap[a],!!l){for(var f=l.length-1;f>=0;f--){var d=l[f];(i===d.handler||i===d.handler[h])&&d.context===o&&(delete d.handler[h],l.splice(f,1))}l.length||delete this._eventMap[a]}return this},e.prototype.removeEventListener=function(){for(var n,i=[],o=0;o<arguments.length;o++)i[o]=arguments[o];return(n=this.off).call.apply(n,Ee([this],te(i),!1))},e.prototype.listens=function(n,i,o){if(!this._eventMap||!Se(n))return 0;var s=this._eventMap[n.toLowerCase()];if(!s||!s.length)return 0;if(!i)return s.length;for(var a=0,l=s.length;a<l;a++)if(i===s[a].handler&&(U(o)||s[a].context===o))return 1;return 0},e.prototype.getListeningEvents=function(){return this._eventMap?Object.keys(this._eventMap):[]},e.prototype.copyEventListeners=function(n){var i=n._eventMap;if(!i)return this;var o;for(var s in i){o=i[s];for(var a=0,l=o.length;a<l;a++)this.on(s,o[a].handler,o[a].context)}return this},e.prototype.fire=function(n,i){return this._eventParent?this._eventParent.fire.call(this._eventParent,n,i):this._fire.call(this,n,i)},e.prototype._wrapOnceHandler=function(n,i,o){var s=Tg(n),a=!1,l=function h(){for(var u=[],c=0;c<arguments.length;c++)u[c]=arguments[c];a||(delete l[s],a=!0,o?i.call.apply(i,Ee([o],te(u),!1)):i.call.apply(i,Ee([this],te(u),!1)),h._called=!0)};return l[s]=i,l},e.prototype._switch=function(n,i,o){for(var s in i)i.hasOwnProperty(s)&&this[n](s,i[s],o);return this},e.prototype._clearListeners=function(n){if(!(!this._eventMap||!Se(n))){var i=this._eventMap[n.toLowerCase()];i&&(this._eventMap[n]=null)}},e.prototype._clearAllListeners=function(){this._eventMap=null},e.prototype._setEventParent=function(n){return this._eventParent=n,this},e.prototype._setEventTarget=function(n){return this._eventTarget=n,this},e.prototype._fire=function(n,i){if(!this._eventMap)return this;n=n.toLowerCase();var o=this._eventMap[n];if(!o)return this;i||(i={type:n,target:this._eventTarget||this}),i.type=n,i.target=this._eventTarget||this;for(var s=o.slice(0),a,l,h,u=0,c=s.length;u<c;u++)if(s[u]){var f=s[u].handler;f._called||(a=s[u].context,l=!0,h=Gt({},i),a?l=s[u].handler.call(a,h):l=s[u].handler(h),l===!1&&i.domEvent&&jr(i.domEvent))}var d=this._eventMap[n];if(d){for(var p=[],u=0,c=d.length;u<c;u++){var f=d[u].handler;f._called||p.push(d[u])}this._eventMap[n]=p}return this},e}(r)}var ME=function(){function r(){}return r}(),ji=function(r){Et(t,r);function t(e){var n=r.call(this)||this;return n._enabled=!1,n.target=e,n}return t.prototype.enable=function(){return this._enabled?this:(this._enabled=!0,this.addHooks(),this)},t.prototype.disable=function(){return this._enabled?(this._enabled=!1,this.removeHooks(),this):this},t.prototype.enabled=function(){return!!this._enabled},t.prototype.remove=function(){this.disable(),delete this.target,delete this.dom},t}(to(ME)),hi=function(){function r(t){if(!this||!this.setOptions)throw new Error('Class instance is being created without "new" operator.');this.setOptions(t),this.callInitHooks(),this._isUpdatingOptions=!1}return r.prototype.proxyOptions=function(){var t=this;return be.proxy?(this.options=new Proxy(this.options,{set:function(e,n,i){if(n=n,e[n]===i||(e[n]=i,t._isUpdatingOptions))return!0;var o={};return o[n]=i,t.config(o),!0}}),this):this},r.prototype.callInitHooks=function(){var t=Object.getPrototypeOf(this);return this._visitInitHooks(t),this},r.prototype.setOptions=function(t){if((!this.hasOwnProperty("options")||U(this.options))&&(this.options=this.options?Object.create(this.options):{}),!t)return this;for(var e in t)this.options[e]=t[e];return this},r.prototype.config=function(t,e){if(this._isUpdatingOptions=!0,t){if(arguments.length===2&&typeof t=="string"){var o={};o[t]=e,t=o}t=t;for(var s in t)this.options[s]=t[s],this[s]&&this[s]instanceof ji&&(t[s]?this[s].enable():this[s].disable());this.onConfig(t),this._isUpdatingOptions=!1}else{var n={};for(var i in this.options)this.options.hasOwnProperty(i)&&(n[i]=this.options[i]);return this._isUpdatingOptions=!1,n}return this},r.prototype.onConfig=function(t){},r.prototype._visitInitHooks=function(t){if(!this._initHooksCalled){var e=Object.getPrototypeOf(t);e._visitInitHooks&&e._visitInitHooks.call(this,e),this._initHooksCalled=!0;var n=t._initHooks;if(n&&n!==e._initHooks)for(var i=0;i<n.length;i++)n[i].call(this)}},r.addInitHook=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];var i=typeof t=="function"?t:function(){var a;(a=this[t]).call.apply(a,Ee([this],te(e),!1))},o=this.prototype,s=Object.getPrototypeOf(o);return(!o._initHooks||o._initHooks===s._initHooks)&&(o._initHooks=[]),o._initHooks.push(i),this},r.include=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];for(var n=0;n<t.length;n++)Gt(this.prototype,t[n]);return this},r.mergeOptions=function(t){var e=this.prototype,n=Object.getPrototypeOf(e);return(!e.options||e.options===n.options)&&(e.options=e.options?Object.create(e.options):{}),Gt(e.options,t),this},r}(),SE=function(){function r(){}return r}(),CE=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t}(to(SE)),bi=new CE,Mg="dprchange",Sg="docvisibilitychange",Cg="dragstart",Pg="dragend";if(typeof window<"u"&&window.matchMedia)for(var Eg=1;Eg<500;Eg++){var PE=(Eg*.01).toFixed(2),wh=window.matchMedia("screen and (resolution: ".concat(PE,"dppx)"));wh&&(wh.addEventListener?wh.addEventListener("change",be.checkDevicePixelRatio):wh.addListener&&wh.addListener(be.checkDevicePixelRatio))}if(be.devicePixelRatio){var Og=be.devicePixelRatio;Object.defineProperty(be,"devicePixelRatio",{get:function(){return Og},set:function(r){r!==Og&&(Og=r,be.monitorDPRChange&&bi.fire(Mg,{devicePixelRatio:r}))}})}be.webgl&&typeof document<"u"&&(Hi(document,"visibilitychange",function(){bi.fire(Sg,{visibilityState:document.visibilityState})}),Hi(document,"dragstart",function(){bi.fire(Cg)}),Hi(document,"dragend",function(){bi.fire(Pg)}));var Ah={};function h_(r){return function(t){Et(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}return e.registerJSONType=function(n){if(n){if(Ah[n]){console.error("".concat(n," has register. please use Different name for:"),this);return}Ah[n]=this}},e.getJSONClass=function(n){return n?Ah[n]:null},e.prototype.getJSONType=function(){if(this._jsonType===void 0){var n=Object.getPrototypeOf(this).constructor;for(var i in Ah)if(Ah[i]===n){this._jsonType=i;break}}if(!this._jsonType)throw new Error("Found an unregistered Layer/Geometry class!");return this._jsonType},e}(r)}var kg={exports:{}},u_={exports:{}};(function(r,t){(function(e,n){r.exports=n()})(eE,function(){function e(s,a,l,h,u){n(s,a,l||0,h||s.length-1,u||o)}function n(s,a,l,h,u){for(;h>l;){if(h-l>600){var c=h-l+1,f=a-l+1,d=Math.log(c),p=.5*Math.exp(2*d/3),g=.5*Math.sqrt(d*p*(c-p)/c)*(f-c/2<0?-1:1),m=Math.max(l,Math.floor(a-f*p/c+g)),y=Math.min(h,Math.floor(a+(c-f)*p/c+g));n(s,a,m,y,u)}var x=s[a],v=l,_=h;for(i(s,l,a),u(s[h],x)>0&&i(s,l,h);v<_;){for(i(s,v,_),v++,_--;u(s[v],x)<0;)v++;for(;u(s[_],x)>0;)_--}u(s[l],x)===0?i(s,l,_):(_++,i(s,_,h)),_<=a&&(l=_+1),a<=_&&(h=_-1)}}function i(s,a,l){var h=s[a];s[a]=s[l],s[l]=h}function o(s,a){return s<a?-1:s>a?1:0}return e})})(u_);var EE=u_.exports;kg.exports=Th,kg.exports.default=Th;var OE=EE;function Th(r,t){if(!(this instanceof Th))return new Th(r,t);this._maxEntries=Math.max(4,r||9),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),t&&this._initFormat(t),this.clear()}Th.prototype={all:function(){return this._all(this.data,[])},search:function(r){var t=this.data,e=[],n=this.toBBox;if(!Nc(r,t))return e;for(var i=[],o,s,a,l;t;){for(o=0,s=t.children.length;o<s;o++)a=t.children[o],l=t.leaf?n(a):a,Nc(r,l)&&(t.leaf?e.push(a):Rg(r,l)?this._all(a,e):i.push(a));t=i.pop()}return e},collides:function(r){var t=this.data,e=this.toBBox;if(!Nc(r,t))return!1;for(var n=[],i,o,s,a;t;){for(i=0,o=t.children.length;i<o;i++)if(s=t.children[i],a=t.leaf?e(s):s,Nc(r,a)){if(t.leaf||Rg(r,a))return!0;n.push(s)}t=n.pop()}return!1},load:function(r){if(!(r&&r.length))return this;if(r.length<this._minEntries){for(var t=0,e=r.length;t<e;t++)this.insert(r[t]);return this}var n=this._build(r.slice(),0,r.length-1,0);if(!this.data.children.length)this.data=n;else if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){var i=this.data;this.data=n,n=i}this._insert(n,this.data.height-n.height-1,!0)}return this},insert:function(r){return r&&this._insert(r,this.data.height-1),this},clear:function(){return this.data=Ca([]),this},remove:function(r,t){if(!r)return this;for(var e=this.data,n=this.toBBox(r),i=[],o=[],s,a,l,h;e||i.length;){if(e||(e=i.pop(),a=i[i.length-1],s=o.pop(),h=!0),e.leaf&&(l=kE(r,e.children,t),l!==-1))return e.children.splice(l,1),i.push(e),this._condense(i),this;!h&&!e.leaf&&Rg(e,n)?(i.push(e),o.push(s),s=0,a=e,e=e.children[0]):a?(s++,e=a.children[s],h=!1):e=null}return this},toBBox:function(r){return r},compareMinX:c_,compareMinY:f_,toJSON:function(){return this.data},fromJSON:function(r){return this.data=r,this},_all:function(r,t){for(var e=[];r;)r.leaf?t.push.apply(t,r.children):e.push.apply(e,r.children),r=e.pop();return t},_build:function(r,t,e,n){var i=e-t+1,o=this._maxEntries,s;if(i<=o)return s=Ca(r.slice(t,e+1)),Sa(s,this.toBBox),s;n||(n=Math.ceil(Math.log(i)/Math.log(o)),o=Math.ceil(i/Math.pow(o,n-1))),s=Ca([]),s.leaf=!1,s.height=n;var a=Math.ceil(i/o),l=a*Math.ceil(Math.sqrt(o)),h,u,c,f;for(d_(r,t,e,l,this.compareMinX),h=t;h<=e;h+=l)for(c=Math.min(h+l-1,e),d_(r,h,c,a,this.compareMinY),u=h;u<=c;u+=a)f=Math.min(u+a-1,c),s.children.push(this._build(r,u,f,n-1));return Sa(s,this.toBBox),s},_chooseSubtree:function(r,t,e,n){for(var i,o,s,a,l,h,u,c;n.push(t),!(t.leaf||n.length-1===e);){for(u=c=1/0,i=0,o=t.children.length;i<o;i++)s=t.children[i],l=Ig(s),h=IE(r,s)-l,h<c?(c=h,u=l<u?l:u,a=s):h===c&&l<u&&(u=l,a=s);t=a||t.children[0]}return t},_insert:function(r,t,e){var n=this.toBBox,i=e?r:n(r),o=[],s=this._chooseSubtree(i,this.data,t,o);for(s.children.push(r),Sh(s,i);t>=0&&o[t].children.length>this._maxEntries;)this._split(o,t),t--;this._adjustParentBBoxes(i,o,t)},_split:function(r,t){var e=r[t],n=e.children.length,i=this._minEntries;this._chooseSplitAxis(e,i,n);var o=this._chooseSplitIndex(e,i,n),s=Ca(e.children.splice(o,e.children.length-o));s.height=e.height,s.leaf=e.leaf,Sa(e,this.toBBox),Sa(s,this.toBBox),t?r[t-1].children.push(s):this._splitRoot(e,s)},_splitRoot:function(r,t){this.data=Ca([r,t]),this.data.height=r.height+1,this.data.leaf=!1,Sa(this.data,this.toBBox)},_chooseSplitIndex:function(r,t,e){var n,i,o,s,a,l,h,u;for(l=h=1/0,n=t;n<=e-t;n++)i=Mh(r,0,n,this.toBBox),o=Mh(r,n,e,this.toBBox),s=RE(i,o),a=Ig(i)+Ig(o),s<l?(l=s,u=n,h=a<h?a:h):s===l&&a<h&&(h=a,u=n);return u},_chooseSplitAxis:function(r,t,e){var n=r.leaf?this.compareMinX:c_,i=r.leaf?this.compareMinY:f_,o=this._allDistMargin(r,t,e,n),s=this._allDistMargin(r,t,e,i);o<s&&r.children.sort(n)},_allDistMargin:function(r,t,e,n){r.children.sort(n);var i=this.toBBox,o=Mh(r,0,t,i),s=Mh(r,e-t,e,i),a=Hc(o)+Hc(s),l,h;for(l=t;l<e-t;l++)h=r.children[l],Sh(o,r.leaf?i(h):h),a+=Hc(o);for(l=e-t-1;l>=t;l--)h=r.children[l],Sh(s,r.leaf?i(h):h),a+=Hc(s);return a},_adjustParentBBoxes:function(r,t,e){for(var n=e;n>=0;n--)Sh(t[n],r)},_condense:function(r){for(var t=r.length-1,e;t>=0;t--)r[t].children.length===0?t>0?(e=r[t-1].children,e.splice(e.indexOf(r[t]),1)):this.clear():Sa(r[t],this.toBBox)},_initFormat:function(r){var t=["return a"," - b",";"];this.compareMinX=new Function("a","b",t.join(r[0])),this.compareMinY=new Function("a","b",t.join(r[1])),this.toBBox=new Function("a","return {minX: a"+r[0]+", minY: a"+r[1]+", maxX: a"+r[2]+", maxY: a"+r[3]+"};")}};function kE(r,t,e){if(!e)return t.indexOf(r);for(var n=0;n<t.length;n++)if(e(r,t[n]))return n;return-1}function Sa(r,t){Mh(r,0,r.children.length,t,r)}function Mh(r,t,e,n,i){i||(i=Ca(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(var o=t,s;o<e;o++)s=r.children[o],Sh(i,r.leaf?n(s):s);return i}function Sh(r,t){return r.minX=Math.min(r.minX,t.minX),r.minY=Math.min(r.minY,t.minY),r.maxX=Math.max(r.maxX,t.maxX),r.maxY=Math.max(r.maxY,t.maxY),r}function c_(r,t){return r.minX-t.minX}function f_(r,t){return r.minY-t.minY}function Ig(r){return(r.maxX-r.minX)*(r.maxY-r.minY)}function Hc(r){return r.maxX-r.minX+(r.maxY-r.minY)}function IE(r,t){return(Math.max(t.maxX,r.maxX)-Math.min(t.minX,r.minX))*(Math.max(t.maxY,r.maxY)-Math.min(t.minY,r.minY))}function RE(r,t){var e=Math.max(r.minX,t.minX),n=Math.max(r.minY,t.minY),i=Math.min(r.maxX,t.maxX),o=Math.min(r.maxY,t.maxY);return Math.max(0,i-e)*Math.max(0,o-n)}function Rg(r,t){return r.minX<=t.minX&&r.minY<=t.minY&&t.maxX<=r.maxX&&t.maxY<=r.maxY}function Nc(r,t){return t.minX<=r.maxX&&t.minY<=r.maxY&&t.maxX>=r.minX&&t.maxY>=r.minY}function Ca(r){return{children:r,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function d_(r,t,e,n,i){for(var o=[t,e],s;o.length;)e=o.pop(),t=o.pop(),!(e-t<=n)&&(s=t+Math.ceil((e-t)/n/2)*n,OE(r,s,t,e,i),o.push(t,s,s,e))}var DE=kg.exports,FE=pg(DE),Ch={},Ph=function(){function r(){this._tree=FE(9,["[0]","[1]","[2]","[3]"])}return r.prototype.collides=function(t){var e;return e=te(t,4),Ch.minX=e[0],Ch.minY=e[1],Ch.maxX=e[2],Ch.maxY=e[3],this._tree.collides(Ch)},r.prototype.insertBox=function(t){var e=this._tree;return e.insert(t),this},r.prototype.bulkInsertBox=function(t){return this._tree.load(t),this},r.prototype.clear=function(){return this._tree.clear(),this},r}();function Dg(r){return function(t){Et(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}return e.prototype.addHandler=function(n,i){if(!i)return this;if(this._handlers||(this._handlers=[]),this[n])return this[n].enable(),this;var o=this[n]=new i(this);return this._handlers.push(o),this.options[n]&&o.enable(),this},e.prototype.removeHandler=function(n){if(!n)return this;var i=this[n];if(i){var o=this._handlers.indexOf(i);o>=0&&this._handlers.splice(o,1),this[n].remove(),delete this[n]}return this},e.prototype._clearHandlers=function(){for(var n=0,i=this._handlers.length;n<i;n++)this._handlers[n].remove();this._handlers=[]},e}(r)}var p_="touchstart mousedown",Bc={mousedown:"mousemove",touchstart:"touchmove",pointerdown:"touchmove",MSPointerDown:"touchmove"},Fg={mousedown:"mouseup",touchstart:"touchend",pointerdown:"touchend",MSPointerDown:"touchend"},Eh=function(r){Et(t,r);function t(e,n){n===void 0&&(n={});var i=r.call(this,null)||this;return i.dom=e,i.options=n,i}return t.prototype.addHooks=function(){},t.prototype.removeHooks=function(){},t.prototype.enable=function(){return this.dom?(this._onMouseDown=function(e){return this.onMouseDown(e)},Ln(this.dom,p_,this._onMouseDown,this),this):this},t.prototype.disable=function(){return this.dom?(this._offEvents(),Un(this.dom,p_,this._onMouseDown),delete this._onMouseDown,this):this},t.prototype.onMouseDown=function(e){if(!(!this.options.rightclick&&e.button===2)){var n=e;if(!(n.touches&&n.touches.length>1)&&!(this.options.cancelOn&&this.options.cancelOn(e)===!0)){var i=this.dom;i.setCapture?i.setCapture():window.captureEvents&&window.captureEvents(),i.ondragstart=function(){return!1},delete this.moved;var o=n.touches?n.touches[0]:e;this.startPos=new W(o.clientX,o.clientY),Un(document,Bc[e.type],this.onMouseMove),Un(document,Fg[e.type],this.onMouseUp),Ln(document,Bc[e.type],this.onMouseMove,this),Ln(document,Fg[e.type],this.onMouseUp,this),this.options.ignoreMouseleave||(Un(this.dom,"mouseleave",this.onMouseUp),Ln(this.dom,"mouseleave",this.onMouseUp,this)),this.fire("mousedown",{domEvent:e,mousePos:new W(o.clientX,o.clientY)})}}},t.prototype.onMouseMove=function(e){var n=e;if(n.touches&&n.touches.length>1){this.moved&&(this.interupted=!0,this.onMouseUp(e));return}var i=n.touches?n.touches[0]:e,o=new W(i.clientX,i.clientY),s=o.sub(this.startPos);!s.x&&!s.y||(this.moved?this.fire("dragging",{domEvent:e,mousePos:new W(i.clientX,i.clientY)}):(this.fire("dragstart",{domEvent:e,mousePos:this.startPos.copy()}),this.moved=!0))},t.prototype.onMouseUp=function(e){var n=e,i=n.changedTouches?n.changedTouches[0]:e;this._offEvents();var o={domEvent:e};It(i.clientX)&&(o.mousePos=new W(parseInt(i.clientX+"",0),parseInt(i.clientY+"",0))),this.moved&&(o.interupted=this.interupted,this.fire("dragend",o),delete this.interupted,delete this.moved),this.fire("mouseup",o)},t.prototype._offEvents=function(){var e=this.dom;if(Un(e,"mouseleave",this.onMouseUp),!(typeof document>"u"||typeof window>"u")){for(var n in Bc)Un(document,Bc[n],this.onMouseMove),Un(document,Fg[n],this.onMouseUp);e.releaseCapture?e.releaseCapture():window.captureEvents&&window.captureEvents()}},t}(ji),at=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.toNumberArrays=function(e){return Array.isArray(e)?Es(e,function(n){return n.toArray()}):e.toArray()},t.toCoordinates=function(e){if(It(e[0])&&It(e[1]))return new t(e);if(e instanceof t)return e;for(var n=[],i=0,o=e.length;i<o;i++){var s=e[i];Array.isArray(s)?It(s[0])?n.push(new t(s)):n.push(t.toCoordinates(s)):s instanceof t?n.push(s):n.push(new t(s))}return n},t.prototype.closeTo=function(e,n){return n||(n=0),this.x>=e.x-n&&this.x<=e.x+n&&this.y>=e.y-n&&this.y<=e.y+n},t.prototype.abs=function(){return new t(Math.abs(this.x),Math.abs(this.y))},t.prototype.round=function(){return new t(Math.round(this.x),Math.round(this.y))},t.prototype.ceil=function(){return new t(Math.ceil(this.x),Math.ceil(this.y))},t.prototype.floor=function(){return new t(Math.floor(this.x),Math.floor(this.y))},t.prototype.copy=function(){return new t(this.x,this.y,this.z)},t.prototype.toFixed=function(e){return new t(this.x.toFixed(e),this.y.toFixed(e),It(this.z)?this.z.toFixed(e):void 0)},t.prototype.add=function(e,n){var i,o;return U(e.x)?U(e[0])?(i=this.x+e,o=this.y+n):(i=this.x+e[0],o=this.y+e[1]):(i=this.x+e.x,o=this.y+e.y),new t(i,o)},t.prototype.sub=function(e,n){var i,o;return U(e.x)?U(e[0])?(i=this.x-e,o=this.y-n):(i=this.x-e[0],o=this.y-e[1]):(i=this.x-e.x,o=this.y-e.y),new t(i,o)},t.prototype.multi=function(e){return new t(this.x*e,this.y*e)},t.prototype.equals=function(e){return e instanceof this.constructor?this.x===e.x&&this.y===e.y&&this.z===e.z:!1},t}(z1);(function(){function r(t,e){this.type=t,this.properties=e}return r.createProj4=function(t){return new r("proj4",{proj:t})},r.fromProjectionCode=function(t){return t?(t=t.toUpperCase().replace(":",""),r[t]||null):null},r.WGS84=r.createProj4("+proj=longlat +datum=WGS84 +no_defs"),r.EPSG3857=r.createProj4("+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"),r.IDENTITY=r.createProj4("+proj=identity +no_defs"),r.CGCS2000=r.createProj4("+proj=longlat +datum=CGCS2000"),r.EPSG4490=r.CGCS2000,r.BD09LL=r.createProj4("+proj=longlat +datum=BD09"),r.GCJ02=r.createProj4("+proj=longlat +datum=GCJ02"),r})();var LE=new W(0,0),zE=new at(0,0),Lg=new at(0,0),zg=new at(0,0),Hg=new at(0,0),Ng=new at(0,0),HE=new at(0,0),g_=new at(0,0),m_=new at(0,0),Bg=[],Pa,Oh=[],gn=function(){function r(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this._clazz=at;var n=t.length,i=n>0?t[n-1]:null;i&&i.unproject&&(this.projection=t[n-1]),this._dirty=!0,this.antiMeridian=!1,this._initialize(t[0],t[1],t[2],t[3])}return r.prototype._initialize=function(t,e,n,i){if(this.xmin=null,this.xmax=null,this.ymin=null,this.ymax=null,!U(t)){var o=this.projection;if(It(t)&&It(e)&&It(n)&&It(i)){o?this.set(t,e,n,i):this.set(Math.min(t,n),Math.min(e,i),Math.max(t,n),Math.max(e,i));return}else if(Array.isArray(t))o?this.set(t[0],t[1],t[2],t[3]):this.set(Math.min(t[0],t[2]),Math.min(t[1],t[3]),Math.max(t[0],t[2]),Math.max(t[1],t[3]));else if(It(t.x)&&It(e.x)&&It(t.y)&&It(e.y)){var s=t,a=e;o?this.set(s.x,s.y,a.x,a.y):(s.x>a.x?(this.xmin=a.x,this.xmax=s.x):(this.xmin=s.x,this.xmax=a.x),s.y>a.y?(this.ymin=a.y,this.ymax=s.y):(this.ymin=s.y,this.ymax=a.y))}else It(t.xmin)&&It(t.xmax)&&It(t.ymin)&&It(t.ymax)&&this.set(t.xmin,t.ymin,t.xmax,t.ymax)}},r.prototype._add=function(t){return this._dirty=!0,U(t.x)?U(t.xmin)?U(t[0])||(this.xmin+=t[0],this.ymin+=t[1],this.xmax+=t[0],this.ymax+=t[1]):(this.xmin+=t.xmin,this.ymin+=t.ymin,this.xmax+=t.xmax,this.ymax+=t.ymax):(this.xmin+=t.x,this.ymin+=t.y,this.xmax+=t.x,this.ymax+=t.y),this},r.prototype.add=function(t){var e=new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection);return e._add(t)},r.prototype._scale=function(t){return this._dirty=!0,this.xmin*=t,this.ymin*=t,this.xmax*=t,this.ymax*=t,this},r.prototype._sub=function(t){return this._dirty=!0,U(t.x)?U(t.xmin)?U(t[0])||(this.xmin-=t[0],this.ymin-=t[1],this.xmax-=t[0],this.ymax-=t[1]):(this.xmin-=t.xmin,this.ymin-=t.ymin,this.xmax-=t.xmax,this.ymax-=t.ymax):(this.xmin-=t.x,this.ymin-=t.y,this.xmax-=t.x,this.ymax-=t.y),this},r.prototype._substract=function(t){return this._sub(t)},r.prototype.sub=function(t){var e=new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection);return e._sub(t)},r.prototype.substract=function(t){return this.sub(t)},r.prototype.round=function(){return new this.constructor(Math.round(this.xmin),Math.round(this.ymin),Math.round(this.xmax),Math.round(this.ymax),this.projection)},r.prototype._round=function(){return this._dirty=!0,this.xmin=Math.round(this.xmin),this.ymin=Math.round(this.ymin),this.xmax=Math.round(this.xmax),this.ymax=Math.round(this.ymax),this},r.prototype.getMin=function(t){return t?(t.set(this.xmin,this.ymin),t):new this._clazz(this.xmin,this.ymin)},r.prototype.getMax=function(t){return t?(t.set(this.xmax,this.ymax),t):new this._clazz(this.xmax,this.ymax)},r.prototype.getCenter=function(t){var e=(this.xmin+this.xmax)/2,n=(this.ymin+this.ymax)/2;return t?(t.set(e,n),t):new this._clazz(e,n)},r.prototype.isValid=function(){return!U(this.xmin)&&!U(this.ymin)&&!U(this.xmax)&&!U(this.ymax)},r.prototype.equals=function(t){return this.xmin===t.xmin&&this.xmax===t.xmax&&this.ymin===t.ymin&&this.ymax===t.ymax},r.prototype.intersects=function(t){this._project(this),this._project(t);var e=Math.max(this.pxmin,t.pxmin),n=Math.max(this.pymin,t.pymin),i=Math.min(this.pxmax,t.pxmax),o=Math.min(this.pymax,t.pymax);return!(e>i||n>o)},r.prototype.within=function(t){return this._project(this),this._project(t),this.pxmin>=t.pxmin&&this.pxmax<=t.pxmax&&this.pymin>=t.pymin&&this.pymax<=t.pymax},r.prototype.contains=function(t){if(!t)return!1;this._project(this);var e=this.projection;if(e){var n=zE;Array.isArray(t)?(n.x=t[0],n.y=t[1],t=e.project(n,n)):t.x!==void 0?(n.x=t.x,n.y=t.y,t=e.project(n,n)):t.xmin!==void 0&&this._project(t)}return(t.x||t.pxmin||0)>=this.pxmin&&(t.x||t.pxmax||0)<=this.pxmax&&(t.y||t.pymin||0)>=this.pymin&&(t.y||t.pymax||0)<=this.pymax},r.prototype.getWidth=function(){return Math.abs(this.xmax-this.xmin)},r.prototype.getHeight=function(){return Math.abs(this.ymax-this.ymin)},r.prototype.getSize=function(){return new kn(this.getWidth(),this.getHeight())},r.prototype.set=function(t,e,n,i){return this.xmin=t,this.ymin=e,this.xmax=n,this.ymax=i,this._dirty=!0,this},r.prototype.__combine=function(t){t.x!==void 0&&(Pa.xmin=Pa.xmax=t.x,Pa.ymin=Pa.ymax=t.y,t=Pa),this._project(t),this._project(this);var e=It(this.pxmin),n,i,o,s;e?(n=Math.min(this.pxmin,t.pxmin),i=Math.min(this.pymin,t.pymin),o=Math.max(this.pxmax,t.pxmax),s=Math.max(this.pymax,t.pymax)):(n=t.pxmin,i=t.pymin,o=t.pxmax,s=t.pymax);var a=this.projection;if(a){Lg.set(n,i),zg.set(o,s);var l=a.unproject(Lg,Lg),h=a.unproject(zg,zg);n=l.x,i=l.y,o=h.x,s=h.y}return Oh[0]=n,Oh[1]=i,Oh[2]=o,Oh[3]=s,Oh},r.prototype._combine=function(t){if(!t||t.isValid&&!t.isValid())return this;var e=this.__combine(t);return this.set(e[0],e[1],e[2],e[3]),this._dirty=!0,this},r.prototype.combine=function(t){if(!t||t.isValid&&!t.isValid())return this;var e=this.__combine(t);return new this.constructor(e[0],e[1],e[2],e[3],this.projection)},r.prototype.intersection=function(t){if(!this.intersects(t))return null;Hg.x=Math.max(this.pxmin,t.pxmin),Hg.y=Math.max(this.pymin,t.pymin),Ng.x=Math.min(this.pxmax,t.pxmax),Ng.y=Math.min(this.pymax,t.pymax);var e=Hg,n=Ng,i=this.projection;return i&&(e=i.unproject(e,e),n=i.unproject(n,n)),new this.constructor(e,n,i)},r.prototype.expand=function(t){var e,n;return It(t)?e=n=t:(e=t.width||t.x||t[0]||0,n=t.height||t.y||t[1]||0),new this.constructor(this.xmin-e,this.ymin-n,this.xmax+e,this.ymax+n,this.projection)},r.prototype._expand=function(t){var e,n;return It(t)?e=n=t:(e=t.width||t.x||t[0]||0,n=t.height||t.y||t[1]||0),this.xmin-=e,this.ymin-=n,this.xmax+=e,this.ymax+=n,this._dirty=!0,this},r.prototype.toJSON=function(){return{xmin:this.xmin,ymin:this.ymin,xmax:this.xmax,ymax:this.ymax}},r.prototype.toArray=function(t){var e=this.xmin,n=this.ymin,i=this.xmax,o=this.ymax;return t?(t[0].x=e,t[0].y=o,t[1].x=i,t[1].y=o,t[2].x=i,t[2].y=n,t[3].x=e,t[3].y=n,t[4].x=e,t[4].y=o,t):[new this._clazz([e,o]),new this._clazz([i,o]),new this._clazz([i,n]),new this._clazz([e,n]),new this._clazz([e,o])]},r.prototype.toString=function(){return"".concat(this.xmin,",").concat(this.ymin,",").concat(this.xmax,",").concat(this.ymax)},r.prototype.copy=function(){return new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection)},r.prototype.convertTo=function(t,e){if(!this.isValid())return null;var n=e||new this.constructor;e&&n.set(null,null,null,null);var i;return this._clazz===at?i=HE:this._clazz===W&&(i=LE),i.x=this.xmin,i.y=this.ymax,n._combine(t(i)),i.x=this.xmax,n._combine(t(i)),i.y=this.ymin,n._combine(t(i)),i.x=this.xmin,n._combine(t(i)),n},r.prototype._project=function(t){if(!t||!t.isValid()){t&&(t.pxmin=t.pxmax=t.pymin=t.pymax=null);return}var e=this.projection;if(e){if(t._dirty){g_.set(t.xmin,t.ymin),m_.set(t.xmax,t.ymax),Bg[0]=g_,Bg[1]=m_;var n=e.projectCoords(Bg,this.antiMeridian),i=n[0],o=n[1];t.pxmin=Math.min(i.x,o.x),t.pymin=Math.min(i.y,o.y),t.pxmax=Math.max(i.x,o.x),t.pymax=Math.max(i.y,o.y)}delete t._dirty}else t.pxmin=t.xmin,t.pxmax=t.xmax,t.pymin=t.ymin,t.pymax=t.ymax},r}();Pa=new gn(0,0,0,0);var Ce=function(r){Et(t,r);function t(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var i=r.apply(this,Ee([],te(e),!1))||this;return i._clazz=W,i}return t}(gn),y_=function(){function r(t){this.matrix=t}return r.prototype.transform=function(t,e,n){var i=this.matrix[0]*(t.x-this.matrix[2])/e,o=-this.matrix[1]*(t.y-this.matrix[3])/e;return n?(n.x=i,n.y=o,n):new W(i,o)},r.prototype.untransform=function(t,e,n){var i=t.x*e/this.matrix[0]+this.matrix[2],o=t.y*e/-this.matrix[1]+this.matrix[3];return n?(n.x=i,n.y=o,n):new at(i,o)},r}(),Jo={code:"",is:function(r){if(this.code===r)return!0;if(!this.aliases)return!1;for(var t=0;t<this.aliases.length;t++)if(this.aliases[t]===r)return!0;return!1},project:function(r){return r},unproject:function(r){return r},projectCoords:function(r,t){var e=this;if(!r)return[];if(!Array.isArray(r))return this.project(r);if(r.length===0)return[];if(!this.isSphere())return Es(r,this.project,this);if(Array.isArray(r[0]))return r.map(function(y){return e.projectCoords(y,t)});for(var n=t,i=this.getCircum(),o=this.getSphereExtent(),s=o.sy,a=void 0,l=r[0],h=void 0,u=void 0,c=void 0,f=void 0,d=[this.project(l)],p=1,g=r.length;p<g;p++){h=r[p],u=h.x-l.x,c=h.y-l.y,f=this.project(h);var m=!1;Math.abs(u)>180&&n&&(u<0?h.x=360-Math.abs(h.x):h.x=-180-(180-Math.abs(h.x)),m=!0),Math.abs(c)>90&&n&&(a===void 0&&(a=h.y<l.y),a&&(f._add(0,-i.y*Br(c)*s),h._add(0,-180*Br(c)))),m&&(f=this.project(h)),l=h,d.push(f)}return d},unprojectCoords:function(r){return r?Array.isArray(r)?Es(r,this.unproject,this):this.unproject(r):[]},isSphere:function(){return!!this.sphere},isOutSphere:function(r){if(!this.isSphere())return!1;var t=this.getSphereExtent();return!t.contains(r)},wrapCoord:function(r){if(!this.isSphere())return r;var t=this.getSphereExtent(),e=new at(r);return t.contains(e)||(e.x=Os(r.x,t.xmin,t.xmax),e.y=Os(r.y,t.ymin,t.ymax)),e},getCircum:function(){if(!this.circum&&this.isSphere()){var r=this.getSphereExtent();this.circum={x:r.getWidth(),y:r.getHeight()}}return this.circum},getSphereExtent:function(){if(!this.extent&&this.isSphere()){var r=this.project(new at(180,90)),t=this.project(new at(-180,-90));this.extent=new gn(t,r,this),this.extent.sx=r.x>t.x?1:-1,this.extent.sy=r.y>t.y?1:-1}return this.extent}},jg={measureLength:function(r,t){if(!Array.isArray(r))return this.measureLenBetween(r,t);for(var e=0,n=0,i=r.length;n<i-1;n++)e+=this.measureLenBetween(r[n],r[n+1]);return e}},NE={measure:"IDENTITY",measureLenBetween:function(r,t){if(!r||!t)return 0;try{return Math.sqrt(Math.pow(r.x-t.x,2)+Math.pow(r.y-t.y,2))}catch{return 0}},measureArea:function(r){if(!Array.isArray(r))return 0;for(var t=0,e=0,n=r.length;e<n;e++){var i=r[e],o=null;e===n-1?o=r[0]:o=r[e+1],t+=i.x*o.y-i.y*o.x}return Math.abs(t/2)},locate:function(r,t,e,n){return n=n||new at(0,0),n.set(r.x,r.y),this._locate(n,t,e)},_locate:function(r,t,e){return r?(t||(t=0),e||(e=0),!t&&!e||(r.x=r.x+t,r.y=r.y+e),r):null},rotate:function(r,t,e){return r=new at(r.x,r.y),this._rotate(r,t,e)},_rotate:function(){var r=new W(0,0);return function(t,e,n){return r.x=t.x-e.x,r.y=t.y-e.y,r._rotate(n*Math.PI/180),t.x=e.x+r.x,t.y=e.y+r.y,t}}()},v_=Gt(NE,jg),x_=function(){function r(t){this.radius=t}return r.prototype.measureLenBetween=function(t,e){if(!t||!e)return 0;var n=Gn(t.y),i=Gn(e.y),o=n-i,s=Gn(t.x)-Gn(e.x);return n=2*Math.asin(Math.sqrt(Math.pow(Math.sin(o/2),2)+Math.cos(n)*Math.cos(i)*Math.pow(Math.sin(s/2),2))),n*=this.radius,n},r.prototype.measureArea=function(t){var e=Gn(this.radius),n=0,i=t,o=i.length;if(o<3)return 0;var s;for(s=0;s<o-1;s++){var a=i[s],l=i[s+1];n+=a.x*e*Math.cos(Gn(a.y))*l.y*e-l.x*e*Math.cos(Gn(l.y))*a.y*e}var h=i[s],u=i[0];return n+=h.x*e*Math.cos(Gn(h.y))*u.y*e-u.x*e*Math.cos(Gn(u.y))*h.y*e,.5*Math.abs(n)},r.prototype.locate=function(t,e,n,i){return i=i||new at(0,0),i.set(t.x,t.y),this._locate(i,e,n)},r.prototype._locate=function(t,e,n){if(!t)return null;if(e||(e=0),n||(n=0),!e&&!n)return t;var i,o,s=Gn(t.y);if(n!==0){var a=Math.abs(n),l=Math.sin(a/(2*this.radius))*2;s=s+l*(n>0?1:-1),o=Os(s*180/Math.PI,-90,90)}else o=t.y;if(e!==0){var h=Math.abs(e),u=Gn(t.x),c=2*Math.sqrt(Math.pow(Math.sin(h/(2*this.radius)),2)/Math.pow(Math.cos(s),2));u=u+c*(e>0?1:-1),i=Os(u*180/Math.PI,-180,180)}else i=t.x;return t.x=i,t.y=o,t},r.prototype.rotate=function(t,e,n){var i=new at(t);return this._rotate(i,e,n)},r.prototype._rotate=function(t,e,n){var i=BE(e,t),o=i-n,s=this.measureLenBetween(e,t);return t.x=e.x,t.y=e.y,jE(t,s,o,this.radius)},r}();function BE(r,t,e){e===void 0&&(e={});var n;return e.final?n=__(t,r):n=__(r,t),n>180?-(360-n):n}function __(r,t){var e=Gn(r.y),n=Gn(t.y),i=Gn(t.x-r.x);i>Math.PI&&(i-=2*Math.PI),i<-Math.PI&&(i+=2*Math.PI);var o=Math.log(Math.tan(n/2+Math.PI/4)/Math.tan(e/2+Math.PI/4)),s=Math.atan2(i,o);return(Dp(s)+360)%360}function jE(r,t,e,n){var i=t/n,o=r.x*Math.PI/180,s=Gn(r.y),a=Gn(e),l=i*Math.cos(a),h=s+l;Math.abs(h)>Math.PI/2&&(h=h>0?Math.PI-h:-Math.PI-h);var u=Math.log(Math.tan(h/2+Math.PI/4)/Math.tan(s/2+Math.PI/4)),c=Math.abs(u)>1e-11?l/u:Math.cos(s),f=i*Math.sin(a)/c,d=o+f;return r.x=(d*180/Math.PI+540)%360-180,r.y=h*180/Math.PI,r}var VE={measure:"EPSG:4326",sphere:new x_(6378137),measureLenBetween:function(r,t){return this.sphere.measureLenBetween(r,t)},measureArea:function(r){return this.sphere.measureArea.call(this.sphere,r)},_locate:function(r,t,e){return this.sphere._locate.call(this.sphere,r,t,e)},locate:function(r,t,e,n){return this.sphere.locate.call(this.sphere,r,t,e,n)},_rotate:function(r,t,e){return this.sphere._rotate.call(this.sphere,r,t,e)},rotate:function(r,t,e){return this.sphere.rotate.call(this.sphere,r,t,e)}},kh=Gt(VE,jg),GE={measure:"BAIDU",sphere:new x_(637099681e-2),measureLenBetween:function(r,t){return this.sphere.measureLenBetween.call(this.sphere,r,t)},measureArea:function(r){return this.sphere.measureArea.call(this.sphere,r)},_locate:function(r,t,e){return this.sphere._locate.call(this.sphere,r,t,e)},locate:function(r,t,e,n){return this.sphere.locate.call(this.sphere,r,t,e,n)},_rotate:function(r,t,e){return this.sphere._rotate.call(this.sphere,r,t,e)},rotate:function(r,t,e){return this.sphere.rotate.call(this.sphere,r,t,e)}},b_=Gt(GE,jg),w_=kh,Ih={};function Vg(r){Ih[r.measure]=r}Vg(v_),Vg(kh),Vg(b_);var A_={getInstance:function(r){if(!r)return w_;for(var t in Ih)if(ga(Ih,t)){var e=Ih[t].measure;if(!e)continue;if(r.toLowerCase()===e.toLowerCase())return Ih[t]}return null}},T_=1e-7,UE={code:"EPSG:3857",rad:Math.PI/180,metersPerDegree:6378137*Math.PI/180,maxLatitude:85.0511287798,project:function(r,t){var e=this.rad,n=this.metersPerDegree,i=this.maxLatitude,o=r.x,s=Math.max(Math.min(i,r.y),-i),a;s===0?a=0:a=Math.log(Math.tan((90+s)*e/2))/e;var l=o*n,h=a*n;return t?(t.x=l,t.y=h,t):new at(l,h)},unproject:function(r,t){var e=this.rad,n=this.metersPerDegree,i=r.x/n,o=r.y,s;o===0?s=0:(s=o/n,s=(2*Math.atan(Math.exp(s*e))-Math.PI/2)/e),Math.abs(Math.abs(i)-180)<T_&&(i=Br(i)*180),Math.abs(Math.abs(s)-this.maxLatitude)<T_&&(s=Br(s)*this.maxLatitude);var a=i,l=s;return t?(t.x=a,t.y=l,t):new at(a,l)}},M_=Gt({},Jo,UE,kh),$E={code:"EPSG:4326",aliases:["EPSG:4490"],project:function(r,t){return t?(t.x=r.x,t.y=r.y,t):new at(r)},unproject:function(r,t){return t?(t.x=r.x,t.y=r.y,t):new at(r)}},WE=Gt({},Jo,$E,kh),Gg=Math.abs,Ds=Math.sin,Fs=Math.cos,ZE=Math.tan,XE=Math.atan,jc=Math.atan2,YE=Math.sqrt,qE=Math.log,Ug=Math.hypot,S_=Math.sinh,JE=Math.cosh,C_=1/0;function KE(r){var t=[],e=[],n=[],i=[],o,s,a,l,h,u;r.es<=0,a=r.es/(1+YE(1-r.es)),h=l=a/(2-a),t[0]=l*(2+l*(-2/3+l*(-2+l*(116/45+l*(26/45+l*(-2854/675)))))),e[0]=l*(-2+l*(2/3+l*(4/3+l*(-82/45+l*(32/45+l*(4642/4725)))))),h*=l,t[1]=h*(7/3+l*(-8/5+l*(-227/45+l*(2704/315+l*(2323/945))))),e[1]=h*(5/3+l*(-16/15+l*(-13/9+l*(904/315+l*(-1522/945))))),h*=l,t[2]=h*(56/15+l*(-136/35+l*(-1262/105+l*(73814/2835)))),e[2]=h*(-26/15+l*(34/21+l*(8/5+l*(-12686/2835)))),h*=l,t[3]=h*(4279/630+l*(-332/35+l*(-399572/14175))),e[3]=h*(1237/630+l*(-12/5+l*(-24832/14175))),h*=l,t[4]=h*(4174/315+l*(-144838/6237)),e[4]=h*(-734/315+l*(109598/31185)),h*=l,t[5]=h*(601676/22275),e[5]=h*(444337/155925),h=l*l,o=r.k0/(1+l)*(1+h*(1/4+h*(1/64+h/256))),n[0]=l*(-.5+l*(2/3+l*(-37/96+l*(1/360+l*(81/512+l*(-96199/604800)))))),i[0]=l*(.5+l*(-2/3+l*(5/16+l*(41/180+l*(-127/288+l*(7891/37800)))))),n[1]=h*(-1/48+l*(-1/15+l*(437/1440+l*(-46/105+l*(1118711/3870720))))),i[1]=h*(13/48+l*(-3/5+l*(557/1440+l*(281/630+l*(-1983433/1935360))))),h*=l,n[2]=h*(-17/480+l*(37/840+l*(209/4480+l*(-5569/90720)))),i[2]=h*(61/240+l*(-103/140+l*(15061/26880+l*(167603/181440)))),h*=l,n[3]=h*(-4397/161280+l*(11/504+l*(830251/7257600))),i[3]=h*(49561/161280+l*(-179/168+l*(6601661/7257600))),h*=l,n[4]=h*(-4583/161280+l*(108847/3991680)),i[4]=h*(34729/80640+l*(-3418889/1995840)),h*=l,n[5]=h*(-20648693/638668800),i[5]=h*(212378941/319334400),u=g(e,r.phi0),s=-o*(u+m(i,2*u)),r.fwd=c,r.inv=f;function c(x,v){var _,w,b,A,T,S=x.phi,M=x.lam;S=g(e,S),_=Ds(S),w=Fs(S),A=Ds(M),b=Fs(M),S=jc(_,b*w),M=jc(A*w,Ug(_,w*b)),M=p(ZE(M)),T=y(i,2*S,2*M),S+=T[0],M+=T[1],Gg(M)<=2.623395162778?(v.y=o*S+s,v.x=o*M):v.x=v.y=C_}function f(x,v){var _,w,b,A,T,S=x.y,M=x.x;S=(S-s)/o,M=M/o,Gg(M)<=2.623395162778?(T=y(n,2*S,2*M),S+=T[0],M+=T[1],M=XE(S_(M)),_=Ds(S),w=Fs(S),A=Ds(M),b=Fs(M),M=jc(A,b*w),S=jc(_*b,Ug(A,b*w)),v.phi=g(t,S),v.lam=M):v.phi=v.lam=C_}function d(x){var v=1+x,_=v-1;return _===0?x:x*qE(v)/_}function p(x){var v=Gg(x);return v=d(v*(1+v/(Ug(1,v)+1))),x<0?-v:v}function g(x,v){for(var _=2*Fs(2*v),w=x.length-1,b=x[w],A=0,T;--w>=0;)T=-A+_*b+x[w],A=b,b=T;return v+T*Ds(2*v)}function m(x,v){for(var _=2*Fs(v),w=x.length-1,b=x[w],A=0,T;--w>=0;)T=-A+_*b+x[w],A=b,b=T;return Ds(v)*T}function y(x,v,_){for(var w=Ds(v),b=Fs(v),A=S_(_),T=JE(_),S=2*b*T,M=-2*w*A,E=x.length-1,P=x[E],k=0,O=0,I=0,D,z;--E>=0;)D=O,z=k,O=P,k=I,P=-D+S*O-M*k+x[E],I=-z+M*O+S*k;return S=w*T,M=b*A,[S*P-M*I,S*I+M*P]}}var P_=57.29577951308232,Ea=.017453292519943295,QE=6378137,tO=.0066943799901413165,E_=["Traverse_Mercator"],eO={code:"EPSG:9807",aliases:E_,centralMeridian:0,create:function(r){var t={a:QE,es:tO,x0:U(r.falseEasting)?5e5:r.falseEasting,y0:U(r.falseNorthing)?0:r.falseNorthing,k0:r.scaleFactor||.9996,lam0:(r.centralMeridian||0)*Ea,phi0:(r.latitudeOfOrigin||0)*Ea,originLam0:r.startLongtitude||0,originPhi0:r.startLatitude||0};KE(t);var e={lam:0,phi:0},n={},i=0,o=0;(t.originLam0||t.originPhi0)&&(e.lam=t.originLam0*Ea-t.lam0,e.phi=t.originPhi0*Ea,t.fwd(e,n),i=t.a*n.x+t.x0,o=t.a*n.y+t.y0);var s={code:"EPSG:9807",aliases:E_,centralMeridian:r.centralMeridian,project:function(a,l){e.lam=a.x*Ea-t.lam0,e.phi=a.y*Ea,t.fwd(e,n);var h=t.a*n.x+t.x0-i,u=t.a*n.y+t.y0-o;return l?(l.x=h,l.y=u,l):new at(h,u)},unproject:function(a,l){n.x=(a.x-t.x0+i)/t.a,n.y=(a.y-t.y0+o)/t.a,t.inv(n,e);var h=(e.lam+t.lam0)*P_,u=e.phi*P_;return l?(l.x=h,l.y=u,l):new at(h,u)}};return Gt({},Jo,s,kh)}},Vc=Gt({},Jo,eO),nO={code:"utm",aliases:[],create:function(r){var t={},e=parseInt(r.zone);if(t.falseNorthing=r.south?1e7:0,t.falseEasting=5e5,e>0&&e<=60)e--;else throw new Error("zone must be > 0 and <= 60.");return t.centralMeridian=(e+.5)*6-180,t.scaleFactor=.9996,Vc.create(t)}},rO=Gt({},Vc,nO),iO={EARTHRADIUS:637099681e-2,MCBAND:[1289059486e-2,836237787e-2,5591021,348198983e-2,167804312e-2,0],LLBAND:[75,60,45,30,15,0],MC2LL:[[1410526172116255e-23,898305509648872e-20,-1.9939833816331,200.9824383106796,-187.2403703815547,91.6087516669843,-23.38765649603339,2.57121317296198,-.03801003308653,173379812e-1],[-7435856389565537e-24,8983055097726239e-21,-.78625201886289,96.32687599759846,-1.85204757529826,-59.36935905485877,47.40033549296737,-16.50741931063887,2.28786674699375,1026014486e-2],[-3030883460898826e-23,898305509983578e-20,.30071316287616,59.74293618442277,7.357984074871,-25.38371002664745,13.45380521110908,-3.29883767235584,.32710905363475,685681737e-2],[-1981981304930552e-23,8983055099779535e-21,.03278182852591,40.31678527705744,.65659298677277,-4.44255534477492,.85341911805263,.12923347998204,-.04625736007561,448277706e-2],[309191371068437e-23,8983055096812155e-21,6995724062e-14,23.10934304144901,-.00023663490511,-.6321817810242,-.00663494467273,.03430082397953,-.00466043876332,25551644e-1],[2890871144776878e-24,8983055095805407e-21,-3068298e-14,7.47137025468032,-353937994e-14,-.02145144861037,-1234426596e-14,.00010322952773,-323890364e-14,826088.5]],LL2MC:[[-.0015702102444,111320.7020616939,0x60e374c3105a3,-0x24bb4115e2e164,0x5cc55543bb0ae8,-0x7ce070193f3784,0x5e7ca61ddf8150,-0x261a578d8b24d0,0x665d60f3742ca,82.5],[.0008277824516172526,111320.7020463578,6477955746671607e-7,-4082003173641316e-6,1077490566351142e-5,-1517187553151559e-5,1205306533862167e-5,-5124939663577472e-6,9133119359512032e-7,67.5],[.00337398766765,111320.7020202162,4481351045890365e-9,-2339375119931662e-8,7968221547186455e-8,-1159649932797253e-7,9723671115602145e-8,-4366194633752821e-8,8477230501135234e-9,52.5],[.00220636496208,111320.7020209128,51751.86112841131,3796837749470245e-9,992013.7397791013,-122195221711287e-8,1340652697009075e-9,-620943.6990984312,144416.9293806241,37.5],[-.0003441963504368392,111320.7020576856,278.2353980772752,2485758690035394e-9,6070.750963243378,54821.18345352118,9540.606633304236,-2710.55326746645,1405.483844121726,22.5],[-.0003218135878613132,111320.7020701615,.00369383431289,823725.6402795718,.46104986909093,2351.343141331292,1.58060784298199,8.77738589078284,.37238884252424,7.45]],convertMC2LL:function(r,t){for(var e,n=0,i=this.MCBAND.length;n<i;n++)if(Math.abs(r.y)>=this.MCBAND[n]){e=this.MC2LL[n];break}var o=this.convertor(r,e,t);return o},convertLL2MC:function(r,t){var e,n,i;r.x=this.getLoop(r.x,-180,180),r.y=this.getRange(r.y,-74,74);var o=new at(r.x,r.y);for(n=0,i=this.LLBAND.length;n<i;n++)if(o.y>=this.LLBAND[n]){e=this.LL2MC[n];break}if(!e){for(n=this.LLBAND.length-1;n>=0;n--)if(o.y<=-this.LLBAND[n]){e=this.LL2MC[n];break}}var s=this.convertor(r,e,t);return s},convertor:function(r,t,e){if(!r||!t)return null;var n=t[0]+t[1]*Math.abs(r.x),i=Math.abs(r.y)/t[9],o=t[2]+t[3]*i+t[4]*i*i+t[5]*i*i*i+t[6]*i*i*i*i+t[7]*i*i*i*i*i+t[8]*i*i*i*i*i*i;return n*=r.x<0?-1:1,o*=r.y<0?-1:1,e?(e.x=n,e.y=o,e):new at(n,o)},toRadians:function(r){return Math.PI*r/180},toDegrees:function(r){return 180*r/Math.PI},getRange:function(r,t,e){return t!=null&&(r=Math.max(r,t)),e!=null&&(r=Math.min(r,e)),r},getLoop:function(r,t,e){if(r===1/0)return e;if(r===-1/0)return t;for(;r>e;)r-=e-t;for(;r<t;)r+=e-t;return r}},oO={code:"BAIDU",project:function(r,t){return this.convertLL2MC(r,t)},unproject:function(r,t){return this.convertMC2LL(r,t)}},sO=Gt({},Jo,oO,b_,iO),aO={code:"IDENTITY",project:function(r,t){return t?(t.x=r.x,t.y=r.y,t):r.copy()},unproject:function(r,t){return t?(t.x=r.x,t.y=r.y,t):r.copy()}},lO=Gt({},Jo,aO,v_),O_=M_,To=Object.freeze({__proto__:null,BAIDU:sO,Common:Jo,DEFAULT:O_,EPSG3857:M_,EPSG4326:WE,EPSG9807:Vc,IDENTITY:lO,UTM:rO});function $g(r){return function(t){Et(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}return e.registerRenderer=function(n,i){var o=this.prototype,s=Object.getPrototypeOf(o);return(!o._rendererClasses||o._rendererClasses===s._rendererClasses)&&(o._rendererClasses=o._rendererClasses?Object.create(o._rendererClasses):{}),o._rendererClasses[n.toLowerCase()]=i,this},e.getRendererClass=function(n){var i=this.prototype;return i._rendererClasses?i._rendererClasses[n.toLowerCase()]:null},e}(r)}var k_="check_browser_max_fps",hO=`function (exports) {
    exports.initialize = function () {};
    function now(){
        return  new Date().getTime();
    }
    function checkFPS(cb) {
        if (!requestAnimationFrame) {
            cb(-1);
            return;
        }
        const count = 100;
        let idx = 0;
        let id;
        let startTime;
        function loop() {
            idx++;
            if (idx === count) {
                cancelAnimationFrame(id);
                const endTime = now();
                const timePerFPS = (endTime - startTime) / count;
                const fps = Math.floor(1000 / timePerFPS);
                cb(fps);
            } else {
                id = requestAnimationFrame(loop);
            }
        }
        startTime = now();
        id = requestAnimationFrame(loop);
    }
    //recive message
    exports.onmessage = function (msg, postResponse) {
        checkFPS((fps) => {
            if (fps < -1) {
                postResponse('check fps fail');
            } else {
                postResponse(null, { fps });
            }
        })
    }
}`;Rs(k_,function(){return hO});var Wg=0,I_=[],Rh=function(){function r(t){var e=this;wg(),this._delayMessages=[],this.initializing=!1;var n=Gx(t);uE()&&!n&&(this.initializing=!0,console.log("Injecting codes in worker with worker key: :".concat(t)),gE(t,function(){e.initializing=!1,e.created()})),this.workerKey=t,this.workerPool=vg(),this.currentActor=0,this.actorId=bo(),this.workers=this.workerPool.acquire(this.actorId),this.callbacks={},this.callbackID=0,this.receiveFn=this.receive.bind(this),this.workers.forEach(function(i){i.addEventListener("message",e.receiveFn,!1)}),Ux(t)}return r.prototype.created=function(){var t=this;this._delayMessages.forEach(function(e){var n=e.command,i=e.data,o=e.buffers,s=e.cb,a=e.workerId;t[n](i,o,s,a)}),this._delayMessages=[]},r.prototype.isActive=function(){return!!this.workers},r.prototype.broadcast=function(t,e,n){var i=this;return this.initializing?(this._delayMessages.push({command:"broadcast",data:t,buffers:e,cb:n}),this):(n=n||function(){},uO(this.workers,function(o,s){i.send(t,e,s,o.id)},n),this)},r.prototype.send=function(t,e,n,i){if(this.initializing)return this._delayMessages.push({command:"send",data:t,buffers:e,cb:n,workerId:i}),this;var o=n?"".concat(this.actorId,":").concat(this.callbackID++):null;return n&&(this.callbacks[o]=n),this.post({data:t,callback:String(o)},e,i),this},r.prototype.receive=function(t){var e=this,n=t.data,i=n.callback,o=this.callbacks[i];delete this.callbacks[i],n.type==="<request>"?this.actorId===n.actorId&&this[n.command](n.params,function(s,a,l){var h={type:"<response>",callback:n.callback};s?h.error=s.message:h.data=a,e.post(h,l||I_,n.workerId)}):o&&n.error?o(n.error):o&&o(null,n.data)},r.prototype.remove=function(){var t=this;this.workers.forEach(function(e){e.removeEventListener("message",t.receiveFn,!1)}),delete this.receiveFn,delete this.workers,delete this.callbacks,delete this.workerPool},r.prototype.post=function(t,e,n){return(typeof n!="number"||isNaN(n))&&(n=this.currentActor=(this.currentActor+1)%this.workerPool.workerCount),t.workerId=n,t.workerKey=this.workerKey,t.actorId=this.actorId,this.workerPool.addMessage(n,t,e||I_),n},r.prototype.getDedicatedWorker=function(){return Wg=(Wg+1)%this.workerPool.workerCount,Wg},r}();function uO(r,t,e){r.length||e(null,[]);var n=r.length,i=new Array(r.length),o=null;r.forEach(function(s,a){t(s,function(l,h){l&&(o=l),i[a]=h,--n===0&&e(o,i)})})}var Zg,cO=function(r){Et(t,r);function t(){return r.call(this,k_)||this}return t}(Rh);function fO(r){Zg||(Zg=new cO),Zg.send({},[],function(t,e){t?(console.error(t),r()):r(e.fps)})}var Xg=!1;function dO(){Xg||Li.maxFPS<=0&&(Xg=!0,fO(function(r){It(r)&&r>0&&Li.maxFPS<=0&&(Li.maxFPS=r),Xg=!1}))}qx(dO);var pO=[],gO=function(r){Et(t,r);function t(){return r.call(this,mg)||this}return t.prototype.fetchImage=function(e,n){var i={url:e};this.send(i,pO,n)},t}(Rh),Oa=function(r){Et(t,r);function t(e){var n=r.call(this)||this;return n.layer=e,n._painted=!1,n._drawTime=0,be.decodeImageInWorker&&!be.safari&&!be.iosWeixin&&(n._resWorkerConn=new gO),n.setToRedraw(),n}return t.prototype.render=function(e){this.prepareRender(),!(!this.getMap()||!this.layer.isVisible())&&(this.resources||(this.resources=new Ls),this.checkAndDraw(this._tryToDraw,e),this._frameTime=e)},t.prototype.getFrameTimestamp=function(){return this._frameTime||0},t.prototype.checkAndDraw=function(e){for(var n=this,i=[],o=1;o<arguments.length;o++)i[o-1]=arguments[o];if(this._toRedraw=!1,this.checkResources){var s=this.checkResources();s.length>0?(this._loadingResource=!0,this.loadResources(s).then(function(){if(n._loadingResource=!1,n.layer){n.layer.fire("resourceload");var a=n.layer.getMap();n.setToRedraw(),a.getRenderer().callInNextFrame(function(){n.setToRedraw()})}})):e.call.apply(e,Ee([this],te(i),!1))}else e.call.apply(e,Ee([this],te(i),!1))},t.prototype.testIfNeedRedraw=function(){var e=this.getMap();return this._loadingResource?!1:this._toRedraw?!0:e.isInteracting()&&!this.drawOnInteracting?!1:!!this.needToRedraw()},t.prototype.needToRedraw=function(){var e=this.getMap();return e.isInteracting()||e.getRenderer().isViewChanged()?!(!e.getPitch()&&e.isMoving()&&!e.isZooming()&&!e.isRotating()&&!this.layer.options.forceRenderOnMoving):!1},t.prototype.onSkipDrawOnInteracting=function(){},t.prototype.isLoadingResource=function(){return this._loadingResource},t.prototype.isRenderComplete=function(){return!!this._renderComplete},t.prototype.mustRenderOnInteracting=function(){return!this._painted},t.prototype.setToRedraw=function(){return this._toRedraw=!0,this},t.prototype.setCanvasUpdated=function(){return this._canvasUpdated=!0,this},t.prototype.isCanvasUpdated=function(){return!!this._canvasUpdated},t.prototype.remove=function(){this.onRemove(),delete this._loadingResource,delete this.middleWest,delete this.canvas,delete this.context,delete this.canvasExtent2D,delete this._extent2D,this.resources&&this.resources.remove(),delete this.resources,this._resWorkerConn&&(this._resWorkerConn.remove(),delete this._resWorkerConn),delete this.layer},t.prototype.onRemove=function(){},t.prototype.onAdd=function(){},t.prototype.getMap=function(){return this.layer?this.layer.getMap():null},t.prototype.getCanvasImage=function(){var e=this.getMap();if(this._canvasUpdated=!1,this._renderZoom!==e.getZoom()||!this.canvas||!this._extent2D||this.isBlank()||this.layer.isEmpty&&this.layer.isEmpty())return null;var n=e._pointToContainerPoint(this.middleWest)._add(0,-e.height/2);return{image:this.canvas,layer:this.layer,point:n}},t.prototype.clear=function(){this.clearCanvas()},t.prototype.isBlank=function(){return!this._painted},t.prototype.show=function(){this.setToRedraw()},t.prototype.hide=function(){this.clear(),this.setToRedraw()},t.prototype.setZIndex=function(e){this.setToRedraw()},t.prototype.hitDetect=function(e){if(!this.context||this.layer.isEmpty&&this.layer.isEmpty()||this.isBlank()||this._errorThrown||this.layer.isVisible&&!this.layer.isVisible())return!1;var n=this.getMap(),i=n.getDevicePixelRatio(),o=n.getSize();if(e.x<0||e.x>o.width*i||e.y<0||e.y>o.height*i)return!1;var s=this.getImageData&&this.getImageData();if(s){var a=Math.round(i*e.x),l=Math.round(i*e.y),h=l*s.width*4+a*4;return s.data[h+3]>0}try{var u=this.context.getImageData(i*e.x,i*e.y,1,1).data;if(u[3]>0)return!0}catch(c){return this._errorThrown||(console&&console.warn(`hit detect failed with tainted canvas, some geometries have external resources in another domain:
`,c),this._errorThrown=!0),!1}return!1},t.prototype.loadResources=function(e){this.resources||(this.resources=new Ls);var n=this.resources,i=[];if(on(e))for(var o={},s=e.length-1;s>=0;s--){var a=e[s];!a||!a.length||o[a.join("-")]||(o[a.join("-")]=1,n.isResourceLoaded(a,!0)||i.push(new Promise(this._promiseResource(a))))}return Promise.all(i)},t.prototype.prepareRender=function(){delete this._renderComplete;var e=this.getMap();this._renderZoom=e.getZoom(),this.canvasExtent2D=this._extent2D=e.get2DExtent(),this.middleWest=e._containerPointToPoint(new W(0,e.height/2))},t.prototype.createCanvas=function(){if(!this.canvas){var e=this.getMap(),n=e.getSize(),i=e.getDevicePixelRatio(),o=Math.round(i*n.width),s=Math.round(i*n.height);if(this.layer._canvas){var a=this.layer._canvas;a.width=o,a.height=s,a.style&&(a.style.width=n.width+"px",a.style.height=n.height+"px"),this.canvas=this.layer._canvas}else this.canvas=Mt.createCanvas(o,s,e.CanvasClass);this.onCanvasCreate()}},t.prototype.onCanvasCreate=function(){},t.prototype._canvasContextScale=function(e,n){return e.scale(n,n),e.dpr=n,this},t.prototype.createContext=function(){if(!(this.gl&&this.gl.canvas===this.canvas||this.context)&&(this.context=Mt.getCanvas2DContext(this.canvas),!!this.context)){this.context.dpr=1,this.layer.options.globalCompositeOperation&&(this.context.globalCompositeOperation=this.layer.options.globalCompositeOperation);var e=this.getMap().getDevicePixelRatio();e!==1&&this._canvasContextScale(this.context,e)}},t.prototype.resetCanvasTransform=function(){if(this.context){var e=this.getMap().getDevicePixelRatio();this.context.setTransform(e,0,0,e,0,0)}},t.prototype.resizeCanvas=function(e){var n=this.canvas;if(n){var i=e||this.getMap().getSize(),o=this.getMap().getDevicePixelRatio(),s=Wp(i,o),a=s.width,l=s.height,h=s.cssWidth,u=s.cssHeight;this.layer._canvas&&(n.style.width!==h||n.style.height!==u)&&(n.style.width=h,n.style.height=u),!(n.width===a&&n.height===l)&&(n.height=l,n.width=a,this.context&&(this.context.dpr=1),o!==1&&this.context&&this._canvasContextScale(this.context,o))}},t.prototype.clearCanvas=function(){if(!(!this.context||!this.getMap())){var e=this.getMap().getDevicePixelRatio(),n=1/e,i=this.canvas.width*n,o=this.canvas.height*n;Mt.clearRect(this.context,0,0,Math.max(i,this.canvas.width),Math.max(o,this.canvas.height))}},t.prototype.prepareCanvas=function(){this.canvas?(this.resetCanvasTransform(),this.clearCanvas(),this.resizeCanvas()):(this.createCanvas(),this.createContext(),this.layer.onCanvasCreate(),this.layer.fire("canvascreate",{context:this.context,gl:this.gl})),delete this._maskExtent;var e=this.layer.getMask();if(!e)return this.layer.fire("renderstart",{context:this.context,gl:this.gl}),null;var n=this._maskExtent=e._getMaskPainter().get2DExtent();return n&&this._extent2D&&!n.intersects(this._extent2D)?(this.layer.fire("renderstart",{context:this.context,gl:this.gl}),n):(this.layer.fire("renderstart",{context:this.context,gl:this.gl}),n)},t.prototype.clipCanvas=function(e){var n=this.layer.getMask();if(!n||!this.layer.options.maskClip)return!1;var i=this.middleWest,o=this.getMap();this.middleWest=o._containerPointToPoint(new W(0,o.height/2)),e.save();var s=o.getDevicePixelRatio();if(s!==1&&(e.save(),this._canvasContextScale(e,s)),n.getGeometries){e.isMultiClip=!0;var a=n.getGeometries()||[];e.beginPath(),a.forEach(function(h){var u=h._getMaskPainter();u.paint(null,e)}),e.stroke(),e.isMultiClip=!1}else{e.isClip=!0,e.beginPath();var l=n._getMaskPainter();l.paint(null,e),e.isClip=!1}s!==1&&e.restore();try{e.clip("evenodd")}catch(h){console.error(h)}return this.middleWest=i,!0},t.prototype.getViewExtent=function(){return{extent:this._extent2D,maskExtent:this._maskExtent,zoom:this._renderZoom,middleWest:this.middleWest}},t.prototype.completeRender=function(){this.getMap()&&(this._renderComplete=!0,this.layer.fire("renderend",{context:this.context,gl:this.gl}),this.setCanvasUpdated())},t.prototype.getEvents=function(){return{_zoomstart:this.onZoomStart,_zooming:this.onZooming,_zoomend:this.onZoomEnd,_resize:this.onResize,_movestart:this.onMoveStart,_moving:this.onMoving,_moveend:this.onMoveEnd,_dragrotatestart:this.onDragRotateStart,_dragrotating:this.onDragRotating,_dragrotateend:this.onDragRotateEnd,_spatialreferencechange:this.onSpatialReferenceChange}},t.prototype.onZoomStart=function(e){},t.prototype.onZoomEnd=function(e){this.setToRedraw()},t.prototype.onZooming=function(e){},t.prototype.onMoveStart=function(e){},t.prototype.onMoving=function(e){},t.prototype.onMoveEnd=function(e){this.setToRedraw()},t.prototype.onResize=function(e){delete this._extent2D,this.resizeCanvas(),this.setToRedraw()},t.prototype.onDragRotateStart=function(e){},t.prototype.onDragRotating=function(e){},t.prototype.onDragRotateEnd=function(e){this.setToRedraw()},t.prototype.onSpatialReferenceChange=function(e){},t.prototype.getDrawTime=function(){return this._drawTime},t.prototype._tryToDraw=function(e){if(this._toRedraw=!1,!this.canvas&&this.layer.isEmpty&&this.layer.isEmpty()){this._renderComplete=!0;return}this._drawAndRecord(e)},t.prototype._drawAndRecord=function(e){if(this.getMap()){var n=this._painted;this._painted=!0;var i=Qe();this.draw(e),i=Qe()-i,this._drawTime=n?i:i/2,n&&this.layer&&this.layer.options.logDrawTime&&console.log(this.layer.getId(),"frameTimeStamp:",e,"drawTime:",this._drawTime)}},t.prototype._promiseResource=function(e){var n=this,i=this.layer,o=this.resources,s=i.options.crossOrigin,a=i.options.renderer||"";return function(l){if(o.isResourceLoaded(e,!0)){l(e);return}var h=hx(e[0]);if(Cx(h)){createImageBitmap(h).then(function(f){n._cacheResource(e,f),l(e)}).catch(function(f){console.error(f),l(e)});return}var u=!Ps(e[0])&&n._resWorkerConn&&(i.options.renderer!=="canvas"||i.options.decodeImageInWorker);if(u)n._resWorkerConn.fetchImage(h,function(f,d){if(f){f&&typeof console<"u"&&console.warn(f),l(e);return}$p(d,function(p){n._cacheResource(e,p),l(e)})});else{var c=new Image;U(s)?a!=="canvas"&&(c.crossOrigin=""):c.crossOrigin=s,Ps(e[0])&&!Kn&&(e[1]&&(e[1]*=2),e[2]&&(e[2]*=2)),c.onload=function(){n._cacheResource(e,c),l(e)},c.onabort=function(f){console&&console.warn("image loading aborted: "+e[0]),f&&console&&console.warn(f),l(e)},c.onerror=function(f){f&&typeof console<"u"&&console.warn(f),o.markErrorResource(e),l(e)},hh(c,[h])}}},t.prototype._cacheResource=function(e,n){if(!(!this.layer||!this.resources)){var i=e[1],o=e[2];if(this.layer.options.cacheSvgOnCanvas&&Ps(e[0])===1&&(be.edge||be.ie)){U(i)&&(i=n.width||this.layer.options.defaultIconSize[0]),U(o)&&(o=n.height||this.layer.options.defaultIconSize[1]);var s=Mt.createCanvas(i,o);Mt.image(s.getContext("2d"),n,0,0,i,o),n=s}this.resources.addResource(e,n)}},t}(hi),Ls=function(){function r(){this.resources={},this._errors={}}return r.prototype.addResource=function(t,e){var n=this;if(this.resources[t[0]]={image:e,width:+t[1],height:+t[2],refCnt:0},e&&e.width&&e.height&&!e.close&&be.imageBitMap&&!be.safari&&!be.iosWeixin){if(e.src&&Ps(e.src))return;createImageBitmap(e).then(function(i){n.resources[t[0]]&&(n.resources[t[0]].image=i)})}},r.prototype.isResourceLoaded=function(t,e){if(!t)return!1;var n=this._getImgUrl(t);if(this._errors[n])return!0;var i=this.resources[n];return!(!i||e&&Ps(t[0])&&(+t[1]>i.width||+t[2]>i.height))},r.prototype.login=function(t){var e=this.resources[t];e&&e.refCnt++},r.prototype.logout=function(t){var e=this.resources[t];e&&e.refCnt--<=0&&(e.image&&e.image.close&&e.image.close(),delete this.resources[t])},r.prototype.getImage=function(t){var e=this._getImgUrl(t);return!this.isResourceLoaded(t)||this._errors[e]?null:this.resources[e].image},r.prototype.markErrorResource=function(t){this._errors[this._getImgUrl(t)]=1},r.prototype.merge=function(t){if(!t)return this;for(var e in t.resources){var n=t.resources[e];this.addResource([e,n.width,n.height],n.image)}return this},r.prototype.forEach=function(t){if(!this.resources)return this;for(var e in this.resources)ga(this.resources,e)&&t(e,this.resources[e]);return this},r.prototype._getImgUrl=function(t){return Array.isArray(t)?t[0]:t},r.prototype.remove=function(){for(var t in this.resources){var e=this.resources[t];e&&e.image&&e.image.close&&e.image.close()}this.resources={}},r}(),mO=`
function (exports) {
    exports.onmessage = function (msg, postResponse) {
        var url = msg.data.url;
        var fetchOptions = msg.data.fetchOptions;
        requestImageOffscreen(url, function (err, data) {
            var buffers = [];
            if (data && data.data) {
                buffers.push(data.data);
            }
            postResponse(err, data, buffers);
        }, fetchOptions);
    };

    function requestImageOffscreen(url, cb, fetchOptions) {
        fetch(url, fetchOptions ? fetchOptions : {})
            .then(response => response.arrayBuffer())
            .then(arrayBuffer => {
                const blob=new Blob([arrayBuffer]);
                return createImageBitmap(blob);
            })
            .then(bitmap => {
                cb(null, {data:bitmap});
            }).catch(err => {
                console.warn('error when loading tile:', url);
                console.warn(err);
                cb(err);
            });
    }
}`;function yO(){be.decodeImageInWorker&&Rs(mg,function(){return mO})}yO();var ka={markerWidth:10,markerHeight:10,markerLineWidth:1},Yg=new W(0,0);function vO(r){if(!r)return 0;var t=r.x,e=r.y;if(t===0&&e===0)return 0;if(t===0||!t){if(e<0)return-Math.PI/2;if(e>0)return Math.PI/2}var n=e/t;return e<0&&t<0?Math.atan(n)-Math.PI:e>0&&t<0?Math.atan(n)+Math.PI:Math.atan(n)}function xO(r,t,e){var n=Math.PI/2+e,i=Math.PI/4+e,o=e,s=t,a=Math.sqrt(r*r+t*t),l=r,h=0,u=0,c=Math.cos(n)*s,f=Math.sin(n)*s,d=Math.cos(i)*a,p=Math.sin(i)*a,g=Math.cos(o)*l,m=Math.sin(o)*l,y=Math.min(c,d,g,h),x=Math.min(f,p,m,u),v=Math.max(c,d,g,h),_=Math.max(f,p,m,u);return[y,x,v-y,_-x]}function Dh(r,t,e,n,i,o){var s=i.x+o.x,a=i.y+o.y;Yg.x=s,Yg.y=a;var l=vO(Yg),h=Math.sqrt(s*s+a*a),u=Math.cos(t+l)*h,c=Math.sin(t+l)*h,f=0,d=0;f+=u,d+=c;var p=te(xO(e,n,t),4),g=p[0],m=p[1],y=p[2],x=p[3];f+=g,d+=m;var v=f+Math.max(e,y),_=d+Math.max(n,x);return r.set(f,d,v,_),r}function R_(){return .5}var _O=new W(0,0);function qg(r,t,e,n,i,o,s){var a=_O.set(t,e);if(n)return Dh(r,n,o,s,a,i);var l=r.set(a.x,a.y,a.x+o,a.y+s);return l._add(i),n&&wO(l,n),l}var bO=[];function D_(r,t,e){if(e=e||Jg(bO,t),e&&(e[0]===0||e[1]===0))return im(r),r;var n=z_(t,e[0],e[1]);return qg(r,t.markerDx||0,t.markerDy||0,Gc(t),n,e[0],e[1])}function F_(r){return r==="rectangle"?"right":"middle"}function L_(r){return r==="bar"||r==="pie"||r==="pin"?"top":r==="rectangle"?"bottom":"middle"}var Ia=new kn(0,0);function z_(r,t,e){var n=R_(),i=2*(r.shadowBlur||0),o=i+n;Ia.width=t,Ia.height=e;var s=r.markerType,a=wo(Ia,r.markerHorizontalAlignment||F_(s),r.markerVerticalAlignment||L_(s));return a.x!==-t/2&&(a.x-=Br(a.x+t/2)*o),a.y!==-e/2&&(a.y-=Br(a.y+e/2)*o),a}function Jg(r,t){var e=R_(),n=se(t.markerWidth,ka.markerWidth),i=se(t.markerHeight,ka.markerHeight);if(n===0||i===0)return r[0]=0,r[1]=0,r;var o=se(t.markerLineWidth,ka.markerLineWidth),s=2*((t.shadowBlur||0)+Math.max(Math.abs(t.shadowOffsetX||0)+Math.abs(t.shadowOffsetY||0))),a=Math.round(n+o+s+e*2),l=Math.round(i+o+s+e*2);return r[0]=a,r[1]=l,r}var H_=new Ce;function wO(r,t){var e=r.xmin,n=r.ymin,i=r.xmax,o=r.ymax;return H_.set(e,n,i,o),H_.convertTo(function(s){return s._rotate(t)},r)}function Gc(r,t){t===void 0&&(t="markerRotation");var e=r[t];return It(e)?-e*Math.PI/180:0}function Kg(r,t,e){var n=t.markerFile,i=e?e.getImage(n):null,o=t.markerWidth||(i?i.width:0),s=t.markerHeight||(i?i.height:0);if(Ia.width=o,Ia.height=s,t.markerWidth===0||t.markerHeight===0)return im(r),r;var a=wo(Ia,t.markerHorizontalAlignment||"middle",t.markerVerticalAlignment||"top");return qg(r,t.markerDx||0,t.markerDy||0,Gc(t),a,o,s)}function N_(r,t,e){var n=e.size;if(n&&(n.width===0||n.height===0))return im(r),r;var i=wo(n,t.textHorizontalAlignment,t.textVerticalAlignment),o=t.textHaloRadius||0,s=qg(r,t.textDx||0,t.textDy||0,Gc(t,"textRotation"),i,n.width,n.height);return s.xmin-=o,s.xmax+=o,s.ymin-=o,s.ymax+=o,s}var Uc=new Ce;function Qg(r,t,e,n){var i=r||new Ce;if(Array.isArray(t)){for(var o=t,s=0;s<o.length;s++)Qg(i,o[s],e,n[s]);return i}return $c(t)&&i._combine(N_(Uc,t,n)),tm(t)&&i._combine(Kg(Uc,t,e)),Wc(t)&&i._combine(D_(Uc,t)),em(t)&&i._combine(Kg(Uc,t)),i}function $c(r){return r?!U(r.textName):!1}function tm(r){return r?!U(r.markerFile):!1}function Wc(r){return r?!!(U(r.markerFile)&&!U(r.markerType)&&r.markerType!=="path"):!1}function em(r){return r?!!(U(r.markerFile)&&r.markerType==="path"):!1}var nm=["markerWidth","markerHeight","markerHorizontalAlignment","markerVerticalAlignment","markerDx","markerDy","markerRotation","textName","textSize","textDx","textDy","textVerticalAlignment","textHorizontalAlignment","textRotation","textWrapWidth"],rm=["textName","markerType","markerFile","textHaloRadius","shadowBlur","shadowOffsetX","shadowOffsetY","textWrapWidth"];function im(r){r&&(r.xmin=1/0,r.ymin=1/0,r.xmax=-1/0,r.ymax=-1/0)}function Zc(r,t,e,n){for(var i=[],o=0,s,a=0,l=r.length;a<l-1;a++)s=AO(r[a],r[a+1],t,a,e,n),s&&(i[o]=i[o]||[],i[o].push({point:s[0],index:a}),(s[1]!==r[a+1]||a===l-2)&&(i[o].push({point:s[1],index:a+1}),o++));return i}var B_;function AO(r,t,e,n,i,o){var s=n?B_:Ra(r,e),a=Ra(t,e),l,h,u;for(B_=a;;){if(!(s|a))return[r,t];if(s&a)return!1;if(o)return[r,t];l=s||a,h=om(r,t,l,e,i),u=Ra(h,e),l===s?(r=h,s=u):(t=h,a=u)}}function Xc(r,t,e){var n=[1,4,2,8],i,o,s,a,l,h,u,c,f;for(o=0,u=r.length;o<u;o++)r[o]._code=Ra(r[o],t);for(a=0;a<4;a++){for(c=n[a],i=[],o=0,u=r.length,s=u-1;o<u;s=o++)l=r[o],h=r[s],l._code&c?h._code&c||(f=om(h,l,c,t,e),f._code=Ra(f,t),i.push(f)):(h._code&c&&(f=om(h,l,c,t,e),f._code=Ra(f,t),i.push(f)),i.push(l));r=i}return r}function om(r,t,e,n,i){var o=t.x-r.x,s=t.y-r.y,a=n.getMin(),l=n.getMax(),h,u;e&8?(h=r.x+o*(l.y-r.y)/s,u=l.y):e&4?(h=r.x+o*(a.y-r.y)/s,u=a.y):e&2?(h=l.x,u=r.y+s*(l.x-r.x)/o):e&1&&(h=a.x,u=r.y+s*(a.x-r.x)/o);var c=new W(h,u);return i&&c._round(),c}function Ra(r,t){var e=0;return r.x<t.getMin().x?e|=1:r.x>t.getMax().x&&(e|=2),r.y<t.getMin().y?e|=4:r.y>t.getMax().y&&(e|=8),e}function j_(r,t,e,n){r=new W(r);var i=Math.abs(e.x-t.x),o=Math.abs(e.y-t.y),s=Math.sqrt(Math.abs(i*i-o*o)),a=i>=o,l,h,u;return a?(l=new W(t.x-s,t.y),h=new W(t.x+s,t.y),u=i*2):(l=new W(t.x,t.y-s),h=new W(t.x,t.y+s),u=o*2),r.distanceTo(l)+r.distanceTo(h)<=u+2*n}function V_(r){if(!r)return[0,0];var t=1/0,e=-1/0;if(It(r))return t=e=r,[t,e];var n=function(a){for(var l=0,h=a.length;l<h;l++){var u=a[l];t=Math.min(t,u),e=Math.max(e,u)}};if(!Array.isArray(r[0]))return n(r),[t,e];for(var i=0,o=r.length;i<o;i++){var s=r[i];n(s)}return[t,e]}var TO=function(){function r(){this.bbox=qo()}return r.prototype._setBBOX=function(t,e,n,i,o){return t.isHitTesting||Dc(this.bbox,e,n,i,o),this},r.prototype._bufferBBOX=function(t,e){return t.isHitTesting||Hx(this.bbox,e),this},r.prototype.getMap=function(){return this.geometry.getMap()},r.prototype.getPainter=function(){return this.painter},r.prototype.isDynamicSize=function(){return!1},r.prototype.isVisible=function(){if(!this.style)return!0;var t=this.style.visible;if(t===!1||t===0)return!1;var e=this.style.opacity;return!(e<=0)},r.testColor=function(t){return!t||!Se(t)?!1:g5.indexOf(t)>=0},r}(),G_=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype._prepareContext=function(e){if(Cn(this.symbol.opacity)?this._opacityFn||(this._opacityFn=Sc(this.symbol.opacity)):delete this._opacityFn,It(this.symbol.opacity))e.globalAlpha!==this.symbol.opacity&&(e.globalAlpha=this.symbol.opacity);else if(this._opacityFn){var n=this.getMap();e.globalAlpha=this._opacityFn(n.getZoom())}else e.globalAlpha!==1&&(e.globalAlpha=1)},t.prototype.prepareCanvas=function(e,n,i){e.setLineDash&&on(n.lineDasharray)&&e.setLineDash(n.lineDasharray);var o=this.getPainter().isHitTesting();Mt.prepareCanvas(e,n,i,o)},t.prototype.remove=function(){},t.prototype.setZIndex=function(){},t.prototype.show=function(){},t.prototype.hide=function(){},t.prototype._defineStyle=function(e){return this.symbol&&(e.visible=this.symbol.visible,e.opacity=this.symbol.opacity),Pc(e,this.geometry)},t}(TO);function MO(r,t){var e=r&&r.getImage(t);return e||null}function U_(r,t,e,n){var i=$_(e),o=e,s=o.markerType.toLowerCase(),a=W_(s,o.markerWidth,o.markerHeight),l=i.lineOpacity,h=i.polygonOpacity,u=Ao(i.polygonFill);if(u){var c=void 0;Ao(i.polygonFill)&&(c||(c=SO(t,o.markerWidth,o.markerHeight)),i.polygonGradientExtent=c)}Mt.prepareCanvas(r,i,n);var f=o.markerWidth,d=o.markerHeight,p=o.markerLineWidth/2;if(s==="ellipse")Mt.ellipse(r,t,f/2,d/2,d/2,l,h);else if(s==="cross"||s==="x"){for(var g=a.length-1;g>=0;g--)a[g]._add(t);Mt.path(r,a.slice(0,2),l),Mt.path(r,a.slice(2,4),l)}else if(s==="diamond"||s==="bar"||s==="square"||s==="rectangle"||s==="triangle"){s==="bar"?t=t.add(0,-p):s==="rectangle"&&(t=t.add(p,p));for(var g=a.length-1;g>=0;g--)a[g]._add(t);Mt.polygon(r,a,l,h)}else if(s==="pin"){t=t.add(0,-p);for(var g=a.length-1;g>=0;g--)a[g]._add(t);var m=r.lineCap;r.lineCap="round",Mt.bezierCurveAndFill(r,a,l,h),r.lineCap=m}else if(s==="pie"){t=t.add(0,-p);var y=Math.atan(f/2/d)*180/Math.PI,m=r.lineCap;r.lineCap="round",Mt.sector(r,t,d,[90-y,90+y],l,h),r.lineCap=m}else throw new Error("unsupported markerType: "+s);return r.canvas}function SO(r,t,e){var n=new Ce;return n._combine(r),n.xmin+=-t/2,n.ymin+=-e/2,n.xmax+=t/2,n.ymax+=e/2,n}function $_(r){var t={lineColor:r.markerLineColor,linePatternFile:r.markerLinePatternFile,lineWidth:r.markerLineWidth,lineOpacity:r.markerLineOpacity,lineDasharray:r.markerLineDasharray,lineCap:"butt",lineJoin:"round",polygonFill:r.markerFill,polygonPatternFile:r.markerFillPatternFile,polygonOpacity:r.markerFillOpacity};return t.lineWidth===0&&(t.lineOpacity=0),t}function W_(r,t,e){var n=e/2,i=t/2,o=0,s=0,a,l,h,u;if(r==="triangle")return a=new W(o,s-n),l=new W(o-i,s+n),h=new W(o+i,s+n),[a,l,h];if(r==="cross")return a=new W(o-i,s),l=new W(o+i,s),h=new W(o,s-n),u=new W(o,s+n),[a,l,h,u];if(r==="diamond")return a=new W(o-i,s),l=new W(o,s-n),h=new W(o+i,s),u=new W(o,s+n),[a,l,h,u];if(r==="square")return a=new W(o-i,s+n),l=new W(o+i,s+n),h=new W(o+i,s-n),u=new W(o-i,s-n),[a,l,h,u];if(r==="rectangle")return a=new W(o,s),l=a.add(t,0),h=a.add(t,e),u=a.add(0,e),[a,l,h,u];if(r==="x")return a=new W(o-i,s+n),l=new W(o+i,s-n),h=new W(o+i,s+n),u=new W(o-i,s-n),[a,l,h,u];if(r==="bar")return a=new W(o-i,s-e),l=new W(o+i,s-e),h=new W(o+i,s),u=new W(o-i,s),[a,l,h,u];if(r==="pin"||r==="pie"){var c=e*Math.atan(i/n);return a=new W(o,s),l=new W(o-c,s-e),h=new W(o+c,s-e),u=new W(o,s),[a,l,h,u]}return[]}var CO=new W(0,0),PO=new W(0,0),EO=new W(0,0),OO=new W(0,0),Da=function(r){Et(t,r);function t(e,n,i){var o=r.call(this)||this;return o.symbol=e,o.geometry=n,o.painter=i,o}return t.prototype.get2DExtent=function(){for(var e=this.getMap(),n=e.getGLRes(),i=new Ce,o=this._getRenderPoints()[0],s=o.length-1;s>=0;s--)o[s]&&i._combine(e._pointAtResToPoint(o[s],n));return i},t.prototype.isDynamicSize=function(){var e=this.symbol;return Cn(e.markerWidth)||Cn(e.markerHeight)||Cn(e.textSize)},t.prototype._rotateExtent=function(e,n){return e.convertTo(function(i){return i._rotate(n)})},t.prototype._getRenderPoints=function(){var e=this.getPainter(),n=e.isSpriting()?"center":this.getPlacement();return this.getPainter().getRenderPoints(n)},t.prototype._getRenderContainerPoints=function(e){var n=this.getPainter();if(n.isSpriting())return this._getRenderPoints()[0];var i=this.geometry,o=this.getDxDy(),s;if(i._cPoint&&!e){var a=e?EO:OO;a.set(i._cPoint.x,i._cPoint.y);var l=n.containerOffset;a._sub(l);var h=o.x,u=o.y;(h||u)&&a._add(h||0,u||0),s=[a]}else{var c=this._getRenderPoints()[0];s=this.painter._pointContainerPoints(c,o.x,o.y,e,!0,this.getPlacement())}if(!s||!Array.isArray(s[0]))return s;for(var f=[],d=0,p=s.length;d<p;d++)for(var g=0,m=s[d].length;g<m;g++)f.push(s[d][g]);return f},t.prototype.getPlacement=function(){return this.symbol.markerPlacement},t.prototype.getRotation=function(){return Gc(this.style)},t.prototype.getDxDy=function(){var e=this.style,n=e.markerDx,i=e.markerDy;return new W(n,i)},t.prototype._getRotationAt=function(e){var n=this.getRotation();n||(n=0);var i=this._getRenderPoints()[1];if(!i||!i[e])return n;var o=this.getMap(),s=i[e][0],a=i[e][1];if(o.isTransforming()){var l=o.getGLRes();return s=o._pointAtResToContainerPoint(i[e][0],l,0,CO),a=o._pointAtResToContainerPoint(i[e][1],l,0,PO),n+pc(s.x,s.y,a.x,a.y)}else return n+-pc(s.x,s.y,a.x,a.y)},t.prototype._rotate=function(e,n,i){if(i){var o=this.getDxDy(),s=n.sub(o);return e.save(),e.translate(s.x,s.y),e.rotate(i),o}return null},t}(G_),kO=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.getPlacement=function(){return"point"},t.prototype.getDxDy=function(){return new W(0,0)},t.prototype.symbolize=function(e){var n=this.geometry,i=n.getLayer();if(!(!n.options.debug&&i&&!i.options.debug)){var o=this.getMap();if(!(!o||o.isZooming())){var s=i.options.debugOutline,a=1;e.strokeStyle=s,e.fillStyle=s,e.lineWidth=1,e.font="18px  serif";var l=n.getContainerExtent().toArray();Mt.polygon(e,[l],a,0);for(var h=this._getRenderContainerPoints(),u=this.geometry.getId(),c=W_("cross",10,10),f=0;f<h.length;f++){var d=h[f];U(u)||Mt.fillText(e,u,d.add(8,-4),s);for(var p=[],g=0;g<c.length;g++)p.push(c[g].add(d));Mt.path(e,p.slice(0,2),a),Mt.path(e,p.slice(2,4),a)}}}},t}(Da),sm=new kn(1,1),IO=new Ce,am=function(r){Et(t,r);function t(e,n,i){var o=r.call(this,e,n,i)||this;return o.style=o._defineStyle(o.translate()),o}return t.test=function(e){return tm(e)},t.prototype.symbolize=function(e,n){if(this.isVisible()){var i=this.style;if(!(!this.painter.isHitTesting()&&(i.markerWidth===0||i.markerHeight===0||i.markerOpacity===0))){var o=this._getRenderContainerPoints();if(on(o)){var s=this._getImage(n);if(!s){typeof console<"u"&&console.warn("no img found for "+(this.style.markerFile||this._url[0]));return}this._prepareContext(e);var a=i.markerWidth,l=i.markerHeight;if(!It(a)||!It(l)){a=s.width,l=s.height,i.markerWidth=a,i.markerHeight=l;var h=i.markerFile;n.isResourceLoaded(h)||n.addResource(h,s);var u=this.getPainter();u.isSpriting()||u.removeCache()}var c;this.symbol.markerType!=="path"&&It(i.markerOpacity)&&i.markerOpacity<1&&(c=e.globalAlpha,e.globalAlpha*=i.markerOpacity),sm.width=a,sm.height=l;for(var f=wo(sm,i.markerHorizontalAlignment,i.markerVerticalAlignment),d=0,p=o.length;d<p;d++){var g=o[d],m=this.getRotation()?this._rotate(e,g,this._getRotationAt(d)):null,y=void 0;if(m){var x=g.sub(m);g=m;var v=this._getRotationAt(d);y=Dh(IO,v,a,l,g,f),y._add(x)}var _=g.x+f.x,w=g.y+f.y;Mt.image(e,s,_,w,a,l),m&&e.restore(),m?this._setBBOX(e,y.xmin,y.ymin,y.xmax,y.ymax):this._setBBOX(e,_,w,_+a,w+l)}c!==void 0&&(e.globalAlpha=c)}}}},t.prototype._getImage=function(e){return MO(e,this.style.markerFile)},t.prototype.getFixedExtent=function(e){return this._fixedExtent=this._fixedExtent||new Ce,Kg(this._fixedExtent,this.style,e)},t.prototype.translate=function(){var e=this.symbol;return{markerFile:e.markerFile,markerOpacity:se(e.markerOpacity,1),markerWidth:se(e.markerWidth,null),markerHeight:se(e.markerHeight,null),markerRotation:se(e.markerRotation,0),markerDx:se(e.markerDx,0),markerDy:se(e.markerDy,0),markerHorizontalAlignment:se(e.markerHorizontalAlignment,"middle"),markerVerticalAlignment:se(e.markerVerticalAlignment,"top")}},t}(Da),RO=new at(0,0),DO=new at(0,0),Z_=function(r){Et(t,r);function t(e,n,i){var o=r.call(this)||this;return o.symbol=e,o.geometry=n,o.painter=i,n.isPoint||(o.style=o._defineStyle(o.translate())),o}return t.test=function(e,n){if(!e||n&&n.isPoint)return!1;for(var i in e){var o=i.slice(0,4);if(o==="line"||o==="poly")return!0}return!1},t.prototype.symbolize=function(e,n){var i,o;if(this.isVisible()){var s=this.style;if(!(s.polygonOpacity===0&&s.lineOpacity===0&&!this.painter.isHitTesting())){var a=this._getPaintParams();if(a){this._prepareContext(e);var l=Ao(s.lineColor),h=this.geometry.getJSONType()==="Polygon"||this.geometry.type==="LineString";l&&(s.lineColor.places||!h)&&(s.lineGradientExtent=this.geometry.getContainerExtent()._expand(s.lineWidth)),Ao(s.polygonFill)&&(s.polygonGradientExtent=this.geometry.getContainerExtent());var u=this.geometry.getLayer().options.geometryEventTolerance||0,c=this.geometry._hitTestTolerance()+u,f=a[0],d=this.geometry.getJSONType()==="Polygon"&&f.length>0&&Array.isArray(f[0][0])||this.geometry.type==="LineString"&&f.length>0&&Array.isArray(f[0]);if(d)for(var p=0;p<f.length;p++){this.prepareCanvas(e,s,n),l&&h&&!s.lineColor.places&&this._createGradient(e,f[p],s.lineColor);var g=[e,f[p]];a.length>1&&g.push.apply(g,Ee([],te(a.slice(1)),!1)),g.push(s.lineOpacity,s.polygonOpacity,s.lineDasharray);var m=(i=this.geometry)._paintOn.apply(i,Ee([],te(g),!1));this._setBBOX(e,m),this._bufferBBOX(e,c)}else{this.prepareCanvas(e,s,n),l&&h&&!s.lineColor.places&&this._createGradient(e,f,s.lineColor);var g=[e];g.push.apply(g,Ee([],te(a),!1)),g.push(s.lineOpacity,s.polygonOpacity,s.lineDasharray);var m=(o=this.geometry)._paintOn.apply(o,Ee([],te(g),!1));this._setBBOX(e,m),this._bufferBBOX(e,c)}e.setLineDash&&Array.isArray(s.lineDasharray)&&e.setLineDash([])}}}},t.prototype.get2DExtent=function(){var e=this.getMap(),n=this.geometry._getPrjExtent();if(!n)return null;(!this._extMin||!this._extMax)&&(this._extMin=new at(0,0),this._extMax=new at(0,0)),this._extMin.x=n.xmin,this._extMin.y=n.ymin,this._extMax.x=n.xmax,this._extMax.y=n.ymax;var i=e._prjToPoint(this._extMin,void 0,RO),o=e._prjToPoint(this._extMax,void 0,DO);return this._pxExtent?this._pxExtent.set(Math.min(i.x,o.x),Math.min(i.y,o.y),Math.max(i.x,o.x),Math.max(i.y,o.y)):this._pxExtent=new Ce(i,o),this._pxExtent},t.prototype.getFixedExtent=function(){var e=this.style.lineWidth/2;return new Ce(-e,-e,e,e)},t.prototype._getPaintParams=function(){return this.getPainter().getPaintParams(this.style.lineDx,this.style.lineDy)},t.prototype.translate=function(){var e=this.symbol,n={lineColor:se(e.lineColor,"#000"),lineWidth:se(e.lineWidth,2),lineOpacity:se(e.lineOpacity,1),lineDasharray:se(e.lineDasharray,[]),lineCap:se(e.lineCap,"butt"),lineJoin:se(e.lineJoin,"miter"),linePatternFile:se(e.linePatternFile,null),lineDx:se(e.lineDx,0),lineDy:se(e.lineDy,0),polygonFill:se(e.polygonFill,null),polygonOpacity:se(e.polygonOpacity,1),polygonPatternFile:se(e.polygonPatternFile,null),polygonPatternDx:se(e.polygonPatternDx,0),polygonPatternDy:se(e.polygonPatternDy,0),linePatternDx:se(e.linePatternDx,0),linePatternDy:se(e.linePatternDy,0)};return n.lineWidth===0&&(n.lineOpacity=0),this.geometry.type==="LineString"&&!n.polygonFill&&(n.polygonFill=n.lineColor),n},t.prototype._createGradient=function(e,n,i){if(!(!Array.isArray(n)||!n.length)){var o=te(FO(n),2),s=o[0],a=o[1];if(!s||!a){console.error("unable create canvas LinearGradient,error data:",n);return}var l=e.createLinearGradient(s.x,s.y,a.x,a.y);i.colorStops.forEach(function(h){l.addColorStop.apply(l,Ee([],te(h),!1))}),e.strokeStyle=l}},t}(G_);function FO(r){var t,e=!0;Array.isArray(r[0])?(t=r[0],e=!1):t=r;var n=t.length;if(e)return[t[0],t[n-1]];for(var i=t[0],o=0,s,a=1;a<n;a++){var l=t[a],h=i.distanceTo(l);h>o&&(o=h,s=l)}return[i,s]}var LO=new Ce,zO=function(r){Et(t,r);function t(e,n,i){var o=r.call(this,e,n,i)||this,s=o.translate();return o._dynamic=yx(s),o.style=o._defineStyle(s),o.style.textWrapWidth===0||(o.strokeAndFill=o._defineStyle(o.translateLineAndFill(o.style))),o}return t.test=function(e){return $c(e)},t.prototype.symbolize=function(e,n){if(this.isVisible()&&!(!this.painter.isHitTesting()&&(this.style.textSize===0||!this.style.textOpacity&&(!this.style.textHaloRadius||!this.style.textHaloOpacity)||this.style.textWrapWidth===0))){var i=this._getRenderContainerPoints();if(on(i)){var o=this.style,s=this.strokeAndFill,a=vc(this.style.textName,this.geometry.getProperties());this._dynamic&&delete this._textDesc;var l=this._textDesc=this._textDesc||xc(a,this.style);this._prepareContext(e),this.prepareCanvas(e,s,n),Mt.prepareCanvasFont(e,o);for(var h=o.textHaloRadius||0,u=0,c=i.length;u<c;u++){var f=i[u],d=this.getRotation()?this._rotate(e,f,this._getRotationAt(u)):null,p=void 0;if(d){var g=f.sub(d);f=d;var m=this._getRotationAt(u),y=l.size||{width:0,height:0},x=y.width,v=y.height,_=wo(l.size,o.textHorizontalAlignment,o.textVerticalAlignment);p=Dh(LO,m,x,v,f,_),p._add(g)}var w=Mt.text(e,a,f,o,l);d?(this._setBBOX(e,p.xmin,p.ymin,p.xmax,p.ymax),e.restore()):this._setBBOX(e,w),this._bufferBBOX(e,h)}}}},t.prototype.getPlacement=function(){return this.symbol.textPlacement},t.prototype.getRotation=function(){var e=this.style.textRotation;return It(e)?-e*Math.PI/180:null},t.prototype.getDxDy=function(){var e=this.style;return new W(e.textDx,e.textDy)},t.prototype.getFixedExtent=function(){var e=this.geometry.getTextDesc();return Array.isArray(e)&&(e=e[this._index]),this._fixedExtent=this._fixedExtent||new Ce,e?N_(this._fixedExtent,this.style,e):this._fixedExtent},t.prototype.translate=function(){var e=this.symbol,n={textName:e.textName,textFaceName:se(e.textFaceName,"monospace"),textWeight:se(e.textWeight,"normal"),textStyle:se(e.textStyle,"normal"),textSize:se(e.textSize,Y1),textFont:se(e.textFont,null),textFill:se(e.textFill,"#000"),textOpacity:se(e.textOpacity,1),textHaloFill:se(e.textHaloFill,"#ffffff"),textHaloRadius:se(e.textHaloRadius,0),textHaloOpacity:se(e.textHaloOpacity,1),textWrapWidth:se(e.textWrapWidth,null),textWrapCharacter:se(e.textWrapCharacter,`
`),textLineSpacing:se(e.textLineSpacing,0),textDx:se(e.textDx,0),textDy:se(e.textDy,0),textHorizontalAlignment:se(e.textHorizontalAlignment,"middle"),textVerticalAlignment:se(e.textVerticalAlignment,"middle"),textAlign:se(e.textAlign,"center"),textRotation:se(e.textRotation,0),textMaxWidth:se(e.textMaxWidth,0),textMaxHeight:se(e.textMaxHeight,0)};return n.textMaxWidth>0&&(!n.textWrapWidth||n.textWrapWidth>n.textMaxWidth)&&(n.textWrapWidth||(n.textMaxHeight=1),n.textWrapWidth=n.textMaxWidth),n},t.prototype.translateLineAndFill=function(e){return{lineColor:e.textHaloRadius?e.textHaloFill:e.textFill,lineWidth:e.textHaloRadius,lineOpacity:e.textOpacity,lineDasharray:null,lineCap:"butt",lineJoin:"round",polygonFill:e.textFill,polygonOpacity:e.textOpacity}},t}(Da),X_=[0,0],Y_=new Ce,HO=new W(0,0),q_=function(r){Et(t,r);function t(e,n,i){var o=r.call(this,e,n,i)||this,s=o.translate();return o._dynamic=yx(s),o.style=o._defineStyle(s),o.strokeAndFill=o._defineStyle($_(o.style)),o.padding=0,o}return t.test=function(e){return Wc(e)},t.prototype.symbolize=function(e,n){if(this.isVisible()){var i=this.style;if(!(!this.painter.isHitTesting()&&(i.markerWidth===0||i.markerHeight===0||i.polygonOpacity===0&&i.lineOpacity===0))){var o=this._getRenderContainerPoints();on(o)&&(this._prepareContext(e),this.getPainter().isSpriting()||this.geometry.getLayer().getMask()===this.geometry||this._dynamic||this.geometry.getLayer().options.cacheVectorOnCanvas===!1?this._drawMarkers(e,o,n):this._drawMarkersWithCache(e,o,n))}}},t.prototype._drawMarkers=function(e,n,i){for(var o=n.length-1;o>=0;o--){var s=n[o],a=Jg(X_,this.style),l=te(a,2),h=l[0],u=l[1],c=void 0,f=this.getRotation()?this._rotate(e,s,this._getRotationAt(o)):null;if(f){var d=s.sub(f);s=f;var p=this._getRotationAt(o);c=Dh(Y_,p,h,u,s,HO),c._add(d)}if(this._drawVectorMarker(e,s,i),f)e.restore(),this._setBBOX(e,c.xmin,c.ymin,c.xmax,c.ymax);else{var g=s.x,m=s.y;this._setBBOX(e,g,m,g+h,m+u)}}},t.prototype._drawMarkersWithCache=function(e,n,i){var o=this._stampSymbol(),s=i.getImage(o);s||(s=this._createMarkerImage(e,i),i.addResource([o,s.width,s.height],s));for(var a=z_(this.style,s.width,s.height),l=n.length-1;l>=0;l--){var h=n[l],u=this.getRotation()?this._rotate(e,h,this._getRotationAt(l)):null,c=void 0;if(u){var f=h.sub(u);h=u;var d=this._getRotationAt(l);c=Dh(Y_,d,s.width,s.height,h,a),c._add(f)}var p=h.x+a.x,g=h.y+a.y;Mt.image(e,s,p,g),u?(e.restore(),this._setBBOX(e,c.xmin,c.ymin,c.xmax,c.ymax)):this._setBBOX(e,p,g,p+s.width,g+s.height)}},t.prototype._createMarkerImage=function(e,n){var i=e.canvas.constructor,o=Jg(X_,this.style),s=Mt.createCanvas(o[0],o[1],i),a=this._getCacheImageAnchor(o[0],o[1]),l=s.getContext("2d");return this._drawVectorMarker(l,a,n),s},t.prototype._stampSymbol=function(){return this._stamp||(this._stamp=Kp([this.style.markerType,Ao(this.style.markerFill)?ag(this.style.markerFill):this.style.markerFill,this.style.markerFillOpacity,this.style.markerFillPatternFile,Ao(this.style.markerLineColor)?ag(this.style.markerLineColor):this.style.markerLineColor,this.style.markerLineWidth,this.style.markerLineOpacity,this.style.markerLineDasharray?this.style.markerLineDasharray.join(","):"",this.style.markerLinePatternFile,this.style.markerWidth,this.style.markerHeight,this.style.markerHorizontalAlignment,this.style.markerVerticalAlignment].join("_"))),this._stamp},t.prototype._getCacheImageAnchor=function(e,n){var i=2*(this.symbol.shadowBlur||0),o=i+this.padding,s=this.style.markerType;return s==="bar"||s==="pie"||s==="pin"?new W(e/2,n-o):s==="rectangle"?new W(o,o):new W(e/2,n/2)},t.prototype._getGraidentExtent=function(e){var n=new Ce,i=this.getDxDy(),o=this.getFixedExtent();if(Array.isArray(e))for(var s=e.length-1;s>=0;s--)n._combine(e[s]);else n._combine(e);return n.xmin+=o.xmin-i.x,n.ymin+=o.ymin-i.y,n.xmax+=o.xmax-i.x,n.ymax+=o.ymax-i.y,n},t.prototype._drawVectorMarker=function(e,n,i){U_(e,n,this.style,i)},t.prototype.getFixedExtent=function(){var e=this.isDynamicSize(),n=this.style.markerWidth,i=this.style.markerHeight;return this._fixedExtent=this._fixedExtent||new Ce,D_(this._fixedExtent,this.style,e?[128,128*(n===0?1:i/n)]:null)},t.prototype.translate=function(){var e=this.symbol,n={markerType:se(e.markerType,"ellipse"),markerFill:se(e.markerFill,"#00f"),markerFillOpacity:se(e.markerFillOpacity,1),markerFillPatternFile:se(e.markerFillPatternFile,null),markerLineColor:se(e.markerLineColor,"#000"),markerLineWidth:se(e.markerLineWidth,ka.markerLineWidth),markerLineOpacity:se(e.markerLineOpacity,1),markerLineDasharray:se(e.markerLineDasharray,[]),markerLinePatternFile:se(e.markerLinePatternFile,null),markerDx:se(e.markerDx,0),markerDy:se(e.markerDy,0),markerWidth:se(e.markerWidth,ka.markerWidth),markerHeight:se(e.markerHeight,ka.markerHeight),markerRotation:se(e.markerRotation,0),shadowBlur:se(e.shadowBlur,0),shadowOffsetX:se(e.shadowOffsetX,0),shadowOffsetY:se(e.shadowOffsetY,0)},i=n.markerType,o=F_(i),s=L_(i);return n.markerHorizontalAlignment=se(e.markerHorizontalAlignment,o),n.markerVerticalAlignment=se(e.markerVerticalAlignment,s),It(e.markerOpacity)&&(It(e.markerFillOpacity)&&(n.markerFillOpacity*=e.markerOpacity),It(e.markerLineOpacity)&&(n.markerLineOpacity*=e.markerOpacity)),n},t}(Da),J_=function(r){Et(t,r);function t(e,n,i){var o=this;U(e.markerWidth)&&(e.markerWidth=80),U(e.markerHeight)&&(e.markerHeight=80),o=r.call(this,e,n,i)||this,e=Gt({},e,o.translate());var s=o.style=o._defineStyle(e);return be.gecko?o._url=[mh(s,s.markerWidth,s.markerHeight),s.markerWidth,s.markerHeight]:o._url=[mh(s),s.markerWidth,s.markerHeight],o}return t.test=function(e){return em(e)},t.prototype._prepareContext=function(){},t.prototype._getImage=function(e){var n=this;if(e&&e.isResourceLoaded(this._url))return e.getImage(this._url);var i=this.painter,o=new Image;return o.onload=function(){var s=i.getLayer()&&i.getLayer().getRenderer();s&&s.setToRedraw()},o.onerror=function(s){s&&typeof console<"u"&&console.warn(s),e.markErrorResource(n._url)},o.src=this._url[0],e&&e.addResource(this._url,o),o},t}(am),K_={lineWidth:1,polygonFill:"#fff",polygonOpacity:.5},NO=function(r){Et(t,r);function t(e,n,i){var o=r.call(this,e,n,i)||this;return o.style=n.getLayer().options.drawAltitude,(!o.style||!kr(o.style))&&(o.style={lineWidth:2}),o.style.lineWidth||(o.style.lineWidth=0),o.dxdy=o._defineStyle({dx:e.textDx||e.markerDx,dy:e.textDy||e.markerDy}),o}return t.test=function(e,n){var i=n.getLayer();if(!i)return!1;var o=n.getJSONType();return o==="Marker"||o==="LineString"},t.prototype.symbolize=function(e){var n=this.geometry.getLayer();if(n.options.drawAltitude&&this.geometry.hasAltitude()){var i=this._getStyle();if(this._prepareContext(e),this.geometry.type==="LineString"){var o=this._getPaintParams(i.lineDx,i.lineDy);if(!o)return;var s=this.getPainter().getPaintParams(i.lineDx,i.lineDy,!0,!0,"_groundpt")[0];this._drawLineAltitude(e,o[0],s)}else{var a=this._getRenderContainerPoints(),l=this._getRenderContainerPoints(!0);if(!a||a.length===0)return;this._drawMarkerAltitude(e,a[0],l[0])}}},t.prototype.getDxDy=function(){var e=this.dxdy;return new W(e.dx||0,e.dy||0)},t.prototype.get2DExtent=function(){return this.geometry.type==="LineString"?Z_.prototype.get2DExtent.apply(this):r.prototype.get2DExtent.call(this)},t.prototype.getPlacement=function(){return"point"},t.prototype._getPaintParams=function(e,n){return this.getPainter().getPaintParams(e||0,n||0,null,!0,"_altpt")},t.prototype._drawMarkerAltitude=function(e,n,i){var o=this._getStyle();this.prepareCanvas(e,o),Mt.path(e,[n,i],o.lineOpacity,null,o.lineDasharray)},t.prototype._drawLineAltitude=function(e,n,i){var o=this._getStyle(),s=n.length>0&&Array.isArray(n[0]);if(s)for(var a=0;a<n.length;a++)this._drawLine(e,n[a],i[a]);else this._drawLine(e,n,i);e.setLineDash&&Array.isArray(o.lineDasharray)&&e.setLineDash([])},t.prototype._drawLine=function(e,n,i){var o=this._getStyle();this.prepareCanvas(e,o);for(var s=0,a=n.length-1;s<a;s++)Mt.polygon(e,[n[s],n[s+1],i[s+1],i[s]],o.lineOpacity,o.polygonOpacity,o.lineDasharray)},t.prototype._getStyle=function(){var e=this.geometry.getLayer(),n=e.options.drawAltitude;if(Array.isArray(n)){var i=e.getGeometries()||[],o=i.indexOf(this.geometry);o>=0&&(n=n[o]||K_)}return kr(n)||(n=K_),n.lineWidth||(n.lineWidth=0,n.lineOpacity=0),n},t}(Da),BO=[NO,Z_,am,J_,q_,zO],zs,Q_=new W(0,0),jO=new Ce,Yc=new Ce,wi=new Ce,VO=new Ce,Ko=new Ce,GO={code:void 0},Fh={minx:1/0,miny:1/0,maxx:-1/0,maxy:-1/0},lm=function(r){Et(t,r);function t(e){var n=r.call(this)||this;return n.geometry=e,n.symbolizers=n._createSymbolizers(),n._altAtGL=n._getGeometryAltitude(),n.bbox=qo(),n._drawTime=0,n}return t.prototype._setDrawTime=function(e){return this._drawTime=e,this},t.prototype.getRenderBBOX=function(){var e=this.getLayer();if(e&&e._drawTime!==this._drawTime)return null;xh(this.bbox);for(var n=this.symbolizers.length-1;n>=0;n--){var i=this.symbolizers[n],o=i.bbox;Fc(o)&&Dc(this.bbox,o)}return Fc(this.bbox)?this.bbox:null},t.prototype.getMap=function(){return this.geometry.getMap()},t.prototype.getLayer=function(){return this.geometry&&this.geometry.getLayer()},t.prototype._createSymbolizers=function(){var e=this.getSymbol(),n=[],i=BO,o=e;Array.isArray(e)||(o=[e]);for(var s=o.length-1;s>=0;s--)for(var a=o[s],l=i.length-1;l>=0;l--)if(i[l].test(a,this.geometry)){var h=new i[l](a,this.geometry,this);h._index=s,n.push(h),h instanceof Da&&(this._hasPoint=!0)}if(!n.length&&console){var u=this.geometry.getId();console.warn("invalid symbol for geometry("+(this.geometry?this.geometry.getType()+(u?":"+u:""):"")+") to draw : "+JSON.stringify(e))}return this._debugSymbolizer=new kO(e,this.geometry,this),n},t.prototype.hasPoint=function(){return!!this._hasPoint},t.prototype.getRenderPoints=function(e){return this._verifyProjection(),this._renderPoints||(this._renderPoints={}),e||(e="center"),this._renderPoints[e]||(this._renderPoints[e]=this.geometry._getRenderPoints(e)),this._renderPoints[e]},t.prototype.getPaintParams=function(e,n,i,o,s){s===void 0&&(s="_pt");var a=this.getLayer()._getRenderer(),l=a.mapStateCache,h,u,c,f,d,p=this.getMap();l&&!this._hitPoint?(h=l.resolution,u=l.pitch,c=l.bearing,f=l.glScale,d=l.containerExtent):(h=p.getResolution(),u=p.getPitch(),c=p.getBearing(),f=p.getGLScale(),d=p.getContainerExtent());var g=this.geometry,m=h,y=u!==0,x=c!==0,v=this._cachedParams,_=g._paintAsPath&&g._paintAsPath();if(_&&this._unsimpledParams&&m<=this._unsimpledParams._res)v=this._unsimpledParams;else if(!v||v._res!==h||this._pitched!==y&&g._redrawWhenPitch()||this._rotated!==x&&g._redrawWhenRotate()){if(v=g._getPaintParams(),!v)return null;v._res=m,!g._simplified&&_&&(this._unsimpledParams||(this._unsimpledParams=v),m>this._unsimpledParams._res&&(this._unsimpledParams._res=m)),this._cachedParams=v}if(!v)return null;this._pitched=y,this._rotated=x;var w=f,b=[],A=v[0],T=d,S=this._pointContainerPoints(A,e,n,i,o||this._hitPoint&&!T.contains(this._hitPoint),null,s);if(!S)return null;b.push(S);for(var M=1,E=v.length;M<E;M++)It(v[M])||v[M]instanceof kn?It(v[M])?b.push(v[M]/w):b.push(v[M].multi(1/w)):b.push(v[M]);return b},t.prototype._pointContainerPoints=function(e,n,i,o,s,a,l){if(l===void 0&&(l="_pt"),this._aboveCamera())return null;var h=this.getLayer()._getRenderer(),u=h.mapStateCache,c=this.getMap(),f=this.geometry,d=this.containerOffset,p,g;u?(p=u.glRes,g=u.containerExtent):(p=c.getGLRes(),g=c.getContainerExtent());var m,y=this.getLayer().options.roundPoint,x=1/0,v=1/0,_=-1/0,w=-1/0,b=!s,A=h.layer.options.clipBBoxBufferSize||3,T=this.symbolizers,S=f.options.enableClip;function M(Ht,ee){Ht===void 0&&(Ht=[]),ee===void 0&&(ee=[]);var nt=ch(Ht,l);nt=c._pointsAtResToContainerPoints(Ht,p,ee,nt);for(var Dt=0,Vt=nt.length;Dt<Vt;Dt++){var Ct=nt[Dt];Ct._sub(d),(n||i)&&Ct._add(n||0,i||0),y&&(Ct.x=Math.ceil(Ct.x),Ct.y=Math.ceil(Ct.y)),x=Math.min(Ct.x,x),v=Math.min(Ct.y,v),_=Math.max(Ct.x,_),w=Math.max(Ct.y,w)}if(S&&b&&kx(T)){if(Ko.ymin=g.ymin,Ko.ymin<A&&(Ko.ymin=g.ymin-A),Ko.xmin=g.xmin-A,Ko.xmax=g.xmax+A,Ko.ymax=g.ymax+A,f.getShell&&f.getHoles)return Xc(nt,Ko);var _e=Zc(nt,Ko,!1);if(_e.length){var Ie=[];return _e.forEach(function(Jt){for(var Ne=0,ce=Jt.length;Ne<ce;Ne++)Ie.push(Jt[Ne].point)}),Ie}}return nt}var E=this.getAltitude();if(Array.isArray(e)){var P=this.geometry,k=void 0;!s&&P.options.enableClip?(k=this._clip(e,E),k.inView&&(b=!1)):k={points:e,altitude:E};var O=k.points;E=k.altitude,o&&(E=0);var I=E;m=[];for(var D=[],z=It(E),L=0,$=O.length;L<$;L++){var Z=O[L];if(Array.isArray(Z)){if(z){var j=M(Z,E);m.push(j);continue}for(var st=[],lt=0,rt=Z.length;lt<rt;lt++)Array.isArray(E)&&(E[L]?I=E[L][lt]:I=0),st.push(I);var Rt=M(Z,st);m.push(Rt)}else Array.isArray(E)&&(a==="vertex-last"?I=E[E.length-1-L]:a==="line"?I=(E[L]+E[L+1])/2:I=E[L]),D.push(I)}D.length&&(m=M(O,D))}else e instanceof W&&(o&&(E=0),m=c._pointAtResToContainerPoint(e,p,E)._sub(d),(n||i)&&m._add(n,i));return Fh.minx=x,Fh.miny=v,Fh.maxx=_,Fh.maxy=w,this._containerBbox=Fh,m},t.prototype._clip=function(e,n){if(It(n)&&n!==0)return{points:e,altitude:n};if(Array.isArray(n)){for(var i=!1,o=0,s=n.length;o<s;o++)if(n[o]!==0){i=!0;break}if(i)return{points:e,altitude:n}}var a=this.getMap(),l=this.geometry,h=this.getSymbol().lineWidth;It(h)||(h=4);var u=this.getLayer()._getRenderer(),c=u.mapStateCache,f,d,p;c?(f=c._2DExtent,d=c.glExtent,p=c.pitch):(f=a.get2DExtent(),d=a.get2DExtentAtRes(a.getGLRes()),p=a.getPitch());var g=f._expand(h);if(p>0&&n){var m=a.cameraLookAt,y=a.cameraPosition;Q_.set(y[0],y[1]),g=g._combine(Q_._add(Br(m[0]-y[0]),Br(m[1]-y[1])))}var x=this.get2DExtent(null,VO),v=e;if(x.within(g))return{points:v,altitude:n,inView:!0};var _=d._expand(h*a.getGLScale());wi.xmin=_.xmin,wi.xmax=_.xmax,wi.ymin=_.ymin,wi.ymax=_.ymax;var w=l.options.smoothness;if(l.getShell&&this.geometry.getHoles&&!w){var b=_.xmin,A=_.ymin,T=_.xmax,S=_.ymax,M=Math.abs(T-b),E=Math.abs(S-A),P=Math.sqrt(M*M+E*E),k=(P-M)/2,O=(P-E)/2;if(wi.xmin=_.xmin-k,wi.xmax=_.xmax+k,wi.ymin=_.ymin-O,wi.ymax=_.ymax+O,!Array.isArray(e[0]))v=Xc(e,wi);else{v=[];for(var o=0;o<e.length;o++){var I=Xc(e[o],wi);I.length&&v.push(I)}}}else if(l.getJSONType()==="LineString"&&!w){if(!Array.isArray(e[0]))v=Zc(e,wi,!1,!!w);else{v=[];for(var o=0;o<e.length;o++)ai(v,Zc(e[o],wi,!1,!!w))}return this._interpolateSegAlt(v,e,n)}return{points:v,altitude:n}},t.prototype._interpolateSegAlt=function(e,n,i){if(!Array.isArray(i)){var o=function(l){return l.point};return{points:e.map(function(l){return Array.isArray(l)?l.map(o):l.point}),altitude:i}}var s=t2(e,n,i);i=[];var a=s.map(function(l){if(Array.isArray(l)){var h=[],u=l.map(function(c){return h.push(c.altitude),c.point});return i.push(h),u}return i.push(l.altitude),l.point});return{points:a,altitude:i}},t.prototype.getSymbol=function(){return this.geometry._getInternalSymbol()},t.prototype._resetSymbolizersBBOX=function(){for(var e=this.symbolizers.length-1;e>=0;e--){var n=this.symbolizers[e],i=n.bbox;xh(i)}return this},t.prototype.paint=function(e,n,i){var o;if(this.symbolizers){var s=this.getLayer(),a=s._getRenderer();if(!(!a||!a.context&&!n)){var l=a.mapStateCache||{offset:void 0};if(!(!this.geometry._isCheck&&e&&!e.intersects(this.get2DExtent(a.resources,jO)))){var h=this.getMap();if(!this._aboveCamera()){this.containerOffset=i||l.offset||h._pointToContainerPoint(a.middleWest)._add(0,-h.height/2),this._beforePaint();var u=n||a.context;u.isHitTesting||this._resetSymbolizersBBOX();for(var c=[u,a.resources],f=this.symbolizers.length-1;f>=0;f--)(u.shadowBlur||this.symbolizers[f].symbol.shadowBlur)&&this._prepareShadow(u,this.symbolizers[f].symbol),(o=this.symbolizers[f]).symbolize.apply(o,Ee([],te(c),!1));this._afterPaint(),this._painted=!0,(this.geometry.options.debug||s.options.debug)&&this._debugSymbolizer.symbolize(u)}}}}},t.prototype.getSprite=function(e,n){var i;if(!this.geometry.isPoint)return null;if(this._spriting=!0,!this._sprite&&this.symbolizers.length>0){var o=new Ce;this.symbolizers.forEach(function(p){var g=p.getFixedExtent(e);o._combine(g)});var s=o.getMin().multi(-1),a=n||(this.getMap()?this.getMap().CanvasClass:null),l=Mt.createCanvas(o.getWidth(),o.getHeight(),a),h=void 0;this._renderPoints&&(h=this._renderPoints);for(var u=l.getContext("2d"),c=[u,e],f=this.symbolizers.length-1;f>=0;f--){var d=this.symbolizers[f].getDxDy();this._renderPoints={center:[[s.add(d)]]},this._prepareShadow(u,this.symbolizers[f].symbol),(i=this.symbolizers[f]).symbolize.apply(i,Ee([],te(c),!1))}h&&(this._renderPoints=h),this._sprite={canvas:l,offset:o.getCenter()}}return this._spriting=!1,this._sprite},t.prototype.isSpriting=function(){return!!this._spriting},t.prototype.hitTest=function(e,n){if((!n||n<.5)&&(n=.5),this._hitPoint=e.sub(n,n),!zs){var i=this.getMap()?this.getMap().CanvasClass:null;zs=Mt.createCanvas(1,1,i)}Mt.setHitTesting(!0),zs.width=zs.height=2*n;var o=Mt.getCanvas2DContext(zs);o.isHitTesting=!0;try{this.paint(null,o,this._hitPoint)}finally{Mt.setHitTesting(!1)}delete this._hitPoint;for(var s=o.getImageData(0,0,zs.width,zs.height).data,a=3,l=s.length;a<l;a+=4)if(s[a]>0)return!0;return!1},t.prototype.isHitTesting=function(){return!!this._hitPoint},t.prototype._prepareShadow=function(e,n){n.shadowBlur?(e.shadowBlur=this.isHitTesting()?0:n.shadowBlur,e.shadowColor=n.shadowColor||"#000",e.shadowOffsetX=n.shadowOffsetX||0,e.shadowOffsetY=n.shadowOffsetY||0):e.shadowBlur&&(e.shadowBlur=null,e.shadowColor=null,e.shadowOffsetX=null,e.shadowOffsetY=null)},t.prototype._eachSymbolizer=function(e,n){if(this.symbolizers){n||(n=this);for(var i=this.symbolizers.length-1;i>=0;i--)e.apply(n,[this.symbolizers[i]])}},t.prototype.get2DExtent=function(e,n){this._verifyProjection();var i=this.getMap();e=e||this.getLayer()._getRenderer().resources;var o=i.getZoom(),s=this._isDynamicSize();if((!this._extent2D||this._extent2D._zoom!==o||!this._fixedExtent)&&(this._extent2D&&this._extent2D._zoom!==o&&delete this._extent2D,this.symbolizers&&(this._extent2D||(this._extent2D=this._computeExtent2D(new Ce),this._extent2D._zoom=o),this._fixedExtent||(this._fixedExtent=this._computeFixedExtent(e,new Ce)))),!this._extent2D)return s&&delete this._fixedExtent,null;var a=this._fixedExtent,l=a.xmin,h=a.ymin,u=a.xmax,c=a.ymax;return s&&delete this._fixedExtent,Yc.set(l,-c,u,-h),n?(n.set(this._extent2D.xmin,this._extent2D.ymin,this._extent2D.xmax,this._extent2D.ymax),n._add(Yc),n):this._extent2D.add(Yc)},t.prototype._computeExtent2D=function(e){for(var n=this.symbolizers.length-1;n>=0;n--){var i=this.symbolizers[n];e._combine(i.get2DExtent())}return e},t.prototype._computeFixedExtent=function(e,n){for(var i=this.symbolizers.length-1;i>=0;i--){var o=this.symbolizers[i];o.getFixedExtent&&n._combine(o.getFixedExtent(e))}return n},t.prototype._isDynamicSize=function(){for(var e=this.symbolizers.length-1;e>=0;e--){var n=this.symbolizers[e];if(n.isDynamicSize())return!0}return!1},t.prototype._aboveCamera=function(){var e=this.getMinAltitude(),n=this.getMap(),i=n.getGLRes();e=n.altitudeToPoint(e,i)*Br(e);var o=n.getFrustumAltitude();return e&&o&&o<e},t.prototype.getFixedExtent=function(){var e=this.getMap(),n=e.getZoom();return this._isDynamicSize()?this._computeFixedExtent(null,new Ce):((!this._extent2D||this._extent2D._zoom!==n)&&this.get2DExtent(null,Yc),this._fixedExtent)},t.prototype.setZIndex=function(e){this._eachSymbolizer(function(n){n.setZIndex(e)})},t.prototype.show=function(){if(this._painted)this.removeCache(),this._eachSymbolizer(function(n){n.show()});else{var e=this.getLayer();e.isCanvasRender()||this.paint()}},t.prototype.hide=function(){this._eachSymbolizer(function(e){e.hide()})},t.prototype.repaint=function(){this._altAtGL=this._getGeometryAltitude(),this.removeCache();var e=this.getLayer();if(e){var n=e.getRenderer();!n||!n.setToRedraw()||n.setToRedraw()}},t.prototype.refreshSymbol=function(){this.removeCache(),this._removeSymbolizers(),this.symbolizers=this._createSymbolizers()},t.prototype.remove=function(){this.removeCache(),this._removeSymbolizers()},t.prototype._removeSymbolizers=function(){this._eachSymbolizer(function(e){delete e.painter,e.remove()}),delete this.symbolizers},t.prototype.removeCache=function(){delete this._renderPoints,delete this._paintParams,delete this._sprite,delete this._extent2D,delete this._fixedExtent,delete this._cachedParams,delete this._unsimpledParams},t.prototype.getAltitude=function(){var e=this.geometry._getAltitude();return e!==this._propAlt&&(this._altAtGL=this._getGeometryAltitude()),this._altAtGL?this._altAtGL:0},t.prototype.getMinAltitude=function(){return this.minAltitude?this.minAltitude:0},t.prototype.getMaxAltitude=function(){return this.maxAltitude?this.maxAltitude:0},t.prototype._getGeometryAltitude=function(){var e=this.getMap();if(!e)return 0;var n=this.geometry._getAltitude();this._propAlt=n;var i=te(V_(n),2),o=i[0],s=i[1];if(this.minAltitude=o,this.maxAltitude=s,!n)return 0;var a=this.geometry.getCenter();return a?n:0},t.prototype._verifyProjection=function(){var e=this.geometry._getProjection()||GO;this._projCode&&this._projCode!==e.code&&this.removeCache(),this._projCode=e.code},t.prototype._beforePaint=function(){},t.prototype._afterPaint=function(){},t}(hi);function t2(r,t,e){if(!Array.isArray(e))return r;for(var n=[],i=0,o=r.length;i<o;i++)if(Array.isArray(r[i]))n.push(t2(r[i],t,e));else{var s=r[i];if(s.point.equals(t[s.index]))s.altitude=e[s.index],n.push(s);else{var a=void 0,l=void 0;s.index===0?(a=s.index,l=s.index+1):(a=s.index-1,l=s.index);var h=s.point.distanceTo(t[l]),u=h/(h+t[a].distanceTo(s.point)),c=cc(e[a],e[l],1-u);s.altitude=c,n.push(s)}}return n}var UO=new Ce,e2=function(r){Et(t,r);function t(e,n){var i=r.call(this)||this;return i.geometry=e,i.isMask=n,i.bbox=qo(),i._drawTime=0,i}return t.prototype._setDrawTime=function(e){return this._drawTime=e,this._eachPainter(function(n){n._setDrawTime(e)}),this},t.prototype.getRenderBBOX=function(){var e=this,n=this.getLayer();return n&&n._drawTime!==this._drawTime?null:(xh(this.bbox),this._eachPainter(function(i){var o=i.getRenderBBOX();Fc(o)&&Dc(e.bbox,o)}),Fc(this.bbox)?this.bbox:null)},t.prototype._eachPainter=function(e){for(var n=this.geometry.getGeometries(),i,o=0,s=n.length;o<s&&(i=this.isMask?n[o]._getMaskPainter():n[o]._getPainter(),!(!!i&&i&&e.call(this,i)===!1));o++);},t.prototype.getLayer=function(){return this.geometry&&this.geometry.getLayer()},t.prototype.paint=function(e){this.geometry&&this._eachPainter(function(n){n.paint(e)})},t.prototype.get2DExtent=function(e,n){n&&n.set(null,null,null,null);var i=n||new Ce;return this._eachPainter(function(o){i=i._combine(o.get2DExtent(e,UO))}),i},t.prototype.remove=function(){this._eachPainter(function(e){e.remove()})},t.prototype.setZIndex=function(e){this._eachPainter(function(n){n.setZIndex(e)})},t.prototype.show=function(){this._eachPainter(function(e){e.show()})},t.prototype.hide=function(){this._eachPainter(function(e){e.hide()})},t.prototype.repaint=function(){this._eachPainter(function(e){e.repaint()})},t.prototype.refreshSymbol=function(){this._eachPainter(function(e){e.refreshSymbol()})},t.prototype.hasPoint=function(){var e=!1;return this._eachPainter(function(n){return n.hasPoint()?(e=!0,!1):!0}),e},t.prototype.getMinAltitude=function(){var e=!0,n=0;return this._eachPainter(function(i){var o=i.getMinAltitude();(e||o<n)&&(e=!1,n=o)}),n},t.prototype.getMaxAltitude=function(){var e=0;return this._eachPainter(function(n){var i=n.getMaxAltitude();i>e&&(e=i)}),e},t}(hi);function $O(r){for(var t="",e=r.split(""),n=e.length,i=n-1;i>=0&&!isNaN(e[i]);i--)t=e[i]+t;return t}function WO(r){var t=r.indexOf("EPSG")>-1?r:"EPSG:"+r;return t=n2(t,[["4490","4326"],["102100","3857"],["900913","3857"]]),t}function n2(r,t){return t===void 0&&(t=[]),t.forEach(function(e){var n=te(e,2),i=n[0],o=n[1];r=r.replace(i,o)}),r}function ZO(r){var t=r.projection,e=r.isArcgis,n=r.isGeoServer,i=r.isSuperMap,o=.0002645833333333333;return(e||n||i)&&(o=28e-5),t&&t.indexOf("4326")>-1&&(o=23767925226029154e-25,(e||i)&&(o=2518101729011901e-24),n&&(o=251528279553466e-23)),o}var XO="wmts";function Qo(r,t){var e=r.getElementsByTagName(t);if(e&&e.length)return e;var n=XO+":"+t;return r.getElementsByTagName(n)}function YO(r,t){for(var e=0;e<r.length;e++){var n=r[e];if(n=n.getElementsByTagName("ows:Identifier")[0],n&&n.textContent===t)return r[e]}return null}function qO(r,t,e){var n=["isArcgis","isSuperMap","isGeoServer"];n.every(function(I){return e[I]==null})&&console.warn("Please specify the server type, such as isArcgis, isSuperMap, isGeoServer, Otherwise, the system will determine by itself"),e.isArcgis==null&&(e.isArcgis=["arcgis","geoscene"].some(function(I){return r.indexOf(I)>-1})),e.isSuperMap==null&&(e.isSuperMap=r.indexOf("supermap")>-1);var i=new DOMParser,o=i.parseFromString(r,"text/xml"),s=o.querySelectorAll("Contents")[0];if(!s)return[];var a=Qo(s,"Layer");if(!a.length)return[];for(var l=[],h=0,u=s.childNodes.length;h<u;h++)s.childNodes[h].localName==="TileMatrixSet"&&l.push(s.childNodes[h]);if(!l.length)return[];for(var c=[],h=0,u=a.length;h<u;h++){var f=a[h],d=f.querySelectorAll("Style")[0];d&&(d=d.getElementsByTagName("ows:Identifier")[0],d&&(d=d.textContent));var p=f.getElementsByTagName("ows:Identifier")[0];p&&(p=p.textContent);var g=Qo(f,"TileMatrixSetLink");if(g.length!==0)for(var m=0,y=g.length;m<y;m++){var x=g[m];x=Qo(x,"TileMatrixSet")[0],x&&(x=x.textContent);var v=YO(l,x);if(v){var _=f.querySelectorAll("ResourceURL")[0],w="";_&&(w=_.attributes.template.value);var b=JO(v,e),A=b.resolutions,T=b.tileSize,S=b.tileSystem,M=b.projection,E=b.TileMatrixSet,P=b.isGeoServer,k=b.levelStr;w.length||(w=t.substr(0,t.lastIndexOf("?")),w+="?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER={LAYER}&STYLE={Style}&TILEMATRIXSET={TileMatrixSet}&FORMAT={tiles}&TILEMATRIX={TileMatrix}&TILEROW={TileRow}&TILECOL={TileCol}");var O=n2(w,[["{LAYER}",p],["{Layer}",p],["{layer}",p],["{STYLE}",d],["{Style}",d],["{style}",d],["{TileMatrixSet}",E],["{TileMatrix}",P?"".concat(k,":{z}"):"{z}"],["{TileRow}","{y}"],["{TileCol}","{x}"],["{tiles}",P?"image/png":"tiles"]]);c.push({tileSize:T,tileSystem:S,spatialReference:{resolutions:A,projection:M},urlTemplate:O,info:{layerName:p,TileMatrixSet:E,style:d,tileSize:T,tileSystem:S,resolutions:A,projection:M,urlTemplate:O}})}}}return c}function JO(r,t){t===void 0&&(t={});var e=Qo(r,"TileMatrix"),n=[],i=[],o=[],s,a,l=!1,h;if(!s){var u=r.getElementsByTagName("ows:SupportedCRS")[0];u&&(s=u.textContent,s=s.split("EPSG")[1],s=$O(s),s=WO(s))}a||(a=r.getElementsByTagName("ows:Identifier")[0],a&&(a=a.textContent)),t.projection=s;for(var c=1/0,f=0;f<e.length;f++){var d=e[f],p=d.getElementsByTagName("ows:Identifier")[0].textContent;isNaN(parseInt(p))?(h=p.substr(0,p.lastIndexOf(":")),p=p.split(":"),p=p[p.length-1],p=parseInt(p),l=!0,t.isGeoServer=!0):p=parseInt(p),c=Math.min(c,p);var g=Qo(d,"ScaleDenominator")[0].textContent,m=Qo(d,"TopLeftCorner")[0].textContent,y=Qo(d,"TileWidth")[0].textContent,x=Qo(d,"TileHeight")[0].textContent;if(o.length===0&&o.push(parseInt(y),parseInt(x)),i.length===0){var v=te(m.split(" ").filter(function(S){return S!==""}).map(function(S){return parseFloat(S)}),2),_=v[0],w=v[1];_>0?i.push(1,-1,w,_):i.push(1,-1,_,w)}var b=ZO(t),A=parseFloat(g)*b;n.push(A)}if(c>0)for(var A=n[0],T=c-1;T>=0;T--)A=A*2,n.splice(0,0,A);return{resolutions:n,tileSize:o,tileSystem:i,projection:s,TileMatrixSet:a,isGeoServer:l,levelStr:h}}var KO=function(r,t,e){e===void 0&&(e={jsonp:!0}),Se(r)&&Ir.get(r,function(n,i){if(n){t(n);return}var o=qO(i,r,e);t(null,o)},e)};function r2(r){for(var t=r.tileInfo,e=[t.cols,t.rows],n=[],i=t.lods,o=0,s=i.length;o<s;o++)n.push(i[o].resolution);var a=r.fullExtent,l=t.origin,h=[1,-1,l.x,l.y];return delete a.spatialReference,{spatialReference:{resolutions:n,fullExtent:a},tileSystem:h,tileSize:e}}var QO=function(r,t,e){if(e===void 0&&(e={jsonp:!0}),Se(r)&&r.substring(0,1)!=="{")Ir.getJSON(r,function(i,o){if(i){t(i);return}var s=r2(o);t(null,s)},e);else{Se(r)&&(r=uh(r));var n=r2(r);t(null,n)}},Fa=23,Kr={"EPSG:3857":{projection:"EPSG:3857",resolutions:function(){for(var r=[],t=12756274*Math.PI,e=0;e<Fa;e++)r[e]=t/(256*Math.pow(2,e));return r}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}},"EPSG:4326":{projection:"EPSG:4326",fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){for(var r=[],t=0;t<Fa;t++)r[t]=180/(Math.pow(2,t)*128);return r}()},BAIDU:{projection:"baidu",resolutions:function(){for(var r=Math.pow(2,18),t=[],e=0;e<Fa;e++)t[e]=r,r*=.5;return t}(),fullExtent:{top:33554432,left:-33554432,bottom:-33554432,right:33554432}},IDENTITY:{projection:"identity",resolutions:function(){for(var r=Math.pow(2,8),t=[],e=0;e<Fa;e++)t[e]=r,r*=.5;return t}(),fullExtent:{top:2e5,left:-2e5,bottom:-2e5,right:2e5}},"PRESET-VT-3857":{projection:"EPSG:3857",resolutions:function(){for(var r=[],t=6378137*Math.PI,e=0;e<Fa;e++)r[e]=t/(256*Math.pow(2,e));return r}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}},"PRESET-VT-4326":{projection:"EPSG:4326",fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){for(var r=[],t=0;t<Fa;t++)r[t]=180/4/(Math.pow(2,t)*128);return r}()}};Kr["EPSG:4490"]=Kr["EPSG:4326"],Kr["PRESET-3857-512"]=Kr["PRESET-VT-3857"],Kr["PRESET-4326-512"]=Kr["PRESET-VT-4326"],Kr["PRESET-4490-512"]=Kr["PRESET-VT-4326"];var eo=function(){function r(t){t===void 0&&(t={}),this.options=t,this._initSpatialRef()}return r.registerPreset=function(t,e){t=t&&t.toUpperCase(),Kr[t]&&console.warn("Spatial reference ".concat(t," already registered.")),Kr[t]=e},r.getPreset=function(t){return Kr[t.toUpperCase()]},r.getAllPresets=function(){return Object.keys(Kr)},r.loadArcgis=function(t,e,n){return QO(t,e,n),this},r.loadWMTS=function(t,e,n){return KO(t,e,n),this},r.getProjectionInstance=function(t){var e;if(!t)return null;if(Se(t)?e={code:t}:e=t,e.project)return e.locate||(e=Gt({},e),e.measure==="identity"?Gt(e,A_.getInstance("IDENTITY")):Gt(e,A_.getInstance("EPSG:4326"))),e;var n=(e.code+"").toLowerCase();for(var i in To)if(ga(To,i)){var o=To[i].aliases||[],s=To[i].code;s&&o.push(s);for(var a=0;a<o.length;a++)if(o[a].toLowerCase()===n)if(To[i].create){var l=To[i].create(t);return l.code=o[a],l}else{if(To[i].code===o[a])return To[i];var l=Gt({},To[i]);return l.code=o[a],l}}return null},r.equals=function(t,e){if(Se(t)||Se(e))return t===e;if(!t&&!e)return!0;if(!t||!e||t.projection!==e.projection)return!1;var n=t.fullExtent,i=e.fullExtent;if(n&&!i||!n&&i||n&&i&&(n.top!==i.top||n.bottom!==i.bottom||n.left!==i.left||n.right!==i.right))return!1;var o=t.resolutions,s=e.resolutions;if(o&&s){if(o.length!==s.length)return!1;for(var a=0;a<o.length;a++)if(o[a]!==s[a])return!1}else if(o||s)return!1;return!0},r.prototype._initSpatialRef=function(){var t;if(this.options.projection?t=r.getProjectionInstance(this.options.projection):t=O_,!t)throw new Error("must provide a valid projection in map's spatial reference.");t=Gt({},Jo,t),t.measureLength||Gt(t,w_),this._projection=t;var e,n=this.options.resolutions;if(!n&&(t.code&&(e=Kr[t.code.toUpperCase()],e&&(n=e.resolutions,this.isEPSG=t.code!=="IDENTITY")),!n))throw new Error("must provide valid resolutions in map's spatial reference.");if(this._resolutions=n,this._pyramid=!0,this._pyramid){for(var i=1e4,o=0;o<n.length;o++)if(n[o]&&n[o-1]&&Math.round(n[o-1]/n[o]*i)/i!==2){this._pyramid=!1;break}}var s=this.options.fullExtent;if(!s&&(t.code&&(e=Kr[t.code.toUpperCase()],e&&(s=e.fullExtent)),!s))throw new Error("must provide a valid fullExtent in map's spatial reference.");if(U(s.left)?(this._fullExtent=new gn(s),s.left=s.xmin,s.right=s.xmax,s.top=s.ymax,s.bottom=s.ymin):this._fullExtent=new gn(new at(s.left,s.top),new at(s.right,s.bottom)),U(s.top)||U(s.bottom)||U(s.left)||U(s.right))throw new Error("must provide valid top/bottom/left/right in fullExtent.");Gt(this._fullExtent,s),this._projection.fullExtent=s;var a=s.right>=s.left?1:-1,l=s.top>=s.bottom?-1:1;this._transformation=new y_([a,l,0,0])},r.prototype.getResolutions=function(){return this._resolutions||[]},r.prototype.getResolution=function(t){var e=t|0;e<0?e=0:e>this._resolutions.length-1&&(e=this._resolutions.length-1);var n=this._resolutions[e];if(e!==t&&t>0&&e<this._resolutions.length-1){var i=this._resolutions[e+1];return n+(i-n)*(t-e)}return n},r.prototype.getProjection=function(){return this._projection},r.prototype.getFullExtent=function(){return this._fullExtent},r.prototype.getTransformation=function(){return this._transformation},r.prototype.getMinZoom=function(){for(var t=0;t<this._resolutions.length;t++)if(!U(this._resolutions[t]))return t;return 0},r.prototype.getMaxZoom=function(){for(var t=this._resolutions.length-1;t>=0;t--)if(!U(this._resolutions[t]))return t;return this._resolutions.length-1},r.prototype.getZoomDirection=function(){return Br(this._resolutions[this.getMinZoom()]-this._resolutions[this.getMaxZoom()])},r.prototype.toJSON=function(){return this.json||(this.json={resolutions:this._resolutions,fullExtent:{top:this._fullExtent.top,left:this._fullExtent.left,bottom:this._fullExtent.bottom,right:this._fullExtent.right},projection:this._projection.code}),this.json},r.prototype.isPyramid=function(){return this._pyramid},r}(),hm=new W(0,0),i2=new Ce,um={};function tk(r){if(!r)return!1;var t=r.xmin,e=r.ymin,n=r.xmax,i=r.ymax;return n-t>0&&i-e>0}var ek={id:null,visible:!0,interactive:!0,editable:!0,cursor:null,antiMeridian:!1,defaultProjection:"EPSG:4326"},en=function(r){Et(t,r);function t(e){var n=this,i=Gt({},e),o=i.symbol,s=i.properties,a=i.id;return delete i.symbol,delete i.id,delete i.properties,n=r.call(this,i)||this,o?n.setSymbol(o):n._genSizeSymbol(),s&&n.setProperties(s),U(a)||n.setId(a),e&&It(e.rotateAngle)&&(n._dirtyRotate=!0),n}return t.fromJSON=function(e){return e},t.prototype.getFirstCoordinate=function(){if(this.type==="GeometryCollection"){var e=this.getGeometries();return e.length?e[0].getFirstCoordinate():null}var n=this.getCoordinates();if(!Array.isArray(n))return n;do n=n[0];while(Array.isArray(n)&&n.length>0);return n},t.prototype.getLastCoordinate=function(){if(this.type==="GeometryCollection"){var e=this.getGeometries();return e.length?e[e.length-1].getLastCoordinate():null}var n=this.getCoordinates();if(!Array.isArray(n))return n;do n=n[n.length-1];while(Array.isArray(n)&&n.length>0);return n},t.prototype.addTo=function(e,n){return e.addGeometry(this,n),this},t.prototype.getLayer=function(){return this._layer?this._layer:null},t.prototype.getMap=function(){return this._layer?this._layer.getMap():null},t.prototype.getId=function(){return this._id},t.prototype.setId=function(e){var n=this.getId();return this._id=e,this._fireEvent("idchange",{old:n,new:e}),this},t.prototype.getProperties=function(){return this.properties?this.properties:this._getParent()?this._getParent().getProperties():null},t.prototype.setProperties=function(e){var n=this.properties;return this.properties=kr(e)?Gt({},e):e,this._clearAltitudeCache(),this._repaint(),this._fireEvent("propertieschange",{old:n,new:e}),this},t.prototype.getType=function(){return this.type},t.prototype.getSymbol=function(){var e=this._symbol;return e?Array.isArray(e)?Bi(e):Gt({},e):null},t.prototype.setSymbol=function(e){return this._symbolUpdated=e,this._symbol=this._prepareSymbol(e),this.onSymbolChanged(),delete this._compiledSymbol,delete this._symbolHash,this},t.prototype.getSymbolHash=function(){return this._symbolHash||(this._symbolHash=vh(this._symbolUpdated)),this._symbolHash},t.prototype.updateSymbol=function(e){if(!e)return this;var n=this._getSymbol();if(Array.isArray(n)){if(!Array.isArray(e))throw new Error("Parameter of updateSymbol is not an array.");for(var i=0;i<e.length;i++)$c(e[i])&&delete this._textDesc,n[i]&&e[i]&&(n[i]=Bi(n[i],e[i]))}else{if(Array.isArray(e))throw new Error("Geometry's symbol is not an array to update.");$c(n)&&delete this._textDesc,n?n=Bi(n,e):n=Bi(this._getInternalSymbol(),e)}return this._eventSymbolProperties=e,delete this._compiledSymbol,this.setSymbol(n)},t.prototype.getTextContent=function(){var e=this._getInternalSymbol();if(Array.isArray(e)){for(var n=[],i=!1,o=0;o<e.length;o++)n[o]=vc(e[o]&&e[o].textName,this.getProperties()),U(n[o])||(i=!0);return i?n:null}return vc(e&&e.textName,this.getProperties())},t.prototype.getTextDesc=function(){if(!this._textDesc){var e=this.getTextContent(),n=this._sizeSymbol,i=Array.isArray(e);Array.isArray(n)?this._textDesc=n.map(function(o,s){return xc(i?e[s]:"",o)}):this._textDesc=xc(e,n)}return this._textDesc},t.prototype.getCenter=function(){return this._computeCenter(this._getMeasurer())},t.prototype.getExtent=function(){var e=this._getPrjExtent(),n=this._getProjection();if(e&&n){var i=n.unproject(new at(e.xmin,e.ymin)),o=n.unproject(new at(e.xmax,e.ymax));return new gn(i,o,n)}else return this._computeExtent(this._getMeasurer())},t.prototype.getContainerExtent=function(e){var n=this.get2DExtent();if(!n||!n.isValid())return null;var i=this.getMap(),o=i.getGLRes(),s=this.getMinAltitude(),a=n.convertTo(function(p){return i._pointAtResToContainerPoint(p,o,s,hm)},e),l=this.getMaxAltitude();if(l!==s){var h=n.convertTo(function(p){return i._pointAtResToContainerPoint(p,o,l,hm)},i2);a._combine(h)}var u=this.getLayer();if(u&&this.type==="LineString"&&l&&u.options.drawAltitude){var c=n.convertTo(function(p){return i._pointAtResToContainerPoint(p,o,0,hm)},i2);a._combine(c)}if(a){var f=this._getFixedExtent();tk(f)&&a._add(f)}var d=this.options.smoothness;return d&&a._expand(a.getWidth()*.15),a},t.prototype._getFixedExtent=function(){this._fixedExtent||(this._fixedExtent=new Ce);var e=this._sizeSymbol,n=(e&&e.lineWidth||1)/2;this._fixedExtent.set(-n,-n,n,n);var i=e&&e.lineDx||0;this._fixedExtent._add([i,0]);var o=e&&e.lineDy||0;return this._fixedExtent._add([0,o]),this._fixedExtent},t.prototype.get2DExtent=function(){var e=this.getMap();if(!e)return null;if(this._extent2d)return this._extent2d;var n=this._getPrjExtent();if(!n||!n.isValid())return null;var i=n.getMin(),o=n.getMax(),s=e.getGLRes();return e._prjToPointAtRes(i,s,i),e._prjToPointAtRes(o,s,o),this._extent2d=new Ce(i,o),this._extent2d.z=e.getZoom(),this._extent2d},t.prototype.getSize=function(){var e=this.getContainerExtent();return e?e.getSize():null},t.prototype.containsPoint=function(e,n){if(!this.getMap())throw new Error('The geometry is required to be added on a map to perform "containsPoint".');return e instanceof at&&(e=this.getMap().coordToContainerPoint(e)),this._containsPoint(e,n)},t.prototype._containsPoint=function(e,n){var i=this._getPainter();return i?(n=n||0,this._hitTestTolerance&&(n+=this._hitTestTolerance()),i.hitTest(e,n)):!1},t.prototype.show=function(){if(this.options.visible=!0,this.getMap()){var e=this._getPainter();e&&e.show(),this._fireEvent("show")}return this},t.prototype.hide=function(){if(this.options.visible=!1,this.getMap()){this.onHide();var e=this._getPainter();e&&e.hide(),this._fireEvent("hide")}return this},t.prototype.isVisible=function(){if(!this.options.visible)return!1;var e=this._getInternalSymbol();if(!e)return!0;if(!this.symbolIsVisible())return!1;if(Array.isArray(e)){if(!e.length)return!0;for(var n=0,i=e.length;n<i;n++)if(U(e[n].opacity)||e[n].opacity>0)return!0;return!1}else return U(e.opacity)||kr(e.opacity)||It(e.opacity)&&e.opacity>0},t.prototype.symbolIsVisible=function(){var e=this._getCompiledSymbol();if(!e)return!0;Array.isArray(e)||(e=[e]);for(var n=0,i=e.length;n<i;n++){var o=e[n];if(o){var s=o.visible;if(s!==!1&&s!==0)return!0}}return!1},t.prototype.getZIndex=function(){return this.options.zIndex||0},t.prototype.setZIndex=function(e){var n=this.options.zIndex;return this.options.zIndex=e,this._fireEvent("zindexchange",{old:n,new:e}),this},t.prototype.setZIndexSilently=function(e){return this.options.zIndex=e,this},t.prototype.bringToFront=function(){var e=this.getLayer();if(!e||!e.getGeoMaxZIndex)return this;var n=e.getGeoMaxZIndex();return this.setZIndex(n+1),this},t.prototype.bringToBack=function(){var e=this.getLayer();if(!e||!e.getGeoMinZIndex)return this;var n=e.getGeoMinZIndex();return this.setZIndex(n-1),this},t.prototype.translate=function(e,n){if(U(e))return this;var i=new at(e,n);if(i.x===0&&i.y===0)return this;var o=this.getCoordinates();if(this._silence=!0,o)if(Array.isArray(o)){var s=Es(o,function(a){return a.add(i)});this.setCoordinates(s)}else this.setCoordinates(o.add(i));return this._silence=!1,this._fireEvent("positionchange"),this},t.prototype._translateRotatePivot=function(e){if(!this._pivot||!e)return this;if(this.options.rotatePivot){var n=this.getCoordinates();if(!n)return this;e instanceof at||(e=new at(e));var i=e.sub(n);if(i.x===0&&i.y===0)return this;this._pivot._add(i),this.options.rotatePivot=this._pivot.toArray()}return this},t.prototype.flash=function(e,n,i,o){return Up.call(this,e,n,i,o)},t.prototype.copy=function(){var e=this.toJSON(),n=t.fromJSON(e);return n.options.visible=!0,n},t.prototype.remove=function(){var e=this.getLayer();return e?(this._fireEvent("removestart"),this._unbind(),this._fireEvent("removeend"),this._fireEvent("remove"),this):this},t.prototype.toGeoJSONGeometry=function(){var e=this._exportGeoJSONGeometry();return e},t.prototype.toGeoJSON=function(e){e||(e={});var n={type:"Feature",geometry:null};if(U(e.geometry)||e.geometry){var i=this._exportGeoJSONGeometry();n.geometry=i}var o=this.getId();U(o)||(n.id=o);var s;return(U(e.properties)||e.properties)&&(s=this._exportProperties()),n.properties=s,n},t.prototype.toJSON=function(e){e||(e={});var n=this._toJSON(e),i=this._exportGraphicOptions(e);return Gt(n,i),n},t.prototype.getLength=function(){return this._computeGeodesicLength(this._getMeasurer())},t.prototype.getArea=function(){return this._computeGeodesicArea(this._getMeasurer())},t.prototype.rotate=function(e,n){if(!It(e))return console.error("angle:".concat(e," is not number")),this;if(this._painter||(this._dirtyRotate=!0),this.type==="GeometryCollection"){var i=this.getGeometries();return i.forEach(function(l){return l.rotate(e,n)}),this}n?n=new at(n):n=this.getCenter(),this._angle=e,this._pivot=n;var o=this._getMeasurer(),s=this.getCoordinates();if(!Array.isArray(s)){if((n.x!==s.x||n.y!==s.y)&&!this.getShell){var a=o._rotate(s,n,e);this.setCoordinates(a)}else this.onPositionChanged();return this.getShell&&(this.options.rotateAngle=e,this.options.rotatePivot=n.toArray()),this}return Es(s,function(l){return o._rotate(l,n,e)}),this.setCoordinates(s),this},t.prototype._rotatePrjCoordinates=function(e){if(!e||this._angle===0||!this._pivot)return e;var n=this._getProjection();if(!n)return e;var i=0,o=Array.isArray(e),s=o?e:[e],a=[],l,h;if(this.getRotateOffsetAngle){i=this.getRotateOffsetAngle();var u=s[s.length-1];l=u.x,h=u.y}else{var c=qo();_h(s,c);var f=te(c,4),d=f[0],p=f[1],g=f[2],m=f[3];l=(d+g)/2,h=(p+m)/2}for(var y=0,x=s.length;y<x;y++){var v=s[y],_=v.x,w=v.y,b=_-l,A=w-h,T=Math.sqrt(b*b+A*A),S=nk(l,h,_,w),M=(S-this._angle+i)/180*Math.PI,E=Math.cos(M)*T,P=Math.sin(M)*T,k=new at(l+E,h+P);a.push(k)}for(var O=n.project(this._pivot),I=O.x,D=O.y,z=l-I,L=h-D,y=0,x=a.length;y<x;y++){var v=a[y];v.x-=z,v.y-=L}return o?a:a[0]},t.prototype.isRotated=function(){return!!(It(this._angle)&&this._pivot)},t.prototype._getConnectPoints=function(){return[this.getCenter()]},t.prototype._initOptions=function(e){var n=Gt({},e),i=n.symbol,o=n.properties,s=n.id;delete n.symbol,delete n.id,delete n.properties,this.setOptions(n),i&&this.setSymbol(i),o&&this.setProperties(o),U(s)||this.setId(s)},t.prototype._bindLayer=function(e){if(e!==this.getLayer()){if(this.getLayer())throw new Error("Geometry cannot be added to two or more layers at the same time.");this._layer=e,this._clearCache(),this._bindInfoWindow(),this._bindMenu()}},t.prototype._prepareSymbol=function(e){if(Array.isArray(e)){for(var n=[],i=0;i<e.length;i++)n.push(Ec(this._checkAndCopySymbol(e[i])));return n}else if(e)return e=this._checkAndCopySymbol(e),Ec(e);return null},t.prototype._checkAndCopySymbol=function(e){var n={};for(var i in e)p5[i]&&Se(e[i])?n[i]=+e[i]:n[i]=e[i];return n},t.prototype._getSymbol=function(){return this._symbol},t.prototype._setExternSymbol=function(e){return this._eventSymbolProperties=e,this._symbol||delete this._textDesc,this._externSymbol=this._prepareSymbol(e),this.onSymbolChanged(),this},t.prototype._getInternalSymbol=function(){return this._symbol?this._symbol:this._externSymbol?this._externSymbol:this.options.symbol?this.options.symbol:null},t.prototype._getPrjExtent=function(){var e=this._getProjection();return this._verifyProjection(),!this._extent&&e&&(this._extent=this._computePrjExtent(e)),this._extent},t.prototype._unbind=function(){var e=this.getLayer();e&&(this._animPlayer&&this._animPlayer.finish(),this._unbindMenu(),this._unbindInfoWindow(),this.isEditing()&&this.endEdit(),this._removePainter(),this.onRemove&&this.onRemove(),e.onRemoveGeometry&&e.onRemoveGeometry(this),delete this._layer,delete this._internalId,delete this._extent)},t.prototype._getInternalId=function(){return this._internalId},t.prototype._setInternalId=function(e){this._internalId=e},t.prototype._getMeasurer=function(){return this._getProjection()?this._getProjection():eo.getProjectionInstance(this.options.defaultProjection)},t.prototype._getProjection=function(){var e=this.getMap();return e?e.getProjection():null},t.prototype._verifyProjection=function(){var e=this._getProjection();this._projCode&&e&&this._projCode!==e.code&&this._clearProjection(),this._projCode=e?e.code:this._projCode},t.prototype._getExternalResources=function(){var e=this._getInternalSymbol();return yh(e)},t.prototype._getPainter=function(){if(this._painter)return this._painter;var e=this.getLayer();if(!this._painter&&e){if(W1.indexOf(this.type)!==-1){if(e.constructor.getCollectionPainterClass){var n=e.constructor.getCollectionPainterClass();n&&(this._painter=new n(this))}}else if(e.constructor.getPainterClass){var n=e.constructor.getPainterClass();n&&(this._painter=new n(this))}}return this._painter},t.prototype._getMaskPainter=function(){return this._maskPainter?this._maskPainter:(this._maskPainter=this.getGeometries&&this.getGeometries()?new e2(this,!0):new lm(this),this._maskPainter)},t.prototype._removePainter=function(){this._painter&&this._painter.remove(),delete this._painter},t.prototype._paint=function(e){if(this.symbolIsVisible()&&this._painter){if(this._dirtyCoords){delete this._dirtyCoords;var n=this._getProjection();n&&(this._pcenter=n.project(this._coordinates),this._clearCache())}this._dirtyRotate&&It(this.options.rotateAngle)&&this.rotate(this.options.rotateAngle,this.options.rotatePivot),this._dirtyRotate=!1,this._painter.paint(e)}},t.prototype._clearCache=function(){delete this._extent,delete this._extent2d,this._clearAltitudeCache()},t.prototype._clearProjection=function(){delete this._extent,delete this._extent2d},t.prototype._repaint=function(){this._painter&&this._painter.repaint()},t.prototype.onHide=function(){this.closeMenu(),this.closeInfoWindow()},t.prototype.onShapeChanged=function(){this._clearCache(),this._repaint(),this._fireEvent("shapechange")},t.prototype.onPositionChanged=function(){this._clearCache(),this._repaint(),this._fireEvent("positionchange")},t.prototype.onSymbolChanged=function(){this._painter&&this._painter.refreshSymbol();var e={};this._eventSymbolProperties?(e.properties=JSON.parse(JSON.stringify(this._eventSymbolProperties)),delete this._eventSymbolProperties):delete this._textDesc,this._genSizeSymbol(),this._fireEvent("symbolchange",e)},t.prototype._genSizeSymbol=function(){var e=this._getInternalSymbol();if(!e){delete this._sizeSymbol;return}if(Array.isArray(e)){this._sizeSymbol=[];for(var n=!1,i=0;i<e.length;i++){var o=this._sizeSymbol[i]=this._getSizeSymbol(e[i]);!n&&o&&o._dynamic&&(n=!0)}this._sizeSymbol._dynamic=n}else this._sizeSymbol=this._getSizeSymbol(e)},t.prototype._getSizeSymbol=function(e){var n=Pc({lineWidth:e.lineWidth,lineDx:e.lineDx,lineDy:e.lineDy},this);return(Cn(e.lineWidth)||Cn(e.lineDx)||Cn(e.lineDy))&&(n._dynamic=!0),n},t.prototype._getCompiledSymbol=function(){return this._compiledSymbol?this._compiledSymbol:(this._compiledSymbol=Pc(this._getInternalSymbol(),this),this._compiledSymbol)},t.prototype.onConfig=function(e){var n;e.properties&&(n=e.properties,delete e.properties);var i=!1;for(var o in e)if(e.hasOwnProperty(o)){var s=o.slice(0,5);if(s==="arrow"||s==="smoot"){i=!0;break}}n?(this.setProperties(n),this._repaint()):i&&this._repaint()},t.prototype._setParent=function(e){e&&(this._parent=e)},t.prototype._getParent=function(){return this._parent},t.prototype._fireEvent=function(e,n){this._silence||(this.getLayer()&&this.getLayer()._onGeometryEvent&&(n||(n={}),n.type=e,n.target=this,this.getLayer()._onGeometryEvent(n)),this.fire(e,n))},t.prototype._toJSON=function(e){return{feature:this.toGeoJSON(e)}},t.prototype._recordVisible=function(){var e=this.options.visible;U(e)&&(e=!0),this._savedVisible=e},t.prototype._recoveryVisible=function(){delete this._savedVisible},t.prototype._exportGraphicOptions=function(e){var n={};return(U(e.options)||e.options)&&(n.options=this.config()),n.options&&this.isEditing&&this.isEditing()&&(n.options.visible=this._savedVisible),(U(e.symbol)||e.symbol)&&(n.symbol=this.getSymbol()),(U(e.infoWindow)||e.infoWindow)&&this._infoWinOptions&&(n.infoWindow=this._infoWinOptions),n},t.prototype._exportGeoJSONGeometry=function(){var e=this.getCoordinates(),n=at.toNumberArrays(e);return{type:this.getType(),coordinates:n}},t.prototype._exportProperties=function(){var e=null,n=this.getProperties();return U(n)||(kr(n)?e=Gt({},n):e=n),e},t.prototype._hitTestTolerance=function(){return 0},t.prototype._getAltitude=function(){var e=this.getLayer();if(!e)return 0;var n=e.options,i=e.getAltitude?e.getAltitude():0,o=n.enableAltitude;if(!o&&e.isVectorLayer)return i;var s=cm(e),a=this.properties||um,l=a[s];if(U(l)){var h=o2(this,i,o);return U(h)?i:h}return Array.isArray(l)?l.map(function(u){return u+i}):l+i},t.prototype.getAltitude=function(){var e=this.getLayer(),n=cm(e),i=this.properties||um,o=i[n];if(!U(o))return o;var s=o2(this,0,!1);return U(s)?0:s},t.prototype.hasAltitude=function(){return this._genMinMaxAlt(),!!this._minAlt||!!this._maxAlt},t.prototype.setAltitude=function(e){if(!It(e))return this;var n=this.getLayer(),i=cm(n),o=this.properties||um,s=o[i];if(!U(s))if(Array.isArray(s))for(var a=0,l=s.length;a<l;a++)s[a]=e;else o[i]=e;var h=this.getCoordinates?this.getCoordinates():null;if(!h)return this;if(s2(h,e),n){var u=n.getRenderer();u&&u.gl?this.setCoordinates(h):u&&this._repaint()}return this._clearAltitudeCache(),this.onPositionChanged(),this},t.prototype._genMinMaxAlt=function(){if(this._minAlt===void 0||this._maxAlt===void 0){var e=this._getAltitude(),n=te(V_(e),2),i=n[0],o=n[1];this._minAlt=i,this._maxAlt=o}},t.prototype.getMinAltitude=function(){return this._genMinMaxAlt(),this._minAlt},t.prototype.getMaxAltitude=function(){return this._genMinMaxAlt(),this._maxAlt},t.prototype._clearAltitudeCache=function(){return this._minAlt=void 0,this._maxAlt=void 0,this},t}(h_(to(Dg(hi))));en.mergeOptions(ek);function cm(r){var t="altitude";if(r){if(!r.isVectorLayer)return null;var e=r.options;t=e.altitudeProperty}return t}function o2(r,t,e){var n=r.getCoordinates?r.getCoordinates():null;if(n){var i=[];if(a2(n,i),i.length){var o=l2(n,t,e);return o}}return null}function s2(r,t){if(Array.isArray(r))for(var e=0,n=r.length;e<n;e++)s2(r[e],t);else r.z=t}function a2(r,t){if(!t.length)if(Array.isArray(r))for(var e=0,n=r.length;e<n;e++)a2(r[e],t);else It(r.z)&&t.push(r.z)}function l2(r,t,e){if(Array.isArray(r)){for(var n=[],i=0,o=r.length;i<o;i++)n.push(l2(r[i],t,e));return n}return It(r.z)?e?t+r.z:r.z:e?t:0}function nk(r,t,e,n){if(r===e)return n>t?-90:90;e-=r,n-=t,n=-n;var i=Math.atan2(n,e);return i/Math.PI*180}var rk={attribution:null,minZoom:null,maxZoom:null,visible:!0,opacity:1,globalCompositeOperation:null,renderer:"canvas",debugOutline:"#0f0",cssFilter:null,forceRenderOnMoving:!1,forceRenderOnZooming:!1,forceRenderOnRotating:!1,collision:!1,collisionScope:"layer",hitDetect:function(){return!be.mobile}(),maskClip:!0},Rr=function(r){Et(t,r);function t(e,n){var i=this,o;return n&&(o=n.canvas,delete n.canvas),i=r.call(this,n)||this,i._canvas=o,i.setId(e),n&&(i.setZIndex(n.zIndex),n.mask&&i.setMask(en.fromJSON(n.mask))),i.proxyOptions(),i}return t.prototype.load=function(){if(!this.getMap())return this;if(this.onLoad()){this._initRenderer();var e=this.getZIndex();U(e)||(this._renderer.setZIndex(e),this.isCanvasRender()||this._renderer.render()),this.onLoadEnd()}return this},t.prototype.getId=function(){return this._id},t.prototype.setId=function(e){var n=this._id;return U(e)||(e=e+""),this._id=e,this.fire("idchange",{type:"idchange",target:this,old:n,new:e}),this},t.prototype.addTo=function(e){return e.addLayer(this),this},t.prototype.setZIndex=function(e){return this._zIndex=e,U(e)?delete this.options.zIndex:this.options.zIndex=e,this.map&&this.map._sortLayersByZIndex(),this._renderer&&this._renderer.setZIndex(e),this.fire("setzindex",{type:"setzindex",target:this,zIndex:e}),this},t.prototype.getZIndex=function(){return this._zIndex||0},t.prototype.getMinZoom=function(){var e=this.getMap(),n=this.options.minZoom;return e?Math.max(e.getMinZoom(),n||0):n},t.prototype.getMaxZoom=function(){var e=this.getMap(),n=this.options.maxZoom;return e?Math.min(e.getMaxZoom(),U(n)?1/0:n):n},t.prototype.getOpacity=function(){return this.options.opacity},t.prototype.setOpacity=function(e){return this.config("opacity",e),this.fire("setopacity",{type:"setopacity",target:this,opacity:e}),this},t.prototype.isCanvasRender=function(){var e=this._getRenderer();return e&&e instanceof Oa},t.prototype.getMap=function(){return this.map?this.map:null},t.prototype.getProjection=function(){var e=this.getMap();return e?e.getProjection():null},t.prototype.bringToFront=function(){var e=this._getLayerList();if(!e.length)return this;var n=e[e.length-1];if(e.length===1||n===this)return this;var i=n.getZIndex();return this.setZIndex(i+1),this},t.prototype.bringToBack=function(){var e=this._getLayerList();if(!e.length)return this;var n=e[0];if(e.length===1||n===this)return this;var i=n.getZIndex();return this.setZIndex(i-1),this},t.prototype.show=function(){var e=this;if(!this.options.visible){this.options.visible=!0;var n=this.getRenderer();n&&n.show();var i=this.getMap();n&&i?i.once("renderend",function(){e.fire("show")}):this.fire("show")}return this},t.prototype.hide=function(){var e=this;if(this.options.visible){this.options.visible=!1;var n=this.getRenderer();n&&n.hide();var i=this.getMap();n&&i?i.once("renderend",function(){e.fire("hide")}):this.fire("hide")}return this},t.prototype.isVisible=function(){if(It(this.options.opacity)&&this.options.opacity<=0)return!1;var e=this.getMap();if(e){var n=e.getZoom();if(!U(this.options.maxZoom)&&this.options.maxZoom<n||!U(this.options.minZoom)&&this.options.minZoom>n)return!1}return U(this.options.visible)&&(this.options.visible=!0),this.options.visible},t.prototype.remove=function(){if(this.map){var e=this.map.getRenderer();this.map.removeLayer(this),e&&e.setToRedraw()}else this.fire("remove");return this},t.prototype.getMask=function(){return this._mask},t.prototype.setMask=function(e){if(!(e.type==="Point"&&e._isVectorMarker()||e.type==="Polygon"||e.type==="MultiPolygon"))throw new Error("Mask for a layer must be a marker with vector marker symbol or a Polygon(MultiPolygon).");if(e._bindLayer(this),e.type==="Point"?e.updateSymbol({markerLineColor:"rgba(0, 0, 0, 0)",markerFillOpacity:0}):e.setSymbol({lineColor:"rgba(0, 0, 0, 0)",polygonOpacity:0}),this._mask=e,e&&e.toGeoJSON)try{this._maskGeoJSON=e.toGeoJSON()}catch(i){delete this._maskGeoJSON,console.error(i)}if(this.options.mask=e.toJSON(),!this.getMap()||this.getMap().isZooming())return this;var n=this._getRenderer();return n&&n.setToRedraw&&this._getRenderer().setToRedraw(),this},t.prototype.removeMask=function(){if(delete this._mask,delete this._maskGeoJSON,delete this.options.mask,!this.getMap()||this.getMap().isZooming())return this;var e=this._getRenderer();return e&&e.setToRedraw&&this._getRenderer().setToRedraw(),this},t.prototype.onLoad=function(){return!0},t.prototype.onLoadEnd=function(){},t.prototype.isLoaded=function(){return!!this._loaded},t.prototype.getCollisionIndex=function(){if(this.options.collisionScope==="layer")return this._collisionIndex||(this._collisionIndex=new Ph),this._collisionIndex;var e=this.getMap();return e?e.getCollisionIndex():null},t.prototype.clearCollisionIndex=function(){return this.options.collisionScope==="layer"&&this._collisionIndex&&this._collisionIndex.clear(),this},t.prototype.getRenderer=function(){return this._getRenderer()},t.prototype.onConfig=function(e){var n=e&&Object.keys&&Object.keys(e).length>0;if(n&&U(e.animation)){if(this._optionsHook&&ze(this._optionsHook)&&this._optionsHook(e),this._silentConfig)return;var i=this.getRenderer();i&&i.setToRedraw&&i.setToRedraw()}},t.prototype.onAdd=function(){},t.prototype.onRendererCreate=function(){},t.prototype.onCanvasCreate=function(){},t.prototype.onRemove=function(){},t.prototype._bindMap=function(e,n){e&&(this.map=e,U(n)||this.setZIndex(n),this._switchEvents("on",this),this.onAdd(),this.fire("add"))},t.prototype._initRenderer=function(){var e=this.options.renderer;if(this.constructor.getRendererClass){var n=this.constructor.getRendererClass(e);if(!n)throw new Error("Invalid renderer for Layer("+this.getId()+"):"+e);this._renderer=new n(this),this._renderer.layer=this,this._renderer.setZIndex(this.getZIndex()),this._switchEvents("on",this._renderer),this._renderer.onAdd&&this._renderer.onAdd(),this.onRendererCreate(),this.fire("renderercreate",{type:"renderercreate",target:this,renderer:this._renderer})}},t.prototype._doRemove=function(){this._loaded=!1,this._switchEvents("off",this),this.onRemove(),this._renderer&&(this._switchEvents("off",this._renderer),this._renderer.remove(),delete this._renderer),delete this.map,delete this._collisionIndex},t.prototype._switchEvents=function(e,n){n&&n.getEvents&&this.getMap()&&this.getMap()[e](n.getEvents(),n)},t.prototype._getRenderer=function(){return this._renderer},t.prototype._getLayerList=function(){if(!this.map)return[];var e=+!!this.map.getBaseLayer();return this.map.getLayers().slice(e)},t.prototype._getMask2DExtent=function(){if(!this._mask||!this.getMap())return null;var e=this._mask._getMaskPainter();return e?e.get2DExtent():null},t.prototype.toJSON=function(e){return{type:"Layer",id:this.getId(),options:e||this.config()}},t.fromJSON=function(e){if(!e)return null;var n=e.type,i=t.getJSONClass(n);if(!i||!i.fromJSON)throw new Error("unsupported layer type:"+n);return i.fromJSON(e)},t}(h_(to($g(hi))));Rr.mergeOptions(rk);var ik=Rr.prototype.fire;Rr.prototype.fire=function(r,t){return r==="layerload"&&(this._loaded=!0),this.map&&(t||(t={type:null,target:null}),t.type=r,t.target=this,this.map._onLayerEvent(t)),ik.apply(this,arguments),["show","hide"].indexOf(r)>-1&&this.fire("visiblechange",Object.assign({},t,{visible:this.options.visible})),this};var ok=new at(0,0),h2=new W(0,0),u2=["centerCross","fog","fogColor","debugSky"],sk={maxVisualPitch:70,maxPitch:80,centerCross:!1,zoomInCenter:!1,zoomOrigin:null,zoomAnimation:function(){return!Kn}(),zoomAnimationDuration:330,panAnimation:function(){return!Kn}(),panAnimationDuration:600,rotateAnimation:function(){return!Kn}(),zoomable:!0,enableInfoWindow:!0,hitDetect:function(){return!be.mobile}(),hitDetectLimit:5,fpsOnInteracting:25,layerCanvasLimitOnInteracting:-1,maxZoom:null,minZoom:null,maxExtent:null,limitExtentOnMaxExtent:!1,fixCenterOnResize:!0,checkSize:!0,checkSizeInterval:1e3,renderer:"canvas",cascadePitches:[10,60],renderable:!0,clickTimeThreshold:280,stopRenderOnOffscreen:!0,preventWheelScroll:!0,preventTouch:!0,supportPluginEvent:!0,switchDragButton:!1,mousemoveThrottleTime:sx,maxFPS:0,debug:!1,cameraFarUndergroundInMeter:2e3},xe=function(r){Et(t,r);function t(e,n){var i=this;if(!n)throw new Error("Invalid options when creating map.");if(!n.center)throw new Error("Invalid center when creating map.");var o=Gt({},n),s=o.zoom;delete o.zoom;var a=new at(o.center);delete o.center;var l=o.baseLayer;delete o.baseLayer;var h=o.layers;return delete o.layers,i=r.call(this,o)||this,i.VERSION=t.VERSION,Object.defineProperty(i,"id",{value:bo(),writable:!1}),i._loaded=!1,i._initContainer(e),i._panels={},i._baseLayer=null,i._layers=[],i._zoomLevel=s,i._center=a,i._centerZ=a.z,i.setSpatialReference(o.spatialReference||o.view),i._mapViewPoint=new W(0,0),i._initRenderer(),i._updateMapSize(i._getContainerDomSize()),l&&i.setBaseLayer(l),h&&i.addLayer(h),i.setMaxExtent(o.maxExtent),i._Load(),i.proxyOptions(),i.isMap=!0,i}return t.addOnLoadHook=function(e){for(var n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];var o=typeof e=="function"?e:function(){var s;(s=this[e]).call.apply(s,Ee([this],te(n),!1))};return this.prototype._onLoadHooks=this.prototype._onLoadHooks||[],this.prototype._onLoadHooks.push(o),this},t.prototype.isLoaded=function(){return!!this._loaded},t.prototype.getContainer=function(){return this._containerDOM},t.prototype.getSpatialReference=function(){return this._spatialReference},t.prototype.setSpatialReference=function(e){var n=this.options.spatialReference;return this._loaded&&eo.equals(n,e)?this:(this._updateSpatialReference(e,n),this)},t.prototype._updateSpatialReference=function(e,n){Se(e)&&(e=eo.getPreset(e)),e=Gt({},e),this._center=this.getCenter(),this.options.spatialReference=e,this._spatialReference=new eo(e);var i=this._spatialReference.getProjection();return this.options.spatialReference&&ze(this.options.spatialReference.projection)&&(this.options.spatialReference.projection=i.code),this._resetMapStatus(),Vc.is(i.code)&&(this._originLng=i.centralMeridian,this._altitudeOriginDirty=!0),this._fireEvent("spatialreferencechange",{old:n,new:Gt({},this.options.spatialReference)}),this},t.prototype.onConfig=function(e){var n=e.spatialReference||e.view;U(n)||this._updateSpatialReference(n,null);for(var i=!1,o=0,s=u2.length;o<s;o++){var a=u2[o];if(!U(e[a])){i=!0;break}}if(!i)return this;var l=this.getRenderer();return l&&l.setToRedraw(),this},t.prototype.getProjection=function(){return this._spatialReference?this._spatialReference.getProjection():null},t.prototype.getFullExtent=function(){return this._spatialReference?this._spatialReference.getFullExtent():null},t.prototype.setCursor=function(e){return delete this._cursor,this._trySetCursor(e),this._cursor=e,this},t.prototype.resetCursor=function(){return this.setCursor(null)},t.prototype.getCenter=function(){if(!this._loaded||!this._prjCenter)return this._center;var e=this.getProjection(),n=e.unproject(this._prjCenter);return n.x=Math.round(n.x*1e8)/1e8,n.y=Math.round(n.y*1e8)/1e8,n.z=this._centerZ,this.centerAltitude&&(n.z=this.centerAltitude),n},t.prototype.setCenter=function(e,n){if(!e)return this;e=new at(e),n&&(e=this._getCenterByPadding(e,this.getZoom(),n));var i=this.getProjection(),o=i.project(e);return!this._verifyExtent(o)&&!this.options.limitExtentOnMaxExtent?this:this._loaded?(this._centerZ=e.z,this.onMoveStart(),this._setPrjCenter(o),this.onMoveEnd(this._parseEventFromCoord(this.getCenter())),this):(this._center=e,this)},t.prototype.getSize=function(){return U(this.width)||U(this.height)?this._getContainerDomSize():new kn(this.width,this.height)},t.prototype.getContainerExtent=function(){var e=this.height,n=this.getPitch(),i=this.options.maxVisualPitch;return i&&n>i&&(e=this._getVisualHeight(i)),new Ce(0,this.height-e,this.width,this.height)},t.prototype._getVisualHeight=function(e){e=e||.01;var n=(90-this.getPitch())*Math.PI/180,i=this.getFov()*Math.PI/180;e*=Math.PI/180;var o=this.cameraCenterDistance/this.getGLScale(),s=Math.tan(i/2),a=Math.tan(e),l=o*s/(1/a-s)/Math.sin(e),h=o*(Math.sin(n)*l/(o+Math.cos(n)*l));return this.height/2+h},t.prototype.getExtent=function(){return this.pointToExtent(this.get2DExtent())},t.prototype.getProjExtent=function(){var e=this.get2DExtent();return new gn(this._pointToPrj(e.getMin()),this._pointToPrj(e.getMax()))},t.prototype.getPrjExtent=function(){return this.getProjExtent()},t.prototype.getMaxExtent=function(){return this.options.maxExtent?new gn(this.options.maxExtent,this.getProjection()):null},t.prototype.setMaxExtent=function(e){if(e){var n=new gn(e,this.getProjection());this.options.maxExtent=n;var i=this.getProjection();this._prjMaxExtent=n.convertTo(function(o){return i.project(o)}),this._verifyExtent(this._getPrjCenter())||(this._loaded?this._panTo(this._prjMaxExtent.getCenter()):this._center=i.unproject(this._prjMaxExtent.getCenter()))}else delete this.options.maxExtent,delete this._prjMaxExtent;return this},t.prototype.getZoom=function(){return this._zoomLevel},t.prototype.getZoomForScale=function(e,n,i){var o=this.getZoom();if(U(n)&&(n=o),e===1&&n===o)return o;var s=this._getResolution(n),a=s/e,l=this.getZoomFromRes(a);if(i)return l;var h=1e-6;return this.getSpatialReference().getZoomDirection()<0?Math.ceil(l-h):Math.floor(l+h)},t.prototype.getZoomFromRes=function(e){var n=this._getResolutions(),i=this._getResolution(this.getMinZoom()),o=this._getResolution(this.getMaxZoom());if(i<=o){if(e<=i)return this.getMinZoom();if(e>=o)return this.getMaxZoom()}else{if(e>=i)return this.getMinZoom();if(e<=o)return this.getMaxZoom()}for(var s=n.length,a=0;a<s-1;a++)if(n[a]){var l=n[a+1]-n[a],h=e-n[a];if(Br(l)===Br(h)&&Math.abs(l)>=Math.abs(h))return a+h/l}return s-1},t.prototype.setZoom=function(e,n){return n===void 0&&(n={animation:!0}),isNaN(e)||U(e)?this:(e=+e,this._loaded&&this.options.zoomAnimation&&n.animation?this._zoomAnimation(e):this._zoom(e),this)},t.prototype.getMaxZoom=function(){return U(this.options.maxZoom)?this.getMaxNativeZoom():this.options.maxZoom},t.prototype.setMaxZoom=function(e){var n=this.getMaxNativeZoom();return e>n&&(e=n),e!==null&&e<this._zoomLevel&&(this.setZoom(e),e=+e),this.options.maxZoom=e,this},t.prototype.getMinZoom=function(){return U(this.options.minZoom)?this._spatialReference.getMinZoom():this.options.minZoom},t.prototype.setMinZoom=function(e){if(e!==null){e=+e;var n=this._spatialReference.getMinZoom();e<n&&(e=n),e>this._zoomLevel&&this.setZoom(e)}return this.options.minZoom=e,this},t.prototype.getMaxNativeZoom=function(){var e=this.getSpatialReference();return e?e.getMaxZoom():null},t.prototype.getGLRes=function(){if(this._glRes)return this._glRes;var e=this.getSpatialReference().getFullExtent();return this._glRes=(e.right-e.left)/Math.pow(2,19),this._glRes},t.prototype.getGLScale=function(e){return U(e)&&(e=this.getZoom()),this._getResolution(e)/this.getGLRes()},t.prototype.zoomIn=function(){return this.setZoom(this.getZoom()+1)},t.prototype.zoomOut=function(){return this.setZoom(this.getZoom()-1)},t.prototype.isZooming=function(){return!!this._zooming},t.prototype.isInteracting=function(){return this.isZooming()||this.isMoving()||this.isRotating()},t.prototype.setCenterAndZoom=function(e,n){return!U(n)&&this._zoomLevel!==n?(this.setCenter(e),this.setZoom(n,{animation:!1})):this.setCenter(e),this},t.prototype._getPaddingSize=function(e){return e===void 0&&(e={}),e.paddingLeft||e.paddingTop||e.paddingRight||e.paddingBottom?{width:(e.paddingLeft||0)+(e.paddingRight||0),height:(e.paddingTop||0)+(e.paddingBottom||0)}:null},t.prototype.getFitZoom=function(e,n,i){var o=this;if(!e||!(e instanceof gn))return this._zoomLevel;if(e.xmin===e.xmax&&e.ymin===e.ymax)return this.getMaxZoom();var s=this.getSize(),a=this._getPaddingSize(i);if(a){var l={width:s.width-(a.width||0),height:s.height-(a.height||0)};s=new kn(l.width,l.height)}var h=e.convertTo(function(m){return o.coordToPoint(m)}),u=h.getWidth(),c=h.getHeight(),f=s.width/u,d=s.height/c,p=this.getSpatialReference().getZoomDirection()<0?Math.max(f,d):Math.min(f,d),g=this.getZoomForScale(p,null,n);return g},t.prototype.getView=function(){return{center:this.getCenter().toArray(),zoom:this.getZoom(),pitch:this.getPitch(),bearing:this.getBearing()}},t.prototype._validateView=function(e){if(!(!e||!kr(e))){It(e.bearing)&&(e.bearing=Math.max(-180,e.bearing),e.bearing=Math.min(180,e.bearing)),It(e.pitch)&&(e.pitch=Math.max(0,e.pitch),e.pitch=Math.min(this.options.maxPitch,e.pitch));var n=this.getMaxZoom();It(e.zoom)&&(e.zoom=Math.max(0,e.zoom),e.zoom=Math.min(n,e.zoom))}},t.prototype.setView=function(e){return e?(this._validateView(e),e.center&&this.setCenter(e.center),e.zoom!==null&&!isNaN(+e.zoom)&&this.setZoom(+e.zoom,{animation:!1}),e.pitch!==null&&!isNaN(+e.pitch)&&this.setPitch(+e.pitch),e.bearing!==null&&!isNaN(+e.bearing)&&this.setBearing(+e.bearing),this):this},t.prototype.getResolution=function(e){return this._getResolution(e)},t.prototype.getScale=function(e){var n=U(e)?this.getZoom():e,i=this._getResolution(this.getMaxNativeZoom()),o=this._getResolution(n);return o/i},t.prototype._getCenterByPadding=function(e,n,i){var o=this.coordinateToPoint(e,n),s=i||{},a=s.paddingLeft,l=a===void 0?0:a,h=s.paddingRight,u=h===void 0?0:h,c=s.paddingTop,f=c===void 0?0:c,d=s.paddingBottom,p=d===void 0?0:d,g=0,m=0;(l||u)&&(g=(u-l)/2),(f||p)&&(m=(f-p)/2);var y=new W({x:o.x+g,y:o.y+m});return this.pointToCoordinate(y,n)},t.prototype.fitExtent=function(e,n,i,o){if(i=i||{},!e)return this;e=new gn(e,this.getProjection());var s=this.getFitZoom(e,i.isFraction||!1,i)+(n||0),a=e.getCenter();return this._getPaddingSize(i)&&(a=this._getCenterByPadding(a,s,i)),typeof i.animation>"u"||i.animation?this._animateTo({center:a,zoom:s},{duration:i.duration||this.options.zoomAnimationDuration,easing:i.easing||"out"},o):this.setCenterAndZoom(a,s)},t.prototype.getBaseLayer=function(){return this._baseLayer},t.prototype.setBaseLayer=function(e){var n=!1;if(this._baseLayer&&(n=!0,this._fireEvent("baselayerchangestart"),this._baseLayer.remove()),!e)return delete this._baseLayer,this._fireEvent("baselayerchangeend"),this._fireEvent("setbaselayer"),this;this._baseLayer=e,e._bindMap(this,-1);function i(){this._fireEvent("baselayerload"),n&&(n=!1,this._fireEvent("baselayerchangeend"))}return this._baseLayer.on("layerload",i,this),this._loaded&&this._baseLayer.load(),this._fireEvent("setbaselayer"),this},t.prototype.removeBaseLayer=function(){return this._baseLayer&&(this._baseLayer.remove(),delete this._baseLayer,this._fireEvent("baselayerremove")),this},t.prototype.getLayers=function(e){return this._getLayers(function(n){return n===this._baseLayer||n.getId().indexOf(dh)>=0?!1:e?e(n):!0})},t.prototype.getLayer=function(e){if(!e)return null;var n=this._layerCache?this._layerCache[e]:null;if(n)return n;var i=this.getBaseLayer();return i&&i.getId()===e?i:null},t.prototype.addLayer=function(e){for(var n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];if(!e)return this;Array.isArray(e)||(e=[e]),n&&n.length&&(e=e.concat(n)),this._layerCache||(this._layerCache={});for(var o=this._layers,s=0,a=e.length;s<a;s++){var l=e[s],h=l.getId();if(U(h))throw new Error("Invalid id for the layer: "+h);if(l.getMap()!==this){if(this._layerCache[h])throw new Error("Duplicate layer id in the map: "+h);this._layerCache[h]=l,l._bindMap(this),o.push(l),this._loaded&&l.load()}}return this._sortLayersByZIndex(),this._fireEvent("addlayer",{layers:e}),this},t.prototype.removeLayer=function(e){if(!e)return this;if(!Array.isArray(e))return this.removeLayer([e]);for(var n=[],i=0,o=e.length;i<o;i++){var s=e[i];if(s instanceof Rr||(s=this.getLayer(s)),!!s){var a=s.getMap();if(!(!a||a!==this)){n.push(s),this._removeLayer(s,this._layers),this._loaded&&s._doRemove();var l=s.getId();this._layerCache&&delete this._layerCache[l]}}}if(n.length>0){var h=this.getRenderer();h&&h.setLayerCanvasUpdated(),this.once("frameend",function(){n.forEach(function(u){u.fire("remove")})})}return this._fireEvent("removelayer",{layers:e}),this},t.prototype.sortLayers=function(e){if(!e||!Array.isArray(e))return this;for(var n=[],i=Number.MAX_VALUE,o=0,s=e.length;o<s;o++){var a=e[o];if(Se(e[o])&&(a=this.getLayer(a)),!(a instanceof Rr)||!a.getMap()||a.getMap()!==this)throw new Error("It must be a layer added to this map to order.");a.getZIndex()<i&&(i=a.getZIndex()),n.push(a)}for(var o=0,s=n.length;o<s;o++)n[o].setZIndex(i+o);return this},t.prototype.toDataURL=function(e){e||(e={});var n=e.mimeType;n||(n="image/png");var i=e.save,o=this._getRenderer();if(o&&o.toDataURL){var s=e.fileName;s||(s="export");var a=o.toDataURL(n,e.quality||.92);if(i&&a){var l=void 0;if(typeof Blob<"u"&&typeof atob<"u"){var h=U1(a.replace(/^data:image\/(png|jpeg|jpg|webp);base64,/,""),n);l=URL.createObjectURL(h)}else l=a;var u=document.createElement("a");u.download=s,u.href=l,document.body.appendChild(u),u.click(),document.body.removeChild(u)}return a}return null},t.prototype.coordToPoint=function(e,n,i){return this.coordinateToPoint(e,n,i)},t.prototype.coordToPointAtRes=function(e,n,i){return this.coordinateToPointAtRes(e,n,i)},t.prototype.pointToCoord=function(e,n,i){return this.pointToCoordinate(e,n,i)},t.prototype.pointAtResToCoord=function(e,n,i){return this.pointAtResToCoordinate(e,n,i)},t.prototype.coordToViewPoint=function(e,n,i){return this.coordinateToViewPoint(e,n,i)},t.prototype.viewPointToCoord=function(e,n){return this.viewPointToCoordinate(e,n)},t.prototype.coordToContainerPoint=function(e,n,i){return this.coordinateToContainerPoint(e,n,i)},t.prototype.containerPointToCoord=function(e,n){return this.containerPointToCoordinate(e,n)},t.prototype.containerPointToViewPoint=function(e,n){return n?n.set(e.x,e.y):n=e.copy(),n._sub(this.getViewPoint())},t.prototype.viewPointToContainerPoint=function(e,n){return n?n.set(e.x,e.y):n=e.copy(),n._add(this.getViewPoint())},t.prototype.checkSize=function(e){var n=Qe()-this._initTime<1500&&this.width===0||this.height===0,i=this._getContainerDomSize(),o=this.height,s=this.width;if(!e&&i.width===s&&i.height===o)return this;Ac(this._containerDOM);var a=this.getCenter();if(this.options.fixCenterOnResize)this._updateMapSize(i);else{var l=this._getVisualHeight(this.getPitch()),h=new W(0,this.height-l),u=this._containerPointToPrj(h);this._updateMapSize(i);var c=this._getVisualHeight(this.getPitch()),f=new W(0,this.height-c);this._setPrjCoordAtContainerPoint(u,f),this._mapViewCoord=this._getPrjCenter()}var d=i.width===0||i.height===0||s===0||o===0;return(n||d)&&(this._eventSilence=!0,this.setCenter(a),delete this._eventSilence),this._fireEvent("resize"),this},t.prototype.locate=function(e,n,i){return this.getProjection()._locate(new at(e),n,i)},t.prototype.getMainPanel=function(){var e=this._getRenderer();return e?e.getMainPanel():null},t.prototype.getPanels=function(){return this._panels},t.prototype.remove=function(){var e=this;if(this.isRemoved())return this;this._fireEvent("removestart"),this._removeDomEvents(),this._clearHandlers(),this.removeBaseLayer();for(var n=this.getLayers(),i=0;i<n.length;i++)n[i].remove();return this._getRenderer()&&this._getRenderer().remove(),this._containerDOM.childNodes&&this._containerDOM.childNodes.length>0&&Array.prototype.slice.call(this._containerDOM.childNodes,0).filter(function(o){return o.className==="maptalks-wrapper"}).forEach(function(o){return e._containerDOM.removeChild(o)}),delete this._panels,delete this._containerDOM,delete this._renderer,this._fireEvent("removeend"),this._clearAllListeners(),this},t.prototype.isRemoved=function(){return!this._containerDOM},t.prototype.isMoving=function(){return!!this._moving},t.prototype.onMoveStart=function(e){this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer);var n=this._getPrjCenter();(!this._originCenter||this._verifyExtent(n))&&(this._originCenter=n),this._moving=!0,this._trySetCursor("move"),this._fireEvent("movestart",this._parseEvent(e?e.domEvent:null,"movestart"))},t.prototype.onMoving=function(e){this._fireEvent("moving",this._parseEvent(e?e.domEvent:null,"moving")),this._limitMaxExtent()},t.prototype.onMoveEnd=function(e){if(this._moving=!1,this._suppressRecenter||this._recenterOnTerrain(),this._trySetCursor("default"),this._fireEvent("moveend",e&&e.domEvent?this._parseEvent(e.domEvent,"moveend"):e),!this._verifyExtent(this._getPrjCenter())&&this._originCenter&&!this.options.limitExtentOnMaxExtent){var n=this._originCenter;this._panTo(n)}this._limitMaxExtent()},t.prototype.onDragRotateStart=function(e){this._dragRotating=!0,this._fireEvent("dragrotatestart",this._parseEvent(e?e.domEvent:null,"dragrotatestart"))},t.prototype.onDragRotating=function(e){this._fireEvent("dragrotating",this._parseEvent(e?e.domEvent:null,"dragrotating"))},t.prototype.onDragRotateEnd=function(e){this._dragRotating=!1,this._fireEvent("dragrotateend",this._parseEvent(e?e.domEvent:null,"dragrotateend"))},t.prototype.isDragRotating=function(){return!!this._dragRotating},t.prototype.isOffscreen=function(e,n){var i;n===void 0&&(n=0);var o=this,s=o.width,a=o.height,l=s+n,h=a+n,u=e,c=u.xmin,f=u.ymin,d=u.xmax,p=u.ymax;return Array.isArray(e)&&(i=te(e,4),c=i[0],f=i[1],d=i[2],p=i[3]),d<n||c>=l||p<n||f>h},t.prototype.getRenderer=function(){return this._getRenderer()},t.prototype.getDevicePixelRatio=function(){return this.options.devicePixelRatio||be.devicePixelRatio||1},t.prototype.setDevicePixelRatio=function(e){return It(e)&&e>0&&e!==this.options.devicePixelRatio&&(this.options.devicePixelRatio=e,this.checkSize(!0)),this},t.prototype._initContainer=function(e){if(Se(e)){if(this._containerDOM=document.getElementById(e),!this._containerDOM)throw new Error("Invalid container when creating map: '"+e+"'")}else this._containerDOM=e,Kn&&(this.CanvasClass=this._containerDOM.constructor);if(this._containerDOM.childNodes&&this._containerDOM.childNodes.length>0&&this._containerDOM.childNodes[0].className==="maptalks-wrapper")throw new Error("Container is already loaded with another map instance, use map.remove() to clear it.")},t.prototype._trySetCursor=function(e){return!this._cursor&&!this._priorityCursor&&(e||(e="default"),this._setCursorToPanel(e)),this},t.prototype._setPriorityCursor=function(e){if(e)this._priorityCursor=e,this._setCursorToPanel(e);else{var n=!1;this._priorityCursor&&(n=!0),delete this._priorityCursor,n&&this.setCursor(this._cursor)}return this},t.prototype._setCursorToPanel=function(e){var n=this.getMainPanel();n&&n.style&&n.style.cursor!==e&&(n.style.cursor=e)},t.prototype._removeLayer=function(e,n){if(!(!e||!n)){var i=n.indexOf(e);i>-1&&n.splice(i,1)}},t.prototype._sortLayersByZIndex=function(){if(this._layers){for(var e=0,n=this._layers.length;e<n;e++){var i=this._layers[e];i._order=e,i.sortLayersByZIndex&&i.sortLayersByZIndex()}this._layers.sort(function(o,s){var a=o.getZIndex()-s.getZIndex();return a===0?o._order-s._order:a})}},t.prototype._fireEvent=function(e,n){if(!this._eventSilence){var i="_";e[0]!==i&&this.fire(i+e,n),this.fire(e,n)}},t.prototype._Load=function(){this._resetMapStatus(),this.options.pitch&&(this.setPitch(this.options.pitch),delete this.options.pitch),this.options.bearing&&(this.setBearing(this.options.bearing),delete this.options.bearing),delete this._glRes,this._loadAllLayers(),this._getRenderer().onLoad(),this._loaded=!0,this._callOnLoadHooks(),this._initTime=Qe()},t.prototype._initRenderer=function(){var e=this.options.renderer,n=t.getRendererClass(e);this._renderer=new n(this),this._renderer.load()},t.prototype._getRenderer=function(){return this._renderer},t.prototype._loadAllLayers=function(){function e(n){n&&n.load()}this._baseLayer&&this._baseLayer.load(),this._eachLayer(e,this.getLayers())},t.prototype._getLayers=function(e){for(var n=this._baseLayer?[this._baseLayer].concat(this._layers):this._layers,i=[],o=0;o<n.length;o++)(!e||e.call(this,n[o]))&&i.push(n[o]);return i},t.prototype._eachLayer=function(e){for(var n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];if(!(arguments.length<2)){n&&!Array.isArray(n)&&(n=[n]);for(var o=[],s=0,a=n.length;s<a;s++)o=o.concat(n[s]);for(var l=0,h=o.length;l<h;l++)e.call(e,o[l])}},t.prototype._onLayerEvent=function(e){e&&e.type==="idchange"&&(delete this._layerCache[e.old],this._layerCache[e.new]=e.target)},t.prototype._resetMapStatus=function(){var e=this.getMaxZoom(),n=this.getMinZoom(),i=this._spatialReference.getMaxZoom(),o=this._spatialReference.getMinZoom();(U(e)||e===-1||e>i)&&this.setMaxZoom(i),(U(n)||n===-1||n<o)&&this.setMinZoom(o),e=this.getMaxZoom(),n=this.getMinZoom(),e<n&&this.setMaxZoom(n),(U(this._zoomLevel)||this._zoomLevel>e)&&(this._zoomLevel=e),this._zoomLevel<n&&(this._zoomLevel=n),delete this._prjCenter,delete this._glRes;var s=this.getProjection();this._prjCenter=s.project(this._center),this._prjCenter.z=this._center.z,this._calcMatrices();var a=this._getRenderer();a&&a.resetContainer()},t.prototype.setContainerDomRect=function(e){this._containerDomContentRect=e},t.prototype._getContainerDomSize=function(){if(!this._containerDOM)return null;var e=this._containerDOM,n,i;if(this._containerDomContentRect)return n=this._containerDomContentRect.width,i=this._containerDomContentRect.height,new kn(n,i);var o=e;if(!U(o.width)&&!U(o.height)){n=o.width,i=o.height;var s=this.getDevicePixelRatio();s!==1&&e.layer&&(n/=s,i/=s)}else if(!U(e.clientWidth)&&!U(e.clientHeight))n=parseInt(e.clientWidth+"",0),i=parseInt(e.clientHeight+"",0);else throw new Error("can not get size of container");return new kn(n,i)},t.prototype._updateMapSize=function(e){return this.width=e.width,this.height=e.height,this._getRenderer().updateMapSize(e),this._calcMatrices(),this},t.prototype._getPrjCenter=function(){return this._prjCenter},t.prototype._setPrjCenter=function(e){this._prjCenter=e,this.isInteracting()&&!this.isMoving()&&(this._mapViewCoord=e),this._calcMatrices()},t.prototype._setPrjCoordAtContainerPoint=function(e,n){if(!this.centerAltitude&&n.x===this.width/2&&n.y===this.height/2)return this;var i=this._containerPointToPoint(n),o=i._sub(this._prjToPoint(this._getPrjCenter())),s=this._pointToPrj(this._prjToPoint(e)._sub(o));return this._setPrjCenter(s),this},t.prototype._setPrjCoordAtOffsetToCenter=function(e,n){var i=this._pointToPrj(this._prjToPoint(e)._sub(n));return this._setPrjCenter(i),this},t.prototype._verifyExtent=function(e){if(!e)return!1;var n=this._prjMaxExtent;return n?n.contains(e):!0},t.prototype._limitMaxExtent=function(){var e=this;if(this._limitMaxExtenting||!this.options.limitExtentOnMaxExtent)return this;var n=this._prjMaxExtent,i=this.getMaxExtent();if(!n||!i)return this;var o=n.toArray(),s=o.map(function(M){return e.prjToContainerPoint(M)}),a=qo();_h(s,a);var l=this.getSize(),h=l.width,u=l.height,c=[0,0,h,u];if(Nx(c,a))return this;if(Nx(a,c))return this;var f=0,d=0,p=0,g=0,m=0,y=0,x=Math.abs,v=te(a,4),_=v[0],w=v[1],b=v[2],A=v[3];if(_>0&&b>h&&(f=p=x(_)),_<0&&b<h&&(f=p=-x(_)),_<0&&b<h&&(f=g=-x(h-b)),_>0&&b>h&&(f=g=x(h-b)),w>0&&A>u&&(d=m=x(w)),w<0&&A<u&&(d=m=-x(w)),w<0&&A<u&&(d=y=-x(u-A)),w>0&&A>u&&(d=y=x(u-A)),p!==0&&g!==0&&(f=p,x(g)<x(p)&&(f=g)),m!==0&&y!==0&&(d=m,x(y)<x(m)&&(d=y)),f!==0||d!==0){var T=new W(h/2+f,u/2+d),S=this.containerPointToCoord(T);this._limitMaxExtenting=!0,this.setCenter(S),this._limitMaxExtenting=!1}return this},t.prototype._offsetCenterByPixel=function(e){var n=h2.set(this.width/2-e.x,this.height/2-e.y),i=this._containerPointToPrj(n,ok),o=h2.set(this.width/2,this.height/2);this._setPrjCoordAtContainerPoint(i,o)},t.prototype.offsetPlatform=function(e){return e?(this._getRenderer().offsetPlatform(e),this._mapViewCoord=this._getPrjCenter(),this._mapViewPoint=this._mapViewPoint.add(e),this._mapViewPoint):this._mapViewPoint},t.prototype.getViewPoint=function(){var e=this.getViewPointFrameOffset(),n=this.offsetPlatform();return e&&(n=n.add(e)),n},t.prototype._resetMapViewPoint=function(){this._mapViewPoint=new W(0,0),this._mapViewCoord=this._getPrjCenter()},t.prototype._getResolution=function(e){return(e===void 0||e===this._zoomLevel)&&this._mapRes!==void 0?this._mapRes:(U(e)&&(e=this._zoomLevel),this._spatialReference.getResolution(e))},t.prototype._getResolutions=function(){return this._spatialReference.getResolutions()},t.prototype._prjToPoint=function(e,n,i){n=U(n)?this.getZoom():n;var o=this._getResolution(n);return this._prjToPointAtRes(e,o,i)},t.prototype._prjToPointAtRes=function(e,n,i){return this._spatialReference.getTransformation().transform(e,n,i)},t.prototype._prjsToPointsAtRes=function(e,n,i){i===void 0&&(i=[]);for(var o=this._spatialReference.getTransformation(),s=[],a=0,l=e.length;a<l;a++){var h=o.transform(e[a],n,i[a]);s.push(h)}return s},t.prototype._pointToPrj=function(e,n,i){n=U(n)?this.getZoom():n;var o=this._getResolution(n);return this._pointToPrjAtRes(e,o,i)},t.prototype._pointToPrjAtRes=function(e,n,i){return this._spatialReference.getTransformation().untransform(e,n,i)},t.prototype._pointToPoint=function(e,n,i){return U(n)?(i?(i.x=e.x,i.y=e.y):i=e.copy(),i):this._pointAtResToPoint(e,this._getResolution(n),i)},t.prototype._pointAtResToPoint=function(e,n,i){return i?(i.x=e.x,i.y=e.y):i=e.copy(),i._multi(n/this._getResolution())},t.prototype._pointToPointAtRes=function(e,n,i){return i?(i.x=e.x,i.y=e.y):i=e.copy(),i._multi(this._getResolution()/n)},t.prototype._containerPointToPrj=function(e,n){return this._pointToPrj(this._containerPointToPoint(e,void 0,n),void 0,n)},t.prototype._callOnLoadHooks=function(){var e=t.prototype;if(e._onLoadHooks)for(var n=0,i=e._onLoadHooks.length;n<i;n++)e._onLoadHooks[n].call(this)},t.prototype._fixPrjOnWorldWide=function(e){var n=this.getProjection();if(n&&n.fullExtent&&e){var i=n.fullExtent||{},o=i.left,s=i.bottom,a=i.top,l=i.right;It(o)&&(e.x=Math.max(o,e.x)),It(l)&&(e.x=Math.min(l,e.x)),It(s)&&(e.y=Math.max(s,e.y)),It(a)&&(e.y=Math.min(a,e.y))}return this},t.prototype.toJSON=function(e){e||(e={});var n={jsonVersion:this.JSON_VERSION,version:this.VERSION,extent:this.getExtent().toJSON()};n.options=this.config(),n.options.center=this.getCenter(),n.options.zoom=this.getZoom(),n.options.bearing=this.getBearing(),n.options.pitch=this.getPitch();var i=this.getBaseLayer();(U(e.baseLayer)||e.baseLayer)&&i&&(n.baseLayer=i.toJSON(e.baseLayer));var o={};e.clipExtent&&(e.clipExtent===!0?o.clipExtent=this.getExtent():o.clipExtent=e.clipExtent);var s=[];if(U(e.layers)||e.layers&&!Array.isArray(e.layers)){for(var a=this.getLayers(),l=0,h=a.length;l<h;l++)if(a[l].toJSON){var u=Gt({},kr(e.layers)?e.layers:{},o);s.push(a[l].toJSON(u))}n.layers=s}else if(on(e.layers)){for(var a=e.layers,l=0;l<a.length;l++){var c=a[l],f=this.getLayer(c.id);if(f.toJSON){var u=Gt({},c.options,o);s.push(f.toJSON(u))}}n.layers=s}else n.layers=[];return n},t.fromJSON=function(e,n,i){if(!e||!n)return null;i||(i={});var o=new t(e,n.options);if(U(i.baseLayer)||i.baseLayer){var s=Rr.fromJSON(n.baseLayer);s&&o.setBaseLayer(s)}if(U(i.layers)||i.layers){for(var a=[],l=n.layers,h=0;h<l.length;h++){var u=Rr.fromJSON(l[h]);a.push(u)}o.addLayer(a)}return o},t}(Dg(to($g(hi))));xe.mergeOptions(sk);var ak=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.addHooks=function(){this.target&&this.target.on("_dblclick",this._onDoubleClick,this)},t.prototype.removeHooks=function(){this.target&&this.target.off("_dblclick",this._onDoubleClick,this)},t.prototype._onDoubleClick=function(e){var n=this.target;if(n.options.doubleClickZoom){var i=n.getZoom(),o=e.domEvent.shiftKey?Math.ceil(i)-1:Math.floor(i)+1;n._zoomAnimation(o,e.containerPoint)}},t}(ji);xe.mergeOptions({doubleClickZoom:!0}),xe.addOnLoadHook("addHandler","doubleClickZoom",ak);var lk=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.addHooks=function(){var e=this.target;if(e){var n=e.getPanels().mapWrapper||e.getContainer();this._dragHandler=new Eh(n,{cancelOn:this._cancelOn.bind(this),rightclick:!0}),this._dragHandler.on("mousedown",this._onMouseDown,this).on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this).enable()}},t.prototype.removeHooks=function(){this._dragHandler.off("mousedown",this._onMouseDown,this).off("dragstart",this._onDragStart,this).off("dragging",this._onDragging,this).off("dragend",this._onDragEnd,this),this._dragHandler.remove(),delete this._dragHandler},t.prototype._cancelOn=function(e){return!!(this.target.isZooming()||this._ignore(e))},t.prototype._ignore=function(e){return e?(e.domEvent&&(e=e.domEvent),this.target._ignoreEvent(e)||this.target._isEventOutMap(e)):!1},t.prototype._onMouseDown=function(e){delete this.startDragTime,delete this._mode;var n=this.target.options.switchDragButton,i=n?0:2,o=e.domEvent.type==="touchstart",s=n&&o||e.domEvent.button===i||e.domEvent.ctrlKey;s?(this.target.options.dragRotate||this.target.options.dragPitch)&&(this._mode="rotatePitch"):this.target.options.dragPan&&(this._mode="move"),this.target._stopAnim(this.target._mapAnimPlayer),Qi(e.domEvent)},t.prototype._onDragStart=function(e){this.startDragTime=Qe(),this._mode==="move"?this._moveStart(e):this._mode==="rotatePitch"&&this._rotateStart(e)},t.prototype._onDragging=function(e){var n=this.target;n._isEventOutMap(e.domEvent)||(this._mode==="move"?this._moving(e):this._mode==="rotatePitch"&&this._rotating(e))},t.prototype._onDragEnd=function(e){this._mode==="move"?this._moveEnd(e):this._mode==="rotatePitch"&&this._rotateEnd(e),delete this.startDragTime,delete this.startBearing},t.prototype._start=function(e){this.preX=e.mousePos.x,this.preY=e.mousePos.y,this.startX=this.preX,this.startY=this.preY,this._startPrjCenter=this.target._getPrjCenter().copy()},t.prototype._moveStart=function(e){this._start(e);var n=this.target;n.onMoveStart(e);var i=li(n._getActualEvent(e.domEvent),n.getContainer());this.startPrjCoord=this._containerPointToPrj(i)},t.prototype._moving=function(e){if(this.startDragTime){var n=this.target,i=li(n._getActualEvent(e.domEvent),n.getContainer()),o=n._containerPointToPoint(i,void 0,void 0,this.startPrjCoord.z),s=n._prjToPoint(n._pointToPrj(o)),a=s._sub(n._prjToPoint(n._getPrjCenter()));n._setPrjCoordAtOffsetToCenter(this.startPrjCoord,a),n.onMoving(e)}},t.prototype._containerPointToPrj=function(e){var n=this.target,i=n._queryTerrainInfo(e);if(i){var o=n.getProjection().project(i.coordinate);return o.z=i.altitude,o}return n._containerPointToPrj(e)},t.prototype._moveEnd=function(e){if(this.startDragTime){var n=e.domEvent.type==="touchend",i=this.target,o=Qe()-this.startDragTime,s=e.mousePos.x,a=e.mousePos.y,l=s-this.startX,h=a-this.startY,u=i._getPrjCenter(),c=u.sub(this._startPrjCenter);if(this._clear(),i.options.panAnimation&&!e.interupted&&i._verifyExtent(i._getPrjCenter())&&o<280&&Math.abs(h)+Math.abs(l)>5){o=5*o;var f=n?5:2.8,d=u.add(c._multi(f));i._panTo(d,{duration:n?o*3:o*2,easing:"outExpo"})}else i.onMoveEnd(e)}},t.prototype._rotateStart=function(e){this._start(e),delete this._rotateMode,this.startBearing=this.target.getBearing(),this.target.onDragRotateStart(e),this._db=0},t.prototype._rotating=function(e){var n=this.target,i=e.mousePos.x,o=e.mousePos.y,s=n.getPitch(),a=n.getBearing(),l=Math.abs(i-this.preX),h=Math.abs(o-this.preY);if(this._rotateMode||(n.options.dragRotatePitch?this._rotateMode="rotate_pitch":l>h?this._rotateMode="rotate":l<h?this._rotateMode="pitch":this._rotateMode="rotate"),!(this._rotateMode==="pitch"&&s===0&&h<10)){if(this._rotateMode.indexOf("rotate")>=0&&n.options.dragRotate){var u=.15,c=0;n.options.dragPitch||l>h?c=-u*(this.preX-i):i>n.width/2?c=u*(this.preY-o):c=-u*(this.preY-o);var f=n.getBearing()+c;this._db=this._db||0,this._db+=c,n._setBearing(f)}this._rotateMode.indexOf("pitch")>=0&&n.options.dragPitch&&n._setPitch(n.getPitch()+(this.preY-o)*.15),this.preX=i,this.preY=o,(n.getBearing()!==a||n.getPitch()!==s)&&n.onDragRotating(e)}},t.prototype._rotateEnd=function(e){var n=this.target,i=n.getBearing();this._clear();var o=Qe()-this.startDragTime;if(n.onDragRotateEnd(e),n.options.rotateAnimation&&Math.abs(i-this.startBearing)>20&&(this._rotateMode==="rotate"||this._rotateMode==="rotate_pitch")&&!e.interupted&&o<400){var s=n.getBearing();n._animateTo({bearing:s+this._db/1.5},{easing:"outQuint",duration:1600})}},t.prototype._clear=function(){delete this.startPrjCoord,delete this.preX,delete this.preY,delete this.startX,delete this.startY},t}(ji);xe.mergeOptions({draggable:!0,dragPan:!0,dragRotatePitch:!0,dragRotate:!0,dragPitch:!0}),xe.addOnLoadHook("addHandler","draggable",lk);var c2="mousedown mouseup mousemove click dblclick contextmenu touchstart touchmove touchend mouseout",hk={mousemove:["mousemove","mouseover","mouseout","mouseenter"],touchend:["touchend","click"]},qc=function(r){return r&&r.getLayer&&r.on&&r.fire},f2=function(r){return r._getInternalId?r._getInternalId():r.getId?r.getId():null},La=function(r,t,e){if(r._onEvent)return r._onEvent(t,e);var n=r.getLayer();return n&&n.fireGeoEvent?n.fireGeoEvent(r,t,e):null},uk=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.addHooks=function(){var e=this.target,n=e.getPanels().allLayers||e.getContainer();Ln(n,c2,this._identifyGeometryEvents,this)},t.prototype.removeHooks=function(){var e=this.target,n=e.getPanels().allLayers||e.getContainer();Un(n,c2,this._identifyGeometryEvents)},t.prototype._identifyGeometryEvents=function(e,n){var i=this.target;if(i.isInteracting()||i._ignoreEvent(e))return;var o=null,s=n||e.type;if(Mc(s)&&!Li.isTest&&ax(this,i.options.mousemoveThrottleTime)){jr(e);return}var a=s==="mousedown"||s==="touchstart"&&e.touches&&e.touches.length===1;if(a)this._mouseDownTime=Qe();else if((s==="click"||s==="touchend")&&this._mouseDownTime){var l=this._mouseDownTime;delete this._mouseDownTime;var h=Qe();if(h-l>300){if(s==="click")return}else s==="touchend"&&(o="click")}var u=e.touches&&e.touches.length>0?e.touches[0]:e.changedTouches&&e.changedTouches.length>0?e.changedTouches[0]:e;if(!u)return;var c=li(u,i.getContainer());s==="touchstart"&&i.options.preventTouch&&Qi(e);for(var f=null,d=this.target.getRenderer().getTopElements(),p=a&&e.button!==2,g=0;g<d.length;g++)if(d[g].hitTest(c)){var m=d[g].options.cursor;if(m&&(f=m),p||d[g].events&&d[g].events.indexOf(s)>=0){var y={target:i,type:s,domEvent:e,containerPoint:c};if(p){i._setPriorityCursor(f),d[g].mousedown(y);return}else d[g].onEvent(y)}}var x=i._getLayers(function(A){return!!(A.identify&&A.options.geometryEvents)});if(!x.length)return;var v=hk[s]||[s],_={includeInternals:!0,filter:function(A){if(A instanceof en){var T=A._getEventTypeToFire(e);return s==="mousemove"?(!f&&A.options.cursor&&(f=A.options.cursor),!0):!(!A.listens(T)&&!A.listens(o))}else if(qc(A))return!0;return!1},count:1,onlyVisible:i.options.onlyVisibleGeometryEvents,containerPoint:c,layers:x,eventTypes:v,domEvent:e},w=b.bind(this);Mc(s)?this._queryIdentifyTimeout=i.getRenderer().callInNextFrame(function(){i.isInteracting()||i.identifyAtPoint(_,w)}):i.identifyAtPoint(_,w);function b(A){var T=this,S=!0,M=function(){var z=T._prevOverGeos&&T._prevOverGeos.geos;return z||[]},E=function(z,L){if(z===void 0&&(z=[]),L===void 0&&(L={}),z&&z.length>0)for(var $=z.length-1;$>=0;$--){var Z=z[$];if(qc(Z)){var j=f2(z[$]);L[j]||(S=La(Z,e,"mouseout"))}}};if(s==="mouseout"){var P=M();this._prevOverGeos={geos:[],geomap:{}},E(P,{})}else if(s==="mousemove"){var k={};if(A.length>0)for(var O=A.length-1;O>=0;O--){var I=A[O];if(qc(I)){var D=f2(I);k[D]=I,La(I,e),(!this._prevOverGeos||!this._prevOverGeos.geomap[D])&&La(I,e,"mouseenter"),S=La(I,e,"mouseover")}}i._setPriorityCursor(f);var P=M();this._prevOverGeos={geos:A,geomap:k},E(P,k)}else{if(!A||!A.length)return;for(var O=A.length-1;O>=0;O--)if(qc(A[O])){S=La(A[O],e),o&&La(A[O],e,o);break}}S===!1&&jr(e)}},t}(ji);xe.mergeOptions({geometryEvents:!0,onlyVisibleGeometryEvents:!0}),xe.addOnLoadHook("addHandler","geometryEvents",uk);/*!
 * Contains code from mapbox-gl-js
 * http://github.com/mapbox/mapbox-gl-js
 * License BSD-3-Clause
 */var d2=4.000244140625,ck=1/100,fk=1/450,dk=2,pk=function(r){Et(t,r);function t(e){var n=r.call(this,e)||this;return n._thisScrollZoom=n._scrollZoom.bind(n),n._thisCheckIfEndZoom=n._checkIfEndZoom.bind(n),n._wheelZoomRate=fk,n._defaultZoomRate=ck,n._delta=0,n}return t.prototype.addHooks=function(){Hi(this.target._containerDOM,"wheel",this._onWheelScroll,this)},t.prototype.removeHooks=function(){ks(this.target._containerDOM,"wheel",this._onWheelScroll)},t.prototype._onWheelScroll=function(e){var n=this.target;if(n.options.preventWheelScroll&&(Qi(e),jr(e)),n._ignoreEvent(e)||n._isEventOutMap(e)||!n.options.zoomable)return!1;var i=n.getContainer(),o=n._checkZoomOrigin(li(e,i));return n.options.seamlessZoom?(this._zooming||(this._trackPadSuspect=0,this._ensureTrackpad=!1),this._seamless(e,o)):this._interval(e,o)},t.prototype._seamless=function(e,n){var i=e.deltaMode===window.WheelEvent.DOM_DELTA_LINE?e.deltaY*60:e.deltaY;if(i%d2!==0&&(this._ensureTrackpad||(Math.abs(i)<60?this._trackPadSuspect++:this._trackPadSuspect=0,this._trackPadSuspect>=2&&(this._ensureTrackpad=!0)),this._ensureTrackpad&&(i*=14)),e.shiftKey&&i&&(i=i/4),this._lastWheelEvent=e,U(this._delta)&&(this._delta=0),this._delta-=i,!this._zooming&&this._delta){var o=this.target;this._zoomOrigin=n,o.onZoomStart(null,n)}this._start()},t.prototype._start=function(){if(this._delta){this._zooming=!0;var e=this.target;this._active||(e.getRenderer().callInNextFrame(this._thisScrollZoom),this._active=!0)}},t.prototype._scrollZoom=function(){if(this._active=!1,!!this._delta){var e=Math.abs(this._delta)>d2?this._wheelZoomRate:this._defaultZoomRate,n=dk/(1+Math.exp(-Math.abs(this._delta*e)));this._delta<0&&n!==0&&(n=1/n);var i=this.target,o=i.getZoom(),s=i.getZoomForScale(n,o,!0);this._delta=0,i.onZooming(s,this._zoomOrigin),this._scrollTime=performance.now(),i.getRenderer().callInNextFrame(this._thisCheckIfEndZoom)}},t.prototype._checkIfEndZoom=function(){if(this._zooming){var e=this.target,n=performance.now();n-this._scrollTime>210?(this._zooming=!1,e.onZoomEnd(e.getZoom(),this._zoomOrigin)):e.getRenderer().callInNextFrame(this._thisCheckIfEndZoom)}},t.prototype._interval=function(e,n){var i=this,o=this.target;if(this._zooming)return this._requesting++,!1;this._requesting=0;var s=(e.deltaY?e.deltaY*-1:e.wheelDelta?e.wheelDelta:e.detail)>0?1:-1;e.detail&&(s*=-1);var a=o.getZoom(),l=a+s;if(l=o._checkZoom(s>0?Math.ceil(l):Math.floor(l)),l===a)return!1;this._zooming=!0,this._delta||(o.onZoomStart(null,n),this._origin=n,this._delta=s,this._startZoom=o.getZoom());var h=90;return o._animateTo({zoom:l-this._delta*1/2,around:this._origin},{continueOnViewChanged:!0,easing:"linear",duration:h,wheelZoom:!0},function(u){if(u.state.playState!=="finished"){u.state.playState!=="running"&&(delete i._zooming,delete i._requesting);return}i._requesting<1||Math.abs(l-i._startZoom)>2||l===o.getMaxZoom()||l===o.getMinZoom()?(o._animateTo({zoom:l,around:i._origin},{continueOnViewChanged:!0,duration:100},function(c){c.state.playState!=="running"&&(delete i._zooming,delete i._requesting)}),delete i._startZoom,delete i._origin,delete i._delta,i._requesting=0):U(i._requesting)||(delete i._zooming,i._onWheelScroll(e))}),!1},t}(ji);xe.mergeOptions({scrollWheelZoom:!0,seamlessZoom:!0}),xe.addOnLoadHook("addHandler","scrollWheelZoom",pk);var gk=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.addHooks=function(){Hi(this.target.getContainer(),"touchstart",this._onTouchStart,this)},t.prototype.removeHooks=function(){ks(this.target.getContainer(),"touchstart",this._onTouchStart)},t.prototype._onTouchStart=function(e){var n=this.target;if(!(!e.touches||e.touches.length<2)){var i=n.getContainer(),o=li(e.touches[0],i),s=li(e.touches[1],i);this.preY=o.y,this._startP1=o,this._startP2=s,this._startDist=o.distanceTo(s),this._startVector=o.sub(s),this._startZoom=n.getZoom(),this._startBearing=n.getBearing(),Un(document,"touchmove",this._onTouchMove),Un(document,"touchend",this._onTouchEnd),Hi(document,"touchmove",this._onTouchMove,this),Hi(document,"touchend",this._onTouchEnd,this),n.options.preventTouch&&Qi(e),n._fireEvent("touchactstart")}},t.prototype._onTouchMove=function(e){var n=this.target;if(!(!e.touches||e.touches.length<2)){var i=n.getContainer(),o=li(e.touches[0],i),s=li(e.touches[1],i),a=o.sub(this._startP1),l=s.sub(this._startP2),h=o.sub(s),u=o.distanceTo(s)/this._startDist,c=h.angleWith(this._startVector)*180/Math.PI,f=this.preY||o.y,d=(f-o.y)*.4;this.preY=o.y;var p={domEvent:e,mousePos:[o,s]};if(this.mode||(n.options.touchRotate&&Math.abs(c)>8?this.mode=n.options.touchZoomRotate?"rotate_zoom":"rotate":n.options.touchPitch&&a.y*l.y>0&&Math.abs(a.y)>10&&Math.abs(l.y)>10?this.mode="pitch":n.options.zoomable&&n.options.touchZoom&&Math.abs(1-u)>.15&&(this.mode=n.options.touchZoomRotate&&n.options.touchRotate?"rotate_zoom":"zoom"),this._startTouching(p)),this.mode==="zoom"||this.mode==="rotate_zoom"){this._scale=u;var g=n._getResolution(this._startZoom)/u,m=n.getZoomFromRes(g);n.onZooming(m,this._Origin)}this.mode==="rotate"||this.mode==="rotate_zoom"?(n._setBearing(this._startBearing+c),n.onDragRotating(p)):this.mode==="pitch"&&(n._setPitch(n.getPitch()+d),n.onDragRotating(p)),n._fireEvent("touchactinging")}},t.prototype._startTouching=function(e){var n=this.target;if(this.mode==="zoom"||this.mode==="rotate_zoom"){var i=n.getSize();this._Origin=new W(i.width/2,i.height/2),n.onZoomStart(null,this._Origin)}(this.mode==="rotate"||this.mode==="pitch"||this.mode==="rotate_zoom")&&n.onDragRotateStart(e)},t.prototype._onTouchEnd=function(e){delete this.preY;var n=this.target;if(Un(document,"touchmove",this._onTouchMove),Un(document,"touchend",this._onTouchEnd),this.mode==="zoom"||this.mode==="rotate_zoom"){var i=this._scale,o=n._getResolution(this._startZoom)/i,s=n.getZoomFromRes(o);n.onZoomEnd(s,this._Origin)}(this.mode==="pitch"||this.mode==="rotate"||this.mode==="rotate_zoom")&&n.onDragRotateEnd({domEvent:e}),delete this.mode,n._fireEvent("touchactend")},t}(ji);xe.mergeOptions({touchGesture:!0,touchZoom:!0,touchPitch:!0,touchRotate:!0,touchZoomRotate:!1}),xe.addOnLoadHook("addHandler","touchGesture",gk);var Jc="__anim_player",za={outExpo:function(r){return r===1?1:1-Math.pow(2,-10*r)},outQuint:function(r){return 1-Math.pow(1-r,5)},in:function(r){return Math.pow(r,2)},out:function(r){return 1-za.in(1-r)},inAndOut:function(r){return 3*r*r-2*r*r*r},linear:function(r){return r},upAndDown:function(r){return r<.5?za.inAndOut(2*r):1-za.inAndOut(2*(r-.5))}},mk=function(){function r(t,e){this.state=t,this.styles=e}return Object.defineProperty(r.prototype,"playState",{get:function(){return this.state.playState},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"symbol",{get:function(){return this.styles.symbol},enumerable:!1,configurable:!0}),r}(),yk=function(){function r(t,e,n,i){this._animation=t,this.options=e,this._onFrame=n,this.playState="idle",this.ready=!0,this.finished=!1,this.target=i}return r.prototype._prepare=function(){var t=this.options,e=t.speed||t.duration;Se(e)&&(e=pr.speed[e],e||(e=+e)),e||(e=pr.speed.normal),this.duration=e,this._framer=t.framer||pr._requestAnimFrame.bind(pr)},r.prototype.play=function(){if(this.playState!=="idle"&&this.playState!=="paused"||this.target&&this.target[Jc])return this;this.target&&(this.target[Jc]=1),this.playState==="idle"&&(this.currentTime=0,this._prepare());var t=Qe();if(!this.startTime){var e=this.options;this.startTime=e.startTime?e.startTime:t}return this._playStartTime=Math.max(t,this.startTime),this.playState==="paused"&&(this._playStartTime-=this.currentTime),this.playState="running",this._run(),this},r.prototype.pause=function(){return this.playState==="paused"?this:(this.playState="paused",this._run(),this)},r.prototype.cancel=function(){return this.playState==="idle"?this:(this.playState="idle",this.finished=!1,this._run(),this)},r.prototype.finish=function(){return this.playState==="finished"?this:(this.playState="finished",this.finished=!0,this._run(),this)},r.prototype.reverse=function(){},r.prototype._run=function(){var t=this,e=this._onFrame,n=Qe(),i=n-this._playStartTime;if(this.options.repeat&&i>=this.duration&&(this._playStartTime=n,i=0),this.playState!=="running"){if(this.target&&delete this.target[Jc],e){this.playState==="finished"?i=this.duration:this.playState==="idle"&&(i=0);var o=this._animation(i,this.duration);o.state.playState=this.playState,e(o)}return}var s=this._animation(i,this.duration);this.playState=s.state.playState,this.playState!=="running"&&this.target&&delete this.target[Jc],this.playState==="idle"?this.startTime>n&&setTimeout(this._run.bind(this),this.startTime-n):this.playState==="running"?this._framer(function(){t.playState==="running"&&(t.currentTime=i,e&&e(s),t._run())}):this.playState==="finished"&&(this.finished=!0,e&&e(s))},r}(),pr={speed:{slow:2e3,normal:1e3,fast:500},_resolveStyles:function(r){if(!r)return null;function t(u){if(!Array.isArray(u))return pr._resolveStyles(u);for(var c=[],f=[],d=[],p=0;p<u.length;p++){var g=pr._resolveStyles(u[p]);g&&(c.push(g[0]),f.push(g[1]),d.push(g[2]))}return c.length?[c,f,d]:null}function e(u){var c=u,f;Array.isArray(u)||(It(u)?c=[0,u]:u instanceof W||u instanceof at?(f=u.constructor,c=[new f(0,0),u]):c=[u,u]);var d=c[0],p=c[1];return It(d)&&It(p)?d===p?null:[d,p-d,p]:Array.isArray(d)&&It(d[0])||d instanceof at||d instanceof W?(Array.isArray(d)?(d=new at(d),p=new at(p)):(f=d.constructor,d=new f(d),p=new f(p)),d.equals(p)?null:[d,p.sub(d),p]):[d,p,p]}function n(u){return!Array.isArray(u)&&u.constructor===Object?!0:!!(Array.isArray(u)&&u[0].constructor===Object)}var i={},o={},s={};for(var a in r)if(r.hasOwnProperty(a)){var l=r[a];if(l){if(Array.isArray(l)&&(U(l[0])||U(l[1])))continue}else continue;var h=void 0;n(l)?h=t(l):h=e(l),h&&(o[a]=h[0],i[a]=h[1],s[a]=h[2])}return[o,i,s]},framing:function(r,t){t||(t={});var e=t.easing?za[t.easing]:za.linear;e||(e=za.linear);var n,i,o;r=pr._resolveStyles(r),r&&(i=r[0],n=r[1],o=r[2]);var s=function(a,l,h){if(!l||!h)return null;var u={};for(var c in h)if(h.hasOwnProperty(c)){if(l[c]===o[c]){u[c]=l[c];continue}var f=l[c],d=h[c];if(It(d))u[c]=f+a*d;else if(Array.isArray(d)){for(var p=[],g=0;g<d.length;g++)p.push(s(a,f[g],d[g]));u[c]=p}else{var m=d.constructor;m===Object?u[c]=s(a,f,d):f instanceof W||f instanceof at?u[c]=f.add(d.multi(a)):u[c]=d}}return u};return function(a,l){var h,u;if(a<0)h={playState:"idle",delta:0},u=i;else if(a<l){var c=e(a/l);h={playState:"running",delta:c},u=s(c,i,n)}else h={playState:"finished",delta:1},u=o;return h.startStyles=i,h.destStyles=o,h.progress=a,h.remainingMs=l-a,new mk(h,u)}},_requestAnimFrame:function(r){this._frameQueue||(this._frameQueue=[]),this._frameQueue.push(r),this._a()},_a:function(){this._animationFrameId||(this._animationFrameId=_o(pr._frameFn))},_run:function(){if(this._frameQueue.length){var r=this._frameQueue;this._frameQueue=[];for(var t=0,e=r.length;t<e;t++)r[t]();this._frameQueue.length?this._animationFrameId=_o(pr._frameFn):delete this._animationFrameId}},animate:function(r,t,e,n){t||(t={});var i=pr.framing(r,t),o=new yk(i,t,e,n);return o},_frameFn:function(){}};pr._frameFn=pr._run.bind(pr),pr.animate;var p2={exports:{}};(function(r){(function(){function t(a,l){var h=a.x-l.x,u=a.y-l.y;return h*h+u*u}function e(a,l,h){var u=l.x,c=l.y,f=h.x-u,d=h.y-c;if(f!==0||d!==0){var p=((a.x-u)*f+(a.y-c)*d)/(f*f+d*d);p>1?(u=h.x,c=h.y):p>0&&(u+=f*p,c+=d*p)}return f=a.x-u,d=a.y-c,f*f+d*d}function n(a,l){for(var h=a[0],u=[h],c,f=1,d=a.length;f<d;f++)c=a[f],t(c,h)>l&&(u.push(c),h=c);return h!==c&&u.push(c),u}function i(a,l,h,u,c){for(var f=u,d,p=l+1;p<h;p++){var g=e(a[p],a[l],a[h]);g>f&&(d=p,f=g)}f>u&&(d-l>1&&i(a,l,d,u,c),c.push(a[d]),h-d>1&&i(a,d,h,u,c))}function o(a,l){var h=a.length-1,u=[a[0]];return i(a,0,h,l,u),u.push(a[h]),u}function s(a,l,h){if(a.length<=2)return a;var u=l!==void 0?l*l:1;return a=h?a:n(a,u),a=o(a,u),a}r.exports=s,r.exports.default=s})()})(p2);var vk=p2.exports,xk=pg(vk),g2="not find Geometry' Projection. please add Geometry to Layer and add Layer to Map",_k={smoothness:!1,enableClip:!0,enableSimplify:!0,simplifyTolerance:2,symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:1,opacity:1}},Kc=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.animateShow=function(e,n){var i=this;e===void 0&&(e={}),this._showPlayer&&this._showPlayer.finish(),ze(e)&&(e={},n=e);var o=this.getCoordinates();if(o.length!==0){this._animIdx=0,this._animLenSoFar=0,this.show();var s=!!this.getShell,a=s?this.getShell().concat(this.getShell()[0]):o,l=this._getProjection();if(!l){console.error(g2);return}var h=l.projectCoords(a,this.options.antiMeridian);this._prjAniShowCenter=this._getPrjExtent().getCenter(),this._aniShowCenter=l.unproject(this._prjAniShowCenter);var u=e.duration||1e3,c=e.easing||"out";this.setCoordinates([]);var f=0;h.length&&(h[0]._distance=0);for(var d=1;d<h.length;d++){var p=h[d].distanceTo(h[d-1]);h[d]._distance=p,f+=p}this._tempCoord=new at(0,0),this._tempPrjCoord=new W(0,0);var g=this._showPlayer=pr.animate({t:u},{duration:u,easing:c},function(m){if(!i.getMap()){if(g.playState!=="finished"&&(g.finish(),n)){var y=i.getCoordinates();n(m,y[y.length-1])}return}var x=i._drawAnimShowFrame(m.styles.t,u,f,a,h);m.state.playState==="finished"&&(delete i._showPlayer,delete i._aniShowCenter,delete i._prjAniShowCenter,delete i._animIdx,delete i._animLenSoFar,delete i._animTailRatio,delete i._tempCoord,delete i._tempPrjCoord,i.setCoordinates(o)),n&&n(m,x)},this);return g.play(),g}},t.prototype._drawAnimShowFrame=function(e,n,i,o,s){if(e===0)return o[0];var a=e/n*i,l=0,h,u;for(h=this._animIdx+1,u=s.length;h<u&&(l=s[h]._distance,!(this._animLenSoFar+l>a));h++)this._animLenSoFar+=l;if(this._animIdx=h-1,this._animIdx>=u-1)return this.setCoordinates(o),o[o.length-1];var c=this._animIdx,f=s[c],d=s[c+1],p=a-this._animLenSoFar,g=p/l;this._animTailRatio=g;var m=f.x+(d.x-f.x)*g,y=f.y+(d.y-f.y)*g;this._tempPrjCoord.x=m,this._tempPrjCoord.y=y;var x=this._tempPrjCoord,v=o[c],_=o[c+1],w=v.x+(_.x-v.x)*g,b=v.y+(_.y-v.y)*g;this._tempCoord.x=w,this._tempCoord.y=b;var A=this._tempCoord,T=!!this.getShell;if(!T&&this.options.smoothness>0){for(var S=[],M=[],E=0;E<=this._animIdx;E++)S.push(o[E]),M.push(s[E]);S.push(A,A),M.push(x,x),this.setCoordinates(S),this._setPrjCoordinates(M)}else{var S=o.slice(0,this._animIdx+1);S.push(A);var M=s.slice(0,this._animIdx+1);M.push(x),T?(this.setCoordinates([this._aniShowCenter].concat(S)),this._setPrjCoordinates([this._prjAniShowCenter].concat(M))):(this.setCoordinates(S),this._setPrjCoordinates(M))}return A},t.prototype._getCenterInExtent=function(e,n,i){var o=this.getExtent();if(!e.intersects(o))return null;var s=i(n,e);if(s.length===0)return null;var a=te([0,0,0],3),l=a[0],h=a[1],u=a[2];s.forEach(function(f){Array.isArray(f)?f.forEach(function(d){d.point&&(d=d.point),l+=d.x,h+=d.y,u++}):(f.point&&(f=f.point),l+=f.x,h+=f.y,u++)});var c=new at(l,h)._multi(1/u);return c.count=u,c},t.prototype._getPath2DPoints=function(e,n,i){if(!on(e))return[];var o=this.getMap(),s=!n&&this._shouldSimplify(),a=this.options.simplifyTolerance*o._getResolution(),l=Array.isArray(e[0]);if(delete this._simplified,s&&!l){var h=e.length;e=xk(e,a,!1),this._simplified=e.length<h}if(i||(i=o._getResolution()),Array.isArray(e)){var u=[],c="_glPt";if(!Array.isArray(e[0]))return u=ch(e,c),o._prjsToPointsAtRes(e,i,u);for(var f=[],d=0,p=e.length;d<p;d++){var g=e[d];u=ch(g,c);var m=o._prjsToPointsAtRes(g,i,u);f.push(m)}return f}else return o._prjToPointAtRes(e,i)},t.prototype._shouldSimplify=function(){var e=this.getLayer(),n=e.options.enableAltitude;return e&&e.options.enableSimplify&&!n&&this.options.enableSimplify&&!this._showPlayer},t.prototype._setPrjCoordinates=function(e){this._prjCoords=e,this.onShapeChanged()},t.prototype._getPrjCoordinates=function(){return this._verifyProjection(),!this._prjCoords&&this._getProjection()&&(this._prjCoords=this._projectCoords(this._coordinates)),this._prjCoords},t.prototype._updateCache=function(){this._clearCache();var e=this._getProjection();e&&this._prjCoords&&(this._coordinates=this._unprojectCoords(this._getPrjCoordinates()))},t.prototype._clearProjection=function(){this._prjCoords=null,r.prototype._clearProjection.call(this)},t.prototype._projectCoords=function(e){var n=this._getProjection();return n?n.projectCoords(e,this.options.antiMeridian):[]},t.prototype._unprojectCoords=function(e){var n=this._getProjection();return n?n.unprojectCoords(e):[]},t.prototype._computeCenter=function(){var e=this._coordinates;if(!on(e))return null;for(var n=0,i=0,o=0,s=e.length,a=0;a<s;a++)e[a]&&It(e[a].x)&&It(e[a].y)&&(n+=e[a].x,i+=e[a].y,o++);return new at(n/o,i/o)},t.prototype._computeExtent=function(e){var n,i=this._coordinates;if(!on(i))return null;var o=[i];return this.hasHoles&&this.hasHoles()&&(n=o.push).call.apply(n,Ee([o],te(this.getHoles()),!1)),this._coords2Extent(o,this._getProjection())},t.prototype._computePrjExtent=function(e){var n,i=[this._getPrjCoordinates()];return this.hasHoles&&this.hasHoles()&&(n=i.push).call.apply(n,Ee([i],te(this._getPrjHoles()),!1)),this._coords2Extent(i)},t.prototype._get2DLength=function(){for(var e=this._getPath2DPoints(this._getPrjCoordinates(),!0),n=0,i=1,o=e.length;i<o;i++)n+=e[i].distanceTo(e[i-1]);return n},t.prototype._hitTestTolerance=function(){var e=this._getInternalSymbol(),n;if(Array.isArray(e)){n=0;for(var i=0;i<e.length;i++)It(e[i].lineWidth)&&e[i].lineWidth>n&&(n=e[i].lineWidth)}else n=e.lineWidth;return r.prototype._hitTestTolerance.call(this)+(It(n)?n/2:1.5)},t.prototype._coords2Extent=function(e,n){if(!e||e.length===0||Array.isArray(e[0])&&e[0].length===0)return null;for(var i=new gn(n),o=0,s=e.length;o<s;o++)for(var a=0,l=e[o].length;a<l;a++)i._combine(e[o][a]);return i},t}(en);Kc.mergeOptions(_k);var m2="Polygon",_n=function(r){Et(t,r);function t(e,n){var i=r.call(this,n)||this;return i.type="Polygon",e&&i.setCoordinates(e),i}return t.prototype.getOutline=function(){var e=this._getPainter();if(!e)return null;var n=this.getExtent();return new t(n.toArray(),{symbol:{lineWidth:1,lineColor:"6b707b"}})},t.prototype.setCoordinates=function(e){if(!e)return this._coordinates=null,this._holes=null,this._projectRings(),this;var n=at.toCoordinates(e),i=n.length;if(!Array.isArray(n[0]))this._coordinates=this._trimRing(n);else if(this._coordinates=this._trimRing(n[0]),i>1){for(var o=[],s=1;s<i;s++)n[s]&&o.push(this._trimRing(n[s]));this._holes=o}else this._holes=null;return this._projectRings(),this},t.prototype.getCoordinates=function(){if(!this._coordinates)return[];for(var e=this.getHoles(),n=[this._copyAndCloseRing(this._coordinates)],i=0,o=e.length;i<o;i++)n.push(this._copyAndCloseRing(e[i]));return n},t.prototype.getCenterInExtent=function(e){return this._getCenterInExtent(e,this.getShell(),Xc)},t.prototype.getShell=function(){return this._coordinates||[]},t.prototype.getHoles=function(){return this._holes||[]},t.prototype.hasHoles=function(){return this.getHoles().length>0},t.prototype._projectRings=function(){if(!this.getMap()){this.onShapeChanged();return}this._prjCoords=this._projectCoords(this._coordinates),this._prjHoles=this._projectCoords(this._holes),this.onShapeChanged()},t.prototype._setPrjCoordinates=function(e){this._prjCoords=e,this.onShapeChanged()},t.prototype._cleanRing=function(e){for(var n=e.length-1;n>=0;n--)e[n]||e.splice(n,1)},t.prototype._checkRing=function(e){if(this._cleanRing(e),!e||!on(e))return!1;var n=e[e.length-1],i=!0;return(e[0].x!==n.x||e[0].y!==n.y)&&(i=!1),i},t.prototype._trimRing=function(e){var n=this._checkRing(e);return on(e)&&n&&e.splice(e.length-1,1),e},t.prototype._copyAndCloseRing=function(e){e=e.slice(0);var n=this._checkRing(e);return on(e)&&!n&&e.push(e[0].copy()),e},t.prototype._getPrjShell=function(){return this.getJSONType()===m2?this._getPrjCoordinates():(this._verifyProjection(),this._getProjection()&&!this._prjShell&&(this._prjShell=this._projectCoords(this._getShell?this._getShell():this.getShell())),this._prjShell)},t.prototype._getPrjHoles=function(){var e=this._getProjection();return this._verifyProjection(),e&&!this._prjHoles&&(this._prjHoles=this._projectCoords(this.getHoles())),this._prjHoles},t.prototype._computeGeodesicLength=function(e){var n=this.getCoordinates();if(!on(n))return 0;for(var i=0,o=0,s=n.length;o<s;o++)i+=e.measureLength(n[o]);return i},t.prototype._computeGeodesicArea=function(e){var n=this.getCoordinates();if(!on(n))return 0;for(var i=e.measureArea(n[0]),o=1,s=n.length;o<s;o++)i-=e.measureArea(n[o]);return i},t.prototype._updateCache=function(){r.prototype._updateCache.call(this),this._prjHoles&&(this._holes=this._unprojectCoords(this._getPrjHoles()))},t.prototype._clearCache=function(){return delete this._prjShell,r.prototype._clearCache.call(this)},t.prototype._clearProjection=function(){this._prjHoles&&(this._prjHoles=null),this._prjShell&&(this._prjShell=null),r.prototype._clearProjection.call(this)},t}(Kc);_n.registerJSONType(m2);function fm(r){return function(t){Et(e,t);function e(){return t!==null&&t.apply(this,arguments)||this}return e.prototype.getCoordinates=function(){return this._coordinates},e.prototype.setCoordinates=function(n){var i=n instanceof at?n:new at(n);if(this._translateRotatePivot(i),this._coordinates=i,!this.getMap())return this._dirtyCoords=!0,this.onPositionChanged(),this;var o=this._getProjection();return this._setPrjCoordinates(o.project(this._coordinates)),this},e.prototype._getCenter2DPoint=function(n){var i=this.getMap();if(!i)return null;var o=this._getPrjCoordinates();return o?(n||(n=i._getResolution()),i._prjToPointAtRes(o,n)):null},e.prototype._getPrjCoordinates=function(){var n=this._getProjection();return this._verifyProjection(),!this._pcenter&&n&&this._coordinates&&(this._pcenter=n.project(this._coordinates)),this._pcenter},e.prototype._setPrjCoordinates=function(n){this._pcenter=n,this.onPositionChanged()},e.prototype._updateCache=function(){this._clearCache();var n=this._getProjection();this._pcenter&&n&&(this._coordinates=n.unproject(this._pcenter))},e.prototype._clearProjection=function(){this._pcenter=null,t.prototype._clearProjection.call(this)},e.prototype._computeCenter=function(){return this._coordinates?this._coordinates.copy():null},e}(r)}var y2=new Ce,bk={symbol:{markerType:"path",markerPath:[{path:"M8 23l0 0 0 0 0 0 0 0 0 0c-4,-5 -8,-10 -8,-14 0,-5 4,-9 8,-9l0 0 0 0c4,0 8,4 8,9 0,4 -4,9 -8,14z M3,9 a5,5 0,1,0,0,-0.9Z",fill:"#DE3333"}],markerPathWidth:16,markerPathHeight:23,markerWidth:24,markerHeight:34},hitTestForEvent:!1,collision:!0},bn=function(r){Et(t,r);function t(e,n){var i=r.call(this,n)||this;return i.type="Point",i.isPoint=!0,e&&i.setCoordinates(e),i}return t.prototype.getOutline=function(){var e=this.getCoordinates(),n=this.getContainerExtent(),i=this.getMap().coordToContainerPoint(e);return new t(e,{symbol:{markerType:"square",markerWidth:n.getWidth(),markerHeight:n.getHeight(),markerLineWidth:1,markerLineColor:"6b707b",markerFill:"rgba(0, 0, 0, 0)",markerDx:n.xmin-(i.x-n.getWidth()/2),markerDy:n.ymin-(i.y-n.getHeight()/2)}})},t.prototype.setSymbol=function(e){return delete this._fixedExtent,r.prototype.setSymbol.call(this,e)},t.prototype._getSizeSymbol=function(e){for(var n={},i=!1,o=!1,s=0;s<nm.length;s++){var a=e[nm[s]];U(a)||(!i&&Cn(a)&&(i=!0,o=!0),n[nm[s]]=a)}for(var s=0;s<rm.length;s++){var a=e[rm[s]];U(a)||(!i&&Cn(a)&&(i=!0),n[rm[s]]=a)}var l;return i?(l=Pc(n,this),o&&(l._dynamic=!0)):l=n,l},t.prototype._setExternSymbol=function(e){return this._symbol||delete this._fixedExtent,r.prototype._setExternSymbol.call(this,e)},t.prototype._isDynamicSize=function(){return this._sizeSymbol&&this._sizeSymbol._dynamic},t.prototype._getFixedExtent=function(){if(this._fixedExtent&&!this._isDynamicSize())return this._fixedExtent;this._fixedExtent=this._fixedExtent||new Ce,this._fixedExtent.set(null,null,null,null);var e=this._sizeSymbol;if(!e)return this._fixedExtent;var n=this.getLayer()&&this.getLayer().getRenderer(),i=n&&n.resources,o=this.getTextDesc();if(Array.isArray(e)){y2.set(1/0,1/0,-1/0,-1/0);for(var s=0;s<e.length;s++)e[s]&&this._fixedExtent._combine(Qg(y2,e[s],i,o&&o[s]))}else this._fixedExtent=Qg(this._fixedExtent,e,i,o);return this._fixedExtent},t.prototype._isVectorMarker=function(){var e=this._getInternalSymbol();return Array.isArray(e)?!1:Wc(e)},t.prototype._canEdit=function(){var e=this._getInternalSymbol();return Array.isArray(e)?!1:Wc(e)||em(e)||tm(e)},t.prototype._containsPoint=function(e,n){var i=this.getContainerExtent();return n&&(i=i.expand(n)),i.contains(e)?this.options.hitTestForEvent?r.prototype._containsPoint.call(this,e,n):!0:!1},t.prototype._computeExtent=function(){return v2.call(this,"getCenter")},t.prototype._computePrjExtent=function(){return v2.call(this,"_getPrjCoordinates")},t.prototype._computeGeodesicLength=function(){return 0},t.prototype._computeGeodesicArea=function(){return 0},t.prototype._getSprite=function(e,n){return this._getPainter()?this._getPainter().getSprite(e,n):new lm(this).getSprite(e,n)},t}(fm(en));bn.mergeOptions(bk),bn.registerJSONType("Marker");function v2(r){var t=this[r]();return t?new gn(t,t,this._getProjection()):null}var wk={arrowStyle:null,arrowPlacement:"vertex-last"},Pn=function(r){Et(t,r);function t(e,n){var i=r.call(this,n)||this;return i.type="LineString",e&&i.setCoordinates(e),i}return t.prototype.getOutline=function(){return _n.prototype.getOutline.call(this)},t.prototype.setCoordinates=function(e){return e?(this._coordinates=at.toCoordinates(e),this.getMap()?this._setPrjCoordinates(this._projectCoords(this._coordinates)):this.onShapeChanged(),this):(this._coordinates=null,this._setPrjCoordinates(null),this)},t.prototype.getCoordinates=function(){return this._coordinates||[]},t.prototype.getCenterInExtent=function(e){return this._getCenterInExtent(e,this.getCoordinates(),Zc)},t.prototype._computeGeodesicLength=function(e){return e.measureLength(this.getCoordinates())},t.prototype._computeGeodesicArea=function(){return 0},t}(Kc);Pn.mergeOptions(wk),Pn.registerJSONType("LineString");var Ak=new Ce,Lh=function(r){Et(t,r);function t(e,n){var i=r.call(this,n)||this;return i.type="GeometryCollection",i.setGeometries(e),i}return t.prototype.getContainerExtent=function(e){var n=e||new Ce;return this.forEach(function(i){n._combine(i.getContainerExtent(Ak))}),n},t.prototype.setGeometries=function(e){for(var n=this._checkGeometries(e||[]),i=this._getSymbol(),o=this.config(),s=this.getProperties(),a=n.length-1;a>=0;a--)n[a]._initOptions(o),n[a]._setParent(this),n[a]._setEventParent(this),i&&n[a].setSymbol(i),s&&n[a].setProperties(s);return this._geometries=n,this.getLayer()&&(this._bindGeometriesToLayer(),this.onShapeChanged()),this},t.prototype.getGeometries=function(){return this._geometries||[]},t.prototype.forEach=function(e,n){for(var i=this.getGeometries(),o=0,s=i.length;o<s;o++)i[o]&&(n?e.call(n,i[o],o):e(i[o],o));return this},t.prototype.filter=function(e,n){if(!e)return new t;var i=[],o=ze(e),s=o?e:ng(e);return this.forEach(function(a){var l=o?a:sg(a);(n?s.call(n,l):s(l))&&i.push(a)},this),new t(i)},t.prototype.translate=function(e){if(!e)return this;if(this.isEmpty())return this;var n=arguments;return this.forEach(function(i){i&&i.translate&&i.translate.apply(i,n)}),this},t.prototype.isEmpty=function(){return!on(this.getGeometries())},t.prototype.remove=function(){return this.forEach(function(e){e._unbind()}),en.prototype.remove.apply(this,arguments)},t.prototype.show=function(){return this.options.visible=!0,this.forEach(function(e){e.show()}),this},t.prototype.hide=function(){return this.options.visible=!1,this.forEach(function(e){e.hide()}),this},t.prototype.onConfig=function(e){this.forEach(function(n){n.config(e)})},t.prototype.getSymbol=function(){var e=r.prototype.getSymbol.call(this);if(!e){var n=[],i=!1;this.forEach(function(o){var s=o.getSymbol();s&&!i&&(i=!0),n.push(o.getSymbol())}),i&&(e={children:n})}return e},t.prototype.setSymbol=function(e){var n=this;if(e&&e.children)this._symbol=null,this.forEach(function(o,s){o._eventSymbolProperties=n._eventSymbolProperties,o.setSymbol(e.children[s])});else{var i=this._prepareSymbol(e);this._symbol=i,this.forEach(function(o){o._eventSymbolProperties=n._eventSymbolProperties,o.setSymbol(i)})}return this.onSymbolChanged(),this},t.prototype._setExternSymbol=function(e){return e=this._prepareSymbol(e),this._externSymbol=e,this.forEach(function(n){n._setExternSymbol(e)}),this.onSymbolChanged(),this},t.prototype._bindLayer=function(){r.prototype._bindLayer.apply(this,arguments),this._bindGeometriesToLayer()},t.prototype._bindGeometriesToLayer=function(){var e=this.getLayer();this.forEach(function(n){n._bindLayer(e)})},t.prototype._checkGeometries=function(e){var n="The geometry added to collection is invalid.";e=Array.isArray(e)?e:[e];for(var i=[],o=0,s=e.length;o<s;o++){var a=e[o];if(a){if(!this._checkGeo(a)){console.error(n+" Index: "+o);continue}if(Tk(a)){console.error(a," is GeometryCollection sub class,it Cannot be placed in GeometryCollection");continue}i.push(a)}}return i},t.prototype._checkGeo=function(e){return e instanceof en},t.prototype._updateCache=function(){this._clearCache(),!this.isEmpty()&&this.forEach(function(e){e&&e._updateCache&&e._updateCache()})},t.prototype._removePainter=function(){this._painter&&this._painter.remove(),delete this._painter,this.forEach(function(e){e._removePainter()})},t.prototype._computeCenter=function(e){if(!e||this.isEmpty())return null;for(var n=0,i=0,o=0,s=this.getGeometries(),a=0,l=s.length;a<l;a++)if(s[a]){var h=s[a]._computeCenter(e);h&&(n+=h.x,i+=h.y,o++)}return o===0?null:new at(n/o,i/o)},t.prototype._containsPoint=function(e,n){if(this.isEmpty())return!1;delete this._pickGeometryIndex;for(var i=this.getGeometries(),o=0,s=i.length;o<s;o++)if(i[o]._containsPoint(e,n))return this._pickGeometryIndex=o,!0;return!1},t.prototype._hitTestTolerance=function(){for(var e=this.getGeometries(),n=0,i=0,o=e.length;i<o;i++){var s=e[i]._hitTestTolerance();n=Math.max(n,s)}return n},t.prototype._computeExtent=function(e){return x2.call(this,e,"_computeExtent")},t.prototype._computePrjExtent=function(e){return x2.call(this,e,"_computePrjExtent")},t.prototype._computeGeodesicLength=function(e){if(!e||this.isEmpty())return 0;for(var n=this.getGeometries(),i=0,o=0,s=n.length;o<s;o++)n[o]&&(i+=n[o]._computeGeodesicLength(e));return i},t.prototype._computeGeodesicArea=function(e){if(!e||this.isEmpty())return 0;for(var n=this.getGeometries(),i=0,o=0,s=n.length;o<s;o++)n[o]&&(i+=n[o]._computeGeodesicArea(e));return i},t.prototype._exportGeoJSONGeometry=function(){var e=[];if(!this.isEmpty())for(var n=this.getGeometries(),i=0,o=n.length;i<o;i++)n[i]&&e.push(n[i]._exportGeoJSONGeometry());return{type:"GeometryCollection",geometries:e}},t.prototype._toJSON=function(e){e=Gt({},e);var n={type:"Feature",geometry:{type:"GeometryCollection",geometries:this.getGeometries().filter(function(s){return s&&s._toJSON}).map(function(s){var a=s._toJSON();return a.subType?a:s._exportGeoJSONGeometry()})}},i=this.getId();U(i)||(n.id=i);var o;return(U(e.properties)||e.properties)&&(o=this._exportProperties()),n.properties=o,e.feature=n,e},t.prototype._clearProjection=function(){if(!this.isEmpty())for(var e=this.getGeometries(),n=0,i=e.length;n<i;n++)e[n]&&e[n]._clearProjection()},t.prototype._getConnectPoints=function(){var e=this.getExtent(),n=[new at(e.xmin,e.ymax),new at(e.xmax,e.ymin),new at(e.xmin,e.ymin),new at(e.xmax,e.ymax)];return n},t.prototype._getExternalResources=function(){if(this.isEmpty())return[];for(var e=this.getGeometries(),n=[],i={},o,s,a,l=0,h=e.length;l<h;l++)if(e[l]){o=e[l]._getInternalSymbol(),s=yh(o);for(var u=0,c=s.length;u<c;u++)a=s[u].join(),i[a]||(n.push(s[u]),i[a]=1)}return n},t.prototype.startEdit=function(e){var n=this;if(this.isEmpty())return this;e||(e={}),e.symbol&&(this._originalSymbol=this.getSymbol(),this.setSymbol(e.symbol)),this._draggbleBeforeEdit=this.options.draggable,this.config("draggable",!1),this._recordVisible();for(var i=this.getGeometries(),o=0,s=i.length;o<s;o++)i[o].startEdit(e);this._editing=!0;var a=this.getLayer(),l=a&&a.options.renderer==="canvas";return l&&this.hide(),setTimeout(function(){n.fire("editstart")},1),this},t.prototype.endEdit=function(){if(this.isEmpty())return this;this._recoveryVisible();for(var e=this.getGeometries(),n=0,i=e.length;n<i;n++)e[n].endEdit();return this._originalSymbol&&(this.setSymbol(this._originalSymbol),delete this._originalSymbol),this._editing=!1,this.show(),this.config("draggable",this._draggbleBeforeEdit),this.fire("editend"),this},t.prototype.isEditing=function(){return!!this._editing},t}(en);Lh.registerJSONType("GeometryCollection");function x2(r,t){if(this.isEmpty())return null;for(var e=new gn,n=this.getGeometries(),i=0,o=n.length;i<o;i++)if(n[i]){var s=n[i][t](r);s&&e._combine(s)}return e}function Tk(r){return r instanceof Lh}var _2=function(r){Et(t,r);function t(e,n,i,o){var s=r.call(this,null,o)||this;return s.GeometryType=e,s.type=n,s._initData(i),s}return t.prototype.getCoordinates=function(){for(var e=[],n=this.getGeometries(),i=0,o=n.length;i<o;i++){var s=n[i];e.push(s.getShell&&s.getJSONType()!=="Polygon"?[s.getShell()]:s.getCoordinates())}return e},t.prototype.setCoordinates=function(e){e=e||[];for(var n=[],i=0,o=e.length;i<o;i++){var s=new this.GeometryType(e[i],this.config());n.push(s)}return this.setGeometries(n),this},t.prototype._initData=function(e){e=e||[],e.length&&(e[0]instanceof this.GeometryType?this.setGeometries(e):this.setCoordinates(e))},t.prototype._checkGeo=function(e){return e instanceof this.GeometryType},t.prototype._exportGeoJSONGeometry=function(){var e=this.getCoordinates(),n=at.toNumberArrays(e);return{type:this.getType(),coordinates:n}},t.prototype._toJSON=function(e){return{feature:this.toGeoJSON(e)}},t}(Lh),Hs=function(r){Et(t,r);function t(e,n){return r.call(this,bn,"MultiPoint",e,n)||this}return t.prototype.findClosest=function(e){if(!e)return null;var n=this.getCoordinates(),i=null,o=1/0;return n.forEach(function(s){var a=Mk(s,e);a<o&&(i=s,o=a)}),i},t}(_2);Hs.registerJSONType("MultiPoint");function Mk(r,t){var e=t.x-r.x,n=t.y-r.y;return Math.sqrt(e*e+n*n)}var b2=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.getCenterInExtent=function(e){var n=this.getGeometries(),i=te([0,0,0],3),o=i[0],s=i[1],a=i[2];return n.forEach(function(l){var h=l.getCenterInExtent(e);h&&(o+=h.x*h.count,s+=h.y*h.count,a+=h.count)}),a===0?null:new at(o,s)._multi(1/a)},t}(_2),Ns=function(r){Et(t,r);function t(e,n){return r.call(this,Pn,"MultiLineString",e,n)||this}return t}(b2);Ns.registerJSONType("MultiLineString");var Bs=function(r){Et(t,r);function t(e,n){return r.call(this,_n,"MultiPolygon",e,n)||this}return t}(b2);Bs.registerJSONType("MultiPolygon");var Sk={Marker:bn,LineString:Pn,Polygon:_n,MultiPoint:Hs,MultiLineString:Ns,MultiPolygon:Bs},w2="geojson-fetch-worker-page-async",Ck=`
function (exports) {
    const resultMap = {};

    function handleResult(msg, postResponse) {
        const data = msg.data || {};
        const { taskId } = data;
        const features = resultMap[taskId];
        if (!features) {
            postResponse('not find geojson dataset the taskId:' + taskId);
            return;
        }
        if (features.length === 0) {
            delete resultMap[taskId];
            postResponse(null, []);
            return;
        }
        const pageSize = data.pageSize || 2000;
        const pageFeatures = features.slice(0, pageSize);
        resultMap[taskId] = features.slice(pageSize, Infinity);
        postResponse(null, pageFeatures);
    }
    //worker init
    exports.initialize = function () {
        // console.log("geojson fetch init");
    };
    //recive message
    exports.onmessage = function (msg, postResponse) {
        const { taskId, type, url } = msg.data || {};
        if (!taskId) {
            postResponse('not find task id for get geojson dataset,taskId=' + taskId);
            return;
        }
        if (type === 'fetchdata') {
            if (!url) {
                postResponse('url is null,url=' + url);
                return;
            }
            fetch(url).then(res => res.json()).then(geojson => {
                let features;
                if (Array.isArray(geojson)) {
                    features = geojson;
                } else if (geojson.features) {
                    features = geojson.features;
                } else {
                    features = [geojson];
                }
                resultMap[taskId] = features;
                handleResult(msg, postResponse);
            }).catch(errror => {
                postResponse(errror.message);
            });
        } else if (type === 'pagefeatures') {
            handleResult(msg, postResponse);
        } else {
            postResponse('not support task type:' + type);
        }
    };
}`,Pk=function(r){Et(t,r);function t(){return r.call(this,w2)||this}return t.prototype._sendMsg=function(e,n,i){var o=this;this.send(e,[],function(s,a){s?i(s):o._pageFeatures(e,a,n,i)},e.workerId)},t.prototype._fetchGeoJSON=function(e,n,i,o){i===void 0&&(i=[]);var s=Gt({},n);s.type="fetchdata",s.url=e,this._sendMsg(s,i,o)},t.prototype._pageFeatures=function(e,n,i,o){if(i.push(n),n.length===0){o(null,i);return}var s=Gt({},e);s.type="pagefeatures",this._sendMsg(s,i,o)},t}(Rh);Rs(w2,function(){return Ck});var Qc,Ai={toGeometry:function(r,t){if(Se(r)&&(r=uh(r)),Array.isArray(r)){for(var e=[],n=0,i=r.length;n<i;n++){var o=Ai._convert(r[n],t);Array.isArray(o)?ai(e,o):e.push(o)}return e}else{var s=Ai._convert(r,t);return s}},toGeometryAsync:function(r,t,e){return e===void 0&&(e=2e3),Se(r)&&(r=uh(r)),new Promise(function(n){var i=[];if(r&&(Array.isArray(r)||Array.isArray(r.features))){var o=It(e)?Math.round(e):2e3,s=r.features||r,a=Math.ceil(s.length/o),l=1,h=function(){var c=(l-1)*o,f=l*o,d=s.slice(c,f),p=Ai.toGeometry(d,t);return l++,p};Wx({count:a,run:h}).then(function(c){for(var f=0,d=c.length;f<d;f++){var p=c[f];p&&(Array.isArray(p)?ai(i,p):i.push(p))}n(i)})}else{var u=Ai.toGeometry(r,t);n(u)}})},_convert:function(r,t){if(!r||U(r.type))return null;var e=r.type;if(e==="Feature"){var n=r.geometry,i=Ai._convert(n);return i?(i.setId(r.id),i.setProperties(r.properties),t&&t(i),i):null}else if(e==="FeatureCollection"){var o=r.features;return o?Ai.toGeometry(o,t):null}else if(["Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon"].indexOf(e)>=0){var s=e==="Point"?"Marker":e,a=new Sk[s](r.coordinates);return t&&t(a),a}else if(e==="GeometryCollection"){var l=r.geometries;if(!on(l)){var h=new Lh;return t&&t(h),h}for(var u=[],c=l.length,f=0;f<c;f++)l[f].subType?u.push(en.getJSONClass(l[f].subType).fromJSON(l[f])):u.push(Ai._convert(l[f]));var a=new Lh(u);return t&&t(a),a}return null},_isGeoJSON:function(r){if(!r)return!1;if(r=r||{},Array.isArray(r)&&r.length)return Ai.isGeoJSON(r[0]);var t=r.type;if(!t||Z1.indexOf(t)===-1)return!1;var e=r.features,n=r.geometries,i=r.geometry,o=r.coordinates;if(o&&Array.isArray(o)||Array.isArray(n)||Array.isArray(e))return!0;if(i){var s=i.coordinates;if(s&&Array.isArray(s))return!0}return!1},fetch:function(r,t){return t===void 0&&(t=2e3),new Promise(function(e,n){if(!r||!Se(r)){n("url is error,It should be string");return}var i=Gt({pageSize:2e3},{pageSize:t});r=mc(r),Qc||(Qc=new Pk);var o=Qc.workers.length,s=Math.floor(Math.random()*o);s=Math.min(o-1,s),i.workerId=s,i.taskId=H1(),Qc._fetchGeoJSON(r,i,[],function(a,l){if(a){n(a);return}var h=[];l.forEach(function(u){for(var c=0,f=u.length;c<f;c++)h.push(u[c])}),e({type:"FeatureCollection",features:h})})})}},Ek={numberOfShellPoints:60},Ti=function(r){Et(t,r);function t(e,n,i){var o=r.call(this,null,i)||this;return e&&o.setCoordinates(e),o._radius=n,o}return t.fromJSON=function(e){var n=e.feature,i=new t(e.coordinates,e.radius,e.options);return i.setProperties(n.properties),i},t.prototype.getRadius=function(){return this._radius},t.prototype.setRadius=function(e){return this._radius=e,this.onShapeChanged(),this},t.prototype.getShell=function(){for(var e=this._getMeasurer(),n=this.getCoordinates(),i=this.options.numberOfShellPoints,o=this.getRadius(),s=[],a,l,h,u=0,c=i-1;u<c;u++){a=360*u/c*Math.PI/180,l=o*Math.cos(a),h=o*Math.sin(a);var f=e.locate(n,l,h);f.z=n.z,s.push(f)}return s.push(s[0]),s},t.prototype.getHoles=function(){return[]},t.prototype.animateShow=function(){return this.show()},t.prototype._containsPoint=function(e,n){var i=this.getMap();if(i.getPitch())return r.prototype._containsPoint.call(this,e,n);var o=i._pointToContainerPoint(this._getCenter2DPoint()),s=this.getSize(),a=this._hitTestTolerance()+(n||0),l=o.add(s.width/2,s.height/2);return j_(e,o,l,a)},t.prototype._computePrjExtent=function(e){var n=this._getMinMax(e);if(!n)return null;var i=this._getPrjCoordinates(),o=n.map(function(u){return e.project(u)}),s=o[0].x-i.x,a=o[1].x-i.x,l=o[2].y-i.y,h=o[3].y-i.y;return new gn(i.add(s,l),i.add(a,h))},t.prototype._computeExtent=function(e){var n=this._getMinMax(e);return n?new gn(n[0].x,n[2].y,n[1].x,n[3].y,this._getProjection()):null},t.prototype._getMinMax=function(e){if(!e||!this._coordinates||U(this._radius))return null;var n=this._radius,i=e.locate(this._coordinates,-n,0),o=e.locate(this._coordinates,n,0),s=e.locate(this._coordinates,0,n),a=e.locate(this._coordinates,0,-n);return[i,o,s,a]},t.prototype._computeGeodesicLength=function(){return U(this._radius)?0:Math.PI*2*this._radius},t.prototype._computeGeodesicArea=function(){return U(this._radius)?0:Math.PI*Math.pow(this._radius,2)},t.prototype._exportGeoJSONGeometry=function(){var e=at.toNumberArrays([this.getShell()]);return{type:"Polygon",coordinates:e}},t.prototype._toJSON=function(e){var n=this.getCenter(),i=Gt({},e);i.geometry=!1;var o=this.toGeoJSON(i);return o.geometry={type:"Polygon"},{feature:o,subType:"Circle",coordinates:[n.x,n.y],radius:this.getRadius()}},t}(fm(_n));Ti.mergeOptions(Ek),Ti.registerJSONType("Circle");function Ok(r){return r*r*r*r}function kk(r){for(var t=[],e=[],n=0;n<r;n++)e.push(Ok(n/r));var i=e.map(function(l){return l}).reverse(),o=[];ai(o,e,i,e,i);for(var s=0,n=0,a=o.length;n<a;n+=4)t.push(o[n]),s+=o[n];return{fs:t,sum:s}}var Ik={numberOfShellPoints:81},no=function(r){Et(t,r);function t(e,n,i,o){var s=r.call(this,null,o)||this;return e&&s.setCoordinates(e),s.width=n,s.height=i,s}return t.fromJSON=function(e){var n=e.feature,i=new t(e.coordinates,e.width,e.height,e.options);return i.setProperties(n.properties),i},t.prototype.getWidth=function(){return this.width},t.prototype.setWidth=function(e){return this.width=e,this.onShapeChanged(),this},t.prototype.getHeight=function(){return this.height},t.prototype.setHeight=function(e){return this.height=e,this.onShapeChanged(),this},t.prototype.getShell=function(){return this.isRotated()?this.getRotatedShell():this._getShell()},t.prototype._getShell=function(){var e=this._getMeasurer(),n=this.getCoordinates(),i=this.options.numberOfShellPoints-1,o=this.getWidth(),s=this.getHeight(),a=[],l=Math.pow(o/2,2)*Math.pow(s/2,2),h=Math.pow(o/2,2),u=Math.pow(s/2,2),c=[];if(Math.max(o/s,s/o)>2){var f=kk(i),d=f.fs,p=f.sum,g=360/p,m=0;s>o&&(m=90);for(var y=0,x=0,v=d.length;x<v;x++)y+=g*d[x],c.push(y+m)}else for(var x=0;x<i;x++){var y=360*x/i;c.push(y)}this.options.debug&&console.log(c);for(var _,w,b,A,x=0;x<c.length;x++){_=c[x],w=_*Math.PI/180,b=Math.sqrt(l/(h*Math.pow(Math.tan(w),2)+u)),A=Math.sqrt(l/(u*Math.pow(1/Math.tan(w),2)+h)),_>90&&_<270&&(b*=-1),_>180&&_<360&&(A*=-1);var T=e.locate(n,b,A);T.z=n.z,a.push(T)}return a.push(a[0].copy()),a},t.prototype._getPrjShell=function(){var e=r.prototype._getPrjShell.call(this);return this._rotatePrjCoordinates(e)},t.prototype.getHoles=function(){return[]},t.prototype.animateShow=function(){return this.show()},t.prototype._containsPoint=function(e,n){var i=this.getMap();if(i.isTransforming())return r.prototype._containsPoint.call(this,e,n);var o=i.getProjection(),s=this._hitTestTolerance()+(n||0),a=o.projectCoords([this._coordinates,i.locate(this._coordinates,this.getWidth()/2,this.getHeight()/2)],this.options.antiMeridian),l=i.prjToContainerPoint(a[0]),h=i.prjToContainerPoint(a[1]);return j_(e,l,h,s)},t.prototype._computePrjExtent=function(){return this.isRotated()?this._computeRotatedPrjExtent():Ti.prototype._computePrjExtent.apply(this,arguments)},t.prototype._computeExtent=function(){return Ti.prototype._computeExtent.apply(this,arguments)},t.prototype._getMinMax=function(e){if(!e||!this._coordinates||U(this.width)||U(this.height))return null;var n=this.getWidth(),i=this.getHeight(),o=e.locate(this._coordinates,-n/2,0),s=e.locate(this._coordinates,n/2,0),a=e.locate(this._coordinates,0,-i/2),l=e.locate(this._coordinates,0,i/2);return[o,s,a,l]},t.prototype._computeGeodesicLength=function(){if(U(this.width)||U(this.height))return 0;var e=this.width>this.height?this.width:this.height;return 2*Math.PI*e/2-4*Math.abs(this.width-this.height)},t.prototype._computeGeodesicArea=function(){return U(this.width)||U(this.height)?0:Math.PI*this.width*this.height/4},t.prototype._exportGeoJSONGeometry=function(){var e=at.toNumberArrays([this.getShell()]);return{type:"Polygon",coordinates:e}},t.prototype._toJSON=function(e){var n=Gt({},e),i=this.getCenter();n.geometry=!1;var o=this.toGeoJSON(n);return o.geometry={type:"Polygon"},{feature:o,subType:"Ellipse",coordinates:[i.x,i.y],width:this.getWidth(),height:this.getHeight()}},t}(fm(_n));no.mergeOptions(Ik),no.registerJSONType("Ellipse");var js=function(r){Et(t,r);function t(e,n,i,o){var s=r.call(this,null,o)||this;return e&&s.setCoordinates(e),s._width=n,s._height=i,s}return t.fromJSON=function(e){var n=e.feature,i=new t(e.coordinates,e.width,e.height,e.options);return i.setProperties(n.properties),i},t.prototype.getCoordinates=function(){return this._coordinates},t.prototype.setCoordinates=function(e){var n=e instanceof at?e:new at(e);if(this._translateRotatePivot(n),this._coordinates=n,!this._coordinates||!this.getMap())return this.onPositionChanged(),this;var i=this._getProjection();return this._setPrjCoordinates(i.project(this._coordinates)),this},t.prototype.getWidth=function(){return this._width},t.prototype.setWidth=function(e){return this._width=e,this.onShapeChanged(),this},t.prototype.getHeight=function(){return this._height},t.prototype.setHeight=function(e){return this._height=e,this.onShapeChanged(),this},t.prototype.getShell=function(){return this.isRotated()?this.getRotatedShell():this._getShell()},t.prototype._getShell=function(){var e=this._getMeasurer(),n=this._coordinates,i=this.getMap(),o=1,s=-1;if(i){var a=i.getFullExtent();a.left>a.right&&(o=-1),a.bottom>a.top&&(s=1)}var l=[];l.push(n);var h=e.locate(n,o*this._width,0);h.z=n.z,l.push(h);var u=e.locate(n,o*this._width,s*this._height);u.z=n.z,l.push(u);var c=e.locate(n,0,s*this._height);return l.push(c),c.z=n.z,l.push(n),l},t.prototype.getHoles=function(){return[]},t.prototype.animateShow=function(){return this.show()},t.prototype._getPrjCoordinates=function(){var e=this._getProjection();return this._verifyProjection(),!this._pnw&&e&&this._coordinates&&(this._pnw=e.project(this._coordinates)),this._pnw},t.prototype._setPrjCoordinates=function(e){this._pnw=e,this.onPositionChanged()},t.prototype._getPrjShell=function(){var e=r.prototype._getPrjShell.call(this),n=this._getProjection();if(!n.isSphere())return this._rotatePrjCoordinates(e);for(var i=n.getSphereExtent(),o=i.sx,s=i.sy,a=this._getProjection().getCircum(),l=e[0],h=1,u=e.length;h<u;h++){var c=e[h],f=0,d=0;o*(l.x-c.x)>0&&(f=a.x*o),s*(l.y-c.y)<0&&(d=a.y*s),e[h]._add(f,d)}return this._rotatePrjCoordinates(e)},t.prototype._updateCache=function(){this._clearCache();var e=this._getProjection();this._pnw&&e&&(this._coordinates=e.unproject(this._pnw))},t.prototype._clearProjection=function(){this._pnw=null,r.prototype._clearProjection.call(this)},t.prototype._computeCenter=function(e){return e.locate(this._coordinates,this._width/2,-this._height/2)},t.prototype._containsPoint=function(e,n){var i=this.getMap();if(i.isTransforming())return r.prototype._containsPoint.call(this,e,n);var o=U(n)?this._hitTestTolerance():n,s=i._getResolution()*o,a=this._getPrjExtent().expand(s),l=i._containerPointToPrj(e);return a.contains(l)},t.prototype._computePrjExtent=function(e){if(this.isRotated())return this._computeRotatedPrjExtent();var n=this._getSouthEast(e);if(!n)return null;var i=e.projectCoords([new at(this._coordinates.x,n.y),new at(n.x,this._coordinates.y)],this.options.antiMeridian);return new gn(i[0],i[1])},t.prototype._computeExtent=function(e){var n=this._getSouthEast(e);return n?new gn(this._coordinates,n,this._getProjection()):null},t.prototype._getSouthEast=function(e){if(!e||!this._coordinates||U(this._width)||U(this._height))return null;var n=this.getWidth(),i=this.getHeight(),o=n,s=-i;if(e.fullExtent){var a=e.fullExtent,l=a.right>a.left?1:-1,h=a.top>a.bottom?1:-1;o*=l,s*=h}var u=e.locate(this._coordinates,o,0),c=e.locate(this._coordinates,0,s);return u.y=c.y,u},t.prototype._computeGeodesicLength=function(){return U(this._width)||U(this._height)?0:2*(this._width+this._height)},t.prototype._computeGeodesicArea=function(){return U(this._width)||U(this._height)?0:this._width*this._height},t.prototype._exportGeoJSONGeometry=function(){var e=at.toNumberArrays([this.getShell()]);return{type:"Polygon",coordinates:e}},t.prototype._toJSON=function(e){var n=Gt({},e),i=this.getCoordinates();n.geometry=!1;var o=this.toGeoJSON(n);return o.geometry={type:"Polygon"},{feature:o,subType:"Rectangle",coordinates:[i.x,i.y],width:this.getWidth(),height:this.getHeight()}},t}(_n);js.registerJSONType("Rectangle");var Rk={numberOfShellPoints:60},Vs=function(r){Et(t,r);function t(e,n,i,o,s){var a=r.call(this,e,n,s)||this;return a.startAngle=i,a.endAngle=o,a}return t.fromJSON=function(e){var n=e.feature,i=new t(e.coordinates,e.radius,e.startAngle,e.endAngle,e.options);return i.setProperties(n.properties),i},t.prototype.getStartAngle=function(){return this.startAngle},t.prototype.setStartAngle=function(e){return this.startAngle=e,this.onShapeChanged(),this},t.prototype.getEndAngle=function(){return this.endAngle},t.prototype.setEndAngle=function(e){return this.endAngle=e,this.onShapeChanged(),this},t.prototype._correctAngles=function(){var e=this.getStartAngle(),n=this.getEndAngle();if(n<e)return console.error("The ending angle should be greater than the starting angle ",e,n),[0,0];var i=360;return n-e>i?(console.error("The difference between the end angle and the start angle is greater than 360 degrees ",e,n),[0,0]):(e<0&&(e+=i,n+=i),[e,n])},t.prototype.getShell=function(){return this.isRotated()?this.getRotatedShell():this._getShell()},t.prototype._getShell=function(){for(var e=te(this._correctAngles(),2),n=e[0],i=e[1],o=this._getMeasurer(),s=this.getCoordinates(),a=this.options.numberOfShellPoints-2,l=this.getRadius(),h=[s.copy()],u=i-n,c,f,d,p=0;p<a;p++){c=(u*p/(a-1)+n)*Math.PI/180,f=l*Math.cos(c),d=l*Math.sin(c);var g=o.locate(s,f,d);g.z=s.z,h.push(g)}return h.push(s.copy()),h},t.prototype.getRotateOffsetAngle=function(){return 90},t.prototype._getPrjShell=function(){var e=r.prototype._getPrjShell.call(this);return this._rotatePrjCoordinates(e)},t.prototype._computePrjExtent=function(){return this.isRotated()?this._computeRotatedPrjExtent():Ti.prototype._computePrjExtent.apply(this,arguments)},t.prototype._containsPoint=function(e,n){var i=this.getMap();if(i.isTransforming())return r.prototype._containsPoint.call(this,e,n);var o=i._pointToContainerPoint(this._getCenter2DPoint()),s=this._hitTestTolerance()+(n||0),a=this.getSize(),l=o,h=e,u=h.x-l.x,c=l.y-h.y,f=Math.atan2(c,u),d=f<0?(f+2*Math.PI)*360/(2*Math.PI):f*360/(2*Math.PI),p=te(this._correctAngles(),2),g=p[0],m=p[1],y=g%360,x=m%360,v=!1;return y>x?v=!(d>x&&d<y):v=d>=y&&d<=x,h.distanceTo(l)<=a.width/2+s&&v},t.prototype._computeGeodesicLength=function(){if(U(this._radius))return 0;var e=te(this._correctAngles(),2),n=e[0],i=e[1];return Math.PI*2*this._radius*Math.abs(n-i)/360+2*this._radius},t.prototype._computeGeodesicArea=function(){if(U(this._radius))return 0;var e=te(this._correctAngles(),2),n=e[0],i=e[1];return Math.PI*Math.pow(this._radius,2)*Math.abs(n-i)/360},t.prototype._toJSON=function(e){var n=Gt({},e),i=this.getCenter();n.geometry=!1;var o=this.toGeoJSON(n);return o.geometry={type:"Polygon"},{feature:o,subType:"Sector",coordinates:[i.x,i.y],radius:this.getRadius(),startAngle:this.getStartAngle(),endAngle:this.getEndAngle()}},t}(Ti);Vs.mergeOptions(Rk),Vs.registerJSONType("Sector");var Dk={enableSimplify:!1,enableClip:!1},zh=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype._arc=function(e,n,i){var o=this.options.arcDegree;o===0&&(o=1);for(var s=o*Math.PI/180,a=1,l=n.length;a<l;a++)Mt._arcBetween(e,n[a-1],n[a],s),Mt._stroke(e,i)},t.prototype._quadraticCurve=function(e,n){if(n.length<=2){Mt._path(e,n);return}var i,o;for(i=2,o=n.length;i<o;i+=2)e.quadraticCurveTo(n[i-1].x,n[i-1].y,n[i].x,n[i].y);if(i-=1,i<o)for(;i<o;i++)e.lineTo(n[i].x,n[i].y)},t.prototype._bezierCurve=function(e,n){if(n.length<=3){Mt._path(e,n);return}var i,o;for(i=1,o=n.length;i+2<o;i+=3)e.bezierCurveTo(n[i].x,n[i].y,n[i+1].x,n[i+1].y,n[i+2].x,n[i+2].y);if(i<o)for(;i<o;i++)e.lineTo(n[i].x,n[i].y)},t.prototype._getCurveArrowPoints=function(e,n,i,o,s,a){var l=n.length,h;for(h=a;h<l;h+=a){var u=this._getArrowShape(n[h-1],n[h],i,o,s);u&&e.push(u)}if(h-=a,h<l-1)for(h+=1;h<l;h++){var u=this._getArrowShape(n[h-1],n[h],i,o,s);u&&e.push(u)}},t}(Pn);zh.mergeOptions(Dk);var Fk={arcDegree:90},tf=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype._toJSON=function(e){return{feature:this.toGeoJSON(e),subType:"ArcCurve"}},t.prototype._paintOn=function(e,n,i){e.beginPath(),this._arc(e,n,i),Mt._stroke(e,i),this._paintArrow(e,n,i)},t.fromJSON=function(e){var n=e.feature,i=new t(n.geometry.coordinates,e.options);return i.setProperties(n.properties),i},t}(zh);tf.registerJSONType("ArcCurve"),tf.mergeOptions(Fk);var A2=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.fromJSON=function(e){var n=e.feature,i=new t(n.geometry.coordinates,e.options);return i.setProperties(n.properties),i},t.prototype._toJSON=function(e){return{feature:this.toGeoJSON(e),subType:"CubicBezierCurve"}},t.prototype._paintOn=function(e,n,i){e.beginPath(),e.moveTo(n[0].x,n[0].y),this._bezierCurve(e,n),Mt._stroke(e,i),this._paintArrow(e,n,i)},t.prototype._getArrowPoints=function(e,n,i,o,s){return this._getCurveArrowPoints(e,n,i,o,s,3)},t}(zh);A2.registerJSONType("CubicBezierCurve");var T2=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.fromJSON=function(e){var n=e.feature,i=new t(n.geometry.coordinates,e.options);return i.setProperties(n.properties),i},t.prototype._toJSON=function(e){return{feature:this.toGeoJSON(e),subType:"QuadBezierCurve"}},t.prototype._paintOn=function(e,n,i){e.beginPath(),e.moveTo(n[0].x,n[0].y),this._quadraticCurve(e,n,i),Mt._stroke(e,i),this._paintArrow(e,n,i)},t.prototype._getArrowPoints=function(e,n,i,o,s){return this._getCurveArrowPoints(e,n,i,o,s,2)},t}(zh);T2.registerJSONType("QuadBezierCurve");var Lk={textFaceName:"monospace",textSize:12,textLineSpacing:8,textWrapCharacter:`
`,textHorizontalAlignment:"middle",textVerticalAlignment:"middle"},zk={markerType:"square",markerLineColor:"#000",markerLineWidth:2,markerLineOpacity:1,markerFill:"#fff",markerOpacity:1},dm=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.getContent=function(){return this._content},t.prototype.setContent=function(e){var n=this._content;return this._content=yc(e),this._refresh(),this._fireEvent("contentchange",{old:n,new:e}),this},t.prototype.onAdd=function(){this._refresh()},t.prototype.toJSON=function(){var e=r.prototype.toJSON.call(this);return delete e.symbol,e},t.prototype.setSymbol=function(e){if(this._refreshing||!e)return r.prototype.setSymbol.call(this,e);var n=this._parseSymbol(e);if(this.setTextStyle){var i=this.getTextStyle()||{};i.symbol=n[0],this.setTextStyle(i)}else this.setTextSymbol&&this.setTextSymbol(n[0]);if(this.setBoxStyle){var i=this.getBoxStyle()||{};i.symbol=n[1],this.setBoxStyle(i)}else this.setBoxSymbol&&this.setBoxSymbol(n[1]);return this},t.prototype._parseSymbol=function(e){var n={},i={};for(var o in e)ga(e,o)&&(o.indexOf("text")===0?n[o]=e[o]:i[o]=e[o]);return[n,i]},t.prototype._getTextSize=function(e){return Jp(this._content,e).size},t.prototype._getInternalSymbol=function(){return this._symbol},t.prototype._getDefaultTextSymbol=function(){return Gt({},Lk)},t.prototype._getDefaultBoxSymbol=function(){return Gt({},zk)},t.prototype._getDefaultPadding=function(){return[12,8]},t}(bn),Hk={textStyle:{wrap:!0,padding:[12,8],verticalAlignment:"middle",horizontalAlignment:"middle"},boxSymbol:null},ef=function(r){Et(t,r);function t(e,n,i,o,s){s===void 0&&(s={});var a=r.call(this,n,s)||this;return a._content=yc(e),a._width=U(i)?100:i,a._height=U(o)?40:o,s.boxSymbol&&a.setBoxSymbol(s.boxSymbol),s.textStyle&&a.setTextStyle(s.textStyle),a._refresh(),a}return t.prototype.getWidth=function(){return this._width},t.prototype.setWidth=function(e){return this._width=e,this._refresh(),this},t.prototype.getHeight=function(){return this._height},t.prototype.setHeight=function(e){return this._height=e,this._refresh(),this},t.prototype.getBoxSymbol=function(){return Gt({},this.options.boxSymbol)},t.prototype.setBoxSymbol=function(e){return this.options.boxSymbol=e&&Gt({},e),this.getSymbol()&&this._refresh(),this},t.prototype.getTextStyle=function(){return this.options.textStyle?Gt({},this.options.textStyle):null},t.prototype.setTextStyle=function(e){return this.options.textStyle=e&&Gt({},e),this.getSymbol()&&this._refresh(),this},t.fromJSON=function(e){var n=e.feature,i=new t(e.content,n.geometry.coordinates,e.width,e.height,e.options);return i.setProperties(n.properties),i.setId(n.id),e.symbol&&i.setSymbol(e.symbol),i},t.prototype._toJSON=function(e){return{feature:this.toGeoJSON(e),width:this.getWidth(),height:this.getHeight(),subType:"TextBox",content:this._content}},t.prototype._refresh=function(){var e=this.getTextStyle()||{},n=e.padding||[12,8],i,o;if(Cn(this._width)){i=JSON.parse(JSON.stringify(this._width));var s=i.stops;if(s)for(var a=0;a<s.length;a++)s[a][1]=s[a][1]-2*n[0]}else i=this._width-2*n[0];if(Cn(this._height)){o=JSON.parse(JSON.stringify(this._height));var s=o.stops;if(s)for(var a=0;a<s.length;a++)s[a][1]=s[a][1]-2*n[1]}else o=this._height-2*n[1];var l=Gt({},e.symbol||this._getDefaultTextSymbol(),this.options.boxSymbol||this._getDefaultBoxSymbol(),{textName:this._content,markerWidth:this._width,markerHeight:this._height,textHorizontalAlignment:"middle",textVerticalAlignment:"middle",textMaxWidth:i,textMaxHeight:o});e.wrap&&!l.textWrapWidth&&(l.textWrapWidth=i);var h=e.horizontalAlignment;l.textDx=l.markerDx||0;var u;if(Cn(this._width)){u=JSON.parse(JSON.stringify(this._width));var s=u.stops;if(s)for(var a=0;a<s.length;a++)s[a][1]=s[a][1]/2-n[0],h==="left"&&(s[a][1]*=-1)}else u=l.markerWidth/2-n[0],h==="left"&&(u*=-1);h==="left"?(l.textHorizontalAlignment="right",l.textDx=u):h==="right"&&(l.textHorizontalAlignment="left",l.textDx=u);var c=e.verticalAlignment;l.textDy=l.markerDy||0;var f;if(Cn(this._height)){f=JSON.parse(JSON.stringify(this._height));var s=f.stops;if(s)for(var a=0;a<s.length;a++)s[a][1]=s[a][1]/2-n[1],c==="top"&&(s[a][1]*=-1)}else f=l.markerHeight/2-n[1],c==="top"&&(f*=-1);c==="top"?(l.textVerticalAlignment="bottom",l.textDy=f):c==="bottom"&&(l.textVerticalAlignment="top",l.textDy=f),this._refreshing=!0,this.updateSymbol(l),delete this._refreshing},t.prototype.startEdit=function(e){var n=this._getCompiledSymbol();if(Cn(this._width)){var i=n.markerWidth;this._oldWidth=this._width,this.setWidth(i)}if(Cn(this._height)){var o=n.markerHeight;this._oldHeight=this._height,this.setHeight(o)}return r.prototype.startEdit.call(this,e)},t.prototype.endEdit=function(){var e=this.getMap(),n=e&&e.getZoom();if(this._oldWidth){for(var i=this._width,o=Sc(this._oldWidth),s=o(n),a=i/s,l=this._oldWidth.stops,h=0;h<l.length;h++)l[h][1]*=a;this.setWidth(this._oldWidth),delete this._oldWidth}if(this._oldHeight){for(var u=this._height,c=Sc(this._oldHeight),f=c(n),a=u/f,l=this._oldHeight.stops,h=0;h<l.length;h++)l[h][1]*=a;this.setHeight(this._oldHeight),delete this._oldHeight}return r.prototype.endEdit.call(this)},t}(dm);ef.mergeOptions(Hk),ef.registerJSONType("TextBox");var Nk={boxStyle:null,textSymbol:null},Ha=function(r){Et(t,r);function t(e,n,i){i===void 0&&(i={});var o=r.call(this,n,i)||this;return i.textSymbol&&o.setTextSymbol(i.textSymbol),i.boxStyle&&o.setBoxStyle(i.boxStyle),o._content=yc(e),o._refresh(),o}return t.prototype.getBoxStyle=function(){return this.options.boxStyle?Gt({},this.options.boxStyle):null},t.prototype.setBoxStyle=function(e){return this.options.boxStyle=e&&Gt({},e),this._refresh(),this},t.prototype.getTextSymbol=function(){return Gt({},this._getDefaultTextSymbol(),this.options.textSymbol)},t.prototype.setTextSymbol=function(e){return this.options.textSymbol=e&&Gt({},e),this._refresh(),this},t.fromJSON=function(e){var n=e.feature,i=new t(e.content,n.geometry.coordinates,e.options);return i.setProperties(n.properties),i.setId(n.id),e.symbol&&i.setSymbol(e.symbol),i},t.prototype._canEdit=function(){return!1},t.prototype._toJSON=function(e){return{feature:this.toGeoJSON(e),subType:"Label",content:this._content}},t.prototype._refresh=function(){var e=Gt({},this.getTextSymbol(),{textName:this._content}),n=this.getBoxStyle();if(n){Gt(e,n.symbol);var i=this._getBoxSize(e),o=i[1],s=n.padding||this._getDefaultPadding(),a=i[0];e.markerWidth=a.width,e.markerHeight=a.height;var l=e.textDx||0,h=e.textDy||0,u=wo(o,e.textHorizontalAlignment,e.textVerticalAlignment)._add(l,h),c=n.horizontalAlignment||"middle";e.markerDx=u.x,c==="left"?e.markerDx+=e.markerWidth/2-s[0]:c==="right"?e.markerDx-=e.markerWidth/2-o.width-s[0]:e.markerDx+=o.width/2;var f=n.verticalAlignment||"middle";e.markerDy=u.y,f==="top"?e.markerDy+=e.markerHeight/2-s[1]:f==="bottom"?e.markerDy-=e.markerHeight/2-o.height-s[1]:e.markerDy+=o.height/2}this._refreshing=!0,this.updateSymbol(e),delete this._refreshing},t.prototype._getBoxSize=function(e){e.markerType||(e.markerType="square");var n=this.getBoxStyle(),i=this._getTextSize(e),o,s,a=n.padding||this._getDefaultPadding();return o=i.width+a[0]*2,s=i.height+a[1]*2,n.minWidth&&(!o||o<n.minWidth)&&(o=n.minWidth),n.minHeight&&(!s||s<n.minHeight)&&(s=n.minHeight),[new kn(o,s),i]},t}(dm);Ha.mergeOptions(Nk),Ha.registerJSONType("Label");var M2=function(r){return function(t){Et(e,t);function e(){for(var n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];return t.apply(this,Ee([],te(n),!1))||this}return e._hasConnectors=function(n){return!U(n.__connectors)&&n.__connectors.length>0},e._getConnectors=function(n){return n.__connectors},e.prototype.getConnectSource=function(){return this._connSource},e.prototype.setConnectSource=function(n){var i=this._connTarget;return this.onRemove(),this._connSource=n,this._connTarget=i,this.onAdd(),this},e.prototype.getConnectTarget=function(){return this._connTarget},e.prototype.setConnectTarget=function(n){var i=this._connSource;return this.onRemove(),this._connSource=i,this._connTarget=n,this._updateCoordinates(),this._registerEvents(),this},e.prototype._updateCoordinates=function(){var n=this.getMap();if(!n&&this._connSource&&(n=this._connSource.getMap()),!n&&this._connTarget&&(n=this._connTarget.getMap()),!!n&&!(!this._connSource||!this._connTarget)){for(var i=this._connSource._getConnectPoints(),o=this._connTarget._getConnectPoints(),s=0,a=this.getCoordinates(),l,h,u=0,c=i.length;u<c;u++)for(var f=i[u],d=0,p=o.length;d<p;d++){var g=o[d],m=n.computeLength(f,g);u===0&&d===0?(l=f,h=g,s=m):m<s&&(l=f,h=g)}(!on(a)||!a[0].equals(l)||!a[1].equals(h))&&this.setCoordinates([l,h])}},e.prototype.onAdd=function(){this._registerEvents(),this._updateCoordinates()},e.prototype.onRemove=function(){if(this._connSource&&(this._connSource.__connectors&&uc(this,this._connSource.__connectors),this._connSource.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connSource.off("dragstart mousedown mouseover",this._showConnect,this),this._connSource.off("dragend mouseup mouseout",this.hide,this),this._connSource.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connSource),this._connTarget&&(uc(this,this._connTarget.__connectors),this._connTarget.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connTarget.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connTarget),!(this._connSource instanceof en)||!(this._connTarget instanceof en)){var n=this.getMap();n&&n.off("movestart moving moveend zoomstart zooming zoomend rotate pitch fovchange spatialreferencechange",this._updateCoordinates,this)}},e.prototype._showConnect=function(){!this._connSource||!this._connTarget||this._connSource.isVisible()&&this._connTarget.isVisible()&&(this._updateCoordinates(),this.show())},e.prototype._registerEvents=function(){if(!(!this._connSource||!this._connTarget)){this._connSource.__connectors||(this._connSource.__connectors=[]),this._connTarget.__connectors||(this._connTarget.__connectors=[]),this._connSource.__connectors.push(this),this._connTarget.__connectors.push(this),this._connSource.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connTarget.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connSource.on("show",this._showConnect,this).on("hide",this.hide,this),this._connTarget.on("show",this._showConnect,this).on("hide",this.hide,this);var n=this.options.showOn;if(this.hide(),n==="moving"?(this._connSource.on("dragstart",this._showConnect,this).on("dragend",this.hide,this),this._connTarget.on("dragstart",this._showConnect,this).on("dragend",this.hide,this)):n==="click"?(this._connSource.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this),this._connTarget.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this)):n==="mouseover"?(this._connSource.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this),this._connTarget.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this)):this._showConnect(),!(this._connSource instanceof en)||!(this._connTarget instanceof en)){var i=this.getMap();i&&i.on("movestart moving moveend zoomstart zooming zoomend rotate pitch fovchange spatialreferencechange",this._updateCoordinates,this)}}},e}(r)},S2={showOn:"always"},nf=function(r){Et(t,r);function t(e,n,i){var o=r.call(this,null,i)||this;return arguments.length===1&&(i=e,e=null,n=null),o._connSource=e,o._connTarget=n,o}return t}(M2(Pn));nf.mergeOptions(S2),nf.registerJSONType("ConnectorLine");var C2=function(r){Et(t,r);function t(e,n,i){var o=r.call(this,null,i)||this;return arguments.length===1&&(i=e,e=null,n=null),o._connSource=e,o._connTarget=n,o}return t}(M2(tf));C2.mergeOptions(S2),C2.registerJSONType("ArcConnectorLine");function rf(r){return r&&r instanceof en}var Bk={drawImmediate:!1,geometryEvents:!0,geometryEventTolerance:1},P2=[],pm=function(r){Et(t,r);function t(e,n,i){var o=this;n&&!rf(n)&&!Array.isArray(n)&&Z1.indexOf(n.type)<0&&(i=n,n=null),o=r.call(this,e,i)||this,o._maxZIndex=0,o._minZIndex=0,o._initCache(),n&&o.addGeometry(n);var s=o.options.style;return s&&o.setStyle(s),o}return t.prototype.getAltitude=function(){return 0},t.prototype.getGeometryById=function(e){return U(e)||e===""||!this._geoMap[e]?null:this._geoMap[e]},t.prototype.getGeometries=function(e,n){if(!e)return this._geoList.slice(0);for(var i=[],o,s,a=0,l=this._geoList.length;a<l;a++)o=this._geoList[a],n?s=e.call(n,o):s=e(o),s&&i.push(o);return i},t.prototype.getFirstGeometry=function(){return this._geoList.length?this._geoList[0]:null},t.prototype.getLastGeometry=function(){var e=this._geoList.length;return e===0?null:this._geoList[e-1]},t.prototype.getCount=function(){return this._geoList.length},t.prototype.getExtent=function(){if(this.getCount()===0)return null;var e=new gn(this.getProjection());return this.forEach(function(n){e._combine(n.getExtent())}),e},t.prototype.forEach=function(e,n){for(var i=this._geoList.slice(0),o=0,s=i.length;o<s;o++)n?e.call(n,i[o],o):e(i[o],o);return this},t.prototype.filter=function(e,n){var i=[],o=ze(e),s=o?e:ng(e);return this.forEach(function(a){var l=o?a:sg(a);(n?s.call(n,l):s(l))&&i.push(a)},this),i},t.prototype.isEmpty=function(){return!this._geoList.length},t.prototype.addGeometry=function(e,n){if(!e)return this;if(e.type==="FeatureCollection")return this.addGeometry(Ai.toGeometry(e),n);if(Array.isArray(e)){if(e.length===0)return this}else{var i=arguments.length,o=arguments[i-1];return e=Array.prototype.slice.call(arguments,0,i-1),n=o,o&&kr(o)&&("type"in o||rf(o))&&(e.push(o),n=!1),this.addGeometry(e,n)}this._initCache();var s;n&&(s=new gn),this._toSort=this._maxZIndex>0;for(var a=[],l=0,h=e.length;l<h;l++){var u=e[l];if(!(u&&(Ai._isGeoJSON(u)||rf(u))))throw new Error("Invalid geometry to add to layer("+this.getId()+") at index:"+l);if(!(u.getLayer&&u.getLayer()===this)){if(!rf(u)&&(u=en.fromJSON(u),Array.isArray(u)))for(var c=0,f=u.length;c<f;c++)this._add(u[c],s,l),a.push(u[c]);if(!u)throw new Error("Invalid geometry to add to layer("+this.getId()+") at index:"+l);Array.isArray(u)||(this._add(u,s,l),a.push(u))}}var d=this.getMap();if(d&&(this._getRenderer().onGeometryAdd(a),s&&!U(s.xmin))){var p=s.getCenter(),g=d.getFitZoom(s);if(kr(n)){var m=ze(n.step)?n.step:function(){};d.animateTo({center:p,zoom:g},Gt({duration:d.options.zoomAnimationDuration,easing:"out"},n),m)}else n===!0&&d.setCenterAndZoom(p,g)}return this.fire("addgeo",{type:"addgeo",target:this,geometries:e}),this},t.prototype.getGeoMinZIndex=function(){return this._minZIndex},t.prototype.getGeoMaxZIndex=function(){return this._maxZIndex},t.prototype._add=function(e,n,i){this._toSort||(this._toSort=e.getZIndex()!==0),this._updateZIndex(e.getZIndex());var o=e.getId();if(!U(o)){if(!U(this._geoMap[o]))throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+o+", at index:"+i);this._geoMap[o]=e}var s=bo();e._setInternalId(s),this._geoList.push(e),this.onAddGeometry(e),e._bindLayer(this),e.onAdd&&e.onAdd(),n&&n._combine(e.getExtent()),e._fireEvent("add",{layer:this}),this._cookedStyles&&this._styleGeometry(e)},t.prototype.removeGeometry=function(e){if(!Array.isArray(e))return this.removeGeometry([e]);for(var n=e.length-1;n>=0;n--)e[n]instanceof en||(e[n]=this.getGeometryById(e[n])),!(!e[n]||this!==e[n].getLayer())&&e[n].remove();return this.fire("removegeo",{type:"removegeo",target:this,geometries:e}),this},t.prototype.clear=function(){this._clearing=!0,this.forEach(function(i){i.remove()}),this._geoMap={};var e=this._geoList;this._geoList=[];var n=this._getRenderer();return n&&(n.onGeometryRemove(e),n.clearImageData&&(n.clearImageData(),delete n._lastGeosToDraw)),this._clearing=!1,this.fire("clear"),this},t.prototype.onRemoveGeometry=function(e){if(!(!e||this._clearing)&&this===e.getLayer()){var n=e._getInternalId();if(!U(n)){var i=e.getId();U(i)||delete this._geoMap[i];var o=this._findInList(e);o>=0&&this._geoList.splice(o,1),this._getRenderer()&&this._getRenderer().onGeometryRemove([e])}}},t.prototype.getStyle=function(){return this.options.style?this.options.style:null},t.prototype.setStyle=function(e){return this.options.style=e,e=Px(e),this._cookedStyles=Tx(e),this.forEach(function(n){this._styleGeometry(n)},this),this.fire("setstyle",{type:"setstyle",target:this,style:e}),this},t.prototype._styleGeometry=function(e){if(!this._cookedStyles)return!1;for(var n=sg(e),i=0,o=this._cookedStyles.length;i<o;i++)if(this._cookedStyles[i].filter(n)===!0)return e._setExternSymbol(this._cookedStyles[i].symbol),!0;return!1},t.prototype.removeStyle=function(){return this.options.style?(delete this.options.style,delete this._cookedStyles,this.forEach(function(e){e._setExternSymbol(null)},this),this.fire("removestyle"),this):this},t.prototype.onAddGeometry=function(e){var n=this.getStyle();n&&this._styleGeometry(e)},t.prototype.hide=function(){for(var e=0,n=this._geoList.length;e<n;e++)this._geoList[e].onHide();return Rr.prototype.hide.call(this)},t.prototype._initCache=function(){this._geoList||(this._geoList=[],this._geoMap={})},t.prototype._updateZIndex=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];this._maxZIndex=Math.max(this._maxZIndex,Math.max.apply(Math,Ee([],te(e),!1))),this._minZIndex=Math.min(this._minZIndex,Math.min.apply(Math,Ee([],te(e),!1)))},t.prototype._sortGeometries=function(){var e=this;this._toSort&&(this._maxZIndex=0,this._minZIndex=0,this._geoList.sort(function(n,i){return e._updateZIndex(n.getZIndex(),i.getZIndex()),e._compare(n,i)}),this._toSort=!1)},t.prototype._compare=function(e,n){return e.getZIndex()===n.getZIndex()?e._getInternalId()-n._getInternalId():e.getZIndex()-n.getZIndex()},t.prototype._findInList=function(e){var n=this._geoList.length;if(n===0)return-1;this._sortGeometries();for(var i=0,o=n-1,s;i<=o;){if(s=Math.floor((i+o)/2),this._geoList[s]===e)return s;this._compare(this._geoList[s],e)>0?o=s-1:i=s+1}return-1},t.prototype.onGeometryEvent=function(e){return this._onGeometryEvent(e)},t.prototype._onGeometryEvent=function(e){if(!(!e||!e.target)){var n=e.type;n==="idchange"?this._onGeometryIdChange(e):n==="zindexchange"?this._onGeometryZIndexChange(e):n==="positionchange"?this._onGeometryPositionChange(e):n==="shapechange"?this._onGeometryShapeChange(e):n==="symbolchange"?this._onGeometrySymbolChange(e):n==="show"?this._onGeometryShow(e):n==="hide"?this._onGeometryHide(e):n==="propertieschange"&&this._onGeometryPropertiesChange(e)}},t.prototype._onGeometryIdChange=function(e){if(!(e.new===e.old&&this._geoMap[e.old]&&this._geoMap[e.old]===e.target)){if(!U(e.new)){if(this._geoMap[e.new])throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+e.new);this._geoMap[e.new]=e.target}!U(e.old)&&e.new!==e.old&&delete this._geoMap[e.old]}},t.prototype._onGeometryZIndexChange=function(e){e.old!==e.new&&(this._updateZIndex(e.new),this._toSort=!0,this._getRenderer()&&this._getRenderer().onGeometryZIndexChange(e))},t.prototype._onGeometryPositionChange=function(e){this._getRenderer()&&this._getRenderer().onGeometryPositionChange(e)},t.prototype._onGeometryShapeChange=function(e){this._getRenderer()&&this._getRenderer().onGeometryShapeChange(e)},t.prototype._onGeometrySymbolChange=function(e){this._getRenderer()&&this._getRenderer().onGeometrySymbolChange(e)},t.prototype._onGeometryShow=function(e){this._getRenderer()&&this._getRenderer().onGeometryShow(e)},t.prototype._onGeometryHide=function(e){this._getRenderer()&&this._getRenderer().onGeometryHide(e)},t.prototype._onGeometryPropertiesChange=function(e){this._getRenderer()&&this._getRenderer().onGeometryPropertiesChange(e)},t.prototype._hasGeoListeners=function(e){if(!e)return!1;Array.isArray(e)||(P2[0]=e,e=P2);for(var n=this.getGeometries()||[],i=0,o=n.length;i<o;i++){var s=n[i];if(s){if(s.options.cursor)return!0;for(var a=0,l=e.length;a<l;a++){var h=e[a],u=s.listens(h);if(u>0)return!0}}}return!1},t.prototype._getRenderer=function(){return r.prototype._getRenderer.call(this)},t}(Rr);pm.mergeOptions(Bk);var jk=new Ce,Vk={debug:!1,enableSimplify:!0,defaultIconSize:[20,20],cacheVectorOnCanvas:!0,cacheSvgOnCanvas:be.gecko,enableAltitude:!1,altitudeProperty:"altitude",drawAltitude:!1,sortByDistanceToCamera:!1,roundPoint:!1,altitude:0,clipBBoxBufferSize:3,collision:!1,collisionBufferSize:2,collisionDelay:250,collisionScope:"layer",progressiveRender:!1,progressiveRenderCount:1e3,progressiveRenderDebug:!1},ro=function(r){Et(t,r);function t(e,n,i){var o=r.call(this,e,n,i)||this;return o.isVectorLayer=!0,o}return t.prototype.onConfig=function(e){if(r.prototype.onConfig.call(this,e),!U(e.enableAltitude))for(var n=this.getGeometries()||[],i=0,o=n.length;i<o;i++){var s=n[i];s&&(s._clearAltitudeCache(),s.fire("positionchange"))}if(e.enableAltitude||e.drawAltitude||e.altitudeProperty){var a=this.getRenderer();a&&a.setToRedraw&&a.setToRedraw()}},t.prototype.identify=function(e,n){n=n||{};var i=this.getRenderer();e instanceof at||(e=new at(e));var o=this.getMap().coordToContainerPoint(e);return n.onlyVisible&&i&&i.identifyAtPoint?i.identifyAtPoint(o,n):this._hitGeos(this._geoList,o,n)},t.prototype.identifyAtPoint=function(e,n){n=n||{};var i=this.getRenderer();return e instanceof W||(e=new W(e)),n.onlyVisible&&i&&i.identifyAtPoint?i.identifyAtPoint(e,n):this._hitGeos(this._geoList,e,n)},t.prototype._hitGeos=function(e,n,i){if(i===void 0&&(i={}),!e||!e.length)return[];var o=i.filter,s=[],a=i.tolerance,l=this.getMap(),h=this.getRenderer(),u=h&&h.getImageData&&h.getImageData();if(u){var c=0,f=h.maxTolerance;if(It(f))c=f;else for(var d=e.length-1;d>=0;d--){var p=e[d]._hitTestTolerance()+(a||0);p>c&&(c=p)}var g=l.getDevicePixelRatio();u.r=g;for(var m=!1,y=n.x-c,x=n.y-c,d=-c;d<=c;d++){for(var v=-c;v<=c;v++){var _=Math.round((y+d)*g),w=Math.round((x+v)*g),b=w*u.width*4+_*4;if(u.data[b+3]>0){m=!0;break}}if(m)break}if(!m)return s}for(var A=i.onlyVisible,d=e.length-1;d>=0;d--){var T=e[d];if(!(!T||!T.options.interactive)&&!(!A&&!T.isVisible())){var S=T._getPainter();if(S){var M=S.getRenderBBOX&&S.getRenderBBOX();if(M){var _=n.x,w=n.y;if(_<M[0]||w<M[1]||_>M[2]||w>M[3])continue}if(!(T instanceof Pn)||!T._getArrowStyle()&&!(T instanceof zh)){var E=T.getContainerExtent(jk);if(a&&(E=E._expand(a)),!E||!E.contains(n))continue}if(T._containsPoint(n,a)&&(!o||o(T))&&(s.push(T),i.count&&s.length>=i.count))break}}}return s},t.prototype.getAltitude=function(){return this.options.altitude||0},t.prototype.toJSON=function(e){e||(e={clipExtent:null,geometries:null});var n={type:this.getJSONType(),id:this.getId(),options:this.config()};if(U(e.geometries)||e.geometries){var i=void 0;if(e.clipExtent){var o=this.getMap(),s=o?o.getProjection():null;i=new gn(e.clipExtent,s)}for(var a=[],l=this.getGeometries(),h=0,u=l.length;h<u;h++){var c=l[h],f=c.getExtent();if(!(!f||i&&!i.intersects(f))){var d=c.toJSON(e.geometries);a.push(d)}}n.geometries=a}return n},t.prototype.getRenderer=function(){return r.prototype.getRenderer.call(this)},t.fromJSON=function(e){if(!e||e.type!=="VectorLayer")return null;for(var n=new t(e.id,e.options),i=e.geometries,o=[],s=0;s<i.length;s++){var a=en.fromJSON(i[s]);a&&o.push(a)}return n.addGeometry(o),n},t.getPainterClass=function(){return lm},t.getCollectionPainterClass=function(){return e2},t}(pm);ro.mergeOptions(Vk),ro.registerJSONType("VectorLayer");var of="_map_tool",E2=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.addTo=function(e){return e?(this._map=e,e[of]&&e[of].disable(),this.onAdd&&this.onAdd(),this.enable(),e[of]=this,this._fireEvent("add"),this):this},t.prototype.getMap=function(){return this._map},t.prototype.enable=function(){var e=this._map;return!e||this._enabled?this:(this._enabled=!0,this._switchEvents("off"),this._registerEvents(),this.onEnable&&this.onEnable(),this._fireEvent("enable"),this)},t.prototype.disable=function(){return!this._enabled||!this._map?this:(this._enabled=!1,this._switchEvents("off"),this.onDisable&&this.onDisable(),this._fireEvent("disable"),this)},t.prototype.isEnabled=function(){return!!this._enabled},t.prototype.remove=function(){return this._map?(this.disable(),this._map&&(delete this._map[of],delete this._map),this._fireEvent("remove"),this):this},t.prototype._registerEvents=function(){this._switchEvents("on")},t.prototype._switchEvents=function(e){var n=this.getEvents();n&&this._map[e](n,this)},t.prototype._fireEvent=function(e,n){n||(n={}),this.fire(e,n)},t}(to(hi)),Gk={symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:.3},doubleClickZoom:!1,mode:null,once:!1,autoPanAtEdge:!1,ignoreMouseleave:!0,blockGeometryEvents:!1,zIndex:Number.MAX_VALUE,enableAltitude:!0,interactive:!0,transformCoordinate:null},O2={},gr=function(r){Et(t,r);function t(e){var n=r.call(this,e)||this;return n._checkMode(),n._events={click:n._clickHandler,"mousemove touchmove":n._mouseMoveHandler,dblclick:n._doubleClickHandler,"mousedown touchstart":n._mouseDownHandler,"mouseup touchend":n._mouseUpHandler,mousemove:n._mouseMoveHandler,mousedown:n._mouseDownHandler,mouseup:n._mouseUpHandler},n}return t.registerMode=function(e,n){O2[e.toLowerCase()]=n},t.getRegisterMode=function(e){return O2[e.toLowerCase()]},t.prototype.getMode=function(){return this.options.mode?this.options.mode.toLowerCase():null},t.prototype.setMode=function(e){return this._geometry&&(this._geometry.remove(),delete this._geometry),this._clearStage(),this._switchEvents("off"),this.options.mode=e,this._checkMode(),this.isEnabled()&&(this._switchEvents("on"),this._restoreMapCfg(),this._saveMapCfg()),this},t.prototype.getSymbol=function(){var e=this.options.symbol;return Bi(e||this.options.symbol)},t.prototype.setSymbol=function(e){return e?(this.options.symbol=e,this._geometry&&this._geometry.setSymbol(e),this):this},t.prototype.getCurrentGeometry=function(){return this._geometry},t.prototype.onAdd=function(){this._checkMode()},t.prototype.onEnable=function(){this._saveMapCfg(),this._drawToolLayer=this._getDrawLayer(),this._clearStage(),this._loadResources();var e=this.getMap();return this.options.autoPanAtEdge&&(this._mapAutoPanAtEdge=e.options.autoPanAtEdge,this._mapAutoPanAtEdge||e.config({autoPanAtEdge:!0})),this._geometryEvents=e.options.geometryEvents,this.options.blockGeometryEvents&&e.config("geometryEvents",!1),this},t.prototype.onDisable=function(){var e=this.getMap();return this._restoreMapCfg(),this.endDraw({ignoreEndEvent:!0}),this._map&&(e.removeLayer(this._getDrawLayer()),this.options.autoPanAtEdge&&(this._mapAutoPanAtEdge||e.config({autoPanAtEdge:!1}))),this.options.blockGeometryEvents&&e.config("geometryEvents",this._geometryEvents),this},t.prototype.undo=function(){var e=this._getRegisterMode(),n=e.action;if(!this._shouldRecordHistory(n)||!this._historyPointer)return this;var i=this._clickCoords.slice(0,--this._historyPointer);return e.update(this.getMap().getProjection(),i,this._geometry),this},t.prototype.redo=function(){var e=this._getRegisterMode(),n=e.action;if(!this._shouldRecordHistory(n)||U(this._historyPointer)||this._historyPointer===this._clickCoords.length)return this;var i=this._clickCoords.slice(0,++this._historyPointer);return e.update(this.getMap().getProjection(),i,this._geometry),this},t.prototype._shouldRecordHistory=function(e){return Array.isArray(e)&&e[0]==="click"&&e[1]==="mousemove"&&e[2]==="dblclick"},t.prototype._checkMode=function(){this._getRegisterMode()},t.prototype._saveMapCfg=function(){var e=this.getMap();this._mapDoubleClickZoom=e.options.doubleClickZoom,e.config({doubleClickZoom:this.options.doubleClickZoom});for(var n=this._getRegisterMode().action,i=!1,o=0;o<n.length;o++)if(n[o].indexOf("mousedown")>=0||n[o].indexOf("touchstart")>=0){i=!0;break}if(i){var s=this.getMap();this._mapDraggable=s.options.draggable,s.config({draggable:!1})}},t.prototype._restoreMapCfg=function(){var e=this.getMap();e.config({doubleClickZoom:this._mapDoubleClickZoom}),U(this._mapDraggable)||e.config("draggable",this._mapDraggable),delete this._mapDraggable,delete this._mapDoubleClickZoom},t.prototype._loadResources=function(){var e=this.getSymbol(),n=yh(e);n.length>0&&this._drawToolLayer._getRenderer().loadResources(n)},t.prototype._getProjection=function(){return this._map.getProjection()},t.prototype._getRegisterMode=function(){var e=this.getMode(),n=t.getRegisterMode(e);if(!n)throw new Error(e+" is not a valid mode of DrawTool.");return n},t.prototype.getEvents=function(){var e=this._getRegisterMode().action,n={};if(Array.isArray(e)){for(var i=0;i<e.length;i++)n[e[i]]=this._events[e[i]];return n}return null},t.prototype._mouseDownHandler=function(e){this._createGeometry(e)},t.prototype._mouseUpHandler=function(e){this.endDraw(e)},t.prototype._clickHandler=function(e){if(!this.options.interactive)return this;e.enableAltitude=this.options.enableAltitude;var n=this.getMap(),i=this._getRegisterMode();if(this._clickCoords&&this._clickCoords.length){var o=this._clickCoords.length,s=n._pointToPrj(e.point2d);if(this._clickCoords[o-1].equals(s))return}if(!this._geometry)this._createGeometry(e);else{var s=n._pointToPrj(e.point2d);U(this._historyPointer)||(this._clickCoords=this._clickCoords.slice(0,this._historyPointer));var a=this._geometry.snapTo;if(a&&ze(a)){var l=this._getSnapResult(a,e.containerPoint);if(s=l.prjCoord,this._clickCoords=this._clickCoords.concat(l.effectedVertex),this._clickCoords[this._clickCoords.length-1].equals(s))return}if(this._clickCoords.push(s),this._historyPointer=this._clickCoords.length,e.drawTool=this,i.update(n.getProjection(),this._clickCoords,this._geometry,e),this.getMode()==="point"){this.endDraw(e);return}this._clickCoords.length<=1?this._fireEvent("drawstart",e):this._fireEvent("drawvertex",e),i.clickLimit&&i.clickLimit===this._historyPointer&&this.endDraw(e)}},t.prototype._createGeometry=function(e){var n=this.getMode(),i=this.getMap(),o=this._getRegisterMode(),s=i._pointToPrj(e.point2d),a=this.getSymbol();if(!this._geometry){this._fireEvent("drawprepare",e),this._clickCoords=[s],e.drawTool=this,this._geometry=o.create(this.getMap().getProjection(),this._clickCoords,e),a&&n!=="point"?this._geometry.setSymbol(a):this.options.hasOwnProperty("symbol")&&this._geometry.setSymbol(this.options.symbol),this._addGeometryToStage(this._geometry),this._fireEvent("drawstart",e);var l=this._geometry.snapTo;if(l&&ze(l)){var h=this._getSnapResult(l,e.containerPoint),u=this.getMap();if(u&&h){var c=h.prjCoord;this._clickCoords=[c],o.update(u.getProjection(),this._clickCoords,this._geometry,e)}}}n==="point"&&e.type!=="mousemove"&&this.endDraw(e)},t.prototype._mouseMoveHandler=function(e){if(!this.options.interactive)return this;e.enableAltitude=this.options.enableAltitude;var n=this.getMap();if(!(!n||n.isInteracting())){if(this.getMode()==="point"&&!this._geometry){this._createGeometry(e);return}if(this._geometry){var i=this._getMouseContainerPoint(e);if(this._isValidContainerPoint(i)){var o=n._pointToPrj(e.point2d),s=[],a=this._geometry.snapTo;if(a&&ze(a)){var l=this._getSnapResult(a,i);o=l.prjCoord,s=l.effectedVertex}var h=n.getProjection();e.drawTool=this;var u=this._getRegisterMode();if(this._shouldRecordHistory(u.action)){var c=this._clickCoords.slice(0,this._historyPointer);if(c&&c.length>0&&o.equals(c[c.length-1]))return;u.update(h,c.concat(s,[o]),this._geometry,e)}else u.update(h,o,this._geometry,e);this._fireEvent("mousemove",e)}}}},t.prototype._doubleClickHandler=function(e){if(!this.options.interactive)return this;if(e.enableAltitude=this.options.enableAltitude,!!this._geometry){var n=this._getMouseContainerPoint(e);if(this._isValidContainerPoint(n)){var i=this._getRegisterMode(),o=this._clickCoords;if(!(!o||o.length<2)){var s=this.getMode();if(!(s&&s.indexOf("polygon")>-1&&o.length<3)){for(var a=this.getMap().getProjection(),l=[o[0]],h=1,u=o.length;h<u;h++)(o[h].x!==o[h-1].x||o[h].y!==o[h-1].y)&&l.push(o[h]);l.length<2||this._geometry&&this._geometry instanceof _n&&l.length<3||(e.drawTool=this,i.update(a,l,this._geometry,e),this.endDraw(e))}}}}},t.prototype._addGeometryToStage=function(e){var n=this._getDrawLayer();n.addGeometry(e)},t.prototype.endDraw=function(e){if(!this._geometry||this._ending)return this;this._ending=!0;var n=this._geometry;return this._clearStage(),e=e||{},this._geometry=n,e.ignoreEndEvent||this._fireEvent("drawend",e),delete this._geometry,this.options.once&&this.disable(),delete this._ending,delete this._historyPointer,this._vertexes&&(this._vertexes=[]),this},t.prototype._clearStage=function(){this._getDrawLayer().clear(),delete this._geometry,delete this._clickCoords},t.prototype._getMouseContainerPoint=function(e){var n=this._getRegisterMode().action;return(n[0].indexOf("mousedown")>=0||n[0].indexOf("touchstart")>=0)&&jr(e.domEvent),e.containerPoint},t.prototype._isValidContainerPoint=function(e){var n=this._map.getSize(),i=n.width,o=n.height;return e.x<0||e.y<0?!1:!(e.x>i||e.y>o)},t.prototype._getSnapResult=function(e,n){var i=this.getMap(),o=[];if(this.options.edgeAutoComplete){var s=this._clickCoords[(this._historyPointer||1)-1];o.push(i.prjToContainerPoint(s));var a=this._clickCoords[(this._historyPointer||1)-2];a&&o.push(i.prjToContainerPoint(a))}var l=e(n,o);n=(l.effectedVertex?l.point:l)||n;var h=i._containerPointToPrj(n);return l.effectedVertex&&(l.effectedVertex=l.effectedVertex.map(function(u){return i._containerPointToPrj(u)})),{prjCoord:h,effectedVertex:l.effectedVertex||[]}},t.prototype._getDrawLayer=function(){var e=dh+"drawtool",n=this._map.getLayer(e);return n||(n=new ro(e,{enableSimplify:!1,enableAltitude:this.options.enableAltitude,zIndex:this.options.zIndex}),this._map.addLayer(n)),this._pushLayers(n),n},t.prototype._fireEvent=function(e,n){n||(n={}),n=Gt({},n),this._geometry&&(n.geometry=this._getRegisterMode().generate(this._geometry,{drawTool:this}),n.tempGeometry=this._geometry),E2.prototype._fireEvent.call(this,e,n)},t.prototype._pushLayers=function(e){var n=this;return e?(Array.isArray(e)||(e=[e]),this._layers=this._layers||[],e.forEach(function(i){n._layers.indexOf(i)===-1&&n._layers.push(i)}),this):this},t.prototype._outLayers=function(e){var n=this;return e?(Array.isArray(e)||(e=[e]),this._layers=this._layers||[],e.forEach(function(i){for(var o=0,s=n._layers.length;o<s;o++)if(i===n._layers[o]){n._layers.splice(o,1);break}}),this):this},t.prototype.setLayerZIndex=function(e){return It(e)?(this.options.zIndex=e,this._layers=this._layers||[],this._layers.forEach(function(n){n&&n.setZIndex&&n.setZIndex(e)}),this):this},t.prototype.addCoordinate=function(e){if(!this.isEnabled())return this;var n=this.getMap();if(!n)return this;e=new at(e);var i=n._parseEventFromCoord(e);return this._clickHandler(i),this},t.prototype.getTempGeometry=function(){return this._geometry},t}(E2);gr.mergeOptions(Gk);var Uk=function(r){Et(t,r);function t(e){var n=r.call(this,e)||this;return n.drawTool=new gr({mode:"boxZoom",ignoreMouseleave:!1}),n}return t.prototype.addHooks=function(){this.target.on("_mousedown",this._onMouseDown,this)},t.prototype.removeHooks=function(){this.target.off("_mousedown",this._onMouseDown,this),this.drawTool.isEnabled()&&this.drawTool.remove()},t.prototype._onMouseDown=function(e){this.target.options.boxZoom&&e.domEvent.shiftKey&&this.drawTool.setSymbol(this.target.options.boxZoomSymbol).on("drawend",this._boxZoom,this).addTo(this.target)},t.prototype._boxZoom=function(e){var n=this.target;this.drawTool.remove();var i=e.geometry,o=i.getCenter(),s=i.getSymbol(),a=s.markerWidth,l=s.markerHeight,h=new gn(o,n.locateByPoint(o,a,l),n.getProjection()),u=n.getFitZoom(h);n._animateTo({center:h.getCenter(),zoom:u})},t}(ji);xe.mergeOptions({boxZoom:!0,boxZoomSymbol:{markerType:"rectangle",markerLineWidth:3,markerLineColor:"#1bbc9b",markerLineDasharray:[10,5],markerFillOpacity:.1,markerFill:"#1bbc9b",markerWidth:1,markerHeight:1}}),xe.addOnLoadHook("addHandler","boxZoom",Uk);var ts=30,$k=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.addHooks=function(){this.target&&this.target.on("_mousemove",this._onMouseMove,this)},t.prototype.removeHooks=function(){this.target&&this.target.off("_mousemove",this._onMouseMove,this)},t.prototype._onMouseMove=function(e){var n=this.target;if(n.options.autoPanAtEdge){var i=e.containerPoint,o=n.getContainerExtent();if(o){var s=i.x,a=i.y,l=o.xmax,h=o.ymax,u=void 0;s<ts&&(u=[Math.abs(s-ts),0]),a<ts&&(u=[0,Math.abs(a-ts)]),s+ts>l&&(u=[-Math.abs(s+ts-l),0]),a+ts>h&&(u=[0,-Math.abs(a+ts-h)]),u&&n.panBy(u,{duration:1})}}},t}(ji);xe.mergeOptions({autoPanAtEdge:!1}),xe.addOnLoadHook("addHandler","autoPanAtEdge",$k),xe.include({animateTo:function(r,t,e){var n=this;t===void 0&&(t={}),r=Gt({},this.getView(),r),this._validateView(r),ze(t)&&(e=t,t={});var i=this.getProjection(),o=this.getView(),s={},a=!0;for(var l in r)if(ga(r,l)&&!U(r[l])&&(l==="prjCenter"||!U(o[l])))if(a=!1,l==="center"){var h=new at(o[l]),u=new at(r[l]);h.equals(u)||(s.center=[h,u])}else if(l==="prjCenter"){var h=new at(this._getPrjCenter()),u=new at(r[l]);h.equals(u)||(s.prjCenter=[h,u])}else o[l]!==r[l]&&l!=="around"&&(s[l]=[o[l],r[l]]);if(a)return null;this._animPlayer&&(this._isInternalAnimation?this._animPlayer.playState==="running"&&(this._animPlayer.pause(),this._prevAnimPlayer=this._animPlayer):(delete this._prevAnimPlayer,this._stopAnim(this._animPlayer)));var c=r.around||null,f=this._getRenderer(),d=function(g){f.callInNextFrame(g)},p=this._animPlayer=pr.animate(s,{easing:t.easing||"out",duration:t.duration||this.options.zoomAnimationDuration,framer:d,repeat:t.repeat},function(g){if(n.isRemoved()){p.finish();return}if(p.playState==="running"){if(g.styles.center){var m=g.styles.center;n._setPrjCenter(i.project(m)),n.onMoving(n._parseEventFromCoord(n.getCenter()))}else if(g.styles.prjCenter){var m=g.styles.prjCenter;n._setPrjCenter(m),n.onMoving(n._parseEventFromCoord(n.getCenter()))}U(g.styles.zoom)||n.onZooming(g.styles.zoom,c),U(g.styles.pitch)||n._setPitch(g.styles.pitch),U(g.styles.bearing)||n._setBearing(g.styles.bearing),n._fireEvent("animating")}else(p.playState!=="paused"||p===n._mapAnimPlayer)&&(p._interupted||(s.center?n._setPrjCenter(i.project(s.center[1])):s.prjCenter&&n._setPrjCenter(s.prjCenter[1]),U(s.pitch)||n._setPitch(s.pitch[1]),U(s.bearing)||n._setBearing(s.bearing[1])),n._endAnim(p,s,c,t));e&&e(g)},this);return this._startAnim(s,c),p},_animateTo:function(r,t,e){return t===void 0&&(t={}),this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._isInternalAnimation=!0,this._mapAnimPlayer=this.animateTo(r,t,e),delete this._isInternalAnimation,this._mapAnimPlayer},flyTo:function(r,t,e){var n=this;t===void 0&&(t={}),r=Gt({},this.getView(),r),this._validateView(r),this._animPlayer&&(this._isInternalAnimation?this._animPlayer.playState==="running"&&(this._animPlayer.pause(),this._prevAnimPlayer=this._animPlayer):(delete this._prevAnimPlayer,this._stopAnim(this._animPlayer))),ze(t)&&(e=t,t={}),t=Gt({curve:1.42},t);var i=this;function o(rt,Rt){return i.getResolution(Rt)/i.getResolution(rt)}var s=r.around||new W(this.width/2,this.height/2),a=this.getMinZoom(),l=this.getMaxZoom(),h=this.getProjection(),u=this.getView(),c=u.zoom,f=u.bearing,d=u.pitch,p="zoom"in r?fc(+r.zoom,a,l):c,g="bearing"in r?+r.bearing:f,m="pitch"in r?+r.pitch:d,y=h.project(r.center&&new at(r.center)||this.getCenter()),x=o(p,c),v=h.project(this.getCenter()),_=y.sub(v),w=t.curve,b=Math.max(this.width,this.height),A=b/x,T=_.mag();if("minZoom"in t){var S=fc(Math.min(t.minZoom,c,p),a,l),M=b/o(S,c);w=Math.sqrt(M/T*2)}var E=w*w;function P(rt){var Rt=(A*A-b*b+(rt?-1:1)*E*E*T*T)/(2*(rt?A:b)*E*T);return Math.log(Math.sqrt(Rt*Rt+1)-Rt)}function k(rt){return(Math.exp(rt)-Math.exp(-rt))/2}function O(rt){return(Math.exp(rt)+Math.exp(-rt))/2}function I(rt){return k(rt)/O(rt)}var D=P(0),z=function(rt){return O(D)/O(D+w*rt)},L=function(rt){return b*((O(D)*I(D+w*rt)-k(D))/E)/T},$=(P(1)-D)/w;if(Math.abs(T)<1e-6||!isFinite($)){if(Math.abs(b-A)<1e-6)return this.animateTo(r,t,e);var Z=A<b?-1:1;$=Math.abs(Math.log(A/b))/w,L=function(){return 0},z=function(rt){return Math.exp(Z*w*rt)}}var j=this._getRenderer(),st=function(rt){j.callInNextFrame(rt)},lt=this._animPlayer=pr.animate({k:[0,1]},{easing:t.easing||"out",duration:t.duration||8,framer:st},function(rt){if(n.isRemoved()){lt.finish();return}var Rt=rt.styles.k,Ht=Rt*$,ee=1/z(Ht),nt={};if(r.center){var Dt=Rt===1?y:v.add(_.multi(L(Ht)));nt.prjCenter=[y,Dt]}if(c!==p){var Vt=Rt===1?p:n.getZoomForScale(ee,c,!0);nt.zoom=[c,Vt]}if(d!==m){var Ct=k2(d,m,Rt);nt.pitch=[m,Ct]}if(f!==g){var _e=k2(f,g,Rt);nt.bearing=[g,_e]}if(lt.playState==="running"){if(nt.prjCenter){var Ie=nt.prjCenter;n._setPrjCenter(Ie[1]),n.onMoving(n._parseEventFromCoord(n.getCenter()))}nt.zoom&&n.onZooming(nt.zoom[1],s),nt.pitch&&n._setPitch(nt.pitch[1]),nt.bearing&&n._setBearing(nt.bearing[1]),n._fireEvent("animating")}else(lt.playState!=="paused"||lt===n._mapAnimPlayer)&&(lt._interupted||(nt.prjCenter&&n._setPrjCenter(nt.prjCenter[1]),nt.pitch&&n._setPitch(nt.pitch[1]),nt.bearing&&n._setBearing(nt.bearing[1])),n._endAnim(lt,nt,s,t));e&&e(rt)},{});return this._startAnim({center:r.center,zoom:r.zoom!==c,pitch:m!==d,bearing:g!==f},s),this},isAnimating:function(){return!!this._animPlayer},isRotating:function(){return this.isDragRotating()||!!this._animRotating},_endAnim:function(r,t,e,n){delete this._animRotating;var i=r._interupted?"animateinterrupted":"animateend";if(r===this._animPlayer&&delete this._animPlayer,r===this._mapAnimPlayer&&delete this._mapAnimPlayer,t.center){var o=void 0;r._interupted?o=this.getCenter():o=t.center[1],this.onMoveEnd(this._parseEventFromCoord(o))}else if(t.prjCenter){var o=void 0;r._interupted?o=this._getPrjCenter():o=t.prjCenter[1];var s=this._parseEventFromCoord(this.getProjection().unproject(o));s.point2d=this._prjToPoint(o),this.onMoveEnd(s)}U(t.zoom)||(r._interupted?this.onZoomEnd(this.getZoom()):n.wheelZoom?this.onZooming(t.zoom[1],e):this.onZoomEnd(t.zoom[1])),i&&this._fireEvent(i),!U(t.pitch)&&!this.getPitch()&&this.getRenderer().setToRedraw(),n.wheelZoom||this._resumePrev(r)},_startAnim:function(r,t){this._animPlayer&&((r.center||r.prjCenter)&&this.onMoveStart(),r.zoom&&!this.isZooming()&&this.onZoomStart(r.zoom[1],t),(r.pitch||r.bearing)&&(this._animRotating=!0),this._fireEvent("animatestart"),this._animPlayer.play())},_stopAnim:function(r){r&&(delete this._animRotating,r.playState!=="finished"&&(r._interupted=!0,r.cancel()),r===this._animPlayer&&delete this._animPlayer,r===this._mapAnimPlayer&&delete this._mapAnimPlayer)},_resumePrev:function(r){if(this._prevAnimPlayer){var t=this._prevAnimPlayer;t.playState!=="paused"&&delete this._prevAnimPlayer,r!==t&&(this._animPlayer=t,t.play())}}});function k2(r,t,e){return r*(1-e)+t*e}function I2(r){r.stopPropagation(),r.preventDefault()}var R2=["dragstart","dragenter","dragend","dragleave","dragover"].join(" ").toString(),D2="mousedown mouseup mouseover mouseout mouseenter mouseleave mousemove click dblclick contextmenu keypress touchstart touchmove touchend drop ";xe.include({_registerDomEvents:function(){var r=this._panels.mapWrapper||this._containerDOM;Hi(r,D2,this._handleDOMEvent,this),Hi(r,R2,I2,this)},_removeDomEvents:function(){var r=this._panels.mapWrapper||this._containerDOM;ks(r,D2,this._handleDOMEvent),ks(r,R2,I2)},_handleDOMEvent:function(r){if(r&&r.type==="drop"){r.stopPropagation(),r.preventDefault();var t=this._parseEvent(r,r.type);t=Gt({},t,{dataTransfer:r.dataTransfer}),this._fireEvent(r.type,t);return}var e=this.options.clickTimeThreshold,n=r.type;if(!(Mc(n)&&!Li.isTest&&ax(this,this.options.mousemoveThrottleTime))){var i=n==="mousedown"||n==="touchstart"&&(!r.touches||r.touches.length===1);i&&(this._domMouseDownTime=Qe(),this._domMouseDownView=this.getView());var o=n==="contextmenu"&&Wk(this);if(n==="contextmenu"){Qi(r);var s=this._domMouseDownTime,a=Qe();a-s<=e&&!o&&this._fireDOMEvent(this,r,"dom:"+r.type)}else this._fireDOMEvent(this,r,"dom:"+r.type);if(!(this._ignoreEvent(r)||this._isEventOutMap(r))){var l=!1;if(i)this._mouseDownTime=Qe();else if(n==="click"||n==="touchend"||n==="contextmenu")if(this._mouseDownTime){var s=this._mouseDownTime;delete this._mouseDownTime;var a=Qe();if(a-s>e){if(n==="click"||n==="contextmenu")return}else if(n==="contextmenu"){if(o)return}else n==="touchend"&&(l=!0)}else return;var h;l&&(this._clickTime&&Qe()-this._clickTime<=e?(delete this._clickTime,h="dblclick",this._fireDOMEvent(this,r,"dom:dblclick")):(this._clickTime=Qe(),h="click",this._fireDOMEvent(this,r,"dom:click"))),!(this._ignoreEvent(r)||this._isEventOutMap(r))&&(this._fireDOMEvent(this,r,n),h&&this._fireDOMEvent(this,r,h))}}},_ignoreEvent:function(r){if(!r||!this._panels.control)return!1;var t=r.srcElement||r.target,e;if(t)for(;t&&t!==this._containerDOM;){if(t.className&&t.className.indexOf&&(t.className.indexOf("maptalks-control")>=0||t.className.indexOf("maptalks-ui")>=0&&e&&!e.eventsPropagation))return!0;e=t,t=t.parentNode}return!1},_isEventOutMap:function(r){if(this.getPitch()>this.options.maxVisualPitch){var t=this._getActualEvent(r),e=li(t,this._containerDOM);if(!this.getContainerExtent().contains(e))return!0}return!1},_wrapTerrainData:function(r){r.containerPoint&&!r.terrain&&(r.terrain=this._queryTerrainInfo(r.containerPoint))},_parseEvent:function(r,t){if(!r)return null;var e={domEvent:r};if(t!=="keypress"){var n=this._getActualEvent(r);if(n&&n.clientX!==void 0){var i=li(n,this._containerDOM);e=Gt(e,{containerPoint:i,viewPoint:this.containerPointToViewPoint(i)});var o=this.options.maxVisualPitch;(this.getPitch()<=o||i.y>=this.height-this._getVisualHeight(o))&&(e=Gt(e,{coordinate:this.containerPointToCoord(i),point2d:this._containerPointToPoint(i)}))}}return this._wrapTerrainData(e),e},_parseEventFromCoord:function(r){var t=this.coordToContainerPoint(r),e=this.containerPointToViewPoint(t),n={coordinate:r,containerPoint:t,viewPoint:e,point2d:this.coordToPoint(r)};return n},_getActualEvent:function(r){return r=r,r.touches&&r.touches.length>0?r.touches[0]:r.changedTouches&&r.changedTouches.length>0?r.changedTouches[0]:r},_fireDOMEvent:function(r,t,e){var n=this;if(!this.isRemoved()){var i=this._parseEvent(t,e);this._wrapTerrainData(i),Mc(e)?this.getRenderer().callInNextFrame(function(){if(i.domEvent&&i.domEvent._cancelBubble){n._fireEvent("_"+e,i);return}n._fireEvent(e,i)}):this._fireEvent(e,i)}},_getEventParams:function(r){var t=this,e={domEvent:r},n=r.touches&&r.touches.length>0?r.touches[0]:r.changedTouches&&r.changedTouches.length>0?r.changedTouches[0]:r;if(n){var i=li(n,t.getContainer());e.coordinate=t.containerPointToCoordinate(i),e.containerPoint=i,e.viewPoint=t.containerPointToViewPoint(i),e.point2d=t._containerPointToPoint(i)}return this._wrapTerrainData(e),e}}),xe.addOnLoadHook("_registerDomEvents");function Wk(r){if(!r._domMouseDownView)return!0;var t=r.getView(),e=r._domMouseDownView;return t.bearing!==e.bearing||t.pitch!==e.pitch}xe.include({isFullScreen:function(){var r=document;return!!(r.webkitIsFullScreen||r.mozFullScreen||r.msFullscreenElement||r.fullscreenElement)},requestFullScreen:function(r){return this._fireEvent("fullscreenstart"),this._requestFullScreen(r||this._containerDOM),this._fireEvent("fullscreenend"),this},cancelFullScreen:function(){return this._cancelFullScreen(),this._fireEvent("cancelfullscreen"),this},_requestFullScreen:function(r){if(r.requestFullscreen)r.requestFullscreen();else if(r.mozRequestFullScreen)r.mozRequestFullScreen();else if(r.webkitRequestFullScreen)r.webkitRequestFullScreen();else if(r.msRequestFullScreen)r.msRequestFullScreen();else{var t="fullscreen=1,status=no,resizable=yes,top=0,left=0,scrollbars=no,titlebar=no,menubar=no,location=no,toolbar=no,z-look=yes,width="+(screen.availWidth-8)+",height="+(screen.availHeight-45),e=window.open(location.href,"_blank",t);e!==null&&(window.opener=null,window.close())}},_cancelFullScreen:function(){var r=document;if(document.exitFullscreen)document.exitFullscreen();else if(r.mozCancelFullScreen)r.mozCancelFullScreen();else if(r.webkitCancelFullScreen)r.webkitCancelFullScreen();else{var t="fullscreen=no,status=yes,resizable=yes,scrollbars=no,titlebar=no,menubar=yes,location=yes,toolbar=yes,z-look=yes",e=window.open(location.href,"_blank",t);e!==null&&(window.opener=null,window.close())}}}),xe.include({panTo:function(r,t,e){if(t===void 0&&(t={}),!r)return this;if(ze(t)&&(e=t,t={}),r=new at(r),typeof t.animation>"u"||t.animation){var n=this.getProjection().project(r);return this._panAnimation(n,t.duration,e)}else this.setCenter(r);return this},_panTo:function(r,t){return t===void 0&&(t={}),typeof t.animation>"u"||t.animation?this._panAnimation(r,t.duration):(this.onMoveStart(),this._setPrjCenter(r),this.onMoveEnd(this._parseEventFromCoord(this.getCenter())),this)},panBy:function(r,t,e){if(t===void 0&&(t={}),!r)return this;ze(t)&&(e=t,t={}),r=new W(r);var n=this.getContainerExtent(),i=n.ymin;if(i>0&&r.y>30){var o=r.y;r.y=30,r.x=r.x*30/o,console.warn("offset is limited to panBy when pitch is above maxPitch")}if(typeof t.animation>"u"||t.animation){r=r.multi(-1);var s=this._containerPointToPrj(new W(this.width/2+r.x,this.height/2+r.y));this._panAnimation(s,t.duration,e)}else{this.onMoveStart(),this._offsetCenterByPixel(r);var a=this.containerPointToCoord(new W(this.width/2,this.height/2));this.onMoveEnd(this._parseEventFromCoord(a))}return this},_panAnimation:function(r,t,e){return this._animateTo({prjCenter:r},{duration:t||this.options.panAnimationDuration},e)}}),xe.include({computeLength:function(r,t){if(!this.getProjection())return null;var e=new at(r),n=new at(t);return e.equals(n)?0:this.getProjection().measureLength(e,n)},computeGeometryLength:function(r){return r._computeGeodesicLength(this.getProjection())},computeGeometryArea:function(r){return r._computeGeodesicArea(this.getProjection())},identify:function(r,t){r=r||{};var e=new at(r.coordinate);return this._identify(r,t,function(n){return n.identify(e,r)})},identifyAtPoint:function(r,t){var e=r.includeInternals,n=r.tolerance;r=r||{};var i=new W(r.containerPoint),o=this.containerPointToCoord(i);return this._identify(r,t,function(s){var a,l=r.containerPoint;if(e&&!U(s.options.geometryEventTolerance)&&(r.tolerance=r.tolerance||0,r.tolerance+=s.options.geometryEventTolerance),s._hasGeoListeners&&e&&r.eventTypes.indexOf("mousemove")>=0&&!s._hasGeoListeners(r.eventTypes))return[];if(s.identifyAtPoint?a=s.identifyAtPoint(l,r):o&&s.identify?a=s.identify(o,r):a=[],e&&(U(n)?delete r.tolerance:r.tolerance=n),(!a||!a.length)&&(s.fire("identifyempty",r),s.getLayers&&ze(s.getLayers))){var h=(s.getLayers()||[]).filter(function(u){return u});h.forEach(function(u){u.fire("identifyempty",r)})}return a})},_identify:function(r,t,e){var n=r.layers;if(!on(n))return this;for(var i=r.eventTypes,o=[],s=0,a=n.length;s<a;s++)Se(n[s])?o.push(this.getLayer(n[s])):o.push(n[s]);i&&(o=o.filter(function(d){return d._hasGeoListeners?d._hasGeoListeners(i):!0}));for(var l=[],s=o.length-1;s>=0&&!(r.count&&l.length>=r.count);s--){var h=o[s];if(!(!h||!h.getMap()||!r.includeInvisible&&!h.isVisible()||!r.includeInternals&&h.getId().indexOf(dh)>=0)){var u=e(h),c=h.getId();if(u)if(Array.isArray(u)){for(var f=0;f<u.length;f++)u[f]&&!u[f].getLayer&&U(u[f].layer)&&(u[f].layer=c);ai(l,u)}else!u.getLayer&&U(u.layer)&&(u.layer=c),l.push(u)}}return t.call(this,l),this}}),xe.include({_zoom:function(r,t){!this.options.zoomable||this.isZooming()||(t=this._checkZoomOrigin(t),r=this._checkZoom(r),this.onZoomStart(r,t),this._frameZoom=this.getZoom(),this.onZoomEnd(r,t))},_zoomAnimation:function(r,t,e){!this.options.zoomable||this.isZooming()||(r=this._checkZoom(r),this.getZoom()!==r&&(t=this._checkZoomOrigin(t),this._startZoomAnim(r,t,e)))},_checkZoomOrigin:function(r){return(!r||this.options.zoomInCenter)&&(r=new W(this.width/2,this.height/2)),this.options.zoomOrigin&&(r=new W(this.options.zoomOrigin)),r},_startZoomAnim:function(r,t,e){U(e)&&(e=1);var n=this._getResolution(this._startZoomVal)/this._getResolution(r),i=this.options.zoomAnimationDuration*Math.abs(n-e)/Math.abs(n-1);this._frameZoom=this._startZoomVal,this._animateTo({zoom:r,around:t},{continueOnViewChanged:!0,duration:i})},onZoomStart:function(r,t){!this.options.zoomable||this.isZooming()||(this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),delete this.cameraZenithDistance,this._zooming=!0,this._startZoomVal=this.getZoom(),this._startZoomCoord=t&&this._containerPointToPrj(t),this._fireEvent("zoomstart",{from:this._startZoomVal,to:r}))},onZooming:function(r,t,e){if(this.options.zoomable){var n=this._frameZoom;if(n!==r){U(e)&&(e=1),this._zoomTo(r,t);var i=this.getResolution(r),o=this.getResolution(this._startZoomVal),s=o/i/e,a=this._startZoomCoord&&this.prjToContainerPoint(this._startZoomCoord,this._startZoomVal),l=this.getViewPoint();if(!this.isRotating()&&a&&!a.equals(t)&&s!==1){var h=this.getPitch(),u=a._sub(t)._multi(1/(1-s));h&&(u.y/=Math.cos(h*Math.PI/180)),t=t.add(u)}var c=t&&t.x||this.width/2,f=t&&t.y||this.height/2,d={view:[s,0,0,s,(c-l.x)*(1-s),(f-l.y)*(1-s)]},p=this.getDevicePixelRatio();d.container=[s,0,0,s,c*p*(1-s),f*p*(1-s)],this._fireEvent("zooming",{from:this._startZoomVal,to:r,origin:new W(c,f),matrix:d}),this._frameZoom=r}}},onZoomEnd:function(r,t){if(this.options.zoomable){var e=this._startZoomVal;this._zoomTo(r,t),this._zooming=!1,this._getRenderer().onZoomEnd(),this._suppressRecenter||this._recenterOnTerrain(),this._fireEvent("zoomend",{from:e,to:r}),!this._verifyExtent(this._getPrjCenter())&&!this.options.limitExtentOnMaxExtent&&this._panTo(this._prjMaxExtent.getCenter())}},_zoomTo:function(r,t){if(this._zoomLevel=r,this._calcMatrices(),t&&this._startZoomCoord){var e=this._containerPointToPoint(t),n=e._sub(this._prjToPoint(this._getPrjCenter()));this._setPrjCoordAtOffsetToCenter(this._startZoomCoord,n)}},_checkZoom:function(r){var t=this.getMaxZoom(),e=this.getMinZoom();return r<e&&(r=e),r>t&&(r=t),r}});function Qr(r,t,e,n){return r[0]=t,r[1]=e,r[2]=n,r}function Zk(r,t,e){return r[0]=t[0]+e[0],r[1]=t[1]+e[1],r[2]=t[2]+e[2],r}function Hh(r,t,e){return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],r}function F2(r){var t=r[0],e=r[1],n=r[2];return Math.sqrt(t*t+e*e+n*n)}function Na(r,t){var e=t[0],n=t[1],i=t[2],o=e*e+n*n+i*i;return o>0&&(o=1/Math.sqrt(o),r[0]=t[0]*o,r[1]=t[1]*o,r[2]=t[2]*o),r}function L2(r,t){return r[0]*t[0]+r[1]*t[1]+r[2]*t[2]}function Xk(r,t,e){return r[0]=t[0]*e,r[1]=t[1]*e,r[2]=t[2]*e,r}function gm(r,t,e){var n=t[0],i=t[1],o=t[2],s=e[0],a=e[1],l=e[2];return r[0]=i*l-o*a,r[1]=o*s-n*l,r[2]=n*a-i*s,r}function mm(r,t){var e=t[0]-r[0],n=t[1]-r[1],i=t[2]-r[2];return Math.hypot?Math.hypot(e,n,i):qk(e,n,i)}function Yk(r,t,e){var n=t[0],i=t[1],o=t[2],s=e[3]*n+e[7]*i+e[11]*o+e[15];return s=s||1,r[0]=(e[0]*n+e[4]*i+e[8]*o+e[12])/s,r[1]=(e[1]*n+e[5]*i+e[9]*o+e[13])/s,r[2]=(e[2]*n+e[6]*i+e[10]*o+e[14])/s,r}function qk(){for(var r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];for(var e=0,n=r.length;n--;)e+=r[n]*r[n];return Math.sqrt(e)}function z2(r,t){Na(r,r),Na(t,t);var e=L2(r,t);return e>1?0:e<-1?Math.PI:Math.acos(e)}function ym(r,t,e){var n=t[0],i=t[1],o=t[2],s=1/(e[3]*n+e[7]*i+e[11]*o+e[15]);return r[0]=(e[0]*n+e[4]*i+e[8]*o+e[12])*s,r[1]=(e[1]*n+e[5]*i+e[9]*o+e[13])*s,r[2]=(e[2]*n+e[6]*i+e[10]*o+e[14])*s,r}function Jk(r,t){var e=t[0],n=t[4],i=t[8],o=t[1],s=t[5],a=t[9],l=t[2],h=t[6],u=t[10],c=e+s+u,f;return c>0?(f=.5/Math.sqrt(c+1),r.w=.25/f,r.x=(h-a)*f,r.y=(i-l)*f,r.z=(o-n)*f):e>s&&e>u?(f=2*Math.sqrt(1+e-s-u),r.w=(h-a)/f,r.x=.25*f,r.y=(n+o)/f,r.z=(i+l)/f):s>u?(f=2*Math.sqrt(1+s-e-u),r.w=(i-l)/f,r.x=(n+o)/f,r.y=.25*f,r.z=(a+h)/f):(f=2*Math.sqrt(1+u-e-s),r.w=(o-n)/f,r.x=(i+l)/f,r.y=(a+h)/f,r.z=.25*f),this}function Kk(r,t){var e=r,n=t.x,i=t.y,o=t.z,s=t.w,a=n+n,l=i+i,h=o+o,u=n*a,c=n*l,f=n*h,d=i*l,p=i*h,g=o*h,m=s*a,y=s*l,x=s*h;return e[0]=1-(d+g),e[4]=c-x,e[8]=f+y,e[1]=c+x,e[5]=1-(u+g),e[9]=p-m,e[2]=f-y,e[6]=p+m,e[10]=1-(u+d),e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Qk(r,t){var e=r;return e[12]=t[0],e[13]=t[1],e[14]=t[2],r}function tI(r,t,e,n){var i=[0,0,0],o=[0,0,0],s=[0,0,0];return Hh(s,t,e),F2(s)===0&&(s[2]=1),Na(s,s),gm(i,n,s),F2(s)===0&&(Math.abs(n[2])===1?s[0]+=1e-4:s[2]+=1e-4,Na(s,s),gm(i,n,s)),Na(i,i),gm(o,s,i),r[0]=i[0],r[4]=o[0],r[8]=s[0],r[1]=i[1],r[5]=o[1],r[9]=s[1],r[2]=i[2],r[6]=o[2],r[10]=s[2],r}var ui=Math.PI/180,eI=.6435011087932844,vm=new at(0,0),H2=new W(0,0),nI=[0,-1,0],N2=[],rI=function(r){if(It(r))return r!==0;if(Array.isArray(r)&&r.length>0){for(var t=0,e=r.length;t<e;t++)if(It(r[t])&&r[t]!==0)return!0}return!1};/*!
 * contains code from mapbox-gl-js
 * https://github.com/mapbox/mapbox-gl-js
 * LICENSE : MIT
 * (c) mapbox
 *
 */xe.include({getFov:function(){return this._fov||(this._fov=eI),this._fov/ui},setFov:function(r){if(this.isZooming())return this;if(r=Math.max(.01,Math.min(60,r)),this._fov===r)return this;var t=this.getFov();return this._fov=r*ui,this._calcMatrices(),this._renderLayers(),this._fireEvent("fovchange",{from:t,to:this.getFov()}),this},getBearing:function(){return this._angle?-this._angle/ui:0},setBearing:function(r){var t={bearing:r};return this._validateView(t),this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._setBearing(t.bearing)},_setBearing:function(r){if(be.ie9)throw new Error("map can't rotate in IE9.");var t=-Os(r,-180,180)*ui;if(this._angle===t)return this;var e=this.getBearing();return this._fireEvent("rotatestart",{from:e,to:t}),this._angle=t,this._calcMatrices(),this._renderLayers(),this._fireEvent("rotate",{from:e,to:t}),this._fireEvent("rotateend",{from:e,to:t}),this},getPitch:function(){return this._pitch?this._pitch/Math.PI*180:0},setPitch:function(r){var t={pitch:r};return this._validateView(t),this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._setPitch(t.pitch)},_setPitch:function(r){if(be.ie9)throw new Error("map can't tilt in IE9.");var t=fc(r,0,this.options.maxPitch)*ui;if(this._pitch===t)return this;var e=this.getPitch();return this._fireEvent("pitchstart",{from:e,to:t}),this._pitch=t,this._calcMatrices(),this._renderLayers(),this._fireEvent("pitch",{from:e,to:t}),this._fireEvent("pitchend",{from:e,to:t}),this},setCameraMovements:function(r,t){var e=this;if(!Array.isArray(r)||!r.length)return this;if(r.forEach(function(c){e._validateView(c)}),this.setView({center:r[0].center,zoom:r[0].zoom,pitch:r[0].pitch,bearing:r[0].bearing}),r.length===1)return this;var n=1,i=function(c){if(c.state.playState==="finished"){n++,n===r.length-1&&(i=null);var f=r[n];f.duration=f.timestamp-r[n-1].timestamp,t&&t.autoRotate&&(f.bearing=iI(r[n-1].center,f.center)),e._setCameraMovement(f,i)}};r.length===2&&(i=null);var o=this.getBearing();this._setCameraMovement(Vp({bearing:o,duration:r[n].timestamp-r[n-1].timestamp},r[n]),i);var s=function(){e._animPlayer.play()},a=function(){e._animPlayer.pause()},l=function(){e._animPlayer.cancel()},h=function(){e._animPlayer.finish()},u=function(){e._animPlayer.reverse()};return{play:s,pause:a,cancel:l,finish:h,reverse:u}},_setCameraMovement:function(r,t){this.animateTo({zoom:r.zoom,center:r.center,pitch:r.pitch,bearing:r.bearing},{duration:r.duration,easing:"out"},t)},setCameraOrientation:function(r){var t=r.position,e=r.pitch,n=r.bearing;this._validateView(r),e=e||0,n=n||0;var i=this.getFitZoomForCamera(t,e),o=i.zoom,s=i.cameraToGroundDistance,a=Math.sin(e*ui)*s,l=Os(n,-180,180),h=l*ui,u=this.getGLRes(),c=new at(t[0],t[1]),f=this.coordToPointAtRes(c,u),d=new W(0,0);d.x=f.x+a*Math.sin(h),d.y=f.y+a*Math.cos(h);var p=this._pointToPrjAtRes(d,this.getGLRes());return this._setPrjCenter(p),this.setView({bearing:n,pitch:e,zoom:o}),this},setCameraPosition:function(r){var t=this.getGLRes(),e=this.coordToPointAtRes(r,t);e.z=this.altitudeToPoint(r.z||0,t);var n=this.getCenter(),i=this.coordToPointAtRes(n,t);i.z=this.altitudeToPoint(n.z,t);var o=Hh([],e.toArray(),i.toArray());Qr(this.cameraUp||[0,0,0],0,0,1),this._pitch=z2(o,this.cameraUp),Qr(N2,o[0],o[1],0),this._angle=-z2(N2,nI),this._zoomLevel=this.getFitZoomForCamera(r,this._pitch).zoom,this._calcMatrices()},getFitZoomForCamera:function(r,t){var e=Array.isArray(r)?r[2]:r.z,n=e*this._meterToGLPoint,i=this.centerAltitude||0,o=i*this._meterToGLPoint,s=n-o,a=t*ui,l=s/Math.cos(a),h=l+o,u=this.getFitZoomForAltitude(h);return{zoom:u,cameraToGroundDistance:l}},getFitZoomForAltitude:function(r){var t=this._getFovRatio(),e=r*t*2/(this.height||1)*this.getGLRes(),n=this._getResolutions(),i=0;for(i;i<n.length-1;i++){if(n[i]===e)return i;if(n[i+1]===e)return i+1;if(e<n[i]&&e>n[i+1])return i=(e-n[i])/(n[i+1]-n[i])+i,i-1}return i},isTransforming:function(){return!!(this._pitch||this._angle)},getFrustumAltitude:function(){return this._frustumAltitude},_calcFrustumAltitude:function(){var r=90-this.getPitch(),t=this.getFov()/2,e=this.cameraPosition?this.cameraPosition[2]:0;if(t<=r)return e;t=Math.PI*t/180;var n=new W(this.cameraPosition).distanceTo(new W(this.cameraLookAt)),i=e*Math.tan(t*2),o=Math.tan(t)*(n+i);return e+o},_pointToContainerPoint:function(r,t,e,n){e===void 0&&(e=0);var i=this._getResolution(t);return this._pointAtResToContainerPoint(r,i,e,n)},_pointAtResToContainerPoint:function(r,t,e,n){e===void 0&&(e=0),n||(n=new W(0,0)),r=this._pointAtResToPoint(r,t,n);var i=this.isTransforming(),o;return!i&&!e&&(o=this._prjToPoint(this._getPrjCenter(),void 0,vm)),this._toContainerPoint(n,i,e,o),n},_pointsAtResToContainerPoints:function(r,t,e,n){e===void 0&&(e=[]),n===void 0&&(n=[]);var i=this.getPitch(),o=this.getBearing(),s=t/this._getResolution();if(i===0&&o===0&&!rI(e)){var a=this.get2DExtent(),l=a.xmin,h=a.ymin,u=a.xmax,c=a.ymax;if(u>l&&c>h){for(var f=this.getSize(),d=f.width,p=f.height,g=(u-l)/d,m=(c-h)/p,y=0,x=r.length;y<x;y++){if(!r[y]){n[y]=null;continue}var v=n[y];v.x=r[y].x,v.y=r[y].y,v._multi(s),v.x=(v.x-l)*g,v.y=p-(v.y-h)*m}return n}}for(var _=Array.isArray(e),w=this.isTransforming(),b=this._prjToPoint(this._getPrjCenter(),void 0,vm),y=0,x=r.length;y<x;y++){if(!r[y]){n[y]=null;continue}var v=n[y];v.x=r[y].x,v.y=r[y].y,v._multi(s);var A=_?e[y]||0:e;this._toContainerPoint(v,w,A,b)}return n},_toContainerPoint:function(){var r=[0,0,0];return function(t,e,n,i){var o=this.width/2,s=this.height/2;if(e||n){this._altitudeScale||(this._altitudeScale=this.altitudeToPoint(100,this.getGLRes())/100);var a=this._glScale;Qr(r,t.x*a,t.y*a,n*this._altitudeScale);var l=this._projIfBehindCamera(r,this.cameraPosition,this.cameraForward);ym(l,l,this.projViewMatrix),t.x=l[0]*o+o,t.y=-(l[1]*s)+s}else t._sub(i.x,i.y),t.set(t.x,-t.y),t._add(o,s)}}(),_projIfBehindCamera:function(){var r=new Array(3),t=new Array(3),e=new Array(3);return function(n,i,o){Hh(r,n,i);var s=L2(o,r);return s<=0&&(Xk(t,o,s*1.01),Zk(n,i,Hh(e,r,t))),n}}(),_containerPointToPoint:function(r,t,e,n){var i=this._getResolution(t);return this._containerPointToPointAtRes(r,i,e,n)},_containerPointToPointAtRes:function(){var r=[0,0,0],t=[0,0,0,1],e=[0,0,0,1];return function(n,i,o,s){if(this.isTransforming()){var a=this.width/2||1,l=this.height/2||1;Qr(r,(n.x-a)/a,(l-n.y)/l,0),Qr(t,r[0],r[1],0),Qr(e,r[0],r[1],1),t[3]=e[3]=1,ym(t,t,this.projViewMatrixInverse),ym(e,e,this.projViewMatrixInverse);var h=t[0],u=e[0],c=t[1],f=e[1],d=t[2],p=e[2],g=s?this.altitudeToPoint(s,i)*this._glScale:0,m=d===p?g:(g-d)/(p-d),y=cc(h,u,m),x=cc(c,f,m);return o?(o.x=y,o.y=x):o=new W(y,x),o._multi(1/this._glScale),this._getResolution()===i?o:this._pointToPointAtRes(o,i,o)}var v=this._prjToPointAtRes(this._getPrjCenter(),i,o),_=this._getResolution()/i,w=_*(n.x-this.width/2),b=_*(n.y-this.height/2);return v._add(w,-b)}}(),_calcMatrices:function(){var r=Mi();return function(){delete this._mapRes,delete this._mapGlRes,delete this._mapExtent2D,delete this._mapGlExtent2D;var t=this.getSize(),e=t.width||1,n=t.height||1;this._glScale=this.getGLScale();var i=this._getCameraWorldMatrix(),o=this.getFov()*Math.PI/180,s=this._getCameraFar(o,this.getPitch());this.cameraFar=s,this.cameraNear=this.cameraCenterDistance/20;var a=this.projMatrix||Mi();ug(a,o,e/n,this.cameraNear,s),this.projMatrix=a,this.viewMatrix=fg(this.viewMatrix||Mi(),i),this.projViewMatrix=ba(this.projViewMatrix||Mi(),a,this.viewMatrix),this._calcCascadeMatrixes(),this.projViewMatrixInverse=ba(this.projViewMatrixInverse||Mi(),i,fg(r,a)),this.domCssMatrix=this._calcDomMatrix(),this._frustumAltitude=this._calcFrustumAltitude(),this._mapRes=this._getResolution(),this._mapGlRes=this.getGLRes(),this._mapExtent2D=this.get2DExtent(),this._mapGlExtent2D=this.get2DExtentAtRes(this._mapGlRes)}}(),_getCameraFar:function(r,t){var e=this.cameraCenterDistance=mm(this.cameraPosition,this.cameraLookAt),n=e/this._meterToGLPoint;t=t*Math.PI/180;var i=n+this.options.cameraFarUndergroundInMeter/Math.cos(t);return Math.max(i*this._meterToGLPoint,e*5)},_calcCascadeMatrixes:function(){var r=Mi();function t(e,n,i){var o=this.width,s=this.height,a=this.getFov()*Math.PI/180,l=this._getCameraFar(a,n),h=this.cameraCenterDistance;l=h+(l-h)/Math.cos((90-n)*Math.PI/180)*Math.cos((90-e)*Math.PI/180),ug(r,a,o/s,.1,l);var u=this.viewMatrix;return ba(i,r,u)}return function(){var e=this.getPitch(),n=this.options.cascadePitches[0],i=this.options.cascadePitches[1],o=this.cascadeFrustumMatrix0=this.cascadeFrustumMatrix0||Mi(),s=this.cascadeFrustumMatrix1=this.cascadeFrustumMatrix1||Mi();e>n?t.call(this,e,n,o):dg(this.cascadeFrustumMatrix0,this.projViewMatrix),e>i?t.call(this,e,i,s):dg(this.cascadeFrustumMatrix1,this.cascadeFrustumMatrix0)}}(),_calcDomMatrix:function(){var r=Mi(),t=Mi(),e=[1,-1,1],n=[0,0,0];return function(){var i=this.width||1,o=this.height||1,s=.5/Math.tan(this._fov/2)*o;return kc(r,this.projMatrix,e),cg(r,r,Qr(n,0,0,-s)),this._pitch&&Ix(r,r,this._pitch),this._angle&&Rx(r,r,this._angle),Ic(t),kc(t,t,Qr(n,i/2,-o/2,1)),ba(this.domCssMatrix||Mi(),t,r)}}(),_getFovZ:function(r){var t=this.getGLScale(r),e=this._getFovRatio();return t*(this.height||1)/2/e},_getCameraWorldMatrix:function(){var r={};return function(){var t=this.getGLRes();this._meterToGLPoint||(this._meterToGLPoint=this.distanceToPointAtRes(100,0,t).x/100);var e=this._prjToPointAtRes(this._prjCenter,t,H2),n=this.getCenter().z,i=n!==void 0?n:this.centerAltitude||0,o=i*this._meterToGLPoint;this.cameraLookAt=Qr(this.cameraLookAt||[0,0,0],e.x,e.y,o);var s=this.getPitch()*ui,a=this.getBearing()*ui,l=this._getFovZ(),h=this.cameraZenithDistance===void 0?l:this.cameraZenithDistance,u=h-o,c=u*Math.cos(s),f=Math.sin(s)*u,d=e.x-f*Math.sin(a),p=e.y-f*Math.cos(a);this.cameraPosition=Qr(this.cameraPosition||[0,0,0],d,p,c+o),this.cameraToCenterDistance=l;var g=f||1;this.cameraUp=this.cameraUp||[0,0,0];var m=this.cameraUp=Qr(this.cameraUp,Math.sin(a)*g,Math.cos(a)*g,Math.sin(s)*g),y=this.cameraWorldMatrix=this.cameraWorldMatrix||Mi();tI(y,this.cameraPosition,this.cameraLookAt,m);var x=this.cameraForward||[0,0,0];return Hh(x,this.cameraLookAt,this.cameraPosition),this.cameraForward=Na(x,x),Jk(r,y),Kk(y,r),Qk(y,this.cameraPosition),y}}(),updateCenterAltitude:function(){this.getRenderer().setToRedraw(),!this.centerAltitude&&this._hasAltitudeLayer()&&(this.centerAltitude=0),this._recenterOnTerrain()},_recenterOnTerrain:function(){if(!(this.centerAltitude===void 0||this._centerZ!==void 0)){var r=this._queryTerrainByProjCoord(this._prjCenter);U(r)&&this._hasAltitudeLayer()&&(r=this.centerAltitude);var t=r||0,e=this.getPitch()*ui,n=this.getBearing()*ui,i=(t-this.centerAltitude)*this._meterToGLPoint,o=this._getFovZ(),s=this.cameraZenithDistance===void 0?o:this.cameraZenithDistance,a=s-this.centerAltitude*this._meterToGLPoint,l=a-i/Math.cos(e),h=this.cameraPosition,u=Math.sin(e)*l,c=H2;c.x=h[0]+u*Math.sin(n),c.y=h[1]+u*Math.cos(n);var f=t*this._meterToGLPoint;this.cameraZenithDistance=(h[2]-f)/Math.cos(e)+f,this.centerAltitude=t;var d=this.pointAtResToCoordinate(c,this.getGLRes(),vm);this._eventSilence=!0,this._suppressRecenter=!0,this.setCenter(d),delete this._suppressRecenter,delete this._eventSilence,U(r)&&delete this.centerAltitude}},_queryTerrainByProjCoord:function(r){for(var t=this._getLayers(),e=0;e<t.length;e++)if(t[e].queryTerrainByProjCoord)return t[e].queryTerrainByProjCoord(r)[0];return 0},_hasAltitudeLayer:function(){for(var r=this._getLayers(),t=0;t<r.length;t++)if(r[t].getTerrainLayer&&r[t].getTerrainLayer())return!0;return!1},_queryTerrainInfo:function(r){for(var t=this._getLayers()||[],e=0;e<t.length;e++){var n=t[e];if(r&&n&&n.queryTerrainAtPoint&&n.getTerrainLayer&&n.getTerrainLayer()){var i=n.queryTerrainAtPoint(r);if(i)return{coordinate:i,altitude:i.z};break}}return null},_getFovRatio:function(){var r=this.getFov();return Math.tan(r/2*ui)},_renderLayers:function(){if(!this.isInteracting()){var r=this._getLayers();r.forEach(function(t){if(t){var e=t._getRenderer();e&&e.setToRedraw&&e.setToRedraw()}})}}});function Mi(){return Ic(new Array(16))}function iI(r,t){var e=Gn(r[0]),n=Gn(t[0]),i=Gn(r[1]),o=Gn(t[1]),s=Math.sin(n-e)*Math.cos(o),a=Math.cos(i)*Math.sin(o)-Math.sin(i)*Math.cos(o)*Math.cos(n-e);return Dp(Math.atan2(s,a))}xe.include({_onViewChange:function(r){this._viewHistory||(this._viewHistory=[],this._viewHistoryPointer=0);for(var t=this._getCurrentView(),e=this._viewHistory.length-1;e>=0;e--)if(gc(r,this._viewHistory[e])){this._viewHistoryPointer=e,this._fireViewChange(t,r);return}this._viewHistoryPointer<this._viewHistory.length-1&&this._viewHistory.splice(this._viewHistoryPointer+1),this._viewHistory.push(r);var n=this.options.viewHistoryCount;n>0&&this._viewHistory.length>n&&this._viewHistory.splice(0,this._viewHistory.length-n),this._viewHistoryPointer=this._viewHistory.length-1,this._fireViewChange(t,r)},zoomToPreviousView:function(r){if(r===void 0&&(r={}),!this.hasPreviousView())return null;var t=this._viewHistory[--this._viewHistoryPointer];return this._zoomToView(t,r),t},hasPreviousView:function(){return!(!this._viewHistory||this._viewHistoryPointer===0)},zoomToNextView:function(r){if(r===void 0&&(r={}),!this.hasNextView())return null;var t=this._viewHistory[++this._viewHistoryPointer];return this._zoomToView(t,r),t},hasNextView:function(){return!(!this._viewHistory||this._viewHistoryPointer===this._viewHistory.length-1)},_zoomToView:function(r,t){var e=this,n=this.getView();t.animation?this._animateTo(r,{duration:t.duration},function(i){i.state.playState==="finished"&&e._fireViewChange(n,r)}):(this.setView(r),this._fireViewChange(n,r))},getViewHistory:function(){return this._viewHistory},_fireViewChange:function(r,t){this._fireEvent("viewchange",{old:r,new:t}),this._insertUICollidesQueue()},_getCurrentView:function(){return this._viewHistory?this._viewHistory[this._viewHistoryPointer]:null}}),xe.mergeOptions({viewHistory:!0,viewHistoryCount:10});var oI=new Ph;xe.include({getCollisionIndex:function(){return this._collisionIndex||this.createCollisionIndex(),this._collisionIndex||this.createCollisionIndex()},createCollisionIndex:function(){return this.clearCollisionIndex(),this._collisionIndex=new Ph,this._collisionIndex},clearCollisionIndex:function(){return this.collisionFrameTime=0,this._collisionIndex&&this._collisionIndex.clear(),this},_insertUICollidesQueue:function(){return this._uiCollidesQueue||(this._uiCollidesQueue=[]),this._uiCollidesQueue.push(1),this},uiCollides:function(){if(!this.uiList||this.uiList.length===0||!this._uiCollidesQueue||this._uiCollidesQueue.length===0)return this;var r=oI;r.clear();for(var t=this.uiList,e=0,n=t.length;e<n;e++){var i=t[e],o=i.options,s=o.collisionBufferSize,a=o.collision;if(a){var l=i.getDOM();if(!(!i.isVisible()||!l)&&l.getBoundingClientRect){i.bbox||(i.bbox=[0,0,0,0]);var h=l.getBoundingClientRect(),u=h.x,c=h.y,f=h.width,d=h.height;if(f===0||d===0){var p=i.getSize();p&&(f=p.width,d=p.height)}var g=u-s,m=u+f+s,y=c-s,x=c+d+s;if(i.bbox[0]=g,i.bbox[1]=y,i.bbox[2]=m,i.bbox[3]=x,r.collides(i.bbox)){i._collidesEffect(!1);continue}r.insertBox(i.bbox),i._collidesEffect(!0)}}}return this._uiCollidesQueue=[],this},_addUI:function(r){this.uiList||(this.uiList=[]);var t=this.uiList.indexOf(r);return t>-1?this:(this.uiList.push(r),this.uiList=this.uiList.sort(function(e,n){return n.options.collisionWeight-e.options.collisionWeight}),this)},_removeUI:function(r){if(!this.uiList)return-1;var t=this.uiList.indexOf(r);return t<0||this.uiList.splice(t,1),t}});var sI=new at(0,0);xe.include({coordinateToPoint:function(r,t,e){var n=this._getResolution(t);return this.coordinateToPointAtRes(r,n,e)},coordinateToPointAtRes:function(){var r=new at(0,0);return function(t,e,n){var i=this.getProjection().project(t,r);return this._prjToPointAtRes(i,e,n)}}(),pointToCoordinate:function(){var r=new at(0,0);return function(t,e,n){var i=this._pointToPrj(t,e,r);return this.getProjection().unproject(i,n)}}(),pointAtResToCoordinate:function(){var r=new at(0,0);return function(t,e,n){var i=this._pointToPrjAtRes(t,e,r);return this.getProjection().unproject(i,n)}}(),coordinateToViewPoint:function(){var r=new at(0,0);return function(t,e,n){return this._prjToViewPoint(this.getProjection().project(t,r),e,n)}}(),viewPointToCoordinate:function(){var r=new at(0,0);return function(t,e){return this.getProjection().unproject(this._viewPointToPrj(t,r),e)}}(),coordinateToContainerPoint:function(r,t,e){var n=this._getResolution(t);return this.coordinateToContainerPointAtRes(r,n,e)},coordinateToContainerPointAtRes:function(){var r=new at(0,0);return function(t,e,n){var i=this.getProjection().project(t,r);return this._prjToContainerPointAtRes(i,e,n)}}(),coordinatesToContainerPoints:function(r,t){var e=this._getResolution(t);return this.coordinatesToContainerPointsAtRes(r,e)},coordinatesToContainerPointsAtRes:function(){return function(r,t){for(var e=[],n=this._spatialReference.getTransformation(),i=t/this._getResolution(),o=this.getProjection(),s=new at(0,0),a=this.isTransforming(),l=this._prjToPoint(this._getPrjCenter(),void 0,sI),h=0,u=r.length;h<u;h++){var c=o.project(r[h],s),f=n.transform(c,t);f=f._multi(i),this._toContainerPoint(f,a,r[h].z,l),e.push(f)}return e}}(),containerPointToCoordinate:function(){var r=new at(0,0);return function(t,e){var n=this._containerPointToPrj(t,r);return this.getProjection().unproject(n,e)}}(),containerToExtent:function(){var r=new W(0,0),t=new W(0,0);return function(e){var n=new Ce(this._containerPointToPoint(e.getMin(r),void 0,r),this._containerPointToPoint(e.getMax(t),void 0,t));return this._pointToExtent(n)}}(),distanceToPixel:function(){var r=new W(0,0),t=new W(0,0);return function(e,n,i){var o=this.getProjection();if(!o)return null;var s=this.getScale()/this.getScale(i),a=this.getCenter(),l=o.locate(a,e,n),h=this.coordToContainerPoint(a,void 0,r),u=this.coordToContainerPoint(l,void 0,t);return u._sub(h)._multi(s)._abs(),new kn(u.x,u.y)}}(),distanceToPoint:function(r,t,e,n){var i=this._getResolution(e);return this.distanceToPointAtRes(r,t,i,n)},distanceToPointAtRes:function(){var r=new W(0,0),t=new at(0,0);return function(e,n,i,o,s){var a=this.getProjection();if(!a)return null;var l=o||this.getCenter(),h=a.locate(l,e,n,t),u=this.coordToPointAtRes(l,i,r),c=this.coordToPointAtRes(h,i,s);return c._sub(u)._abs(),c}}(),altitudeToPoint:function(){var r=new at(0,40),t=new W(0,0);return function(e,n,i){e===void 0&&(e=0),this._altitudeOriginDirty&&(r.x=this._originLng,this._altitudeOriginDirty=!1);var o=this.distanceToPointAtRes(e,e,n,i||r,t);e<0&&o.x>0&&(o.x=-o.x);var s=this.options.heightFactor;return s&&s!==1&&(o.x*=s,o.y*=s),o.x}}(),pointAtResToAltitude:function(){var r=new at(0,40);return function(t,e,n){t===void 0&&(t=0);var i=this.pointAtResToDistance(t,0,e,n||r);return i}}(),pixelToDistance:function(){var r=new at(0,0),t=new at(0,0),e=new at(0,0),n=new at(0,0);return function(i,o){var s=this.getProjection();if(!s)return null;var a=this.getFullExtent(),l=a.top>a.bottom?-1:1,h=r.set(this.width/2,this.height/2),u=t.set(this.width/2+i,this.height/2+l*o),c=this.containerPointToCoord(h,e),f=this.containerPointToCoord(u,n);return s.measureLength(c,f)}}(),pointToDistance:function(r,t,e){var n=this.getResolution(e);return this.pointAtResToDistance(r,t,n)},pointAtResToDistance:function(){var r=new W(0,0),t=new at(0,0),e=new at(0,0),n=new at(0,0);return function(i,o,s,a){var l=this.getProjection();if(!l)return null;var h=a?l.project(a,t):this._getPrjCenter(),u=this._prjToPointAtRes(h,s,r);u._add(i,o);var c=this.pointAtResToCoord(u,s,e),f=a||l.unproject(h,n);return l.measureLength(f,c)}}(),locateByPoint:function(){var r=new W(0,0);return function(t,e,n){var i=this.coordToContainerPoint(t,void 0,r);return this.containerPointToCoord(i._add(e,n))}}(),_get2DExtent:function(r,t){var e;if((r===void 0||r===this._zoomLevel)&&this._mapExtent2D&&(e=this._mapExtent2D),e)return t?(t.set(e.xmin,e.ymin,e.xmax,e.ymax),t):e.copy();var n=this._getResolution(r);return this._get2DExtentAtRes(n,t)},get2DExtent:function(r,t){return this._get2DExtent(r,t)},_get2DExtentAtRes:function(){var r=new W(0,0);return function(t,e){var n=this;if(t===this._mapGlRes&&this._mapGlExtent2D)return this._mapGlExtent2D;var i=this.getContainerExtent();return i.convertTo(function(o){return n._containerPointToPointAtRes(o,t,r)},e)}}(),get2DExtentAtRes:function(r,t){return this._get2DExtentAtRes(r,t)},pointToExtent:function(r){return this._pointToExtent(r)},_pointToExtent:function(){var r=new at(0,0),t=new at(0,0);return function(e){var n=e.getMin(),i=e.getMax(),o=this.getFullExtent(),s=te(!o||o.left<=o.right?[n.x,i.x]:[i.x,n.x],2),a=s[0],l=s[1],h=te(!o||o.top>o.bottom?[i.y,n.y]:[n.y,i.y],2),u=h[0],c=h[1],f=n.set(a,c),d=i.set(l,u);return new gn(this.pointToCoord(f,void 0,r),this.pointToCoord(d,void 0,t),this.getProjection())}}(),getViewPointFrameOffset:function(){var r=new W(0,0);return function(){if(this.isZooming())return null;var t=this._getPrjCenter();return this._mapViewCoord&&!this._mapViewCoord.equals(t)?this._prjToContainerPoint(this._mapViewCoord)._sub(this._prjToContainerPoint(t,void 0,r)):null}}(),_viewPointToPrj:function(){var r=new W(0,0);return function(t,e){return this._containerPointToPrj(this.viewPointToContainerPoint(t,r),e)}}(),viewPointToPrj:function(r,t){return this._viewPointToPrj(r,t)},_prjToContainerPoint:function(r,t,e,n){var i=this._getResolution(t);return this._prjToContainerPointAtRes(r,i,e,n)},prjToContainerPoint:function(r,t,e,n){return this._prjToContainerPoint(r,t,e,n)},_prjToContainerPointAtRes:function(){var r=new W(0,0);return function(t,e,n,i){return this._pointAtResToContainerPoint(this._prjToPointAtRes(t,e,r),e,i||0,n)}}(),prjToContainerPointAtRes:function(r,t,e,n){return this.prjToContainerPointAtRes(r,t,e,n)},_prjToViewPoint:function(){var r=new W(0,0);return function(t,e,n){var i=this._prjToContainerPoint(t,void 0,r,n);return this.containerPointToViewPoint(i,e)}}(),prjToViewPoint:function(r,t,e){return this._prjToViewPoint(r,t,e)},_viewPointToPoint:function(){var r=new W(0,0);return function(t,e,n){return this._containerPointToPoint(this.viewPointToContainerPoint(t,r),e,n)}}(),viewPointToPoint:function(r,t,e){return this._viewPointToPoint(r,t,e)},_pointToViewPoint:function(){var r=new at(0,0);return function(t,e,n){return this._prjToViewPoint(this._pointToPrj(t,e,r),n)}}(),pointToViewPoint:function(r,t,e){return this._pointToViewPoint(r,t,e)}});var aI={start:"起点",units:{mile:" 英里",feet:" 英尺",kilometer:" 公里",meter:" 米"}},lI={units:{mile:" 平方英里",feet:" 平方英尺",kilometer:" 平方公里",meter:" 平方米"}},hI={distancetool:aI,areatool:lI},uI={start:"Inicio",units:{mile:" mi",feet:" ft",kilometer:" km",meter:" m"}},cI={units:{mile:" mi²",feet:" ft²",kilometer:" km²",meter:" m²"}},fI={distancetool:uI,areatool:cI},dI={start:"Start",units:{mile:" mi",feet:" ft",kilometer:" km",meter:" m"}},pI={units:{mile:" mi²",feet:" ft²",kilometer:" km²",meter:" m²"}},gI={distancetool:dI,areatool:pI},Ba=function(r){Et(t,r);function t(e){var n=r.call(this,"Translator: "+e)||this;return n.name="TranslatorError",n}return t}(Error),B2=function(r){Et(t,r);function t(e){var n=r.call(this)||this;return n.languages={"zh-CN":hI,"es-MX":fI,"en-US":gI},n.setLang(e||"zh-CN"),n}return t.prototype.setLang=function(e){var n=this.languages[e];if(!n)throw new Ba("Setted Lang does not exist");this.nodes=n},t.prototype._validateNestedProps=function(e){e.forEach(function(n){if(n==="")throw new Ba('Any of sides of a dot "." cannot be empty')})},t.prototype.translate=function(e){if(e===void 0&&(e=null),e==null)throw new Ba("Missing parameter textNode");if(typeof e=="string"){var n=null;if(e.includes(".")){var i=e.split(".");if(i.length>3)throw new Ba("Translate function can only access through 3 nested properties, trying to access -> ".concat(i.length));this._validateNestedProps(i);try{var o=null;switch(i.length){case 2:o=this.nodes[i[0]][i[1]];break;case 3:o=this.nodes[i[0]][i[1]][i[2]];break}return o}catch(s){throw new Ba("Unable to find the text translated in lang json"+s.message)}}else return n=this.nodes[e],n}else throw new Ba("Param passed has to be a String")},t}(hi),mI={formatLabelContent:null,decimalPlaces:2,mode:"LineString",language:"zh-CN",metric:!0,imperial:!1,symbol:{lineColor:"#000",lineWidth:3,lineOpacity:1},vertexSymbol:{markerType:"ellipse",markerFill:"#fff",markerLineColor:"#000",markerLineWidth:3,markerWidth:11,markerHeight:11},labelOptions:{textSymbol:{textFaceName:"monospace",textLineSpacing:1,textHorizontalAlignment:"right",textDx:15},boxStyle:{padding:[6,2],symbol:{markerType:"square",markerFill:"#fff",markerFillOpacity:.9,markerLineColor:"#b4b3b3"}}},clearButtonSymbol:[{markerType:"square",markerFill:"#fff",markerLineColor:"#b4b3b3",markerLineWidth:2,markerWidth:15,markerHeight:15,markerDx:20},{markerType:"x",markerWidth:10,markerHeight:10,markerDx:20}]},j2=function(r){Et(t,r);function t(e){var n=r.call(this,e)||this;return n.on("enable",n._afterEnable,n).on("disable",n._afterDisable,n),n._measureLayers=[],n.translator=new B2(n.options.language),n}return t.prototype.clear=function(){if(on(this._measureLayers))for(var e=0;e<this._measureLayers.length;e++)this._measureLayers[e].remove();return delete this._lastMeasure,delete this._lastVertex,this._outLayers(this._measureLayers),this._measureLayers=[],this},t.prototype.getMeasureLayers=function(){return this._measureLayers},t.prototype.getLastMeasure=function(){return this._lastMeasure?this._lastMeasure:0},t.prototype.undo=function(){r.prototype.undo.call(this);var e=this._historyPointer;if(e!==this._vertexes.length)for(var n=e;n<this._vertexes.length;n++)this._vertexes[n].label&&this._vertexes[n].label.remove(),this._vertexes[n].marker.remove();return this},t.prototype.redo=function(){r.prototype.redo.call(this);var e=this._historyPointer-1;return this._vertexes[e]&&(this._vertexes[e].marker.getLayer()||(this._vertexes[e].label&&this._vertexes[e].label.addTo(this._measureMarkerLayer),this._vertexes[e].marker.addTo(this._measureMarkerLayer))),this},t.prototype._formatLabelContent=function(e){var n=this.options.formatLabelContent;return n&&ze(n)?n.call(this,e)+"":null},t.prototype._measure=function(e){var n=this.getMap(),i;e instanceof en?i=n.computeGeometryLength(e):Array.isArray(e)&&(i=n.getProjection().measureLength(e)),this._lastMeasure=i;var o=this._formatLabelContent(i);if(o)return o;var s=[this.translator.translate("distancetool.units.meter"),this.translator.translate("distancetool.units.kilometer"),this.translator.translate("distancetool.units.feet"),this.translator.translate("distancetool.units.mile")],a="",l=this.options.decimalPlaces;return this.options.metric&&(a+=i<1e3?i.toFixed(l)+s[0]:(i/1e3).toFixed(l)+s[1]),this.options.imperial&&(i*=3.2808399,a.length>0&&(a+=`
`),a+=i<5280?i.toFixed(l)+s[2]:(i/5280).toFixed(l)+s[3]),a},t.prototype._registerMeasureEvents=function(){this.on("drawstart",this._msOnDrawStart,this).on("drawvertex",this._msOnDrawVertex,this).on("mousemove",this._msOnMouseMove,this).on("drawend",this._msOnDrawEnd,this)},t.prototype._afterEnable=function(){this._registerMeasureEvents()},t.prototype._afterDisable=function(){this.off("drawstart",this._msOnDrawStart,this).off("drawvertex",this._msOnDrawVertex,this).off("mousemove",this._msOnMouseMove,this).off("drawend",this._msOnDrawEnd,this)},t.prototype._msOnDrawStart=function(e){var n=this.getMap(),i=bo(),o="distancetool_"+i,s="distancetool_markers_"+i,a=this.options.zIndex,l=this.options.enableAltitude;n.getLayer(o)?(this._measureLineLayer=n.getLayer(o),this._measureMarkerLayer=n.getLayer(s)):(this._measureLineLayer=new ro(o,{zIndex:a,enableAltitude:l}).addTo(n),this._measureMarkerLayer=new ro(s,{zIndex:a,enableAltitude:l}).addTo(n)),this._measureLayers.push(this._measureLineLayer),this._measureLayers.push(this._measureMarkerLayer),this._pushLayers([this._measureLineLayer,this._measureMarkerLayer]);var h=this._getFirstCoordinate()||e.coordinate,u=new bn(h.copy(),{symbol:this.options.vertexSymbol}),c=this.translator.translate("distancetool.start"),f=new Ha(c,h.copy(),this.options.labelOptions);this._lastVertex=f,this._addVertexMarker(u,f)},t.prototype._msOnMouseMove=function(e){var n=this._measure(this._msGetCoordsToMeasure(e));if(!this._tailMarker){var i=Bi(this.options.vertexSymbol);i.markerWidth/=2,i.markerHeight/=2,this._tailMarker=new bn(e.coordinate,{symbol:i}).addTo(this._measureMarkerLayer),this._tailLabel=new Ha(n,e.coordinate,this.options.labelOptions).addTo(this._measureMarkerLayer)}var o=this._getLasttCoordinate()||e.coordinate;this._tailMarker.setCoordinates(o.copy()),this._tailLabel.setContent(n),this._tailLabel.setCoordinates(o.copy())},t.prototype._msGetCoordsToMeasure=function(e){return e.geometry.getCoordinates().concat([e.coordinate])},t.prototype._msOnDrawVertex=function(e){var n=this._getLasttCoordinate()||e.coordinate,i=e.geometry,o=new bn(n.copy(),{symbol:this.options.vertexSymbol}),s=this._measure(i),a=new Ha(s,n.copy(),this.options.labelOptions);this._addVertexMarker(o,a),this._lastVertex=a},t.prototype._addVertexMarker=function(e,n){this._vertexes||(this._vertexes=[]),this._historyPointer!==void 0&&this._vertexes.length>this._historyPointer-1&&(this._vertexes.length=this._historyPointer-1),this._vertexes.push({label:n,marker:e}),this._measureMarkerLayer.addGeometry(e),n&&this._measureMarkerLayer.addGeometry(n)},t.prototype._msOnDrawEnd=function(e){if(this._clearTailMarker(),e.geometry.getCoordinates().length<2){this._lastMeasure=0,this._clearMeasureLayers();return}var n=this._lastVertex.getSize();n||(n=new kn(10,10)),this._addClearMarker(this._lastVertex.getCoordinates(),this._lastVertex._getPrjCoordinates(),n.width);var i=e.geometry.copy();i.setCoordinates(e.geometry.getCoordinates()),i.addTo(this._measureLineLayer),this._lastMeasure=i.getLength()},t.prototype._addClearMarker=function(e,n,i){var o=this.options.clearButtonSymbol,s={markerDx:(o.markerDx||0)+i,textDx:(o.textDx||0)+i};Array.isArray(o)&&(s=o.map(function(u){return u?{markerDx:(u.markerDx||0)+i,textDx:(u.textDx||0)+i}:null})),o=Bi(o,s);var a=new bn(e,{symbol:o}),l=this._measureLineLayer,h=this._measureMarkerLayer;a.on("click",function(){return l.remove(),h.remove(),!1},this),a.addTo(this._measureMarkerLayer)},t.prototype._clearTailMarker=function(){this._tailMarker&&(this._tailMarker.remove(),delete this._tailMarker),this._tailLabel&&(this._tailLabel.remove(),delete this._tailLabel)},t.prototype._clearMeasureLayers=function(){this._measureLineLayer.remove(),this._measureMarkerLayer.remove()},t.prototype._getFirstCoordinate=function(){if(!this._geometry)return null;var e=this._geometry.getCoordinates()||[];return e[0]},t.prototype._getLasttCoordinate=function(){if(!this._geometry)return null;var e=this._geometry.getCoordinates()||[];return e[e.length-1]},t}(gr);j2.mergeOptions(mI);var yI={mode:"Polygon",symbol:{lineColor:"#000000",lineWidth:2,lineOpacity:1,lineDasharray:"",polygonFill:"#ffffff",polygonOpacity:.5},language:"zh-CN"},vI=function(r){Et(t,r);function t(e){var n=r.call(this,e)||this;return n.translator=new B2(n.options.language),n._measureLayers=[],n}return t.prototype._measure=function(e){var n=this.getMap(),i;e instanceof en?i=n.computeGeometryArea(e):Array.isArray(e)&&(i=n.getProjection().measureArea(e)),this._lastMeasure=i;var o=this._formatLabelContent(i);if(o)return o;var s=[this.translator.translate("areatool.units.meter"),this.translator.translate("areatool.units.kilometer"),this.translator.translate("areatool.units.feet"),this.translator.translate("areatool.units.mile")],a="",l=this.options.decimalPlaces;if(this.options.metric&&(a+=i<1e6?i.toFixed(l)+s[0]:(i/1e6).toFixed(l)+s[1]),this.options.imperial){i*=Math.pow(3.2808399,2),a.length>0&&(a+=`
`);var h=5280*5280;a+=i<h?i.toFixed(l)+s[2]:(i/h).toFixed(l)+s[3]}return a},t.prototype._msGetCoordsToMeasure=function(e){return e.geometry.getShell().concat([e.coordinate])},t.prototype._msOnDrawVertex=function(e){var n=this._getLasttCoordinate()||e.coordinate,i=new bn(n.copy(),{symbol:this.options.vertexSymbol});this._measure(e.geometry),this._lastVertex=i,this._addVertexMarker(i)},t.prototype._msOnDrawEnd=function(e){this._clearTailMarker();var n,i=this.getMap();if(e.point2d)n=i._pointToPrj(e.point2d);else{var o=e.geometry._getPrjCoordinates()||[];o=o.slice(0,o.length-1),n=o[o.length-1]}if(e.geometry.getShell().length<3){this._lastMeasure=0,this._clearMeasureLayers();return}var s=this._measure(e.geometry),a=this._getLasttCoordinate(),l=new Ha(s,a.copy(),this.options.labelOptions).addTo(this._measureMarkerLayer),h=l.getSize();h||(h=new kn(10,10)),this._addClearMarker(a.copy(),n,h.width);var u=e.geometry.copy();u.setCoordinates(e.geometry.getCoordinates()),u.addTo(this._measureLineLayer),this._lastMeasure=u.getArea()},t}(j2);vI.mergeOptions(yI);function Vi(r,t,e){var n=Array.isArray(t);n||(t=[t]);var i,o;if(e&&e.drawTool&&e.drawTool.options&&(o=e.drawTool.options.transformCoordinate),o&&ze(o))i=t.map(function(l){return r.unproject(l)}),i=i.map(function(l){var h=o(l,e);return h||l});else{if(!e||!e.target||!e.target._queryTerrainInfo)return i=t.map(function(l){return r.unproject(l)}),n?i:i[0];var s=e.target,a=e.enableAltitude;i=t.map(function(l){if(a){var h=s.prjToContainerPoint(l),u=s._queryTerrainInfo(h);if(u&&u.coordinate)return u.coordinate}return r.unproject(l)})}return n?i:i[0]}var V2={create:function(r,t,e){var n=Vi(r,t[0],e),i=new Ti(n,0);return i},update:function(r,t,e,n){var i=e.getMap(),o=Array.isArray(t)?t[t.length-1]:t,s=Vi(r,o,n),a=i.computeLength(e.getCenter(),s);e.setRadius(a)},generate:function(r){return r}};gr.registerMode("circle",Gt({clickLimit:2,action:["click","mousemove","click"]},V2)),gr.registerMode("freeHandCircle",Gt({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},V2));var G2={create:function(r,t,e){var n=Vi(r,t[0],e),i=new no(n,0,0);return i},update:function(r,t,e,n){var i=e.getMap(),o=e.getCenter(),s=Array.isArray(t)?t[t.length-1]:t,a=Vi(r,s,n),l=i.computeLength(o,new at({x:a.x,y:o.y})),h=i.computeLength(o,new at({x:o.x,y:a.y}));e.setWidth(l*2),e.setHeight(h*2)},generate:function(r){return r}};gr.registerMode("ellipse",Gt({clickLimit:2,action:["click","mousemove","click"]},G2)),gr.registerMode("freeHandEllipse",Gt({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},G2));var U2={create:function(r,t){var e=new _n([]);return e._firstClick=t[0],e},update:function(r,t,e,n){var i=e.getMap(),o=n.containerPoint,s=i.prjToContainerPoint(e._firstClick),a=[[s.x,s.y],[o.x,s.y],[o.x,o.y],[s.x,o.y]],l=a.map(function(u){return i._containerPointToPrj(new W(u))}),h=Vi(r,l,n);e.setCoordinates(h)},generate:function(r){return r}};gr.registerMode("rectangle",Gt({clickLimit:2,action:["click","mousemove","click"]},U2)),gr.registerMode("freeHandRectangle",Gt({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},U2)),gr.registerMode("point",{clickLimit:1,action:["click","mousemove"],create:function(r,t,e){var n=Vi(r,t[0],e),i=new bn(n);return i},generate:function(r){return r},update:function(r,t,e,n){if(Array.isArray(t)&&(t=t[t.length-1]),!t)return e;var i=Vi(r,t,n);return e.setCoordinates(i),e}});var $2={create:function(r,t,e){var n=Vi(r,t,e),i=new Pn(n);return i.setCoordinates(n),i},update:function(r,t,e,n){var i=e.getSymbol(),o;Array.isArray(t)?o=t:(o=e._drawPrjs||[],o.push(t)),e._drawPrjs=o;var s=Vi(r,o,n);e.setCoordinates(s);var a=e.getLayer();if(a){var l=a.getGeometryById("polygon");if(!l&&o.length>=3){if(l=new _n([s],{id:"polygon",zIndex:-1}),i){var h=Bi(i,{lineOpacity:0});l.setSymbol(h)}l.addTo(a)}l&&l.setCoordinates([s])}},generate:function(r){var t=new _n(r.getCoordinates(),{symbol:r.getSymbol(),properties:r.getProperties()});return t._projCode=r._projCode,t}};gr.registerMode("polygon",Gt({action:["click","mousemove","dblclick"]},$2)),gr.registerMode("freeHandPolygon",Gt({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},$2));var Nh={create:function(r,t,e){var n=Vi(r,t,e),i=new Pn(n);return i.setCoordinates(n),i},update:function(r,t,e,n){var i;Array.isArray(t)?i=t:(i=e._drawPrjs||[],i.push(t)),e._drawPrjs=i;var o=Vi(r,i,n);e.setCoordinates(o)},generate:function(r){return r}};gr.registerMode("linestring",Gt({action:["click","mousemove","dblclick"]},Nh)),gr.registerMode("freeHandLinestring",Gt({action:["mousedown touchstart","mousemove touchmove","mouseup touchend"]},Nh)),gr.registerMode("arccurve",{action:["click","mousemove","dblclick"],create:function(r,t){var e=t.map(function(i){return r.unproject(i)}),n=new tf(e);return n._setPrjCoordinates(t),n},update:Nh.update,generate:function(r){return r}}),gr.registerMode("quadbeziercurve",{action:["click","mousemove","dblclick"],create:function(r,t){var e=t.map(function(i){return r.unproject(i)}),n=new T2(e);return n._setPrjCoordinates(t),n},update:Nh.update,generate:function(r){return r}}),gr.registerMode("cubicbeziercurve",{action:["click","mousemove","dblclick"],create:function(r,t){var e=t.map(function(i){return r.unproject(i)}),n=new A2(e);return n._setPrjCoordinates(t),n},update:Nh.update,generate:function(r){return r}}),gr.registerMode("boxZoom",{action:["mousedown","mousemove","mouseup"],create:function(r,t){t=t[0];var e=r.unproject(t),n=new bn(e);return n._firstClick=t,n},update:function(r,t,e,n){var i=e.getMap(),o=i.prjToContainerPoint(e._firstClick),s=n.containerPoint;t=i._containerPointToPrj(new at(Math.min(o.x,s.x),Math.min(o.y,s.y)));var a=r.unproject(t);e.setCoordinates(a)._setPrjCoordinates(t),e.updateSymbol({markerWidth:Math.abs(o.x-s.x),markerHeight:Math.abs(o.y-s.y)})},generate:function(r){return r}});var xI={eventsPropagation:!1,eventsToStop:null,dx:0,dy:0,autoPan:!1,autoPanDuration:600,single:!0,animation:"scale",animationOnHide:!1,animationDuration:500,pitchWithMap:!1,rotateWithMap:!1,visible:!0,roundPoint:!1,collision:!1,collisionBufferSize:2,collisionWeight:0,collisionFadeIn:!1,zIndex:0},Gs=function(r){Et(t,r);function t(e){var n=r.call(this,e)||this;return n.proxyOptions(),n}return t.prototype._appendCustomClass=function(e){if(!e)return console.warn("dom is null:",e),this;if(this.options.cssName){var n=this.options.cssName;Array.isArray(n)||(n=[n]),n.forEach(function(i){e.classList.add(i)})}return this},t.prototype.onAdd=function(){},t.prototype.onRemove=function(){},t.prototype.onDomRemove=function(){},t.prototype.getEvents=function(){return{}},t.prototype.getOwnerEvents=function(){return{}},t.prototype.buildOn=function(){return null},t.prototype.addTo=function(e){return this._owner=e,this._switchEvents("on"),this.onAdd&&this.onAdd(),this.fire("add"),this},t.prototype.getMap=function(){return this._owner?this._owner.getBaseLayer?this._owner:this._owner.getMap():null},t.prototype._collides=function(){var e=this.getMap();return e?(e._addUI(this),e._insertUICollidesQueue(),this):this},t.prototype._collidesEffect=function(e){var n=this.getDOM();if(!n)return this;var i=e?"visible":"hidden";if(n.style.visibility=i,!n.classList||!n.classList.add)return this;if(!this.options.collisionFadeIn)return this;var o=n.classList,s="mtk-ui-fadein",a=o.contains(s);return e&&!a?n.classList.add(s):!e&&a&&n.classList.remove(s),this},t.prototype.show=function(e){var n=this,i=this.getMap();if(!i)return this;this.options.visible=!0,e=e||this._coordinate||this._owner.getCenter(),e instanceof at||(e=new at(e));var o=this.isVisible();this._showBySymbolChange||this.fire("showstart");var s=this._getUIContainer();this._coordinate=e,this._removePrevDOM(),this._mapEventsOn||this._switchMapEvents("on");var a=this.__uiDOM=this.buildOn();a.eventsPropagation=this.options.eventsPropagation,this._observerDomSize(a);var l=this.options.zIndex;if(!a)return this._showBySymbolChange||this.fire("showend"),this._collides(),this.setZIndex(l),this;this._measureSize(a),this._singleton()&&(a._uiComponent=this,i[this._uiDomKey()]=a),this._setPosition(),a.style[bc]=null,s.appendChild(a);var h=this._getAnimation();if(o&&(h.ok=!1),h.ok&&(h.fade&&(a.style.opacity="0"),h.scale)){if(this.getTransformOrigin){var u=this.getTransformOrigin();a.style[_5]=u}a.style[ya]=this._toCSSTranslate(this._pos)+" scale(0)"}this.isSupportZoomFilter()||(a.style.display=""),this.options.eventsToStop&&Ln(a,this.options.eventsToStop,jr);var c=h.transition;return h.ok&&c&&(a.offsetHeight,c&&(a.style[bc]=c),h.fade&&(a.style.opacity="1"),h.scale&&(a.style[ya]=this._toCSSTranslate(this._pos)+" scale(1)")),this._showBySymbolChange||this.fire("showend"),this._collides(),clearTimeout(this._autoPanId),this.options.autoPan&&(this._autoPanId=setTimeout(function(){n._autoPan()},32)),this.setZIndex(l),this},t.prototype.hide=function(){var e=this;if(!this.getDOM())return this;this._onDomMouseout&&this._onDomMouseout(),this.options.visible=!1;var n=this._getAnimation(),i=this.getDOM();return this.options.animationOnHide||(n.ok=!1),n.ok?(i.offsetHeight,i.style[bc]=n.transition,setTimeout(function(){i.style.display="none",e.fire("hide")},this.options.animationDuration)):(i.style.display="none",this.fire("hide")),n.fade&&(i.style.opacity="0"),n.scale&&(i.style[ya]=this._toCSSTranslate(this._pos)+" scale(0)"),this._switchMapEvents("off"),this._collides(),this},t.prototype.isVisible=function(){if(!this.options.visible)return!1;var e=this.getDOM();return this.getMap()&&e&&e.parentNode&&e.style.display!=="none"},t.prototype.remove=function(){if(delete this._mapEventsOn,!this._owner)return this;var e=this.getMap();return e&&e._removeUI(this),this.hide(),this._switchEvents("off"),this.onRemove&&this.onRemove(),!this._singleton()&&this.__uiDOM&&this._removePrevDOM(),delete this._owner,this.fire("remove"),this._collides(),this},t.prototype.getSize=function(){return this._domContentRect&&this._size&&(this._size.width=this._domContentRect.width,this._size.height=this._domContentRect.height),this._size?this._size.copy():null},t.prototype.getOwner=function(){return this._owner},t.prototype.getDOM=function(){return this.__uiDOM},t.prototype.setZIndex=function(e){if(!It(e))return this;var n=this.getDOM();return n?(n.style.zIndex=e+"",e!==this.options.zIndex&&(this.options.zIndex=e),this):this},t.prototype._roundPoint=function(e){return this.options.roundPoint&&(e=e._round()),e},t.prototype.getPosition=function(){if(!this.getMap())return null;var e=this._roundPoint(this._getViewPoint());if(this.getOffset){var n=this._roundPoint(this.getOffset());n&&e._add(n)}return e},t.prototype._getAnimation=function(){for(var e={fade:!1,scale:!1,ok:!1,transition:""},n=this.options.animation?this.options.animation.split(","):[],i=0;i<n.length;i++){var o=Zp(n[i]);o==="fade"?e.fade=!0:o==="scale"&&(e.scale=!0)}var s=null;return e.fade&&(s="opacity "+this.options.animationDuration+"ms"),e.scale&&(s=s?s+",":"",s+=ya+" "+this.options.animationDuration+"ms"),e.transition=s,e.ok=s!==null,e},t.prototype._getViewPoint=function(){var e=0,n=this._coordinate||{};if(It(n.z)?e=n.z:this._owner&&this._owner.getAltitude&&(e=this._owner.getAltitude()||0,It(e)||(e=0)),this._owner.getLayer){var i=this._owner.getLayer();i&&i.isVectorLayer&&(e=this._owner._getAltitude()||0,It(e)||(e=0))}var o=this._meterToPoint(this._coordinate,e);return this.getMap().coordToViewPoint(this._coordinate,void 0,o)._add(this.options.dx,this.options.dy)},t.prototype._meterToPoint=function(e,n){return n},t.prototype._autoPan=function(){var e=this.getMap(),n=this.getDOM();if(!(!n||!e||e.isMoving())){var i=this._getViewPoint()._round(),o=e.width,s=e.height,a=e.getContainer();if(n&&a&&n.getBoundingClientRect){var l=a.getBoundingClientRect(),h=l.left,u=l.top,c=50,f=n.getBoundingClientRect(),d=0,p=0,g=f.left,m=f.right,y=f.top,x=f.bottom,v=f.width,_=f.height;if(g-=h,m-=h,y-=u,x-=u,v>0&&_>0){if(g<c&&(d=c-g),d===0&&m+c>o&&(d=-(m+c-o)),y<c&&(p=c-y),p===0&&x+c>s&&(p=-(x+c-s)),d!==0||p!==0){var w=e.getPitch();w>40&&p!==0&&this._coordinate?e.animateTo({center:this._coordinate},{duration:e.options.panAnimationDuration}):e.panBy([Math.ceil(d),Math.ceil(p)])}return}}var b=e.viewPointToContainerPoint(i),A=this.getOffset(),T=b.add(A),S=e.viewPointToPrj(i),M=parseInt(n.clientWidth+""),E=parseInt(n.clientHeight+""),P=50,k=0,O=0;if(T.x<0?k=-T.x+P:T.x+M>o&&(k=-(T.x+M-o)-P),T.y-E<0?O=Math.abs(T.y-E)+P:T.y+E>s&&(O=s-(T.y+E)-P),M>=o&&(k=o/2-b.x),O!==0||k!==0){var I=b.add(k,O),D=e._containerPointToPoint(I)._sub(e._prjToPoint(e._getPrjCenter())),z=e._pointToPrj(e._prjToPoint(S).sub(D));e._panAnimation(z)}}},t.prototype._measureSize=function(e){var n=this._getUIContainer();e.style.position="absolute";var i=e.style.bottom?"bottom":"top";if(e.style.display="",n.appendChild(e),e.getBoundingClientRect){var o=e.getBoundingClientRect();this._size=new kn(o.width,o.height)}else this._size=new kn(e.clientWidth,e.clientHeight);return e.style.display="none",e.style.left="0px",e.style[i]="0px",this._size},t.prototype._removePrevDOM=function(){this.onDomRemove&&this.onDomRemove();var e=this.options.eventsToStop;if(this._singleton()){var n=this.getMap(),i=this._uiDomKey();if(n[i]){e&&Un(n[i],e,jr);var o=n[i]._uiComponent;o&&o!==this&&o.isVisible()&&o.fire("hide"),va(n[i]),o&&!this.hideDom&&o._switchMapEvents("off"),delete n[i]}delete this.__uiDOM}else this.__uiDOM&&(e&&Un(this.__uiDOM,e,jr),va(this.__uiDOM),delete this.__uiDOM);this._resizeObserver&&(this._resizeObserver.disconnect(),delete this._resizeObserver,delete this._domContentRect)},t.prototype._uiDomKey=function(){return"__ui_"+this._getClassName()},t.prototype._singleton=function(){return this.options.single},t.prototype._getUIContainer=function(){return this.getMap().getPanels().ui},t.prototype._getClassName=function(){return"UIComponent"},t.prototype._switchMapEvents=function(e){var n=this.getMap();if(n){this._mapEventsOn=e==="on";var i=this._getDefaultEvents();if(this.getEvents&&Gt(i,this.getEvents()),i)for(var o in i)i.hasOwnProperty(o)&&n[e](o,i[o],this)}},t.prototype._switchEvents=function(e){var n=this._getOwnerEvents();if(this._owner)for(var i in n)n.hasOwnProperty(i)&&this._owner[e](i,n[i],this)},t.prototype._getDefaultEvents=function(){return{"zooming rotate pitch":this.onEvent,zoomend:this.onZoomEnd,moving:this.onMoving,moveend:this.onMoving,resize:this.onResize}},t.prototype._getOwnerEvents=function(){var e={};return this._owner&&this._owner instanceof en&&(e.positionchange=this.onGeometryPositionChange,e.symbolchange=this._updatePosition),this.getOwnerEvents&&Gt(e,this.getOwnerEvents()),e},t.prototype.onGeometryPositionChange=function(e){if(this._owner&&this.isVisible()){this._showBySymbolChange=!0;var n=e.target,i=n.getCenter();if(n._getAltitude){var o=n._getAltitude();It(o)&&(i.z=o)}this.show(i),delete this._showBySymbolChange}},t.prototype.onMoving=function(){this.isVisible()&&this.getMap().isTransforming()&&this._updatePosition()},t.prototype.onEvent=function(){this.isVisible()&&this._updatePosition()},t.prototype.onZoomEnd=function(){this.isVisible()&&this._setPosition()},t.prototype.onResize=function(){this.isVisible()&&this._setPosition()},t.prototype.onDomSizeChange=function(){this.isVisible()&&(this._setPosition(),this._collides())},t.prototype._updatePosition=function(){if(!this.getMap())return this;var e=this.getMap()._getRenderer();return e.callInNextFrame(this._setPosition.bind(this)),this},t.prototype._setPosition=function(){var e=this.getDOM();if(e){e.style[bc]=null;var n=this.getPosition();this._pos=n,e.style[ya]=this._toCSSTranslate(n)+" scale(1)"}},t.prototype._toCSSTranslate=function(e){if(!e)return"";if(be.any3d){var n=this.getMap(),i=n?n.getBearing():0,o=n?n.getPitch():0,s="";return this.options.pitchWithMap&&o&&(s+=" rotateX(".concat(Math.round(o),"deg)")),this.options.rotateWithMap&&i&&(s+=" rotateZ(".concat(Math.round(-i),"deg)")),"translate3d("+Math.fround(e.x)+"px,"+Math.fround(e.y)+"px, 0px)"+s}else return"translate("+Math.fround(e.x)+"px,"+Math.fround(e.y)+"px)"},t.prototype._observerDomSize=function(e){var n=this;return!e||!be.resizeObserver||this._resizeObserver?this:(this._resizeObserver=new ResizeObserver(function(i){if(i.length){var o=i[0].borderBoxSize;o&&o.length?n._domContentRect={width:o[0].inlineSize,height:o[0].blockSize}:n._domContentRect=i[0].contentRect}else delete n._domContentRect;n.onDomSizeChange&&n.onDomSizeChange()}),this._resizeObserver.observe(e),this)},t.prototype.isSupportZoomFilter=function(){return!1},t.prototype.onConfig=function(){return this._updatePosition(),this},t.isSupport=function(e){return!!(e&&ze(e.on)&&ze(e.off)&&ze(e.getCenter))},t.prototype._bindDomEvents=function(e,n){if(e){var i=this._getDomEvents()||{},o=n==="on"?Ln:Un;for(var s in i)n==="on"&&Un(e,s,i[s]),o(e,s,i[s],this)}},t.prototype._getDomEvents=function(){return{mouseover:this._onDomMouseover,mouseout:this._onDomMouseout}},t.prototype._configMapPreventWheelScroll=function(e){var n=this.getMap();n&&(this.options.eventsPropagation||(n.options.preventWheelScroll=e))},t.prototype._onDomMouseover=function(){this._configMapPreventWheelScroll(!1)},t.prototype._onDomMouseout=function(){this._configMapPreventWheelScroll(!0)},t}(to(hi));Gs.mergeOptions(xI);var _I={containerClass:null,eventsPropagation:!0,draggable:!1,single:!1,content:null,altitude:0,minZoom:0,maxZoom:null,horizontalAlignment:"middle",verticalAlignment:"middle"},W2="mousedown mouseup mouseenter mouseover mouseout mousemove click dblclick contextmenu keypress touchstart touchmove touchend",xm=function(r){Et(t,r);function t(e,n){var i=r.call(this,n)||this;return i._markerCoord=new at(e),i}return t.prototype._getClassName=function(){return"UIMarker"},t.prototype.setCoordinates=function(e){return this._markerCoord=e,this.fire("positionchange"),this.isVisible()&&(this._coordinate=this._markerCoord,this._setPosition(),this._collides()),this},t.prototype.getCoordinates=function(){return this._markerCoord},t.prototype.getCenter=function(){return this.getCoordinates()},t.prototype.getAltitude=function(){var e=this.getCoordinates()||{};return It(e.z)?e.z:this.options.altitude||0},t.prototype.setAltitude=function(e){return It(e)&&this._markerCoord&&(this._markerCoord.z=e,this._updatePosition&&(this._updatePosition(),this._collides())),this},t.prototype.setContent=function(e){var n=this.options.content;return this.options.content=e,this.fire("contentchange",{old:n,new:e}),this.isVisible()&&this.show(),this},t.prototype.getContent=function(){return this.options.content},t.prototype.onAdd=function(){if(this._owner&&!this._owner.isMap){var e=this._owner;throw new Error("UIMarker Can only be added to the map, but owner is:"+e.getJSONType&&e.getJSONType())}return this.show(),this},t.prototype.show=function(){return r.prototype.show.call(this,this._markerCoord)},t.prototype.flash=function(e,n,i,o){return Up.call(this,e,n,i,o)},t.prototype.buildOn=function(){var e=this.getDOM();this._bindDomEvents(e,"off");var n,i=this.options.content,o=Se(i);return o||ze(i)?(n=de("div"),o?n.innerHTML=this.options.content:i.bind(this)(n)):n=this.options.content,this.options.containerClass&&(n.className=this.options.containerClass),this._registerDOMEvents(n),this._bindDomEvents(n,"on"),this._appendCustomClass(n),n},t.prototype.getOffset=function(){var e=this.getSize(),n=-e.width/2,i=-e.height/2,o=this.options,s=o.horizontalAlignment,a=o.verticalAlignment;return s==="left"?n=-e.width:s==="right"&&(n=0),a==="top"?i=-e.height:a==="bottom"&&(i=0),new W(n,i)},t.prototype.getTransformOrigin=function(){return"center center"},t.prototype.onDomRemove=function(){var e=this.getDOM();this._removeDOMEvents(e)},t.prototype.isDragging=function(){return this.draggable?this.draggable.isDragging():!1},t.prototype._registerDOMEvents=function(e){Ln(e,W2,this._onDomEvents,this)},t.prototype._onDomEvents=function(e,n){var i=this.getMap()._parseEvent(e,e.type);if(n=n||e.type,n==="mousedown"&&(this._mousedownEvent=e),n==="mouseup"&&(this._mouseupEvent=e),!(n==="click"&&this._mouseClickPositionIsChange())&&(n==="touchstart"&&(this._touchstartTime=Qe()),this.fire(n,i),n==="touchend"&&be.touch)){var o=this.getMap().options.clickTimeThreshold||280;Qe()-this._touchstartTime<o&&this._onDomEvents(e,"click")}},t.prototype._removeDOMEvents=function(e){Un(e,W2,this._onDomEvents)},t.prototype._mouseClickPositionIsChange=function(){var e=this._mousedownEvent||{},n=e.x,i=e.y,o=this._mouseupEvent||{},s=o.x,a=o.y;return n!==s||i!==a},t.prototype._getConnectPoints=function(){var e=this.getMap(),n=e.coordToContainerPoint(this.getCoordinates()),i=this.getSize(),o=i.width,s=i.height,a=[e.containerPointToCoordinate(n.add(-o/2,0)),e.containerPointToCoordinate(n.add(o/2,0)),e.containerPointToCoordinate(n.add(0,s/2)),e.containerPointToCoordinate(n.add(0,-s/2))];return a},t.prototype._getViewPoint=function(){var e=0;if(this._owner){var n=this.getAltitude();n>0&&(e=this._meterToPoint(this._coordinate,n))}return this.getMap().coordToViewPoint(this._coordinate,void 0,e)._add(this.options.dx,this.options.dy)},t.prototype._getDefaultEvents=function(){return Gt({},r.prototype._getDefaultEvents.call(this),{"zooming zoomend":this.onZoomFilter})},t.prototype._setPosition=function(){this.onZoomFilter(),r.prototype._setPosition.call(this)},t.prototype.onZoomFilter=function(){var e=this.getDOM();e&&(!this.isVisible()&&e.style.display!=="none"?e.style.display="none":this.isVisible()&&e.style.display==="none"&&(e.style.display=""))},t.prototype.isVisible=function(){var e=this.getMap();if(!e||!this.options.visible)return!1;var n=e.getZoom(),i=this.options,o=i.minZoom,s=i.maxZoom;if(!U(o)&&n<o||!U(s)&&n>s)return!1;var a=this.getDOM();return a&&!0},t.prototype.isSupportZoomFilter=function(){return!0},t}(Dg(Gs));xm.mergeOptions(_I);var Z2=be.touch?"touchstart mousedown":"mousedown",bI=function(r){Et(t,r);function t(e){return r.call(this,e)||this}return t.prototype.addHooks=function(){this.target.on(Z2,this._startDrag,this)},t.prototype.removeHooks=function(){this.target.off(Z2,this._startDrag,this)},t.prototype._startDrag=function(e){var n=e.domEvent;n.touches&&n.touches.length>1||n.button===2||this.isDragging()||(this.target.on("click",this._endDrag,this),this._lastCoord=e.coordinate,this._lastPoint=e.containerPoint,this._prepareDragHandler(),this._dragHandler.onMouseDown(e.domEvent),this.target.fire("dragstart",e))},t.prototype._prepareDragHandler=function(){this._dragHandler=new Eh(this.target.getDOM(),{cancelOn:this._cancelOn.bind(this),ignoreMouseleave:!0}),this._dragHandler.on("mousedown",this._onMouseDown,this),this._dragHandler.on("dragging",this._dragging,this),this._dragHandler.on("mouseup",this._endDrag,this),this._dragHandler.enable()},t.prototype._cancelOn=function(e){var n=e.srcElement||e.target,i=n.tagName.toLowerCase();return i==="button"||i==="input"||i==="select"||i==="option"||i==="textarea"},t.prototype._onMouseDown=function(e){jr(e.domEvent)},t.prototype._dragging=function(e){var n=this.target,i=n.getMap(),o=i._parseEvent(e.domEvent),s=o.domEvent,a=s;if(!(a.touches&&a.touches.length>1)){if(!this._isDragging){this._isDragging=!0;return}var l=o.coordinate,h=o.containerPoint;this._lastCoord||(this._lastCoord=l),this._lastPoint||(this._lastPoint=h);var u=l.sub(this._lastCoord),c=h.sub(this._lastPoint);this._lastCoord=l,this._lastPoint=h,this.target.setCoordinates(this.target.getCoordinates().add(u)),o.coordOffset=u,o.pointOffset=c,n.fire("dragging",o)}},t.prototype._endDrag=function(e){var n=this.target,i=n.getMap();if(this._dragHandler&&(n.off("click",this._endDrag,this),this._dragHandler.disable(),delete this._dragHandler),delete this._lastCoord,delete this._lastPoint,this._isDragging=!1,!!i){var o=i._parseEvent(e.domEvent);n&&n._mouseClickPositionIsChange&&n._mouseClickPositionIsChange()&&n.fire("dragend",o)}},t.prototype.isDragging=function(){return!!this._isDragging},t}(ji);xm.addInitHook("addHandler","draggable",bI);var wI=/\{ *([\w_]+) *\}/g,X2={containerClass:"maptalks-msgBox",autoPan:!0,autoCloseOn:null,autoOpenOn:"click",width:"auto",minHeight:120,custom:!1,title:null,content:null,enableTemplate:!1},AI=new kn(0,0),_m=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype._getClassName=function(){return"InfoWindow"},t.prototype.addTo=function(e){return e instanceof en&&(e.getInfoWindow()&&e.getInfoWindow()!==this&&e.removeInfoWindow(),e._infoWindow=this),r.prototype.addTo.call(this,e)},t.prototype.setContent=function(e){var n=this.options.content;return this.options.content=e,this.fire("contentchange",{old:n,new:e}),this.isVisible()&&this.show(this._coordinate),this},t.prototype.getContent=function(){return this.options.content},t.prototype.setTitle=function(e){var n=e;return this.options.title=e,this.fire("contentchange",{old:n,new:e}),this.isVisible()&&this.show(this._coordinate),this},t.prototype.getTitle=function(){return this.options.title},t.prototype.buildOn=function(){var e=this,n=ze(this.options.content),i=Se(this.options.content);if(this.options.custom){var o=this.getDOM(),s=void 0;if(this._bindDomEvents(o,"off"),i||n){var a=de("div");i?(a.innerHTML=this.options.content,this._replaceTemplate(a)):this.options.content.bind(this)(a),s=a}else this._replaceTemplate(this.options.content),s=this.options.content;return this._bindDomEvents(s,"on"),this._appendCustomClass(s),s}this._bindDomEvents(this.getDOM(),"off");var l=de("div");this.options.containerClass&&(l.className=this.options.containerClass);var h=this._getWindowWidth();l.style.width=It(h)?h+"px":"auto",l.style.bottom="0px";var u='<em class="maptalks-ico"></em>';this.options.title&&(u+="<h2>"+this.options.title+"</h2>"),u+='<a href="javascript:void(0);" class="maptalks-close">×</a><div class="maptalks-msgContent"></div>',l.innerHTML=u,this._replaceTemplate(l);var c=l.querySelector(".maptalks-msgContent");i||n?i?c.innerHTML=this.options.content:this.options.content.bind(this)(c):c.appendChild(this.options.content),this._onCloseBtnClick=function(d){e.options.eventsPropagation||(Qi(d),jr(d)),e.hide()};var f=l.querySelector(".maptalks-close");return Hi(f,"click touchend",this._onCloseBtnClick),n||this._replaceTemplate(c),this._bindDomEvents(l,"on"),this._appendCustomClass(l),l},t.prototype._replaceTemplate=function(e){var n=this._owner;if(this.options.enableTemplate&&n&&n.getProperties&&e&&e.innerHTML){var i=n.getProperties()||{};if(kr(i)){var o=e.innerHTML;e.innerHTML=o.replace(wI,function(s,a){return i[a]})}}return this},t.prototype.getTransformOrigin=function(){var e=this.getSize();return e.width/2+"px bottom"},t.prototype.getOffset=function(){var e=this.getSize(),n=new W(-e.width/2,0);this.options.custom?n._sub(0,e.height):n._sub(4,12);var i=this.getOwner();if(i instanceof bn||i instanceof Hs){var o=void 0,s=void 0;if(i instanceof bn)o=i._getPainter(),s=i.getSize();else{var a=i.getGeometries();if(!a||!a.length)return n;o=a[0]._getPainter(),s=a[0].getSize()}if(s||(s=AI),o){var l=o.getFixedExtent();n._add(l.xmax-s.width/2,l.ymin)}else n._add(0,-s.height)}return n},t.prototype.show=function(e){return this.getMap()?this.getMap().options.enableInfoWindow?r.prototype.show.call(this,e):this:this},t.prototype.getEvents=function(){if(!this.options.autoCloseOn)return null;var e={};return e[this.options.autoCloseOn]=this.hide,e},t.prototype.getOwnerEvents=function(){var e=this.getOwner();if(!this.options.autoOpenOn||!e)return null;var n={};return n[this.options.autoOpenOn]=this._onAutoOpen,n},t.prototype.onRemove=function(){this._onDomMouseout(),this.onDomRemove()},t.prototype.onDomRemove=function(){if(this._onCloseBtnClick){var e=this.getDOM(),n=e.childNodes[2];ks(n,"click touchend",this._onCloseBtnClick),delete this._onCloseBtnClick}},t.prototype._onAutoOpen=function(e){var n=this,i=this.getOwner();setTimeout(function(){i instanceof bn||i instanceof Gs?n.show(i.getCoordinates()):i instanceof Hs?n.show(i.findClosest(e.coordinate)):((i instanceof Pn||i instanceof Ns)&&n.getMap().getScale()>=8&&(e.coordinate=n._rectifyMouseCoordinte(i,e.coordinate)),n.show(e.coordinate))},1)},t.prototype._rectifyMouseCoordinte=function(e,n){var i=this;return e instanceof Pn?this._rectifyLineStringMouseCoordinate(e,n).coordinate:e instanceof Ns?e.getGeometries().map(function(o){return i._rectifyLineStringMouseCoordinate(o,n)}).sort(function(o,s){return o.dis-s.dis})[0].coordinate:n},t.prototype._rectifyLineStringMouseCoordinate=function(e,n){for(var i=this.getMap(),o=e.getCoordinates()||[],s=i.getGLRes(),a=o.map(function(Tn){var nr=i.coordToPointAtRes(Tn,s),ln=Tn.z||0;return i._pointAtResToContainerPoint(nr,s,ln)}),l=i.coordToContainerPoint(n),h=1/0,u=-1,c=0,f=a.length;c<f;c++){var d=a[c],p=l.distanceTo(d);p<h&&(h=p,u=c)}for(var g=[u-1,u,u+1].filter(function(Tn){return Tn>=0&&Tn<=a.length-1}),m=g.map(function(Tn){return a[Tn]}),y=[],x=i.getSize(),v=x.width,_=x.height,c=0,f=m.length-1;c<f;c++){var w=c,b=m[c],A=m[c+1];if(b.x===A.x)for(var T=Math.max(0,Math.min(b.y,A.y)),S=Math.min(_,Math.max(b.y,A.y)),M=T;M<=S;M++)y.push({point:new W(b.x,M),coordinateIndex:w});else for(var E=(A.y-b.y)/(A.x-b.x),P=Math.max(0,Math.min(b.x,A.x)),k=Math.min(v,Math.max(b.x,A.x)),O=P;O<=k;O++){var I=E*(O-b.x)+b.y;y.push({point:new W(O,I),coordinateIndex:w})}}for(var D=1/0,z=-1,L=-1,$,c=0,f=y.length;c<f;c++){var Z=y[c],j=Z.point,st=Z.coordinateIndex,p=l.distanceTo(j);p<D&&(D=p,z=c,L=st,$=j)}if(z<0)return{dis:D,coordinate:n};var lt=m[L],rt=m[L+1],Rt=lt.distanceTo(rt),Ht=$.distanceTo(lt),ee=Ht/Rt,nt=g.map(function(Tn){return o[Tn]}),Dt=nt[L],Vt=nt[L+1],Ct=Dt.x,_e=Dt.y,Ie=Dt.z||0,Jt=Vt.x,Ne=Vt.y,ce=Vt.z||0,ke=Jt-Ct,qe=Ne-_e,Re=ce-Ie,Je=Ct+ke*ee,Le=_e+qe*ee,pn=Ie+Re*ee;return{dis:D,coordinate:new at(Je,Le,pn)}},t.prototype._getWindowWidth=function(){var e=X2.width,n=this.options.width;return n||(n=e),n},t}(Gs);_m.mergeOptions(X2);var Y2="remove hide shapechange positionchange dragend animatestart",TI={width:0,height:0,animation:"fade",containerClass:"maptalks-tooltip",showTimeout:400},MI=function(r){Et(t,r);function t(e,n){n===void 0&&(n={});var i=r.call(this,n)||this;return i._content=e,i}return t.prototype._getClassName=function(){return"ToolTip"},t.prototype.addTo=function(e){if(t.isSupport(e))return e.on("mousemove",this.onMouseMove,this),e.on("mouseout",this.onMouseOut,this),e.on(Y2,this.hideDom,this),r.prototype.addTo.call(this,e);throw new Error("Invalid geometry or UIMarker the tooltip is added to.")},t.prototype.setStyle=function(e){return this.options.containerClass=e,this},t.prototype.getStyle=function(){return this.options.containerClass},t.prototype.getContent=function(){return this._content},t.prototype.buildOn=function(){var e=de("div"),n=this.options||{};n.height&&(e.style.height=n.height+"px"),n.width&&(e.style.width=n.width+"px");var i=n.containerClass||n.cssName;return!i&&n.height&&(e.style.lineHeight=n.height+"px"),ze(this._content)?this._content.bind(this)(e):e.innerHTML='<div class="'.concat(i,'">').concat(this._content,"</div>"),this._appendCustomClass(e),e},t.prototype.onMouseOut=function(){clearTimeout(this._timeout),this.isVisible()&&this._removePrevDOM(),this._switchMapEvents("off")},t.prototype.onMouseMove=function(e){var n=this;clearTimeout(this._timeout);var i=this.getMap();if(i){var o=i.locateByPoint(e.coordinate,-5,25);this.options.showTimeout===0?this.show(o):this._timeout=setTimeout(function(){i&&n.show(o)},this.options.showTimeout)}},t.prototype.onRemove=function(){clearTimeout(this._timeout),this._owner&&(this._owner.off("mousemove",this.onMouseMove,this),this._owner.off("mouseout",this.onMouseOut,this),this._owner.off(Y2,this.hideDom,this))},t.prototype.hideDom=function(){this.hide()},t.prototype.onEvent=function(){return r.prototype.onEvent.call(this),this.hideDom(),this},t.prototype._getViewPoint=function(){return this.getMap().coordToViewPoint(this._coordinate,void 0,0)._add(this.options.dx,this.options.dy)},t}(Gs);MI.mergeOptions(TI);var SI={containerClass:"maptalks-menu",animation:null,animationDelay:10,animationOnHide:!1,autoPan:!1,width:160,maxHeight:0,custom:!1,items:[]},q2=function(r){Et(t,r);function t(e){return r.call(this,e)||this}return t.prototype._getClassName=function(){return"Menu"},t.prototype.addTo=function(e){return e._menu&&e._menu!==this&&e.removeMenu(),e._menu=this,this._owner=e,Gs.prototype.addTo.apply(this,[e])},t.prototype.setItems=function(e){return this.options.items=e,this},t.prototype.getItems=function(){return this.options.items||[]},t.prototype.buildOn=function(){var e;if(this.options.custom)if(Se(this.options.items)){var n=de("div");n.innerHTML=this.options.items,this._appendCustomClass(n),e=n}else e=this.options.items;else{e=de("div"),this.options.containerClass&&xa(e,this.options.containerClass),e.style.width=this._getMenuWidth()+"px";var i=this._createMenuItemDom();e.appendChild(i),Ln(e,"contextmenu",Qi),this._appendCustomClass(e)}return e&&(this._bindDomEvents(e,"off"),this._bindDomEvents(e,"on")),e},t.prototype.getOffset=function(){if(!this.getMap())return null;var e=this.getMap().getSize(),n=this.getMap().viewPointToContainerPoint(this._getViewPoint()),i=this.getSize(),o=0,s=0;return n.x+i.width>e.width&&(o=-i.width),n.y+i.height>e.height&&(s=-i.height),new W(o,s)},t.prototype.getTransformOrigin=function(){var e=this.getOffset()._multi(-1);return e.x+"px "+e.y+"px"},t.prototype.getEvents=function(){return{"_zoomstart _zoomend _movestart _dblclick _click":this._removePrevDOM}},t.prototype._createMenuItemDom=function(){var e=this,n=this.getMap(),i=de("ul");xa(i,"maptalks-menu-items");var o=this.getItems();function s(d){return function(p){var g=n._parseEvent(p,"click");g.target=e,g.owner=e._owner,g.index=d;var m=this._callback(g);m!==!1&&(e.hide(),e._owner&&e._owner.fire("closemenu"))}}for(var a,l,h=0,u=o.length;h<u;h++){if(a=o[h],a==="-"||a==="_")l=de("li"),xa(l,"maptalks-menu-splitter");else{l=de("li");var c=a.item;ze(c)&&(c=c({owner:this._owner,index:h})),l.innerHTML=c,l._callback=a.click,Ln(l,"click",s(h))}i.appendChild(l)}var f=this.options.maxHeight||0;return f>0&&Tc(i,"max-height: "+f+"px; overflow-y: auto;"),i},t.prototype._getMenuWidth=function(){var e=160,n=this.options.width||e;return n},t}(Gs);q2.mergeOptions(SI);var J2={setMenu:function(r){return this._menuOptions=r,this._menu?this._menu.setOptions(r):this.on("contextmenu",this._defaultOpenMenu,this),this},getMenu:function(){return this._menu},openMenu:function(r){var t=this instanceof xe?this:this.getMap();return r||(r=this.getCenter()),this._menu?this._menu.show(r):this._menuOptions&&t&&(this._bindMenu(),this._menu.show(r)),this.fire("openmenu",{coordinate:r}),this},setMenuItems:function(r){return this._menuOptions||(this._menuOptions={}),Array.isArray(r)&&(this._menuOptions.custom=!1),this._menuOptions.items=r,this.setMenu(this._menuOptions),this},getMenuItems:function(){return this._menu?this._menu.getItems():this._menuOptions?this._menuOptions.items||[]:[]},closeMenu:function(){return this._menu&&this._menu.hide(),this.fire("closemenu",{}),this},removeMenu:function(){return this.off("contextmenu",this._defaultOpenMenu,this),this._unbindMenu(),delete this._menuOptions,this.fire("removemenu",{}),this},_bindMenu:function(){return this._menuOptions?(this._menu=new q2(this._menuOptions),this._menu.addTo(this),this):this},_unbindMenu:function(){return this._menu&&(this.closeMenu(),this._menu.remove(),delete this._menu),this},_defaultOpenMenu:function(r){return this.openMenu(r.coordinate),!1}};xe.include(J2),en.include(J2);var Gi=function(r){Et(t,r);function t(e){return e&&e.position&&!Se(e.position)&&(e.position=Gt({},e.position)),r.call(this,e)||this}return t.prototype._appendCustomClass=function(e){if(!e)return console.warn("dom is null:",e),this;if(this.options.cssName){var n=this.options.cssName;Array.isArray(n)||(n=[n]),n.forEach(function(i){e.classList.add(i)})}return this},t.prototype.onAdd=function(){},t.prototype.onRemove=function(){},t.prototype.addTo=function(e){if(this.remove(),!e.options.control)return this;this._map=e;var n=e.getPanels().control;return this.__ctrlContainer=de("div"),Tc(this.__ctrlContainer,"position:absolute;overflow:visible;"),this.update(),n.appendChild(this.__ctrlContainer),this.onAdd&&this.onAdd(),this.fire("add",{dom:n}),this},t.prototype.update=function(){return this.__ctrlContainer.innerHTML="",this._controlDom=this.buildOn(this.getMap()),this._controlDom&&(this._updatePosition(),this.__ctrlContainer.appendChild(this._controlDom)),this},t.prototype.getMap=function(){return this._map},t.prototype.getPosition=function(){return Gt({},this._parse(this.options.position))},t.prototype.setPosition=function(e){return Se(e)?this.options.position=e:this.options.position=Gt({},e),this._updatePosition(),this},t.prototype.getContainerPoint=function(){var e=this.getPosition(),n=this.getMap().getSize(),i,o;return U(e.left)?U(e.right)||(i=n.width-parseInt(e.right+"")):i=parseInt(e.left+""),U(e.top)?U(e.bottom)||(o=n.height-parseInt(e.bottom+"")):o=parseInt(e.top+""),new W(i,o)},t.prototype.getContainer=function(){return this.__ctrlContainer},t.prototype.getDOM=function(){return this._controlDom},t.prototype.show=function(){return this.__ctrlContainer.style.display="",this},t.prototype.hide=function(){return this.__ctrlContainer.style.display="none",this},t.prototype.isVisible=function(){return this.__ctrlContainer&&this.__ctrlContainer.style.display===""},t.prototype.remove=function(){return this._map?(va(this.__ctrlContainer),this.onRemove&&this.onRemove(),delete this._map,delete this.__ctrlContainer,delete this._controlDom,this.fire("remove"),this):this},t.prototype._parse=function(e){var n=e;return Se(e)&&(n=t.positions[n]),n},t.prototype._updatePosition=function(){var e=this.getPosition();e||(e={top:20,left:20});for(var n in e)if(e.hasOwnProperty(n)){var i=e[n]||0;It(i)&&(i+="px"),this.__ctrlContainer.style[n]=i}this.fire("positionchange",{position:Gt({},e)})},t}(to(hi));Gi.positions={"top-left":{top:20,left:20},"top-right":{top:20,right:20},"bottom-left":{bottom:20,left:20},"bottom-right":{bottom:20,right:20}},xe.mergeOptions({control:!0}),xe.include({addControl:function(r){return this._containerDOM.getContext?this:(r.addTo(this),this)},removeControl:function(r){return!r||r.getMap()!==this?this:(r.remove(),this)}});var CI={position:{bottom:0,left:0},content:'<a href="http://maptalks.org" target="_blank">maptalks</a>'},K2="addlayer removelayer setbaselayer baselayerremove",Q2=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.buildOn=function(){return this._attributionContainer=de("div"),this._attributionContainer.className="maptalks-attribution",this._appendCustomClass(this._attributionContainer),this._update(),this._attributionContainer},t.prototype.onAdd=function(){this.getMap().on(K2,this._update,this)},t.prototype.onRemove=function(){this.getMap().off(K2,this._update,this)},t.prototype._update=function(){var e=this.getMap();if(e){var n=e._getLayers(function(o){return!!o.options.attribution}).reverse().map(function(o){return o.options.attribution}),i=this.options.content+(n.length>0?" - "+n.join(", "):"");this._attributionContainer.innerHTML='<span style="padding:0px 4px">'+i+"</span>"}},t}(Gi);Q2.mergeOptions(CI),xe.mergeOptions({attribution:!0}),xe.addOnLoadHook(function(){var r=this.options.attribution||this.options.attributionControl;r&&(this.attributionControl=new Q2(r),this.addControl(this.attributionControl))});var PI={position:{top:120,left:20}},tb=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.buildOn=function(e){var n=this._getCompass();return this._appendCustomClass(n),this._compass=n,this._registerDomEvents(),e.on("resize moving moveend zooming zoomend rotate rotateend dragrotating dragrotateend viewchange",this._rotateCompass,this),n},t.prototype.onAdd=function(){this._rotateCompass()},t.prototype._getCompass=function(){var e=de("div","maptalks-compass");return e},t.prototype._registerDomEvents=function(){Ln(this._compass,"click",this._resetView,this)},t.prototype._rotateCompass=function(){var e=this.getMap().getBearing().toFixed(1),n=parseFloat(e);n<=180&&(n*=-1),n!==this._bearing&&(this._bearing=n,Tc(this._compass,"transform: rotate(".concat(this._bearing,"deg);")))},t.prototype.onRemove=function(){this.getMap().off("resize moving moveend zooming zoomend rotate rotateend dragrotating dragrotateend viewchange",this._rotateCompass,this),delete this._compass,delete this._bearing},t.prototype._resetView=function(){var e={bearing:0};this.getMap().animateTo(e)},t}(Gi);tb.mergeOptions(PI),xe.mergeOptions({compassControl:!1}),xe.addOnLoadHook(function(){this.options.compassControl&&(this.compassControl=new tb(this.options.compassControl),this.addControl(this.compassControl))});var EI={position:"top-right",baseTitle:"Base Layers",overlayTitle:"Layers",excludeLayers:[],containerClass:"maptalks-layer-switcher"},eb=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.buildOn=function(){var e=this.container=de("div",this.options.containerClass),n=this.panel=de("div","panel"),i=this.button=de("button");return e.appendChild(i),e.appendChild(n),this._appendCustomClass(e),e},t.prototype.onAdd=function(){Ln(this.button,"mouseover",this._show,this),Ln(this.panel,"mouseleave",this._hide,this)},t.prototype.onRemove=function(){this.panel&&(Un(this.button,"mouseover",this._show),Un(this.panel,"mouseleave",this._hide),va(this.panel),va(this.button),delete this.panel,delete this.button,delete this.container)},t.prototype._show=function(){ix(this.container,"shown")||(xa(this.container,"shown"),this._createPanel())},t.prototype._hide=function(e){this.panel.contains(e.toElement||e.relatedTarget)||Qp(this.container,this.options.containerClass)},t.prototype._createPanel=function(){this.panel.innerHTML="";var e=de("ul");this.panel.appendChild(e),this._renderLayers(this.getMap(),e)},t.prototype._renderLayers=function(e,n){var i=this,o=e.getBaseLayer(),s=e.getLayers(),a=s.length;if(o){var l=o.layers||[o],h=de("li","group"),u=de("ul"),c=de("label");c.innerHTML=this.options.baseTitle,h.appendChild(c);for(var f=0,d=l.length;f<d;f++){var p=l[f];this._isExcluded(p)&&(u.appendChild(this._renderLayer(l[f],!0)),h.appendChild(u),n.appendChild(h))}}if(a){var h=de("li","group"),u=de("ul"),c=de("label"),g=de("input");g.type="checkbox",g.checked=!0,c.innerHTML=this.options.overlayTitle,h.appendChild(g),h.appendChild(c);for(var m=function(b){var A=b.target.checked,T=b.target.parentNode;if(T){var S=T.getElementsByTagName("ul")[0];if(S){var M=function(P){var k=P._layer;k&&k[A?"show":"hide"]()},E=function(P){var k=P._layer,O=P.childNodes[0];O&&(O.checked=A),k&&k[A?"show":"hide"]()};M(T),S.childNodes.forEach(function(P){E(P);var k=P.getElementsByTagName("ul")[0];k&&(M(P),k.childNodes.forEach(function(O){E(O)}))})}}},y=function(b){var A=s[b];if(x._isExcluded(A)){if(A.getLayers){var T=de("li","group"),S=de("ul"),M=de("label"),E=de("input");M.innerHTML=A.getId(),E.type="checkbox",E.checked=A.isVisible(),E.onchange=m,T.appendChild(E),T.appendChild(M),T.appendChild(S),T._layer=A,u.appendChild(T);var P=A.getLayers()||[];P.forEach(function(k){S.appendChild(i._renderLayer(k,!1,E.checked))})}else u.appendChild(x._renderLayer(A));A&&!A.isVisible()&&(g.checked=!1)}},x=this,f=0;f<a;f++)y(f);h.appendChild(u),n.appendChild(h),g.onchange=m}},t.prototype._isExcluded=function(e){var n=e.getId(),i=this.options.excludeLayers;return!(i.length&&i.indexOf(n)>=0)},t.prototype._renderLayer=function(e,n,i){var o=this;i===void 0&&(i=!0);var s=de("li","layer"),a=de("label"),l=de("input"),h=this.getMap(),u=e.options.visible;e.options.visible=!0;var c=e.isVisible();e.options.visible=u,s.className="layer";var f=l;return n?(f.type="radio",f.name="base"):f.type="checkbox",f.checked=u&&c,i||(f.checked=!1),c||f.setAttribute("disabled","disabled"),f.onchange=function(d){if(d.target.type==="radio"){var p=h.getBaseLayer(),g=p.layers;if(g)for(var m=0,y=g.length;m<y;m++){var x=g[m];x[x===e?"show":"hide"]()}else p.isVisible()||p.show();h._fireEvent("setbaselayer")}else e[d.target.checked?"show":"hide"]();o.fire("layerchange",{target:e})},s.appendChild(l),a.innerHTML=e.getId(),s.appendChild(a),s._layer=e,s},t}(Gi);eb.mergeOptions(EI),xe.mergeOptions({layerSwitcherControl:!1}),xe.addOnLoadHook(function(){this.options.layerSwitcherControl&&(this.layerSwitcherControl=new eb(this.options.layerSwitcherControl),this.addControl(this.layerSwitcherControl))});var OI={level:4,position:{right:1,bottom:1},size:[300,200],maximize:!0,symbol:{lineWidth:3,lineColor:"#1bbc9b",polygonFill:"#1bbc9b",polygonOpacity:.4},containerClass:"maptalks-overview",buttonClass:"maptalks-overview-button"},nb=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.buildOn=function(){var e=this.options.size;this.options.maximize||(e=[0,0]);var n=de("div");this._appendCustomClass(n);var i=this.mapContainer=de("div");i.style.width=e[0]+"px",i.style.height=e[1]+"px",i.className=this.options.containerClass;var o=this.button=de("div");return o.className=this.options.buttonClass,n.appendChild(i),n.appendChild(o),n},t.prototype.onAdd=function(){this.options.maximize&&this._createOverview(),this.getMap().on("resize moving zooming rotate dragrotating viewchange",this._update,this).on("setbaselayer",this._updateBaseLayer,this).on("spatialreferencechange",this._updateSpatialReference,this),Ln(this.button,"click",this._onButtonClick,this),this._updateButtonText()},t.prototype.onRemove=function(){this.getMap().off("resize moving zooming rotate dragrotating viewchange",this._update,this).off("setbaselayer",this._updateBaseLayer,this).off("spatialreferencechange",this._updateSpatialReference,this),this._overview&&(this._overview.remove(),delete this._overview,delete this._perspective),Un(this.button,"click",this._onButtonClick)},t.prototype.maxmize=function(){var e=this.options.size,n=this.mapContainer;return n.style.width=e[0]+"px",n.style.height=e[1]+"px",this._createOverview(),this},t.prototype.minimize=function(){this._overview&&this._overview.remove(),delete this._overview,delete this._perspective;var e=this.mapContainer;return e.style.width="0px",e.style.height="0px",this},t.prototype.getOverviewMap=function(){return this._overview},t.prototype._onButtonClick=function(){this._overview?this.minimize():this.maxmize(),this._updateButtonText()},t.prototype._updateButtonText=function(){this._overview?this.button.innerHTML="-":this.button.innerHTML="+"},t.prototype._createOverview=function(){var e=this.getMap(),n=this.mapContainer,i=e.config();Gt(i,{center:e.getCenter(),zoom:this._getOverviewZoom(),zoomAnimationDuration:150,pitch:0,bearing:0,scrollWheelZoom:!1,checkSize:!1,doubleClickZoom:!1,touchZoom:!1,control:!1,draggable:!1,maxExtent:null}),this._overview=new xe(n,i),this._updateBaseLayer(),this._perspective=new _n(this._getPerspectiveCoords(),{draggable:!0,cursor:"move",symbol:this.options.symbol}).on("dragend",this._onDragEnd,this),new ro("perspective_layer",this._perspective).addTo(this._overview),this.fire("load")},t.prototype._getOverviewZoom=function(){var e=this.getMap(),n=e.getZoom(),i=e.getMinZoom(),o=this.options.level;if(o>0){for(var s=o;s>0;s--)if(n-s>=i)return n-s}else for(var s=o;s<0;s++)if(n-s>=i)return n-s;return n},t.prototype._onDragEnd=function(){var e=this._perspective.getCenter();this._overview.setCenter(e),this.getMap().panTo(e)},t.prototype._getPerspectiveCoords=function(){var e=this.getMap(),n=e.getProjection();return e.getContainerExtent().toArray().map(function(i){if(n){var o=e._containerPointToPrj(i);return e._fixPrjOnWorldWide(o),n.unproject(o)}return e.containerPointToCoordinate(i)})},t.prototype._update=function(){if(this._overview){Ac(this._overview.getContainer());var e=this._getPerspectiveCoords();this._perspective.setCoordinates(e),this._overview.setCenterAndZoom(this.getMap().getCenter(),this._getOverviewZoom())}},t.prototype._updateSpatialReference=function(){if(this._overview){var e=this.getMap(),n=e.options.spatialReference;this._overview.setSpatialReference(n)}},t.prototype._updateBaseLayer=function(){if(this._overview){var e=this.getMap(),n=e.getBaseLayer();if(!n){this._overview.setBaseLayer(null);return}var i=n.layers,o=0;if(i)for(var s=0,a=i.length;s<a;s++){var l=i[s];if(l.isVisible()){o=s;break}}var h=n.toJSON(),u=null;i?(u=h.layers[o].options,u.visible=!0):u=h.options,this._overview.setMinZoom(u.minZoom||null).setMaxZoom(u.maxZoom||null),delete u.minZoom,delete u.maxZoom,delete h.options.canvas,h.options.visible=!0,h.options.renderer="canvas";var c=Rr.fromJSON(h);for(var f in n)ze(n[f])&&n.hasOwnProperty(f)&&n[f]!==n.constructor.prototype[f]&&(c[f]=n[f]);this._overview.setBaseLayer(c)}},t}(Gi);nb.mergeOptions(OI),xe.mergeOptions({overviewControl:!1}),xe.addOnLoadHook(function(){this.options.overviewControl&&(this.overviewControl=new nb(this.options.overviewControl),this.addControl(this.overviewControl))});var kI={position:"top-right",draggable:!0,custom:!1,content:"",closeButton:!0},II=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.buildOn=function(){var e=this,n;if(this.options.custom)Se(this.options.content)?(n=de("div"),n.innerHTML=this.options.content,this._appendCustomClass(n)):n=this.options.content;else{if(n=de("div","maptalks-panel"),this._appendCustomClass(n),this.options.closeButton){var i=de("a","maptalks-close");i.innerText="×",i.href="javascript:;",i.onclick=function(){n.style.display="none",e.fire("close")},n.appendChild(i)}var o=de("div","maptalks-panel-content");Se(this.options.content)?o.innerHTML=this.options.content:o.appendChild(this.options.content),n.appendChild(o)}return this.draggable=new Eh(n,{cancelOn:this._cancelOn.bind(this),ignoreMouseleave:!0}),this.draggable.on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this),this.options.draggable&&this.draggable.enable(),n},t.prototype.update=function(){return this.draggable&&(this.draggable.disable(),delete this.draggable),Gi.prototype.update.call(this)},t.prototype.setContent=function(e){var n=this.options.content;return this.options.content=e,this.fire("contentchange",{old:n,new:e}),this.isVisible()&&this.update(),this},t.prototype.getContent=function(){return this.options.content},t.prototype._cancelOn=function(e){var n=e.srcElement||e.target,i=n.tagName.toLowerCase();return i==="button"||i==="input"||i==="select"||i==="option"||i==="textarea"},t.prototype._onDragStart=function(e){this._startPos=e.mousePos,this._startPosition=Gt({},this.getPosition()),this.fire("dragstart",e)},t.prototype._onDragging=function(e){var n=e.mousePos,i=n.sub(this._startPos),o=this._startPosition,s=this.getPosition();U(s.top)||(s.top=parseInt(o.top)+i.y),U(s.bottom)||(s.bottom=parseInt(o.bottom)-i.y),U(s.left)||(s.left=parseInt(o.left)+i.x),U(s.right)||(s.right=parseInt(o.right)-i.x),this.setPosition(s),this.fire("dragging",e)},t.prototype._onDragEnd=function(e){delete this._startPos,delete this._startPosition,this.fire("dragend",e)},t.prototype._getConnectPoints=function(){var e=this.getMap(),n=this.getContainerPoint(),i=this.getDOM(),o=parseInt(i.clientWidth+""),s=parseInt(i.clientHeight+""),a=[e.containerPointToCoordinate(n.add(o/2,0)),e.containerPointToCoordinate(n.add(o,s/2)),e.containerPointToCoordinate(n.add(o/2,s)),e.containerPointToCoordinate(n.add(0,s/2))];return a},t}(Gi);II.mergeOptions(kI);var RI={position:{top:156,left:20},view:null},rb=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.buildOn=function(){var e=this._getReset();return this._appendCustomClass(e),this._reset=e,this._registerDomEvents(),e},t.prototype.onAdd=function(){this._view=this.options.view?this.options.view:this.getMap().getView()},t.prototype.setView=function(e){this._view=e},t.prototype._getReset=function(){var e=de("div","maptalks-reset");return e},t.prototype._registerDomEvents=function(){Ln(this._reset,"click",this._resetView,this)},t.prototype.onRemove=function(){delete this._reset,delete this._view},t.prototype._resetView=function(){this.getMap().setView(this._view)},t}(Gi);rb.mergeOptions(RI),xe.mergeOptions({resetControl:!1}),xe.addOnLoadHook(function(){this.options.resetControl&&(this.resetControl=new rb(this.options.resetControl),this.addControl(this.resetControl))});var DI={position:"bottom-left",maxWidth:100,metric:!0,imperial:!1,containerClass:null},ib="zoomend moving moveend",ob=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.buildOn=function(e){return this._map=e,this._scaleContainer=de("div",this.options.containerClass),this._addScales(),e.on(ib,this._update,this),this._map.isLoaded()&&this._update(),this._appendCustomClass(this._scaleContainer),this._scaleContainer},t.prototype.onRemove=function(){this.getMap().off(ib,this._update,this)},t.prototype._addScales=function(){var e="border: 2px solid #000000;border-top: none;line-height: 1.1;padding: 0px;color: #000000;font-size: 11px;text-align:center;white-space: nowrap;overflow: hidden;-moz-box-sizing: content-box;box-sizing: content-box;background: #fff; background: rgba(255, 255, 255, 0);";this.options.metric&&(this._mScale=nx("div",this.options.containerClass?null:e,this._scaleContainer)),this.options.imperial&&(this._iScale=nx("div",this.options.containerClass?null:e,this._scaleContainer))},t.prototype._update=function(){var e=this._map,n=e.pixelToDistance(this.options.maxWidth,0);this._updateScales(n)},t.prototype._updateScales=function(e){this.options.metric&&e&&this._updateMetric(e),this.options.imperial&&e&&this._updateImperial(e)},t.prototype._updateMetric=function(e){var n=this._getRoundNum(e),i=n<1e3?n+" m":n/1e3+" km";this._updateScale(this._mScale,i,n/e)},t.prototype._updateImperial=function(e){var n=e*3.2808399,i,o,s;n>5280?(i=n/5280,o=this._getRoundNum(i),this._updateScale(this._iScale,o+" mile",o/i)):(s=this._getRoundNum(n),this._updateScale(this._iScale,s+" feet",s/n))},t.prototype._updateScale=function(e,n,i){e.style.width=Math.round(this.options.maxWidth*i)+"px",e.innerHTML=n},t.prototype._getRoundNum=function(e){var n=Math.pow(10,(Math.floor(e)+"").length-1),i=e/n;return i=i>=10?10:i>=5?5:i>=3?3:i>=2?2:1,n*i},t}(Gi);ob.mergeOptions(DI),xe.mergeOptions({scaleControl:!1}),xe.addOnLoadHook(function(){this.options.scaleControl&&(this.scaleControl=new ob(this.options.scaleControl),this.addControl(this.scaleControl))});var FI={height:28,vertical:!1,position:"top-right",reverseMenu:!1,items:[]},LI=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.buildOn=function(e){this._map=e;var n=de("div"),i=de("ul","maptalks-toolbar-hx");n.appendChild(i),this.options.vertical?xa(n,"maptalks-toolbar-vertical"):xa(n,"maptalks-toolbar-horizonal");var o=this;function s(p,g,m,y){var x=o._getItems()[g];return function(v){return jr(v),p({target:x,index:g,childIndex:m,dom:y})}}var a=this.options.items;if(on(a))for(var l=0,h=a.length;l<h;l++){var u=a[l],c=de("li");if(this.options.height!==28&&(c.style.lineHeight=this.options.height+"px"),c.style.height=this.options.height+"px",c.style.cursor="pointer",T5(u.item)){c.style.textAlign="center";var f=M5("div",u.item);c.innerHTML='<div style="margin-top:'+(this.options.height-f.height)/2+'px;">'+u.item+"</div>"}else c.innerHTML=u.item;if(u.click&&Ln(c,"click",s(u.click,l,null,c)),on(u.children)){var d=this._createDropMenu(l);c.appendChild(d),c._menu=d,Ln(c,"mouseover",function(){this._menu.style.display=""}),Ln(c,"mouseout",function(){this._menu.style.display="none"})}i.appendChild(c)}return this._appendCustomClass(n),n},t.prototype._createDropMenu=function(e){var n=this;function i(y,x,v){var _=n._getItems()[x].children[v];return function(w){return jr(w),y({target:_,index:x,childIndex:v})}}var o=de("div","maptalks-dropMenu"),s=this._getItems(),a=s.length,l=de("ul"),h=s[e].children;e===a-1&&h&&(o.style.cssText="right: 0px;",l.style.cssText="right: 0px;position: absolute;",this.options.reverseMenu&&(l.style.bottom="0")),o.appendChild(de("em","maptalks-ico"));for(var u=0,c=0,f=h.length;c<f;c++){var d=Xp(h[c].item,"12px");d.width>u&&(u=d.width)}for(var c=0,f=h.length;c<f;c++){var p=h[c],g=de("li");g.innerHTML='<a href="javascript:;">'+p.item+"</a>",g.style.cursor="pointer",g.style.width=u+24+"px",Ln(g.childNodes[0],"click",i(p.click,e,c)),l.appendChild(g)}if(this.options.vertical){var m=u<95?95:u;this.options.reverseMenu?o.style.right=-(m+10*2+2)+"px":o.style.left=-(m+10*2+2)+"px"}else this.options.reverseMenu?o.style.bottom="28px":o.style.top="29px";return o.appendChild(l),o.style.display="none",o},t.prototype._getItems=function(){return this.options.items||[]},t}(Gi);LI.mergeOptions(FI);var zI={position:"top-left",zoomLevel:!0,seamless:!1},sb=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.buildOn=function(e){var n=this.options,i=de("div","maptalks-zoom");if(this._appendCustomClass(i),n.zoomLevel){var o=de("span","maptalks-zoom-zoomlevel"),s=de("span","maptalks-zoom-zoomlevel-text");o.appendChild(s),i.appendChild(o),this._levelDOM=s}var a=de("div","maptalks-zoom-slider"),l=de("a","maptalks-zoom-zoomin");l.href="javascript:;",a.appendChild(l),this._zoomInButton=l;var h=de("a","maptalks-zoom-zoomout");return h.href="javascript:;",a.appendChild(h),this._zoomOutButton=h,i.appendChild(a),e.on("_zoomend _zooming _zoomstart _spatialreferencechange",this._update,this),this._update(),this._registerDomEvents(),i},t.prototype.onRemove=function(){this.getMap().off("_zoomend _zooming _zoomstart _spatialreferencechange",this._update,this)},t.prototype._update=function(){this._updateText()},t.prototype._updateText=function(){if(this._levelDOM){var e=this.getMap(),n=e.getZoom();Cs(n)||(n=Math.floor(n*10)/10),this._levelDOM.innerHTML=n+""}},t.prototype._registerDomEvents=function(){this._zoomInButton&&Ln(this._zoomInButton,"click",this._onZoomInClick,this),this._zoomOutButton&&Ln(this._zoomOutButton,"click",this._onZoomOutClick,this)},t.prototype._onZoomInClick=function(e){Qi(e),this.getMap().zoomIn()},t.prototype._onZoomOutClick=function(e){Qi(e),this.getMap().zoomOut()},t}(Gi);sb.mergeOptions(zI),xe.mergeOptions({zoomControl:!1}),xe.addOnLoadHook(function(){this.options.zoomControl&&(this.zoomControl=new sb(this.options.zoomControl),this.addControl(this.zoomControl))});var es=function(){function r(t,e,n,i){Array.isArray(t)?(this.scale={x:t[0],y:t[1]},this.origin={x:t[2],y:t[3]}):(this.scale={x:t,y:e},this.origin={x:n,y:i})}return r.getDefault=function(t){var e=t.code.toLowerCase();return e==="baidu"?"baidu":e==="EPSG:4326".toLowerCase()||e==="EPSG:4490".toLowerCase()?"tms-global-geodetic":e==="identity"?[1,-1,0,0]:"web-mercator"},r}(),sf=6378137*Math.PI;Gt(es,{"web-mercator":new es([1,-1,-sf,sf]),"tms-global-mercator":new es([1,1,-sf,-sf]),"tms-global-geodetic":new es([1,1,-180,-90]),baidu:new es([1,1,0,0])});var ab=function(){function r(t,e,n,i){this.map=t,this.tileSize=i,this.fullExtent=n,this.prepareTileInfo(e,n),this._xScale=n.right>=n.left?1:-1,this._yScale=n.top>=n.bottom?1:-1;var o=t.getGLRes();this._pointOrigin=t._prjToPointAtRes(new W(this.tileSystem.origin),o),this._glRes=o}return r.prototype.prepareTileInfo=function(t,e){if(Se(t)?t=es[t.toLowerCase()]:Array.isArray(t)&&(t=new es(t)),!t)throw new Error("Invalid TileSystem");this.tileSystem=t;var n=e.right>e.left?1:-1,i=e.top>e.bottom?-1:1,o=t.origin.x,s=t.origin.y;this.transformation=new y_([n,i,o,s])},r.prototype._getTileNum=function(t,e){var n=this.tileSystem,i=this.tileSize,o=1e-7,s=Math.floor(o*n.scale.x+t.x/(i.width*e)),a=Math.ceil(o*n.scale.y+t.y/(i.height*e));return{x:n.scale.x*s,y:n.scale.y*a}},r.prototype.getTileIndex=function(t,e,n){var i=this.tileSystem,o=this.transformation.transform(t,1),s=this._getTileNum(o,e);return i.scale.x<0&&(s.x-=1),i.scale.y>0&&(s.y-=1),this.getNeighorTileIndex(s.x,s.y,0,0,e,n)},r.prototype.getNeighorTileIndex=function(t,e,n,i,o,s){var a=this.tileSystem,l=t+a.scale.x*n,h=e-a.scale.y*i,u=!1,c=l,f=h,d=this._getTileFullIndex(o);return s&&((s===!0||s==="x")&&(d.xmax===d.xmin?l=d.xmin:l<d.xmin?(l=d.xmax-(d.xmin-l)%(d.xmax-d.xmin),l===d.xmax&&(l=d.xmin)):l>=d.xmax&&(l=d.xmin+(l-d.xmin)%(d.xmax-d.xmin))),(s===!0||s==="y")&&(d.ymax===d.ymin?h=d.ymin:h>=d.ymax?h=d.ymin+(h-d.ymin)%(d.ymax-d.ymin):h<d.ymin&&(h=d.ymax-(d.ymin-h)%(d.ymax-d.ymin),h===d.ymax&&(h=d.ymin)))),(l<d.xmin||l>d.xmax||h>d.ymax||h<d.ymin)&&(u=!0),{x:l,y:h,idx:c,idy:f,out:u}},r.prototype._getTileFullIndex=function(t){if(this._tileFullIndex||(this._tileFullIndex={}),this._tileFullIndex[t])return this._tileFullIndex[t];var e=this.fullExtent,n=this.transformation,i=this._getTileNum(n.transform(new at(e.left,e.top),1),t),o=this._getTileNum(n.transform(new at(e.right,e.bottom),1),t),s=this.tileSystem;return s.scale.x<0&&(i.x-=1,o.x-=1),s.scale.y>0&&(i.y-=1,o.y-=1),this._tileFullIndex[t]=new gn(i,o,null),this._tileFullIndex[t]},r.prototype.getTilePrjNW=function(t,e,n,i){var o=this.tileSystem,s=this.tileSize,a=o.origin.y+this._yScale*o.scale.y*(e+(o.scale.y===1?1:0))*n*s.height,l=o.origin.x+this._xScale*o.scale.x*(t+(o.scale.x===1?0:1))*n*s.width;return i?(i.set(l,a),i):new at(l,a)},r.prototype.getTilePointNW=function(t,e,n,i){var o=this._glRes/n,s=this.tileSystem,a=this.tileSize,l=this._pointOrigin.y*o+this._yScale*s.scale.y*(e+(s.scale.y===1?1:0))*a.height,h=this._pointOrigin.x*o+this._xScale*s.scale.x*(t+(s.scale.x===1?0:1))*a.width;return i?(i.set(h,l),i):new W(h,l)},r.prototype.getTilePrjSE=function(t,e,n,i){var o=this.tileSystem,s=this.tileSize,a=o.origin.y+this._yScale*o.scale.y*(e+(o.scale.y===1?0:1))*n*s.height,l=o.origin.x+this._xScale*o.scale.x*(t+(o.scale.x===1?1:0))*n*s.width;return i?(i.set(l,a),i):new at(l,a)},r.prototype.getTilePointSE=function(t,e,n,i){var o=this._glRes/n,s=this.tileSystem,a=this.tileSize,l=this._pointOrigin.y*o+this._yScale*s.scale.y*(e+(s.scale.y===1?0:1))*a.height,h=this._pointOrigin.x*o+this._xScale*s.scale.x*(t+(s.scale.x===1?1:0))*a.width;return i?(i.set(h,l),i):new W(h,l)},r.prototype.getTilePrjExtent=function(t,e,n){var i=this.getTilePrjNW(t,e,n),o=this.getTilePrjSE(t,e,n);return new gn(i,o)},r}();/*!
* Contains code from THREE.js
* MIT License
* https://github.com/mrdoob/three.js
*/for(var ns=[],bm=0;bm<6;bm++)ns[bm]=[];var af=[];function wm(r,t,e){HI(r);for(var n=0;n<6;n++){var i=ns[n];if(af[0]=i[0]>0?t[1][0]:t[0][0],af[1]=i[1]>0?t[1][1]:t[0][1],af[2]=i[2]>0?t[1][2]:t[0][2],NI(i,af)<0)return!1}return!0}function HI(r){var t=r,e=t[0],n=t[1],i=t[2],o=t[3],s=t[4],a=t[5],l=t[6],h=t[7],u=t[8],c=t[9],f=t[10],d=t[11],p=t[12],g=t[13],m=t[14],y=t[15];ja(ns[0],o-e,h-s,d-u,y-p),ja(ns[1],o+e,h+s,d+u,y+p),ja(ns[2],o+n,h+a,d+c,y+g),ja(ns[3],o-n,h-a,d-c,y-g),ja(ns[4],o-i,h-l,d-f,y-m),ja(ns[5],o+i,h+l,d+f,y+m)}var lf=1/6;function ja(r,t,e,n,i){return r[0]=t*lf,r[1]=e*lf,r[2]=n*lf,r[3]=i*lf,r}function NI(r,t){return r[0]*t[0]+r[1]*t[1]+r[2]*t[2]+r[3]}var BI=1,Bh=new W(0,0),jI=32,hf=typeof Set<"u",lb=function(){function r(){this._table=hf?new Set:{}}return r.prototype.add=function(t){hf?this._table.add(t):this._table[t]=!0},r.prototype.has=function(t){return hf?this._table.has(t):this._table[t]},r.prototype.reset=function(){hf?this._table.clear():this._table={}},r}(),VI={urlTemplate:null,subdomains:null,errorUrl:null,repeatWorld:!0,background:!0,loadingLimitOnInteracting:3,loadingLimit:0,tileRetryCount:0,placeholder:!1,crossOrigin:null,tileSize:[256,256],offset:[0,0],tileSystem:null,fadeAnimation:!Kn,fadeDuration:1e3/60*10,debug:!1,spatialReference:null,maxCacheSize:256,renderer:function(){return be.webgl?"gl":"canvas"}(),clipByPitch:!0,maxAvailableZoom:null,cascadeTiles:!0,zoomOffset:0,pyramidMode:1,decodeImageInWorker:!1,tileLimitPerFrame:0,tileStackStartDepth:7,tileStackDepth:6,awareOfTerrain:!0,bufferPixel:.5,mipmapTexture:!0,depthMask:!0,currentTilesFirst:!0,forceRenderOnMoving:!0},GI=/\{ *([\w_]+) *\}/g,hb=new W(0,0),jh=new W(0,0),Vh=new W(0,0),rs=new W(0,0),UI=new W(0,0),$I=new W(0,0),wr=[[0,0,0],[0,0,0]],Am=[0,0,0],Tm=[0,0,0],Mm=[0,0,0],En=function(r){Et(t,r);function t(e,n){return r.call(this,e,n)||this}return t.fromJSON=function(e){return!e||e.type!=="TileLayer"?null:new t(e.id,e.options)},t.prototype.forceReload=function(){return this.fire("forcereloadstart"),this.clear(),this.load(),this.fire("forcereloadend"),this},t.prototype.getTileSize=function(e){if(this._tileSize)return this._tileSize;var n=this.options.tileSize;return It(n)&&(n=[n,n]),this._tileSize=new kn(n),this._tileSize},t.prototype.getTiles=function(e,n){var i=this;this._coordCache={};var o;if(this._isPyramidMode()?o=this._getPyramidTiles(e,n):o=this._getCascadeTiles(e,n),!this._maskGeoJSON)return o;var s=o.tileGrids||[],a=0;return s.forEach(function(l){var h=l.tiles||[];l.tiles=h.filter(function(c){return i._tileInMask(c)}),a+=l.tiles.length;var u=l.tiles.map(function(c){return c.parent});l.parents=l.parents.filter(function(c){return u.indexOf(c.id)>-1})}),o.count=a,o},t.prototype._isPyramidMode=function(){var e=this.getSpatialReference();return!this._disablePyramid&&!this._hasOwnSR&&this.options.pyramidMode&&e&&e.isPyramid()},t.prototype._getTileFullExtent=function(){if(this._tileFullExtent)return this._tileFullExtent;var e=this.getSpatialReference(),n=e.getFullExtent(),i=e.getResolution(0),o=this.getMap();return this._tileFullExtent=n.convertTo(function(s){return o._prjToPointAtRes(s,i,Bh)}),this._tileFullExtent},t.prototype._getRootNodes=function(e){var n=this.getMap();if(this._rootNodes){var i=this._rootNodes,o=i.tiles,s=i.mapWidth,a=i.mapHeight;if(n.width!==s||n.height!==a){for(var l=this._getRootError(),h=0;h<o.length;h++)o[h].error=l;this._rootNodes.mapWidth=n.width,this._rootNodes.mapHeight=n.height}for(var h=0;h<o.length;h++)o[h].offset[0]=e[0],o[h].offset[1]=e[1];return this._rootNodes}var u=this.getSpatialReference(),c=u.getResolution(0),f=this._getTileConfig(),d=u.getFullExtent(),p=f.tileSystem,g=p.origin,m=p.scale,y=f.getTilePrjExtent(0,0,c),x=y.getWidth(),v=y.getHeight(),_=1e-5,w=Math.abs((g.x-d.left)/x);w=Math.ceil(w-_);var b=Math.abs((d.right-g.x)/x);b=Math.ceil(b-_);var A=Math.ceil(Math.abs(d.top-g.y)/v);A=Math.ceil(A-_);var T=Math.ceil(Math.abs(d.bottom-g.y)/v);if(T=Math.ceil(T-_),(b+w)*(T+A)>jI)return{status:0,error:"Too many root nodes"};for(var S=this._getRootError(),M=[],E=0,h=-w;h<b;h++)for(var P=-A;P<T;P++){var k=m.y<0?P:-(P+1);M.push(this.createTileNode(h,k,E,h,k,c,S))}return this._rootNodes={status:1,tiles:M,mapWidth:n.width,mapHeight:n.height},this._getRootNodes(e)},t.prototype.createTileNode=function(e,n,i,o,s,a,l,h,u,c){var f=this.getMap(),d=this.options.zoomOffset;if(!u){var p=this._getTileConfig();u=p.getTilePrjExtent(e,n,a).convertTo(function(y){return f._prjToPointAtRes(y,a,Bh)})}var g=this._getTileOffset(i),m=this.getTileUrl(e,n,i+d);return{parent:h,layer:this.getId(),x:e,y:n,z:i,idx:o,idy:s,res:a,extent2d:u,id:c||this._getTileId(e,n,i),url:hx(m),offset:g,error:l,children:[]}},t.prototype._getRootError=function(){var e=this.getMap(),n=Gn(e.getFov()),i=e.width/e.height,o=e.cameraPosition[2],s=o*Math.tan(.5*n),a=s*i,l=Math.sqrt(o*o+s*s+a*a),h=e._getFovZ(0),u=h*(l/o),c=this.getSpatialReference(),f=c.getResolution(0);return u*f/e.getResolution(0)},t.prototype._getPyramidTiles=function(e,n){var i=this.getMap();isNaN(+e)&&(e=this._getTileZoom(i.getZoom()));var o=this.getSpatialReference(),s=Math.min(e,this.getMaxZoom(),this.getMaxAvailableZoom()||1/0),a=i.projViewMatrix,l=this._getTileFullExtent(),h=this._getTileOffset(0),u;if(this.options.repeatWorld){var c=i.getContainerExtent(),f=this._convertToExtent2d(c),d=o.getResolution(0)/i.getResolution();if(f.within(l.copy()._scale(d))){var _=this._getRootNodes(h);if(_.status!==1)return console.warn(_.error),this._disablePyramid=!0,this.getTiles(e,n);u=Ee([],te(_.tiles),!1)}else{var p=i.getPitch(),g=i.options.cascadePitches[1],m=Math.floor(i._getVisualHeight(g)),y=p<=g?c:new Ce(0,i.height-m,i.width,i.height);this._visitedTiles=new lb;var x=this._getTiles(0-this.options.zoomOffset,y,2,n&&n.getRenderer(),!0),v=this._getRootError()*Math.pow(2,this.options.zoomOffset);x.tiles.forEach(function(E){E.error=v}),u=x.tiles}}else{var _=this._getRootNodes(h);if(_.status!==1)return console.warn(_.error),this._disablePyramid=!0,this.getTiles(e,n);u=Ee([],te(_.tiles),!1)}for(var w=i.getGLRes(),b={0:h},A=new Ce,T=[],S=[];u.length>0;){var M=u.pop();if(M.z===s){A._combine(M.extent2d),T.push(M);continue}b[M.z+1]||(b[M.z+1]=this._getTileOffset(M.z+1)),this._splitNode(M,a,u,T,A,s,b[M.z+1],n&&n.getRenderer(),w),this.isParentTile(e,s,M)&&S.push(M)}return S.sort(ZI),{tileGrids:[{extent:A,count:T.length,tiles:T,parents:S,offset:[0,0],zoom:e}],count:T.length}},t.prototype.isParentTile=function(e,n,i){var o=Math.max(this.getMinZoom(),e-this.options.tileStackStartDepth),s=Math.min(n,o+this.options.tileStackDepth);return i.z>=o&&i.z<s},t.prototype._splitNode=function(e,n,i,o,s,a,l,h,u){for(var c=e.z+1,f=this.getSpatialReference(),d=e.idx,p=e.idy,g=h||this.getRenderer(),m=!1,y=[],x=f.getResolution(c),v=x/u,_=0;_<4;_++){var w=_%2,b=_>>1,A=(d<<1)+w,T=(p<<1)+b;e.children||(e.children=[]);var S=e.children[_];S||(S=this._getTileId(A,T,c),e.children[_]=S);var M=g.isTileCachedOrLoading(S),E=M&&M.info;E||(this.tileInfoCache||(this.tileInfoCache=new Ag(this.options.maxCacheSize*4)),E=this.tileInfoCache.get(S),E||(E=this._createChildNode(e,w,b,l,S))),E.error=e.error/2,E.offset[0]=l[0],E.offset[1]=l[1];var P=this._isTileVisible(E,n,v,a,l);if(P===1)m=!0;else{if(P===-1)continue;if(P===0&&c!==a){o.push(e),s._combine(e.extent2d);return}}y.push(E)}c===a?m?i.push.apply(i,Ee([],te(y),!1)):(o.push(e),s._combine(e.extent2d)):i.push.apply(i,Ee([],te(y),!1))},t.prototype._createChildNode=function(e,n,i,o,s){var a=e.x,l=e.y,h=e.idx,u=e.idy,c=e.extent2d,f=e.z+1,d=(a<<1)+n,p=(l<<1)+i,g=(h<<1)+n,m=(u<<1)+i,y=2,x=c.getWidth()/2*y,v=c.getHeight()/2*y,_=c.xmin*y,w=c.ymax*y,b=c.ymin*y,A=this._getTileConfig().tileSystem,T=A.scale.y;s=s||this._getTileId(g,m,f);var S;if(T<0){var M=_+n*x,E=w-i*v;S=new Ce(M,E-v,M+x,E)}else{var P=_+n*x,k=b+i*v;S=new Ce(P,k,P+x,k+v)}var O=this.createTileNode(d,p,f,g,m,e.res/2,e.error/2,e.id,S,s);return this.tileInfoCache.add(s,O),O},t.prototype._isTileVisible=function(e,n,i,o,s){if(e.z===0)return 1;if(!this._isTileInFrustum(e,n,i,s))return-1;var a=this.options.maxError;U(a)&&(a=BI);var l=this._getScreenSpaceError(e,i,o,s);return l>=a?1:0},t.prototype._isTileInFrustum=function(e,n,i,o){if(!this._zScale){var s=this.getMap(),a=s.getGLRes();this._zScale=s.altitudeToPoint(100,a)/100}var l=this.getRenderer(),h=e.extent2d,u=h.xmin,c=h.ymin,f=h.xmax,d=h.ymax;if(e.offset&&!ze(this.options.offset)){var p=te(e.offset,2),g=p[0],m=p[1];u+=g,f+=g,c+=m,d+=m}wr[0][0]=(u-o[0])*i,wr[0][1]=(c-o[1])*i;var y=e.minAltitude||l&&l.avgMinAltitude||0;wr[0][2]=y*this._zScale,wr[1][0]=(f-o[0])*i,wr[1][1]=(d-o[1])*i;var x=e.maxAltitude||l&&l.avgMaxAltitude||0;return wr[1][2]=x*this._zScale,wm(n,wr)},t.prototype._getScreenSpaceError=function(e,n,i,o){var s=e.error,a=this.getMap(),l=e.extent2d,h=l.xmin,u=l.ymin,c=l.xmax,f=l.ymax;Am[0]=(h-o[0])*n,Am[1]=(u-o[1])*n,Tm[0]=(c-o[0])*n,Tm[1]=(f-o[1])*n;var d=WI(Am,Tm,a.cameraPosition),p=Math.max(Math.abs(d),1e-7),g=Math.abs(e.z-i),m;a.height<1e3?m=1:m=g<=1?1:g<=2?.7:.605;var y=s*m/p,x=this.getMap().getPitch();return x<=60?y*1.45:y},t.prototype._getCascadeTiles=function(e,n){var i=this.getMap(),o=i.getPitch(),s=n&&n.getRenderer(),a=i.getContainerExtent(),l=[],h=0,u=this.getMinZoom(),c=i.options.cascadePitches[0],f=i.options.cascadePitches[1],d=Math.floor(i._getVisualHeight(f)),p=U(e)?this._getTileZoom(i.getZoom()):e;if(this._visitedTiles=new lb,!U(e)||!this.options.cascadeTiles||o<=c||!U(u)&&p<=u){var g=o<=f?a:new Ce(0,i.height-d,i.width,i.height),m=this._getTiles(p,g,2,s);return m&&(h+=m.tiles.length,l.push(m)),{tileGrids:l,count:h}}var y=Math.floor(i._getVisualHeight(c)),x=new Ce(0,i.height-y,i.width,i.height),v=this._getTiles(p,x,0,s);h+=v?v.tiles.length:0,l.push(v);var _=x.ymin,w=i.getSpatialReference().getZoomDirection(),b=w,A;if(o>f){p-b<=u&&(b=0);var T=new Ce(0,i.height-d,i.width,_);A=this._getTiles(p-b,T,1,s),h+=A?A.tiles.length:0,_=T.ymin,b+=4*w,l.push(A)}var S;if(p-b>=u){var M=new Ce(0,a.ymin,i.width,_);S=this._getTiles(p-b,M,2,s),h+=S?S.tiles.length:0,l.push(S)}return A&&S&&(l[1]=S,l[2]=A),{tileGrids:l,count:h}},t.prototype.getTileUrl=function(e,n,i){var o=this.options.urlTemplate,s="";if(this.options.subdomains){var a=this.options.subdomains;if(on(a)){var l=a.length,h=(e+n)%l;h<0&&(h=0),s=a[h]}}if(ze(o))return o(e,n,i,s);var u={x:e,y:n,z:i,s};return this.options.token&&(u.token=this.options.token),this.options.customTags&&Gt(u,this.options.customTags),o.replace(GI,function(c,f){var d=u[f];if(d===void 0)throw new Error("No value provided for variable "+c);return typeof d=="function"&&(d=d(u)),d})},t.prototype.clear=function(){return this._renderer&&this._renderer.clear(),this.tileInfoCache&&this.tileInfoCache.reset(),this.fire("clear"),this},t.prototype.toJSON=function(){var e={type:this.getJSONType(),id:this.getId(),options:this.config()};return e},t.prototype.getSpatialReference=function(){var e=this.getMap();if(e&&(!this.options.spatialReference||eo.equals(this.options.spatialReference,e.options.spatialReference)))return e.getSpatialReference();if(this._sr)return this._sr;var n=this.options.spatialReference;if(Se(n)&&(n=eo.getPreset(n),!n))throw new Error("Unsupported spatial reference: ".concat(this.options.spatialReference,", possible values: ").concat(eo.getAllPresets().join()));return this._sr=new eo(n),this._srMinZoom=this._sr.getMinZoom(),this._srMaxZoom=this._sr.getMaxZoom(),this._hasOwnSR=this._sr.toJSON().projection!==e.getSpatialReference().toJSON().projection,this._sr},t.prototype.getMinZoom=function(){var e=this.options.minZoom||0,n=this.getSpatialReference();return n!==this.getMap().getSpatialReference()?Math.max(e,this._srMinZoom):e},t.prototype.getMaxZoom=function(){var e=this.getSpatialReference();return e!==this.getMap().getSpatialReference()?Math.min(r.prototype.getMaxZoom.call(this),this._srMaxZoom):r.prototype.getMaxZoom.call(this)},t.prototype._getTileZoom=function(e){if(!this._hasOwnSR){var n=this.getMap().getResolution(e),i=this.getSpatialReference().getResolution(e),o=Math.log(i/n)*Math.LOG2E;e+=o}var s=this.getMaxAvailableZoom();return!U(s)&&e>s&&(e=s),Cs(e)||(e=Math.round(e)),e=Math.max(0,e),e},t.prototype.getMaxAvailableZoom=function(){var e=this.getSpatialReference();return this.options.maxAvailableZoom||e&&e.getMaxZoom()},t.prototype._getTiles=function(e,n,i,o,s){var a=this.getMap(),l=e,h=a.projViewMatrix,u=a.getResolution(e)/a.getResolution(e-1)===.5;i<2&&(i===0&&u&&(l-=1),h=i===0?a.cascadeFrustumMatrix0:i===1?a.cascadeFrustumMatrix1:a.projViewMatrix);var c=l+this.options.zoomOffset,f=this._getTileOffset(l),d=f[0]||f[1],p={zoom:l,extent:null,offset:f,tiles:[]};if(c<0||!a||!this.isVisible()||!a.width||!a.height)return p;if(!s){var g=this.getMinZoom(),m=this.getMaxZoom();if(!U(g)&&l<g||!U(m)&&l>m)return p}var y=this._getTileConfig();if(!y)return p;var x={zoom:f},v=this.getSpatialReference(),_=v.getResolution(l),w;this._hasOwnSR?w=a.getGLScale(l):w=_/a.getGLRes();var b=!this._hasOwnSR&&this.options.repeatWorld,A=this._convertToExtent2d(n),T=this._getMask2DExtent();if(T){var S=T.intersection(A);if(!S)return p;n=S.convertTo(function(rn){return a._pointToContainerPoint(rn,void 0,0,Bh)})}var M=a._containerPointToPrj(n.getCenter(),hb),E=a._prjToPoint(M,l,jh),P;d?P=this._project(a._pointToPrj(E._add(f),l,jh),jh):P=this._project(M,jh);var k=a.getGLScale()/a.getGLScale(l);Vh.x=A.xmin*k,Vh.y=A.ymax*k,rs.x=A.xmax*k,rs.y=A.ymin*k;for(var O=this._project(a._pointToPrj(Vh._add(f),l,Vh),Vh),I=this._project(a._pointToPrj(rs._add(f),l,rs),rs),D=y.getTileIndex(P,_,b),z=y.getTileIndex(O,_,b),L=y.getTileIndex(I,_,b),$=Math.ceil(Math.abs(D.idy-z.idy)),Z=Math.ceil(Math.abs(D.idx-z.idx)),j=Math.ceil(Math.abs(D.idy-L.idy)),st=Math.ceil(Math.abs(D.idx-L.idx)),lt=($+j+1)*(Z+st+1),rt=this.getTileSize(),Rt=this.getRenderer()||o,Ht=this._getTileConfig().tileSystem.scale,ee=[],nt=new Ce,Dt=new W(0,0),Vt=-$;Vt<=j;Vt++)for(var Ct=-Z,_e=-1/0,Ie=!1;Ct>=_e&&Ct<=st;){var Jt=y.getNeighorTileIndex(D.idx,D.idy,Ct,Vt,_,b);_e===-1/0?Ct++:Ct--;var Ne=this._getTileId(Jt.idx,Jt.idy,l);if(!(Jt.out||this._visitedTiles&&this._visitedTiles.has(Ne))){var ce=Rt&&Rt.isTileCachedOrLoading(Ne);ce&&(ce=ce.info);var ke=void 0;if(ce){var qe=ce.extent2d;Dt.set(qe.xmin,qe.ymax),ke=Dt}else if(!this._hasOwnSR)ke=y.getTilePointNW(Jt.x,Jt.y,_);else{var Re=y.getTilePrjNW(Jt.x,Jt.y,_);ke=a._prjToPoint(this._unproject(Re,rs),l)}var Je=void 0,Le=void 0;if(!this._hasOwnSR)Je=rt.width,Le=rt.height;else{var pn=void 0;if(!this._hasOwnSR)pn=y.getTilePointSE(Jt.x,Jt.y,_);else{var Tn=y.getTilePrjSE(Jt.x,Jt.y,_);pn=a._prjToPoint(this._unproject(Tn,rs),l,rs)}Je=Math.ceil(Math.abs(pn.x-ke.x)),Le=Math.ceil(Math.abs(pn.y-ke.y))}var nr=Ht.x*(Jt.idx-Jt.x)*Je,ln=Ht.y*(Jt.idy-Jt.y)*Le;!ce&&(nr||ln)&&ke._add(nr,ln);var qn=ce&&ce.extent2d||new Ce(ke.x,ke.y-Le,ke.x+Je,ke.y);if(lt<=4||Ie||this._isTileInExtent(h,qn,f,w)){var hn=this._hasOwnSR?a._getResolution(l):_;this._visitedTiles&&i===0&&this._visitedTiles.add(Ne),u&&i===0?(this._splitTiles(h,ee,Rt,Jt,l+1,hn,qn,nr,ln,x),nt._combine(qn)):(ce?(ce.offset[0]=f[0],ce.offset[1]=f[1]):ce=this.createTileNode(Jt.x,Jt.y,l,Jt.idx,Jt.idy,hn,0,null,qn,Ne),ee.push(ce),nt._combine(qn)),_e===-1/0?(_e=Ct,Ct=st):Ie||(Ie=!0)}}}if(ee.length){var we=a._containerPointToPoint(n.getCenter(),l,Bh)._add(f),Ze=new W(0,0),yn=new W(0,0);ee.sort(function(rn,vr){return Ze.set((rn.extent2d.xmin+rn.extent2d.xmax)/2,(rn.extent2d.ymin+rn.extent2d.ymax)/2),yn.set((vr.extent2d.xmin+vr.extent2d.xmax)/2,(vr.extent2d.ymin+vr.extent2d.ymax)/2),Ze.distanceTo(we)-yn.distanceTo(we)})}return{offset:f,zoom:e,extent:nt,tiles:ee}},t.prototype._convertToExtent2d=function(e){var n=this,i=this.getMap();return e.convertTo(function(o){var s;if(o.y>0&&o.y<i.height){var a=(o.x===0?0:1)+o.y;n._coordCache[a]||(n._coordCache[a]=i._containerPointToPoint(o)),s=n._coordCache[a]}return s=i._containerPointToPoint(o,void 0,Bh),s})},t.prototype._splitTiles=function(e,n,i,o,s,a,l,h,u,c){var f=this._getTileConfig().tileSystem.scale.y,d=this.getMap().getGLScale(s),p=UI.set(l.xmin*2,f<0?l.ymax*2:l.ymin*2),g=l.getWidth(),m=l.getHeight(),y=o.idx*2,x=o.idy*2,v=o.x*2,_=o.y*2,w=this._checkAndAddTile(e,i,y,x,v,_,s,a,0,0,g,m,p,d,c);w&&n.push(w),w=this._checkAndAddTile(e,i,y,x,v,_,s,a,0,1,g,m,p,d,c),w&&n.push(w),w=this._checkAndAddTile(e,i,y,x,v,_,s,a,1,0,g,m,p,d,c),w&&n.push(w),w=this._checkAndAddTile(e,i,y,x,v,_,s,a,1,1,g,m,p,d,c),w&&n.push(w)},t.prototype._checkAndAddTile=function(e,n,i,o,s,a,l,h,u,c,f,d,p,g,m){var y=this._getTileId(i+u,o+c,l);if(this._visitedTiles&&this._visitedTiles.has(y))return null;var x=m[l];x||(x=m[l]=this._getTileOffset(l));var v=this._getTileConfig().tileSystem.scale.y,_=new Ce(p.x+u*f,p.y+v*c*d,p.x+(u+1)*f,p.y+v*(c+1)*d);if(!this._isSplittedTileInExtent(e,_,x,g))return null;var w=h/2,b=n&&n.isTileCachedOrLoading(y),A;return b?A=b.info:A=this.createTileNode(s+u,a+c,l,i+u,i+a,w,0,null,_,y),A},t.prototype._getTileOffset=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var i=this.options.offset;return ze(i)&&(i=i.call.apply(i,Ee([this],te(e),!1))),It(i)&&(i=[i,i]),i||[0,0]},t.prototype.getTileId=function(e,n,i,o){return this._getTileId(e,n,i,o)},t.prototype._getTileId=function(e,n,i,o){return"".concat(o||this.getId(),"_").concat(e,"_").concat(n,"_").concat(i)},t.prototype._project=function(e,n){if(this._hasOwnSR){var i=this.getMap(),o=i.getProjection(),s=this.getSpatialReference().getProjection();return s.project(o.unproject(e,n),n)}else return e},t.prototype._unproject=function(e,n){if(this._hasOwnSR){var i=this.getMap(),o=this.getSpatialReference(),s=i.getProjection(),a=o.getProjection();return s.project(a.unproject(e,n),n)}else return e},t.prototype._initTileConfig=function(){var e=this.getMap(),n=this.getTileSize(),i=this.getSpatialReference(),o=i.getProjection(),s=i.getFullExtent();this._defaultTileConfig=new ab(e,es.getDefault(o),s,n),this.options.hasOwnProperty("tileSystem")&&(this._tileConfig=new ab(e,this.options.tileSystem,s,n)),delete this._rootNodes,delete this._tileFullExtent,delete this._disablePyramid},t.prototype._getTileConfig=function(){return this._defaultTileConfig||this._initTileConfig(),this._tileConfig||this._defaultTileConfig},t.prototype._bindMap=function(e){return this._onSpatialReferenceChange(),r.prototype._bindMap.apply(this,arguments)},t.prototype._isTileInExtent=function(e,n,i,o){var s=this.getMap(),a;if(e!==s.projViewMatrix){var l=n.getCenter($I)._sub(i[0],i[1])._multi(o);Qr(Mm,l.x,l.y,0);var h=Yk(Mm,Mm,s.projViewMatrix);a=h[1]<0?s.projViewMatrix:e}else a=s.projViewMatrix;return wr[0][0]=(n.xmin-i[0])*o,wr[0][1]=(n.ymin-i[1])*o,wr[1][0]=(n.xmax-i[0])*o,wr[1][1]=(n.ymax-i[1])*o,wm(a,wr)},t.prototype._isSplittedTileInExtent=function(e,n,i,o){var s=this.getMap();return wr[0][0]=(n.xmin-i[0])*o,wr[0][1]=(n.ymin-i[1])*o,wr[1][0]=(n.xmax-i[0])*o,wr[1][1]=(n.ymax-i[1])*o,wm(s.projViewMatrix,wr)},t.prototype.getEvents=function(){return{spatialreferencechange:this._onSpatialReferenceChange}},t.prototype._onSpatialReferenceChange=function(){delete this._tileConfig,delete this._defaultTileConfig,delete this._sr,delete this._srMinZoom,delete this._hasOwnSR,delete this._rootNodes,this.tileInfoCache&&this.tileInfoCache.reset();var e=this.getRenderer();e&&e.clear()},t.prototype.getPolygonOffsetCount=function(){return 2},t.prototype.getPolygonOffset=function(){return this._polygonOffset||0},t.prototype.setPolygonOffset=function(e){return this._polygonOffset=e,this},t.prototype.getRenderer=function(){return r.prototype.getRenderer.call(this)},t.prototype._getTileBBox=function(e){var n=this.getMap();if(n){var i=e.extent2d;if(i){var o=e.res,s=i.xmin,a=i.ymin,l=i.xmax,h=i.ymax,u=new W(s,a),c=new W(l,h),f=n.pointAtResToCoordinate(u,o,hb),d=n.pointAtResToCoordinate(c,o,jh);return[f.x,f.y,d.x,d.y]}}},t.prototype._tileInMask=function(e){var n=this.getMask();if(!n)return!0;var i=n.type;if(!i||i.indexOf("Polygon")===-1)return!0;var o=this._maskGeoJSON;if(!o||!o.geometry)return!0;var s=o.geometry,a=s.coordinates,l=s.type;if(!a||!l||l.indexOf("Polygon")===-1)return!0;if(!o.bbox){var h=n.getExtent();if(!h)return!0;o.bbox=[h.xmin,h.ymin,h.xmax,h.ymax]}var u=this._getTileBBox(e);return u?sE(u,this._maskGeoJSON):!0},t}(Rr);En.registerJSONType("TileLayer"),En.mergeOptions(VI);function WI(r,t,e){var n=Math.max(r[0]-e[0],0,e[0]-t[0]),i=Math.max(r[1]-e[1],0,e[1]-t[1]),o=Math.max(r[2]-e[2],0,e[2]-t[2]);return Math.sqrt(n*n+i*i+o*o)}function ZI(r,t){return r.z-t.z}var XI={urlTemplate:"",maxCacheSize:1024},YI=new kn(256,256),Va="show hide remove setzindex forcereloadstart";function ub(r){return Array.isArray(r)||(r=[r]),r}var cb=function(r){Et(t,r);function t(e,n,i){var o=r.call(this,e,i)||this;return o.layers=n||[],o._checkChildren(),o.layerMap={},o._groupChildren=[],o}return t.fromJSON=function(e){if(!e||e.type!=="GroupTileLayer")return null;var n=e.layers.map(function(i){return Rr.fromJSON(i)});return new t(e.id,n,e.options)},t.prototype.getLayers=function(){return this.layers},t.prototype.addLayer=function(e){var n=this;e===void 0&&(e=[]),e=ub(e);var i=this.layers.length;return e.forEach(function(o){o instanceof En&&n.layers.indexOf(o)===-1&&!n.layerMap[o.getId()]&&n.layers.push(o)}),i!==this.layers.length&&(this._sortLayers(),this._refresh(),this._renderLayers()),this},t.prototype.removeLayer=function(e){var n=this;e===void 0&&(e=[]),e=ub(e);var i=this.layers.length;return e.forEach(function(o){if(o instanceof En||(o=n.layerMap[o]),o instanceof En){var s=n.layers.indexOf(o);s>=0&&(n.layers.splice(s,1),o._doRemove(),o.off(Va,n._onLayerShowHide,n))}}),i!==this.layers.length&&(this._refresh(),this._renderLayers()),this},t.prototype.clearLayers=function(){var e=this;return this.layers.forEach(function(n){n._doRemove(),n.off(Va,e._onLayerShowHide,e)}),this.layers=[],this._refresh(),this._renderLayers(),this},t.prototype.toJSON=function(){var e={type:this.getJSONType(),id:this.getId(),layers:this.layers.map(function(n){return n.toJSON()}),options:this.config()};return e},t.prototype.getTileSize=function(e){var n=this.getLayer(e);return n?n.getTileSize():YI},t.prototype.getTiles=function(e,n){for(var i=this.layers,o=[],s=0,a=0,l=i.length;a<l;a++){var h=i[a];if(!(!h||!h.options.visible||!h.isVisible()||!h.getMap())){var u=h.getTiles(e,n||this);!u||u.count===0||(s+=u.count,ai(o,u.tileGrids))}}return{count:s,tileGrids:o}},t.prototype.onAdd=function(){this._sortLayers(),this._refresh(),r.prototype.onAdd.call(this)},t.prototype.onRemove=function(){var e=this;this.layers.forEach(function(n){n._doRemove(),n.off(Va,e._onLayerShowHide,e)}),this.layerMap={},this._groupChildren=[],r.prototype.onRemove.call(this)},t.prototype.getLayer=function(e){return this.getChildLayer(e)},t.prototype.getChildLayer=function(e){var n=this.layerMap[e];if(n)return n;for(var i=0;i<this._groupChildren.length;i++){var o=this._groupChildren[i].getChildLayer(e);if(o)return o}return null},t.prototype._removeChildTileCache=function(e){if(!e)return this;var n=this.getRenderer();if(!n)return this;var i,o=e.getId(),s=function(){return i&&i.info&&i.info.layer===o};if(n.tileCache){var a=n.tileCache.keys();a.forEach(function(c){i=n.tileCache.get(c),s()&&n.tileCache.remove(c)})}var l=n.tilesInView||{};for(var h in l)i=l[h],s()&&delete l[h];var u=n.tilesLoading||{};for(var h in u)i=u[h],s()&&n.abortTileLoading(i.image,i.info);return this},t.prototype._onLayerShowHide=function(e){var n=e||{},i=n.type,o=n.target;i==="remove"&&o?(this.layers.splice(this.layers.indexOf(o),1),o._doRemove(),o.off(Va,this._onLayerShowHide,this),this._refresh()):i==="setzindex"?this._sortLayers():i==="forcereloadstart"&&this._removeChildTileCache(o),this._renderLayers()},t.prototype._renderLayers=function(){var e=this.getRenderer();return e&&e.setToRedraw(),this},t.prototype._refresh=function(){var e=this,n=this.getMap();return this._groupChildren=[],this.layerMap={},this.layers.forEach(function(i){e.layerMap[i.getId()]=i,i.getChildLayer&&e._groupChildren.push(i),i.getMap()||i._bindMap(n),i.off(Va,e._onLayerShowHide,e),i.on(Va,e._onLayerShowHide,e)}),this},t.prototype.isVisible=function(){if(!r.prototype.isVisible.call(this))return!1;for(var e=this.layers,n=0,i=e.length;n<i;n++)if(e[n].isVisible())return!0;return!1},t.prototype._checkChildren=function(){var e=this,n={};this.layers.forEach(function(i){var o=i.getId();if(n[o])throw new Error("Duplicate child layer id (".concat(o,") in the GroupTileLayer (").concat(e.getId(),")"));n[o]=1})},t.prototype._sortLayers=function(){this.layers.sort(function(e,n){return e.options.zIndex-n.options.zIndex})},t}(En);cb.registerJSONType("GroupTileLayer"),cb.mergeOptions(XI);var fb={urlTemplate:"",crs:null,uppercase:!1,detectRetina:!1},qI={service:"WMS",request:"GetMap",layers:"",styles:"",format:"image/jpeg",transparent:!1,version:"1.1.1"},Sm,Cm=function(r){Et(t,r);function t(e,n){var i=r.call(this,e)||this;return Sm||(Sm=Gt({},i.options)),i.wmsParams=Gt({},qI),i.setOptions(n),i.setZIndex(n.zIndex),be.proxy||i._optionsHook(n),i}return t.prototype._optionsHook=function(e){e===void 0&&(e={});for(var n in e)n==="tileSize"&&(this._tileSize=null),n in Sm||(this.wmsParams[n]=e[n]);var i=this.getTileSize();return this.wmsParams.width=i.width,this.wmsParams.height=i.height,this._wmsVersion=parseFloat(this.wmsParams.version),this},t.prototype.onAdd=function(){var e=this.getMap().getDevicePixelRatio(),n=fb.detectRetina?e:1;this.wmsParams.width*=n,this.wmsParams.height*=n;var i=this.options.crs||this.getMap().getProjection().code,o=this._wmsVersion>=1.3?"crs":"srs";this.wmsParams[o]=i,r.prototype.onAdd.call(this)},t.prototype.getTileUrl=function(e,n,i){var o=this.getSpatialReference().getResolution(i),s=this._getTileConfig(),a=s.getTilePrjExtent(e,n,o),l=a.getMax(),h=a.getMin(),u=(this._wmsVersion>=1.3&&(this.wmsParams.crs==="EPSG:4326"||this.wmsParams.crs==="EPSG:4490")?[h.y,h.x,l.y,l.x]:[h.x,h.y,l.x,l.y]).join(","),c=r.prototype.getTileUrl.call(this,e,n,i);return c+JI(this.wmsParams,c,this.options.uppercase)+(this.options.uppercase?"&BBOX=":"&bbox=")+u},t.prototype.toJSON=function(){return{type:"WMSTileLayer",id:this.getId(),options:this.config()}},t.fromJSON=function(e){return!e||e.type!=="WMSTileLayer"?null:new t(e.id,e.options)},t}(En);Cm.registerJSONType("WMSTileLayer"),Cm.mergeOptions(fb);function JI(r,t,e){var n=[];for(var i in r)n.push(encodeURIComponent(e?i.toUpperCase():i)+"="+encodeURIComponent(r[i]));return(!t||t.indexOf("?")===-1?"?":"&")+n.join("&")}var Pm=function(r){Et(t,r);function t(e,n){var i=r.call(this,e,n)||this;return i.options.hasOwnProperty("forceRenderOnMoving")||(i.options.forceRenderOnMoving=!1),i}return t.prototype.drawTile=function(){},t.prototype.toJSON=function(){return{type:"CanvasTileLayer",id:this.getId(),options:this.config()}},t.fromJSON=function(e){return!e||e.type!=="CanvasTileLayer"?null:new t(e.id,e.options)},t}(En);Pm.registerJSONType("CanvasTileLayer");function KI(r,t){for(var e={alpha:!0,stencil:!0,preserveDrawingBuffer:!0,antialias:!1},n=["webgl","experimental-webgl"],i=null,o=0;o<n.length;++o){try{i=r.getContext(n[o],t||e)}catch{}if(i)break}return i}function db(r,t,e){var n=r.createShader(t);r.shaderSource(n,e),r.compileShader(n);var i=r.getShaderParameter(n,r.COMPILE_STATUS);if(!i){var o=r.getShaderInfoLog(n);throw r.deleteShader(n),new Error("Failed to compile shader: "+o)}return n}function pb(r,t,e){var n=db(r,r.VERTEX_SHADER,t),i=db(r,r.FRAGMENT_SHADER,e);if(!n||!i)return null;var o=r.createProgram();return o?(r.attachShader(o,n),r.attachShader(o,i),r.linkProgram(o),{program:o,vertexShader:n,fragmentShader:i}):null}function gb(r,t,e){if(Array.isArray(e[0])){for(var n=Float32Array.BYTES_PER_ELEMENT,i=0,o=0;o<e.length;o++)i+=e[o][1]||0;for(var s=0,o=0;o<e.length;o++){var a=r.getAttribLocation(t,e[o][0]);if(a<0)throw new Error("Failed to get the storage location of "+e[o][0]);r.vertexAttribPointer(a,e[o][1],r[e[o][2]||"FLOAT"],!1,n*i,n*s),s+=e[o][1]||0,r.enableVertexAttribArray(a)}}else{var a=r.getAttribLocation(t,e[0]);r.vertexAttribPointer(a,e[1],r[e[2]||"FLOAT"],!1,0,0),r.enableVertexAttribArray(a)}}var QI={never:512,"<":513,"=":514,"<=":515,">":516,"!=":517,">=":518,always:519};function tR(r){return QI[r]}var mb=[1,1,1,1],eR=new Float32Array(8),nR=new Int16Array(8),yb={vertexShader:`
        attribute vec2 a_position;

        attribute vec2 a_texCoord;

        uniform mat4 u_matrix;

        varying vec2 v_texCoord;

        void main() {
            gl_Position = u_matrix * vec4(a_position, 0., 1.);

            v_texCoord = a_texCoord;
        }
    `,fragmentShader:`
        precision mediump float;

        uniform sampler2D u_image;

        uniform float u_opacity;
        uniform float u_debug_line;
        uniform vec4 u_base_color;
        uniform float u_alpha_test;
        varying vec2 v_texCoord;

        void main() {
            if (u_debug_line == 1.) {
                gl_FragColor = vec4(0., 1., 0., 1.);
            } else {
                gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;
            }
            gl_FragColor *= u_base_color;
            if (gl_FragColor.a < u_alpha_test) {
                discard;
            }
        }
    `},is=["",0],Gh=[0,0,0],rR=new Array(16),iR=new W(20,20),Em=function(r){var t=function(e){Et(n,e);function n(){var i=e.apply(this,Ee([],te(arguments),!1))||this;return i._layerAlt=0,i._layerAltitude=0,i}return n.prototype.drawGLImage=function(i,o,s,a,l,h,u,c,f){this.gl.program!==this.program&&this.useProgram(this.program);var d=this.gl;this.loadTexture(i);var p=this.canvas.gl&&this.canvas.gl.wrap;if(p){var g=this.layer&&this.layer.options.opacity;U(g)&&(g=1),u*=g}Gh[0]=o||0,Gh[1]=s||0,Gh[2]=0;var m=this.layer;if(m){var y=m.options.altitude,x=It(y);if(x||(this._layerAlt=0),this._layerAltitude!==y&&x){var v=m.getMap();if(v){var _=v.altitudeToPoint(y,v.getGLRes());this._layerAltitude=y,this._layerAlt=_}}}Gh[2]=this._layerAlt||0;var w=Ic(rR);cg(w,w,Gh),kc(w,w,[h,h,1]),ba(w,this.getMap().projViewMatrix,w),d.uniformMatrix4fv(this.program.u_matrix,!1,w),d.uniform1f(this.program.u_opacity,u),d.uniform1f(this.program.u_debug_line,0),d.uniform4fv(this.program.u_base_color,f||mb),d.uniform1f(this.program.u_alpha_test,this.layer.options.alphaTest||0);var b=i.glBuffer;b&&(b.width!==a||b.height!==l)&&(this.saveImageBuffer(b),delete i.glBuffer),i.glBuffer?d.bindBuffer(d.ARRAY_BUFFER,b):i.glBuffer=this.bufferTileData(0,0,a,l),is[0]="a_position",is[1]=2,is[2]=i.glBuffer.type,this.enableVertexAttrib(is),d.bindBuffer(d.ARRAY_BUFFER,this.texBuffer),is[0]="a_texCoord",is[1]=2,is[2]="UNSIGNED_BYTE",this.enableVertexAttrib(is),d.drawArrays(d.TRIANGLE_STRIP,0,4),c&&this.drawDebug(w,0,0,a,l,c)},n.prototype.drawDebug=function(i,o,s,a,l,h){var u=this.gl;u.disable(u.DEPTH_TEST),u.bindBuffer(u.ARRAY_BUFFER,this._debugBuffer),this.enableVertexAttrib(["a_position",2,"FLOAT"]),u.bufferData(u.ARRAY_BUFFER,new Float32Array([o,s,o+a,s,o+a,s-l,o,s-l,o,s]),u.DYNAMIC_DRAW),u.uniformMatrix4fv(this.program.u_matrix,!1,i),u.uniform1f(this.program.u_opacity,1),u.uniform1f(this.program.u_debug_line,1),u.uniform4fv(this.program.u_base_color,mb),u.uniform1f(this.program.u_alpha_test,this.layer.options.alphaTest||0),u.drawArrays(u.LINE_STRIP,0,5);var c=this._debugInfoCanvas;if(!c){var f=this.getMap().getDevicePixelRatio()>1?2:1;c=this._debugInfoCanvas=document.createElement("canvas"),c.width=256*f,c.height=32*f;var d=c.getContext("2d");d.font="20px monospace",d.scale(f,f)}var p=c.getContext("2d");p.clearRect(0,0,c.width,c.height);var g=this.layer.options.debugOutline;Mt.fillText(p,h,iR,g),this.loadTexture(c),u.texImage2D(u.TEXTURE_2D,0,u.RGBA,u.RGBA,u.UNSIGNED_BYTE,c),a=256;var m=o,y=o+a,x=s-l+32,v=s-l;u.bufferData(u.ARRAY_BUFFER,this.set8(m,x,m,v,y,x,y,v),u.DYNAMIC_DRAW),u.uniform1f(this.program.u_debug_line,0),u.bindBuffer(u.ARRAY_BUFFER,this.texBuffer),this.enableVertexAttrib(["a_texCoord",2,"UNSIGNED_BYTE"]),u.drawArrays(u.TRIANGLE_STRIP,0,4),u.enable(u.DEPTH_TEST)},n.prototype.bufferTileData=function(i,o,s,a,l){var h=i,u=i+s,c=o,f=o-a,d;Cs(h)&&Cs(u)&&Cs(c)&&Cs(f)?d=this.set8Int(h,c,h,f,u,c,u,f):d=this.set8(h,c,h,f,u,c,u,f);var p=this.loadImageBuffer(d,l);return p.width=s,p.height=a,p.type=d instanceof Int16Array?"SHORT":"FLOAT",p},n.prototype.createCanvas2=function(){this.canvas2=Mt.createCanvas(this.canvas.width,this.canvas.height)},n.prototype.createGLContext=function(){this.canvas.gl&&this.canvas.gl.wrap?this.gl=this.canvas.gl.wrap():this.gl=KI(this.canvas2||this.canvas,this.layer.options.glOptions);var i=this.gl;i.clearColor(0,0,0,0),i.enable(i.DEPTH_TEST),i.enable(i.STENCIL_TEST),i.enable(i.BLEND),i.blendFunc(i.ONE,i.ONE_MINUS_SRC_ALPHA),this.program=this.createProgram(yb.vertexShader,this.layer.options.fragmentShader||yb.fragmentShader),this._debugBuffer=this.createBuffer(),this.useProgram(this.program),this.texBuffer=this.createBuffer(),i.bindBuffer(i.ARRAY_BUFFER,this.texBuffer),this.enableVertexAttrib(["a_texCoord",2,"UNSIGNED_BYTE"]),i.bufferData(i.ARRAY_BUFFER,new Uint8Array([0,0,0,1,1,0,1,1]),i.STATIC_DRAW),this.enableSampler("u_image"),i.activeTexture(i.TEXTURE0),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0)},n.prototype.resizeGLCanvas=function(){this.gl&&this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.canvas2&&(this.canvas2.width!==this.canvas.width||this.canvas2.height!==this.canvas.height)&&(this.canvas2.width=this.canvas.width,this.canvas2.height=this.canvas.height)},n.prototype.clearGLCanvas=function(){this.gl&&(this.gl.clearStencil(255),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.STENCIL_BUFFER_BIT)),this.gl.wrap||this.gl.clear(this.gl.DEPTH_BUFFER_BIT)},n.prototype.disposeImage=function(i){i&&(i.texture&&this.saveTexture(i.texture),i.glBuffer&&this.saveImageBuffer(i.glBuffer),delete i.texture,delete i.glBuffer)},n.prototype._createTexture=function(i){var o=this.gl,s=this.getTexture()||o.createTexture();o.bindTexture(o.TEXTURE_2D,s),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.LINEAR),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,o.CLAMP_TO_EDGE);var a=this.layer.options.mipmapTexture;return a&&(!Ga(i.width)||!Ga(i.height))&&(i=oR(i)),o.texImage2D(o.TEXTURE_2D,0,o.RGBA,o.RGBA,o.UNSIGNED_BYTE,i),a&&o.generateMipmap(o.TEXTURE_2D),s},n.prototype.getTexture=function(){this._textures||(this._textures=[]);var i=this._textures;return i&&i.length>0?i.pop():null},n.prototype.saveTexture=function(i){this._textures.push(i)},n.prototype.loadTexture=function(i){var o=this.getMap(),s=this.gl,a=i.texture;a||(a=this._createTexture(i),i.texture=a),s.bindTexture(s.TEXTURE_2D,a);var l=this.layer.options.mipmapTexture;return l&&(o.isMoving()&&o.getRenderer().isViewChanged()?s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR_MIPMAP_LINEAR):s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR)),a},n.prototype.getImageBuffer=function(){this._imageBuffers||(this._imageBuffers=[]);var i=this._imageBuffers;return i&&i.length>0?i.pop():null},n.prototype.saveImageBuffer=function(i){this._imageBuffers||(this._imageBuffers=[]),this._imageBuffers.push(i)},n.prototype.loadImageBuffer=function(i,o){var s=this.gl,a=o||this.createImageBuffer();return s.bindBuffer(s.ARRAY_BUFFER,a),s.bufferData(s.ARRAY_BUFFER,i,s.STATIC_DRAW),a},n.prototype.createImageBuffer=function(){return this.getImageBuffer()||this.createBuffer()},n.prototype.removeGLCanvas=function(){var i=this.gl;if(i){if(this._debugBuffer&&(i.deleteBuffer(this._debugBuffer),delete this._debugBuffer),this._buffers&&(this._buffers.forEach(function(a){i.deleteBuffer(a)}),delete this._buffers),this._textures&&(this._textures.forEach(function(a){return i.deleteTexture(a)}),delete this._textures),this._debugInfoCanvas){var o=this._debugInfoCanvas.texture;o&&i.deleteTexture(o),delete this._debugInfoCanvas.texture,delete this._debugInfoCanvas}var s=i.program;i.deleteShader(s.fragmentShader),i.deleteShader(s.vertexShader),i.deleteProgram(s),delete this.gl,delete this.canvas2}},n.prototype.createBuffer=function(){var i=this.gl,o=i.createBuffer();if(!o)throw new Error("Failed to create the buffer object");return this._buffers||(this._buffers=[]),this._buffers.push(o),o},n.prototype.enableVertexAttrib=function(i){gb(this.gl,this.gl.program,i)},n.prototype.createProgram=function(i,o){for(var s=this.gl,a=pb(s,i,o),l=a.program,h=a.vertexShader,u=a.fragmentShader,c=s.getProgramParameter(l,35718),f=[],d=0;d<c;++d){var p=s.getActiveUniform(l,d);f.push(p.name)}return l.vertexShader=h,l.fragmentShader=u,this._initUniforms(l,f),l},n.prototype.useProgram=function(i){var o=this.gl;return o.useProgram(i),o.program=i,this},n.prototype.enableSampler=function(i,o){var s=this.gl,a=this._getUniform(s.program,i);return o||(o=0),s.uniform1i(a,o),a},n.prototype._initUniforms=function(i,o){for(var s=0;s<o.length;s++){var a=o[s],l=o[s],h=a.indexOf("[");h>=0&&(a=a.substring(0,h),Kn||(l=l.substring(0,h))),i[a]=this._getUniform(i,l)}},n.prototype._getUniform=function(i,o){var s=this.gl,a=s.getUniformLocation(i,o);if(!a)throw new Error("Failed to get the storage location of "+o);return a},n.prototype.set8=function(i,o,s,a,l,h,u,c){var f=eR;return f[0]=i,f[1]=o,f[2]=s,f[3]=a,f[4]=l,f[5]=h,f[6]=u,f[7]=c,f},n.prototype.set8Int=function(i,o,s,a,l,h,u,c){var f=nR;return f[0]=i,f[1]=o,f[2]=s,f[3]=a,f[4]=l,f[5]=h,f[6]=u,f[7]=c,f},n}(r);return t};function oR(r){if(Ga(r.width)&&Ga(r.height))return r;var t=r.width,e=r.height;Ga(t)||(t=vb(t)),Ga(e)||(e=vb(e));var n=document.createElement("canvas");n.width=t,n.height=e;var i=n.getContext("2d");return i.imageSmoothingEnabled=!1,i.drawImage(r,0,0,t,e),n}function Ga(r){return(r&r-1)===0&&r!==0}function vb(r){return Math.pow(2,Math.ceil(Math.log(r)/Math.LN2))}var sR={renderer:be.webgl?"gl":"canvas",crossOrigin:null,alphaTest:!1,depthMask:!0,depthFunc:"<="},aR=new W(0,0),Om=function(r){Et(t,r);function t(e,n,i){var o=this;return n&&!Array.isArray(n)&&!n.url&&(i=n,n=null),o=r.call(this,e,i)||this,o._images=n,o}return t.prototype.onAdd=function(){this._prepareImages(this._images)},t.prototype.setImages=function(e){return this._images=e,this._prepareImages(e),this},t.prototype.getImages=function(){return this._images},t.prototype._prepareImages=function(e){e=e||[],Array.isArray(e)||(e=[e]);var n=this.getMap(),i=n.getGLRes();this._imageData=e.map(function(s){var a=new gn(s.extent);return Gt({},s,{extent:a,extent2d:a.convertTo(function(l){return n.coordToPointAtRes(l,i)})})}),this._images=e;var o=this.getRenderer();o&&o.refreshImages()},t.prototype.getRenderer=function(){return r.prototype.getRenderer.call(this)},t}(Rr);Om.mergeOptions(sR);var lR=[],km=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.isDrawable=function(){return this.getMap().getPitch()?(console&&console.warn("ImageLayer with canvas renderer can't be pitched, use gl renderer ('renderer' : 'gl') instead."),!1):!0},t.prototype.checkResources=function(){var e=this;if(this._imageLoaded)return lR;var n=this.layer,i=n._imageData.map(function(a){return[a.url,null,null]});if(this.resources){var o=[],s=new Ls;i.forEach(function(a){if(e.resources.isResourceLoaded(a)){var l=e.resources.getImage(a);s.addResource(a,l)}else o.push(a)}),this.resources.forEach(function(a,l){s.isResourceLoaded(a)||e.retireImage(l.image)}),this.resources=s,i=o}return this._imageLoaded=!0,i},t.prototype.retireImage=function(e){var n=e;n.close&&n.close()},t.prototype.refreshImages=function(){this._imageLoaded=!1,this.setToRedraw()},t.prototype.draw=function(e,n){this.isDrawable()&&(this.prepareCanvas(),this._painted=!1,this._drawImages(e,n),this.completeRender())},t.prototype._drawImages=function(e,n){var i=this.layer._imageData,o=this.getMap(),s=o.get2DExtentAtRes(o.getGLRes());if(i&&i.length)for(var a=0;a<i.length;a++){var l=i[a].extent2d,h=this.resources&&this.resources.getImage(i[a].url);h&&s.intersects(l)&&(this._painted=!0,this._drawImage(h,l,i[a].opacity||1))}},t.prototype._drawImage=function(e,n,i){var o=0,s=this.context;i<1&&(o=s.globalAlpha,s.globalAlpha=i);var a=this.getMap(),l=aR.set(n.xmin,n.ymax),h=a._pointAtResToContainerPoint(l,a.getGLRes()),u=h.x,c=h.y,f=a.getBearing();f&&(s.save(),s.translate(u,c),f&&s.rotate(-f*Math.PI/180),u=c=0);var d=a.getGLScale();s.drawImage(e,u,c,n.getWidth()/d,n.getHeight()/d),f&&s.restore(),o&&(s.globalAlpha=o)},t.prototype.drawOnInteracting=function(e,n,i){this.draw()},t}(Oa),xb=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.drawOnInteracting=function(e,n,i){this.draw(n,i)},t.prototype._prepareGLContext=function(){var e=this.gl;if(e){e.disable(e.STENCIL_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.enable(e.DEPTH_TEST),e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA),e.depthFunc(tR(this.layer.options.depthFunc));var n=!!this.layer.options.depthMask;e.depthMask(n)}},t.prototype._drawImages=function(e,n){var i=this.gl;if(n&&n.renderTarget){var o=n.renderTarget.fbo;if(o){var s=n.renderTarget.getFramebuffer(o);i.bindFramebuffer(i.FRAMEBUFFER,s)}}if(this._prepareGLContext(),r.prototype._drawImages.call(this),n&&n.renderTarget){var o=n.renderTarget.fbo;o&&i.bindFramebuffer(i.FRAMEBUFFER,null)}},t.prototype.isDrawable=function(){return!0},t.prototype._drawImage=function(e,n,i){this.drawGLImage(e,n.xmin,n.ymax,n.getWidth(),n.getHeight(),1,i)},t.prototype.createContext=function(){this.createGLContext()},t.prototype.resizeCanvas=function(e){this.canvas&&(r.prototype.resizeCanvas.call(this,e),this.resizeGLCanvas())},t.prototype.clearCanvas=function(){this.canvas&&(r.prototype.clearCanvas.call(this),this.clearGLCanvas())},t.prototype.retireImage=function(e){var n=e;n.close&&n.close(),this.disposeImage(e)},t.prototype.onRemove=function(){this.removeGLCanvas(),r.prototype.onRemove.call(this)},t}(Em(km));Om.registerRenderer("canvas",km),Om.registerRenderer("gl",xb);var _b;(function(r){r[r.never=0]="never",r[r["<"]=1]="<",r[r["="]=2]="=",r[r["<="]=3]="<=",r[r[" >"]=4]=" >",r[r["!="]=5]="!=",r[r[">="]=6]=">=",r[r.always=7]="always"})(_b||(_b={}));var Im=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.getPrepareParams=function(){return[]},t.prototype.getDrawParams=function(){return[]},t.prototype.onCanvasCreate=function(){this.canvas&&this.layer.options.doubleBuffer&&(this.buffer=Mt.createCanvas(this.canvas.width,this.canvas.height,this.getMap().CanvasClass))},t.prototype.needToRedraw=function(){if(this.layer.options.animation)return!0;var e=this.getMap();return e.isInteracting()&&!this.layer.drawOnInteracting?!1:r.prototype.needToRedraw.call(this)},t.prototype.draw=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];this.prepareCanvas(),this.prepareDrawContext(),this._drawLayer.apply(this,Ee([],te(e),!1))},t.prototype.drawOnInteracting=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];this._drawLayerOnInteracting.apply(this,Ee([],te(e),!1))},t.prototype.getCanvasImage=function(){var e=r.prototype.getCanvasImage.call(this);if(e&&e.image&&this.layer.options.doubleBuffer){var n=e.image;(this.buffer.width!==n.width||this.buffer.height!==n.height)&&(this.buffer.width=n.width,this.buffer.height=n.height);var i=this.buffer.getContext("2d"),o=this.layer.doubleBuffer(i,this.context);(o===void 0||o)&&(Mt.image(i,n,0,0),e.image=this.buffer)}return e},t.prototype.remove=function(){return delete this._drawContext,r.prototype.remove.call(this)},t.prototype.onZoomStart=function(e){this.layer.onZoomStart(e),r.prototype.onZoomStart.call(this,e)},t.prototype.onZooming=function(e){this.layer.onZooming(e),r.prototype.onZooming.call(this,e)},t.prototype.onZoomEnd=function(e){this.layer.onZoomEnd(e),r.prototype.onZoomEnd.call(this,e)},t.prototype.onMoveStart=function(e){this.layer.onMoveStart(e),r.prototype.onMoveStart.call(this,e)},t.prototype.onMoving=function(e){this.layer.onMoving(e),r.prototype.onMoving.call(this,e)},t.prototype.onMoveEnd=function(e){this.layer.onMoveEnd(e),r.prototype.onMoveEnd.call(this,e)},t.prototype.onResize=function(e){this.layer.onResize(e),r.prototype.onResize.call(this,e)},t.prototype.prepareDrawContext=function(){var e;if(!this._predrawed){var n=bb(this.getPrepareParams());this._drawContext=(e=this.layer).prepareToDraw.apply(e,Ee([this.context],te(n),!1)),this._drawContext||(this._drawContext=[]),Array.isArray(this._drawContext)||(this._drawContext=[this._drawContext]),this._predrawed=!0}},t.prototype._prepareDrawParams=function(){if(!this.getMap())return null;var e=this.getViewExtent();if(e.maskExtent&&!e.extent.intersects(e.maskExtent))return this.completeRender(),null;var n=[this.context,e],i=bb(this.getDrawParams());return Ee(Ee(Ee([],te(n),!1),te(i),!1),te(this._drawContext),!1)},t.prototype._drawLayer=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];var i=this._prepareDrawParams();i&&(this.layer.draw.apply(this.layer,i.concat(e)),this.completeRender())},t.prototype._drawLayerOnInteracting=function(){for(var e,n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];if(this.layer.drawOnInteracting){var o=this._prepareDrawParams();o&&((e=this.layer).drawOnInteracting.apply(e,Ee(Ee([],te(o),!1),te(n),!1)),this.completeRender())}},t}(Oa);function bb(r){return r||(r=[]),Array.isArray(r)||(r=[r]),r}var hR={doubleBuffer:!1,animation:!1},Rm=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.isCanvasRender=function(){return!0},t.prototype.prepareToDraw=function(){},t.prototype.draw=function(){},t.prototype.redraw=function(){return this._getRenderer()&&this._getRenderer().setToRedraw(),this},t.prototype.play=function(){return this.config("animation",!0),this},t.prototype.pause=function(){return this.config("animation",!1),this},t.prototype.isPlaying=function(){return this.options.animation},t.prototype.clearCanvas=function(){return this._getRenderer()&&this._getRenderer().clearCanvas(),this},t.prototype.requestMapToRender=function(){var e=this._getRenderer();return e&&e.requestMapToRender&&e.requestMapToRender(),this},t.prototype.completeRender=function(){return this._getRenderer()&&this._getRenderer().completeRender(),this},t.prototype.onCanvasCreate=function(){return this},t.prototype.onZoomStart=function(){},t.prototype.onZooming=function(){},t.prototype.onZoomEnd=function(){},t.prototype.onMoveStart=function(){},t.prototype.onMoving=function(){},t.prototype.onMoveEnd=function(){},t.prototype.onResize=function(){},t.prototype.doubleBuffer=function(e){return e.clearRect(0,0,e.canvas.width,e.canvas.height),this},t.prototype._getRenderer=function(){return r.prototype._getRenderer.call(this)},t}(Rr);Rm.mergeOptions(hR),Rm.registerRenderer("canvas",Im);var uR=new W(0,0),cR={animation:!0},wb=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.getParticles=function(e){},t.prototype.draw=function(e,n){var i=this.getParticles(Qe());if(!i||i.length===0){var o=this._getRenderer();o&&(this._getRenderer()._shouldClear=!0);return}var s=this.getMap(),a=n.extent;n.maskExtent&&(a=n.extent.intersection(n.maskExtent)),a=a.convertTo(function(p){return s._pointToContainerPoint(p,void 0,0,uR)});for(var l=2*Math.PI,h=0,u=i.length;h<u;h++){var c=i[h].point;if(a.contains(c)){var f=i[h].color||this.options.lineColor||"#fff",d=i[h].r;e.fillStyle!==f&&(e.fillStyle=f),d<=2?e.fillRect(c.x-d/2,c.y-d/2,d,d):(e.beginPath(),e.arc(c.x,c.y,d/2,0,l),e.fill())}}this._fillCanvas(e)},t.prototype._fillCanvas=function(e){var n=e.globalCompositeOperation;e.globalCompositeOperation="destination-out";var i=this.options.trail||30;e.fillStyle="rgba(0, 0, 0, "+1/i+")",e.fillRect(0,0,e.canvas.width,e.canvas.height),e.globalCompositeOperation=n},t}(Rm);wb.mergeOptions(cR),wb.registerRenderer("canvas",function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.draw=function(){(!this.canvas||!this.layer.options.animation||this._shouldClear)&&(this.prepareCanvas(),this._shouldClear=!1),this.prepareDrawContext(),this._drawLayer()},t.prototype.drawOnInteracting=function(){this.draw(),this._shouldClear=!1},t.prototype.onSkipDrawOnInteracting=function(){this._shouldClear=!0},t}(Im));var Uh=new Ls,$h,Wh,fR=function(r){Et(t,r);function t(e,n,i){var o=r.call(this,i)||this;o.target=e,e.once("remove",o.delete,o);var s=o.options.symbol,a=s.markerLineWidth||1;return o.w=s.markerWidth+a,o.h=s.markerHeight+a,o.opacity=U(s.opacity)?1:s.opacity,o.map=n,o.events=i.events,o._fetchImage(),o.addTo(n),o}return t.prototype.getCursor=function(){return this.options.cursor||"default"},t.prototype._fetchImage=function(){var e=this.map,n=this.options.symbol,i=n.markerFile;this.url=i||vh(n);var o=Uh.getImage(this.url);if(!o){var s=this.w,a=this.h;if(i)o=new Image,o.onload=function(){var u=e.getRenderer();u&&u.setToRedraw()},o.src=this.url;else{var l=document.createElement("canvas");l.width=s,l.height=a;var h=l.getContext("2d");o=U_(h,{x:s/2,y:a/2},n,Uh)}Uh.addResource([this.url,s,a],o)}Uh.login(this.url),this._img=o},t.prototype.setContainerPoint=function(e){this._point=e,this._point._sub(this.w/2,this.h/2)},t.prototype.getContainerPoint=function(){return this._point.add(this.w/2,this.h/2)},t.prototype.offset=function(e){this._point._add(e)},t.prototype.render=function(e){if(!this._img)return!1;var n=this.options.symbol,i=n.markerDx||0,o=n.markerDy||0,s=this.map,a=this._point,l=a.x,h=a.y,u=this.w,c=this.h;if(l+u>0&&l<s.width&&h+c>0&&h<s.height){var f=s.getDevicePixelRatio();return e.globalAlpha=this.opacity,e.drawImage(this._img,Math.round((l+i)*f),Math.round((h+o)*f),Math.round(u*f),Math.round(c*f)),!0}return!1},t.prototype.delete=function(){if(this.map){var e=this.map.getRenderer();e&&e.removeTopElement(this)}Uh.logout(this.url),this._dragger&&(this._dragger.disable(),delete this._dragger),delete this.map},t.prototype.hitTest=function(e){var n=this.options.symbol,i=n.markerDx||0,o=n.markerDy||0,s=this.w,a=this.h,l=this._point.x+i,h=this._point.y+o;return e.x>=l&&e.x<=l+s&&e.y>=h&&e.y<=h+a},t.prototype.addTo=function(e){this.map=e;var n=e.getRenderer();n.addTopElement(this)},t.prototype.onEvent=function(e){this.fire(e.type,e)},t.prototype.mousedown=function(e){var n=e.target,i=this.options.cursor;i&&n.setCursor(i),this.onDragstart(e)},t.prototype.onDragstart=function(e){var n=e.containerPoint,i=e.target,o=i.getPanels().mapWrapper||i.getContainer(),s=this._dragger=new Eh(o);s.on("dragging",this.onDragging,this).on("mouseup",this.onDragend,this).enable(),s.onMouseDown(e.domEvent),$h=n.x,Wh=n.y,this.fire("dragstart",{containerPoint:n})},t.prototype.onDragging=function(e){if(this._dragger){var n=this.map,i=li(e.domEvent,n.getContainer()),o={x:i.x-$h,y:i.y-Wh},s=n.containerPointToCoord(new W($h,Wh)),a=n.containerPointToCoord(i);$h=i.x,Wh=i.y,this.offset(o),this.fire("dragging",{containerPoint:i,coordOffset:a._sub(s)})}},t.prototype.onDragend=function(e){if(this._dragger){var n=this.map;n.resetCursor();var i=li(e.domEvent,n.getContainer()),o={x:i.x-$h,y:i.y-Wh};this.offset(o),this._dragger.disable(),delete this._dragger,this.fire("dragend",{containerPoint:i})}},t.prototype.needCollision=function(){var e=this.target;return e&&e.options&&e.options.collision},t.prototype.getRenderBBOX=function(e){var n=this,i=n.target,o=n.map;if(!i||!i.options||!o)return null;var s=this.options.symbol,a=s.markerDx||0,l=s.markerDy||0,h=this._point,u=h.x,c=h.y,f=this.w,d=this.h;e=e||o.getDevicePixelRatio(),this.bbox=this.bbox||qo();var p=Math.round((u+a)*e),g=Math.round((c+l)*e),m=Math.round(f*e),y=Math.round(d*e);this.bbox[0]=p,this.bbox[1]=g,this.bbox[2]=p+m,this.bbox[3]=g+y;var x=i.options,v=x.collisionBufferSize||0;return Hx(this.bbox,v),this.bbox},t.prototype.setZIndex=function(e){this.options.zIndex=e},t}(to(hi)),dR=function(){function r(t,e,n){this.target=t,t.once("remove",this.delete,this),this.map=e,this.options=n,this.addTo(e)}return r.prototype.setPoints=function(t){this.points=t;var e=t.map(function(i){return i.x}),n=t.map(function(i){return i.y});this.xmin=Math.min.apply(Math,Ee([],te(e),!1)),this.xmax=Math.max.apply(Math,Ee([],te(e),!1)),this.ymin=Math.min.apply(Math,Ee([],te(n),!1)),this.ymax=Math.max.apply(Math,Ee([],te(n),!1))},r.prototype.hitTest=function(){return!1},r.prototype.render=function(t){var e=this.map;if(this.xmax<=0||this.xmin>=e.width||this.ymax<=0||this.ymin>=e.height)return;var n=e.getDevicePixelRatio(),i=.5;function o(l){return Math.round(l)*n+i}t.lineWidth=1,t.strokeStyle="#000",t.globalAlpha=1,t.beginPath();var s=this.points;t.moveTo(o(s[0].x),o(s[0].y));for(var a=1;a<this.points.length;a++)t.lineTo(o(s[a].x),o(s[a].y));t.closePath(),t.stroke()},r.prototype.addTo=function(t){this.map=t;var e=t.getRenderer();e.addTopElement(this)},r.prototype.delete=function(){if(this.map){var t=this.map.getRenderer();t&&t.removeTopElement(this)}},r}(),pR=dh+"_edit_stage_";function Dm(r,t){return{markerType:r,markerFill:"#fff",markerLineColor:"#000",markerLineWidth:2,markerWidth:10,markerHeight:10,opacity:t}}var gR={fixAspectRatio:!1,symbol:null,removeVertexOn:"contextmenu",centerHandleSymbol:Dm("ellipse",1),vertexHandleSymbol:Dm("square",1),newVertexHandleSymbol:Dm("square",.4),collision:!1,collisionBufferSize:0,vertexZIndex:0,newVertexZIndex:0},Ab=function(r){Et(t,r);function t(e,n){var i=r.call(this,n)||this;return i._geometry=e,i._geometry,i}return t.prototype.getMap=function(){return this._geometry.getMap()},t.prototype.prepare=function(){var e=this.getMap();e&&(e.on("drawtopstart",this._refresh,this),this.options.symbol&&(this._originalSymbol=this._geometry.getSymbol(),this._geometry.setSymbol(this.options.symbol)),this._prepareEditStageLayer())},t.prototype._prepareEditStageLayer=function(){var e=this._geometry.getLayer();if(e.options.renderer==="canvas"){var n=this.getMap(),i=bo(),o=pR+i+"_shadow";if(this._shadowLayer=n.getLayer(o),!this._shadowLayer){var s=e.constructor;this._shadowLayer=new s(o),n.addLayer(this._shadowLayer)}}},t.prototype.start=function(){if(!(!this._geometry||!this._geometry.getMap()||this._geometry.editing)){this.editing=!0,this.prepare();var e=this._geometry,n,i=this._geometry.getLayer(),o=i.options.renderer==="canvas";this._geometryDraggble=e.options.draggable,o?(e.config("draggable",!1),n=e.copy(),n.setSymbol(e._getInternalSymbol()),n.copyEventListeners(e),e._getParent()&&n.copyEventListeners(e._getParent()),n._setEventTarget(e),n.setId(null).config({draggable:!1}),this._shadow=n,e.hide()):e instanceof bn&&e.config("draggable",!0),this._switchGeometryEvents("on"),(e instanceof bn||e instanceof Ti||e instanceof js||e instanceof no)&&this._createOrRefreshOutline(),this._shadowLayer&&this._shadowLayer.bringToFront().addGeometry(n),e instanceof bn?n&&(n.config("draggable",!0),n.on("dragend",this._onMarkerDragEnd,this)):this._createCenterHandle(),e instanceof bn&&this.options.resize!==!1?this.createMarkerEditor():e instanceof Ti?this.createCircleEditor():e instanceof js?this.createEllipseOrRectEditor():e instanceof no?this.createEllipseOrRectEditor():e instanceof Vs||(e instanceof _n||e instanceof Pn)&&this.createPolygonEditor()}},t.prototype.stop=function(){delete this._history,delete this._historyPointer,delete this._editOutline,this._switchGeometryEvents("off");var e=this.getMap();if(!e){this.fire("remove");return}this._geometry.config("draggable",this._geometryDraggble),this._shadow&&(delete this._shadow,delete this._geometryDraggble,this._geometry.show()),this._shadowLayer&&(this._shadowLayer.remove(),delete this._shadowLayer),this._refreshHooks=[],this.options.symbol&&(this._geometry.setSymbol(this._originalSymbol),delete this._originalSymbol),this.editing=!1,this.fire("remove")},t.prototype.isEditing=function(){return U(this.editing)?!1:this.editing},t.prototype._getGeometryEvents=function(){return{symbolchange:this._onGeoSymbolChange,dragstart:this._onDragStart,dragend:this._onDragEnd,"positionchange shapechange":this._exeAndReset}},t.prototype._switchGeometryEvents=function(e){if(this._geometry){var n=this._getGeometryEvents();for(var i in n)this._geometry[e](i,n[i],this)}},t.prototype._onGeoSymbolChange=function(e){this._shadow&&this._shadow.setSymbol(e.target._getInternalSymbol())},t.prototype._onMarkerDragEnd=function(){this._update("setCoordinates",this._shadow.getCoordinates().toArray())},t.prototype._createOrRefreshOutline=function(){var e=this._geometry,n=this._editOutline;n||(this._editOutline=new dR(this,this.getMap()),this._addRefreshHook(this._createOrRefreshOutline));var i=this._editOutline.points;if(e instanceof bn)this._editOutline.setPoints(e.getContainerExtent().toArray(i));else{var o=this.getMap(),s=e._getPrjExtent();i=s.toArray(i),i.forEach(function(a){return o.prjToContainerPoint(a,null,a)}),this._editOutline.setPoints(i)}return n},t.prototype._createCenterHandle=function(){var e=this,n=this.getMap(),i=this.options.centerHandleSymbol,o,s=n.coordToContainerPoint(this._geometry.getCenter()),a=this.createHandle(s,{symbol:i,cursor:"move",onDown:function(){if(e._shadow){o=e._shadow.copy();var l=Oc(o._getInternalSymbol(),.5);o.setSymbol(l).addTo(e._geometry.getLayer())}},onMove:function(l){var h=l.coordOffset;o?o.translate(h):e._geometry.translate(h)},onUp:function(){if(o){var l=o.getFirstCoordinate(),h=e._geometry.getFirstCoordinate(),u=l.sub(h);e._update("translate",u),o.remove()}}});this._addRefreshHook(function(){var l=e._geometry.getCenter();a.setContainerPoint(n.coordToContainerPoint(l))})},t.prototype._createHandleInstance=function(e,n){var i=this.getMap(),o=tg(n.symbol,function(){return[i.getZoom(),{"{bearing}":i.getBearing(),"{pitch}":i.getPitch(),"{zoom}":i.getZoom()}]}),s=this.options.removeVertexOn,a=new fR(this,i,{symbol:o,cursor:n.cursor,events:s});return a.setContainerPoint(e),a},t.prototype.createHandle=function(e,n){n||(n={});var i=this._createHandleInstance(e,n),o=this;function s(h){return this._updating=!0,n.onDown&&(n.onDown.call(o,h.containerPoint,h),this._geometry.fire("handledragstart")),!1}function a(h){return o._hideContext(),n.onMove&&(n.onMove.call(o,h),this._geometry.fire("handledragging")),!1}function l(h){return n.onUp&&(n.onUp.call(o,h),this._geometry.fire("handledragend")),this._updating=!1,!1}return i.on("dragstart",s,this),i.on("dragging",a,this),i.on("dragend",l,this),n.onRefresh&&(i.refresh=n.onRefresh),i},t.prototype._createResizeHandles=function(e,n,i){var o=this,s=["nw-resize","n-resize","ne-resize","w-resize","e-resize","sw-resize","s-resize","se-resize"],a=[null,"y",null,"x","x",null,"y",null],l=this._geometry,h=l instanceof bn;function u(){if(h){var y=l.getContainerExtent();return[new W(y.xmin,y.ymin),new W((y.xmax+y.xmin)/2,y.ymin),new W(y.xmax,y.ymin),new W(y.xmin,(y.ymin+y.ymax)/2),new W(y.xmax,(y.ymin+y.ymax)/2),new W(y.xmin,y.ymax),new W((y.xmax+y.xmin)/2,y.ymax),new W(y.xmax,y.ymax)]}var x=l._getPrjExtent();return[new W(x.xmin,x.ymax),new W((x.xmax+x.xmin)/2,x.ymax),new W(x.xmax,x.ymax),new W(x.xmin,(x.ymax+x.ymin)/2),new W(x.xmax,(x.ymax+x.ymin)/2),new W(x.xmin,x.ymin),new W((x.xmax+x.xmin)/2,x.ymin),new W(x.xmax,x.ymin)]}e||(e=[]);var c=this,f=[],d={},p=this.getMap(),g=this.options.vertexHandleSymbol,m=function(){for(var y=u(),x=function(_){if(Array.isArray(e)){var w=e.some(function(S){return S===_});if(w)return"continue"}var b=y[_],A=h?b:p.prjToContainerPoint(b);if(f.length<y.length-e.length){var T=o.createHandle(A,{symbol:g,cursor:s[_],axis:a[_],onMove:function(S){return function(M){c._updating=!0,n(M.containerPoint,S),l.fire("resizing")}}(_),onUp:function(){c._updating=!1,i()}});d[_]=f.length,f.push(T)}else f[d[_]].setContainerPoint(A)},v=0;v<y.length;v++)x(v)};return m(),this._addRefreshHook(m),f},t.prototype.createMarkerEditor=function(){var e=this,n=this._shadow||this._geometry,i=this.getMap();if(!n._canEdit()){console&&console.warn("A marker can't be resized with symbol:",n.getSymbol());return}this._history||this._recordHistory(g());var o=n._getInternalSymbol(),s=new W(0,0);It(o.markerDx)&&(s.x=o.markerDx),It(o.markerDy)&&(s.y=o.markerDy);var a=null,l="middle",h="middle";if(q_.test(o)){var u=o.markerType;u==="pin"||u==="pie"||u==="bar"?(a=[5,6,7],l="bottom"):u==="rectangle"&&(a=[0,1,2,3,5],l="top",h="left")}else(am.test(o)||J_.test(o))&&(l="bottom",a=[5,6,7]);var c=[2,1,2,0,0,2,1,2],f;if(this.options.fixAspectRatio){var d=n.getSize();f=d.width/d.height}var p=this._createResizeHandles(a,function(m,y){if(a&&a.indexOf(y)>=0){var x=i.containerPointToCoordinate(m.sub(s)),v=n.getCoordinates();x.x=v.x,n.setCoordinates(x),e._updateCoordFromShadow(!0);var _=p[p.length-1-y],w=_.getContainerPoint();m=w}var b=i.coordToContainerPoint(n.getCoordinates()).add(s),A=n._getInternalSymbol(),T=m.sub(b);l==="bottom"&&m.y>b.y&&(T.y=0);var S=l==="middle"?2:1,M=h==="left"?1:2,E=Math.abs(T.x)*M,P=Math.abs(T.y)*S;f&&(E=Math.max(E,P*f),P=E/f);var k=c[y];n instanceof ef?((f||k===0||k===2)&&(n.setWidth(E),n!==e._geometry&&e._geometry.setWidth(E)),(f||k===1||k===2)&&(n.setHeight(P),n!==e._geometry&&e._geometry.setHeight(P))):((f||k===0||k===2)&&(A.markerWidth=Math.min(E,e._geometry.options.maxMarkerWidth||1/0)),(f||k===1||k===2)&&(A.markerHeight=Math.min(P,e._geometry.options.maxMarkerHeight||1/0)),n.setSymbol(A),n!==e._geometry&&e._geometry.setSymbol(A))},function(){e._update(g())});function g(){var m=[["setCoordinates",n.getCoordinates().toArray()]];return n instanceof ef?(m.push(["setWidth",n.getWidth()]),m.push(["setHeight",n.getHeight()])):m.push(["setSymbol",n.getSymbol()]),m}},t.prototype.createCircleEditor=function(){var e=this,n=this._shadow||this._geometry,i=this.getMap();this._history||this._recordHistory([["setCoordinates",n.getCoordinates().toArray()],["setRadius",n.getRadius()]]),this._createResizeHandles(null,function(o){var s=n.getCenter(),a=i.containerPointToCoord(o),l=new Pn([[s.x,s.y],[a.x,s.y]]),h=new Pn([[s.x,s.y],[s.x,a.y]]),u=Math.max(i.computeGeometryLength(l),i.computeGeometryLength(h));n.setRadius(u),n!==e._geometry&&e._geometry.setRadius(u)},function(){e._update("setRadius",n.getRadius())})},t.prototype.createEllipseOrRectEditor=function(){var e=this,n=[2,1,2,0,0,2,1,2],i=this._shadow||this._geometry;this._history||this._recordHistory(h());var o=this.getMap(),s=this._geometry instanceof js,a;this.options.fixAspectRatio&&(a=i.getWidth()/i.getHeight());var l=this._createResizeHandles(null,function(u,c){var f=s?1:2,d,p,g,m=l[c],y=m.getContainerPoint(),x=n[c];if(s){var v=l[7-c],_=v.getContainerPoint();d=y.sub(_);var w=d.abs();p=o.pixelToDistance(w.x,0),g=o.pixelToDistance(0,w.y);var b=i.getSize(),A=i.getCoordinates(),T=i.getWidth(),S=i.getHeight(),M=o.containerPointToCoord(u),E=o.containerPointToCoord(_),P=new Pn([[E.x,E.y],[M.x,E.y]]),k=new Pn([[E.x,E.y],[E.x,M.y]]);if(p=o.computeGeometryLength(P),g=o.computeGeometryLength(k),x===0)if(a&&(w.y=w.x/a,b.height=Math.abs(w.y),g=p/a),y.y=_.y-b.height/2,M.y=A.y,c===4)M.x=Math.min(M.x,A.x);else{var O=o.locate(A,T,0);M.x=o.locate(new at(O.x,M.y),-p,0).x}else if(x===1)a&&(w.x=w.y*a,b.width=Math.abs(w.x),p=g*a),y.x=_.x-b.width/2,M.x=A.x,M.y=Math.max(M.y,E.y);else{if(a&&(p>g*a?(g=p/a,y.y=_.y+w.x*Br(d.y)/a):(p=g*a,y.x=_.x+w.y*Br(d.x)*a)),c===0||c===5){var O=c===0?o.locate(A,T,0):o.locate(A,T,-S);M.x=o.locate(new at(O.x,M.y),-p,0).x}else M.x=Math.min(M.x,E.x);M.y=Math.max(M.y,E.y)}i.setCoordinates(M),e._updateCoordFromShadow(!0)}else{var I=i.getCenter(),M=o.containerPointToCoord(y),P=new Pn([[I.x,I.y],[M.x,I.y]]),k=new Pn([[I.x,I.y],[I.x,M.y]]);p=o.computeGeometryLength(P),g=o.computeGeometryLength(k),a&&(p=Math.max(p,g*a),g=p/a)}(a||x===0||x===2)&&(i.setWidth(p*f),i!==e._geometry&&e._geometry.setWidth(p*f)),(a||x===1||x===2)&&(i.setHeight(g*f),i!==e._geometry&&e._geometry.setHeight(g*f))},function(){e._update(h())});function h(){return[["setCoordinates",i.getCoordinates().toArray()],["setWidth",i.getWidth()],["setHeight",i.getHeight()]]}},t.prototype.createPolygonEditor=function(){var e=this.getMap(),n=this._shadow||this._geometry,i=this;this._history||this._recordHistory("setCoordinates",at.toNumberArrays(n.getCoordinates()));var o=n instanceof _n?3:2,s="maptalks--editor-vertex-index",a=this.options,l=a.vertexZIndex,h=a.newVertexZIndex,u={0:[]},c={0:[]};function f(P){if(P===void 0&&(P=0),n instanceof _n){var k=n.getCoordinates()[P]||[];return k.slice(0,k.length-1)}else return n.getCoordinates()}function d(P){return P===void 0&&(P=0),P===0?n._getPrjCoordinates():n._getPrjHoles()[P-1]}function p(){for(var P in u){for(var k=u[P].length-1;k>=0;k--)u[P][k][s]=k;for(var k=c[P].length-1;k>=0;k--)c[P][k][s]=k}i._updateCoordFromShadow()}function g(P){i._updating=!0;var k=P.target,O=k[s],I=It(k._ringIndex)?k._ringIndex:0,D=d(I);if(!(D.length<=o)){var z=n instanceof Pn&&(O===0||O===D.length-1);D.splice(O,1),I>0?n._prjHoles[I-1]=D:n._setPrjCoordinates(D),n._updateCache(),u[I].splice(O,1)[0].delete(),O<c[I].length&&c[I].splice(O,1)[0].delete();var L;if(O===0?L=c[I].length-1:L=O-1,c[I].splice(L,1)[0].delete(),z||c[I].splice(L,0,w.call(i,L,I)),I>0){var $=n.getCoordinates(),Z=$[I];Z&&Array.isArray(Z)&&Z.length>1&&(Z.splice(O,1),n!==this._geometry&&n.setCoordinates($))}p(),i._updating=!1,i._geometry.fire("handleremove",Object.assign({},P,{coordinate:e.containerPointToCoordinate(P.containerPoint),vertex:P.target}))}}function m(P,k,O){O===void 0&&(O=0);var I=i._geometry.snapTo;I&&ze(I)&&(P=i._geometry.snapTo(P)||P);var D=d(O),z=e._containerPointToPrj(P.sub(x())),L=D[k];L.x=z.x,L.y=z.y,n._updateCache(),n.onShapeChanged(),i._updateCoordFromShadow(!0);var $;k===0?$=c[O].length-1:$=k-1,c[O][k]&&c[O][k].refresh(),c[O][$]&&c[O][$].refresh()}var y=new W(0,0);function x(){var P=n._getCompiledSymbol();return y.x=P.lineDx||0,y.y=P.lineDy||0,y}function v(P,k,O){k===void 0&&(k=0);var I=(O||f(k))[P],D=i.createHandle(e.coordToContainerPoint(I)._add(x()),{symbol:i.options.vertexHandleSymbol,cursor:"pointer",axis:null,onMove:function(){m(D.getContainerPoint(),D[s],k)},onRefresh:function(z,L){I=(L||f(k))[D[s]];var $=e.coordToContainerPoint(I);D.setContainerPoint($._add(x()))},onUp:function(){i._updateCoordFromShadow()},onDown:function(z,L){L&&L.domEvent&&L.domEvent.button}});return D[s]=P,D._ringIndex=k,D.on(i.options.removeVertexOn,g),D.setZIndex(l),D}var _=!1;function w(P,k,O){k===void 0&&(k=0);var I=O||f(k),D;P+1>=I.length?D=I[0]:D=I[P+1];var z=I[P].add(D).multi(1/2),L=i.createHandle(z,{symbol:i.options.newVertexHandleSymbol,cursor:"pointer",axis:null,onDown:function($,Z){if(!(Z&&Z.domEvent&&Z.domEvent.button===2)){var j=d(k),st=L[s],lt=L.getContainerPoint(),rt=e._containerPointToPrj(lt);j.splice(st+1,0,rt),k>0?n._prjHoles[k-1]=j:n._setPrjCoordinates(j),n._updateCache(),L.opacity=1,c[k].splice(st,0,w.call(i,st,k),w.call(i,st+1,k)),_=!0}},onMove:function(){m(L.getContainerPoint(),L[s]+1,k)},onUp:function($){if($&&$.domEvent&&$.domEvent.button===2){_=!1;return}var Z=L[s];uc(L,c[k]),L.delete(),u[k].splice(Z+1,0,v.call(i,Z+1,k)),p(),i._updateCoordFromShadow(),_=!1},onRefresh:function($,Z){I=Z||f($);var j=L[s],st;j===I.length-1?st=0:st=j+1;var lt=I[j].add(I[st]).multi(1/2),rt=e.coordToContainerPoint(lt);L.setContainerPoint(rt._add(x()))}});return L[s]=P,L.setZIndex(h),L}if(n instanceof _n)for(var b=n.getHoles().length+1,A=0;A<b;A++){u[A]=[],c[A]=[];for(var T=f(A),S=0,M=T.length;S<M;S++)u[A].push(v.call(this,S,A,T)),S<M-1&&c[A].push(w.call(this,S,A,T));c[A].push(w.call(this,T.length-1,A,T))}else{for(var A=0,T=f(A),S=0,M=T.length;S<M;S++)u[A].push(v.call(this,S,A,T)),S<M-1&&c[A].push(w.call(this,S,A,T));c[A].length&&n.getCoordinates().length===2&&(c[A][0].options.symbol.markerDx=12)}var E=e.getRenderer();E&&E.sortTopElements(),this._addRefreshHook(function(){if(!_){for(var P in c)for(var k=f(P),O=c[P].length-1;O>=0;O--)c[P][O].refresh(P,k);c[0].length&&n instanceof Pn&&(n.getCoordinates().length===2?c[0][0].options.symbol.markerDx=12:n.getCoordinates().length>2&&(c[0][0].options.symbol.markerDx=0));for(var P in u)for(var k=f(P),O=u[P].length-1;O>=0;O--)u[P][O].refresh(P,k)}})},t.prototype._refresh=function(){if(this._refreshHooks)for(var e=this._refreshHooks.length-1;e>=0;e--)this._refreshHooks[e].call(this)},t.prototype._hideContext=function(){this._geometry&&(this._geometry.closeMenu(),this._geometry.closeInfoWindow())},t.prototype._addRefreshHook=function(e){e&&(this._refreshHooks||(this._refreshHooks=[]),this._refreshHooks.push(e))},t.prototype._update=function(e){for(var n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];this._exeHistory([e,n]),this._recordHistory.apply(this,Ee([e],te(n),!1))},t.prototype._updateCoordFromShadow=function(e){var n=this._shadow||this._geometry,i=n.getCoordinates(),o=this._geometry,s=this._updating;this._updating=!0,o.setCoordinates(i),e||this._recordHistory("setCoordinates",at.toNumberArrays(o.getCoordinates())),this._updating=s},t.prototype._recordHistory=function(e){for(var n=[],i=1;i<arguments.length;i++)n[i-1]=arguments[i];if(this._history||(this._history=[],this._historyPointer=0),this._history.length){var o=this._history[this._history.length-1];if(o[0]===e&&JSON.stringify(o[1])===JSON.stringify(n))return}this._historyPointer<this._history.length-1&&this._history.splice(this._historyPointer+1),this._history.push([e,n]),this._historyPointer=this._history.length-1,this._geometry.fire("editrecord")},t.prototype.cancel=function(){if(!this._history||this._historyPointer===0)return this;this._historyPointer=0;var e=this._history[0];return this._exeAndReset(e),this},t.prototype.undo=function(){if(!this._history||this._historyPointer===0)return this;var e=this._history[--this._historyPointer];return this._exeAndReset(e),this},t.prototype.redo=function(){if(!this._history||this._historyPointer===this._history.length-1)return this;var e=this._history[++this._historyPointer];return this._exeAndReset(e),this},t.prototype._exeAndReset=function(e){if(!this._updating){this._exeHistory(e);var n=this._history,i=this._historyPointer;this.stop(),this._history=n,this._historyPointer=i,this.start()}},t.prototype._onDragStart=function(){this._updating=!0},t.prototype._onDragEnd=function(){this._updating=!1},t.prototype._exeHistory=function(e){var n,i;if(Array.isArray(e)){var o=this._updating;this._updating=!0;var s=this._shadow||this._geometry,a=this._geometry;Array.isArray(e[0])?e[0].forEach(function(l){var h,u,c=l[0],f=l.slice(1);(h=s[c]).call.apply(h,Ee([s],te(f),!1)),s!==a&&(u=a[c]).call.apply(u,Ee([a],te(f),!1))}):((n=s[e[0]]).call.apply(n,Ee([s],te(e[1]),!1)),s!==a&&(i=a[e[0]]).call.apply(i,Ee([a],te(e[1]),!1))),this._updating=o}},t}(to(hi));Ab.mergeOptions(gR);var mR={startEditText:function(){return this.getMap()?(this._recordVisible(),this.hide(),this.endEditText(),this._prepareEditor(),this._fireEvent("edittextstart"),this):this},endEditText:function(){if(this._textEditor){var r=this._textEditor.innerHTML;r=r.replace(/<p>/ig,"").replace(/<\/p>/ig,"<br/>"),this._textEditor.innerHTML=r;var t=this._textEditor.innerText.replace(/[\r\n]+$/gi,"");this.setContent(t),Un(this._textEditor,"mousedown dblclick",jr),this.getMap().off("mousedown",this.endEditText,this),this._editUIMarker.remove(),delete this._editUIMarker,this._textEditor.onkeyup=null,delete this._textEditor,this._recoveryVisible(),this.show(),this._fireEvent("edittextend")}return this},isEditingText:function(){return!!this._textEditor},getTextEditor:function(){return this._editUIMarker},_prepareEditor:function(){var r=this.getMap(),t=this._createEditor();this._textEditor=t,r.on("mousedown",this.endEditText,this);var e=this._getEditorOffset();this._editUIMarker=new xm(this.getCoordinates(),{animation:null,content:t,dx:e.dx,dy:e.dy}).addTo(r),this._setCursorToLast(this._textEditor)},_getEditorOffset:function(){var r=this._getInternalSymbol()||{},t=0,e=0,n=r.textHorizontalAlignment;return n==="middle"||U(n)?(t=(r.textDx||0)-2,e=(r.textDy||0)-2):(t=(r.markerDx||0)-2,e=(r.markerDy||0)-2),{dx:t,dy:e}},_createEditor:function(){var r=this.getContent(),t=this.getSize(),e=this._getInternalSymbol()||{},n=t.width,i=e.textFill||"#000000",o=e.textSize||12,s=t.height,a=e.markerLineColor||"#000",l=e.markerFill||"#3398CC",h=e.textLineSpacing||0,u=de("div");return u.contentEditable=!0,u.style.cssText="background:".concat(l,"; border:1px solid ").concat(a,`;
            color:`).concat(i,";font-size:").concat(o,"px;width:").concat(n-2,"px;height:").concat(s-2,`px;margin: auto;
            line-height:`).concat(o+h,`px;outline: 0; padding:0; margin:0;word-wrap: break-word;
            overflow: hidden;-webkit-user-modify: read-write-plaintext-only;`),u.innerText=r,Ln(u,"mousedown dblclick",jr),u.onkeyup=function(c){var f=u.style.height||0;c.keyCode===13&&(u.style.height=parseInt(f)+o/2+"px")},u},_setCursorToLast:function(r){var t;window.getSelection?(r.focus(),t=window.getSelection(),t.selectAllChildren(r),t.collapseToEnd()):document.selection&&(t=document.selection.createRange(),t.moveToElementText(r),t.collapse(!1),t.select())}};dm.include(mR),en.include({animate:function(r,t,e){var n=this;this._animPlayer&&this._animPlayer.finish(),ze(t)&&(e=t),t||(t={});var i=this.getMap(),o=this._getProjection(),s=this._prepareAnimationStyles(r),a,l=t.focus;if(delete this._animationStarted,i){var h=i._getRenderer(),u=function(f){h.callInNextFrame(f)};t.framer=u}if(!o&&l){console.error(g2);return}var c=pr.animate(s,t,function(f){if(i&&i.isRemoved()){c.finish();return}i&&!n._animationStarted&&l&&i.onMoveStart();var d=f.styles;for(var p in d)if(p!=="symbol"&&p!=="translate"&&d.hasOwnProperty(p)){var g="set"+p[0].toUpperCase()+p.slice(1);n[g](d[p])}var m=d.translate;if(m){var y=m;a&&(y=m.sub(a)),a=m,n.translate(y)}var x=d.symbol;if(x){var v=n.getSymbol()||{};n.setSymbol(Bi(v,x))}if(i&&l){var _=o.project(n.getCenter());i._setPrjCenter(_);var w=i._parseEventFromCoord(o.unproject(_));c.playState!=="running"?i.onMoveEnd(w):i.onMoving(w)}n._fireAnimateEvent(c.playState),e&&e(f)},this);return this._animPlayer=c,this._animPlayer.play()},_prepareAnimationStyles:function(r){var t=this._getInternalSymbol(),e={};for(var n in r)if(r.hasOwnProperty(n)){var i=r[n];if(n!=="translate"&&n!=="symbol"){var o="get"+n[0].toUpperCase()+n.substring(1),s=this[o]();e[n]=[s,i]}else if(n==="symbol"){var a=void 0;if(Array.isArray(r.symbol)){if(!Array.isArray(t))throw new Error("geometry'symbol isn't a composite symbol, while the symbol in styles is.");a=[];for(var l=r.symbol,h=0;h<l.length;h++){if(!l[h]){a.push(null);continue}var u={};for(var c in l[h])l[h].hasOwnProperty(c)&&(u[c]=[t[h][c],l[h][c]]);a.push(u)}}else{if(Array.isArray(t))throw new Error("geometry'symbol is a composite symbol, while the symbol in styles isn't.");a={};for(var c in i)i.hasOwnProperty(c)&&(a[c]=[t[c],i[c]])}e.symbol=a}else n==="translate"&&(e.translate=new at(i))}return e},_fireAnimateEvent:function(r){r==="finished"?(delete this._animationStarted,this._fireEvent("animateend")):r==="running"&&(this._animationStarted?this._fireEvent("animating"):(this._fireEvent("animatestart"),this._animationStarted=!0))}});var Fm=dh+"_drag_stage",Tb=be.touch?"touchstart mousedown":"mousedown",yR=function(r){Et(t,r);function t(e){return r.call(this,e)||this}return t.prototype.addHooks=function(){this.target.on(Tb,this._startDrag,this)},t.prototype.removeHooks=function(){this._endDrag(),this.target.off(Tb,this._startDrag,this),delete this.container},t.prototype._prepareDragHandler=function(){this._dragHandler=new Eh(this.container),this._dragHandler.on("dragging",this._dragging,this).on("mouseup",this._endDrag,this).enable()},t.prototype._prepareShadow=function(){var e=this,n=this.target,i=n.getLayer().options.renderer==="canvas";if(i&&n.options.dragShadow){this._prepareDragStageLayer(),this._shadow&&this._shadow.remove();var o=this._shadow=n.copy();if(o.getGeometries){var s=o.getGeometries(),a=n.getGeometries();s.forEach(function(l,h){e._updateShadowSymbol(l,a[h])})}else this._updateShadowSymbol(o,n);o.setId(null),this._prepareShadowConnectors()}},t.prototype._updateShadowSymbol=function(e,n){if(e.setSymbol(n._getInternalSymbol()),n.options.dragShadow){var i=Oc(e._getInternalSymbol(),.5);e.setSymbol(i)}},t.prototype._prepareShadowConnectors=function(){var e=this.target,n=this._shadow,i=this._dragStageLayer._getRenderer().resources,o=[];if(nf._hasConnectors(e))for(var s=nf._getConnectors(e),a=0,l=s.length;a<l;a++){var h=s[a],u=h.config(),c=h._getInternalSymbol();u.symbol=Oc(c,.5);var f=void 0;h.getConnectSource()===e?f=new h.constructor(n,h.getConnectTarget(),u):f=new h.constructor(h.getConnectSource(),n,u),o.push(f),h.getLayer()&&h.getLayer()._getRenderer()&&i.merge(h.getLayer()._getRenderer().resources)}this._shadowConnectors=o,o.push(n),this._dragStageLayer.bringToFront().addGeometry(o)},t.prototype._onTargetUpdated=function(){this._shadow&&this._shadow.setSymbol(this.target._getSymbol())},t.prototype._prepareDragStageLayer=function(){var e=this.target.getMap(),n=this.target.getLayer();this._dragStageLayer=e.getLayer(Fm),this._dragStageLayer||(this._dragStageLayer=new ro(Fm,{enableAltitude:n.options.enableAltitude,altitudeProperty:n.options.altitudeProperty}),e.addLayer(this._dragStageLayer));var i=new Ls;i.merge(n._getRenderer().resources),this._dragStageLayer._getRenderer().resources=i},t.prototype._startDrag=function(e){var n=this.target.getMap();if(n){var i=this.target._getParent();if(!i&&!this.isDragging()){var o=e.domEvent;o.touches&&o.touches.length>1||o.button===2||(this.container=n.getPanels().mapWrapper||n.getContainer(),this.target.on("click",this._endDrag,this),this._lastCoord=this._correctCoord(e.coordinate),this._lastPoint=e.containerPoint,this._prepareDragHandler(),this._dragHandler.onMouseDown(e.domEvent),Ln(this.container,"mouseleave",this._endDrag,this),this._startParam=e,this._moved=!1)}}},t.prototype._dragging=function(e){var n=this.target,i=n.getMap();if(!i._isEventOutMap(e.domEvent)){var o=i._parseEvent(e.domEvent),s=o.domEvent;if(!(s.touches&&s.touches.length>1)){var a=i._getVisualHeight(i.options.maxVisualPitch);if(!(o.containerPoint.y<i.height-a)){if(!this._moved){this._moved=!0,n.on("symbolchange",this._onTargetUpdated,this),this._isDragging=!0,this._prepareShadow(),this._shadow&&(n.options.dragShadow||n.hide(),this._shadow._fireEvent("dragstart",o)),this.target._fireEvent("dragstart",this._startParam||o),delete this._startParam;return}var l=this._shadow||n,h=l.options.dragOnAxis,u=l.options.dragOnScreenAxis,c=o.containerPoint,f=o.coordinate;this._lastPoint=this._lastPoint||c,this._lastCoord=this._lastCoord||f,u?(h==="x"?c.y=this._lastPoint.y:h==="y"&&(c.x=this._lastPoint.x),f=i.containerPointToCoord(c)):f=this._correctCoord(f);var d=c.sub(this._lastPoint),p=f.sub(this._lastCoord);u||(h==="x"?d.y=p.y=0:h==="y"&&(d.x=p.x=0)),this._lastPoint=c,this._lastCoord=f;var g=!l.getGeometries&&l.isPoint;g?l.setCoordinates(f):l.translate(p),l!==n&&!n.options.dragShadow&&(g?n.setCoordinates(f):n.translate(p)),o.coordOffset=p,o.pointOffset=d,l._fireEvent("dragging",o),l!==n&&n._fireEvent("dragging",o)}}}},t.prototype._endDrag=function(e){if(this._dragHandler&&(this._dragHandler.disable(),delete this._dragHandler),this.container&&Un(this.container,"mouseleave",this._endDrag),!!this.target){var n=this.target;n.off("click",this._endDrag,this),n.off("symbolchange",this._onTargetUpdated,this),delete this._lastCoord,delete this._lastPoint,this._isDragging=!1;var i=n.getMap();if(this.enabled()&&i){var o=i._parseEvent(e?e.domEvent:null);this._updateTargetAndRemoveShadow(o),this._moved&&n._fireEvent("dragend",o)}}},t.prototype.isDragging=function(){return!!this._isDragging},t.prototype._updateTargetAndRemoveShadow=function(e){if(this._shadow){var n=this.target,i=n.getMap();n.options.dragShadow||n.show();var o=this._shadow;if(o){if(n.options.dragShadow){var s=o.getFirstCoordinate(),a=n.getFirstCoordinate(),l=s.sub(a);n.translate(l)}o._fireEvent("dragend",e),o.remove(),delete this._shadow}this._shadowConnectors&&(i.getLayer(Fm).removeGeometry(this._shadowConnectors),delete this._shadowConnectors),this._dragStageLayer&&(this._dragStageLayer._getRenderer().resources=new Ls,this._dragStageLayer.remove())}},t.prototype._correctCoord=function(e){var n=this.target.getMap();if(!n.getPitch())return e;var i=this.target;if(!i.getMinAltitude())return e;var o=(i.getMinAltitude()+i.getMaxAltitude())/2;return n.locateByPoint(e,0,-o)},t}(ji);en.mergeOptions({draggable:!1,dragShadow:!0,dragOnAxis:null,dragOnScreenAxis:!1}),en.addInitHook("addHandler","draggable",yR),en.include({isDragging:function(){return this._getParent()?this._getParent().isDragging():this.draggable?this.draggable.isDragging():!1}}),en.include({startEdit:function(r){var t=this.getMap();return!t||!this.options.editable?this:(this._editor&&this.endEdit(),this._recordVisible(),this._editor=new Ab(this,r),this._editor.start(),this._getParent()||this.fire("editstart"),t.getRenderer().setToRedraw(),this)},endEdit:function(){if(this._editor){this._editor.stop(),delete this._editor,this._recoveryVisible(),this._getParent()||this.fire("editend");var r=this.getMap();r&&r.getRenderer().setToRedraw()}return this},redoEdit:function(){return this.isEditing()?(this._editor.redo(),this._getParent()||this.fire("redoedit"),this):this},undoEdit:function(){return this.isEditing()?(this._editor.undo(),this._getParent()||this.fire("undoedit"),this):this},cancelEdit:function(){return this.isEditing()?(this._recoveryVisible(),this._editor.cancel(),this._getParent()||this.fire("canceledit"),this):this},isEditing:function(){return this._editor?this._editor.isEditing():!1}}),en.include({_onEvent:function(r,t){var e=this.getMap();if(e){var n=t||this._getEventTypeToFire(r);n==="contextmenu"&&this.listens("contextmenu")&&(jr(r),Qi(r));var i=e._getEventParams(r);It(this._pickGeometryIndex)&&(i.pickGeometryIndex=this._pickGeometryIndex),this._fireEvent(n,i)}},_getEventTypeToFire:function(r){return r.type}}),en.include({setInfoWindow:function(r){return this.removeInfoWindow(),r instanceof _m?(this._infoWindow=r,this._infoWinOptions=Gt({},this._infoWindow.options),this._infoWindow.addTo(this),this):(this._infoWinOptions=Gt({},r),this._infoWindow?this._infoWindow.setOptions(r):this.getMap()&&this._bindInfoWindow(),this)},getInfoWindow:function(){return this._infoWindow?this._infoWindow:null},openInfoWindow:function(r){return this.getMap()?(r||(r=this.getCenter()),this._infoWindow?this._infoWindow.show(r):this._infoWinOptions&&this.getMap()&&(this._bindInfoWindow(),this._infoWindow.show(r)),this):this},closeInfoWindow:function(){return this._infoWindow&&this._infoWindow.hide(),this},removeInfoWindow:function(){return this._unbindInfoWindow(),delete this._infoWinOptions,delete this._infoWindow,this},_bindInfoWindow:function(){var r=this._infoWinOptions;return r?(this._infoWindow=new _m(r),this._infoWindow.addTo(this),this):this},_unbindInfoWindow:function(){return this._infoWindow&&(this.closeInfoWindow(),this._infoWindow.remove(),delete this._infoWindow),this}}),en.fromJSON=function(r){if(Array.isArray(r)){for(var t=[],e=0,n=r.length;e<n;e++){var i=en.fromJSON(r[e]);Array.isArray(r)?t=t.concat(i):t.push(i)}return t}if(r&&!r.feature)return Ai.toGeometry(r);var o;return r.subType?(o=en.getJSONClass(r.subType).fromJSON(r),U(r.feature.id)||o.setId(r.feature.id)):(o=Ai.toGeometry(r.feature),r.options&&o.config(r.options)),r.symbol&&o.setSymbol(r.symbol),r.infoWindow&&o.setInfoWindow(r.infoWindow),o};var vR=new W(0,0),xR=new W(0,0),Mb=new W(0,0),Sb=new W(0,0),Lm=[],_R=function(r){Et(t,r);function t(){return r.call(this,mg)||this}return t.prototype.checkUrl=function(e){return!e||!Se(e)?e:mc(e)},t.prototype.fetchImage=function(e,n,i,o){e=this.checkUrl(e);var s={url:e,fetchOptions:o};this.send(s,Lm,i,n)},t}(Rh),uf=function(r){Et(t,r);function t(e){var n=r.call(this,e)||this;n.tilesInView={},n.tilesLoading={},n._parentTiles=[],n._childTiles=[],n._tileQueue=[],n._tileQueueIds=new Set;var i=e.getTileSize().width;return n.tileCache=new Ag(e.options.maxCacheSize*i/512*i/512,function(o){n.deleteTile(o)}),be.decodeImageInWorker&&n.layer.options.decodeImageInWorker&&(e.options.renderer==="gl"||!be.safari&&!be.iosWeixin)&&(n._tileImageWorkerConn=new _R),n._compareTiles=wR.bind(n),n}return t.prototype.getCurrentTileZoom=function(){return this._tileZoom},t.prototype.draw=function(e,n){var i=this.getMap();if(this.isDrawable()){var o=this.prepareCanvas();if(o&&!o.intersects(this.canvasExtent2D)){this.completeRender();return}this._renderTimestamp!==e&&(this._consumeTileQueue(),this._computeAvgTileAltitude(),this._renderTimestamp=e);var s,a=!1,l=this._frameTiles;if(l&&e===l.timestamp){if(l.empty)return;s=l}else{if(s=this._getTilesInCurrentFrame(),!s){this._frameTiles={empty:!0,timestamp:e},this.completeRender();return}a=!0,this._frameTiles=s,this._frameTiles.timestamp=e,s.loadingCount&&this.loadTileQueue(s.tileQueue)}var h=s.tiles,u=s.childTiles,c=s.parentTiles,f=s.placeholders,d=s.loading,p=s.loadingCount,g=s.missedTiles,m=s.incompleteTiles;this._drawTiles(h,c,u,f,n,g,m),p||d||(!i.isAnimating()&&(this._parentTiles.length||this._childTiles.length)&&(this._parentTiles=[],this._childTiles=[],this.setToRedraw()),this.completeRender()),a&&this.retireTiles()}},t.prototype.getTileGridsInCurrentFrame=function(){return this._frameTileGrids},t.prototype.getCurrentTimestamp=function(){return this._renderTimestamp||0},t.prototype._getTilesInCurrentFrame=function(){var e=this.getMap(),n=this.layer,i=n._isPyramidMode()&&n.options.terrainTileMode,o=n.getTiles();if(this._frameTileGrids=o,o=o.tileGrids,!o||!o.length)return null;var s=o.reduce(function(Ct,_e){return Ct+(_e&&_e.tiles&&_e.tiles.length||0)},0);s>=this.tileCache.max/2&&this.tileCache.setMaxSize(s*2+1);var a=0,l=!1,h={},u=[],c=[],f={},d=[],p={},g=[],m={},y={},x=this.markTiles(),v=this._getLoadLimit(),_=o.length,w=this._tileZoom===void 0&&n.options.currentTilesFirst&&!this._terrainHelper;this._tileZoom=o[0].zoom;var b=null,A=null;i&&(b=[],A=new Map);for(var T=0;T<_;T++){var S=o[T],M=S.tiles,E=S.parents||Lm,P=E.length,k=w?M:E.concat(M),O=void 0;k.length&&(O=this._generatePlaceHolder(k[0].res));for(var I=0,D=k.length;I<D;I++){var z=k[I],L=z.id,$=I<P,Z=!1,j=u.length;if(this._isLoadingTile(L))Z=l=!0,this.markCurrent(this.tilesLoading[L],!0);else{var st=this.getCachedTile(z,$);if(st)$||(st.image&&this.isTileFadingIn(st.image)&&(Z=l=!0,this.setToRedraw()),this.isTileComplete(st)?u.push(st):(Z=!0,i&&A.set(L,st)));else{Z=l=!0;var lt=v&&a+x[0]>v;if(!this._tileQueueIds.has(z.id)&&!lt&&(!e.isInteracting()||e.isMoving()||e.isRotating())){a++;var rt=L;y[rt]=z}}}if(i&&!$&&(u.length===j?b.push(z):h[z.id]=1),!i&&!$&&Z&&!h[L]){h[L]=1,O&&!m[L]&&(z.cache=!1,g.push({image:O,info:z}),m[L]=1);var Rt=this._findChildTiles(z);if(Rt.length&&Rt.forEach(function(Ct){p[Ct.info.id]||(d.push(Ct),p[Ct.info.id]=1)}),!Rt.length||Rt.length!==4){var Ht=this._findParentTile(z);if(Ht){var ee=Ht.info.id;f[ee]===void 0&&(f[ee]=c.length,c.push(Ht))}}}}}var nt=[];if(i)for(var T=0;T<b.length;T++){var z=b[T].info?b[T].info:b[T];if(!(!z.parent||h[z.id])){var Dt=this._findChildTiles(z),Rt=Dt.tiles,Vt=Dt.missedTiles;if(Rt.length){ai(u,Rt),ai(nt,Vt);continue}else if(A.has(z.id)){u.push(A.get(z.id)),A.delete(z.id);continue}h[z.id]=1,nt.push(z)}}return this.tileCache.shrink(),{childTiles:d,missedTiles:nt,parentTiles:c,tiles:u,incompleteTiles:A&&Array.from(A.values()),placeholders:g,loading:l,loadingCount:a,tileQueue:y}},t.prototype.removeTileCache=function(e){delete this.tilesInView[e],this.tileCache.remove(e)},t.prototype.isTileCachedOrLoading=function(e){return this.tileCache.get(e)||this.tilesInView[e]||this.tilesLoading[e]},t.prototype.isTileCached=function(e){return!!(this.tileCache.get(e)||this.tilesInView[e])},t.prototype.isTileFadingIn=function(e){return this._getTileFadingOpacity(e)<1},t.prototype._drawTiles=function(e,n,i,o,s,a,l){var h=this;n.length&&(n.sort(this._compareTiles),this._parentTiles=n),i.length&&(this._childTiles=i,this._childTiles.sort(this._compareTiles));var u=!0,c=this.canvas._parentTileTimestamp;(this.layer.constructor===En||this.layer.constructor===Cm)&&(this._renderTimestamp===c?u=!1:this.canvas._parentTileTimestamp=this._renderTimestamp);var f=this.layer.options.renderer==="gl"&&(!this.isGL||this.isGL()),d={tiles:e,parentTiles:this._parentTiles,childTiles:this._childTiles,parentContext:s};if(this.onDrawTileStart(d,s),u&&this.layer.options.opacity===1){this.layer._silentConfig=!0;var p=this.layer.options.fadeAnimation;this.layer.options.fadeAnimation=!1,f?(this._drawChildTiles(i,s),this._drawParentTiles(this._parentTiles,s)):(this._drawParentTiles(this._parentTiles,s),this._drawChildTiles(i,s)),this.layer.options.fadeAnimation=p,this.layer._silentConfig=!1}this.drawingCurrentTiles=!0,e.sort(this._compareTiles);for(var g=0,m=e.length;g<m;g++)this._drawTileAndCache(e[g],s);if(delete this.drawingCurrentTiles,u&&this.layer.options.opacity<1){this.layer._silentConfig=!0;var p=this.layer.options.fadeAnimation;this.layer.options.fadeAnimation=!1,f?(this._drawChildTiles(i,s),this._drawParentTiles(this._parentTiles,s)):(this._drawParentTiles(this._parentTiles,s),this._drawChildTiles(i,s)),this.layer.options.fadeAnimation=p,this.layer._silentConfig=!1}o.forEach(function(y){return h._drawTile(y.info,y.image,s)}),this.onDrawTileEnd(d,s)},t.prototype._drawChildTiles=function(e,n){var i=this;this.drawingChildTiles=!0,e.forEach(function(o){return i._drawTile(o.info,o.image,n)}),delete this.drawingChildTiles},t.prototype._drawParentTiles=function(e,n){var i=this;this.drawingParentTiles=!0,this._parentTiles.forEach(function(o){return i._drawTile(o.info,o.image,n)}),delete this.drawingParentTiles},t.prototype.onDrawTileStart=function(e,n){},t.prototype.onDrawTileEnd=function(e,n){},t.prototype._drawTile=function(e,n,i){n&&this.drawTile(e,n,i)},t.prototype._drawTileAndCache=function(e,n){this.isValidCachedTile(e)&&(this.tilesInView[e.info.id]=e),this._drawTile(e.info,e.image,n)},t.prototype.drawOnInteracting=function(e,n,i){this.draw(n,i)},t.prototype.needToRedraw=function(){var e=this.getMap();return this._tileQueue.length?!0:e.getPitch()?r.prototype.needToRedraw.call(this):e.isRotating()||e.isZooming()?!0:e.isMoving()?!!this.layer.options.forceRenderOnMoving:r.prototype.needToRedraw.call(this)},t.prototype.hitDetect=function(){return!1},t.prototype._getLoadLimit=function(){return this.getMap().isInteracting()?this.layer.options.loadingLimitOnInteracting:this.layer.options.loadingLimit||0},t.prototype.isDrawable=function(){return this.getMap().getPitch()?(console&&console.warn("TileLayer with canvas renderer can't be pitched, use gl renderer ('renderer' : 'gl') instead."),this.clear(),!1):!0},t.prototype.clear=function(){this.retireTiles(!0),this.tileCache.reset(),this.tilesInView={},this.tilesLoading={},this._tileQueue=[],this._tileQueueIds.clear(),this._parentTiles=[],this._childTiles=[],r.prototype.clear.call(this)},t.prototype._isLoadingTile=function(e){return!!this.tilesLoading[e]},t.prototype.clipCanvas=function(e){return r.prototype.clipCanvas.call(this,e)},t.prototype._clipByPitch=function(e){var n=this.getMap();if(n.getPitch()<=n.options.maxVisualPitch||!this.layer.options.clipByPitch)return!1;var i=n.getContainerExtent(),o=n.getDevicePixelRatio();return e.save(),e.strokeStyle="rgba(0, 0, 0, 0)",e.beginPath(),e.rect(0,Math.ceil(i.ymin)*o,Math.ceil(i.getWidth())*o,Math.ceil(i.getHeight())*o),e.stroke(),e.clip(),!0},t.prototype.loadTileQueue=function(e){for(var n in e)if(e.hasOwnProperty(n)){var i=e[n],o=this.loadTile(i);o.loadTime===void 0&&(this.tilesLoading[i.id]={image:o,current:!0,info:i})}},t.prototype.loadTile=function(e){var n=this,i={};if(this.loadTileBitmap){var o=function(l){n.onTileLoad(l,e)},s=function(l,h){n.onTileError(h,e,l)};this.loadTileBitmap(e.url,e,o,s)}else if(this._tileImageWorkerConn&&this.loadTileImage===this.constructor.prototype.loadTileImage)this._fetchImage(i,e);else{var a=this.layer.getTileSize(e.layer);i=new Image,i.width=a.width,i.height=a.height,i.onload=this.onTileLoad.bind(this,i,e),i.onerror=this.onTileError.bind(this,i,e),this.loadTileImage(i,e.url)}return i},t.prototype._fetchImage=function(e,n){var i=this;if(e instanceof Image)e.src=n.url;else{var o=n.x,s=n.y,a=Math.abs(o+s)%this._tileImageWorkerConn.workers.length;this._tileImageWorkerConn.fetchImage(n.url,a,function(l,h){l?i.onTileError(e,n,l):$p(h,function(u){i.onTileLoad(u,n)})},this.layer.options.fetchOptions||{referrer:document.location.href,headers:{accept:"image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8"}})}},t.prototype.loadTileImage=function(e,n){var i=this.layer.options.crossOrigin;return U(i)||(e.crossOrigin=i),hh(e,[n])},t.prototype.abortTileLoading=function(e,n){n&&n.id!==void 0&&this.removeTileLoading(n),e&&e instanceof Image&&(e.onload=Cb,e.onerror=Cb,e.src=Gp)},t.prototype.onTileLoad=function(e,n){this.removeTileLoading(n),this._tileQueue.push({tileInfo:n,tileData:e}),this._tileQueueIds.add(n.id),this.setToRedraw()},t.prototype.removeTileLoading=function(e){delete this.tilesLoading[e.id],this.setToRedraw()},t.prototype._consumeTileQueue=function(){for(var e=0,n=this.layer.options.tileLimitPerFrame,i=this._tileQueue;i.length&&(n<=0||e<n);){var o=i.shift(),s=o.tileData,a=o.tileInfo;this._tileQueueIds.has(a.id)&&(this._tileQueueIds.delete(a.id),this.checkTileInQueue(s,a)&&(this.consumeTile(s,a),e++))}},t.prototype._computeAvgTileAltitude=function(){var e=0,n=0,i=0;for(var o in this.tilesInView){var s=this.tilesInView[o]&&this.tilesInView[o].info;s&&(e+=s.minAltitude||0,n+=s.maxAltitude||0,i++)}this.avgMinAltitude=e/i,this.avgMaxAltitude=n/i},t.prototype.checkTileInQueue=function(e,n){return!0},t.prototype.consumeTile=function(e,n){if(this.layer&&this.tilesInView){var i={tile:n,tileImage:e};e=i.tileImage,this.resetTileLoadTime(e),this.removeTileLoading(n),this._addTileToCache(n,e),this.layer.fire("tileload",i),this.setToRedraw()}},t.prototype.resetTileLoadTime=function(e){e.loadTime!==0&&(e.loadTime=Qe())},t.prototype.onTileError=function(e,n,i){if(this.layer){e.onerrorTick=e.onerrorTick||0;var o=this.layer.options.tileRetryCount;if(o>e.onerrorTick){e.onerrorTick++,this._fetchImage(e,n),this.removeTileLoading(n);return}var s=this.layer.options.errorUrl;if(s)if(e instanceof Image&&e.src!==s){e.src=s,this.removeTileLoading(n);return}else e=new Image,e.src=s;this.abortTileLoading(e,n),e.loadTime=0,this.removeTileLoading(n),this._addTileToCache(n,e),this.setToRedraw(),this.layer.fire("tileerror",{tile:n})}},t.prototype.drawTile=function(e,n,i){if(!(!n||!this.getMap())){var o=e.extent2d,s=e.offset,a=vR.set(o.xmin-s[0],o.ymax-s[1]),l=e.z,h=e.id,u=this.getMap(),c=u.getZoom(),f=this.context,d=u._pointAtResToContainerPoint(a,e.res,0,xR),p=u.getBearing(),g=p||c!==l,m=this.getTileOpacity(n,e),y=f.globalAlpha;m<1&&(f.globalAlpha=m),g||d._round();var x=d.x,v=d.y,_=e.extent2d.xmax-e.extent2d.xmin,w=e.extent2d.ymax-e.extent2d.ymin,b=this.layer,A=b?b.options.bufferPixel:0;if(g){f.save(),f.translate(x,v),p&&f.rotate(-p*Math.PI/180),_+=A,w+=A;var T=u._getResolution();if(T!==e.res){var S=e.res/T;f.scale(S,S)}x=v=0}if(Mt.image(f,n,x,v,_,w),this.layer.options.debug){var M=this.layer.options.debugOutline;f.save(),f.strokeStyle=M,f.fillStyle=M,f.font="20px monospace";var E=new W(x,v);Mt.rectangle(f,E,{width:_,height:w},1,0),Mt.fillText(f,this.getDebugInfo(h),E._add(32,w-14),M),Mt.drawCross(f,x+_/2,v+w/2,2,M),f.restore()}g&&f.restore(),f.globalAlpha!==y&&(f.globalAlpha=y),this.setCanvasUpdated()}},t.prototype.getDebugInfo=function(e){var n=e.split("_"),i=n.length;return n[i-3]+"/"+n[i-2]+"/"+n[i-1]},t.prototype.findChildTiles=function(e){return this._findChildTiles(e)},t.prototype._findChildTiles=function(e){var n=this._getLayerOfTile(e.layer),i=n&&n.options.terrainTileMode&&n._isPyramidMode();if(!n||!n.options.background&&!i||e.z>this.layer.getMaxZoom())return Lm;var o=this.getMap(),s=[];if(n._isPyramidMode()){if(!i){for(var a=this._getLayerOfTile(e.layer),l=2,h=e.x*2,u=e.y*2,c=e.z+1,f=[],d=0;d<2;d++)for(var p=0;p<2;p++)f.push(h+d,u+p,c);for(;f.length;){var g=f.pop(),m=f.pop(),y=f.pop(),x=a._getTileId(y,m,g,e.layer),v=g+1<=e.z+l,_=this.tileCache.getAndRemove(x);if(_){if(this.isValidCachedTile(_))s.push(_),this.tileCache.add(x,_);else if(v)for(var d=0;d<2;d++)for(var p=0;p<2;p++)f.push(y*2+d,m*2+p,g+1)}else if(v)for(var d=0;d<2;d++)for(var p=0;p<2;p++)f.push(y*2+d,m*2+p,g+1)}return s}var w=void 0;i&&(w=[]);for(var b=e.x*2,A=e.y*2,T=e.z+1,S=[],M=0;M<2;M++)for(var E=0;E<2;E++){var y=b+M,m=A+E,g=T,x=n._getTileId(y,m,g,e.layer),_=this.tileCache.getAndRemove(x);_&&this.isValidCachedTile(_)?(s.push(_),this.tileCache.add(x,_),S.push(null)):S.push(x)}if(s.length<4)for(var P=0,M=0;M<2;M++)for(var E=0;E<2;E++){var x=S[P++];if(x){for(var y=b+M,m=A+E,g=T,k=s.length,O=[],d=0;d<2;d++)for(var p=0;p<2;p++){var I=y*2+d,D=m*2+p,z=g+1,L=n._getTileId(I,D,z,e.layer),$=this.tileCache.getAndRemove(L);$&&this.isValidCachedTile($)?(s.push($),this.tileCache.add(L,$),O.push(null)):O.push(L)}if(i&&s.length-k<4){var Z=n.tileInfoCache.get(x)||n._createChildNode(e,M,E,[0,0],x);if(s.length-k===0)w.push(Z);else for(var j=0,d=0;d<2;d++)for(var p=0;p<2;p++){var st=O[j++];if(st){var lt=this.layer.tileInfoCache.get(st)||n._createChildNode(Z,d,p,[0,0],st);w.push(lt)}}}}}return i?{tiles:s,missedTiles:w}:s}for(var rt=1,Rt=e.res,Ht=e.extent2d.getMin(),ee=e.extent2d.getMax(),nt=n._project(o._pointToPrjAtRes(Ht,Rt,Mb),Mb),Dt=n._project(o._pointToPrjAtRes(ee,Rt,Sb),Sb),M=1;M<rt;M++)this._findChildTilesAt(s,nt,Dt,n,e.z+M);return s},t.prototype._findChildTilesAt=function(e,n,i,o,s){var a=o.getId(),l=o.getSpatialReference().getResolution(s);if(l)for(var h=o._getTileConfig().getTileIndex(n,l),u=o._getTileConfig().getTileIndex(i,l),c=Math.min(h.idx,u.idx),f=Math.max(h.idx,u.idx),d=Math.min(h.idy,u.idy),p=Math.max(h.idy,u.idy),g,m,y=c;y<f;y++)for(var x=d;x<p;x++)g=o._getTileId(y,x,s,a),m=this.tileCache.getAndRemove(g),m&&this.isValidCachedTile(m)&&(e.push(m),this.tileCache.add(g,m))},t.prototype.findParentTile=function(e,n){return this._findParentTile(e,n)},t.prototype._findParentTile=function(e,n){var i=this.getMap(),o=this._getLayerOfTile(e.layer);if(!o||!o.options.background&&!o.options.terrainTileMode)return null;var s=o.getMinZoom(),a=n||e.z-s;if(o._isPyramidMode()){for(var l=e.z-a,h=e.z-1;h>=l;h--){var u=e.z-h,c=Math.pow(2,u),f=Math.floor(e.x/c),d=Math.floor(e.y/c),p=void 0;h===e.z-1?p=e.parent:p=o._getTileId(f,d,h,e.layer);var g=this.tileCache.getAndRemove(p);if(g&&this.isValidCachedTile(g))return this.tileCache.add(p,g),g}return null}for(var m=o.getSpatialReference(),y=m.getZoomDirection(),x=e.res,v=e.extent2d.getCenter(),_=o._project(i._pointToPrjAtRes(v,x)),u=1;u<=a;u++){var h=e.z-y*u,w=m.getResolution(h);if(w){var b=o._getTileConfig().getTileIndex(_,w),p=o._getTileId(b.x,b.y,h,e.layer),g=this.tileCache.getAndRemove(p);if(g)return this.tileCache.add(p,g),g}}return null},t.prototype.isValidCachedTile=function(e){return!!e.image},t.prototype.isTileComplete=function(e){return!0},t.prototype._getLayerOfTile=function(e){return this.layer.getChildLayer?this.layer.getChildLayer(e):this.layer},t.prototype.getCachedTile=function(e,n){var i=e.id,o=this.tilesInView,s=this.tileCache.getAndRemove(i);if(s){n||(o[i]=s);var a=this.tilesLoading;if(a&&a[i]){this.markCurrent(a[i],!1);var l=a[i],h=l.image,u=l.info;this.abortTileLoading(h,u),delete a[i]}}else s=o[i];return s&&(s.current=!0,this.isValidCachedTile(s)&&this.tileCache.add(i,s)),s},t.prototype._addTileToCache=function(e,n){if(this.isValidCachedTile({info:e,image:n})){var i={image:n,info:e};this.tileCache.add(e.id,i)}},t.prototype.getTileOpacity=function(e,n){var i=this._getTileFadingOpacity(e);if(this.layer.getChildLayer){var o=this.layer.getLayer(n.layer);o&&(i*=o.options.opacity)}return i},t.prototype._getTileFadingOpacity=function(e){return!this.layer.options.fadeAnimation||!e.loadTime?1:Math.min(1,(Qe()-e.loadTime)/this.layer.options.fadeDuration)},t.prototype.onRemove=function(){this.clear(),delete this.tileCache,delete this._tilePlaceHolder,delete this._tileZoom,r.prototype.onRemove.call(this)},t.prototype.markCurrent=function(e,n){e.current=n},t.prototype.markTiles=function(){var e=0,n=0;if(this.tilesLoading)for(var i in this.tilesLoading)this.markCurrent(this.tilesLoading[i],!1),e++;if(this.tilesInView)for(var i in this.tilesInView)this.markCurrent(this.tilesInView[i],!1),n++;return[e,n]},t.prototype.retireTiles=function(e){for(var n in this.tilesLoading){var i=this.tilesLoading[n];(e||!i.current)&&(i.image&&this.abortTileLoading(i.image,i.info),this.deleteTile(i),this.removeTileLoading(i.info))}for(var n in this.tilesInView){var i=this.tilesInView[n];i.current||(delete this.tilesInView[n],this.tileCache.has(n)||this.deleteTile(i))}},t.prototype.deleteTile=function(e){if(!(!e||!e.image)){var n=e.info.id;this._tileQueueIds.has(n)&&this._tileQueueIds.delete(n),e.image.close&&e.image.close(),e.image instanceof Image&&(e.image.onload=null,e.image.onerror=null)}},t.prototype._generatePlaceHolder=function(e){var n=this.getMap(),i=this.layer.options.placeholder;if(!i||n.getPitch())return null;var o=this.layer.getTileSize(),s=e/n._getResolution(),a=this._tilePlaceHolder=this._tilePlaceHolder||Mt.createCanvas(1,1,n.CanvasClass);return a.width=o.width*s,a.height=o.height*s,ze(i)?i(a):bR(a),a},t.prototype.setTerrainHelper=function(e){this._terrainHelper=e},t}(Oa);En.registerRenderer("canvas",uf);function Cb(){return!1}function bR(r){var t=r.getContext("2d"),e=r.width,n=r.height,i=e/16,o=n/16;t.beginPath();for(var s=0;s<16;s++)t.moveTo(0,s*o),t.lineTo(e,s*o),t.moveTo(s*i,0),t.lineTo(s*i,n);t.strokeStyle="rgba(180, 180, 180, 0.1)",t.lineWidth=1,t.stroke(),t.beginPath();for(var a=[[0,0],[e,0],[0,n],[e,n],[0,0],[0,n],[e,0],[e,n],[0,n/2],[e,n/2],[e/2,0],[e/2,n]],s=1;s<a.length;s+=2)t.moveTo(a[s-1][0],a[s-1][1]),t.lineTo(a[s][0],a[s][1]);t.lineWidth=1*4,t.stroke()}function wR(r,t){return Math.abs(this._tileZoom-r.info.z)-Math.abs(this._tileZoom-t.info.z)}var AR=new W(0,0),TR={properties:{}},zm=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.isDrawable=function(){return!0},t.prototype.needToRedraw=function(){var e=this.getMap();return this.isGL()&&!e.getPitch()&&e.isZooming()&&!e.isMoving()&&!e.isRotating()?!0:r.prototype.needToRedraw.call(this)},t.prototype.onDrawTileStart=function(e,n){var i=this.gl;i.enable(i.DEPTH_TEST),i.depthFunc(i.LEQUAL),i.enable(i.POLYGON_OFFSET_FILL),i.enable(i.STENCIL_TEST),i.stencilOp(i.KEEP,i.KEEP,i.REPLACE);var o=!!this.layer.options.depthMask;if(i.depthMask(o),n&&n.renderTarget){var s=n.renderTarget.fbo;if(s){var a=n.renderTarget.getFramebuffer(s);i.bindFramebuffer(i.FRAMEBUFFER,a)}}},t.prototype.onDrawTileEnd=function(e,n){var i=this.gl;if(n&&n.renderTarget){var o=n.renderTarget.fbo;o&&i.bindFramebuffer(i.FRAMEBUFFER,null)}},t.prototype.drawTile=function(e,n,i){if(!(i&&i.sceneFilter&&!i.sceneFilter(TR))){var o=this.getMap();if(!(!e||!o||!n)){var s=e._glScale=e._glScale||e.res/o.getGLRes(),a=e.extent2d.xmax-e.extent2d.xmin,l=e.extent2d.ymax-e.extent2d.ymin;if(e.cache!==!1&&this._bindGLBuffer(n,a,l),!this.isGL()){r.prototype.drawTile.call(this,e,n);return}var h=e.extent2d,u=e.offset,c=AR.set(h.xmin-u[0],e.extent2d.ymax-u[1]),f=c.x*s,d=c.y*s,p=this.getTileOpacity(n,e),g=null;this.layer.options.debug&&(g=this.getDebugInfo(e.id));var m=this.gl;m.stencilFunc(m.LEQUAL,Math.abs(this.getCurrentTileZoom()-e.z),255);var y=this.layer.getPolygonOffset(),x=this.drawingCurrentTiles?y:y+1;m.polygonOffset(x,x),this.drawGLImage(n,f,d,a,l,s,p,g),this._getTileFadingOpacity(n)<1?this.setToRedraw():this.setCanvasUpdated()}}},t.prototype._bindGLBuffer=function(e,n,i){e.glBuffer||(e.glBuffer=this.bufferTileData(0,0,n,i))},t.prototype.loadTileImage=function(e,n){var i=this.layer.options.crossOrigin;e.crossOrigin=i!==null?i:"",e.src=n},t.prototype.onCanvasCreate=function(){(!this.canvas.gl||!this.canvas.gl.wrap)&&this.createCanvas2()},t.prototype.createContext=function(){r.prototype.createContext.call(this),this.createGLContext()},t.prototype.resizeCanvas=function(e){this.canvas&&(r.prototype.resizeCanvas.call(this,e),this.resizeGLCanvas())},t.prototype.clearCanvas=function(){this.canvas&&(r.prototype.clearCanvas.call(this),this.clearGLCanvas())},t.prototype.getCanvasImage=function(){if(!this.isGL()||!this.canvas2)return r.prototype.getCanvasImage.call(this);var e=r.prototype.getCanvasImage.call(this);return e&&(e.image=this.canvas2),e},t.prototype.isGL=function(){if(this.canvas.gl&&this.canvas.gl.wrap)return!0;var e=this.getMap();return e&&(e.getPitch()||e.getBearing())||this.layer&&!!this.layer.options.fragmentShader},t.prototype.deleteTile=function(e){r.prototype.deleteTile.call(this,e),e&&e.image&&this.disposeImage(e.image),delete e.image},t.prototype.onRemove=function(){r.prototype.onRemove.call(this),this.removeGLCanvas()},t}(Em(uf));En.registerRenderer("gl",zm);function Pb(r){var t=this,e=this.layer.getTileSize(),n=this.canvas.constructor,i=this.getMap(),o=i.getDevicePixelRatio(),s=Mt.createCanvas(e.width*o,e.height*o,n);s.layer=this.layer;var a=new W(r.extent2d.xmin,r.extent2d.ymax),l=new gn(i.pointToCoordinate(a),i.pointToCoordinate(a.add(e.width,e.height)),i.getProjection());return this.layer.drawTile(s,{url:r.url,point:a,center:i.pointToCoordinate(a.add(e.width/2,e.height/2)),extent:l,z:r.z,x:r.x,y:r.y},function(h){if(h){t.onTileError(s,r);return}t.onTileLoad(s,r)}),s}var Eb=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.loadTile=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return Pb.apply(this,e)},t}(uf),Ob=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.loadTile=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return Pb.apply(this,e)},t}(zm);Pm.registerRenderer("canvas",Eb),Pm.registerRenderer("gl",Ob);var MR=typeof Int8Array<"u"?new Int8Array([-1,1,0,-1,-1,0,1,1,0,1,-1,0]):[],SR=`
    attribute vec3 a_position;
    uniform mat4 transform;

    void main()
    {
        gl_Position = transform * vec4(a_position, 1.0);
    }
`,CR=`
    precision mediump float;
    uniform vec3 color;
    void main()
    {
        gl_FragColor = vec4(color, 1.0);
    }
`,PR=function(){function r(t,e,n){this.gl=t,this.quadVertices=e||MR,this.attributes=["a_position",3,ER(e)],this.debug=n}return r.prototype.start=function(){var t=this.gl;t.enable(t.STENCIL_TEST),t.stencilMask(255),t.stencilOp(t.KEEP,t.REPLACE,t.REPLACE),t.depthMask(!1),this._save(),this.buffer||(this._createBuffer(),this._createProgram()),t.useProgram(this.program),t.bindBuffer(t.ARRAY_BUFFER,this.buffer),gb(t,this.program,this.attributes),this.transformLoc||(this.transformLoc=t.getUniformLocation(this.program,"transform")),this.colorLoc||(this.colorLoc=t.getUniformLocation(this.program,"color")),!this.debug&&t.colorMask(!1,!1,!1,!1)},r.prototype.end=function(){var t=this.gl;t.depthMask(!0),this._restore(),!this.debug&&t.colorMask(!0,!0,!0,!0)},r.prototype.draw=function(t){var e=this.gl;e.uniformMatrix4fv(this.transformLoc,!1,t),e.uniform3fv(this.colorLoc,[Math.random(),Math.random(),Math.random()]),e.drawArrays(e.TRIANGLE_STRIP,0,4)},r.prototype.remove=function(){var t=this.gl;return this.buffer&&t.deleteBuffer(this.buffer),this.program&&(t.deleteShader(this.program.fragmentShader),t.deleteShader(this.program.vertexShader),t.deleteProgram(this.program)),delete this.transformLoc,delete this.gl,this},r.prototype.stencilMask=function(t){return this.gl.stencilMask(t),this},r.prototype.stencilFunc=function(t,e,n){return this.ref=e,this.gl.stencilFunc(t,e,n),this},r.prototype.stencilOp=function(t,e,n){return this.gl.stencilOp(t,e,n),this},r.prototype.resetFunc=function(){return this.ref=1,this.gl.stencilFunc(this.gl.ALWAYS,1,255),this},r.prototype._save=function(){var t=this.gl;this._savedProgram=t.program},r.prototype._restore=function(){var t=this.gl;t.program=this._savedProgram,t.program&&t.useProgram(t.program)},r.prototype._createBuffer=function(){var t=this.gl;if(this.buffer=t.createBuffer(),!this.buffer)throw new Error("Failed to create the buffer object");t.bindBuffer(t.ARRAY_BUFFER,this.buffer),t.bufferData(t.ARRAY_BUFFER,this.quadVertices,t.STATIC_DRAW)},r.prototype._createProgram=function(){var t=pb(this.gl,SR,CR),e=t.program,n=t.vertexShader,i=t.fragmentShader;e.vertexShader=n,e.fragmentShader=i,this.program=e},r}();function ER(r){return r instanceof Float32Array?"FLOAT":r instanceof Int16Array?"SHORT":r instanceof Uint16Array?"UNSIGNED_SHORT":r instanceof Int8Array?"BYTE":r instanceof Uint8Array||r instanceof Uint8ClampedArray?"UNSIGNED_BYTE":"FLOAT"}var kb=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.checkResources=function(){var e=this._geosToCheck||[];if(!this._resourceChecked&&this.layer._geoList&&ai(e,this.layer._geoList),!on(e))return[];for(var n=[],i={},o=e.length-1;o>=0;o--){var s=e[o],a=s._getExternalResources();if(a.length)if(!this.resources)n.push.apply(n,Ee([],te(a),!1));else for(var l=0;l<a.length;l++){var h=a[l][0];!this.resources.isResourceLoaded(a[l])&&!i[h]&&(n.push(a[l]),i[h]=1)}}return this._resourceChecked=!0,delete this._geosToCheck,n},t.prototype.render=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return this.layer._sortGeometries(),r.prototype.render.apply(this,e)},t.prototype._addGeoToCheckRes=function(e){e&&(Array.isArray(e)||(e=[e]),this._geosToCheck||(this._geosToCheck=[]),ai(this._geosToCheck,e))},t.prototype.onGeometryAdd=function(e){this._addGeoToCheckRes(e),Mo(this)},t.prototype.onGeometryRemove=function(e){Mo(this)},t.prototype.onGeometrySymbolChange=function(e){this._addGeoToCheckRes(e.target),Mo(this)},t.prototype.onGeometryShapeChange=function(e){Mo(this)},t.prototype.onGeometryPositionChange=function(e){Mo(this)},t.prototype.onGeometryZIndexChange=function(e){Mo(this)},t.prototype.onGeometryShow=function(e){Mo(this)},t.prototype.onGeometryHide=function(e){Mo(this)},t.prototype.onGeometryPropertiesChange=function(e){Mo(this)},t}(Oa);function Mo(r){r.layer.options.drawImmediate&&r.render(),r.setToRedraw()}var OR=new Ce,cf=[],Hm=new Ce,kR="center",Ib=new Ph;function Rb(r){if(!r)return null;var t=r.getContext("2d");return t.clearRect(0,0,r.width,r.height),t}function Zh(r){return r&&r.options.progressiveRender&&r.options.progressiveRenderDebug}var Db=function(r){Et(t,r);function t(){return r!==null&&r.apply(this,arguments)||this}return t.prototype.setToRedraw=function(){return r.prototype.setToRedraw.call(this),this._resetProgressiveRender(),this},t.prototype._geoIsCollision=function(e,n){if(!e)return!1;var i=e.options.collision;if(!i)return!1;if(e.isPoint&&e.getContainerExtent){e.bbox||(e.bbox=[0,0,0,0]);var o=this.layer.options.collisionBufferSize,s=e.getContainerExtent();if(!s)return!1;if(e.bbox[0]=s.xmin-o,e.bbox[1]=s.ymin-o,e.bbox[2]=s.xmax+o,e.bbox[3]=s.ymax+o,n.collides(e.bbox))return!0;n.insertBox(e.bbox)}return!1},t.prototype.getImageData=function(){if(!this._lastRenderTime||Qe()-this._lastRenderTime<32||!this.context||!this.context.canvas)return null;if(!this._imageData){var e=this.context.canvas,n=e.width,i=e.height;try{this._imageData=this.context.getImageData(0,0,n,i)}catch(o){console.warn(`hit detect failed with tainted canvas, some geometries have external resources in another domain:
`,o)}}return this._imageData},t.prototype.clearImageData=function(){this._imageData=null,delete this._imageData,this._lastRenderTime=Qe()},t.prototype.checkResources=function(){for(var e=this,n=[],i=0;i<arguments.length;i++)n[i]=arguments[i];var o=r.prototype.checkResources.apply(this,n),s=this.layer.getStyle();return s&&(Array.isArray(s)||(s=[s]),s.forEach(function(a){for(var l=yh(a.symbol,!0),h=0,u=l.length;h<u;h++)e.resources.isResourceLoaded(l[h])||o.push(l[h])})),o},t.prototype.needToRedraw=function(){if(this.isProgressiveRender()&&!this.renderEnd)return!0;var e=this.getMap();return e.isInteracting()&&this.layer.options.enableAltitude?!0:e.isZooming()&&!e.isRotating()&&!e.getPitch()&&!this._hasPoint&&this.layer.constructor===ro?!1:r.prototype.needToRedraw.call(this)},t.prototype.draw=function(){if(this.getMap()){if(!this.layer.isVisible()||this.layer.isEmpty()){this.clearCanvas(),this.completeRender();return}this.prepareCanvas(),this.drawGeos(),this.completeRender()}},t.prototype.isBlank=function(){return!this.context||this.isProgressiveRender()?!1:!this.context.canvas._drawn},t.prototype.drawOnInteracting=function(){if(this._geosToDraw){this._updateMapStateCache(),this._updateDisplayExtent();var e=this.getMap(),n=this.layer.getCount(),i=this.mapStateCache.resolution;(e.isZooming()&&e.options.seamlessZoom&&this._drawnRes!==void 0&&i>this._drawnRes*1.5&&this._geosToDraw.length<n||e.isMoving()||e.isInteracting())&&(this.prepareToDraw(),this._batchConversionMarkers(this.mapStateCache.glRes),this._onlyHasPoint||this._checkGeos(),this._drawnRes=i),this._sortByDistanceToCamera(e.cameraPosition);var o=this.layer.options,s=o.collision,a=o.collisionDelay;if(s){var l=Qe();this._lastCollisionTime||(this._lastCollisionTime=l),l-this._lastCollisionTime<=a?this._geosToDraw=this._lastGeosToDraw||this._geosToDraw:(this._collidesGeos(),this._lastCollisionTime=l)}for(var h=0,u=this._geosToDraw.length;h<u;h++){var c=this._geosToDraw[h];if(!c._isCheck&&!c.isVisible()){delete c._cPoint,delete c._inCurrentView;continue}c._paint(this._displayExtent),this._geosToDraw[h]._cPoint=void 0,this._geosToDraw[h]._inCurrentView=void 0}this.clearImageData(),this._lastGeosToDraw=this._geosToDraw,Zh(this.layer)&&console.log("progressiveRender on drawOnInteracting page:",this.page)}},t.prototype.show=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];this.layer.forEach(function(i){i._repaint()}),r.prototype.show.apply(this,e)},t.prototype.forEachGeo=function(e,n){this.layer.forEach(e,n)},t.prototype._checkGeos=function(){for(var e=this._getCurrentNeedRenderGeos(),n=0,i=e.length;n<i;n++)this.checkGeo(e[n]);return this},t.prototype.drawGeos=function(){this._drawSnapshot(),this._updateMapStateCache(),this._drawnRes=this.mapStateCache.resolution,this._updateDisplayExtent(),this.prepareToDraw(),this._batchConversionMarkers(this.mapStateCache.glRes),this._onlyHasPoint||this._checkGeos(),this._sortByDistanceToCamera(this.getMap().cameraPosition),this._collidesGeos();for(var e=0,n=this._geosToDraw.length;e<n;e++)this._geosToDraw[e]._paint(),this._geosToDraw[e]._cPoint=void 0,this._geosToDraw[e]._inCurrentView=void 0;this.clearImageData(),this._lastGeosToDraw=this._geosToDraw,Zh(this.layer)&&console.log("progressiveRender drawGeos page:",this.page),this._snapshot(),this._setDrawGeosDrawTime()},t.prototype.prepareToDraw=function(){return this.layer._drawTime=Qe(),this._hasPoint=!1,this._geosToDraw=[],this},t.prototype._setDrawGeosDrawTime=function(){for(var e=Qe(),n=this.layer._drawTime,i=this.getGeoPainterList(),o=0,s=i.length;o<s;o++){var a=i[o];a&&a._setDrawTime&&a._setDrawTime(n)}return Zh(this.layer)&&console.log("_setDrawGeosDrawTime time:",Qe()-e+"ms"),this},t.prototype.checkGeo=function(e){if(e.isPoint&&this._onlyHasPoint!==void 0){(e._inCurrentView||e.hasAltitude())&&(this._hasPoint=!0,e._isCheck=!0,this._geosToDraw.push(e));return}if(e._isCheck=!1,!(!e||!e.isVisible()||!e.getMap()||!e.getLayer()||!e.getLayer().isCanvasRender())){var n=e._getPainter(),i=!0;if(e._inCurrentView||!U(e.options.arcDegree)||e.hasAltitude())i=!0;else if(e._inCurrentView===!1)i=!1;else{var o=n.get2DExtent(this.resources,OR);(!o||!o.intersects(this._displayExtent))&&(i=!1)}i&&(n.hasPoint()&&(this._hasPoint=!0),e._isCheck=!0,this._geosToDraw.push(e))}},t.prototype._collidesGeos=function(){var e=this.layer.options.collision;if(!e)return this;var n=this.layer.options.collisionScope,i=this.layer.getMap(),o=n==="map"?i.getCollisionIndex():Ib;o===Ib&&o.clear();var s=this._geosToDraw;this._geosToDraw=[];for(var a=0,l=s.length;a<l;a++)this._geoIsCollision(s[a],o)||this._geosToDraw.push(s[a]);return this},t.prototype.onZoomEnd=function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];delete this.canvasExtent2D,r.prototype.onZoomEnd.apply(this,e)},t.prototype.onRemove=function(){this.forEachGeo(function(e){e.onHide()}),delete this._geosToDraw,delete this.snapshotCanvas,delete this.pageGeos,delete this.geoPainterList},t.prototype.onGeometryPropertiesChange=function(e){e&&this.layer._styleGeometry(e.target),r.prototype.onGeometryPropertiesChange.call(this,e)},t.prototype._updateDisplayExtent=function(){var e=this.canvasExtent2D;if(this._maskExtent){if(!this._maskExtent.intersects(e)){this.completeRender();return}e=e.intersection(this._maskExtent)}this._displayExtent=e},t.prototype.identifyAtPoint=function(e,n){n===void 0&&(n={});var i=this.getGeosForIdentify();return i?this.layer._hitGeos(i,e,n):[]},t.prototype._updateMapStateCache=function(){var e=this.getMap(),n=e._pointToContainerPoint(this.middleWest)._add(0,-e.height/2),i=e.getResolution(),o=e.getPitch(),s=e.getBearing(),a=e.getGLScale(),l=e.getGLRes(),h=e.getContainerExtent(),u=e.get2DExtent(),c=e.get2DExtentAtRes(l);return this.mapStateCache={resolution:i,pitch:o,bearing:s,glScale:a,glRes:l,_2DExtent:u,glExtent:c,containerExtent:h,offset:n},this},t.prototype._batchConversionMarkers=function(e){if(this._onlyHasPoint=void 0,!this._constructorIsThis())return[];var n=[],i=[],o=[],s={},a=this.layer,l=a.options,h=a.getAltitude?a.getAltitude():0,u=a.isCanvasRender();this._onlyHasPoint=!0;for(var c=0,f=this._getCurrentNeedRenderGeos(),d=0,p=f.length;d<p;d++){var g=f[d];if(g.isPoint){var m=g._painter;m||(m=g._getPainter());var y=m.getRenderPoints(kR)[0][0],x=l.enableAltitude?g._getAltitude():h;s[x]===void 0&&(s[x]=m.getAltitude()),n[c]=y,o[c]=s[x],i[c]=g,c++}else this._onlyHasPoint=!1}if(c===0)return[];var v=this.getMap(),_=ch(n,"_pt");_=v._pointsAtResToContainerPoints(n,e,o,_);for(var w=v.getContainerExtent(),b=w.xmax,A=w.ymax,T=w.xmin,S=w.ymin,M={},d=0,p=i.length;d<p;d++){var g=i[d];if(g._cPoint=_[d],!g._cPoint){g._inCurrentView=!1;continue}var E=_[d],P=E.x,k=E.y;if(g._inCurrentView=P>=T&&k>=S&&P<=b&&k<=A||g.hasAltitude(),!g._inCurrentView){var O=g.getSymbolHash(),I=void 0;O?I=M[O]=M[O]||g._painter.getFixedExtent():I=g._painter.getFixedExtent(),Hm.set(I.xmin,I.ymin,I.xmax,I.ymax),Hm._add(_[d]),g._inCurrentView=Hm.intersects(w)}g._inCurrentView&&((!g.isVisible()||!u)&&(g._inCurrentView=!1),this._onlyHasPoint&&g._inCurrentView&&(this._hasPoint=!0,g._isCheck=!0,this._geosToDraw.push(g)))}return _},t.prototype._sortByDistanceToCamera=function(e){if(this.layer.options.sortByDistanceToCamera&&this._geosToDraw.length){var n=this.getMap(),i=n.distanceToPoint(1e3,0,n.getGLScale()).x,o=i/1e3,s="center";this._geosToDraw.sort(function(a,l){if(!a.isPoint||!l.isPoint)return 0;var h=a._painter,u=l._painter;if(!h||!u)return 0;var c=h.getRenderPoints(s)[0][0],f=u.getRenderPoints(s)[0][0],d=h.getAltitude()*o,p=u.getAltitude()*o;Qr(cf,c.x,c.y,d);var g=mm(cf,e);Qr(cf,f.x,f.y,p);var m=mm(cf,e);return m-g})}},t.prototype._constructorIsThis=function(){return this.constructor===t},t.prototype.isProgressiveRender=function(){var e=this.layer;if(!e)return!1;var n=e.options||{},i=n.progressiveRender,o=n.collision;return o?!1:i},t.prototype.getGeosForIdentify=function(){return this.isProgressiveRender()?this.pageGeos||[]:this._geosToDraw||[]},t.prototype.getGeoPainterList=function(){if(!this.isProgressiveRender()){for(var e=[],n=this._geosToDraw||[],i=0,o=n.length;i<o;i++)e.push(n[i]._painter);return e}return this.geoPainterList||[]},t.prototype._checkSnapshotCanvas=function(){if(!this.isProgressiveRender())return delete this.snapshotCanvas,null;var e=this.canvas;if(!e)return delete this.snapshotCanvas,null;this.snapshotCanvas||(this.snapshotCanvas=Mt.createCanvas(1,1));var n=this.snapshotCanvas,i=e.width,o=e.height,s=e.style;return(n.width!==i||n.height!==o)&&(n.width=i,n.height=o),(n.style.width!==s.width||n.style.height!==s.height)&&(n.style.width=s.width,n.style.height=s.height),n},t.prototype._getCurrentNeedRenderGeos=function(){var e=this.layer._geoList||[];if(!this.isProgressiveRender())return e;var n=this.layer,i=n.options.progressiveRenderCount,o=i,s=this.page,a=(s-1)*o,l=s*o,h=e.slice(a,l);return h},t.prototype._resetProgressiveRender=function(){Zh(this.layer)&&console.log("progressiveRender resetProgressiveRender"),this.renderEnd=!1,this.page=1,this.pageGeos=[],this.geoPainterList=[],this.maxTolerance=0,this._clearSnapshotCanvas()},t.prototype._clearSnapshotCanvas=function(){var e=this._checkSnapshotCanvas();e&&Rb(e)},t.prototype._snapshot=function(){for(var e=this.isProgressiveRender(),n=this._geosToDraw||[],i=0,o=n.length;i<o;i++){var s=n[i],a=s._hitTestTolerance()||0;if(this.maxTolerance=Math.max(this.maxTolerance,a),e){this.pageGeos.push(s);var l=s._painter;this.geoPainterList.push(l)}}if(!e)return this;var h=Qe(),u=this._checkSnapshotCanvas();if(u&&this.canvas){var c=Rb(u);c.drawImage(this.canvas,0,0)}var f=this.layer,d=f.options.progressiveRenderCount,p=f._geoList||[],g=Math.ceil(p.length/d);return this.renderEnd=this.page>=g,this.renderEnd&&this._setDrawGeosDrawTime(),Zh(this.layer)&&console.log("snapshot time:",Qe()-h+"ms"),this.renderEnd||this.page++,this},t.prototype._drawSnapshot=function(){if(!this.isProgressiveRender())return this;var e=this,n=e.snapshotCanvas,i=e.context;if(!n||!i)return this;var o=this.getMap();if(!o)return this;var s=o.getDevicePixelRatio()||1,a=1/s;return this._canvasContextScale(i,a),i.drawImage(n,0,0),this._canvasContextScale(i,s),this},t}(kb);ro.registerRenderer("canvas",Db);var Fb=function(r){Et(t,r);function t(e){var n=r.call(this)||this;return n.map=e,n._handlerQueue=[],n._thisDocVisibilitychange=n._onDocVisibilitychange.bind(n),n._thisDocDragStart=n._onDocDragStart.bind(n),n._thisDocDragEnd=n._onDocDragEnd.bind(n),n._thisDocDPRChange=n._onDocDPRChange.bind(n),n}return t.prototype.callInNextFrame=function(e){this._handlerQueue.push(e)},t.prototype.executeFrameCallbacks=function(){var e=this._handlerQueue;this._handlerQueue=[];for(var n=0,i=e.length;n<i;n++)e[n]()},t.prototype.offsetPlatform=function(e,n){if(!this.map.getPanels().front)return this;if(!n&&e.x===0&&e.y===0)return this;var i=this.map.getPanels(),o=this._frontCount=i.back.layerDOM.childElementCount,s=this._backCount=i.front.layerDOM.childElementCount,a=this._uiCount=i.front.uiDOM.childElementCount;if(o||s||a){var l=this.map.offsetPlatform();e?l=l.add(e)._round():l=l.round(),s&&wc(i.back,l),(o||a)&&wc(i.front,l)}return this},t.prototype.domChanged=function(){var e=this.map.getPanels();if(!e.front)return!1;var n=e.back.layerDOM.childElementCount;if(this._frontCount===void 0||this._frontCount!==n)return!0;var i=e.front.layerDOM.childElementCount;if(this._backCount===void 0||this._backCount!==i)return!0;var o=e.front.uiDOM.childElementCount;return this._uiCount===void 0||this._uiCount!==o},t.prototype.resetContainer=function(){if(this.map&&(this.map._resetMapViewPoint(),this.map.getPanels().front)){var e=new W(0,0);wc(this.map.getPanels().back,e),wc(this.map.getPanels().front,e)}},t.prototype.onZoomEnd=function(){this.resetContainer()},t.prototype.onLoad=function(){this._frameLoop()},t.prototype._onDocVisibilitychange=function(){document.visibilityState==="visible"&&this.setToRedraw()},t.prototype._getWrapPanel=function(){if(!this.map)return null;var e=this.map.getPanels();return e&&e.mapWrapper},t.prototype._onDocDragStart=function(){var e=this._getWrapPanel();e&&(e.style.overflow="visible")},t.prototype._onDocDragEnd=function(){var e=this._getWrapPanel();e&&(e.style.overflow="hidden")},t.prototype._onDocDPRChange=function(){var e=this.map;if(!(!e||!e.options||e.options.devicePixelRatio||!e.checkSize||!e.getRenderer)){var n=e.getRenderer();n&&e.checkSize(!0)}},t.prototype._containerIsOffscreen=function(){var e=this.map.getContainer();if(!e||!e.style||e.style.display==="none")return!0;var n=Math.min(e.clientWidth,e.clientHeight);return n<=0},t}(hi),IR=new Ph,Lb=function(r){Et(t,r);function t(e){var n=r.call(this,e)||this;return n._containerIsCanvas=!!e.getContainer().getContext,n._registerEvents(),n._loopTime=0,n._resizeEventList=[],n._resizeTime=-1/0,n._frameCycleRenderCount=0,n}return t.prototype.load=function(){this.initContainer()},t.prototype.renderFrame=function(e){var n=this.map;if(!n||!n.options.renderable)return!1;if(this._handleResizeEventList(e),n.options.stopRenderOnOffscreen&&this._containerIsOffscreen())return!0;this._updateDomPosition(e),delete this._isViewChanged,n._fireEvent("framestart"),this.updateMapDOM(),n.clearCollisionIndex();var i=this._getAllLayerToRender();this.drawLayers(i,e);var o=this.drawLayerCanvas(i);return o&&(this.drawTops(),this._drawCenterCross(),n.options.debugSky&&this._debugSky()),this._needClear=!1,n._fireEvent("frameend"),this._recordView(),this._mapview=this._getMapView(),delete this._spatialRefChanged,this._fireLayerLoadEvents(),this.executeFrameCallbacks(),this._canvasUpdated=!1,n.uiCollides(),!0},t.prototype.getFrameTimestamp=function(){return this._frameTimestamp||0},t.prototype.updateMapDOM=function(){var e=this.map;if(!e.isZooming()){var n=e.getViewPointFrameOffset();n?e.offsetPlatform(n):this.domChanged()&&this.offsetPlatform(null,!0)}},t.prototype._needRedrawAllLayers=function(e){var n=this;if(this.isSpatialReferenceChanged())return!0;var i=[];e.forEach(function(h){if(h){var u=h._toRedraw=n._checkLayerRedraw(h);if(u){i.push(h);var c=h.getLayers&&h.getLayers();c&&Array.isArray(c)&&ai(i,c)}}});for(var o=0,s=i.length;o<s;o++){var a=i[o],l=a&&a.options;if(l&&l.collision&&l.collisionScope==="map")return!0}return!1},t.prototype.drawLayers=function(e,n){for(var i=this._needRedrawAllLayers(e),o=this.map,s=o.isInteracting(),a=[],l=[],h=o.options.fpsOnInteracting||0,u=h===0?0:1e3/h,c=this.map.options.layerCanvasLimitOnInteracting,f=e.length,d=o.getBaseLayer(),p=0,g=0;g<f;g++){var m=e[g];if(m.isVisible()){var y=m.isCanvasRender();y&&a.push(m.getId());var x=m._getRenderer();if(x){var v=i||m._toRedraw;y&&x.isCanvasUpdated()&&(v||l.push(m.getId()),this.setLayerCanvasUpdated());var _=x.__zoomTransformMatrix;if(delete x.__zoomTransformMatrix,!v){y&&s&&(o.isZooming()&&!o.getPitch()?(x.prepareRender(),x.__zoomTransformMatrix=this._zoomMatrix):(o.getPitch()||o.isRotating())&&x.clearCanvas());continue}if(s&&y){if(c>0&&f-1-g>c&&m!==d){m._getRenderer().clearCanvas();continue}p+=this._drawCanvasLayerOnInteracting(m,p,u,n)}else s&&x.drawOnInteracting?(x.prepareRender&&x.prepareRender(),x.checkAndDraw?x.checkAndDraw(x.drawOnInteracting,this._eventParam,n):x.drawOnInteracting(this._eventParam,n)):(x.render(n),y&&_&&x.isLoadingResource()&&(x.__zoomTransformMatrix=_));y&&(l.push(m.getId()),this.setLayerCanvasUpdated())}}}var w=this._canvasIds||[],b=this._updatedIds||[];if(this._canvasIds=a,this._updatedIds=l,!this.isLayerCanvasUpdated()){var A="---";(w.join(A)!==a.join(A)||b.join(A)!==l.join(A))&&this.setLayerCanvasUpdated()}},t.prototype._checkLayerRedraw=function(e){if(this.isSpatialReferenceChanged())return!0;var n=this.map,i=e._getRenderer();return i?e.isCanvasRender()?i.testIfNeedRedraw():i.needToRedraw&&i.needToRedraw()?!0:n.isInteracting()||this.isViewChanged():!1},t.prototype._drawCanvasLayerOnInteracting=function(e,n,i,o){var s=this.map,a=e._getRenderer(),l=a.getDrawTime(),h=i===0||i>0&&n+l<=i;if(a.mustRenderOnInteracting&&a.mustRenderOnInteracting())a.render(o);else{if(a.drawOnInteracting&&(e===s.getBaseLayer()||h||s.isZooming()&&e.options.forceRenderOnZooming||s.isMoving()&&e.options.forceRenderOnMoving||s.isRotating()&&e.options.forceRenderOnRotating))return a.prepareRender(),a.prepareCanvas(),a.checkAndDraw?a.checkAndDraw(a.drawOnInteracting,this._eventParam,o):a.drawOnInteracting(this._eventParam,o),l;s.isZooming()&&!s.getPitch()&&!s.isRotating()?(a.prepareRender(),a.__zoomTransformMatrix=this._zoomMatrix):(s.getPitch()||s.isRotating())&&a.clearCanvas()}return a.drawOnInteracting&&!h&&a.onSkipDrawOnInteracting(this._eventParam,o),0},t.prototype._fireLayerLoadEvents=function(){if(this._updatedIds&&this._updatedIds.length>0){var e=this.map;this._updatedIds.reverse().forEach(function(n){var i=e.getLayer(n);if(i){var o=i._getRenderer();!o||!o.isRenderComplete()||i.fire("layerload")}})}},t.prototype.isLayerCanvasUpdated=function(){return this._canvasUpdated},t.prototype.setLayerCanvasUpdated=function(){this._canvasUpdated=!0},t.prototype.drawLayerCanvas=function(e){var n=this.map;if(!n||!this.isLayerCanvasUpdated()&&!this.isViewChanged()&&this._needClear===!1)return!1;this.canvas||this.createCanvas(),n._fireEvent("renderstart",{context:this.context}),this._updateCanvasSize()||this.clearCanvas();for(var i=n.isInteracting(),o=n.options.layerCanvasLimitOnInteracting,s=e.length,a,l=[],h=0;h<s;h++)if(!(!e[h].isVisible()||!e[h].isCanvasRender())){var u=e[h]._getRenderer();if(u){var c=this._getLayerImage(e[h]);c&&c.image&&(e[h]===n.getBaseLayer()?a=[e[h],c]:l.push([e[h],c]))}}var f=this.canvas.width,d=this.canvas.height;a&&(this._drawLayerCanvasImage(a[0],a[1],f,d),this._drawFog()),s=l.length;for(var p=i&&o>=0&&s>o?s-o:0,h=p;h<s;h++)this._drawLayerCanvasImage(l[h][0],l[h][1],f,d);return n._fireEvent("renderend",{context:this.context}),!0},t.prototype.setToRedraw=function(){var e=this._getAllLayerToRender();this._needClear=!0;for(var n=0,i=e.length;n<i;n++){var o=e[n].getRenderer();o&&o.canvas&&o.setToRedraw&&o.setToRedraw()}},t.prototype.updateMapSize=function(e){if(!(!e||this._containerIsCanvas)){var n=e.width+"px",i=e.height+"px",o=this.map.getPanels();o.mapWrapper.style.width=n,o.mapWrapper.style.height=i,this._updateCanvasSize()}},t.prototype.getMainPanel=function(){return this.map?this._containerIsCanvas?this.map.getContainer():this.map.getPanels()?this.map.getPanels().mapWrapper:null:null},t.prototype.toDataURL=function(e,n){return this.canvas?this.canvas.toDataURL(e,n):null},t.prototype.remove=function(){be.webgl&&typeof document<"u"&&(bi.off(Mg,this._thisDocDPRChange,this),bi.off(Sg,this._thisDocVisibilitychange,this),bi.off(Cg,this._thisDocDragStart,this),bi.off(Pg,this._thisDocDragEnd,this)),this._resizeInterval&&clearInterval(this._resizeInterval),this._resizeObserver&&this._resizeObserver.disconnect(),delete this.context,delete this.canvas,delete this.map,delete this._spatialRefChanged,this._cancelFrameLoop()},t.prototype.hitDetect=function(e){var n=this.map;if(!(!n||!n.options.hitDetect||n.isInteracting())){var i=n._getLayers(),o="default",s=n.options.hitDetectLimit||0,a=0;e&&e._round&&e._round();for(var l=i.length-1;l>=0;l--){var h=i[l];if(!(!h.options.hitDetect||h.isEmpty&&h.isEmpty()||!h.options.geometryEvents)){var u=h._getRenderer();if(!(!u||!u.hitDetect)&&!(u.isBlank&&u.isBlank())){if(h.options.cursor!=="default"&&u.hitDetect(e)){o=h.options.cursor||"pointer";break}if(a++,s>0&&a>s)break}}}n._trySetCursor(o)}},t.prototype._getLayerImage=function(e){var n=e._getRenderer();return n.getCanvasImage?n.getCanvasImage():null},t.prototype.initContainer=function(){var e=this.map.getPanels();function n(x,v,_,w){var b=de("div",v);return _&&(b.style.cssText=_),e[x]=b,w||b5(b),b}var i=this.map.getContainer();if(!this._containerIsCanvas){i.innerHTML="";var o="position:absolute;top:0px;left:0px;",s=n("mapWrapper","maptalks-wrapper","position:absolute;overflow:hidden;",!0),a=n("allLayers","maptalks-all-layers",o+"padding:0px;margin:0px;z-index:0;overflow:visible;",!0),l=n("backStatic","maptalks-back-static",o+"z-index:0;",!0),h=n("back","maptalks-back",o+"z-index:1;"),u=n("backLayer","maptalks-back-layer",o),c=n("canvasContainer","maptalks-canvas-layer",o+"border:none;z-index:2;"),f=n("frontStatic","maptalks-front-static",o+"z-index:3;",!0),d=n("front","maptalks-front",o+"z-index:4;",!0),p=n("frontLayer","maptalks-front-layer",o+"z-index:0;"),g=n("ui","maptalks-ui",o+"border:none;z-index:1;",!0),m=n("control","maptalks-control","z-index:1",!0);i.appendChild(s),a.appendChild(l),h.appendChild(u),h.layerDOM=u,a.appendChild(h),a.appendChild(c),d.appendChild(p),d.layerDOM=p,d.uiDOM=g,a.appendChild(f),a.appendChild(d),d.appendChild(g),s.appendChild(a),s.appendChild(m),this.createCanvas(),this.resetContainer();var y=this.map._getContainerDomSize();this.updateMapSize(y)}},t.prototype.isViewChanged=function(){if(this._isViewChanged!==void 0)return this._isViewChanged;var e=this._mapview,n=this._getMapView();return this._isViewChanged=!e||!gc(e,n),this._isViewChanged},t.prototype._recordView=function(){var e=this.map;!e._onViewChange||e.isInteracting()||e.isAnimating()||gc(e.getView(),e._getCurrentView())||e._onViewChange(e.getView())},t.prototype.isSpatialReferenceChanged=function(){return this._spatialRefChanged},t.prototype._getMapView=function(){var e=this.map,n=e._getPrjCenter();return{x:n.x,y:n.y,zoom:e.getZoom(),pitch:e.getPitch(),bearing:e.getBearing(),width:e.width,height:e.height}},t.prototype._lockFrameRenderEnable=function(){var e=(this.map.options||{}).maxFPS;if(e<=0||Li.maxFPS<=e)return!0;var n=Math.ceil(Li.maxFPS/e);return this._frameCycleRenderCount>=n},t.prototype._frameLoop=function(e){var n=this;if(!this.map){this._cancelFrameLoop();return}this._frameCycleRenderCount++,this._lockFrameRenderEnable()?(e=e||0,this._frameTimestamp=e,this._resizeCount=0,this.renderFrame(e),this._frameCycleRenderCount=0):this.map.options.debug&&console.log("skip frame ing,frameCycleRenderCount:",this._frameCycleRenderCount),this._animationFrame=_o(function(i){n._frameLoop(i)})},t.prototype._cancelFrameLoop=function(){this._animationFrame&&lh(this._animationFrame)},t.prototype._drawLayerCanvasImage=function(e,n,i,o){var s=this.context,a=n.point.round(),l=this.map.getDevicePixelRatio();l!==1&&a._multi(l);var h=n.image,u=h.width,c=h.height;if(!(a.x+u<=0||a.y+c<=0)){var f=e.options.opacity;if(It(f)||(f=1),!(f<=0)){var d=n.opacity;if(It(d)||(d=1),!(d<=0)){var p=s.globalAlpha;f<1&&(s.globalAlpha*=f),d<1&&(s.globalAlpha*=d),e.options.cssFilter&&(s.filter=e.options.cssFilter);var g=e.getRenderer(),m=g.__zoomTransformMatrix,y=g.clipCanvas(this.context);m&&(s.save(),s.setTransform.apply(s,Ee([],te(m),!1))),s.drawImage(h,0,0,u,c,a.x,a.y,i,o),m&&s.restore(),y&&s.restore(),s.filter!=="none"&&(s.filter="none"),s.globalAlpha=p}}}},t.prototype._drawCenterCross=function(){var e=this.map.options.centerCross;if(e){var n=this.context,i=new W(this.canvas.width/2,this.canvas.height/2);ze(e)?e(n,i):Mt.drawCross(this.context,i.x,i.y,2,"#f00")}},t.prototype._drawContainerExtent=function(){var e=this.map.options.cascadePitches,n=this.map.height-this.map._getVisualHeight(e[0]),i=this.map.height-this.map._getVisualHeight(e[1]),o=this.map.getContainerExtent(),s=this.context;s.beginPath(),s.moveTo(0,o.ymin),s.lineTo(o.xmax,o.ymin),s.stroke(),s.beginPath(),s.moveTo(0,n),s.lineTo(o.xmax,n),s.stroke(),s.beginPath(),s.moveTo(0,i),s.lineTo(o.xmax,i),s.stroke()},t.prototype._drawFog=function(){var e=this.map;if(!(e.getPitch()<=e.options.maxVisualPitch||!e.options.fog)){var n=30,i=e.getDevicePixelRatio(),o=this.context,s=e.getContainerExtent(),a=(e.height-e._getVisualHeight(75))*i;a<0&&(a=0);var l=s.ymin*i,h=Math.ceil(l-a),u=e.options.fogColor.join(),c=o.createLinearGradient(0,a,0,l+n),f=1-n/(h+n);c.addColorStop(0,"rgba(".concat(u,", 0)")),c.addColorStop(.3,"rgba(".concat(u,", 0.3)")),c.addColorStop(f,"rgba(".concat(u,", 1)")),c.addColorStop(1,"rgba(".concat(u,", 0)")),o.beginPath(),o.fillStyle=c,o.fillRect(0,a,Math.ceil(s.getWidth())*i,Math.ceil(h+n))}},t.prototype._debugSky=function(){var e=this.map;if(!e)return this;var n=e.getContainerExtent().ymin;if(n<=0)return this;var i=this.context;return i.strokeStyle="red",i.strokeRect(0,0,e.width,n),this},t.prototype._getAllLayerToRender=function(){return this.map._getLayers()},t.prototype.clearCanvas=function(){this.canvas&&Mt.clearRect(this.context,0,0,this.canvas.width,this.canvas.height)},t.prototype._updateCanvasSize=function(){if(!this.canvas||this._containerIsCanvas)return!1;var e=this.map,n=e.getSize(),i=this.canvas,o=e.getDevicePixelRatio(),s=Wp(n,o),a=s.width,l=s.height,h=s.cssWidth,u=s.cssHeight;return i.style&&(i.style.width!==h||i.style.height!==u)&&(i.style.width=h,i.style.height=u),a===i.width&&l===i.height?!1:(i.height=l,i.width=a,this.topLayer.width=i.width,this.topLayer.height=i.height,!0)},t.prototype.createCanvas=function(){this.topLayer=de("canvas"),this.topCtx=this.topLayer.getContext("2d"),this._containerIsCanvas?this.canvas=this.map.getContainer():(this.canvas=de("canvas"),this._updateCanvasSize(),this.map.getPanels().canvasContainer.appendChild(this.canvas)),this.context=this.canvas.getContext("2d")},t.prototype._updateDomPosition=function(e){this._checkPositionTime===void 0&&(this._checkPositionTime=-1/0);var n=Math.abs(e-this._checkPositionTime);return n>=500&&(Ac(this.map.getContainer()),this._checkPositionTime=Math.min(e,this._checkPositionTime)),this},t.prototype._handleResizeEventList=function(e){if(!this._resizeEventList)return this;var n=this._resizeEventList.length;if(n===0)return this;if(this._resizeTime&&e-this._resizeTime<60)return this;var i=this._resizeEventList[n-1].contentRect;return this.map.setContainerDomRect(i),this._resizeEventList=[],this._checkSize(),this._resizeCount=this._resizeCount||0,this.renderFrame((this._frameTimestamp||0)+ ++this._resizeCount/100),this._resizeTime=e,this},t.prototype._checkSize=function(){this.map&&this.map.checkSize()},t.prototype._setCheckSizeInterval=function(e){var n=this;be.resizeObserver?(this._resizeObserver&&this._resizeObserver.disconnect(),this.map&&(this._resizeObserver=new ResizeObserver(function(i){!n.map||n.map.isRemoved()?n._resizeObserver.disconnect():i.length&&(n._resizeEventList=n._resizeEventList||[],n._resizeEventList.push(i[0]))}),this._resizeObserver.observe(this.map.getContainer()))):(clearInterval(this._resizeInterval),this._checkSizeInterval=e,this._resizeInterval=setInterval(function(){!n.map||n.map.isRemoved()?clearInterval(n._resizeInterval):n._checkSize()},this._checkSizeInterval))},t.prototype._registerEvents=function(){var e=this,n=this.map;n.options.checkSize&&!Kn&&typeof window<"u"&&this._setCheckSizeInterval(n.options.checkSizeInterval),be.mobile||n.on("_mousemove",this._onMapMouseMove,this),n.on("_dragrotatestart _dragrotating _dragrotateend _movestart _moving _moveend _zoomstart",function(i){e._eventParam=i}),n.on("_zooming",function(i){n.getPitch()||(e._zoomMatrix=i.matrix.container),e._eventParam=i}),n.on("_zoomend",function(i){e._eventParam=i,delete e._zoomMatrix}),n.on("_spatialreferencechange",function(){e._spatialRefChanged=!0}),be.webgl&&typeof document<"u"&&(bi.on(Mg,this._thisDocDPRChange,this),bi.on(Sg,this._thisDocVisibilitychange,this),bi.on(Cg,this._thisDocDragStart,this),bi.on(Pg,this._thisDocDragEnd,this))},t.prototype._onMapMouseMove=function(e){var n=this,i=this.map;i.isInteracting()||!i.options.hitDetect||(this._hitDetectFrame&&lh(this._hitDetectFrame),this._hitDetectFrame=_o(function(){n.hitDetect(e.containerPoint)}))},t.prototype._getCanvasLayers=function(){return this.map._getLayers(function(e){return e.isCanvasRender()})},t.prototype.addTopElement=function(e){this._tops||(this._tops=[]),this._tops.push(e)},t.prototype.removeTopElement=function(e){if(this._tops){var n=this._tops.indexOf(e);n>=0&&this._tops.splice(n,1)}},t.prototype.getTopElements=function(){return this._tops||[]},t.prototype.sortTopElements=function(){this._tops=this._tops.sort(function(e,n){var i=e.options.zIndex||0,o=n.options.zIndex||0;return o-i})},t.prototype.drawTops=function(){this.topCtx.clearRect(0,0,this.topLayer.width,this.topLayer.height);var e=IR;e.clear(),this.map.fire("drawtopstart"),this.map.fire("drawtops");for(var n=this.getTopElements(),i=!1,o=this.map.getDevicePixelRatio(),s=[],a=0;a<n.length;a++){var l=n[a];if(l.needCollision&&l.needCollision()){var h=l.getRenderBBOX(o);if(h)if(e.collides(h)){var u=l.target&&l.target._geometry;u&&s.indexOf(u)===-1&&(s.push(u),u.fire("handlecollision"));continue}else e.insertBox(h)}l.render(this.topCtx)&&(i=!0)}i&&this.context.drawImage(this.topLayer,0,0),this.map.fire("drawtopsend")},t}(Fb);xe.registerRenderer("canvas",Lb),xe.mergeOptions({fog:!1,fogColor:[233,233,233]});var So=Object.freeze({__proto__:null,CanvasLayerRenderer:Im,CanvasRenderer:Oa,CanvasTileLayerCanvasRenderer:Eb,CanvasTileLayerGLRenderer:Ob,ImageGLRenderable:Em,ImageLayerCanvasRenderer:km,ImageLayerGLRenderer:xb,MapCanvasRenderer:Lb,MapRenderer:Fb,OverlayLayerCanvasRenderer:kb,QuadStencil:PR,Renderable:$g,ResourceCache:Ls,TileLayerCanvasRenderer:uf,TileLayerGLRenderer:zm,VectorLayerCanvasRenderer:Db}),ff={_getRenderPoints:function(){return[[this._getCenter2DPoint(this.getMap().getGLRes())],null]}};bn.include(ff),no.include(ff),Ti.include(ff),Vs.include(ff),js.include({_getRenderPoints:function(r){var t=this.getMap(),e=t.getGLRes();if(r==="vertex"){for(var n=this._trimRing(this.getShell()),i=[],o=0,s=n.length;o<s;o++)i.push(t.coordToPointAtRes(n[o],e));return[i,null]}else{var a=t.coordToPointAtRes(this.getCenter(),e);return[[a],null]}}});var zb={_getRenderPoints:function(r){var t=this.getMap(),e=t.getGLRes(),n,i=null;if(r==="point")n=this._getPath2DPoints(this._getPrjCoordinates(),!1,e),n&&n.length>0&&Array.isArray(n[0])&&(n=n[0].concat(n[1]));else if(r==="vertex")if(n=this._getPath2DPoints(this._getPrjCoordinates(),!1,e),i=[],n&&n.length>0&&Array.isArray(n[0])){for(var o=0,s=n.length;o<s;o++)for(var a=0,l=n[o].length;a<l;a++)a===0?i.push([n[o][a],n[o][a+1]]):i.push([n[o][a-1],n[o][a]]);n=n[0].concat(n[1])}else for(var o=0,s=n.length;o<s;o++)o===0?i.push([n[o],n[o+1]]):i.push([n[o-1],n[o]]);else if(r==="line"){n=[],i=[];var h=this._getPath2DPoints(this._getPrjCoordinates(),!1,e),u=h.length>0&&Array.isArray(h[0]);if(u)for(var c=void 0,o=1,s=h.length;o<s;o++){c=h[o],this instanceof _n&&c.length>0&&!c[0].equals(c[c.length-1])&&c.push(c[0]);for(var a=1,l=c.length;a<l;a++)n.push(c[a].add(c[a-1])._multi(.5)),i.push([c[a-1],c[a]])}else{this instanceof _n&&h.length>0&&!h[0].equals(h[h.length-1])&&h.push(h[0]);for(var o=1,s=h.length;o<s;o++)n.push(h[o].add(h[o-1])._multi(.5)),i.push([h[o-1],h[o]])}}else if(r==="vertex-first"){var f=this._getPrjCoordinates(),s=f.length,d=s?t._prjToPointAtRes(f[0],e):null;n=s?[d]:[],i=s?[[d,f[1]?t._prjToPointAtRes(f[1],e):d]]:[]}else if(r==="vertex-last"){var f=this._getPrjCoordinates(),s=f.length,p=s?t._prjToPointAtRes(f[s-1],e):null;n=s?[p]:[];var g=s>1?s-2:s-1;i=s?[[f[g]?t._prjToPointAtRes(f[g],e):p,p]]:[]}else{var m=this.getCenter();if(!m)n=[];else{var y=this._getProjection().project(m);n=[t._prjToPointAtRes(y,e)]}}return[n,i]}};Pn.include(zb),_n.include(zb);var Ua={within:!1,center:[0,0]};function Hb(r){if(!r||!r._containerBbox)Ua.within=!1;else{Ua.within=!1;var t=r._containerBbox,e=t.minx,n=t.miny,i=t.maxx,o=t.maxy,s=Math.abs(i-e),a=Math.abs(o-n);s<=1&&a<=1&&(Ua.within=!0,Ua.center[0]=(e+i)/2,Ua.center[1]=(n+o)/2),delete r._containerBbox}return Ua}var RR={_redrawWhenPitch:function(){return!1},_redrawWhenRotate:function(){return!1},_getRenderBBOX:function(r,t){return r.isHitTesting?null:(xh(Aa),_h(t,Aa),Aa)}};en.include(RR);function Nb(){var r=this._getPrjShell(),t=qo();_h(r,t);var e=te(t,4),n=e[0],i=e[1],o=e[2],s=e[3];return new gn(n,i,o,s)}function Bb(){var r=this._getPrjShell();if(!r||!Array.isArray(r))return[];var t=this._getProjection(),e=this.getCoordinates()||{};return r.map(function(n){var i=t.unproject(n);return i.z=e.z||0,i})}var Nm={_redrawWhenPitch:function(){return!0},_redrawWhenRotate:function(){return this instanceof no||this instanceof Vs},_computeRotatedPrjExtent:Nb,getRotatedShell:Bb,_paintAsPath:function(){if(this.isRotated())return!0;var r=this.getMap(),t=this._getAltitude();return t>0||r.getPitch()||this instanceof no&&r.getBearing()},_getPaintParams:function(){var r=this.getMap();if(this._paintAsPath())return _n.prototype._getPaintParams.call(this,!0);var t=this._getPrjCoordinates(),e=r._prjToPointAtRes(t,r.getGLRes()),n=this._getRenderSize(e);return Ee([e],te(n),!1)},_paintOn:function(){for(var r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];return this._paintAsPath()?Mt.polygon.apply(Mt,Ee([],te(r),!1)):Mt.ellipse.apply(Mt,Ee([],te(r),!1))},_getRenderSize:function(r){var t=this.getMap(),e=t.getGLRes(),n=this._getPrjExtent(),i=t._prjToPointAtRes(n.getMin(),e),o=t._prjToPointAtRes(n.getMax(),e);return[Math.abs(o.x-i.x)/2,Math.abs(o.y-r.y),Math.abs(r.y-i.y)]}};no.include(Nm),Ti.include(Nm);var DR={_getPaintParams:function(){var r=this.getMap(),t=this._getPrjShell(),e=this._getPath2DPoints(t,!1,r.getGLRes());return[e]},_paintOn:Mt.polygon,_computeRotatedPrjExtent:Nb,getRotatedShell:Bb};js.include(DR);var FR={_redrawWhenPitch:function(){return!0},_getPaintParams:function(){if(this._paintAsPath())return _n.prototype._getPaintParams.call(this,!0);var r=this.getMap(),t=r._prjToPointAtRes(this._getPrjCoordinates(),r.getGLRes()),e=this._getRenderSize(t),n=te(this._correctAngles(),2),i=n[0],o=n[1];return[t,e[0],[i,o]]},_paintOn:function(){for(var r=[],t=0;t<arguments.length;t++)r[t]=arguments[t];if(this._paintAsPath())return Mt.polygon.apply(Mt,Ee([],te(r),!1));var e=this.getMap().getBearing();return e&&(r[3]=r[3].slice(0),r[3][0]+=e,r[3][1]+=e),Mt.sector.apply(Mt,Ee([],te(r),!1))}};Vs.include(Nm,FR),Kc.include({_paintAsPath:function(){return!0}});var LR={arrowStyles:{classic:[3,4]},_getArrowShape:function(r,t,e,n,i){if(!r||!t||r.equals(t))return null;i||(i=0);var o=e*n[0],s=e*n[1]+i,a=o/2+i,l;t.nextCtrlPoint||t.prevCtrlPoint?t.prevCtrlPoint?l=t.sub(new W(t.prevCtrlPoint)):l=t.sub(new W(t.nextCtrlPoint)):l=t.sub(r),l._unit();var h=t.sub(l.multi(s));l._perp();var u=h.add(l.multi(a));l._multi(-1);var c=h.add(l.multi(a));return[u,t,c,u]},_getPaintParams:function(){var r=this._getPrjCoordinates(),t=this._getPath2DPoints(r,!1,this.getMap().getGLRes());return[t]},_paintOn:function(r,t,e,n,i){var o=Hb(this._painter);return o.within?Mt.pixelRect(r,o.center,e,n):this.options.smoothness?Mt.paintSmoothLine(r,t,e,this.options.smoothness,!1,this._animIdx,this._animTailRatio):Mt.path(r,t,e,null,i),this._paintArrow(r,t,e),this._getRenderBBOX(r,t)},_getArrowPlacement:function(){return this.options.arrowPlacement},_getArrowStyle:function(){var r=this.options.arrowStyle;return r?Array.isArray(r)?r:this.arrowStyles[r]:null},_getArrows:function(r,t,e){var n=this,i=this._getArrowStyle();if(!i||r.length<2)return[];for(var o=r.length>0&&Array.isArray(r[0]),s=o?r:[r],a=this._getArrowPlacement(),l=[],h,u,c=function(){if(h&&u){var y=n._getArrowShape(h,u,t,i,e);y&&l.push(y)}},f=s.length-1;f>=0;f--){var d=s[f],p=d.length,g=d[0],m=d[p-1];a==="vertex-first"?(h=g.arrowNextPoint||d[1],u=g):a==="vertex-last"&&(h=m.arrowPrePoint||d[p-2],u=m),c(),a==="vertex-firstlast"&&(h=g.arrowNextPoint||d[1],u=g,c(),h=m.arrowPrePoint||d[p-2],u=m,c()),a==="point"&&this._getArrowPoints(l,d,t,i,e)}return l},_getArrowPoints:function(r,t,e,n,i){for(var o=0,s=t.length-1;o<s;o++){var a=t[o],l=t[o+1],h=this._getArrowShape(l.arrowPrePoint||a,l,e,n,i);h&&r.push(h)}},_paintArrow:function(r,t,e){var n=this._getInternalSymbol().lineWidth;(!It(n)||n<3)&&(n=3);var i=this._getArrows(t,n);if(i.length){r.setLineDash&&r.setLineDash([]);for(var o=i.length-1;o>=0;o--)r.fillStyle=r.strokeStyle,Mt.polygon(r,i[o],e,e)}}};Pn.include(LR);var zR={_getPaintParams:function(r){var t=this.getMap().getGLRes(),e=this._getPrjShell(),n=this._getPath2DPoints(e,r,t),i=n.length>0&&Array.isArray(n[0]);i&&(n=[[n[0]],[n[1]]]);var o=this._getPrjHoles(),s=[];if(o&&o.length>0){for(var a=this._simplified,l=0;l<o.length;l++){var h=this._getPath2DPoints(o[l],r,t);Array.isArray(h)&&i?Array.isArray(h[0])?(n[0].push(h[0]),n[1].push(h[1])):n[0].push(h):s.push(h)}a&&(this._simplified=a)}return i||(n=[n],ai(n,s)),[n]},_paintOn:function(r,t,e,n,i){var o=Hb(this._painter);return o.within?Mt.pixelRect(r,o.center,e,n):Mt.polygon(r,t,e,n,i,this.options.smoothness),this._getRenderBBOX(r,t)}};_n.include(zR),xe.VERSION=X3;var jb={Actor:Rh},Vb=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Us(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var Gb={exports:{}};(function(r,t){(function(e,n){r.exports=n()})(Vb,function(){function e(C,V){this.id=Ne++,this.type=C,this.data=V}function n(C){if(C.length===0)return[];var V=C.charAt(0),J=C.charAt(C.length-1);if(1<C.length&&V===J&&(V==='"'||V==="'"))return['"'+C.substr(1,C.length-2).replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'];if(V=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(C))return n(C.substr(0,V.index)).concat(n(V[1])).concat(n(C.substr(V.index+V[0].length)));if(V=C.split("."),V.length===1)return['"'+C.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'];for(C=[],J=0;J<V.length;++J)C=C.concat(n(V[J]));return C}function i(C){return"["+n(C).join("][")+"]"}function o(C,V){if(typeof C=="function")return new e(0,C);if(typeof C=="number"||typeof C=="boolean")return new e(5,C);if(Array.isArray(C))return new e(6,C.map(function(J,mt){return o(J)}));if(C instanceof e)return C}function s(){var C={"":0},V=[""];return{id:function(J){var mt=C[J];return mt||(mt=C[J]=V.length,V.push(J),mt)},str:function(J){return V[J]}}}function a(C,V,J){function mt(){var Ot=window.innerWidth,Pt=window.innerHeight;C!==document.body&&(Pt=C.getBoundingClientRect(),Ot=Pt.right-Pt.left,Pt=Pt.bottom-Pt.top),ot.width=J*Ot,ot.height=J*Pt,Jt(ot.style,{width:Ot+"px",height:Pt+"px"})}var ot=document.createElement("canvas");Jt(ot.style,{border:0,margin:0,padding:0,top:0,left:0}),C.appendChild(ot),C===document.body&&(ot.style.position="absolute",Jt(C.style,{margin:0,padding:0}));var vt;return C!==document.body&&typeof ResizeObserver=="function"?(vt=new ResizeObserver(function(){setTimeout(mt)}),vt.observe(C)):window.addEventListener("resize",mt,!1),mt(),{canvas:ot,onDestroy:function(){vt?vt.disconnect():window.removeEventListener("resize",mt),C.removeChild(ot)}}}function l(C,V){function J(mt){try{return C.getContext(mt,V)}catch{return null}}return J("webgl")||J("experimental-webgl")||J("webgl-experimental")}function h(C){return typeof C=="string"?C.split():C}function u(C){return typeof C=="string"?document.querySelector(C):C}function c(C){var V=C||{},J,mt,ot,vt;C={};var Ot=[],Pt=[],Wt=typeof window>"u"?1:window.devicePixelRatio,St=!1,Bt=function(ht){},Q=function(){};if(typeof V=="string"?J=document.querySelector(V):typeof V=="object"&&(typeof V.nodeName=="string"&&typeof V.appendChild=="function"&&typeof V.getBoundingClientRect=="function"?J=V:typeof V.drawArrays=="function"||typeof V.drawElements=="function"?(vt=V,ot=vt.canvas):("gl"in V?vt=V.gl:"canvas"in V?ot=u(V.canvas):"container"in V&&(mt=u(V.container)),"attributes"in V&&(C=V.attributes),"extensions"in V&&(Ot=h(V.extensions)),"optionalExtensions"in V&&(Pt=h(V.optionalExtensions)),"onDone"in V&&(Bt=V.onDone),"profile"in V&&(St=!!V.profile),"pixelRatio"in V&&(Wt=+V.pixelRatio))),J&&(J.nodeName.toLowerCase()==="canvas"?ot=J:mt=J),!vt){if(!ot){if(J=a(mt||document.body,Bt,Wt),!J)return null;ot=J.canvas,Q=J.onDestroy}C.premultipliedAlpha===void 0&&(C.premultipliedAlpha=!0),vt=l(ot,C)}return vt?{gl:vt,canvas:ot,container:mt,extensions:Ot,optionalExtensions:Pt,pixelRatio:Wt,profile:St,onDone:Bt,onDestroy:Q}:(Q(),Bt("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}function f(C,V){function J(Ot){Ot=Ot.toLowerCase();var Pt;try{Pt=mt[Ot]=C.getExtension(Ot)}catch{}return!!Pt}for(var mt={},ot=0;ot<V.extensions.length;++ot){var vt=V.extensions[ot];if(!J(vt))return V.onDestroy(),V.onDone('"'+vt+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return V.optionalExtensions.forEach(J),{extensions:mt,restore:function(){Object.keys(mt).forEach(function(Ot){if(mt[Ot]&&!J(Ot))throw Error("(regl): error restoring extension "+Ot)})}}}function d(C,V){for(var J=Array(C),mt=0;mt<C;++mt)J[mt]=V(mt);return J}function p(C){var V,J;return V=(65535<C)<<4,C>>>=V,J=(255<C)<<3,C>>>=J,V|=J,J=(15<C)<<2,C>>>=J,V|=J,J=(3<C)<<1,V|J|C>>>J>>1}function g(){function C(mt){t:{for(var ot=16;268435456>=ot;ot*=16)if(mt<=ot){mt=ot;break t}mt=0}return ot=J[p(mt)>>2],0<ot.length?ot.pop():new ArrayBuffer(mt)}function V(mt){J[p(mt.byteLength)>>2].push(mt)}var J=d(8,function(){return[]});return{alloc:C,free:V,allocType:function(mt,ot){var vt=null;switch(mt){case 5120:vt=new Int8Array(C(ot),0,ot);break;case 5121:vt=new Uint8Array(C(ot),0,ot);break;case 5122:vt=new Int16Array(C(2*ot),0,ot);break;case 5123:vt=new Uint16Array(C(2*ot),0,ot);break;case 5124:vt=new Int32Array(C(4*ot),0,ot);break;case 5125:vt=new Uint32Array(C(4*ot),0,ot);break;case 5126:vt=new Float32Array(C(4*ot),0,ot);break;default:return null}return vt.length!==ot?vt.subarray(0,ot):vt},freeType:function(mt){V(mt.buffer)}}}function m(C){return!!C&&typeof C=="object"&&Array.isArray(C.shape)&&Array.isArray(C.stride)&&typeof C.offset=="number"&&C.shape.length===C.stride.length&&(Array.isArray(C.data)||Le(C.data))}function y(C,V,J,mt,ot,vt){for(var Ot=0;Ot<V;++Ot)for(var Pt=C[Ot],Wt=0;Wt<J;++Wt)for(var St=Pt[Wt],Bt=0;Bt<mt;++Bt)ot[vt++]=St[Bt]}function x(C,V,J,mt,ot){for(var vt=1,Ot=J+1;Ot<V.length;++Ot)vt*=V[Ot];var Pt=V[J];if(V.length-J===4){var Wt=V[J+1],St=V[J+2];for(V=V[J+3],Ot=0;Ot<Pt;++Ot)y(C[Ot],Wt,St,V,mt,ot),ot+=vt}else for(Ot=0;Ot<Pt;++Ot)x(C[Ot],V,J+1,mt,ot),ot+=vt}function v(C){return nr[Object.prototype.toString.call(C)]|0}function _(C,V){for(var J=0;J<V.length;++J)C[J]=V[J]}function w(C,V,J,mt,ot,vt,Ot){for(var Pt=0,Wt=0;Wt<J;++Wt)for(var St=0;St<mt;++St)C[Pt++]=V[ot*Wt+vt*St+Ot]}function b(C,V,J,mt){function ot(Q){this.id=Wt++,this.buffer=C.createBuffer(),this.type=Q,this.usage=35044,this.byteLength=0,this.dimension=1,this.dtype=5121,this.persistentData=null,J.profile&&(this.stats={size:0})}function vt(Q,ht,ct){Q.byteLength=ht.byteLength,C.bufferData(Q.type,ht,ct)}function Ot(Q,ht,ct,bt,ft,gt){if(Q.usage=ct,Array.isArray(ht)){if(Q.dtype=bt||5126,0<ht.length)if(Array.isArray(ht[0])){ft=we(ht);for(var Y=bt=1;Y<ft.length;++Y)bt*=ft[Y];Q.dimension=bt,ht=hn(ht,ft,Q.dtype),vt(Q,ht,ct),gt?Q.persistentData=ht:Re.freeType(ht)}else typeof ht[0]=="number"?(Q.dimension=ft,ft=Re.allocType(Q.dtype,ht.length),_(ft,ht),vt(Q,ft,ct),gt?Q.persistentData=ft:Re.freeType(ft)):Le(ht[0])&&(Q.dimension=ht[0].length,Q.dtype=bt||v(ht[0])||5126,ht=hn(ht,[ht.length,ht[0].length],Q.dtype),vt(Q,ht,ct),gt?Q.persistentData=ht:Re.freeType(ht))}else if(Le(ht))Q.dtype=bt||v(ht),Q.dimension=ft,vt(Q,ht,ct),gt&&(Q.persistentData=new Uint8Array(new Uint8Array(ht.buffer)));else if(m(ht)){ft=ht.shape;var dt=ht.stride,Y=ht.offset,_t=0,yt=0,ae=0,Ke=0;ft.length===1?(_t=ft[0],yt=1,ae=dt[0],Ke=0):ft.length===2&&(_t=ft[0],yt=ft[1],ae=dt[0],Ke=dt[1]),Q.dtype=bt||v(ht.data)||5126,Q.dimension=yt,ft=Re.allocType(Q.dtype,_t*yt),w(ft,ht.data,_t,yt,ae,Ke,Y),vt(Q,ft,ct),gt?Q.persistentData=ft:Re.freeType(ft)}else ht instanceof ArrayBuffer&&(Q.dtype=5121,Q.dimension=ft,vt(Q,ht,ct),gt&&(Q.persistentData=new Uint8Array(new Uint8Array(ht))))}function Pt(Q){V.bufferCount--,mt(Q),C.deleteBuffer(Q.buffer),Q.buffer=null,delete St[Q.id]}var Wt=0,St={};ot.prototype.bind=function(){C.bindBuffer(this.type,this.buffer)},ot.prototype.destroy=function(){Pt(this)};var Bt=[];return J.profile&&(V.getTotalBufferSize=function(){var Q=0;return Object.keys(St).forEach(function(ht){Q+=St[ht].stats.size}),Q}),{create:function(Q,ht,ct,bt){function ft(Y){var dt=35044,_t=null,yt=0,ae=0,Ke=gt&&gt.dimension||1;return Array.isArray(Y)||Le(Y)||m(Y)||Y instanceof ArrayBuffer?_t=Y:typeof Y=="number"?yt=Y|0:Y&&("data"in Y&&(_t=Y.data),"usage"in Y&&(dt=qn[Y.usage]),"type"in Y&&(ae=ln[Y.type]),"dimension"in Y&&(Ke=Y.dimension|0),"length"in Y&&(yt=Y.length|0)),gt.bind(),_t?Ot(gt,_t,dt,ae,Ke,bt):(yt&&C.bufferData(gt.type,yt,dt),gt.dtype=ae||5121,gt.usage=dt,gt.dimension=Ke,gt.byteLength=yt),J.profile&&(gt.stats.size=gt.byteLength*Ze[gt.dtype]),ft}V.bufferCount++;var gt=new ot(ht);return St[gt.id]=gt,ct||ft(Q),ft._reglType="buffer",ft._buffer=gt,ft.subdata=function(Y,dt){var _t=(dt||0)|0,yt;if(gt.bind(),Le(Y)||Y instanceof ArrayBuffer)C.bufferSubData(gt.type,_t,Y);else if(Array.isArray(Y)){if(0<Y.length)if(typeof Y[0]=="number"){var ae=Re.allocType(gt.dtype,Y.length);_(ae,Y),C.bufferSubData(gt.type,_t,ae),Re.freeType(ae)}else(Array.isArray(Y[0])||Le(Y[0]))&&(yt=we(Y),ae=hn(Y,yt,gt.dtype),C.bufferSubData(gt.type,_t,ae),Re.freeType(ae))}else if(m(Y)){yt=Y.shape;var Ke=Y.stride,vn=ae=0,$e=0,xt=0;yt.length===1?(ae=yt[0],vn=1,$e=Ke[0],xt=0):yt.length===2&&(ae=yt[0],vn=yt[1],$e=Ke[0],xt=Ke[1]),yt=Array.isArray(Y.data)?gt.dtype:v(Y.data),yt=Re.allocType(yt,ae*vn),w(yt,Y.data,ae,vn,$e,xt,Y.offset),C.bufferSubData(gt.type,_t,yt),Re.freeType(yt)}return ft},J.profile&&(ft.stats=gt.stats),ft.destroy=function(){Pt(gt)},ft},createStream:function(Q,ht){var ct=Bt.pop();return ct||(ct=new ot(Q)),ct.bind(),Ot(ct,ht,35040,0,1,!1),ct},destroyStream:function(Q){Bt.push(Q)},clear:function(){pn(St).forEach(Pt),Bt.forEach(Pt)},getBuffer:function(Q){return Q&&Q._buffer instanceof ot?Q._buffer:null},restore:function(){pn(St).forEach(function(Q){Q.buffer=C.createBuffer(),C.bindBuffer(Q.type,Q.buffer),C.bufferData(Q.type,Q.persistentData||Q.byteLength,Q.usage)})},_initBuffer:Ot}}function A(C,V,J,mt){function ot(Q){this.id=Wt++,Pt[this.id]=this,this.buffer=Q,this.primType=4,this.type=this.vertCount=0}function vt(Q,ht,ct,bt,ft,gt,Y){Q.buffer.bind();var dt;if(ht?((dt=Y)||Le(ht)&&(!m(ht)||Le(ht.data))||(dt=V.oes_element_index_uint?5125:5123),J._initBuffer(Q.buffer,ht,ct,dt,3)):(C.bufferData(34963,gt,ct),Q.buffer.dtype=dt||5121,Q.buffer.usage=ct,Q.buffer.dimension=3,Q.buffer.byteLength=gt),dt=Y,!Y){switch(Q.buffer.dtype){case 5121:case 5120:dt=5121;break;case 5123:case 5122:dt=5123;break;case 5125:case 5124:dt=5125}Q.buffer.dtype=dt}Q.type=dt,ht=ft,0>ht&&(ht=Q.buffer.byteLength,dt===5123?ht>>=1:dt===5125&&(ht>>=2)),Q.vertCount=ht,ht=bt,0>bt&&(ht=4,bt=Q.buffer.dimension,bt===1&&(ht=0),bt===2&&(ht=1),bt===3&&(ht=4)),Q.primType=ht}function Ot(Q){mt.elementsCount--,delete Pt[Q.id],Q.buffer.destroy(),Q.buffer=null}var Pt={},Wt=0,St={uint8:5121,uint16:5123};V.oes_element_index_uint&&(St.uint32=5125),ot.prototype.bind=function(){this.buffer.bind()};var Bt=[];return{create:function(Q,ht){function ct(gt){if(gt)if(typeof gt=="number")bt(gt),ft.primType=4,ft.vertCount=gt|0,ft.type=5121;else{var Y=null,dt=35044,_t=-1,yt=-1,ae=0,Ke=0;Array.isArray(gt)||Le(gt)||m(gt)?Y=gt:("data"in gt&&(Y=gt.data),"usage"in gt&&(dt=qn[gt.usage]),"primitive"in gt&&(_t=yn[gt.primitive]),"count"in gt&&(yt=gt.count|0),"type"in gt&&(Ke=St[gt.type]),"length"in gt?ae=gt.length|0:(ae=yt,Ke===5123||Ke===5122?ae*=2:(Ke===5125||Ke===5124)&&(ae*=4))),vt(ft,Y,dt,_t,yt,ae,Ke)}else bt(),ft.primType=4,ft.vertCount=0,ft.type=5121;return ct}var bt=J.create(null,34963,!0),ft=new ot(bt._buffer);return mt.elementsCount++,ct(Q),ct._reglType="elements",ct._elements=ft,ct.subdata=function(gt,Y){return bt.subdata(gt,Y),ct},ct.destroy=function(){Ot(ft)},ct},createStream:function(Q){var ht=Bt.pop();return ht||(ht=new ot(J.create(null,34963,!0,!1)._buffer)),vt(ht,Q,35040,-1,-1,0,0),ht},destroyStream:function(Q){Bt.push(Q)},getElements:function(Q){return typeof Q=="function"&&Q._elements instanceof ot?Q._elements:null},clear:function(){pn(Pt).forEach(Ot)}}}function T(C){for(var V=Re.allocType(5123,C.length),J=0;J<C.length;++J)if(isNaN(C[J]))V[J]=65535;else if(C[J]===1/0)V[J]=31744;else if(C[J]===-1/0)V[J]=64512;else{rn[0]=C[J];var vt=vr[0],mt=vt>>>31<<15,ot=(vt<<1>>>24)-127,vt=vt>>13&1023;V[J]=-24>ot?mt:-14>ot?mt+(vt+1024>>-14-ot):15<ot?mt+31744:mt+(ot+15<<10)+vt}return V}function S(C){return Array.isArray(C)||Le(C)}function M(C){return"[object "+C+"]"}function E(C){return Array.isArray(C)&&(C.length===0||typeof C[0]=="number")}function P(C){return!!(Array.isArray(C)&&C.length!==0&&S(C[0]))}function k(C){return Object.prototype.toString.call(C)}function O(C){if(!C)return!1;var V=k(C);return 0<=xr.indexOf(V)?!0:E(C)||P(C)||m(C)}function I(C,V){C.type===36193?(C.data=T(V),Re.freeType(V)):C.data=V}function D(C,V,J,mt,ot,vt){if(C=typeof Sn[C]<"u"?Sn[C]:Mn[C]*rr[V],vt&&(C*=6),ot){for(mt=0;1<=J;)mt+=C*J*J,J/=2;return mt}return C*J*mt}function z(C,V,J,mt,ot,vt,Ot){function Pt(){this.format=this.internalformat=6408,this.type=5121,this.flipY=this.premultiplyAlpha=this.compressed=!1,this.unpackAlignment=1,this.colorSpace=37444,this.channels=this.height=this.width=0}function Wt(F,pt){F.internalformat=pt.internalformat,F.format=pt.format,F.type=pt.type,F.compressed=pt.compressed,F.premultiplyAlpha=pt.premultiplyAlpha,F.flipY=pt.flipY,F.unpackAlignment=pt.unpackAlignment,F.colorSpace=pt.colorSpace,F.width=pt.width,F.height=pt.height,F.channels=pt.channels}function St(F,pt){if(typeof pt=="object"&&pt){"premultiplyAlpha"in pt&&(F.premultiplyAlpha=pt.premultiplyAlpha),"flipY"in pt&&(F.flipY=pt.flipY),"alignment"in pt&&(F.unpackAlignment=pt.alignment),"colorSpace"in pt&&(F.colorSpace=xn[pt.colorSpace]),"type"in pt&&(F.type=De[pt.type]);var X=F.width,kt=F.height,Lt=F.channels,Te=!1;"shape"in pt?(X=pt.shape[0],kt=pt.shape[1],pt.shape.length===3&&(Lt=pt.shape[2],Te=!0)):("radius"in pt&&(X=kt=pt.radius),"width"in pt&&(X=pt.width),"height"in pt&&(kt=pt.height),"channels"in pt&&(Lt=pt.channels,Te=!0)),F.width=X|0,F.height=kt|0,F.channels=Lt|0,X=!1,"format"in pt&&(X=pt.format,kt=F.internalformat=Xe[X],F.format=ve[kt],X in De&&!("type"in pt)&&(F.type=De[X]),X in ir&&(F.compressed=!0),X=!0),!Te&&X?F.channels=Mn[F.format]:Te&&!X&&F.channels!==Jn[F.format]&&(F.format=F.internalformat=Jn[F.channels])}}function Bt(F){C.pixelStorei(37440,F.flipY),C.pixelStorei(37441,F.premultiplyAlpha),C.pixelStorei(37443,F.colorSpace),C.pixelStorei(3317,F.unpackAlignment)}function Q(){Pt.call(this),this.yOffset=this.xOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function ht(F,pt){var X=null;if(O(pt)?X=pt:pt&&(St(F,pt),"x"in pt&&(F.xOffset=pt.x|0),"y"in pt&&(F.yOffset=pt.y|0),O(pt.data)&&(X=pt.data)),pt.copy){var kt=ot.viewportWidth,Lt=ot.viewportHeight;F.width=F.width||kt-F.xOffset,F.height=F.height||Lt-F.yOffset,F.needsCopy=!0}else if(!X)F.width=F.width||1,F.height=F.height||1,F.channels=F.channels||4;else if(Le(X))F.channels=F.channels||4,F.data=X,"type"in pt||F.type!==5121||(F.type=nr[Object.prototype.toString.call(X)]|0);else if(E(X)){switch(F.channels=F.channels||4,kt=X,Lt=kt.length,F.type){case 5121:case 5123:case 5125:case 5126:Lt=Re.allocType(F.type,Lt),Lt.set(kt),F.data=Lt;break;case 36193:F.data=T(kt)}F.alignment=1,F.needsFree=!0}else if(m(X)){kt=X.data,Array.isArray(kt)||F.type!==5121||(F.type=nr[Object.prototype.toString.call(kt)]|0);var Lt=X.shape,Te=X.stride,Kt,Yt,he,He;Lt.length===3?(he=Lt[2],He=Te[2]):He=he=1,Kt=Lt[0],Yt=Lt[1],Lt=Te[0],Te=Te[1],F.alignment=1,F.width=Kt,F.height=Yt,F.channels=he,F.format=F.internalformat=Jn[he],F.needsFree=!0,Kt=He,X=X.offset,he=F.width,He=F.height,Yt=F.channels;for(var R=Re.allocType(F.type===36193?5126:F.type,he*He*Yt),N=0,q=0;q<He;++q)for(var et=0;et<he;++et)for(var ut=0;ut<Yt;++ut)R[N++]=kt[Lt*et+Te*q+Kt*ut+X];I(F,R)}else if(k(X)===Dn||k(X)===Zr||k(X)===Xr)k(X)===Dn||k(X)===Zr?F.element=X:F.element=X.canvas,F.width=F.element.width,F.height=F.element.height,F.channels=4;else if(k(X)===Vn)F.element=X,F.width=X.width,F.height=X.height,F.channels=4;else if(k(X)===Yr)F.element=X,F.width=X.naturalWidth,F.height=X.naturalHeight,F.channels=4;else if(k(X)===Ji)F.element=X,F.width=X.videoWidth,F.height=X.videoHeight,F.channels=4;else if(P(X)){for(kt=F.width||X[0].length,Lt=F.height||X.length,Te=F.channels,Te=S(X[0][0])?Te||X[0][0].length:Te||1,Kt=Tn.shape(X),he=1,He=0;He<Kt.length;++He)he*=Kt[He];he=Re.allocType(F.type===36193?5126:F.type,he),Tn.flatten(X,Kt,"",he),I(F,he),F.alignment=1,F.width=kt,F.height=Lt,F.channels=Te,F.format=F.internalformat=Jn[Te],F.needsFree=!0}}function ct(F,pt,X,kt,Lt){var Te=F.element,Kt=F.data,Yt=F.internalformat,he=F.format,He=F.type,R=F.width,N=F.height;Bt(F),Te?C.texSubImage2D(pt,Lt,X,kt,he,He,Te):F.compressed?C.compressedTexSubImage2D(pt,Lt,X,kt,Yt,R,N,Kt):F.needsCopy?(mt(),C.copyTexSubImage2D(pt,Lt,X,kt,F.xOffset,F.yOffset,R,N)):C.texSubImage2D(pt,Lt,X,kt,R,N,he,He,Kt)}function bt(){return or.pop()||new Q}function ft(F){F.needsFree&&Re.freeType(F.data),Q.call(F),or.push(F)}function gt(){Pt.call(this),this.genMipmaps=!1,this.mipmapHint=4352,this.mipmask=0,this.images=Array(16)}function Y(F,pt,X){var kt=F.images[0]=bt();F.mipmask=1,kt.width=F.width=pt,kt.height=F.height=X,kt.channels=F.channels=4}function dt(F,pt){var X=null;if(O(pt))X=F.images[0]=bt(),Wt(X,F),ht(X,pt),F.mipmask=1;else if(St(F,pt),Array.isArray(pt.mipmap))for(var kt=pt.mipmap,Lt=0;Lt<kt.length;++Lt)X=F.images[Lt]=bt(),Wt(X,F),X.width>>=Lt,X.height>>=Lt,ht(X,kt[Lt]),F.mipmask|=1<<Lt;else X=F.images[0]=bt(),Wt(X,F),ht(X,pt),F.mipmask=1;Wt(F,F.images[0])}function _t(F,pt){for(var X=F.images,kt=0;kt<X.length&&X[kt];++kt){var Lt=X[kt],Te=pt,Kt=kt,Yt=Lt.element,he=Lt.data,He=Lt.internalformat,R=Lt.format,N=Lt.type,q=Lt.width,et=Lt.height;Bt(Lt),Yt?C.texImage2D(Te,Kt,R,R,N,Yt):Lt.compressed?C.compressedTexImage2D(Te,Kt,He,Math.max(1,q),Math.max(1,et),0,he):Lt.needsCopy?(mt(),C.copyTexImage2D(Te,Kt,R,Lt.xOffset,Lt.yOffset,q,et,0)):C.texImage2D(Te,Kt,R,q,et,0,R,N,he||null)}}function yt(){var F=Di.pop()||new gt;Pt.call(F);for(var pt=F.mipmask=0;16>pt;++pt)F.images[pt]=null;return F}function ae(F){for(var pt=F.images,X=0;X<pt.length;++X)pt[X]&&ft(pt[X]),pt[X]=null;Di.push(F)}function Ke(){this.magFilter=this.minFilter=9728,this.wrapT=this.wrapS=33071,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=4352}function vn(F,pt){"min"in pt&&(F.minFilter=Ue[pt.min],0<=ii.indexOf(F.minFilter)&&!("faces"in pt)&&(F.genMipmaps=!0)),"mag"in pt&&(F.magFilter=fe[pt.mag]);var X=F.wrapS,kt=F.wrapT;if("wrap"in pt){var Lt=pt.wrap;typeof Lt=="string"?X=kt=Be[Lt]:Array.isArray(Lt)&&(X=Be[Lt[0]],kt=Be[Lt[1]])}else"wrapS"in pt&&(X=Be[pt.wrapS]),"wrapT"in pt&&(kt=Be[pt.wrapT]);if(F.wrapS=X,F.wrapT=kt,"anisotropic"in pt&&(F.anisotropic=pt.anisotropic),"mipmap"in pt){switch(X=!1,typeof pt.mipmap){case"string":F.mipmapHint=me[pt.mipmap],X=F.genMipmaps=!0;break;case"boolean":X=F.genMipmaps=pt.mipmap;break;case"object":F.genMipmaps=!1,X=!0}!X||"min"in pt||(F.minFilter=9984)}}function $e(F,pt){C.texParameteri(pt,10241,F.minFilter),C.texParameteri(pt,10240,F.magFilter),C.texParameteri(pt,10242,F.wrapS),C.texParameteri(pt,10243,F.wrapT),V.ext_texture_filter_anisotropic&&C.texParameteri(pt,34046,F.anisotropic),F.genMipmaps&&(C.hint(33170,F.mipmapHint),C.generateMipmap(pt))}function xt(F){Pt.call(this),this.mipmask=0,this.internalformat=6408,this.id=_i++,this.refCount=1,this.target=F,this.texture=C.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new Ke,Ot.profile&&(this.stats={size:0})}function ye(F){C.activeTexture(33984),C.bindTexture(F.target,F.texture)}function ne(){var F=sr[0];F?C.bindTexture(F.target,F.texture):C.bindTexture(3553,null)}function Nt(F){var pt=F.texture,X=F.unit,kt=F.target;0<=X&&(C.activeTexture(33984+X),C.bindTexture(kt,null),sr[X]=null),C.deleteTexture(pt),F.texture=null,F.params=null,F.pixels=null,F.refCount=0,delete Fn[F.id],vt.textureCount--}var me={"don't care":4352,"dont care":4352,nice:4354,fast:4353},Be={repeat:10497,clamp:33071,mirror:33648},fe={nearest:9728,linear:9729},Ue=Jt({mipmap:9987,"nearest mipmap nearest":9984,"linear mipmap nearest":9985,"nearest mipmap linear":9986,"linear mipmap linear":9987},fe),xn={none:0,browser:37444},De={uint8:5121,rgba4:32819,rgb565:33635,"rgb5 a1":32820},Xe={alpha:6406,luminance:6409,"luminance alpha":6410,rgb:6407,rgba:6408,rgba4:32854,"rgb5 a1":32855,rgb565:36194},ir={};V.ext_srgb&&(Xe.srgb=35904,Xe.srgba=35906),V.oes_texture_float&&(De.float32=De.float=5126),V.oes_texture_half_float&&(De.float16=De["half float"]=36193),V.webgl_depth_texture&&(Jt(Xe,{depth:6402,"depth stencil":34041}),Jt(De,{uint16:5123,uint32:5125,"depth stencil":34042})),V.webgl_compressed_texture_s3tc&&Jt(ir,{"rgb s3tc dxt1":33776,"rgba s3tc dxt1":33777,"rgba s3tc dxt3":33778,"rgba s3tc dxt5":33779}),V.webgl_compressed_texture_atc&&Jt(ir,{"rgb atc":35986,"rgba atc explicit alpha":35987,"rgba atc interpolated alpha":34798}),V.webgl_compressed_texture_pvrtc&&Jt(ir,{"rgb pvrtc 4bppv1":35840,"rgb pvrtc 2bppv1":35841,"rgba pvrtc 4bppv1":35842,"rgba pvrtc 2bppv1":35843}),V.webgl_compressed_texture_etc1&&(ir["rgb etc1"]=36196);var Er=Array.prototype.slice.call(C.getParameter(34467));Object.keys(ir).forEach(function(F){var pt=ir[F];0<=Er.indexOf(pt)&&(Xe[F]=pt)});var Nr=Object.keys(Xe);J.textureFormats=Nr;var _r=[];Object.keys(Xe).forEach(function(F){_r[Xe[F]]=F});var si=[];Object.keys(De).forEach(function(F){si[De[F]]=F});var Ae=[];Object.keys(fe).forEach(function(F){Ae[fe[F]]=F});var je=[];Object.keys(Ue).forEach(function(F){je[Ue[F]]=F});var an=[];Object.keys(Be).forEach(function(F){an[Be[F]]=F});var ve=Nr.reduce(function(F,pt){var X=Xe[pt];return X===6409||X===6406||X===6409||X===6410||X===6402||X===34041||V.ext_srgb&&(X===35904||X===35906)?F[X]=X:X===32855||0<=pt.indexOf("rgba")?F[X]=6408:F[X]=6407,F},{}),or=[],Di=[],_i=0,Fn={},qr=J.maxTextureUnits,sr=Array(qr).map(function(){return null});return Jt(xt.prototype,{bind:function(){this.bindCount+=1;var F=this.unit;if(0>F){for(var pt=0;pt<qr;++pt){var X=sr[pt];if(X){if(0<X.bindCount)continue;X.unit=-1}sr[pt]=this,F=pt;break}Ot.profile&&vt.maxTextureUnits<F+1&&(vt.maxTextureUnits=F+1),this.unit=F,C.activeTexture(33984+F),C.bindTexture(this.target,this.texture)}return F},unbind:function(){--this.bindCount},decRef:function(){0>=--this.refCount&&Nt(this)}}),Ot.profile&&(vt.getTotalTextureSize=function(){var F=0;return Object.keys(Fn).forEach(function(pt){F+=Fn[pt].stats.size}),F}),{create2D:function(F,pt){function X(Lt,Te){var Kt=kt.texInfo;Ke.call(Kt);var Yt=yt();return typeof Lt=="number"?typeof Te=="number"?Y(Yt,Lt|0,Te|0):Y(Yt,Lt|0,Lt|0):Lt?(vn(Kt,Lt),dt(Yt,Lt)):Y(Yt,1,1),Kt.genMipmaps&&(Yt.mipmask=(Math.max(Yt.width,Yt.height)<<1)-1),kt.mipmask=Yt.mipmask,Wt(kt,Yt),kt.internalformat=Yt.internalformat,X.width=Yt.width,X.height=Yt.height,ye(kt),_t(Yt,3553),$e(Kt,3553),ne(),ae(Yt),Ot.profile&&(kt.stats.size=D(kt.internalformat,kt.type,Yt.width,Yt.height,Kt.genMipmaps,!1)),X.format=_r[kt.internalformat],X.type=si[kt.type],X.mag=Ae[Kt.magFilter],X.min=je[Kt.minFilter],X.wrapS=an[Kt.wrapS],X.wrapT=an[Kt.wrapT],X}var kt=new xt(3553);return Fn[kt.id]=kt,vt.textureCount++,X(F,pt),X.subimage=function(Lt,Te,Kt,Yt){Te|=0,Kt|=0,Yt|=0;var he=bt();return Wt(he,kt),he.width=0,he.height=0,ht(he,Lt),he.width=he.width||(kt.width>>Yt)-Te,he.height=he.height||(kt.height>>Yt)-Kt,ye(kt),ct(he,3553,Te,Kt,Yt),ne(),ft(he),X},X.resize=function(Lt,Te){var Kt=Lt|0,Yt=Te|0||Kt;if(Kt===kt.width&&Yt===kt.height)return X;X.width=kt.width=Kt,X.height=kt.height=Yt,ye(kt);for(var he=0;kt.mipmask>>he;++he){var He=Kt>>he,R=Yt>>he;if(!He||!R)break;C.texImage2D(3553,he,kt.format,He,R,0,kt.format,kt.type,null)}return ne(),Ot.profile&&(kt.stats.size=D(kt.internalformat,kt.type,Kt,Yt,!1,!1)),X},X._reglType="texture2d",X._texture=kt,Ot.profile&&(X.stats=kt.stats),X.destroy=function(){kt.decRef()},X},createCube:function(F,pt,X,kt,Lt,Te){function Kt(He,R,N,q,et,ut){var it,tt=Yt.texInfo;for(Ke.call(tt),it=0;6>it;++it)he[it]=yt();if(typeof He=="number"||!He)for(He=He|0||1,it=0;6>it;++it)Y(he[it],He,He);else if(typeof He=="object")if(R)dt(he[0],He),dt(he[1],R),dt(he[2],N),dt(he[3],q),dt(he[4],et),dt(he[5],ut);else if(vn(tt,He),St(Yt,He),"faces"in He)for(He=He.faces,it=0;6>it;++it)Wt(he[it],Yt),dt(he[it],He[it]);else for(it=0;6>it;++it)dt(he[it],He);for(Wt(Yt,he[0]),Yt.mipmask=tt.genMipmaps?(Math.max(he[0].width,he[0].height)<<1)-1:he[0].mipmask,Yt.internalformat=he[0].internalformat,Kt.width=he[0].width,Kt.height=he[0].height,ye(Yt),it=0;6>it;++it)_t(he[it],34069+it);for($e(tt,34067),ne(),Ot.profile&&(Yt.stats.size=D(Yt.internalformat,Yt.type,Kt.width,Kt.height,tt.genMipmaps,!0)),Kt.format=_r[Yt.internalformat],Kt.type=si[Yt.type],Kt.mag=Ae[tt.magFilter],Kt.min=je[tt.minFilter],Kt.wrapS=an[tt.wrapS],Kt.wrapT=an[tt.wrapT],it=0;6>it;++it)ae(he[it]);return Kt}var Yt=new xt(34067);Fn[Yt.id]=Yt,vt.cubeCount++;var he=Array(6);return Kt(F,pt,X,kt,Lt,Te),Kt.subimage=function(He,R,N,q,et){N|=0,q|=0,et|=0;var ut=bt();return Wt(ut,Yt),ut.width=0,ut.height=0,ht(ut,R),ut.width=ut.width||(Yt.width>>et)-N,ut.height=ut.height||(Yt.height>>et)-q,ye(Yt),ct(ut,34069+He,N,q,et),ne(),ft(ut),Kt},Kt.resize=function(He){if(He|=0,He!==Yt.width){Kt.width=Yt.width=He,Kt.height=Yt.height=He,ye(Yt);for(var R=0;6>R;++R)for(var N=0;Yt.mipmask>>N;++N)C.texImage2D(34069+R,N,Yt.format,He>>N,He>>N,0,Yt.format,Yt.type,null);return ne(),Ot.profile&&(Yt.stats.size=D(Yt.internalformat,Yt.type,Kt.width,Kt.height,!1,!0)),Kt}},Kt._reglType="textureCube",Kt._texture=Yt,Ot.profile&&(Kt.stats=Yt.stats),Kt.destroy=function(){Yt.decRef()},Kt},clear:function(){for(var F=0;F<qr;++F)C.activeTexture(33984+F),C.bindTexture(3553,null),sr[F]=null;pn(Fn).forEach(Nt),vt.cubeCount=0,vt.textureCount=0},getTexture:function(F){return null},restore:function(){for(var F=0;F<qr;++F){var pt=sr[F];pt&&(pt.bindCount=0,pt.unit=-1,sr[F]=null)}pn(Fn).forEach(function(X){X.texture=C.createTexture(),C.bindTexture(X.target,X.texture);for(var kt=0;32>kt;++kt)if(X.mipmask&1<<kt)if(X.target===3553)C.texImage2D(3553,kt,X.internalformat,X.width>>kt,X.height>>kt,0,X.internalformat,X.type,null);else for(var Lt=0;6>Lt;++Lt)C.texImage2D(34069+Lt,kt,X.internalformat,X.width>>kt,X.height>>kt,0,X.internalformat,X.type,null);$e(X.texInfo,X.target)})},refresh:function(){for(var F=0;F<qr;++F){var pt=sr[F];pt&&(pt.bindCount=0,pt.unit=-1,sr[F]=null),C.activeTexture(33984+F),C.bindTexture(3553,null),C.bindTexture(34067,null)}}}}function L(C,V,J,mt,ot,vt){function Ot(xt,ye,ne){this.target=xt,this.texture=ye,this.renderbuffer=ne;var Nt=xt=0;ye?(xt=ye.width,Nt=ye.height):ne&&(xt=ne.width,Nt=ne.height),this.width=xt,this.height=Nt}function Pt(xt){xt&&(xt.texture&&xt.texture._texture.decRef(),xt.renderbuffer&&xt.renderbuffer._renderbuffer.decRef())}function Wt(xt,ye,ne){xt&&(xt.texture?xt.texture._texture.refCount+=1:xt.renderbuffer._renderbuffer.refCount+=1)}function St(xt,ye){ye&&(ye.texture?C.framebufferTexture2D(36160,xt,ye.target,ye.texture._texture.texture,0):C.framebufferRenderbuffer(36160,xt,36161,ye.renderbuffer._renderbuffer.renderbuffer))}function Bt(xt){var ye=3553,ne=null,Nt=null,me=xt;return typeof xt=="object"&&(me=xt.data,"target"in xt&&(ye=xt.target|0)),xt=me._reglType,xt==="texture2d"||xt==="textureCube"?ne=me:xt==="renderbuffer"&&(Nt=me,ye=36161),new Ot(ye,ne,Nt)}function Q(xt,ye,ne,Nt,me){return ne?(xt=mt.create2D({width:xt,height:ye,format:Nt,type:me}),xt._texture.refCount=0,new Ot(3553,xt,null)):(xt=ot.create({width:xt,height:ye,format:Nt}),xt._renderbuffer.refCount=0,new Ot(36161,null,xt))}function ht(xt){return xt&&(xt.texture||xt.renderbuffer)}function ct(xt,ye,ne){xt&&(xt.texture?xt.texture.resize(ye,ne):xt.renderbuffer&&xt.renderbuffer.resize(ye,ne),xt.width=ye,xt.height=ne)}function bt(){this.id=vn++,$e[this.id]=this,this.framebuffer=C.createFramebuffer(),this.height=this.width=0,this.colorAttachments=[],this.depthStencilAttachment=this.stencilAttachment=this.depthAttachment=null}function ft(xt){xt.colorAttachments.forEach(Pt),Pt(xt.depthAttachment),Pt(xt.stencilAttachment),Pt(xt.depthStencilAttachment)}function gt(xt){C.deleteFramebuffer(xt.framebuffer),xt.framebuffer=null,vt.framebufferCount--,delete $e[xt.id]}function Y(xt,ye){var ne;C.bindFramebuffer(36160,xt.framebuffer);var Nt=xt.colorAttachments;for(ne=0;ne<Nt.length;++ne)St(36064+ne,Nt[ne]);for(ne=Nt.length;ne<J.maxColorAttachments;++ne)C.framebufferTexture2D(36160,36064+ne,3553,null,0);C.framebufferTexture2D(36160,33306,3553,null,0),C.framebufferTexture2D(36160,36096,3553,null,0),C.framebufferTexture2D(36160,36128,3553,null,0),St(36096,xt.depthAttachment),St(36128,xt.stencilAttachment),St(33306,xt.depthStencilAttachment),ye||(C.checkFramebufferStatus(36160),C.isContextLost()),C.bindFramebuffer(36160,_t.next?_t.next.framebuffer:null),_t.cur=_t.next,ye||C.getError()}function dt(xt,ye){function ne(me,Be){var fe,Ue=0,xn=0,De=!0,Xe=!0;fe=null;var ir=!0,Er="rgba",Nr="uint8",_r=1,si=null,Ae=null,je=null,an=!1;if(typeof me=="number")Ue=me|0,xn=Be|0||Ue;else if(me){var ve=me;"shape"in ve?(xn=ve.shape,Ue=xn[0],xn=xn[1]):("radius"in ve&&(Ue=xn=ve.radius),"width"in ve&&(Ue=ve.width),"height"in ve&&(xn=ve.height)),("color"in ve||"colors"in ve)&&(fe=ve.color||ve.colors),fe||("colorCount"in ve&&(_r=ve.colorCount|0),"colorTexture"in ve&&(ir=!!ve.colorTexture,Er="rgba4"),"colorType"in ve&&(Nr=ve.colorType,!ir)&&(Nr==="half float"||Nr==="float16"?Er="rgba16f":(Nr==="float"||Nr==="float32")&&(Er="rgba32f")),"colorFormat"in ve&&(Er=ve.colorFormat,0<=yt.indexOf(Er)?ir=!0:0<=ae.indexOf(Er)&&(ir=!1))),("depthTexture"in ve||"depthStencilTexture"in ve)&&(an=!(!ve.depthTexture&&!ve.depthStencilTexture)),"depth"in ve&&(typeof ve.depth=="boolean"?De=ve.depth:(si=ve.depth,Xe=!1)),"stencil"in ve&&(typeof ve.stencil=="boolean"?Xe=ve.stencil:(Ae=ve.stencil,De=!1)),"depthStencil"in ve&&(typeof ve.depthStencil=="boolean"?De=Xe=ve.depthStencil:(je=ve.depthStencil,Xe=De=!1))}else Ue=xn=1;var or=null,Di=null,_i=null,Fn=null;if(Array.isArray(fe))or=fe.map(Bt);else if(fe)or=[Bt(fe)];else for(or=Array(_r),fe=0;fe<_r;++fe)or[fe]=Q(Ue,xn,ir,Er,Nr);for(Ue=Ue||or[0].width,xn=xn||or[0].height,si?Di=Bt(si):De&&!Xe&&(Di=Q(Ue,xn,an,"depth","uint32")),Ae?_i=Bt(Ae):Xe&&!De&&(_i=Q(Ue,xn,!1,"stencil","uint8")),je?Fn=Bt(je):!si&&!Ae&&Xe&&De&&(Fn=Q(Ue,xn,an,"depth stencil","depth stencil")),De=null,fe=0;fe<or.length;++fe)Wt(or[fe]),or[fe]&&or[fe].texture&&(Xe=Zo[or[fe].texture._texture.format]*vo[or[fe].texture._texture.type],De===null&&(De=Xe));return Wt(Di),Wt(_i),Wt(Fn),ft(Nt),Nt.width=Ue,Nt.height=xn,Nt.colorAttachments=or,Nt.depthAttachment=Di,Nt.stencilAttachment=_i,Nt.depthStencilAttachment=Fn,ne.color=or.map(ht),ne.depth=ht(Di),ne.stencil=ht(_i),ne.depthStencil=ht(Fn),ne.width=Nt.width,ne.height=Nt.height,Y(Nt,ve&&ve.ignoreStatusCheck),ne}var Nt=new bt;return vt.framebufferCount++,ne(xt,ye),Jt(ne,{resize:function(me,Be){var fe=Math.max(me|0,1),Ue=Math.max(Be|0||fe,1);if(fe===Nt.width&&Ue===Nt.height)return ne;for(var xn=Nt.colorAttachments,De=0;De<xn.length;++De)ct(xn[De],fe,Ue);return ct(Nt.depthAttachment,fe,Ue),ct(Nt.stencilAttachment,fe,Ue),ct(Nt.depthStencilAttachment,fe,Ue),Nt.width=ne.width=fe,Nt.height=ne.height=Ue,Y(Nt),ne},blit:function(me,Be,fe){C.bindFramebuffer(36008,me._framebuffer.framebuffer),C.bindFramebuffer(36009,Nt.framebuffer),Be||(Be=16384),C.blitFramebuffer(0,0,me.width,me.height,0,0,Nt.width,Nt.height,Be,fe==="linear"?9729:9728),C.bindFramebuffer(36008,null),C.bindFramebuffer(36009,null)},_reglType:"framebuffer",_framebuffer:Nt,destroy:function(){gt(Nt),ft(Nt)},use:function(me){_t.setFBO({framebuffer:ne},me)}})}var _t={cur:null,next:null,dirty:!1,setFBO:null},yt=["rgba"],ae=["rgba4","rgb565","rgb5 a1"];V.ext_srgb&&ae.push("srgba"),V.ext_color_buffer_half_float&&ae.push("rgba16f","rgb16f"),V.webgl_color_buffer_float&&ae.push("rgba32f");var Ke=["uint8"];V.oes_texture_half_float&&Ke.push("half float","float16"),V.oes_texture_float&&Ke.push("float","float32");var vn=0,$e={};return Jt(_t,{getFramebuffer:function(xt){return typeof xt=="function"&&xt._reglType==="framebuffer"&&(xt=xt._framebuffer,xt instanceof bt)?xt:null},create:dt,createCube:function(xt){function ye(Nt){var me,Be={color:null},fe=0,Ue=null;me="rgba";var xn="uint8",De=1;if(typeof Nt=="number"?fe=Nt|0:Nt?("shape"in Nt?fe=Nt.shape[0]:("radius"in Nt&&(fe=Nt.radius|0),"width"in Nt?fe=Nt.width|0:"height"in Nt&&(fe=Nt.height|0)),("color"in Nt||"colors"in Nt)&&(Ue=Nt.color||Nt.colors),Ue||("colorCount"in Nt&&(De=Nt.colorCount|0),"colorType"in Nt&&(xn=Nt.colorType),"colorFormat"in Nt&&(me=Nt.colorFormat)),"depth"in Nt&&(Be.depth=Nt.depth),"stencil"in Nt&&(Be.stencil=Nt.stencil),"depthStencil"in Nt&&(Be.depthStencil=Nt.depthStencil)):fe=1,Ue)if(Array.isArray(Ue))for(Nt=[],me=0;me<Ue.length;++me)Nt[me]=Ue[me];else Nt=[Ue];else for(Nt=Array(De),Ue={radius:fe,format:me,type:xn},me=0;me<De;++me)Nt[me]=mt.createCube(Ue);for(Be.color=Array(Nt.length),me=0;me<Nt.length;++me)De=Nt[me],fe=fe||De.width,Be.color[me]={target:34069,data:Nt[me]};for(me=0;6>me;++me){for(De=0;De<Nt.length;++De)Be.color[De].target=34069+me;0<me&&(Be.depth=ne[0].depth,Be.stencil=ne[0].stencil,Be.depthStencil=ne[0].depthStencil),ne[me]?ne[me](Be):ne[me]=dt(Be)}return Jt(ye,{width:fe,height:fe,color:Nt})}var ne=Array(6);return ye(xt),Jt(ye,{faces:ne,resize:function(Nt){var me=Nt|0;if(me===ye.width)return ye;var Be=ye.color;for(Nt=0;Nt<Be.length;++Nt)Be[Nt].resize(me);for(Nt=0;6>Nt;++Nt)ne[Nt].resize(me);return ye.width=ye.height=me,ye},_reglType:"framebufferCube",destroy:function(){ne.forEach(function(Nt){Nt.destroy()})}})},clear:function(){pn($e).forEach(gt)},restore:function(){_t.cur=null,_t.next=null,_t.dirty=!0,pn($e).forEach(function(xt){xt.framebuffer=C.createFramebuffer(),Y(xt)})}})}function $(){this.w=this.z=this.y=this.x=this.state=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=5126,this.divisor=this.stride=this.offset=0}function Z(C,V,J,mt,ot,vt,Ot){function Pt(Y){if(Y!==gt.currentVAO){var dt=V.oes_vertex_array_object;Y?dt.bindVertexArrayOES(Y.vao):dt.bindVertexArrayOES(null),gt.currentVAO=Y}}function Wt(Y){if(Y!==gt.currentVAO){if(Y)Y.bindAttrs();else{for(var dt=V.angle_instanced_arrays,_t=0;_t<ct.length;++_t){var yt=ct[_t];yt.buffer?(C.enableVertexAttribArray(_t),yt.buffer.bind(),C.vertexAttribPointer(_t,yt.size,yt.type,yt.normalized,yt.stride,yt.offfset),dt&&yt.divisor&&dt.vertexAttribDivisorANGLE(_t,yt.divisor)):(C.disableVertexAttribArray(_t),C.vertexAttrib4f(_t,yt.x,yt.y,yt.z,yt.w))}Ot.elements?C.bindBuffer(34963,Ot.elements.buffer.buffer):C.bindBuffer(34963,null)}gt.currentVAO=Y}}function St(){pn(ft).forEach(function(Y){Y.destroy()})}function Bt(){this.id=++bt,this.attributes=[],this.elements=null,this.ownsElements=!1,this.offset=this.count=0,this.instances=-1,this.primitive=4;var Y=V.oes_vertex_array_object;this.vao=Y?Y.createVertexArrayOES():null,ft[this.id]=this,this.buffers=[]}function Q(){V.oes_vertex_array_object&&pn(ft).forEach(function(Y){Y.refresh()})}var ht=J.maxAttributes,ct=Array(ht);for(J=0;J<ht;++J)ct[J]=new $;var bt=0,ft={},gt={Record:$,scope:{},state:ct,currentVAO:null,targetVAO:null,restore:V.oes_vertex_array_object?Q:function(){},createVAO:function(Y){function dt(yt){var ae;Array.isArray(yt)?(ae=yt,_t.elements&&_t.ownsElements&&_t.elements.destroy(),_t.elements=null,_t.ownsElements=!1,_t.offset=0,_t.count=0,_t.instances=-1,_t.primitive=4):(yt.elements?(ae=yt.elements,_t.ownsElements?(typeof ae=="function"&&ae._reglType==="elements"?_t.elements.destroy():_t.elements(ae),_t.ownsElements=!1):vt.getElements(yt.elements)?(_t.elements=yt.elements,_t.ownsElements=!1):(_t.elements=vt.create(yt.elements),_t.ownsElements=!0)):(_t.elements=null,_t.ownsElements=!1),ae=yt.attributes,_t.offset=0,_t.count=-1,_t.instances=-1,_t.primitive=4,_t.elements&&(_t.count=_t.elements._elements.vertCount,_t.primitive=_t.elements._elements.primType),"offset"in yt&&(_t.offset=yt.offset|0),"count"in yt&&(_t.count=yt.count|0),"instances"in yt&&(_t.instances=yt.instances|0),"primitive"in yt&&(_t.primitive=yn[yt.primitive])),yt={};var Ke=_t.attributes;Ke.length=ae.length;for(var vn=0;vn<ae.length;++vn){var $e=ae[vn],xt=Ke[vn]=new $,ye=$e.data||$e;if(Array.isArray(ye)||Le(ye)||m(ye)){var ne;_t.buffers[vn]&&(ne=_t.buffers[vn],Le(ye)&&ne._buffer.byteLength>=ye.byteLength?ne.subdata(ye):(ne.destroy(),_t.buffers[vn]=null)),_t.buffers[vn]||(ne=_t.buffers[vn]=ot.create($e,34962,!1,!0)),xt.buffer=ot.getBuffer(ne),xt.size=xt.buffer.dimension|0,xt.normalized=!1,xt.type=xt.buffer.dtype,xt.offset=0,xt.stride=0,xt.divisor=0,xt.state=1,yt[vn]=1}else ot.getBuffer($e)?(xt.buffer=ot.getBuffer($e),xt.size=xt.buffer.dimension|0,xt.normalized=!1,xt.type=xt.buffer.dtype,xt.offset=0,xt.stride=0,xt.divisor=0,xt.state=1):ot.getBuffer($e.buffer)?(xt.buffer=ot.getBuffer($e.buffer),xt.size=(+$e.size||xt.buffer.dimension)|0,xt.normalized=!!$e.normalized||!1,xt.type="type"in $e?ln[$e.type]:xt.buffer.dtype,xt.offset=($e.offset||0)|0,xt.stride=($e.stride||0)|0,xt.divisor=($e.divisor||0)|0,xt.state=1):"x"in $e&&(xt.x=+$e.x||0,xt.y=+$e.y||0,xt.z=+$e.z||0,xt.w=+$e.w||0,xt.state=2)}for(ne=0;ne<_t.buffers.length;++ne)!yt[ne]&&_t.buffers[ne]&&(_t.buffers[ne].destroy(),_t.buffers[ne]=null);return _t.refresh(),dt}var _t=new Bt;return mt.vaoCount+=1,dt.destroy=function(){for(var yt=0;yt<_t.buffers.length;++yt)_t.buffers[yt]&&_t.buffers[yt].destroy();_t.buffers.length=0,_t.ownsElements&&(_t.elements.destroy(),_t.elements=null,_t.ownsElements=!1),_t.destroy()},dt._vao=_t,dt._reglType="vao",dt(Y)},getVAO:function(Y){return typeof Y=="function"&&Y._vao?Y._vao:null},destroyBuffer:function(Y){for(var dt=0;dt<ct.length;++dt){var _t=ct[dt];_t.buffer===Y&&(C.disableVertexAttribArray(dt),_t.buffer=null)}},setVAO:V.oes_vertex_array_object?Pt:Wt,clear:V.oes_vertex_array_object?St:function(){}};return Bt.prototype.bindAttrs=function(){for(var Y=V.angle_instanced_arrays,dt=this.attributes,_t=0;_t<dt.length;++_t){var yt=dt[_t];yt.buffer?(C.enableVertexAttribArray(_t),C.bindBuffer(34962,yt.buffer.buffer),C.vertexAttribPointer(_t,yt.size,yt.type,yt.normalized,yt.stride,yt.offset),Y&&yt.divisor&&Y.vertexAttribDivisorANGLE(_t,yt.divisor)):(C.disableVertexAttribArray(_t),C.vertexAttrib4f(_t,yt.x,yt.y,yt.z,yt.w))}for(Y=dt.length;Y<ht;++Y)C.disableVertexAttribArray(Y);(Y=vt.getElements(this.elements))?C.bindBuffer(34963,Y.buffer.buffer):C.bindBuffer(34963,null)},Bt.prototype.refresh=function(){var Y=V.oes_vertex_array_object;Y&&(Y.bindVertexArrayOES(this.vao),this.bindAttrs(),gt.currentVAO=null,Y.bindVertexArrayOES(null))},Bt.prototype.destroy=function(){if(this.vao){var Y=V.oes_vertex_array_object;this===gt.currentVAO&&(gt.currentVAO=null,Y.bindVertexArrayOES(null)),Y.deleteVertexArrayOES(this.vao),this.vao=null}this.ownsElements&&(this.elements.destroy(),this.elements=null,this.ownsElements=!1),ft[this.id]&&(delete ft[this.id],--mt.vaoCount)},gt}function j(C,V,J,mt){function ot(bt,ft,gt,Y){this.name=bt,this.id=ft,this.location=gt,this.info=Y}function vt(bt,ft){for(var gt=0;gt<bt.length;++gt)if(bt[gt].id===ft.id){bt[gt].location=ft.location;return}bt.push(ft)}function Ot(bt,ft,gt){gt=bt===35632?St:Bt;var Y=gt[ft];if(!Y){var dt=V.str(ft),Y=C.createShader(bt);C.shaderSource(Y,dt),C.compileShader(Y),gt[ft]=Y}return Y}function Pt(bt,ft){this.id=ct++,this.fragId=bt,this.vertId=ft,this.program=null,this.uniforms=[],this.attributes=[],this.refCount=1,mt.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function Wt(bt,ft,gt){var Y;Y=Ot(35632,bt.fragId);var dt=Ot(35633,bt.vertId);if(ft=bt.program=C.createProgram(),C.attachShader(ft,Y),C.attachShader(ft,dt),gt)for(Y=0;Y<gt.length;++Y)dt=gt[Y],C.bindAttribLocation(ft,dt[0],dt[1]);C.linkProgram(ft),dt=C.getProgramParameter(ft,35718),mt.profile&&(bt.stats.uniformsCount=dt);var _t=bt.uniforms;for(Y=0;Y<dt;++Y)if(gt=C.getActiveUniform(ft,Y)){if(1<gt.size)for(var yt=0;yt<gt.size;++yt){var ae=gt.name.replace("[0]","["+yt+"]");vt(_t,new ot(ae,V.id(ae),C.getUniformLocation(ft,ae),gt))}yt=gt.name,1<gt.size&&(yt=yt.replace("[0]","")),vt(_t,new ot(yt,V.id(yt),C.getUniformLocation(ft,yt),gt))}for(dt=C.getProgramParameter(ft,35721),mt.profile&&(bt.stats.attributesCount=dt),bt=bt.attributes,Y=0;Y<dt;++Y)(gt=C.getActiveAttrib(ft,Y))&&vt(bt,new ot(gt.name,V.id(gt.name),C.getAttribLocation(ft,gt.name),gt))}var St={},Bt={},Q={},ht=[],ct=0;return mt.profile&&(J.getMaxUniformsCount=function(){var bt=0;return ht.forEach(function(ft){ft.stats.uniformsCount>bt&&(bt=ft.stats.uniformsCount)}),bt},J.getMaxAttributesCount=function(){var bt=0;return ht.forEach(function(ft){ft.stats.attributesCount>bt&&(bt=ft.stats.attributesCount)}),bt}),{clear:function(){var bt=C.deleteShader.bind(C);pn(St).forEach(bt),St={},pn(Bt).forEach(bt),Bt={},ht.forEach(function(ft){C.deleteProgram(ft.program)}),ht.length=0,Q={},J.shaderCount=0},program:function(bt,ft,gt,Y){var dt=Q[ft];dt||(dt=Q[ft]={});var _t=dt[bt];if(_t&&(_t.refCount++,!Y))return _t;var yt=new Pt(ft,bt);return J.shaderCount++,Wt(yt,gt,Y),_t||(dt[bt]=yt),ht.push(yt),Jt(yt,{destroy:function(){if(yt.refCount--,0>=yt.refCount){C.deleteProgram(yt.program);var ae=ht.indexOf(yt);ht.splice(ae,1),J.shaderCount--}0>=dt[yt.vertId].refCount&&(C.deleteShader(Bt[yt.vertId]),delete Bt[yt.vertId],delete Q[yt.fragId][yt.vertId]),Object.keys(Q[yt.fragId]).length||(C.deleteShader(St[yt.fragId]),delete St[yt.fragId],delete Q[yt.fragId])}})},restore:function(){St={},Bt={};for(var bt=0;bt<ht.length;++bt)Wt(ht[bt],null,ht[bt].attributes.map(function(ft){return[ft.location,ft.name]}))},shader:Ot,frag:-1,vert:-1}}function st(C,V,J,mt,ot,vt,Ot){function Pt(St){var Bt;Bt=V.next===null?5121:V.next.colorAttachments[0].texture._texture.type;var Q=0,ht=0,ct=mt.framebufferWidth,bt=mt.framebufferHeight,ft=null;return Le(St)?ft=St:St&&(Q=St.x|0,ht=St.y|0,ct=(St.width||mt.framebufferWidth-Q)|0,bt=(St.height||mt.framebufferHeight-ht)|0,ft=St.data||null),J(),St=ct*bt*4,ft||(Bt===5121?ft=new Uint8Array(St):Bt===5126&&(ft=ft||new Float32Array(St))),C.pixelStorei(3333,4),C.readPixels(Q,ht,ct,bt,6408,Bt,ft),ft}function Wt(St){var Bt;return V.setFBO({framebuffer:St.framebuffer},function(){Bt=Pt(St)}),Bt}return function(St){return St&&"framebuffer"in St?Wt(St):Pt(St)}}function lt(C){return Array.prototype.slice.call(C)}function rt(C){return lt(C).join("")}function Rt(){function C(){var Pt=[],Wt=[];return Jt(function(){Pt.push.apply(Pt,lt(arguments))},{def:function(){var St="v"+J++;return Wt.push(St),0<arguments.length&&(Pt.push(St,"="),Pt.push.apply(Pt,lt(arguments)),Pt.push(";")),St},toString:function(){return rt([0<Wt.length?"var "+Wt.join(",")+";":"",rt(Pt)])}})}function V(){function Pt(ht,ct){St(ht,ct,"=",Wt.def(ht,ct),";")}var Wt=C(),St=C(),Bt=Wt.toString,Q=St.toString;return Jt(function(){Wt.apply(Wt,lt(arguments))},{def:Wt.def,entry:Wt,exit:St,save:Pt,set:function(ht,ct,bt){Pt(ht,ct),Wt(ht,ct,"=",bt,";")},toString:function(){return Bt()+Q()}})}var J=0,mt=[],ot=[],vt=C(),Ot={};return{global:vt,link:function(Pt){for(var Wt=0;Wt<ot.length;++Wt)if(ot[Wt]===Pt)return mt[Wt];return Wt="g"+J++,mt.push(Wt),ot.push(Pt),Wt},block:C,proc:function(Pt,Wt){function St(){var ct="a"+Bt.length;return Bt.push(ct),ct}var Bt=[];Wt=Wt||0;for(var Q=0;Q<Wt;++Q)St();var Q=V(),ht=Q.toString;return Ot[Pt]=Jt(Q,{arg:St,toString:function(){return rt(["function(",Bt.join(),"){",ht(),"}"])}})},scope:V,cond:function(){var Pt=rt(arguments),Wt=V(),St=V(),Bt=Wt.toString,Q=St.toString;return Jt(Wt,{then:function(){return Wt.apply(Wt,lt(arguments)),this},else:function(){return St.apply(St,lt(arguments)),this},toString:function(){var ht=Q();return ht&&(ht="else{"+ht+"}"),rt(["if(",Pt,"){",Bt(),"}",ht])}})},compile:function(){var Pt=['"use strict";',vt,"return {"];Object.keys(Ot).forEach(function(St){Pt.push('"',St,'":',Ot[St].toString(),",")}),Pt.push("}");var Wt=rt(Pt).replace(/;/g,`;
`).replace(/}/g,`}
`).replace(/{/g,`{
`);return Function.apply(null,mt.concat(Wt)).apply(null,ot)}}}function Ht(C){return Array.isArray(C)||Le(C)||m(C)}function ee(C){return C.sort(function(V,J){return V==="viewport"?-1:J==="viewport"?1:V<J?-1:1})}function nt(C,V,J,mt){this.thisDep=C,this.contextDep=V,this.propDep=J,this.append=mt}function Dt(C){return C&&!(C.thisDep||C.contextDep||C.propDep)}function Vt(C){return new nt(!1,!1,!1,C)}function Ct(C,V){var J=C.type;if(J===0)return J=C.data.length,new nt(!0,1<=J,2<=J,V);if(J===4)return J=C.data,new nt(J.thisDep,J.contextDep,J.propDep,V);if(J===5)return new nt(!1,!1,!1,V);if(J===6){for(var mt=J=!1,ot=!1,vt=0;vt<C.data.length;++vt){var Ot=C.data[vt];Ot.type===1?ot=!0:Ot.type===2?mt=!0:Ot.type===3?J=!0:Ot.type===0?(J=!0,Ot=Ot.data,1<=Ot&&(mt=!0),2<=Ot&&(ot=!0)):Ot.type===4&&(J=J||Ot.data.thisDep,mt=mt||Ot.data.contextDep,ot=ot||Ot.data.propDep)}return new nt(J,mt,ot,V)}return new nt(J===3,J===2,J===1,V)}function _e(C,V,J,mt,ot,vt,Ot,Pt,Wt,St,Bt,Q,ht,ct,bt){function ft(R){return R.replace(".","_")}function gt(R,N,q){var et=ft(R);Lt.push(R),kt[et]=X[et]=!!q,Te[et]=N}function Y(R,N,q){var et=ft(R);Lt.push(R),Array.isArray(q)?(X[et]=q.slice(),kt[et]=q.slice()):X[et]=kt[et]=q,Kt[et]=N}function dt(){var R=Rt(),N=R.link,q=R.global;R.id=He++,R.batchId="0";var et=N(Yt),ut=R.shared={props:"a0"};Object.keys(Yt).forEach(function(B){ut[B]=q.def(et,".",B)});var it=R.next={},tt=R.current={};Object.keys(Kt).forEach(function(B){Array.isArray(X[B])&&(it[B]=q.def(ut.next,".",B),tt[B]=q.def(ut.current,".",B))});var K=R.constants={};Object.keys(he).forEach(function(B){K[B]=q.def(JSON.stringify(he[B]))}),R.invoke=function(B,G){switch(G.type){case 0:var wt=["this",ut.context,ut.props,R.batchId];return B.def(N(G.data),".call(",wt.slice(0,Math.max(G.data.length+1,4)),")");case 1:return B.def(ut.props,G.data);case 2:return B.def(ut.context,G.data);case 3:return B.def("this",G.data);case 4:return G.data.append(R,B),G.data.ref;case 5:return G.data.toString();case 6:return G.data.map(function(At){return R.invoke(B,At)})}},R.attribCache={};var H={};return R.scopeAttrib=function(B){if(B=V.id(B),B in H)return H[B];var G=St.scope[B];return G||(G=St.scope[B]=new Fn),H[B]=N(G)},R}function _t(R){var N=R.static;R=R.dynamic;var q;if("profile"in N){var et=!!N.profile;q=Vt(function(it,tt){return et}),q.enable=et}else if("profile"in R){var ut=R.profile;q=Ct(ut,function(it,tt){return it.invoke(tt,ut)})}return q}function yt(R,N){var q=R.static,et=R.dynamic;if("framebuffer"in q){var ut=q.framebuffer;return ut?(ut=Pt.getFramebuffer(ut),Vt(function(tt,K){var H=tt.link(ut),B=tt.shared;return K.set(B.framebuffer,".next",H),B=B.context,K.set(B,".framebufferWidth",H+".width"),K.set(B,".framebufferHeight",H+".height"),H})):Vt(function(tt,K){var H=tt.shared;return K.set(H.framebuffer,".next","null"),H=H.context,K.set(H,".framebufferWidth",H+".drawingBufferWidth"),K.set(H,".framebufferHeight",H+".drawingBufferHeight"),"null"})}if("framebuffer"in et){var it=et.framebuffer;return Ct(it,function(tt,K){var G=tt.invoke(K,it),H=tt.shared,B=H.framebuffer,G=K.def(B,".getFramebuffer(",G,")");return K.set(B,".next",G),H=H.context,K.set(H,".framebufferWidth",G+"?"+G+".width:"+H+".drawingBufferWidth"),K.set(H,".framebufferHeight",G+"?"+G+".height:"+H+".drawingBufferHeight"),G})}return null}function ae(R,N,q){function et(K){if(K in ut){var H=ut[K];K=!0;var B=H.x|0,G=H.y|0,wt,At;return"width"in H?wt=H.width|0:K=!1,"height"in H?At=H.height|0:K=!1,new nt(!K&&N&&N.thisDep,!K&&N&&N.contextDep,!K&&N&&N.propDep,function(zt,jt){var Ut=zt.shared.context,$t=wt;"width"in H||($t=jt.def(Ut,".","framebufferWidth","-",B));var oe=At;return"height"in H||(oe=jt.def(Ut,".","framebufferHeight","-",G)),[B,G,$t,oe]})}if(K in it){var Zt=it[K];return K=Ct(Zt,function(zt,jt){var Me=zt.invoke(jt,Zt),Ut=zt.shared.context,$t=jt.def(Me,".x|0"),oe=jt.def(Me,".y|0"),Qt=jt.def('"width" in ',Me,"?",Me,".width|0:","(",Ut,".","framebufferWidth","-",$t,")"),Me=jt.def('"height" in ',Me,"?",Me,".height|0:","(",Ut,".","framebufferHeight","-",oe,")");return[$t,oe,Qt,Me]}),N&&(K.thisDep=K.thisDep||N.thisDep,K.contextDep=K.contextDep||N.contextDep,K.propDep=K.propDep||N.propDep),K}return N?new nt(N.thisDep,N.contextDep,N.propDep,function(zt,jt){var Ut=zt.shared.context;return[0,0,jt.def(Ut,".","framebufferWidth"),jt.def(Ut,".","framebufferHeight")]}):null}var ut=R.static,it=R.dynamic;if(R=et("viewport")){var tt=R;R=new nt(R.thisDep,R.contextDep,R.propDep,function(K,H){var B=tt.append(K,H),G=K.shared.context;return H.set(G,".viewportWidth",B[2]),H.set(G,".viewportHeight",B[3]),B})}return{viewport:R,scissor_box:et("scissor.box")}}function Ke(R,N){var q=R.static;if(typeof q.frag=="string"&&typeof q.vert=="string"){if(0<Object.keys(N.dynamic).length)return null;var q=N.static,et=Object.keys(q);if(0<et.length&&typeof q[et[0]]=="number"){for(var ut=[],it=0;it<et.length;++it)ut.push([q[et[it]]|0,et[it]]);return ut}}return null}function vn(R,N,q){function et(B){if(B in ut){var G=V.id(ut[B]);return B=Vt(function(){return G}),B.id=G,B}if(B in it){var wt=it[B];return Ct(wt,function(At,Zt){var zt=At.invoke(Zt,wt);return Zt.def(At.shared.strings,".id(",zt,")")})}return null}var ut=R.static,it=R.dynamic,tt=et("frag"),K=et("vert"),H=null;return Dt(tt)&&Dt(K)?(H=Bt.program(K.id,tt.id,null,q),R=Vt(function(B,G){return B.link(H)})):R=new nt(tt&&tt.thisDep||K&&K.thisDep,tt&&tt.contextDep||K&&K.contextDep,tt&&tt.propDep||K&&K.propDep,function(B,G){var wt=B.shared.shader,At;At=tt?tt.append(B,G):G.def(wt,".","frag");var Zt;return Zt=K?K.append(B,G):G.def(wt,".","vert"),G.def(wt+".program("+Zt+","+At+")")}),{frag:tt,vert:K,progVar:R,program:H}}function $e(R,N){function q(zt,jt){if(zt in et){var Ut=et[zt]|0;return jt?it.offset=Ut:it.instances=Ut,Vt(function(oe,Qt){return jt&&(oe.OFFSET=Ut),Ut})}if(zt in ut){var $t=ut[zt];return Ct($t,function(oe,Qt){var Me=oe.invoke(Qt,$t);return jt&&(oe.OFFSET=Me),Me})}if(jt){if(H)return Vt(function(oe,Qt){return oe.OFFSET=0});if(tt)return new nt(K.thisDep,K.contextDep,K.propDep,function(oe,Qt){return Qt.def(oe.shared.vao+".currentVAO?"+oe.shared.vao+".currentVAO.offset:0")})}else if(tt)return new nt(K.thisDep,K.contextDep,K.propDep,function(oe,Qt){return Qt.def(oe.shared.vao+".currentVAO?"+oe.shared.vao+".currentVAO.instances:-1")});return null}var et=R.static,ut=R.dynamic,it={},tt=!1,K=function(){if("vao"in et){var zt=et.vao;return zt!==null&&St.getVAO(zt)===null&&(zt=St.createVAO(zt)),tt=!0,it.vao=zt,Vt(function(Ut){var $t=St.getVAO(zt);return $t?Ut.link($t):"null"})}if("vao"in ut){tt=!0;var jt=ut.vao;return Ct(jt,function(Ut,$t){var oe=Ut.invoke($t,jt);return $t.def(Ut.shared.vao+".getVAO("+oe+")")})}return null}(),H=!1,B=function(){if("elements"in et){var zt=et.elements;if(it.elements=zt,Ht(zt)){var jt=it.elements=vt.create(zt,!0),zt=vt.getElements(jt);H=!0}else zt&&(zt=vt.getElements(zt),H=!0);return jt=Vt(function($t,oe){if(zt){var Qt=$t.link(zt);return $t.ELEMENTS=Qt}return $t.ELEMENTS=null}),jt.value=zt,jt}if("elements"in ut){H=!0;var Ut=ut.elements;return Ct(Ut,function($t,oe){var Qt=$t.shared,Or=Qt.isBufferArgs,Qt=Qt.elements,lc=$t.invoke(oe,Ut),Me=oe.def("null"),Or=oe.def(Or,"(",lc,")"),lc=$t.cond(Or).then(Me,"=",Qt,".createStream(",lc,");").else(Me,"=",Qt,".getElements(",lc,");");return oe.entry(lc),oe.exit($t.cond(Or).then(Qt,".destroyStream(",Me,");")),$t.ELEMENTS=Me})}return tt?new nt(K.thisDep,K.contextDep,K.propDep,function($t,oe){return oe.def($t.shared.vao+".currentVAO?"+$t.shared.elements+".getElements("+$t.shared.vao+".currentVAO.elements):null")}):null}(),G=q("offset",!0),wt=function(){if("primitive"in et){var zt=et.primitive;return it.primitive=zt,Vt(function(Ut,$t){return yn[zt]})}if("primitive"in ut){var jt=ut.primitive;return Ct(jt,function(Ut,$t){var oe=Ut.constants.primTypes,Qt=Ut.invoke($t,jt);return $t.def(oe,"[",Qt,"]")})}return H?Dt(B)?B.value?Vt(function(Ut,$t){return $t.def(Ut.ELEMENTS,".primType")}):Vt(function(){return 4}):new nt(B.thisDep,B.contextDep,B.propDep,function(Ut,$t){var oe=Ut.ELEMENTS;return $t.def(oe,"?",oe,".primType:",4)}):tt?new nt(K.thisDep,K.contextDep,K.propDep,function(Ut,$t){return $t.def(Ut.shared.vao+".currentVAO?"+Ut.shared.vao+".currentVAO.primitive:4")}):null}(),At=function(){if("count"in et){var zt=et.count|0;return it.count=zt,Vt(function(){return zt})}if("count"in ut){var jt=ut.count;return Ct(jt,function(Ut,$t){return Ut.invoke($t,jt)})}return H?Dt(B)?B?G?new nt(G.thisDep,G.contextDep,G.propDep,function(Ut,$t){return $t.def(Ut.ELEMENTS,".vertCount-",Ut.OFFSET)}):Vt(function(Ut,$t){return $t.def(Ut.ELEMENTS,".vertCount")}):Vt(function(){return-1}):new nt(B.thisDep||G.thisDep,B.contextDep||G.contextDep,B.propDep||G.propDep,function(Ut,$t){var oe=Ut.ELEMENTS;return Ut.OFFSET?$t.def(oe,"?",oe,".vertCount-",Ut.OFFSET,":-1"):$t.def(oe,"?",oe,".vertCount:-1")}):tt?new nt(K.thisDep,K.contextDep,K.propDep,function(Ut,$t){return $t.def(Ut.shared.vao,".currentVAO?",Ut.shared.vao,".currentVAO.count:-1")}):null}(),Zt=q("instances",!1);return{elements:B,primitive:wt,count:At,instances:Zt,offset:G,vao:K,vaoActive:tt,elementsActive:H,static:it}}function xt(R,N){var q=R.static,et=R.dynamic,ut={};return Lt.forEach(function(it){function tt(H,B){if(it in q){var G=H(q[it]);ut[K]=Vt(function(){return G})}else if(it in et){var wt=et[it];ut[K]=Ct(wt,function(At,Zt){return B(At,Zt,At.invoke(Zt,wt))})}}var K=ft(it);switch(it){case"cull.enable":case"blend.enable":case"dither":case"stencil.enable":case"depth.enable":case"scissor.enable":case"polygonOffset.enable":case"sample.alpha":case"sample.enable":case"depth.mask":return tt(function(H){return H},function(H,B,G){return G});case"depth.func":return tt(function(H){return Pr[H]},function(H,B,G){return B.def(H.constants.compareFuncs,"[",G,"]")});case"depth.range":return tt(function(H){return H},function(H,B,G){return H=B.def("+",G,"[0]"),B=B.def("+",G,"[1]"),[H,B]});case"blend.func":return tt(function(H){return[oi["srcRGB"in H?H.srcRGB:H.src],oi["dstRGB"in H?H.dstRGB:H.dst],oi["srcAlpha"in H?H.srcAlpha:H.src],oi["dstAlpha"in H?H.dstAlpha:H.dst]]},function(H,B,G){function wt(jt,Ut){return B.def('"',jt,Ut,'" in ',G,"?",G,".",jt,Ut,":",G,".",jt)}H=H.constants.blendFuncs;var At=wt("src","RGB"),zt=wt("dst","RGB"),At=B.def(H,"[",At,"]"),Zt=B.def(H,"[",wt("src","Alpha"),"]"),zt=B.def(H,"[",zt,"]");return H=B.def(H,"[",wt("dst","Alpha"),"]"),[At,zt,Zt,H]});case"blend.equation":return tt(function(H){if(typeof H=="string")return[qr[H],qr[H]];if(typeof H=="object")return[qr[H.rgb],qr[H.alpha]]},function(H,B,G){var wt=H.constants.blendEquations,At=B.def(),Zt=B.def();return H=H.cond("typeof ",G,'==="string"'),H.then(At,"=",Zt,"=",wt,"[",G,"];"),H.else(At,"=",wt,"[",G,".rgb];",Zt,"=",wt,"[",G,".alpha];"),B(H),[At,Zt]});case"blend.color":return tt(function(H){return d(4,function(B){return+H[B]})},function(H,B,G){return d(4,function(wt){return B.def("+",G,"[",wt,"]")})});case"stencil.mask":return tt(function(H){return H|0},function(H,B,G){return B.def(G,"|0")});case"stencil.func":return tt(function(H){return[Pr[H.cmp||"keep"],H.ref||0,"mask"in H?H.mask:-1]},function(H,B,G){H=B.def('"cmp" in ',G,"?",H.constants.compareFuncs,"[",G,".cmp]",":",7680);var wt=B.def(G,".ref|0");return B=B.def('"mask" in ',G,"?",G,".mask|0:-1"),[H,wt,B]});case"stencil.opFront":case"stencil.opBack":return tt(function(H){return[it==="stencil.opBack"?1029:1028,Ki[H.fail||"keep"],Ki[H.zfail||"keep"],Ki[H.zpass||"keep"]]},function(H,B,G){function wt(Zt){return B.def('"',Zt,'" in ',G,"?",At,"[",G,".",Zt,"]:",7680)}var At=H.constants.stencilOps;return[it==="stencil.opBack"?1029:1028,wt("fail"),wt("zfail"),wt("zpass")]});case"polygonOffset.offset":return tt(function(H){return[H.factor|0,H.units|0]},function(H,B,G){return H=B.def(G,".factor|0"),B=B.def(G,".units|0"),[H,B]});case"cull.face":return tt(function(H){var B=0;return H==="front"?B=1028:H==="back"&&(B=1029),B},function(H,B,G){return B.def(G,'==="front"?',1028,":",1029)});case"lineWidth":return tt(function(H){return H},function(H,B,G){return G});case"frontFace":return tt(function(H){return ac[H]},function(H,B,G){return B.def(G+'==="cw"?2304:2305')});case"colorMask":return tt(function(H){return H.map(function(B){return!!B})},function(H,B,G){return d(4,function(wt){return"!!"+G+"["+wt+"]"})});case"sample.coverage":return tt(function(H){return["value"in H?H.value:1,!!H.invert]},function(H,B,G){return H=B.def('"value" in ',G,"?+",G,".value:1"),B=B.def("!!",G,".invert"),[H,B]})}}),ut}function ye(R,N){var q=R.static,et=R.dynamic,ut={};return Object.keys(q).forEach(function(it){var tt=q[it],K;if(typeof tt=="number"||typeof tt=="boolean")K=Vt(function(){return tt});else if(typeof tt=="function"){var H=tt._reglType;H==="texture2d"||H==="textureCube"?K=Vt(function(B){return B.link(tt)}):(H==="framebuffer"||H==="framebufferCube")&&(K=Vt(function(B){return B.link(tt.color[0])}))}else S(tt)&&(K=Vt(function(B){return B.global.def("[",d(tt.length,function(G){return tt[G]}),"]")}));K.value=tt,ut[it]=K}),Object.keys(et).forEach(function(it){var tt=et[it];ut[it]=Ct(tt,function(K,H){return K.invoke(H,tt)})}),ut}function ne(R,N){var q=R.static,et=R.dynamic,ut={};return Object.keys(q).forEach(function(it){var tt=q[it],K=V.id(it),H=new Fn;if(Ht(tt))H.state=1,H.buffer=ot.getBuffer(ot.create(tt,34962,!1,!0)),H.type=0;else{var B=ot.getBuffer(tt);if(B)H.state=1,H.buffer=B,H.type=0;else if("constant"in tt){var G=tt.constant;H.buffer="null",H.state=2,typeof G=="number"?H.x=G:Hr.forEach(function(Ut,$t){$t<G.length&&(H[Ut]=G[$t])})}else{var B=Ht(tt.buffer)?ot.getBuffer(ot.create(tt.buffer,34962,!1,!0)):ot.getBuffer(tt.buffer),wt=tt.offset|0,At=tt.stride|0,Zt=tt.size|0,zt=!!tt.normalized,jt=0;"type"in tt&&(jt=ln[tt.type]),tt=tt.divisor|0,H.buffer=B,H.state=1,H.size=Zt,H.normalized=zt,H.type=jt||B.dtype,H.offset=wt,H.stride=At,H.divisor=tt}}ut[it]=Vt(function(Ut,$t){var oe=Ut.attribCache;if(K in oe)return oe[K];var Qt={isStream:!1};return Object.keys(H).forEach(function(Me){Qt[Me]=H[Me]}),H.buffer&&(Qt.buffer=Ut.link(H.buffer),Qt.type=Qt.type||Qt.buffer+".dtype"),oe[K]=Qt})}),Object.keys(et).forEach(function(it){var tt=et[it];ut[it]=Ct(tt,function(K,H){function B(oe){H(zt[oe],"=",G,".",oe,"|0;")}var G=K.invoke(H,tt),Zt=K.shared,wt=K.constants,At=Zt.isBufferArgs,Zt=Zt.buffer,zt={isStream:H.def(!1)},jt=new Fn;jt.state=1,Object.keys(jt).forEach(function(oe){zt[oe]=H.def(""+jt[oe])});var Ut=zt.buffer,$t=zt.type;return H("if(",At,"(",G,")){",zt.isStream,"=true;",Ut,"=",Zt,".createStream(",34962,",",G,");",$t,"=",Ut,".dtype;","}else{",Ut,"=",Zt,".getBuffer(",G,");","if(",Ut,"){",$t,"=",Ut,".dtype;",'}else if("constant" in ',G,"){",zt.state,"=",2,";","if(typeof "+G+'.constant === "number"){',zt[Hr[0]],"=",G,".constant;",Hr.slice(1).map(function(oe){return zt[oe]}).join("="),"=0;","}else{",Hr.map(function(oe,Qt){return zt[oe]+"="+G+".constant.length>"+Qt+"?"+G+".constant["+Qt+"]:0;"}).join(""),"}}else{","if(",At,"(",G,".buffer)){",Ut,"=",Zt,".createStream(",34962,",",G,".buffer);","}else{",Ut,"=",Zt,".getBuffer(",G,".buffer);","}",$t,'="type" in ',G,"?",wt.glTypes,"[",G,".type]:",Ut,".dtype;",zt.normalized,"=!!",G,".normalized;"),B("size"),B("offset"),B("stride"),B("divisor"),H("}}"),H.exit("if(",zt.isStream,"){",Zt,".destroyStream(",Ut,");","}"),zt})}),ut}function Nt(R){var N=R.static,q=R.dynamic,et={};return Object.keys(N).forEach(function(ut){var it=N[ut];et[ut]=Vt(function(tt,K){return typeof it=="number"||typeof it=="boolean"?""+it:tt.link(it)})}),Object.keys(q).forEach(function(ut){var it=q[ut];et[ut]=Ct(it,function(tt,K){return tt.invoke(K,it)})}),et}function me(R,N,q,et,ut){function it(jt){var Ut=K[jt];Ut&&(B[jt]=Ut)}var tt=Ke(R,N),At=yt(R),K=ae(R,At),H=$e(R),B=xt(R),G=vn(R,ut,tt);it("viewport"),it(ft("scissor.box"));var wt=0<Object.keys(B).length,At={framebuffer:At,draw:H,shader:G,state:B,dirty:wt,scopeVAO:null,drawVAO:null,useVAO:!1,attributes:{}};if(At.profile=_t(R),At.uniforms=ye(q),At.drawVAO=At.scopeVAO=H.vao,!At.drawVAO&&G.program&&!tt&&J.angle_instanced_arrays&&H.static.elements){var Zt=!0;if(R=G.program.attributes.map(function(jt){return jt=N.static[jt],Zt=Zt&&!!jt,jt}),Zt&&0<R.length){var zt=St.getVAO(St.createVAO({attributes:R,elements:H.static.elements}));At.drawVAO=new nt(null,null,null,function(jt,Ut){return jt.link(zt)}),At.useVAO=!0}}return tt?At.useVAO=!0:At.attributes=ne(N),At.context=Nt(et),At}function Be(R,N,q){var et=R.shared.context,ut=R.scope();Object.keys(q).forEach(function(it){N.save(et,"."+it);var tt=q[it].append(R,N);Array.isArray(tt)?ut(et,".",it,"=[",tt.join(),"];"):ut(et,".",it,"=",tt,";")}),N(ut)}function fe(R,N,q,et){var K=R.shared,ut=K.gl,it=K.framebuffer,tt;F&&(tt=N.def(K.extensions,".webgl_draw_buffers"));var H=R.constants,K=H.drawBuffer,H=H.backBuffer;R=q?q.append(R,N):N.def(it,".next"),et||N("if(",R,"!==",it,".cur){"),N("if(",R,"){",ut,".bindFramebuffer(",36160,",",R,".framebuffer);"),F&&N(tt,".drawBuffersWEBGL(",K,"[",R,".colorAttachments.length]);"),N("}else{",ut,".bindFramebuffer(",36160,",null);"),F&&N(tt,".drawBuffersWEBGL(",H,");"),N("}",it,".cur=",R,";"),et||N("}")}function Ue(R,N,q){var et=R.shared,ut=et.gl,it=R.current,tt=R.next,K=et.current,H=et.next,B=R.cond(K,".dirty");Lt.forEach(function(G){if(G=ft(G),!(G in q.state)){var wt,At;if(G in tt){wt=tt[G],At=it[G];var Zt=d(X[G].length,function(zt){return B.def(wt,"[",zt,"]")});B(R.cond(Zt.map(function(zt,jt){return zt+"!=="+At+"["+jt+"]"}).join("||")).then(ut,".",Kt[G],"(",Zt,");",Zt.map(function(zt,jt){return At+"["+jt+"]="+zt}).join(";"),";"))}else wt=B.def(H,".",G),Zt=R.cond(wt,"!==",K,".",G),B(Zt),G in Te?Zt(R.cond(wt).then(ut,".enable(",Te[G],");").else(ut,".disable(",Te[G],");"),K,".",G,"=",wt,";"):Zt(ut,".",Kt[G],"(",wt,");",K,".",G,"=",wt,";")}}),Object.keys(q.state).length===0&&B(K,".dirty=false;"),N(B)}function xn(R,N,q,et){var ut=R.shared,it=R.current,tt=ut.current,K=ut.gl;ee(Object.keys(q)).forEach(function(H){var B=q[H];if(!et||et(B)){var G=B.append(R,N);if(Te[H]){var wt=Te[H];Dt(B)?G?N(K,".enable(",wt,");"):N(K,".disable(",wt,");"):N(R.cond(G).then(K,".enable(",wt,");").else(K,".disable(",wt,");")),N(tt,".",H,"=",G,";")}else if(S(G)){var At=it[H];N(K,".",Kt[H],"(",G,");",G.map(function(Zt,zt){return At+"["+zt+"]="+Zt}).join(";"),";")}else N(K,".",Kt[H],"(",G,");",tt,".",H,"=",G,";")}})}function De(R,N){sr&&(R.instancing=N.def(R.shared.extensions,".angle_instanced_arrays"))}function Xe(R,N,q,et,ut){function it(){return typeof performance>"u"?"Date.now()":"performance.now()"}function tt(jt){Zt=N.def(),jt(Zt,"=",it(),";"),typeof ut=="string"?jt(G,".count+=",ut,";"):jt(G,".count++;"),ct&&(et?(zt=N.def(),jt(zt,"=",At,".getNumPendingQueries();")):jt(At,".beginQuery(",G,");"))}function K(jt){jt(G,".cpuTime+=",it(),"-",Zt,";"),ct&&(et?jt(At,".pushScopeStats(",zt,",",At,".getNumPendingQueries(),",G,");"):jt(At,".endQuery();"))}function H(jt){var Ut=N.def(wt,".profile");N(wt,".profile=",jt,";"),N.exit(wt,".profile=",Ut,";")}var B=R.shared,G=R.stats,wt=B.current,At=B.timer;q=q.profile;var Zt,zt;if(q){if(Dt(q)){q.enable?(tt(N),K(N.exit),H("true")):H("false");return}q=q.append(R,N),H(q)}else q=N.def(wt,".profile");B=R.block(),tt(B),N("if(",q,"){",B,"}"),R=R.block(),K(R),N.exit("if(",q,"){",R,"}")}function ir(R,N,q,et,ut){function it(H){switch(H){case 35664:case 35667:case 35671:return 2;case 35665:case 35668:case 35672:return 3;case 35666:case 35669:case 35673:return 4;default:return 1}}function tt(H,B,G){function wt(){N(Zt,".enableVertexAttribArray(",zt,");");var Qt=G.type,Me;Me=G.size?N.def(G.size,"||",B):B,N(Zt,".bindBuffer(",34962,",",Ut,".buffer);",Zt,".vertexAttribPointer(",[zt,Me,Qt,G.normalized,G.stride,G.offset],");",jt,".type=",Qt,";",jt,".size=",Me,";",oe.map(function(Or){return jt+"."+Or+"="+G[Or]+";"}).join("")),sr&&(Qt=G.divisor,N("if(",jt,".divisor!==",Qt,"){",R.instancing,".vertexAttribDivisorANGLE(",[zt,Qt],");",jt,".divisor=",Qt,";}"))}function At(){N("if(",jt,".buffer){",Zt,".disableVertexAttribArray(",zt,");",jt,".buffer=null;","}if(",Hr.map(function(Qt,Me){return jt+"."+Qt+"!=="+$t[Me]}).join("||"),"){",Zt,".vertexAttrib4f(",zt,",",$t,");",Hr.map(function(Qt,Me){return jt+"."+Qt+"="+$t[Me]+";"}).join(""),"}")}var Zt=K.gl,zt=N.def(H,".location"),jt=N.def(K.attributes,"[",zt,"]");H=G.state;var Ut=G.buffer,$t=[G.x,G.y,G.z,G.w],oe=["buffer","normalized","offset","stride"];H===1?wt():H===2?At():(N("if(",H,"===",1,"){"),wt(),N("}else{"),At(),N("}"))}var K=R.shared;et.forEach(function(H){var B=H.name,G=q.attributes[B],wt;if(G){if(!ut(G))return;wt=G.append(R,N)}else{if(!ut(pa))return;var At=R.scopeAttrib(B);wt={},Object.keys(new Fn).forEach(function(Zt){wt[Zt]=N.def(At,".",Zt)})}tt(R.link(H),it(H.info.type),wt)})}function Er(R,N,q,et,ut,it){for(var tt=R.shared,K=tt.gl,H={},B,G=0;G<et.length;++G){var Ut=et[G],wt=Ut.name,At=Ut.info.type,Zt=Ut.info.size,zt=q.uniforms[wt];if(1<Zt){if(!zt)continue;var jt=wt.replace("[0]","");if(H[jt])continue;H[jt]=1}var Ut=R.link(Ut)+".location",$t;if(zt){if(!ut(zt))continue;if(Dt(zt)){if(wt=zt.value,At===35678||At===35680)At=R.link(wt._texture||wt.color[0]._texture),N(K,".uniform1i(",Ut,",",At+".bind());"),N.exit(At,".unbind();");else if(At===35674||At===35675||At===35676)Zt=R.global.def("new Float32Array(["+Array.prototype.slice.call(wt)+"])"),wt=2,At===35675?wt=3:At===35676&&(wt=4),N(K,".uniformMatrix",wt,"fv(",Ut,",false,",Zt,");");else{switch(At){case 5126:B="1f";break;case 35664:B="2f";break;case 35665:B="3f";break;case 35666:B="4f";break;case 35670:B="1i";break;case 5124:B="1i";break;case 35671:B="2i";break;case 35667:B="2i";break;case 35672:B="3i";break;case 35668:B="3i";break;case 35673:B="4i";break;case 35669:B="4i"}1<Zt?(B+="v",wt=R.global.def("["+Array.prototype.slice.call(wt)+"]")):wt=S(wt)?Array.prototype.slice.call(wt):wt,N(K,".uniform",B,"(",Ut,",",wt,");")}continue}else $t=zt.append(R,N)}else{if(!ut(pa))continue;$t=N.def(tt.uniforms,"[",V.id(wt),"]")}switch(At===35678?N("if(",$t,"&&",$t,'._reglType==="framebuffer"){',$t,"=",$t,".color[0];","}"):At===35680&&N("if(",$t,"&&",$t,'._reglType==="framebufferCube"){',$t,"=",$t,".color[0];","}"),wt=1,At){case 35678:case 35680:At=N.def($t,"._texture"),N(K,".uniform1i(",Ut,",",At,".bind());"),N.exit(At,".unbind();");continue;case 5124:case 35670:B="1i";break;case 35667:case 35671:B="2i",wt=2;break;case 35668:case 35672:B="3i",wt=3;break;case 35669:case 35673:B="4i",wt=4;break;case 5126:B="1f";break;case 35664:B="2f",wt=2;break;case 35665:B="3f",wt=3;break;case 35666:B="4f",wt=4;break;case 35674:B="Matrix2fv";break;case 35675:B="Matrix3fv";break;case 35676:B="Matrix4fv"}if(B.indexOf("Matrix")===-1&&1<Zt&&(B+="v",wt=1),B.charAt(0)==="M"){N(K,".uniform",B,"(",Ut,",");var Ut=Math.pow(At-35674+2,2),oe=R.global.def("new Float32Array(",Ut,")");Array.isArray($t)?N("false,(",d(Ut,function(Or){return oe+"["+Or+"]="+$t[Or]}),",",oe,")"):N("false,(Array.isArray(",$t,")||",$t," instanceof Float32Array)?",$t,":(",d(Ut,function(Or){return oe+"["+Or+"]="+$t+"["+Or+"]"}),",",oe,")"),N(");")}else{if(1<wt){for(var At=[],Qt=[],Zt=0;Zt<wt;++Zt)Array.isArray($t)?Qt.push($t[Zt]):Qt.push(N.def($t+"["+Zt+"]")),it&&At.push(N.def());it&&N("if(!",R.batchId,"||",At.map(function(Me,Or){return Me+"!=="+Qt[Or]}).join("||"),"){",At.map(function(Me,Or){return Me+"="+Qt[Or]+";"}).join("")),N(K,".uniform",B,"(",Ut,",",Qt.join(","),");")}else it&&(At=N.def(),N("if(!",R.batchId,"||",At,"!==",$t,"){",At,"=",$t,";")),N(K,".uniform",B,"(",Ut,",",$t,");");it&&N("}")}}}function Nr(R,N,q,et){function ut(Qt){var Me=G[Qt];return Me?Me.contextDep&&et.contextDynamic||Me.propDep?Me.append(R,q):Me.append(R,N):N.def(B,".",Qt)}function it(){function Qt(){q(Ut,".drawElementsInstancedANGLE(",[At,zt,$t,Zt+"<<(("+$t+"-5121)>>1)",jt],");")}function Me(){q(Ut,".drawArraysInstancedANGLE(",[At,Zt,zt,jt],");")}wt&&wt!=="null"?oe?Qt():(q("if(",wt,"){"),Qt(),q("}else{"),Me(),q("}")):Me()}function tt(){function Qt(){q(H+".drawElements("+[At,zt,$t,Zt+"<<(("+$t+"-5121)>>1)"]+");")}function Me(){q(H+".drawArrays("+[At,Zt,zt]+");")}wt&&wt!=="null"?oe?Qt():(q("if(",wt,"){"),Qt(),q("}else{"),Me(),q("}")):Me()}var K=R.shared,H=K.gl,B=K.draw,G=et.draw,wt=function(){var Qt=G.elements,Me=N;return Qt?((Qt.contextDep&&et.contextDynamic||Qt.propDep)&&(Me=q),Qt=Qt.append(R,Me),G.elementsActive&&Me("if("+Qt+")"+H+".bindBuffer(34963,"+Qt+".buffer.buffer);")):(Qt=Me.def(),Me(Qt,"=",B,".","elements",";","if(",Qt,"){",H,".bindBuffer(",34963,",",Qt,".buffer.buffer);}","else if(",K.vao,".currentVAO){",Qt,"=",R.shared.elements+".getElements("+K.vao,".currentVAO.elements);",pt?"":"if("+Qt+")"+H+".bindBuffer(34963,"+Qt+".buffer.buffer);","}")),Qt}(),At=ut("primitive"),Zt=ut("offset"),zt=function(){var Qt=G.count,Me=N;return Qt?((Qt.contextDep&&et.contextDynamic||Qt.propDep)&&(Me=q),Qt=Qt.append(R,Me)):Qt=Me.def(B,".","count"),Qt}();if(typeof zt=="number"){if(zt===0)return}else q("if(",zt,"){"),q.exit("}");var jt,Ut;sr&&(jt=ut("instances"),Ut=R.instancing);var $t=wt+".type",oe=G.elements&&Dt(G.elements)&&!G.vaoActive;sr&&(typeof jt!="number"||0<=jt)?typeof jt=="string"?(q("if(",jt,">0){"),it(),q("}else if(",jt,"<0){"),tt(),q("}")):it():tt()}function _r(R,N,q,et,ut){return N=dt(),ut=N.proc("body",ut),sr&&(N.instancing=ut.def(N.shared.extensions,".angle_instanced_arrays")),R(N,ut,q,et),N.compile().body}function si(R,N,q,et){De(R,N),q.useVAO?q.drawVAO?N(R.shared.vao,".setVAO(",q.drawVAO.append(R,N),");"):N(R.shared.vao,".setVAO(",R.shared.vao,".targetVAO);"):(N(R.shared.vao,".setVAO(null);"),ir(R,N,q,et.attributes,function(){return!0})),Er(R,N,q,et.uniforms,function(){return!0},!1),Nr(R,N,N,q)}function Ae(R,N){var q=R.proc("draw",1);De(R,q),Be(R,q,N.context),fe(R,q,N.framebuffer),Ue(R,q,N),xn(R,q,N.state),Xe(R,q,N,!1,!0);var et=N.shader.progVar.append(R,q);if(q(R.shared.gl,".useProgram(",et,".program);"),N.shader.program)si(R,q,N,N.shader.program);else{q(R.shared.vao,".setVAO(null);");var ut=R.global.def("{}"),it=q.def(et,".id"),tt=q.def(ut,"[",it,"]");q(R.cond(tt).then(tt,".call(this,a0);").else(tt,"=",ut,"[",it,"]=",R.link(function(K){return _r(si,R,N,K,1)}),"(",et,");",tt,".call(this,a0);"))}0<Object.keys(N.state).length&&q(R.shared.current,".dirty=true;"),R.shared.vao&&q(R.shared.vao,".setVAO(null);")}function je(R,N,q,et){function ut(){return!0}R.batchId="a1",De(R,N),ir(R,N,q,et.attributes,ut),Er(R,N,q,et.uniforms,ut,!1),Nr(R,N,N,q)}function an(R,N,q,et){function ut(wt){return wt.contextDep&&tt||wt.propDep}function it(wt){return!ut(wt)}De(R,N);var tt=q.contextDep,K=N.def(),H=N.def();R.shared.props=H,R.batchId=K;var B=R.scope(),G=R.scope();N(B.entry,"for(",K,"=0;",K,"<","a1",";++",K,"){",H,"=","a0","[",K,"];",G,"}",B.exit),q.needsContext&&Be(R,G,q.context),q.needsFramebuffer&&fe(R,G,q.framebuffer),xn(R,G,q.state,ut),q.profile&&ut(q.profile)&&Xe(R,G,q,!1,!0),et?(q.useVAO?q.drawVAO?ut(q.drawVAO)?G(R.shared.vao,".setVAO(",q.drawVAO.append(R,G),");"):B(R.shared.vao,".setVAO(",q.drawVAO.append(R,B),");"):B(R.shared.vao,".setVAO(",R.shared.vao,".targetVAO);"):(B(R.shared.vao,".setVAO(null);"),ir(R,B,q,et.attributes,it),ir(R,G,q,et.attributes,ut)),Er(R,B,q,et.uniforms,it,!1),Er(R,G,q,et.uniforms,ut,!0),Nr(R,B,G,q)):(N=R.global.def("{}"),et=q.shader.progVar.append(R,G),H=G.def(et,".id"),B=G.def(N,"[",H,"]"),G(R.shared.gl,".useProgram(",et,".program);","if(!",B,"){",B,"=",N,"[",H,"]=",R.link(function(wt){return _r(je,R,q,wt,2)}),"(",et,");}",B,".call(this,a0[",K,"],",K,");"))}function ve(R,N){function q(B){return B.contextDep&&ut||B.propDep}var et=R.proc("batch",2);R.batchId="0",De(R,et);var ut=!1,it=!0;Object.keys(N.context).forEach(function(B){ut=ut||N.context[B].propDep}),ut||(Be(R,et,N.context),it=!1);var tt=N.framebuffer,K=!1;if(tt?(tt.propDep?ut=K=!0:tt.contextDep&&ut&&(K=!0),K||fe(R,et,tt)):fe(R,et,null),N.state.viewport&&N.state.viewport.propDep&&(ut=!0),Ue(R,et,N),xn(R,et,N.state,function(B){return!q(B)}),N.profile&&q(N.profile)||Xe(R,et,N,!1,"a1"),N.contextDep=ut,N.needsContext=it,N.needsFramebuffer=K,it=N.shader.progVar,it.contextDep&&ut||it.propDep)an(R,et,N,null);else if(it=it.append(R,et),et(R.shared.gl,".useProgram(",it,".program);"),N.shader.program)an(R,et,N,N.shader.program);else{et(R.shared.vao,".setVAO(null);");var tt=R.global.def("{}"),K=et.def(it,".id"),H=et.def(tt,"[",K,"]");et(R.cond(H).then(H,".call(this,a0,a1);").else(H,"=",tt,"[",K,"]=",R.link(function(wt){return _r(an,R,N,wt,2)}),"(",it,");",H,".call(this,a0,a1);"))}0<Object.keys(N.state).length&&et(R.shared.current,".dirty=true;"),R.shared.vao&&et(R.shared.vao,".setVAO(null);")}function or(R,N){function q(tt){var K=N.shader[tt];K&&et.set(ut.shader,"."+tt,K.append(R,et))}var et=R.proc("scope",3);R.batchId="a2";var ut=R.shared,it=ut.current;Be(R,et,N.context),N.framebuffer&&N.framebuffer.append(R,et),ee(Object.keys(N.state)).forEach(function(tt){var K=N.state[tt].append(R,et);S(K)?K.forEach(function(H,B){et.set(R.next[tt],"["+B+"]",H)}):et.set(ut.next,"."+tt,K)}),Xe(R,et,N,!0,!0),["elements","offset","count","instances","primitive"].forEach(function(tt){var K=N.draw[tt];K&&et.set(ut.draw,"."+tt,""+K.append(R,et))}),Object.keys(N.uniforms).forEach(function(tt){var K=N.uniforms[tt].append(R,et);Array.isArray(K)&&(K="["+K.join()+"]"),et.set(ut.uniforms,"["+V.id(tt)+"]",K)}),Object.keys(N.attributes).forEach(function(tt){var K=N.attributes[tt].append(R,et),H=R.scopeAttrib(tt);Object.keys(new Fn).forEach(function(B){et.set(H,"."+B,K[B])})}),N.scopeVAO&&et.set(ut.vao,".targetVAO",N.scopeVAO.append(R,et)),q("vert"),q("frag"),0<Object.keys(N.state).length&&(et(it,".dirty=true;"),et.exit(it,".dirty=true;")),et("a1(",R.shared.context,",a0,",R.batchId,");")}function Di(R){if(typeof R=="object"&&!S(R)){for(var N=Object.keys(R),q=0;q<N.length;++q)if(ce.isDynamic(R[N[q]]))return!0;return!1}}function _i(R,N,q){function et(wt,At){tt.forEach(function(Zt){var zt=ut[Zt];ce.isDynamic(zt)&&(zt=wt.invoke(At,zt),At(G,".",Zt,"=",zt,";"))})}var ut=N.static[q];if(ut&&Di(ut)){var it=R.global,tt=Object.keys(ut),K=!1,H=!1,B=!1,G=R.global.def("{}");tt.forEach(function(wt){var At=ut[wt];if(ce.isDynamic(At))typeof At=="function"&&(At=ut[wt]=ce.unbox(At)),wt=Ct(At,null),K=K||wt.thisDep,B=B||wt.propDep,H=H||wt.contextDep;else{switch(it(G,".",wt,"="),typeof At){case"number":it(At);break;case"string":it('"',At,'"');break;case"object":Array.isArray(At)&&it("[",At.join(),"]");break;default:it(R.link(At))}it(";")}}),N.dynamic[q]=new ce.DynamicVariable(4,{thisDep:K,contextDep:H,propDep:B,ref:G,append:et}),delete N.static[q]}}var Fn=St.Record,qr={add:32774,subtract:32778,"reverse subtract":32779};J.ext_blend_minmax&&(qr.min=32775,qr.max=32776);var sr=J.angle_instanced_arrays,F=J.webgl_draw_buffers,pt=J.oes_vertex_array_object,X={dirty:!0,profile:bt.profile},kt={},Lt=[],Te={},Kt={};gt("dither",3024),gt("blend.enable",3042),Y("blend.color","blendColor",[0,0,0,0]),Y("blend.equation","blendEquationSeparate",[32774,32774]),Y("blend.func","blendFuncSeparate",[1,0,1,0]),gt("depth.enable",2929,!0),Y("depth.func","depthFunc",513),Y("depth.range","depthRange",[0,1]),Y("depth.mask","depthMask",!0),Y("colorMask","colorMask",[!0,!0,!0,!0]),gt("cull.enable",2884),Y("cull.face","cullFace",1029),Y("frontFace","frontFace",2305),Y("lineWidth","lineWidth",1),gt("polygonOffset.enable",32823),Y("polygonOffset.offset","polygonOffset",[0,0]),gt("sample.alpha",32926),gt("sample.enable",32928),Y("sample.coverage","sampleCoverage",[1,!1]),gt("stencil.enable",2960),Y("stencil.mask","stencilMask",-1),Y("stencil.func","stencilFunc",[519,0,-1]),Y("stencil.opFront","stencilOpSeparate",[1028,7680,7680,7680]),Y("stencil.opBack","stencilOpSeparate",[1029,7680,7680,7680]),gt("scissor.enable",3089),Y("scissor.box","scissor",[0,0,C.drawingBufferWidth,C.drawingBufferHeight]),Y("viewport","viewport",[0,0,C.drawingBufferWidth,C.drawingBufferHeight]);var Yt={gl:C,context:ht,strings:V,next:kt,current:X,draw:Q,elements:vt,buffer:ot,shader:Bt,attributes:St.state,vao:St,uniforms:Wt,framebuffer:Pt,extensions:J,timer:ct,isBufferArgs:Ht},he={primTypes:yn,compareFuncs:Pr,blendFuncs:oi,blendEquations:qr,stencilOps:Ki,glTypes:ln,orientationType:ac};F&&(he.backBuffer=[1029],he.drawBuffer=d(mt.maxDrawbuffers,function(R){return R===0?[0]:d(R,function(N){return 36064+N})}));var He=0;return{next:kt,current:X,procs:function(){var R=dt(),N=R.proc("poll"),q=R.proc("refresh"),et=R.block();N(et),q(et);var ut=R.shared,it=ut.gl,tt=ut.next,K=ut.current;et(K,".dirty=false;"),fe(R,N),fe(R,q,null,!0);var H;sr&&(H=R.link(sr)),J.oes_vertex_array_object&&q(R.link(J.oes_vertex_array_object),".bindVertexArrayOES(null);");for(var B=0;B<mt.maxAttributes;++B){var G=q.def(ut.attributes,"[",B,"]"),wt=R.cond(G,".buffer");wt.then(it,".enableVertexAttribArray(",B,");",it,".bindBuffer(",34962,",",G,".buffer.buffer);",it,".vertexAttribPointer(",B,",",G,".size,",G,".type,",G,".normalized,",G,".stride,",G,".offset);").else(it,".disableVertexAttribArray(",B,");",it,".vertexAttrib4f(",B,",",G,".x,",G,".y,",G,".z,",G,".w);",G,".buffer=null;"),q(wt),sr&&q(H,".vertexAttribDivisorANGLE(",B,",",G,".divisor);")}return q(R.shared.vao,".currentVAO=null;",R.shared.vao,".setVAO(",R.shared.vao,".targetVAO);"),Object.keys(Te).forEach(function(At){var Zt=Te[At],zt=et.def(tt,".",At),jt=R.block();jt("if(",zt,"){",it,".enable(",Zt,")}else{",it,".disable(",Zt,")}",K,".",At,"=",zt,";"),q(jt),N("if(",zt,"!==",K,".",At,"){",jt,"}")}),Object.keys(Kt).forEach(function(At){var Zt=Kt[At],zt=X[At],jt,Ut,$t=R.block();$t(it,".",Zt,"("),S(zt)?(Zt=zt.length,jt=R.global.def(tt,".",At),Ut=R.global.def(K,".",At),$t(d(Zt,function(oe){return jt+"["+oe+"]"}),");",d(Zt,function(oe){return Ut+"["+oe+"]="+jt+"["+oe+"];"}).join("")),N("if(",d(Zt,function(oe){return jt+"["+oe+"]!=="+Ut+"["+oe+"]"}).join("||"),"){",$t,"}")):(jt=et.def(tt,".",At),Ut=et.def(K,".",At),$t(jt,");",K,".",At,"=",jt,";"),N("if(",jt,"!==",Ut,"){",$t,"}")),q($t)}),R.compile()}(),compile:function(R,N,q,et,ut){var it=dt();it.stats=it.link(ut),Object.keys(N.static).forEach(function(K){_i(it,N,K)}),xo.forEach(function(K){_i(it,R,K)});var tt=me(R,N,q,et,it);return Ae(it,tt),or(it,tt),ve(it,tt),Jt(it.compile(),{destroy:function(){tt.shader.program.destroy()}})}}}function Ie(C,V){for(var J=0;J<C.length;++J)if(C[J]===V)return J;return-1}var Jt=function(C,V){for(var J=Object.keys(V),mt=0;mt<J.length;++mt)C[J[mt]]=V[J[mt]];return C},Ne=0,ce={DynamicVariable:e,define:function(C,V){return new e(C,i(V+""))},isDynamic:function(C){return typeof C=="function"&&!C._reglType||C instanceof e},unbox:o,accessor:i},ke={next:typeof requestAnimationFrame=="function"?function(C){return requestAnimationFrame(C)}:function(C){return setTimeout(C,16)},cancel:typeof cancelAnimationFrame=="function"?function(C){return cancelAnimationFrame(C)}:clearTimeout},qe=typeof performance<"u"&&performance.now?function(){return performance.now()}:function(){return+new Date},Re=g();Re.zero=g();var Je=function(C,V){var J=1;V.ext_texture_filter_anisotropic&&(J=C.getParameter(34047));var mt=1,ot=1;V.webgl_draw_buffers&&(mt=C.getParameter(34852),ot=C.getParameter(36063));var vt=!!V.oes_texture_float;if(vt){vt=C.createTexture(),C.bindTexture(3553,vt),C.texImage2D(3553,0,6408,1,1,0,6408,5126,null);var Ot=C.createFramebuffer();if(C.bindFramebuffer(36160,Ot),C.framebufferTexture2D(36160,36064,3553,vt,0),C.bindTexture(3553,null),C.checkFramebufferStatus(36160)!==36053)vt=!1;else{C.viewport(0,0,1,1),C.clearColor(1,0,0,1),C.clear(16384);var Pt=Re.allocType(5126,4);C.readPixels(0,0,1,1,6408,5126,Pt),C.getError()?vt=!1:(C.deleteFramebuffer(Ot),C.deleteTexture(vt),vt=Pt[0]===1),Re.freeType(Pt)}}return Pt=!0,typeof navigator<"u"&&(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent))||(Pt=C.createTexture(),Ot=Re.allocType(5121,36),C.activeTexture(33984),C.bindTexture(34067,Pt),C.texImage2D(34069,0,6408,3,3,0,6408,5121,Ot),Re.freeType(Ot),C.bindTexture(34067,null),C.deleteTexture(Pt),Pt=!C.getError()),{colorBits:[C.getParameter(3410),C.getParameter(3411),C.getParameter(3412),C.getParameter(3413)],depthBits:C.getParameter(3414),stencilBits:C.getParameter(3415),subpixelBits:C.getParameter(3408),extensions:Object.keys(V).filter(function(Wt){return!!V[Wt]}),maxAnisotropic:J,maxDrawbuffers:mt,maxColorAttachments:ot,pointSizeDims:C.getParameter(33901),lineWidthDims:C.getParameter(33902),maxViewportDims:C.getParameter(3386),maxCombinedTextureUnits:C.getParameter(35661),maxCubeMapSize:C.getParameter(34076),maxRenderbufferSize:C.getParameter(34024),maxTextureUnits:C.getParameter(34930),maxTextureSize:C.getParameter(3379),maxAttributes:C.getParameter(34921),maxVertexUniforms:C.getParameter(36347),maxVertexTextureUnits:C.getParameter(35660),maxVaryingVectors:C.getParameter(36348),maxFragmentUniforms:C.getParameter(36349),glsl:C.getParameter(35724),renderer:C.getParameter(7937),vendor:C.getParameter(7936),version:C.getParameter(7938),readFloat:vt,npotTextureCube:Pt}},Le=function(C){return C instanceof Uint8Array||C instanceof Uint16Array||C instanceof Uint32Array||C instanceof Int8Array||C instanceof Int16Array||C instanceof Int32Array||C instanceof Float32Array||C instanceof Float64Array||C instanceof Uint8ClampedArray},pn=function(C){return Object.keys(C).map(function(V){return C[V]})},Tn={shape:function(C){for(var V=[];C.length;C=C[0])V.push(C.length);return V},flatten:function(C,V,J,mt){var ot=1;if(V.length)for(var vt=0;vt<V.length;++vt)ot*=V[vt];else ot=0;switch(J=mt||Re.allocType(J,ot),V.length){case 0:break;case 1:for(mt=V[0],V=0;V<mt;++V)J[V]=C[V];break;case 2:for(mt=V[0],V=V[1],vt=ot=0;vt<mt;++vt)for(var Ot=C[vt],Pt=0;Pt<V;++Pt)J[ot++]=Ot[Pt];break;case 3:y(C,V[0],V[1],V[2],J,0);break;default:x(C,V,0,J,0)}return J}},nr={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},ln={int8:5120,int16:5122,int32:5124,uint8:5121,uint16:5123,uint32:5125,float:5126,float32:5126},qn={dynamic:35048,stream:35040,static:35044},hn=Tn.flatten,we=Tn.shape,Ze=[];Ze[5120]=1,Ze[5122]=2,Ze[5124]=4,Ze[5121]=1,Ze[5123]=2,Ze[5125]=4,Ze[5126]=4;var yn={points:0,point:0,lines:1,line:1,triangles:4,triangle:4,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},rn=new Float32Array(1),vr=new Uint32Array(rn.buffer),ii=[9984,9986,9985,9987],Jn=[0,6409,6410,6407,6408],Mn={};Mn[6409]=Mn[6406]=Mn[6402]=1,Mn[34041]=Mn[6410]=2,Mn[6407]=Mn[35904]=3,Mn[6408]=Mn[35906]=4;var Dn=M("HTMLCanvasElement"),Zr=M("OffscreenCanvas"),Xr=M("CanvasRenderingContext2D"),Vn=M("ImageBitmap"),Yr=M("HTMLImageElement"),Ji=M("HTMLVideoElement"),xr=Object.keys(nr).concat([Dn,Zr,Xr,Vn,Yr,Ji]),rr=[];rr[5121]=1,rr[5126]=4,rr[36193]=2,rr[5123]=2,rr[5125]=4;var Sn=[];Sn[32854]=2,Sn[32855]=2,Sn[36194]=2,Sn[34041]=4,Sn[33776]=.5,Sn[33777]=.5,Sn[33778]=1,Sn[33779]=1,Sn[35986]=.5,Sn[35987]=1,Sn[34798]=1,Sn[35840]=.5,Sn[35841]=.25,Sn[35842]=.5,Sn[35843]=.25,Sn[36196]=.5;var On=[];On[32854]=2,On[32855]=2,On[36194]=2,On[33189]=2,On[36168]=1,On[34041]=4,On[35056]=4,On[35907]=4,On[34836]=16,On[34842]=8,On[34843]=6;var Wo=function(C,V,J,mt,ot){function vt(Q){this.id=St++,this.refCount=1,this.renderbuffer=Q,this.format=32854,this.height=this.width=0,ot.profile&&(this.stats={size:0})}function Ot(Q){var ht=Q.renderbuffer;C.bindRenderbuffer(36161,null),C.deleteRenderbuffer(ht),Q.renderbuffer=null,Q.refCount=0,delete Bt[Q.id],mt.renderbufferCount--}var Pt={rgba4:32854,rgba8:32856,rgb565:36194,"rgb5 a1":32855,depth:33189,stencil:36168,"depth stencil":34041,"depth24 stencil8":35056};V.ext_srgb&&(Pt.srgba=35907),V.ext_color_buffer_half_float&&(Pt.rgba16f=34842,Pt.rgb16f=34843),V.webgl_color_buffer_float&&(Pt.rgba32f=34836);var Wt=[];Object.keys(Pt).forEach(function(Q){Wt[Pt[Q]]=Q});var St=0,Bt={};return vt.prototype.decRef=function(){0>=--this.refCount&&Ot(this)},ot.profile&&(mt.getTotalRenderbufferSize=function(){var Q=0;return Object.keys(Bt).forEach(function(ht){Q+=Bt[ht].stats.size}),Q}),{create:function(Q,ht){function ct(ft,gt){var Y=0,dt=0,_t=32854,yt=0;if(typeof ft=="object"&&ft?("shape"in ft?(dt=ft.shape,Y=dt[0]|0,dt=dt[1]|0):("radius"in ft&&(Y=dt=ft.radius|0),"width"in ft&&(Y=ft.width|0),"height"in ft&&(dt=ft.height|0)),"format"in ft&&(_t=Pt[ft.format]),"samples"in ft&&(yt=ft.samples)):typeof ft=="number"?(Y=ft|0,dt=typeof gt=="number"?gt|0:Y):ft||(Y=dt=1),Y!==bt.width||dt!==bt.height||_t!==bt.format)return ct.width=bt.width=Y,ct.height=bt.height=dt,ct.samples=yt,bt.format=_t,bt.samples=yt,C.bindRenderbuffer(36161,bt.renderbuffer),yt&&C.renderbufferStorageMultisample?C.renderbufferStorageMultisample(36161,yt,_t,Y,dt):C.renderbufferStorage(36161,_t,Y,dt),ot.profile&&(bt.stats.size=On[bt.format]*bt.width*bt.height),ct.format=Wt[bt.format],ct}var bt=new vt(C.createRenderbuffer());return Bt[bt.id]=bt,mt.renderbufferCount++,ct(Q,ht),ct.resize=function(ft,gt){var Y=ft|0,dt=gt|0||Y;if(Y===bt.width&&dt===bt.height)return ct;ct.width=bt.width=Y,ct.height=bt.height=dt;var _t=ct.samples;return C.bindRenderbuffer(36161,bt.renderbuffer),_t&&C.renderbufferStorageMultisample?C.renderbufferStorageMultisample(36161,_t,bt.format,Y,dt):C.renderbufferStorage(36161,bt.format,Y,dt),ot.profile&&(bt.stats.size=On[bt.format]*bt.width*bt.height),ct},ct._reglType="renderbuffer",ct._renderbuffer=bt,ot.profile&&(ct.stats=bt.stats),ct.destroy=function(){bt.decRef()},ct},clear:function(){pn(Bt).forEach(Ot)},restore:function(){pn(Bt).forEach(function(Q){Q.renderbuffer=C.createRenderbuffer(),C.bindRenderbuffer(36161,Q.renderbuffer),Q.samples&&C.renderbufferStorageMultisample?C.renderbufferStorageMultisample(36161,Q.samples,Q.format,Q.width,Q.height):C.renderbufferStorage(36161,Q.format,Q.width,Q.height)}),C.bindRenderbuffer(36161,null)}}},Zo=[];Zo[6408]=4,Zo[6407]=3;var vo=[];vo[5121]=1,vo[5126]=4,vo[36193]=2;var Hr=["x","y","z","w"],xo="blend.func blend.equation stencil.func stencil.opFront stencil.opBack sample.coverage viewport scissor.box polygonOffset.offset".split(" "),oi={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},Pr={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},Ki={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},ac={cw:2304,ccw:2305},pa=new nt(!1,!1,!1,function(){}),Op=function(C,V){function J(){this.endQueryIndex=this.startQueryIndex=-1,this.sum=0,this.stats=null}function mt(Bt,Q,ht){var ct=Ot.pop()||new J;ct.startQueryIndex=Bt,ct.endQueryIndex=Q,ct.sum=0,ct.stats=ht,Pt.push(ct)}if(!V.ext_disjoint_timer_query)return null;var ot=[],vt=[],Ot=[],Pt=[],Wt=[],St=[];return{beginQuery:function(Bt){var Q=ot.pop()||V.ext_disjoint_timer_query.createQueryEXT();V.ext_disjoint_timer_query.beginQueryEXT(35007,Q),vt.push(Q),mt(vt.length-1,vt.length,Bt)},endQuery:function(){V.ext_disjoint_timer_query.endQueryEXT(35007)},pushScopeStats:mt,update:function(){var Bt,Q;if(Bt=vt.length,Bt!==0){St.length=Math.max(St.length,Bt+1),Wt.length=Math.max(Wt.length,Bt+1),Wt[0]=0;var ht=St[0]=0;for(Q=Bt=0;Q<vt.length;++Q){var ct=vt[Q];V.ext_disjoint_timer_query.getQueryObjectEXT(ct,34919)?(ht+=V.ext_disjoint_timer_query.getQueryObjectEXT(ct,34918),ot.push(ct)):vt[Bt++]=ct,Wt[Q+1]=ht,St[Q+1]=Bt}for(vt.length=Bt,Q=Bt=0;Q<Pt.length;++Q){var ht=Pt[Q],bt=ht.startQueryIndex,ct=ht.endQueryIndex;ht.sum+=Wt[ct]-Wt[bt],bt=St[bt],ct=St[ct],ct===bt?(ht.stats.gpuTime+=ht.sum/1e6,Ot.push(ht)):(ht.startQueryIndex=bt,ht.endQueryIndex=ct,Pt[Bt++]=ht)}Pt.length=Bt}},getNumPendingQueries:function(){return vt.length},clear:function(){ot.push.apply(ot,vt);for(var Bt=0;Bt<ot.length;Bt++)V.ext_disjoint_timer_query.deleteQueryEXT(ot[Bt]);vt.length=0,ot.length=0},restore:function(){vt.length=0,ot.length=0}}};return function(C){function V(){if(Xe.length===0)dt&&dt.update(),_r=null;else{_r=ke.next(V),Bt();for(var Ae=Xe.length-1;0<=Ae;--Ae){var je=Xe[Ae];je&&je(ae,null,0)}ct.flush(),dt&&dt.update()}}function J(){!_r&&0<Xe.length&&(_r=ke.next(V))}function mt(){_r&&(ke.cancel(V),_r=null)}function ot(Ae){Ae.preventDefault(),mt(),ir.forEach(function(je){je()})}function vt(Ae){ct.getError(),ft.restore(),ne.restore(),$e.restore(),Nt.restore(),me.restore(),Be.restore(),ye.restore(),dt&&dt.restore(),fe.procs.refresh(),J(),Er.forEach(function(je){je()})}function Ot(Ae){function je(X,kt){var Lt={},Te={};return Object.keys(X).forEach(function(Kt){var Yt=X[Kt];if(ce.isDynamic(Yt))Te[Kt]=ce.unbox(Yt,Kt);else{if(kt&&Array.isArray(Yt)){for(var he=0;he<Yt.length;++he)if(ce.isDynamic(Yt[he])){Te[Kt]=ce.unbox(Yt,Kt);return}}Lt[Kt]=Yt}}),{dynamic:Te,static:Lt}}function an(X){for(;pt.length<X;)pt.push(null);return pt}var ve=je(Ae.context||{},!0),or=je(Ae.uniforms||{},!0),Di=je(Ae.attributes||{},!1);Ae=je(function(X){function kt(Te){if(Te in Lt){var Kt=Lt[Te];delete Lt[Te],Object.keys(Kt).forEach(function(Yt){Lt[Te+"."+Yt]=Kt[Yt]})}}var Lt=Jt({},X);return delete Lt.uniforms,delete Lt.attributes,delete Lt.context,delete Lt.vao,"stencil"in Lt&&Lt.stencil.op&&(Lt.stencil.opBack=Lt.stencil.opFront=Lt.stencil.op,delete Lt.stencil.op),kt("blend"),kt("depth"),kt("cull"),kt("stencil"),kt("polygonOffset"),kt("scissor"),kt("sample"),"vao"in X&&(Lt.vao=X.vao),Lt}(Ae),!1);var _i={gpuTime:0,cpuTime:0,count:0},Fn=fe.compile(Ae,Di,or,ve,_i),qr=Fn.draw,sr=Fn.batch,F=Fn.scope,pt=[];return Jt(function(X,kt){var Lt;if(typeof X=="function")return F.call(this,null,X,0);if(typeof kt=="function")if(typeof X=="number")for(Lt=0;Lt<X;++Lt)F.call(this,null,kt,Lt);else if(Array.isArray(X))for(Lt=0;Lt<X.length;++Lt)F.call(this,X[Lt],kt,Lt);else return F.call(this,X,kt,0);else if(typeof X=="number"){if(0<X)return sr.call(this,an(X|0),X|0)}else if(Array.isArray(X)){if(X.length)return sr.call(this,X,X.length)}else return qr.call(this,X)},{stats:_i,destroy:function(){Fn.destroy()}})}function Pt(Ae,je){var an=0;fe.procs.poll();var ve=je.color;ve&&(ct.clearColor(+ve[0]||0,+ve[1]||0,+ve[2]||0,+ve[3]||0),an|=16384),"depth"in je&&(ct.clearDepth(+je.depth),an|=256),"stencil"in je&&(ct.clearStencil(je.stencil|0),an|=1024),ct.clear(an)}function Wt(Ae){return Xe.push(Ae),J(),{cancel:function(){function je(){var ve=Ie(Xe,je);Xe[ve]=Xe[Xe.length-1],--Xe.length,0>=Xe.length&&mt()}var an=Ie(Xe,Ae);Xe[an]=je}}}function St(){var Ae=xn.viewport,je=xn.scissor_box;Ae[0]=Ae[1]=je[0]=je[1]=0,ae.viewportWidth=ae.framebufferWidth=ae.drawingBufferWidth=Ae[2]=je[2]=ct.drawingBufferWidth,ae.viewportHeight=ae.framebufferHeight=ae.drawingBufferHeight=Ae[3]=je[3]=ct.drawingBufferHeight}function Bt(){ae.tick+=1,ae.time=ht(),St(),fe.procs.poll()}function Q(){Nt.refresh(),St(),fe.procs.refresh(),dt&&dt.update()}function ht(){return(qe()-_t)/1e3}if(C=c(C),!C)return null;var ct=C.gl,bt=ct.getContextAttributes();ct.isContextLost();var ft=f(ct,C);if(!ft)return null;var Ue=s(),gt={vaoCount:0,bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0},Y=ft.extensions,dt=Op(ct,Y),_t=qe(),Ke=ct.drawingBufferWidth,yt=ct.drawingBufferHeight,ae={tick:0,time:0,viewportWidth:Ke,viewportHeight:yt,framebufferWidth:Ke,framebufferHeight:yt,drawingBufferWidth:Ke,drawingBufferHeight:yt,pixelRatio:C.pixelRatio},Ke={elements:null,primitive:4,count:-1,offset:0,instances:-1},vn=Je(ct,Y),$e=b(ct,gt,C,function(Ae){return ye.destroyBuffer(Ae)}),xt=A(ct,Y,$e,gt),ye=Z(ct,Y,vn,gt,$e,xt,Ke),ne=j(ct,Ue,gt,C),Nt=z(ct,Y,vn,function(){fe.procs.poll()},ae,gt,C),me=Wo(ct,Y,vn,gt,C),Be=L(ct,Y,vn,Nt,me,gt),fe=_e(ct,Ue,Y,vn,$e,xt,Nt,Be,{},ye,ne,Ke,ae,dt,C),Ue=st(ct,Be,fe.procs.poll,ae),xn=fe.next,De=ct.canvas,Xe=[],ir=[],Er=[],Nr=[C.onDestroy],_r=null;De&&(De.addEventListener("webglcontextlost",ot,!1),De.addEventListener("webglcontextrestored",vt,!1));var si=Be.setFBO=Ot({framebuffer:ce.define.call(null,1,"framebuffer")});return Q(),bt=Jt(Ot,{clear:function(Ae){if("framebuffer"in Ae)if(Ae.framebuffer&&Ae.framebuffer_reglType==="framebufferCube")for(var je=0;6>je;++je)si(Jt({framebuffer:Ae.framebuffer.faces[je]},Ae),Pt);else si(Ae,Pt);else Pt(null,Ae)},prop:ce.define.bind(null,1),context:ce.define.bind(null,2),this:ce.define.bind(null,3),draw:Ot({}),buffer:function(Ae){return $e.create(Ae,34962,!1,!1)},elements:function(Ae){return xt.create(Ae,!1)},texture:Nt.create2D,cube:Nt.createCube,renderbuffer:me.create,framebuffer:Be.create,framebufferCube:Be.createCube,vao:ye.createVAO,attributes:bt,frame:Wt,on:function(Ae,je){var an;switch(Ae){case"frame":return Wt(je);case"lost":an=ir;break;case"restore":an=Er;break;case"destroy":an=Nr}return an.push(je),{cancel:function(){for(var ve=0;ve<an.length;++ve)if(an[ve]===je){an[ve]=an[an.length-1],an.pop();break}}}},limits:vn,hasExtension:function(Ae){return 0<=vn.extensions.indexOf(Ae.toLowerCase())},read:Ue,destroy:function(){Xe.length=0,mt(),De&&(De.removeEventListener("webglcontextlost",ot),De.removeEventListener("webglcontextrestored",vt)),ne.clear(),Be.clear(),me.clear(),ye.clear(),Nt.clear(),xt.clear(),$e.clear(),dt&&dt.clear(),Nr.forEach(function(Ae){Ae()})},_gl:ct,_refresh:Q,poll:function(){Bt(),dt&&dt.update()},now:ht,stats:gt,blit:Be.blit}),C.onDone(null,bt),bt}})})(Gb);var Ub=Gb.exports;const Xh=Us(Ub);var ci=1e-6,ti=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var r=0,t=arguments.length;t--;)r+=arguments[t]*arguments[t];return Math.sqrt(r)});function HR(r,t,e,n,i){return r[0]=t,r[1]=e,r[2]=n,r[3]=i,r}function NR(r,t){var e=Math.sin(t),n=Math.cos(t);return r[0]=n,r[1]=e,r[2]=-e,r[3]=n,r}function BR(){var r=new ti(9);return ti!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}function Yh(r,t){return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[4],r[4]=t[5],r[5]=t[6],r[6]=t[8],r[7]=t[9],r[8]=t[10],r}function Bm(r,t){var e=Math.sin(t),n=Math.cos(t);return r[0]=n,r[1]=e,r[2]=0,r[3]=-e,r[4]=n,r[5]=0,r[6]=0,r[7]=0,r[8]=1,r}function jR(){var r=new ti(16);return ti!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0),r[0]=1,r[5]=1,r[10]=1,r[15]=1,r}function io(r,t){return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r[4]=t[4],r[5]=t[5],r[6]=t[6],r[7]=t[7],r[8]=t[8],r[9]=t[9],r[10]=t[10],r[11]=t[11],r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15],r}function mn(r){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function $b(r,t){if(r===t){var e=t[1],n=t[2],i=t[3],o=t[6],s=t[7],a=t[11];r[1]=t[4],r[2]=t[8],r[3]=t[12],r[4]=e,r[6]=t[9],r[7]=t[13],r[8]=n,r[9]=o,r[11]=t[14],r[12]=i,r[13]=s,r[14]=a}else r[0]=t[0],r[1]=t[4],r[2]=t[8],r[3]=t[12],r[4]=t[1],r[5]=t[5],r[6]=t[9],r[7]=t[13],r[8]=t[2],r[9]=t[6],r[10]=t[10],r[11]=t[14],r[12]=t[3],r[13]=t[7],r[14]=t[11],r[15]=t[15];return r}function $s(r,t){var e=t[0],n=t[1],i=t[2],o=t[3],s=t[4],a=t[5],l=t[6],h=t[7],u=t[8],c=t[9],f=t[10],d=t[11],p=t[12],g=t[13],m=t[14],y=t[15],x=e*a-n*s,v=e*l-i*s,_=e*h-o*s,w=n*l-i*a,b=n*h-o*a,A=i*h-o*l,T=u*g-c*p,S=u*m-f*p,M=u*y-d*p,E=c*m-f*g,P=c*y-d*g,k=f*y-d*m,O=x*k-v*P+_*E+w*M-b*S+A*T;return O?(O=1/O,r[0]=(a*k-l*P+h*E)*O,r[1]=(i*P-n*k-o*E)*O,r[2]=(g*A-m*b+y*w)*O,r[3]=(f*b-c*A-d*w)*O,r[4]=(l*M-s*k-h*S)*O,r[5]=(e*k-i*M+o*S)*O,r[6]=(m*_-p*A-y*v)*O,r[7]=(u*A-f*_+d*v)*O,r[8]=(s*P-a*M+h*T)*O,r[9]=(n*M-e*P-o*T)*O,r[10]=(p*b-g*_+y*x)*O,r[11]=(c*_-u*b-d*x)*O,r[12]=(a*S-s*E-l*T)*O,r[13]=(e*E-n*S+i*T)*O,r[14]=(g*v-p*w-m*x)*O,r[15]=(u*w-c*v+f*x)*O,r):null}function qt(r,t,e){var n=t[0],i=t[1],o=t[2],s=t[3],a=t[4],l=t[5],h=t[6],u=t[7],c=t[8],f=t[9],d=t[10],p=t[11],g=t[12],m=t[13],y=t[14],x=t[15],v=e[0],_=e[1],w=e[2],b=e[3];return r[0]=v*n+_*a+w*c+b*g,r[1]=v*i+_*l+w*f+b*m,r[2]=v*o+_*h+w*d+b*y,r[3]=v*s+_*u+w*p+b*x,v=e[4],_=e[5],w=e[6],b=e[7],r[4]=v*n+_*a+w*c+b*g,r[5]=v*i+_*l+w*f+b*m,r[6]=v*o+_*h+w*d+b*y,r[7]=v*s+_*u+w*p+b*x,v=e[8],_=e[9],w=e[10],b=e[11],r[8]=v*n+_*a+w*c+b*g,r[9]=v*i+_*l+w*f+b*m,r[10]=v*o+_*h+w*d+b*y,r[11]=v*s+_*u+w*p+b*x,v=e[12],_=e[13],w=e[14],b=e[15],r[12]=v*n+_*a+w*c+b*g,r[13]=v*i+_*l+w*f+b*m,r[14]=v*o+_*h+w*d+b*y,r[15]=v*s+_*u+w*p+b*x,r}function oo(r,t,e){var n=e[0],i=e[1],o=e[2],s,a,l,h,u,c,f,d,p,g,m,y;return t===r?(r[12]=t[0]*n+t[4]*i+t[8]*o+t[12],r[13]=t[1]*n+t[5]*i+t[9]*o+t[13],r[14]=t[2]*n+t[6]*i+t[10]*o+t[14],r[15]=t[3]*n+t[7]*i+t[11]*o+t[15]):(s=t[0],a=t[1],l=t[2],h=t[3],u=t[4],c=t[5],f=t[6],d=t[7],p=t[8],g=t[9],m=t[10],y=t[11],r[0]=s,r[1]=a,r[2]=l,r[3]=h,r[4]=u,r[5]=c,r[6]=f,r[7]=d,r[8]=p,r[9]=g,r[10]=m,r[11]=y,r[12]=s*n+u*i+p*o+t[12],r[13]=a*n+c*i+g*o+t[13],r[14]=l*n+f*i+m*o+t[14],r[15]=h*n+d*i+y*o+t[15]),r}function so(r,t,e){var n=e[0],i=e[1],o=e[2];return r[0]=t[0]*n,r[1]=t[1]*n,r[2]=t[2]*n,r[3]=t[3]*n,r[4]=t[4]*i,r[5]=t[5]*i,r[6]=t[6]*i,r[7]=t[7]*i,r[8]=t[8]*o,r[9]=t[9]*o,r[10]=t[10]*o,r[11]=t[11]*o,r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15],r}function VR(r,t,e,n){var i=n[0],o=n[1],s=n[2],a=Math.hypot(i,o,s),l,h,u,c,f,d,p,g,m,y,x,v,_,w,b,A,T,S,M,E,P,k,O,I;return a<ci?null:(a=1/a,i*=a,o*=a,s*=a,l=Math.sin(e),h=Math.cos(e),u=1-h,c=t[0],f=t[1],d=t[2],p=t[3],g=t[4],m=t[5],y=t[6],x=t[7],v=t[8],_=t[9],w=t[10],b=t[11],A=i*i*u+h,T=o*i*u+s*l,S=s*i*u-o*l,M=i*o*u-s*l,E=o*o*u+h,P=s*o*u+i*l,k=i*s*u+o*l,O=o*s*u-i*l,I=s*s*u+h,r[0]=c*A+g*T+v*S,r[1]=f*A+m*T+_*S,r[2]=d*A+y*T+w*S,r[3]=p*A+x*T+b*S,r[4]=c*M+g*E+v*P,r[5]=f*M+m*E+_*P,r[6]=d*M+y*E+w*P,r[7]=p*M+x*E+b*P,r[8]=c*k+g*O+v*I,r[9]=f*k+m*O+_*I,r[10]=d*k+y*O+w*I,r[11]=p*k+x*O+b*I,t!==r&&(r[12]=t[12],r[13]=t[13],r[14]=t[14],r[15]=t[15]),r)}function qh(r,t){return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=t[0],r[13]=t[1],r[14]=t[2],r[15]=1,r}function Ws(r,t){return r[0]=t[0],r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t[1],r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=t[2],r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function GR(r,t,e){var n=e[0],i=e[1],o=e[2],s=Math.hypot(n,i,o),a,l,h;return s<ci?null:(s=1/s,n*=s,i*=s,o*=s,a=Math.sin(t),l=Math.cos(t),h=1-l,r[0]=n*n*h+l,r[1]=i*n*h+o*a,r[2]=o*n*h-i*a,r[3]=0,r[4]=n*i*h-o*a,r[5]=i*i*h+l,r[6]=o*i*h+n*a,r[7]=0,r[8]=n*o*h+i*a,r[9]=i*o*h-n*a,r[10]=o*o*h+l,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r)}function jm(r,t,e){var n=t[0],i=t[1],o=t[2],s=t[3],a=n+n,l=i+i,h=o+o,u=n*a,c=n*l,f=n*h,d=i*l,p=i*h,g=o*h,m=s*a,y=s*l,x=s*h;return r[0]=1-(d+g),r[1]=c+x,r[2]=f-y,r[3]=0,r[4]=c-x,r[5]=1-(u+g),r[6]=p+m,r[7]=0,r[8]=f+y,r[9]=p-m,r[10]=1-(u+d),r[11]=0,r[12]=e[0],r[13]=e[1],r[14]=e[2],r[15]=1,r}function UR(r,t){return r[0]=t[12],r[1]=t[13],r[2]=t[14],r}function Wb(r,t){var e=t[0],n=t[1],i=t[2],o=t[4],s=t[5],a=t[6],l=t[8],h=t[9],u=t[10];return r[0]=Math.hypot(e,n,i),r[1]=Math.hypot(o,s,a),r[2]=Math.hypot(l,h,u),r}function $R(r,t){var e=new ti(3);Wb(e,t);var n=1/e[0],i=1/e[1],o=1/e[2],s=t[0]*n,a=t[1]*i,l=t[2]*o,h=t[4]*n,u=t[5]*i,c=t[6]*o,f=t[8]*n,d=t[9]*i,p=t[10]*o,g=s+u+p,m=0;return g>0?(m=Math.sqrt(g+1)*2,r[3]=.25*m,r[0]=(c-d)/m,r[1]=(f-l)/m,r[2]=(a-h)/m):s>u&&s>p?(m=Math.sqrt(1+s-u-p)*2,r[3]=(c-d)/m,r[0]=.25*m,r[1]=(a+h)/m,r[2]=(f+l)/m):u>p?(m=Math.sqrt(1+u-s-p)*2,r[3]=(f-l)/m,r[0]=(a+h)/m,r[1]=.25*m,r[2]=(c+d)/m):(m=Math.sqrt(1+p-s-u)*2,r[3]=(a-h)/m,r[0]=(f+l)/m,r[1]=(c+d)/m,r[2]=.25*m),r}function $a(r,t,e,n){var i=t[0],o=t[1],s=t[2],a=t[3],l=i+i,h=o+o,u=s+s,c=i*l,f=i*h,d=i*u,p=o*h,g=o*u,m=s*u,y=a*l,x=a*h,v=a*u,_=n[0],w=n[1],b=n[2];return r[0]=(1-(p+m))*_,r[1]=(f+v)*_,r[2]=(d-x)*_,r[3]=0,r[4]=(f-v)*w,r[5]=(1-(c+m))*w,r[6]=(g+y)*w,r[7]=0,r[8]=(d+x)*b,r[9]=(g-y)*b,r[10]=(1-(c+p))*b,r[11]=0,r[12]=e[0],r[13]=e[1],r[14]=e[2],r[15]=1,r}function Zb(r,t){var e=t[0],n=t[1],i=t[2],o=t[3],s=e+e,a=n+n,l=i+i,h=e*s,u=n*s,c=n*a,f=i*s,d=i*a,p=i*l,g=o*s,m=o*a,y=o*l;return r[0]=1-c-p,r[1]=u+y,r[2]=f-m,r[3]=0,r[4]=u-y,r[5]=1-h-p,r[6]=d+g,r[7]=0,r[8]=f+m,r[9]=d-g,r[10]=1-h-c,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r}function WR(r,t,e,n,i){var o=1/Math.tan(t/2),s;return r[0]=o/e,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=o,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[11]=-1,r[12]=0,r[13]=0,r[15]=0,i!=null&&i!==1/0?(s=1/(n-i),r[10]=(i+n)*s,r[14]=2*i*n*s):(r[10]=-1,r[14]=-2*n),r}var ZR=WR;function XR(r,t,e,n,i,o,s){var a=1/(t-e),l=1/(n-i),h=1/(o-s);return r[0]=-2*a,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-2*l,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=2*h,r[11]=0,r[12]=(t+e)*a,r[13]=(i+n)*l,r[14]=(s+o)*h,r[15]=1,r}var YR=XR;function Zs(r,t,e,n){var i,o,s,a,l,h,u,c,f,d,p=t[0],g=t[1],m=t[2],y=n[0],x=n[1],v=n[2],_=e[0],w=e[1],b=e[2];return Math.abs(p-_)<ci&&Math.abs(g-w)<ci&&Math.abs(m-b)<ci?mn(r):(u=p-_,c=g-w,f=m-b,d=1/Math.hypot(u,c,f),u*=d,c*=d,f*=d,i=x*f-v*c,o=v*u-y*f,s=y*c-x*u,d=Math.hypot(i,o,s),d?(d=1/d,i*=d,o*=d,s*=d):(i=0,o=0,s=0),a=c*s-f*o,l=f*i-u*s,h=u*o-c*i,d=Math.hypot(a,l,h),d?(d=1/d,a*=d,l*=d,h*=d):(a=0,l=0,h=0),r[0]=i,r[1]=a,r[2]=u,r[3]=0,r[4]=o,r[5]=l,r[6]=c,r[7]=0,r[8]=s,r[9]=h,r[10]=f,r[11]=0,r[12]=-(i*p+o*g+s*m),r[13]=-(a*p+l*g+h*m),r[14]=-(u*p+c*g+f*m),r[15]=1,r)}function df(r,t){return r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2]&&r[3]===t[3]&&r[4]===t[4]&&r[5]===t[5]&&r[6]===t[6]&&r[7]===t[7]&&r[8]===t[8]&&r[9]===t[9]&&r[10]===t[10]&&r[11]===t[11]&&r[12]===t[12]&&r[13]===t[13]&&r[14]===t[14]&&r[15]===t[15]}var qR=qt;function Xb(){var r=new ti(3);return ti!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function Wa(r){var t=r[0],e=r[1],n=r[2];return Math.hypot(t,e,n)}function Yb(r,t,e){var n=new ti(3);return n[0]=r,n[1]=t,n[2]=e,n}function Ar(r,t){return r[0]=t[0],r[1]=t[1],r[2]=t[2],r}function ie(r,t,e,n){return r[0]=t,r[1]=e,r[2]=n,r}function os(r,t,e){return r[0]=t[0]+e[0],r[1]=t[1]+e[1],r[2]=t[2]+e[2],r}function JR(r,t,e){return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],r}function Vm(r,t,e){return r[0]=t[0]*e[0],r[1]=t[1]*e[1],r[2]=t[2]*e[2],r}function Xs(r,t,e){return r[0]=t[0]*e,r[1]=t[1]*e,r[2]=t[2]*e,r}function qb(r,t,e,n){return r[0]=t[0]+e[0]*n,r[1]=t[1]+e[1]*n,r[2]=t[2]+e[2]*n,r}function KR(r,t){var e=t[0]-r[0],n=t[1]-r[1],i=t[2]-r[2];return Math.hypot(e,n,i)}function Za(r,t){var e=t[0],n=t[1],i=t[2],o=e*e+n*n+i*i;return o>0&&(o=1/Math.sqrt(o)),r[0]=t[0]*o,r[1]=t[1]*o,r[2]=t[2]*o,r}function Jb(r,t){return r[0]*t[0]+r[1]*t[1]+r[2]*t[2]}function Ys(r,t,e){var n=t[0],i=t[1],o=t[2],s=e[0],a=e[1],l=e[2];return r[0]=i*l-o*a,r[1]=o*s-n*l,r[2]=n*a-i*s,r}function Xa(r,t,e){var n=t[0],i=t[1],o=t[2],s=e[3]*n+e[7]*i+e[11]*o+e[15];return s=s||1,r[0]=(e[0]*n+e[4]*i+e[8]*o+e[12])/s,r[1]=(e[1]*n+e[5]*i+e[9]*o+e[13])/s,r[2]=(e[2]*n+e[6]*i+e[10]*o+e[14])/s,r}function Ya(r,t){var e=r[0],n=r[1],i=r[2],o=t[0],s=t[1],a=t[2];return Math.abs(e-o)<=ci*Math.max(1,Math.abs(e),Math.abs(o))&&Math.abs(n-s)<=ci*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(i-a)<=ci*Math.max(1,Math.abs(i),Math.abs(a))}var Co=JR,qa=KR,QR=Wa;(function(){var r=Xb();return function(t,e,n,i,o,s){var a,l;for(e||(e=3),n||(n=0),i?l=Math.min(i*e+n,t.length):l=t.length,a=n;a<l;a+=e)r[0]=t[a],r[1]=t[a+1],r[2]=t[a+2],o(r,r,s),t[a]=r[0],t[a+1]=r[1],t[a+2]=r[2];return t}})();function t4(){var r=new ti(4);return ti!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function pf(r,t){return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],r}function Tr(r,t,e,n,i){return r[0]=t,r[1]=e,r[2]=n,r[3]=i,r}function e4(r,t,e){return r[0]=t[0]/e[0],r[1]=t[1]/e[1],r[2]=t[2]/e[2],r[3]=t[3]/e[3],r}function Jh(r,t,e){return r[0]=t[0]*e,r[1]=t[1]*e,r[2]=t[2]*e,r[3]=t[3]*e,r}function n4(r,t){var e=t[0],n=t[1],i=t[2],o=t[3],s=e*e+n*n+i*i+o*o;return s>0&&(s=1/Math.sqrt(s)),r[0]=e*s,r[1]=n*s,r[2]=i*s,r[3]=o*s,r}function ss(r,t,e){var n=t[0],i=t[1],o=t[2],s=t[3];return r[0]=e[0]*n+e[4]*i+e[8]*o+e[12]*s,r[1]=e[1]*n+e[5]*i+e[9]*o+e[13]*s,r[2]=e[2]*n+e[6]*i+e[10]*o+e[14]*s,r[3]=e[3]*n+e[7]*i+e[11]*o+e[15]*s,r}function r4(r,t){return r[0]===t[0]&&r[1]===t[1]&&r[2]===t[2]&&r[3]===t[3]}function i4(r,t){var e=r[0],n=r[1],i=r[2],o=r[3],s=t[0],a=t[1],l=t[2],h=t[3];return Math.abs(e-s)<=ci*Math.max(1,Math.abs(e),Math.abs(s))&&Math.abs(n-a)<=ci*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(i-l)<=ci*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(o-h)<=ci*Math.max(1,Math.abs(o),Math.abs(h))}(function(){var r=t4();return function(t,e,n,i,o,s){var a,l;for(e||(e=4),n||(n=0),i?l=Math.min(i*e+n,t.length):l=t.length,a=n;a<l;a+=e)r[0]=t[a],r[1]=t[a+1],r[2]=t[a+2],r[3]=t[a+3],o(r,r,s),t[a]=r[0],t[a+1]=r[1],t[a+2]=r[2],t[a+3]=r[3];return t}})();function Kb(){var r=new ti(4);return ti!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r[3]=1,r}function Qb(r){return r[0]=0,r[1]=0,r[2]=0,r[3]=1,r}function tw(r,t,e){e=e*.5;var n=Math.sin(e);return r[0]=n*t[0],r[1]=n*t[1],r[2]=n*t[2],r[3]=Math.cos(e),r}function gf(r,t,e,n){var i=t[0],o=t[1],s=t[2],a=t[3],l=e[0],h=e[1],u=e[2],c=e[3],f,d,p,g,m;return d=i*l+o*h+s*u+a*c,d<0&&(d=-d,l=-l,h=-h,u=-u,c=-c),1-d>ci?(f=Math.acos(d),p=Math.sin(f),g=Math.sin((1-n)*f)/p,m=Math.sin(n*f)/p):(g=1-n,m=n),r[0]=g*i+m*l,r[1]=g*o+m*h,r[2]=g*s+m*u,r[3]=g*a+m*c,r}function o4(r,t){var e=t[0]+t[4]+t[8],n;if(e>0)n=Math.sqrt(e+1),r[3]=.5*n,n=.5/n,r[0]=(t[5]-t[7])*n,r[1]=(t[6]-t[2])*n,r[2]=(t[1]-t[3])*n;else{var i=0;t[4]>t[0]&&(i=1),t[8]>t[i*3+i]&&(i=2);var o=(i+1)%3,s=(i+2)%3;n=Math.sqrt(t[i*3+i]-t[o*3+o]-t[s*3+s]+1),r[i]=.5*n,n=.5/n,r[3]=(t[o*3+s]-t[s*3+o])*n,r[o]=(t[o*3+i]+t[i*3+o])*n,r[s]=(t[s*3+i]+t[i*3+s])*n}return r}function qs(r,t,e,n){var i=.5*Math.PI/180;t*=i,e*=i,n*=i;var o=Math.sin(t),s=Math.cos(t),a=Math.sin(e),l=Math.cos(e),h=Math.sin(n),u=Math.cos(n);return r[0]=o*l*u-s*a*h,r[1]=s*a*u+o*l*h,r[2]=s*l*h-o*a*u,r[3]=s*l*u+o*a*h,r}var ew=pf,nw=n4,s4=i4;(function(){var r=Xb(),t=Yb(1,0,0),e=Yb(0,1,0);return function(n,i,o){var s=Jb(i,o);return s<-.999999?(Ys(r,t,i),QR(r)<1e-6&&Ys(r,e,i),Za(r,r),tw(n,r,Math.PI),n):s>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(Ys(r,i,o),n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=1+s,nw(n,n))}})(),function(){var r=Kb(),t=Kb();return function(e,n,i,o,s,a){return gf(r,n,s,a),gf(t,i,o,a),gf(e,r,t,2*a*(1-a)),e}}(),function(){var r=BR();return function(t,e,n,i){return r[0]=n[0],r[3]=n[1],r[6]=n[2],r[1]=i[0],r[4]=i[1],r[7]=i[2],r[2]=-e[0],r[5]=-e[1],r[8]=-e[2],nw(t,o4(t,r))}}();function a4(){var r=new ti(2);return ti!=Float32Array&&(r[0]=0,r[1]=0),r}function rw(r,t){return r[0]=t[0],r[1]=t[1],r}function Pe(r,t,e){return r[0]=t,r[1]=e,r}function iw(r,t,e){return r[0]=t[0]+e[0],r[1]=t[1]+e[1],r}function hr(r,t,e){return r[0]=t[0]*e[0],r[1]=t[1]*e[1],r}function fi(r,t,e){return r[0]=t[0]*e,r[1]=t[1]*e,r}function mf(r,t){var e=t[0]-r[0],n=t[1]-r[1];return Math.hypot(e,n)}function Ui(r,t,e){var n=t[0],i=t[1];return r[0]=e[0]*n+e[2]*i,r[1]=e[1]*n+e[3]*i,r}function l4(r,t,e,n){var i=t[0]-e[0],o=t[1]-e[1],s=Math.sin(n),a=Math.cos(n);return r[0]=i*a-o*s+e[0],r[1]=i*s+o*a+e[1],r}var yf=hr;(function(){var r=a4();return function(t,e,n,i,o,s){var a,l;for(e||(e=2),n||(n=0),i?l=Math.min(i*e+n,t.length):l=t.length,a=n;a<l;a+=e)r[0]=t[a],r[1]=t[a+1],o(r,r,s),t[a]=r[0],t[a+1]=r[1];return t}})();/*!
 * @maptalks/gltf-loader v0.98.2
 * LICENSE : UNLICENSED
 * (c) 2016-2024 maptalks.org
 */let h4=0;function ow(r){return r==null}function In(r){return!ow(r)}function sw(r){return!ow(r)&&(typeof r=="string"||r.constructor!==null&&r.constructor===String)}function vf(r){for(let t=1;t<arguments.length;t++){const e=arguments[t];for(const n in e)r[n]=e[n]}return r}function Gm(r){switch(r){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array}throw new Error("unsupported bufferView's component type: "+r)}function Um(r){return r.indexOf("data:")===0&&r.indexOf("base64,")>0}function $m(r){const t=function(i){return typeof self<"u"?self.atob(i):window.atob(i)}(r.substring(r.indexOf(",")+1)),e=t.length,n=new Uint8Array(e);for(let i=0;i<e;i++)n[i]=t.charCodeAt(i);return n.buffer}const u4=[],c4=[],f4=[],d4=[0,0,0],p4=Qb([]),g4=[1,1,1];function aw(r,t,e,n,i,o,s){const a=Gm(s),l=a.BYTES_PER_ELEMENT;if((i===0||i===n*l)&&o%l==0){const u=new a(t,o,e*n);return r.set(u),r}i===0&&(i=n*l);const h=new Uint8Array(n*l);for(let u=0;u<e;u++){let c=null;const f=new Uint8Array(t,i*u+o,n*l);h.set(f),c=new a(h.buffer,0,n);for(let d=0;d<n;d++)r[u*n+d]=c[d]}return r}const m4=typeof TextDecoder<"u"?new TextDecoder("utf-8"):null;function lw(r,t,e){const n=new Uint8Array(r,t,e);return m4.decode(n)}const Po={get:function(r,t={},e){t||(t={});const n=new AbortController,i=n.signal,o=vf({},t);o.signal=i,o.method||(o.method="GET"),o.referrerPolicy=o.referrerPolicy||"origin",typeof window>"u"||o.referrer||(o.referrer=window.location.href),e&&(r=e(r));const s=fetch(r,o).then(a=>{const l=this._parseResponse(a,t.responseType);return l.message?l:l.then(h=>t.responseType==="arraybuffer"?{data:h,cacheControl:a.headers.get("Cache-Control"),expires:a.headers.get("Expires"),contentType:a.headers.get("Content-Type")}:h).catch(h=>{if(!h.code||h.code!==DOMException.ABORT_ERR)throw h})}).catch(a=>{if(!a.code||a.code!==DOMException.ABORT_ERR)throw a});return s.xhr=n,s},_parseResponse:(r,t)=>r.status!==200?{status:r.status,statusText:r.statusText,message:`incorrect http request with status code(${r.status}): ${r.statusText}`}:t==="arraybuffer"?r.arrayBuffer():t==="json"?r.json():r.text(),getArrayBuffer:(r,t={},e)=>(t||(t={}),t.responseType="arraybuffer",Po.get(r,t,e)),getJSON:function(r,t={},e){return t&&t.jsonp?Po.jsonp(r):((t=t||{}).responseType="json",Po.get(r,t,e))}};Po.jsonp=function(r){const t="_maptalks_jsonp_"+h4++;r.match(/\?/)?r+="&callback="+t:r+="?callback="+t;let e=document.createElement("script");return e.type="text/javascript",e.src=r,new Promise(n=>{window[t]=function(i){document.getElementsByTagName("head")[0].removeChild(e),e=null,delete window[t],n(i)},document.getElementsByTagName("head")[0].appendChild(e)})};let hw=class{constructor(t,e,n,i,o){this._requestImage=t,this.decoders=e,this._supportedFormats=n,this.images={},this._imgRequests={},this._fetchOptions=i||{},this._urlModifier=o}requestImageFromBufferURI(t,e,n){if(this.buffers[t.id]){const s=this.buffers[t.id],a=this._createDataView(e,s);return this.getImageByBuffer(a,n)}if(this._imgRequests[t.id])return this._imgRequests[t.id].then(()=>{const s=this.buffers[t.id],a=this._createDataView(e,s);return this.getImageByBuffer(a,n)});if(Um(t.uri)){const s=this.buffers[t.id]=$m(t.uri),a=this._createDataView(e,s);return this.getImageByBuffer(a,n)}let i;const o=t.uri.indexOf("blob:")>=0;return i=t.uri.indexOf("://")>0||o?t.uri:this.rootPath+"/"+t.uri,this._imgRequests[t.id]=Po.getArrayBuffer(i,this._fetchOptions,this._urlModifier).then(s=>{const a=this.buffers[t.id]=s.data,l=this._createDataView(e,a);return this.getImageByBuffer(l,n)})}getImageByBuffer(t,e){if(this.images[e.id])return Promise.resolve(this.images[e.id]);const n=this.decoders;return n[e.mimeType]?n[e.mimeType](t,{supportedFormats:this._supportedFormats}):e.mimeType==="image/crn"||e.mimeType==="image/ktx2"||e.mimeType==="image/cttf"?(console.warn("missing transcoder for "+e.mimeType,", visit https://maptalks.com/docs/transcoders for details"),Promise.resolve(null)):this._getImageInfo(e.id,t)}requestExternalImage(t){if(this.images[t.id])return Promise.resolve(this.images[t.id]);const e=t.uri.indexOf("data:image/")===0?t.uri:this.rootPath+"/"+t.uri;return this._imgRequests[t.id]?this._imgRequests[t.id].then(()=>this.images[t.id]):this._imgRequests[t.id]=this._getImageInfo(t.id,e)}_getImageInfo(t,e){return new Promise((n,i)=>{let o=e;this._urlModifier&&(o=this._urlModifier(e)),this._requestImage(o,this._fetchOptions,(s,a)=>{s?i(s):(URL.revokeObjectURL(e),this.images[t]=a,n(this.images[t]))})})}};const uw=["SCALAR",1,"VEC2",2,"VEC3",3,"VEC4",4,"MAT2",4,"MAT3",9,"MAT4",16],Ja=[];let Wm=class{constructor(t,e,n,i,o){this.rootPath=t,this.gltf=e,this._enableInterleave=!1,this.glbBuffer=n,this.buffers={},this.requests={},this.accessors={},this._compareAccessor(),this._fetchOptions=i,this._urlModifier=o}_requestData(t,e){const n=this.gltf,i=n.accessors[e];if(i.bufferView===void 0)return this.accessors[i.id]=this._toBufferData(t,e,null,0),Promise.resolve(this.accessors[i.id]);if(i&&this.accessors[i.id])return Promise.resolve(this.accessors[i.id]);const o=n.bufferViews[i.bufferView];return this._requestBufferOfBufferView(o).then(s=>{const{buffer:a,byteOffset:l}=s;return this.accessors[i.id]=this._toBufferData(t,e,a,l)})}_requestBufferOfBufferView(t){const e=this.gltf.buffers[t.buffer];if(this.buffers[e.id]){const n=this.buffers[e.id];return Promise.resolve({buffer:n,byteOffset:0})}if(this.requests[e.id])return this.requests[e.id].then(()=>{const n=this.buffers[e.id];return Promise.resolve({buffer:n,byteOffset:0})});if(t.buffer!=="binary_glTF"&&t.buffer!=="KHR_binary_glTF"&&e.uri){if(Um(e.uri)){const o=this.buffers[e.id]=$m(e.uri);return Promise.resolve({buffer:o,byteOffset:0})}let n;const i=e.uri.indexOf("blob:")>=0;return n=e.uri.indexOf("://")>0||i?e.uri:this.rootPath+"/"+e.uri,this.requests[e.id]=Po.getArrayBuffer(n,this._fetchOptions,!i&&this._urlModifier).then(o=>(i&&URL.revokeObjectURL(n),{buffer:this.buffers[e.id]=o.data,byteOffset:0}))}return Promise.resolve({buffer:this.glbBuffer.buffer,byteOffset:this.glbBuffer.byteOffset})}_toBufferData(t,e,n,i=0){const o=this.gltf,s=o.accessors[e],a=s.bufferView!==void 0?o.bufferViews[s.bufferView]:{},l=(a.byteOffset||0)+i,h=this._getTypeItemSize(s.type),u=Gm(s.componentType),c=a.byteStride||0,f={array:void 0,name:t,accessorName:e,byteLength:s.count*h*u.BYTES_PER_ELEMENT,componentType:s.componentType,count:s.count,type:s.type,itemSize:h,max:s.max,min:s.min,extensions:s.extensions};if(s.min&&(f.min=s.min),s.max&&(f.max=s.max),n)if(this._enableInterleave)f.byteStride=c,f.byteOffset=l+(s.byteOffset||0),!c||c===h*u.BYTES_PER_ELEMENT||t==="indices"||t==="input"||t==="output"||t.indexOf("morph")>=0?(f.array=this._typedArray(n,s.count,h,l+(s.byteOffset||0),u),f.array.buffer.byteLength===f.byteLength&&(f.byteOffset=0)):f.array=new Uint8Array(n,l,a.byteLength);else if(s.interleaved){f.byteStride=0,f.byteOffset=0;const d=new u(s.count*h);if(f.array=aw(d,n,s.count,h,c,l+(s.byteOffset||0),s.componentType),f.extensions&&f.extensions.WEB3D_quantized_attributes&&h>2){const p=new Float32Array(f.array.length),{decodeMatrix:g}=f.extensions.WEB3D_quantized_attributes;for(let m=0;m<f.array.length;m+=h){Ja[0]=f.array[m],Ja[1]=f.array[m+1],Ja[2]=f.array[m+2],Ja[3]=1;const y=ss(Ja,Ja,g);p[m]=y[0],p[m+1]=y[1],p[m+2]=y[2]}f.componentType=5126,f.array=p}}else f.byteStride=0,f.array=this._typedArray(n,s.count,h,l+(s.byteOffset||0),u),f.byteOffset=f.array.byteOffset;else{f.array=new u(s.count);const d=f.min||f.max;d&&(f.array[0]=d[0],f.array[1]=d[1],f.array[2]=d[2])}return f}_compareAccessor(){const t=this.gltf.accessors;if(Array.isArray(t))for(let e=0;e<t.length;e++)for(let n=0;n<t.length;n++)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0);else for(const e in t)for(const n in t)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0)}_typedArray(t,e,n,i,o){return i%o.BYTES_PER_ELEMENT!=0&&(t=t.slice(i,i+e*n*o.BYTES_PER_ELEMENT),i=0),new o(t,i,n*e)}_getTypeItemSize(t){const e=uw.indexOf(t);return uw[e+1]}requestKHRTechniquesWebgl(t){const{shaders:e}=t,n=e.map(i=>{if(i.bufferView!==void 0){const o=this.gltf.bufferViews[i.bufferView],{byteLength:s}=o;return this._requestBufferOfBufferView(o).then(a=>{const{buffer:l,byteOffset:h}=a,u=lw(l,h+(o.byteOffset||0),s);return i.content=u,i})}if(i.uri){if(Um(i.uri)){const o=$m(i.uri),s=lw(o,0,o.byteLength);return i.content=s,Promise.resolve(i)}{const o=this.rootPath+"/"+i.uri;return Po.get(o,this._fetchOptions,this._urlModifier).then(s=>(i.content=s,i))}}return Promise.resolve(i)});return Promise.all(n).then(()=>t)}},y4=class extends hw{constructor(t,e,n,i,o,s,a,l){super(i,o,s,a,l),this.rootPath=t,this.gltf=e,this.requests={},this.buffers={},this.glbBuffer=n,this.accessor=new Wm(t,e,n,a,l)}iterate(t,e){const n=this.gltf[e];if(!n)return;let i=0;for(const o in n)t(o,n[o],i++)}createNode(t){const e={};if(In(t.name)&&(e.name=t.name),In(t.children)&&(e.children=t.children),In(t.jointName)&&(e.jointName=t.jointName),In(t.matrix)&&(e.matrix=t.matrix),In(t.rotation)&&(e.rotation=t.rotation),In(t.scale)&&(e.scale=t.scale),In(t.translation)&&(e.translation=t.translation),In(t.extras)&&(e.extras=t.extras),In(t.meshes)&&(e.mesh=t.meshes[0]),e.translation||e.rotation||e.scale){const n=function(i,o){if(o.matrix)return o.matrix;if(o.translation||o.scale||o.rotation){const s=qh(u4,o.translation||d4),a=Zb(c4,o.rotation||p4),l=Ws(f4,o.scale||g4);return qt(l,a,l),qt(i,s,l)}return mn(i)}([],e);delete e.translation,delete e.rotation,delete e.scale,e.matrix=n}return e}_loadMaterials(t){const e={};for(const n in t){const i=t[n];let o,s;i.instanceTechnique&&i.instanceTechnique.values?(o=i.instanceTechnique,s=o.values.diffuse):(o=i,s=o.values.tex||o.values.diffuseTex||o.values.diffuse);const a={baseColorTexture:{index:s}};i.name&&(a.name=i.name),i.extensions&&(a.extensions=i.extensions),i.extras&&(a.extras=i.extras),e[n]=a}return e}_loadImage(t){if(t.bufferView||t.extensions&&(t.extensions.KHR_binary_glTF||t.extensions.binary_glTF)){const e=t.bufferView?t:t.extensions.KHR_binary_glTF||t.extensions.binary_glTF;t.extensions&&(t.mimeType=e.mimeType,t.width=e.width,t.height=e.height);const n=this.gltf.bufferViews[e.bufferView],i=(n.byteOffset||0)+this.glbBuffer.byteOffset,o=n.byteLength,s=this.buffers[e.bufferView]=new Uint8Array(this.glbBuffer.buffer,i,o);return this.getImageByBuffer(s,t)}return this.requestExternalImage(t)}_getTexture(t){const e=this.gltf.textures[t];if(!e)return null;const n=this.gltf.images[e.source];return this._loadImage(n).then(i=>{const o=this.gltf.samplers[e.sampler];return{image:{array:i.data,width:i.width,height:i.height,index:e.source,mimeType:n.mimeType,name:n.name,extras:n.extras},sampler:o}})}getBaseColorTexture(t){const e=this.gltf.materials[t];let n,i;if(e.instanceTechnique&&e.instanceTechnique.values?(n=e.instanceTechnique,i=n.values.diffuse):(n=e,i=n.values.tex||n.values.diffuseTex||n.values.diffuse),i===void 0||this.gltf.textures===void 0)return null;const o=this.gltf.textures[i];if(!o)return null;const s=this.gltf.samplers[o.sampler];return{format:o.format||6408,internalFormat:o.internalFormat||6408,type:o.type||5121,sampler:s,source:this.gltf.images[o.source]}}getMaterial(){return null}getAnimations(){return null}};const xf=9729;let v4=class extends hw{constructor(t,e,n,i,o,s,a,l){super(i,o,s,a,l),this.rootPath=t,this.gltf=e,this.glbBuffer=n,this.buffers={},this.requests={},this.accessor=new Wm(t,e,n,a,l)}iterate(t,e){const n=this.gltf[e];if(n)for(let i=0;i<n.length;i++)t(i,n[i],i)}createNode(t){const e={};return vf(e,t),!In(t.weights)&&this.gltf.meshes&&In(e.mesh)?e.weights=this.gltf.meshes[e.mesh].weights:t.weights&&(e.weights=t.weights),e}_getTexture(t){const e=this.gltf.textures[t];if(!e)return null;let n=e.source;if(e.extensions&&e.extensions.EXT_texture_webp&&(n=e.extensions.EXT_texture_webp.source),!In(n))return null;const i=this.gltf.images[n];return this._loadImage(i).then(o=>{if(!o)return null;const s={image:{array:o.data,mipmap:o.mipmap,width:o.width,height:o.height,index:e.source,mimeType:i.mimeType,name:i.name,extensions:i.extensions,extras:i.extras}};vf(s,e);const a=In(e.sampler)?this.gltf.samplers[e.sampler]:void 0;if(a&&(s.sampler=a,s.sampler.magFilter=a.magFilter||xf,s.sampler.minFilter=a.minFilter||xf,s.sampler.wrapS=a.wrapS||10497,s.sampler.wrapT=a.wrapT||10497),!s.mipmap&&s.sampler.minFilter!==xf&&s.sampler.minFilter!==9728){const l=s.sampler.minFilter;s.sampler.minFilter=l===9984||l===9986?9728:xf}return o.format&&(s.format=o.format),s})}_loadImage(t){if(!In(t.bufferView))return this.requestExternalImage(t);{const e=this.gltf.bufferViews[t.bufferView],n=this.gltf.buffers[e.buffer];if(n.uri)return this.requestImageFromBufferURI(n,e,t);if(this.glbBuffer)return this._requestFromGlbBuffer(e,t)}return null}_requestFromGlbBuffer(t,e){const n=this._createDataView(t,this.glbBuffer.buffer,this.glbBuffer.byteOffset);return this.getImageByBuffer(n,e)}_createDataView(t,e,n){n=n||0;const i=(t.byteOffset||0)+n,o=t.byteLength;return new Uint8Array(e,i,o)}_transformArrayBufferToBase64(t,e){const n=new Array(t.byteLength);for(let o=0;o<t.byteLength;o++)n[o]=String.fromCharCode(t[o]);return n.join(""),"data:"+(e=e||"image/png")+";base64,"+function(o){return typeof self<"u"?self.btoa(o):window.btoa(o)}(unescape(encodeURIComponent(n)))}getAnimations(t){const e=[];return t.forEach(n=>{e.push(this.getSamplers(n.samplers))}),Promise.all(e).then(n=>{for(let i=0;i<n.length;i++)t[i].samplers=n[i];return t})}getSamplers(t){const e=[];for(let n=0;n<t.length;n++)(In(t[n].input)||In(t[n].output))&&(e.push(this.accessor._requestData("input",t[n].input)),e.push(this.accessor._requestData("output",t[n].output)));return Promise.all(e).then(n=>{for(let i=0;i<n.length/2;i++)t[i].input=n[2*i],t[i].output=n[2*i+1],t[i].interpolation||(t[i].interpolation="LINEAR");return t})}};const cw=typeof TextDecoder<"u"?new TextDecoder("utf-8"):null,x4=1313821514,_4=5130562;let b4=class m1{static read(t,e=0,n=0){n||(n=t.byteLength);const i=new DataView(t,e,n),o=i.getUint32(4,!0);if(o===1)return m1.readV1(i,e);if(o===2)return m1.readV2(t,e);throw new Error("Unsupported glb version : "+o)}static readV1(t,e){const n=t.getUint32(8,!0),i=t.getUint32(12,!0);if(n!==t.byteLength)throw new Error("Length in GLB header is inconsistent with glb's byte length.");const o=fw(t.buffer,20+e,i);return{json:JSON.parse(o),glbBuffer:{byteOffset:20+e+i,buffer:t.buffer,byteLength:n}}}static readV2(t,e){let n,i,o;const s=new DataView(t,e+12);let a=0;for(;a<s.byteLength;){const l=s.getUint32(a,!0);a+=4;const h=s.getUint32(a,!0);if(a+=4,h===x4)n=fw(t,e+12+a,l);else if(h===_4){o=e+12+a,i=l;break}a+=l}return{json:JSON.parse(n),glbBuffer:{byteOffset:o,buffer:t,byteLength:i}}}};function fw(r,t,e){if(cw){const n=new Uint8Array(r,t,e);return cw.decode(n)}return function(n){const i=n.length;let o="";for(let s=0;s<i;){let a=n[s++];if(128&a){let l=w4[a>>3&7];if(!(64&a)||!l||s+l>i)return null;for(a&=63>>l;l>0;l-=1){const h=n[s++];if((192&h)!=128)return null;a=a<<6|63&h}}o+=String.fromCharCode(a)}return o}(new Uint8Array(r,t,e))}const w4=[1,1,1,1,2,2,3,0],Zm=[0,0,0],Xm=[0,0,0,1],Ym=[1,1,1],qm={TRANSLATION:[0,0,0],ROTATION:[0,0,0,1],SCALE:[1,1,1]},Ka={PREVIOUS:null,NEXT:null,PREINDEX:null,NEXTINDEX:null,INTERPOLATION:null},dw={_getTRSW(r,t,e,n,i,o,s,a){const l=In(r)?t.animations:[t.animations[0]],h={};for(let u=0;u<l.length;u++){const c=l[u],f=c.name||u;if(In(r)&&f!==r)continue;const d=c.channelsMap[e];if(d)for(let p=0;p<d.length;p++){const g=d[p];g.target.path==="translation"?(this._getAnimateData(i,c.samplers[g.sampler],n,1),h.translation=Ar(Zm,i)):g.target.path==="rotation"?(this._getQuaternion(o,c.samplers[g.sampler],n,1),h.rotation=ew(Xm,o)):g.target.path==="scale"?(this._getAnimateData(s,c.samplers[g.sampler],n,1),h.scale=Ar(Ym,s)):g.target.path==="weights"&&a&&(this._getAnimateData(a,c.samplers[g.sampler],n,a.length),h.weights=a)}}return h},_getAnimateData(r,t,e,n){switch(t.interpolation){case"LINEAR":{const i=this._getPreNext(Ka,t,e,1*n);i&&(r=function(o,s,a,l){for(let h=0;h<o.length;h++)o[h]=s[h]+l*(a[h]-s[h]);return o}(r,i.PREVIOUS,i.NEXT,i.INTERPOLATION));break}case"STEP":{const i=this._getPreNext(Ka,t,e,1*n);i&&(r=function(o,s){for(let a=0;a<o.length;a++)o[a]=s[a];return o}(r,...i.PREVIOUS));break}case"CUBICSPLINE":{const i=this._getPreNext(Ka,t,e,3*n);i&&(r=this._getCubicSpline(r,i,t.input.array,3*n));break}}return r},_getQuaternion(r,t,e){switch(t.interpolation){case"LINEAR":{const n=this._getPreNext(Ka,t,e,1);n&&gf(r,n.PREVIOUS,n.NEXT,n.INTERPOLATION);break}case"STEP":{const n=this._getPreNext(Ka,t,e,1);n&&(r=Tr(r,...n.PREVIOUS));break}case"CUBICSPLINE":{const n=this._getPreNext(Ka,t,e,3);if(n){for(let i=0;i<n.PREVIOUS.length;i++)n.PREVIOUS[i]=Math.acos(n.PREVIOUS[i]),n.NEXT[i]=Math.acos(n.NEXT[i]);r=this._getCubicSpline(r,n,t.input.array,3);for(let i=0;i<r.length;i++)r[i]=Math.cos(r[i])}break}}return r},_search(r,t){const e=r.length;let n,i,o,s=0,a=e-1,l=Math.floor((s+a)/2);for(;s<=e-1&&a>=0;){if(s===a)return null;if(r[l]<=t&&t<=r[l+1]){const h=r[l];return n=l,i=l+1,o=(t-h)/(r[l+1]-h),{preIndx:n,nextIndex:i,interpolation:o}}t<r[l]?(a=l,l=Math.floor((s+a)/2)):r[l+1]<t&&(s=l,l=Math.floor((s+a)/2))}return null},_getPreNext(r,t,e,n){const i=t.input.array,o=t.output.array,s=t.output.itemSize;(e<i[0]||e>i[i.length-1])&&(e=Math.max(i[0],Math.min(i[i.length-1],e))),e===i[i.length-1]&&(e=i[0]);const a=this._search(i,e);if(!a||!a.nextIndex)return null;const{preIndx:l,nextIndex:h,interpolation:u}=a;r.PREINDEX=l,r.NEXTINDEX=h,r.INTERPOLATION=u;const c=s*n;return r.PREVIOUS=o.subarray(r.PREINDEX*c,(r.PREINDEX+1)*c),r.NEXT=o.subarray(r.NEXTINDEX*c,(r.NEXTINDEX+1)*c),r},_getCubicSpline(r,t,e,n){const i=t.INTERPOLATION,o=e[t.PREINDEX],s=e[t.NEXTINDEX];for(let a=0;a<3;a++){const l=t.PREVIOUS[n+a],h=(s-o)*t.PREVIOUS[2*n+a],u=t.NEXT[3+a],c=(s-o)*t.NEXT[a],f=(2*Math.pow(i,3)-3*Math.pow(i,2)+1)*l+(Math.pow(i,3)-2*Math.pow(i,2)+i)*h+(2*-Math.pow(i,3)+3*Math.pow(i,2))*u+(Math.pow(i,3)-Math.pow(i,2))*c;r[a]=f}return r},getAnimationClip(r,t,e,n){const i=r.nodes[t]&&r.nodes[t].weights;return ie(Zm,...qm.TRANSLATION),Tr(Xm,...qm.ROTATION),ie(Ym,...qm.SCALE),this._getTRSW(n,r,t,e,Zm,Xm,Ym,i)},getTimeSpan(r){if(!r.animations)return null;if(r.timeSpan)return r.timeSpan;const t=r.animations;return r.timeSpan={},t.forEach((e,n)=>{let i=-1/0,o=1/0;const s=e.channels;for(let l=0;l<s.length;l++){const h=s[l],u=e.samplers[h.sampler].input.array;u[u.length-1]>i&&(i=u[u.length-1]),u[0]<o&&(o=u[0])}const a=e.name||n;r.timeSpan[a]={max:i,min:o}}),r.timeSpan},getTimeSpanByName(r,t){const e=this.getTimeSpan(r);return e?In(t)?e[t]:e[Object.keys(e)[0]]:null}};let pw=!1;if(typeof OffscreenCanvas<"u"){let r;try{r=new OffscreenCanvas(2,2).getContext("2d")}catch{}r&&typeof createImageBitmap<"u"&&(pw=!0)}const _f=typeof document>"u"?null:document.createElement("canvas");let Eo=class{constructor(t,e,n){if(this.options=n||{},this.options.decoders||(this.options.decoders={}),this._fetchOptions=this.options.fetchOptions||{},e.buffer instanceof ArrayBuffer){const{json:i,glbBuffer:o}=b4.read(e.buffer,e.byteOffset,e.byteLength);this._init(t,i,o)}else this._init(t,e);this._accessor=new Wm(this.rootPath,this.gltf,this.glbBuffer,this._fetchOptions,this.options.urlModifier),this._checkExtensions()}_checkExtensions(){const t=this.gltf.extensionsRequired;if(t){if(t.indexOf("KHR_draco_mesh_compression")>=0&&!this.options.decoders.draco)throw new Error("KHR_draco_mesh_compression is required but @maptalks/transcoders.draco is not loaded");if(t.indexOf("KHR_texture_basisu")>=0&&!this.options.decoders["image/ktx2"])throw new Error("KHR_texture_basisu is required but @maptalks/transcoders.ktx2 is not loaded");if(t.indexOf("EXT_meshopt_compression")>=0)throw new Error("EXT_meshopt_compression extension is not supported yet.")}}_loadExtensions(){const t=this.gltf.extensions;return t&&t.KHR_techniques_webgl?this._accessor.requestKHRTechniquesWebgl(t.KHR_techniques_webgl).then(e=>(t.KHR_techniques_webgl=e,t)):Promise.resolve(t)}load(t){t=t||{};const e=this._loadScene(t),n=this._loadAnimations(),i=this._loadTextures(),o=this._loadExtensions();return Promise.all([e,n,i,o]).then(s=>(s[0].animations=s[1],s[0].textures=s[2],s[0].extensions=s[3],s[0].transferables=this.transferables||[],this.createChannelsMap(s[0]),s[0]))}createChannelsMap(t){const e=t.animations;if(e)for(let n=0;n<e.length;n++){const i=e[n];i.channelsMap={};for(let o=0;o<i.channels.length;o++){const s=i.channels[o];i.channelsMap[s.target.node]||(i.channelsMap[s.target.node]=[]),i.channelsMap[s.target.node].push(s)}}}getExternalResources(){const t=[];if(this.gltf){const{buffers:e,images:n}=this.gltf;for(let i=0;i<e.length;i++)e[i].uri&&e[i].uri.indexOf("data:application/octet-stream;base64")<0&&t.push({type:"buffer",uri:e[i].uri});for(let i=0;i<n.length;i++)n[i].uri&&n[i].uri.indexOf("data:image/")<0&&t.push({type:"image",uri:n[i].uri})}return t}static getAnimationClip(t,e,n,i){return dw.getAnimationClip(t,e,n,i)}static getAnimationTimeSpan(t,e){return dw.getTimeSpanByName(t,e)}static getTypedArrayCtor(t){return Gm(t)}static readInterleavedArray(t,e,n,i,o,s,a){return aw(t,e,n,i,o,s,a)}_init(t,e,n){this.gltf=e,this.glbBuffer=n,this.version=e.asset?+e.asset.version:1,this.rootPath=t,this.buffers={},this.requests={},this.options.requestImage=pw?M4.bind(this):this.options.requestImage||A4,this.options.transferable&&(this.transferables=[]),this.version===2?(this.adapter=new v4(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this._fetchOptions,this.options.urlModifier),this.adapter.iterate((i,o,s)=>{o.id="buffer_"+s},"buffers"),this.adapter.iterate((i,o,s)=>{o.id="image_"+s},"images"),this.adapter.iterate((i,o,s)=>{o.id="accessor_"+s},"accessors")):(this.adapter=new y4(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this._fetchOptions,this.options.urlModifier),this.adapter.iterate((i,o,s)=>{o.id="accessor_"+s},"accessors"),this.adapter.iterate((i,o,s)=>{o.id="image_"+s},"images"))}_parseNodes(t,e){if(t.children&&t.children.length>0){if(n=t.children[0],!(typeof n=="number"&&isFinite(n)||sw(t.children[0])))return t;const i=t.children.map(o=>{const s=e[o];return s.nodeIndex=o,this._parseNodes(s,e)});t.children=i}var n;return t}_loadScene(t){return this._loadNodes(t).then(e=>{const n=this.scenes=[];let i;for(const s in e)e[s]=this._parseNodes(e[s],e),e[s].nodeIndex=Number(s)?Number(s):s;this.adapter.iterate((s,a,l)=>{const h={};a.name&&(h.name=a.name),a.nodes&&(h.nodes=a.nodes.map(u=>e[u])),this.gltf.scene===s&&(i=l),n.push(h)},"scenes");const o={textures:this.gltf.textures,asset:this.gltf.asset,scene:i,scenes:n,nodes:e,meshes:this.meshes,materials:this.gltf.materials,skins:this.skins,extensionsRequired:this.gltf.extensionsRequired,extensionsUsed:this.gltf.extensionsUsed};if(this.gltf.extensions&&(o.extensions=this.gltf.extensions),this.version===1){const s=this.adapter._loadMaterials(this.gltf.materials);o.materials=s}return delete this.gltf.buffers,o.json=this.gltf,o})}_loadNodes(t){return this._loadMeshes(t).then(()=>{const e=this.nodes={};return this.adapter.iterate((n,i)=>{const o=this.adapter.createNode(i,this.meshes,this.skins);e[n]=o},"nodes"),e})}_loadSkins(){this.skins=[];const t=[];return this.adapter.iterate((e,n,i)=>{t.push(this._loadSkin(n).then(o=>{o.index=i,this.skins.push(o)}))},"skins"),t}_loadSkin(t){const e=t.inverseBindMatrices;return this.adapter.accessor._requestData("inverseBindMatrices",e).then(n=>(t.inverseBindMatrices=n,n&&n.buffer&&this.transferables&&this.transferables.indexOf(n.buffer)<0&&this.transferables.push(n.buffer),t))}_loadAnimations(){const t=this.gltf.animations;return In(t)?this.adapter.getAnimations(t):null}_loadMeshes(t){this.meshes={};let e=[];return this.adapter.iterate((n,i,o)=>{e.push(this._loadMesh(i,t).then(s=>{s.index=o,this.meshes[n]=s}))},"meshes"),e=e.concat(this._loadSkins()),Promise.all(e)}_loadMesh(t,e){const n=t.primitives.map(i=>this._loadPrimitive(i,e)).filter(i=>!!i);return Promise.all(n).then(i=>{const o={};return vf(o,t),o.primitives=i,o})}_loadTextures(){const t=this.gltf.textures;if(!t)return null;const e=[];for(const n in t)e.push(this.adapter._getTexture(n));return Promise.all(e).then(n=>{if(this.transferables)for(let i=0;i<n.length;i++){const o=n[i]&&n[i].image.array;if(o){let s;s=o instanceof ImageBitmap?o:o.buffer,s&&this.transferables.indexOf(s)<0&&this.transferables.push(s)}}if(!Array.isArray(t)){const i={},o=Object.keys(t);for(let s=0;s<n.length;s++)n[s]&&(i[o[s]]=n[s]);return i}return n})}_loadPrimitive(t,e){let n;const i=[],o=t.extensions;if(In(t.targets))for(let s=0;s<t.targets.length;s++){const a=t.targets[s];for(const l in a){const h=this.adapter.accessor._requestData(`morphTargets_${l}_${s}`,a[l]);h&&i.push(h)}}if(o&&o.KHR_draco_mesh_compression){if(!this.options.decoders.draco&&(!this.gltf.extensionsRequired||!this.gltf.extensionsRequired.indexOf("KHR_draco_mesh_compression")<0))return null;const s=this.options.decoders.draco,{bufferView:a,attributes:l}=o.KHR_draco_mesh_compression,h=this.gltf.bufferViews[a],u=this._accessor._requestBufferOfBufferView(h).then(c=>{const{buffer:f,byteOffset:d}=c;let{byteOffset:p}=h;const g=h.byteLength;p||(p=0);const m=new DataView(f,d+p,g),y={attributes:l,useUniqueIDs:!1,skipAttributeTransform:e.skipAttributeTransform};return s(m,y).then(x=>{const v=Object.values(x.attributes);return x.indices&&v.push(x.indices),v})});i.push(u),n=Promise.all(i)}else{const s=t.attributes;for(const a in s){const l=this.adapter.accessor._requestData(a,s[a]);l&&i.push(l)}if(In(t.indices)){const a=this.adapter.accessor._requestData("indices",t.indices);a&&i.push(a)}n=Promise.all(i)}return n.then(s=>{if(o&&o.KHR_draco_mesh_compression){const u=t.targets?t.targets.length:0;s[u]=s[u].concat(s.slice(0,u)),s=s[u]}let a,l;const h={attributes:s.reduce((u,c)=>{if(c.name==="indices")a=c;else if(c.name.indexOf("morphTargets_")>-1)l=l||{},l[c.name.slice(13)]=c;else{if(!(c.name!=="POSITION"||c.min&&c.max)){const f=[1/0,1/0,1/0],d=[-1/0,-1/0,-1/0],{itemSize:p,array:g}=c,m=g.length/p;for(let y=0;y<m;y++)for(let x=0;x<p;x++){const v=y*p+x;g[v]<f[x]&&(f[x]=g[v]),g[v]>d[x]&&(d[x]=g[v])}if(c.quantization){const y=c.quantization,x=y.range/(1<<y.quantizationBits),v=y.minValues;Xs(f,f,x),os(f,f,v),Xs(d,d,x),os(d,d,v)}c.min=f,c.max=d}u[c.name]=c}return this.transferables&&c.array.buffer&&this.transferables.indexOf(c.array.buffer)<0&&this.transferables.push(c.array.buffer),u},{}),material:t.material};return a&&(h.indices=a),l&&(h.morphTargets=l),h.mode=In(t.mode)?t.mode:4,In(t.extras)&&(h.extras=t.extras),h})}};function A4(r,t,e){const n=new Image;n.crossOrigin="",n.onload=()=>{if(!_f)return void e(new Error("There is no canvas to draw image!"));_f.width=n.width,_f.height=n.height;const i=_f.getContext("2d",{willReadFrequently:!0});i.drawImage(n,0,0,n.width,n.height);const o=i.getImageData(0,0,n.width,n.height),s={width:n.width,height:n.height,data:new Uint8Array(o.data)};e(null,s)},n.onerror=function(i){e(i)},n.src=r}const Jm=[],Qa=[],T4=10;let Kh,Km;function M4(r,t,e){Kh||(Kh=new OffscreenCanvas(2,2),Km=Kh.getContext("2d",{willReadFrequently:!0}));let n=null;if(sw(r))this.options.urlModifier&&(r=this.options.urlModifier(r)),Jm.push([r,t,e,this]),Qm();else{const i=new Blob([r]);n=createImageBitmap(i),n.then(gw.bind(this)).then(o=>{e(null,o)}).catch(o=>{console.warn(o),e(o)})}}function Qm(){if(!Jm.length||Qa.length>T4)return;const r=Jm.shift(),[t,e,n,i]=r;Qa.push(r),fetch(t,e).then(o=>o.arrayBuffer()).then(o=>{const s=new Blob([new Uint8Array(o)]);return createImageBitmap(s)}).then(gw.bind(i)).then(o=>{n.call(i,null,o);const s=Qa.indexOf(r);Qa.splice(s,1),Qm()}).catch(o=>{console.warn(o),n.call(i,o);const s=Qa.indexOf(r);Qa.splice(s,1),Qm()})}function gw(r){let{width:t,height:e}=r;mw(t)||(t=yw(t)),mw(e)||(e=yw(e));const n=this.options.maxTextureSize;n&&(t=Math.min(n,t),e=Math.min(n,e)),Kh.width=t,Kh.height=e,Km.drawImage(r,0,0,t,e),r.close();const i=Km.getImageData(0,0,t,e);return{width:t,height:e,data:new Uint8Array(i.data)}}function mw(r){return!(r&r-1)&&r!==0}function yw(r){return Math.pow(2,Math.floor(Math.log(r)/Math.LN2))}var S4=1e-6,Oo=typeof Float32Array<"u"?Float32Array:Array;function C4(){var r=new Oo(9);return Oo!=Float32Array&&(r[1]=0,r[2]=0,r[3]=0,r[5]=0,r[6]=0,r[7]=0),r[0]=1,r[4]=1,r[8]=1,r}function vw(){var r=new Oo(3);return Oo!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r}function P4(r){var t=r[0],e=r[1],n=r[2];return Math.sqrt(t*t+e*e+n*n)}function xw(r,t,e){var n=new Oo(3);return n[0]=r,n[1]=t,n[2]=e,n}function _w(r,t){return r[0]=t[0],r[1]=t[1],r[2]=t[2],r}function Qh(r,t,e,n){return r[0]=t,r[1]=e,r[2]=n,r}function tl(r,t,e){return r[0]=t[0]+e[0],r[1]=t[1]+e[1],r[2]=t[2]+e[2],r}function E4(r,t,e){return r[0]=t[0]-e[0],r[1]=t[1]-e[1],r[2]=t[2]-e[2],r}function O4(r,t,e){return r[0]=t[0]*e,r[1]=t[1]*e,r[2]=t[2]*e,r}function t0(r,t){var e=t[0],n=t[1],i=t[2],o=e*e+n*n+i*i;return o>0&&(o=1/Math.sqrt(o),r[0]=t[0]*o,r[1]=t[1]*o,r[2]=t[2]*o),r}function bf(r,t){return r[0]*t[0]+r[1]*t[1]+r[2]*t[2]}function ko(r,t,e){var n=t[0],i=t[1],o=t[2],s=e[0],a=e[1],l=e[2];return r[0]=i*l-o*a,r[1]=o*s-n*l,r[2]=n*a-i*s,r}var e0=E4,k4=P4;(function(){var r=vw();return function(t,e,n,i,o,s){var a=void 0,l=void 0;for(e||(e=3),n||(n=0),i?l=Math.min(i*e+n,t.length):l=t.length,a=n;a<l;a+=e)r[0]=t[a],r[1]=t[a+1],r[2]=t[a+2],o(r,r,s),t[a]=r[0],t[a+1]=r[1],t[a+2]=r[2];return t}})();function I4(){var r=new Oo(4);return Oo!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0,r[3]=0),r}function R4(r,t,e){return r[0]=t[0]*e,r[1]=t[1]*e,r[2]=t[2]*e,r[3]=t[3]*e,r}function D4(r,t){var e=t[0],n=t[1],i=t[2],o=t[3],s=e*e+n*n+i*i+o*o;return s>0&&(s=1/Math.sqrt(s),r[0]=e*s,r[1]=n*s,r[2]=i*s,r[3]=o*s),r}(function(){var r=I4();return function(t,e,n,i,o,s){var a=void 0,l=void 0;for(e||(e=4),n||(n=0),i?l=Math.min(i*e+n,t.length):l=t.length,a=n;a<l;a+=e)r[0]=t[a],r[1]=t[a+1],r[2]=t[a+2],r[3]=t[a+3],o(r,r,s),t[a]=r[0],t[a+1]=r[1],t[a+2]=r[2],t[a+3]=r[3];return t}})();function bw(){var r=new Oo(4);return Oo!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0),r[3]=1,r}function F4(r,t,e){e=e*.5;var n=Math.sin(e);return r[0]=n*t[0],r[1]=n*t[1],r[2]=n*t[2],r[3]=Math.cos(e),r}function n0(r,t,e,n){var i=t[0],o=t[1],s=t[2],a=t[3],l=e[0],h=e[1],u=e[2],c=e[3],f=void 0,d=void 0,p=void 0,g=void 0,m=void 0;return d=i*l+o*h+s*u+a*c,d<0&&(d=-d,l=-l,h=-h,u=-u,c=-c),1-d>S4?(f=Math.acos(d),p=Math.sin(f),g=Math.sin((1-n)*f)/p,m=Math.sin(n*f)/p):(g=1-n,m=n),r[0]=g*i+m*l,r[1]=g*o+m*h,r[2]=g*s+m*u,r[3]=g*a+m*c,r}function ww(r,t){var e=t[0]+t[4]+t[8],n=void 0;if(e>0)n=Math.sqrt(e+1),r[3]=.5*n,n=.5/n,r[0]=(t[5]-t[7])*n,r[1]=(t[6]-t[2])*n,r[2]=(t[1]-t[3])*n;else{var i=0;t[4]>t[0]&&(i=1),t[8]>t[i*3+i]&&(i=2);var o=(i+1)%3,s=(i+2)%3;n=Math.sqrt(t[i*3+i]-t[o*3+o]-t[s*3+s]+1),r[i]=.5*n,n=.5/n,r[3]=(t[o*3+s]-t[s*3+o])*n,r[o]=(t[o*3+i]+t[i*3+o])*n,r[s]=(t[s*3+i]+t[i*3+s])*n}return r}var Aw=R4,r0=D4;(function(){var r=vw(),t=xw(1,0,0),e=xw(0,1,0);return function(n,i,o){var s=bf(i,o);return s<-.999999?(ko(r,t,i),k4(r)<1e-6&&ko(r,e,i),t0(r,r),F4(n,r,Math.PI),n):s>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(ko(r,i,o),n[0]=r[0],n[1]=r[1],n[2]=r[2],n[3]=1+s,r0(n,n))}})(),function(){var r=bw(),t=bw();return function(e,n,i,o,s,a){return n0(r,n,s,a),n0(t,i,o,a),n0(e,r,t,2*a*(1-a)),e}}(),function(){var r=C4();return function(t,e,n,i){return r[0]=n[0],r[3]=n[1],r[6]=n[2],r[1]=i[0],r[4]=i[1],r[7]=i[2],r[2]=-e[0],r[5]=-e[1],r[8]=-e[2],r0(t,ww(t,r))}}();/*!
 * Contains code from google filament
 * https://github.com/google/filament/
 * License Apache-2.0
 */const L4=8,z4=[],H4=[],Tw=[],N4=[];function Mw(r,t,e){const n=ko(H4,t,e),i=B4(z4,e[0],e[1],e[2],...n,...t);r=ww(r,i),r=r0(r,r),r=j4(r);const s=1/((1<<2*L4-1)-1);if(r[3]<s){r[3]=s;const h=Math.sqrt(1-s*s);r[0]*=h,r[1]*=h,r[2]*=h}const a=e[3]>0?ko(Tw,e,t):ko(Tw,t,e),l=ko(N4,e,t);return bf(l,a)<0&&Aw(r,r,-1),r}function B4(r,t,e,n,i,o,s,a,l,h){return r[0]=t,r[1]=e,r[2]=n,r[3]=i,r[4]=o,r[5]=s,r[6]=a,r[7]=l,r[8]=h,r}function j4(r){return r[3]<0?Aw(r,r,-1):r}const V4=[];function Sw(r,t,e){const n=e||[];n.setLength&&n.setLength(r.length);const i=V4;i.length<r.length/3&&(i.length=r.length/3),i.fill(0,0,r.length/3);const o=t.length===void 0?t:t.length;for(let s=0;s<o/3;s++)t.length===void 0?Ew(r,s*3,s*3+1,s*3+2,n,i):Ew(r,t[s*3],t[s*3+1],t[s*3+2],n,i);for(let s=0;s<n.length;s+=3){const a=i[s/3];if(a===0){n[s]=0,n[s+1]=0,n[s+2]=0;continue}n[s]/=a,n[s+1]/=a,n[s+2]/=a}return n}const G4=[],U4=[],$4=[],Cw=[],i0=[],Pw=[],ao=[];function Ew(r,t,e,n,i,o){Qh(Cw,r[t*3],r[t*3+1],r[t*3+2]),Qh(i0,r[e*3],r[e*3+1],r[e*3+2]),Qh(Pw,r[n*3],r[n*3+1],r[n*3+2]);const s=e0(G4,Pw,i0),a=e0(U4,Cw,i0),l=ko($4,s,a);t0(ao,l),i[t*3]=i[t*3]||0,i[e*3]=i[e*3]||0,i[n*3]=i[n*3]||0,i[t*3+1]=i[t*3+1]||0,i[e*3+1]=i[e*3+1]||0,i[n*3+1]=i[n*3+1]||0,i[t*3+2]=i[t*3+2]||0,i[e*3+2]=i[e*3+2]||0,i[n*3+2]=i[n*3+2]||0,i[t*3]+=ao[0],i[e*3]+=ao[0],i[n*3]+=ao[0],i[t*3+1]+=ao[1],i[e*3+1]+=ao[1],i[n*3+1]+=ao[1],i[t*3+2]+=ao[2],i[e*3+2]+=ao[2],i[n*3+2]+=ao[2],o[t]+=1,o[e]+=1,o[n]+=1}/*!
 * Contains code from THREE.JS
 * https://github.com/mrdoob/three.js/
 * License MIT
 * 
 * Generate tangents per vertex.
 */function Ow(r,t,e,n,i){const o=r.length/3,s=i||new Array(4*o),a=[],l=[];for(let M=0;M<o;M++)a[M]=[0,0,0],l[M]=[0,0,0];const h=[0,0,0],u=[0,0,0],c=[0,0,0],f=[0,0],d=[0,0],p=[0,0],g=[0,0,0],m=[0,0,0];function y(M,E,P){wf(h,r,M*3),wf(u,r,E*3),wf(c,r,P*3),o0(f,e,M*2),o0(d,e,E*2),o0(p,e,P*2);const k=u[0]-h[0],O=c[0]-h[0],I=u[1]-h[1],D=c[1]-h[1],z=u[2]-h[2],L=c[2]-h[2],$=d[0]-f[0],Z=p[0]-f[0],j=d[1]-f[1],st=p[1]-f[1],lt=1/($*st-Z*j);Qh(g,(st*k-j*O)*lt,(st*I-j*D)*lt,(st*z-j*L)*lt),Qh(m,($*O-Z*k)*lt,($*D-Z*I)*lt,($*L-Z*z)*lt),tl(a[M],a[M],g),tl(a[E],a[E],g),tl(a[P],a[P],g),tl(l[M],l[M],m),tl(l[E],l[E],m),tl(l[P],l[P],m)}for(let M=0,E=n.length;M<E;M+=3)y(n[M+0],n[M+1],n[M+2]);const x=[],v=[],_=[],w=[];let b,A,T;function S(M){wf(_,t,M*3),_w(w,_),A=a[M],_w(x,A),e0(x,x,O4(_,_,bf(_,A))),t0(x,x),ko(v,w,A),T=bf(v,l[M]),b=T<0?-1:1,s[M*4]=x[0],s[M*4+1]=x[1],s[M*4+2]=x[2],s[M*4+3]=b}for(let M=0,E=n.length;M<E;M+=3)S(n[M+0]),S(n[M+1]),S(n[M+2]);return s}function wf(r,t,e){return r[0]=t[e],r[1]=t[e+1],r[2]=t[e+2],r}function o0(r,t,e){return r[0]=t[e],r[1]=t[e+1],r}/*!
 * @maptalks/reshader.gl v0.98.2
 * LICENSE : UNLICENSED
 * (c) 2016-2024 maptalks.com
 */function kw(r){return!di(r)&&(typeof r=="string"||r.constructor!==null&&r.constructor===String)}function di(r){return r==null}function Js(r){return!di(r)}function Si(r){return!di(r)&&(typeof r=="function"||r.constructor!==null&&r.constructor===Function)}function $n(r,...t){return Object.assign(r,...t),r}function Iw(r,...t){for(let e=0;e<t.length;e++){const n=t[e];for(const i in n)n[i]!=null&&(r[i]=n[i])}return r}function Io(r){return typeof r=="number"&&!isNaN(r)}function Af(r,t,e){return r*(1-e)+t*e}function Vr(r){return Array.isArray(r)||r instanceof Uint8Array||r instanceof Int8Array||r instanceof Uint16Array||r instanceof Int16Array||r instanceof Uint32Array||r instanceof Int32Array||r instanceof Uint8ClampedArray||r instanceof Float32Array||r instanceof Float64Array}function Rw(r){return(r=Math.abs(r))<128?Int8Array:r<32768?Int16Array:Float32Array}function Dw(r,t,e){return Math.min(e,Math.max(t,r))}function el(r){return r&&r.hasExtension("oes_vertex_array_object")}function Ci(r,t){return Object.prototype.hasOwnProperty.call(r,t)}function s0(r){if(r.data){if(r.data.BYTES_PER_ELEMENT)return r.data.length*r.data.BYTES_PER_ELEMENT;if(r.data.length)return 4*r.data.length}else{if(r.BYTES_PER_ELEMENT)return r.length*r.BYTES_PER_ELEMENT;if(r.length)return 4*r.length;if(r.buffer&&r.buffer.destroy)return r.buffer._buffer.byteLength}return 0}function Fw(r){return r.width*r.height*l0(r.format)*a0(r.type)*(r._reglType==="textureCube"?6:1)}function a0(r){return r==="uint8"?1:r==="uint16"||r==="float16"||r==="half float"?2:r==="uint32"||r==="float"||r==="float32"?4:0}function l0(r){return r==="depth"||r==="alpha"||r==="luminance"?1:r==="luminance alpha"||r==="depth stencil"?2:r==="srgba"||r==="rgb5 a1"||r.substring(0,4)==="rgba"?4:r==="srgb"||r.substring(0,3)==="rgb"?3:1}function h0(r){if(!r.componentType)return!1;const t=Eo.getTypedArrayCtor(r.componentType);return r.byteStride>0&&r.byteStride!==r.itemSize*t.BYTES_PER_ELEMENT}function Tf(r){return r&&(r.stride>0||h0(r))}function u0(r){let t=0;const e=r&&r.length||0;if(!e)return t;let n;for(let i=0;i<e;i++)n=r.charCodeAt(i),t=(t<<5)-t+n,t|=0;return t}function $i(r){return!(r&r-1)&&r!==0}function Mf(r){return Math.pow(2,Math.floor(Math.log(r)/Math.LN2))}function Sf(r,t,e){if(Vr(r))return $i(t)&&$i(e)?r:function(a,l,h){let u=l,c=h;$i(l)||(u=Mf(l)),$i(h)||(c=Mf(h));const f=new ImageData(new Uint8ClampedArray(a),l,h),d=document.createElement("canvas");d.width=l,d.height=h,d.getContext("2d").putImageData(f,0,0);const p=document.createElement("canvas");p.width=u,p.height=c,p.getContext("2d").drawImage(d,0,0,l,h,0,0,c,c),console.warn(`Texture's size is not power of two, resize from (${l}, ${h}) to (${u}, ${c})`);let g=document.getElementById("_debug_resize_canvas");return g||(g=document.createElement("canvas"),g.id="_debug_resize_canvas",document.body.appendChild(g)),g.width=u,g.height=c,g.getContext("2d").drawImage(p,0,0),p}(r,t,e);if($i(r.width)&&$i(r.height))return r;e=r.height,$i(t=r.width)||(t=Mf(t)),$i(e)||(e=Mf(e));const n=document.createElement("canvas");n.width=t,n.height=e,n.getContext("2d").drawImage(r,0,0,t,e);const i=r.src,o=i.lastIndexOf("/")+1,s=i.substring(o);return console.warn(`Texture(${s})'s size is not power of two, resize from (${r.width}, ${r.height}) to (${t}, ${e})`),n}var c0=Object.freeze({__proto__:null,clamp:Dw,defined:Js,extend:$n,extendWithoutNil:Iw,getBufferSize:s0,getPosArrayType:Rw,getSupportedFormats:function(r){return{etc:!!r.getExtension("WEBGL_compressed_texture_etc"),etc1:!!r.getExtension("WEBGL_compressed_texture_etc1"),s3tc:!!r.getExtension("WEBGL_compressed_texture_s3tc"),pvrtc:!!r.getExtension("WEBGL_compressed_texture_pvrtc"),astc:!!r.getExtension("WEBGL_compressed_texture_astc"),bc7:!!r.getExtension("EXT_texture_compression_bptc")}},getTexMemorySize:Fw,getTextureByteWidth:a0,getTextureChannels:l0,hasOwn:Ci,hashCode:u0,interpolate:Af,isArray:Vr,isFunction:Si,isInStride:h0,isInterleaved:Tf,isNil:di,isNumber:Io,isPowerOfTwo:$i,isString:kw,isSupportVAO:el,lerp:function(r,t,e,n){for(let i=0;i<r.length;i++)r[i]=t[i]+n*(e[i]-t[i]);return r},log2:function(r){return Math.log2(r)},normalize:function(r,t){let e=0;for(let n=0,i=t.length;n<i;n++)e+=t[n];for(let n=0,i=t.length;n<i;n++)r[n]=t[n]/e;return r},resizeToPowerOfTwo:Sf,set:function(r,t){for(let e=0;e<r.length;e++)r[e]=t[e];return r}});function f0(r){return class extends r{on(t,e){return this._events||(this._events={type:[e]}),this._events[t]=this._events[t]||[],this._events[t].push(e),this}once(t,e){return this.on(t,this._wrapOnce(t,e))}off(t,e){return this._events&&this._events[t]?(this._events[t].splice(this._events[t].indexOf(e),1),this):this}fire(t,e={}){if(!this._events||!this._events[t])return this;e.target||(e.target=this);const n=this._events[t].slice(0);for(const i of n)i(e);return this}_wrapOnce(t,e){const n=this;let i=!1;return function o(s){i||(i=!0,e(s),n.off(t,o))}}}}const mr="__reshader_disposed";var Lw=Object.freeze({__proto__:null,KEY_DISPOSED:mr,WEBGL_EXTENSIONS:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives"],WEBGL_OPTIONAL_EXTENSIONS:["OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","EXT_texture_filter_anisotropic"]});const nl="_reshader_refCount";let W4=class{},zw=class extends f0(W4){constructor(t,e){if(super(),Si(t)){this._texture=t,t=this.config={};for(const n in this._texture)Ci(this._texture,n)&&(Si(this._texture[n])||(t[n]=this._texture[n]))}else if(this.config=t||{},this.resLoader=e,!t.url&&!t.promise||t.data)t.data&&this._needPowerOf2()&&(t.data instanceof Image?t.data=Sf(t.data):t.hdr||!Vr(t.data)||$i(t.width)&&$i(t.height)||(t.data=Sf(t.data,t.width,t.height)));else{this._loading=!0;const n=this;let i;if(t.promise)i=t.promise;else{let o;o=t.arrayBuffer?e.getArrayBuffer:e.get,i=o.call(e,t.url)}t.data=e.getDefaultTexture(t.url),this.promise=i,i.then(o=>(delete this.promise,n._loading=!1,n.config&&(o.data instanceof Image&&this._needPowerOf2()&&(o.data=Sf(o.data)),n.onLoad(o),Array.isArray(o)||(o=[o]),n.fire("complete",{target:this,resources:o})),o)).catch(o=>{console.error("error when loading texture image.",o),n.fire("error",{target:this,error:o})})}}onLoad(t){}isReady(){return!this._loading}set(t,e){return this.config[t]=e,this.dirty=!0,this}get(t){return this.config[t]}createREGLTexture(t){return null}getREGLTexture(t){return this._texture||(this._texture=this.createREGLTexture(t),this.config.persistent||(this.config.data&&(this.config.data instanceof ImageBitmap||(this.config.data=[])),this.config.image&&(this.config.image.array=[]),this.config.mipmap&&delete this.config.mipmap)),this.dirty&&this._updateREGL(),this._texture}getMemorySize(){if(!this.config)return 0;const{width:t,height:e,type:n,format:i}=this.config;return t*e*a0(n||"uint8")*l0(i||"rgba")}_updateREGL(){this._texture&&!this._texture[mr]&&this._texture(this.config),this.dirty=!1}dispose(){this.config&&this.config.url&&(URL.revokeObjectURL(this.config.url),this.resLoader.disposeRes(this.config.url)),this.config&&this.config.data instanceof ImageBitmap&&(this.config.data.close(),this.config.data=[]),this._texture&&!this._texture[mr]&&(this._texture[nl]&&this._texture[nl]--,this._texture[nl]||(this._texture.destroy(),this._texture[mr]=!0,delete this._texture)),delete this.resLoader;const t=this.config&&this.config.url;delete this.config,t&&this.fire("disposed",{target:this,url:t})}_needPowerOf2(){const t=this.config;return t.wrap&&t.wrap!=="clamp"||t.wrapS&&t.wrapS!=="clamp"||t.wrapT&&t.wrapT!=="clamp"||t.min&&t.min!=="nearest"&&t.min!=="linear"}};const Hw=mn([]),Nw=mn([]);let tu=class y1{constructor(t,e){this.min=t||[1/0,1/0,1/0],this.max=e||[-1/0,-1/0,-1/0],this.updateVertex()}static copy(t,e){Ar(t.min,e.min),Ar(t.max,e.max);for(let n=0;n<e.vertex.length;n++)Ar(t.vertex[n],e.vertex[n]);return t}combine(t){if(!t)return this;let e,n;return Array.isArray(t)?(e=t[0],n=t[1]):(e=t.min,n=t.max),e[0]<this.min[0]&&(this.min[0]=e[0],this._dirty=!0),e[1]<this.min[1]&&(this.min[1]=e[1],this._dirty=!0),e[2]<this.min[2]&&(this.min[2]=e[2],this._dirty=!0),n[0]>this.max[0]&&(this.max[0]=n[0],this._dirty=!0),n[1]>this.max[1]&&(this.max[1]=n[1],this._dirty=!0),n[2]>this.max[2]&&(this.max[2]=n[2],this._dirty=!0),this}dirty(){return this._dirty=!0,this}getCenter(){return this.center||(this.center=[0,0,0],this._dirty=!0),this._dirty&&(os(this.center,this.min,this.max),Xs(this.center,this.center,.5)),this._dirty=!1,this.center}containPoint(t){const e=this.min,n=this.max;return e[0]<=t[0]&&e[1]<=t[1]&&e[2]<=t[2]&&n[0]>=t[0]&&n[1]>=t[1]&&n[2]>=t[2]}isFinite(){const t=this.min,e=this.max;return isFinite(t[0])&&isFinite(t[1])&&isFinite(t[2])&&isFinite(e[0])&&isFinite(e[1])&&isFinite(e[2])}updateVertex(){if(!this.vertex){this.vertex=[];for(let t=0;t<8;t++)this.vertex.push([0,0,0])}return this.vertex[0][0]=this.min[0],this.vertex[0][1]=this.min[1],this.vertex[0][2]=this.min[2],this.vertex[1][0]=this.min[0],this.vertex[1][1]=this.min[1],this.vertex[1][2]=this.max[2],this.vertex[2][0]=this.min[0],this.vertex[2][1]=this.max[1],this.vertex[2][2]=this.max[2],this.vertex[3][0]=this.min[0],this.vertex[3][1]=this.max[1],this.vertex[3][2]=this.min[2],this.vertex[4][0]=this.max[0],this.vertex[4][1]=this.min[1],this.vertex[4][2]=this.min[2],this.vertex[5][0]=this.max[0],this.vertex[5][1]=this.min[1],this.vertex[5][2]=this.max[2],this.vertex[6][0]=this.max[0],this.vertex[6][1]=this.max[1],this.vertex[6][2]=this.max[2],this.vertex[7][0]=this.max[0],this.vertex[7][1]=this.max[1],this.vertex[7][2]=this.min[2],this.vertex}copy(t){return t?y1.copy(t,this):new y1(this.min.slice(),this.max.slice())}equals(t){if(!Ya(this.min,t.min)||!Ya(this.max,t.max))return!1;const e=t.vertex;for(let n=0;n<this.vertex.length;n++)if(!Ya(e[n],this.vertex[n]))return!1;return!0}transform(t,e){if(t=t||Nw,(e=e||Nw)[1]||e[2]||e[4]||e[6]||e[8]||e[9]){const n=this.vertex,i=qt(Hw,e,t);for(let p=0;p<n.length;p++)Xa(this.vertex[p],this.vertex[p],i);const o=this.vertex.map(p=>p[0]),s=this.vertex.map(p=>p[1]),a=this.vertex.map(p=>p[2]),l=Math.min(...o),h=Math.max(...o),u=Math.min(...s),c=Math.max(...s),f=Math.min(...a),d=Math.max(...a);ie(this.min,l,u,f),ie(this.max,h,c,d)}else{const n=qt(Hw,e,t);Xa(this.min,this.min,n),Xa(this.max,this.max,n)}return this}};const Z4=[],X4={5120:"int8",5122:"int16",5124:"int32",5121:"uint8",5123:"uint16",5125:"uint32",5126:"float"},Y4={5120:1,5122:2,5124:4,5121:1,5123:2,5125:4,5126:4},q4={positionSize:3,primitive:"triangles",positionAttribute:"aPosition",normalAttribute:"aNormal",uv0Attribute:"aTexCoord",uv1Attribute:"aTexCoord1",color0Attribute:"aColor0",tangentAttribute:"aTangent",pickingIdAttribute:"aPickingId",textureCoordMatrixAttribute:"aTextureCoordMatrix"};let J4=1;const Ro="_reshader_refCount";let ar=class{constructor(t,e,n,i){this._version=0,this.data=t,this.elements=e,this.desc=$n({},q4,i);const o=this._getPosAttritute();this.data[this.desc.positionAttribute]=o,n||(this.elements?n=Bw(this.elements):o&&o.length?n=o.length/this.desc.positionSize:o&&o.interleavedArray?n=o.interleavedArray.length/this.desc.positionSize:o&&o.array&&(n=o.array.length/this.desc.positionSize)),this.count=n,this.elements||(this.elements=n),this.properties={},this._buffers={},this._vao={},this.getVertexCount(),this._prepareData(!0),this.updateBoundingBox()}set version(t){throw new Error("Geometry.version is read only.")}get version(){return this._version}_getPosAttritute(){return this.data[this.desc.positionAttribute]}_prepareData(t){if(!this.data)return;const e=this._buffers||{};for(const i in this.data){const o=this.data[i];if(o){if(o.buffer&&o.buffer.destroy){const s=o.buffer;s[Ro]||(s[Ro]=0),t&&s[Ro]++}else if(o&&o.array)if(h0(o)){let s=o.array.buffer.__id;s||(s=o.array.buffer.__id=J4++),this.data[i]={buffer:s,offset:o.byteOffset,stride:o.byteStride,type:X4[o.componentType],size:o.itemSize,count:o.count,componentType:o.componentType},e[s]||(e[s]={data:o.array.buffer})}else this.data[i]=o.array}}this._buffers=e;const n=this.elements;n&&n.array&&(this.elements=n.array)}getAttrData(t){const e=t.key,n=!this._reglData||!this._reglData[e];if(this._reglData||(this._reglData={}),n){const i=this._reglData[e]={},o=this.data,{positionAttribute:s,normalAttribute:a,uv0Attribute:l,uv1Attribute:h,tangentAttribute:u,color0Attribute:c,pickingIdAttribute:f,textureCoordMatrixAttribute:d}=this.desc;$n(i,this.data),i.aPosition=o[s],o[a]&&(i.aNormal=o[a]),o[l]&&(i.aTexCoord=o[l]),o[h]&&(i.aTexCoord1=o[h]),o[u]&&(i.aTangent=o[u]),o[c]&&(i.aColor0=o[c]),o[f]&&(i.aPickingId=o[f]),o[d]&&(i.aTextureCoordMatrix=o[d])}return this._reglData[e]}getREGLData(t,e,n){this.getAttrData(e);const i=!this._reglData||!this._reglData[e.key];if(el(t)&&!n){const o=e&&e.key||"default";if(!this._vao[o]||i||this._vao[o].dirty){const s=this._reglData[e.key],a=this._vertexCount,l=[];for(let u=0;u<e.length;u++){const c=e[u].name,f=s[c]&&s[c].buffer;if(f&&f.destroy)l.push(s[c].stride!==void 0?s[c]:f);else{const d=s[c];if(!d){l.push(this.desc.fillEmptyDataInMissingAttribute?new Uint8Array(4*a):Z4);continue}const p=(d.data&&Vr(d.data)?d.data.length:d.length)/a;d.data?(d.dimension=p,l.push(d)):l.push({data:d,dimension:p})}}const h={attributes:l,primitive:this.getPrimitive()};if(this.elements&&!Io(this.elements))if(this.elements.destroy)h.elements=this.elements;else{h.elements={primitive:this.getPrimitive(),data:this.elements};const u=this.getElementsType(this.elements);u&&(h.elements.type=u)}this._vao[o]?this._vao[o].vao(h):this._vao[o]={vao:t.vao(h)}}return delete this._vao[o].dirty,this._vao[o]}return this._reglData[e.key]}_isAttrChanged(t){if(t===this._activeAttributes)return!1;if(t.length!==this._activeAttributes.length)return!0;for(let e=0;e<t.length;e++)if(t[e]!==this._activeAttributes[e])return!0;return!1}generateBuffers(t){const e=this._buffers;for(const l in e)e[l].buffer||(e[l].buffer=t.buffer(e[l].data)),delete e[l].data;const n=this.desc.positionAttribute,i=this.desc.altitudeAttribute,o=this.data,s=this._vertexCount,a={};for(const l in o)if(o[l]){if(o[l].buffer===void 0||o[l].buffer instanceof ArrayBuffer){const h=o[l].data?o[l]:{data:o[l]};h.dimension=(o[l].data?o[l].data:o[l]).length/s;const u=t.buffer(h);u[Ro]=1,a[l]={buffer:u},l!==n&&l!==i||(a[l].array=o[l])}else o[l].buffer.destroy?a[l]=o[l]:e[o[l].buffer]&&(a[l]=$n({},o[l]),a[l].buffer=e[o[l].buffer].buffer);(this.desc.static||l!==n)&&delete o[l].array}if(this.data=a,delete this._reglData,this.elements&&!Io(this.elements)){const l={primitive:this.getPrimitive(),data:this.elements},h=this.getElementsType(this.elements);if(h&&(l.type=h),!this.desc.static&&!this.elements.destroy){const c=this.elements;this.indices=new Uint16Array(c.length);for(let f=0;f<c.length;f++)this.indices[f]=c[f]}this.elements=this.elements.destroy?this.elements:t.elements(l);const u=this.elements;u[Ro]||(u[Ro]=0),u[Ro]++}}getVertexCount(){const{positionAttribute:t,positionSize:e,color0Attribute:n}=this.desc;let i=this.data[t];i.data&&(i=i.data),i.array&&(i=i.array),Vr(i)?this._vertexCount=Math.ceil(i.length/e):i&&i.count!==void 0&&(this._vertexCount=i.count);const o=n;if(this.data[o]){const s=this.data[o].data||this.data[o].array||this.data[o];Array.isArray(s)?this._color0Size=s.length/this._vertexCount:s&&s.count?this._color0Size=s.count/this._vertexCount:this.data[o].buffer&&this.data[o].buffer.destroy&&(this._color0Size=this.data[o].buffer._buffer.dimension)}return this._vertexCount}getColor0Size(){return this._color0Size||0}addBuffer(t,e){return this._buffers[t]={data:e},delete this._reglData,this._deleteVAO(),this}updateBuffer(t,e){if(!this._buffers[t])throw new Error(`invalid buffer ${t} in geometry`);return this._buffers[t].buffer?this._buffers[t].buffer.subdata(e):this._buffers[t].data=e,delete this._reglData,this._deleteVAO(),this}deleteData(t){const e=this.data[t];return e?(this._incrVersion(),e.buffer&&e.buffer.destroy&&e.buffer.destroy(),delete this.data[t],delete this._reglData,this._markVAODirty(!1),this):this}updateData(t,e){const n=this.data[t];if(!n)return this;let i;return this._incrVersion(),this.data[t]=e,n.buffer&&n.buffer.destroy&&(i=n),t===this.desc.positionAttribute&&this.updateBoundingBox(),this.getVertexCount(),i&&(i.buffer(e),this.data[t]=i),this._prepareData(!1),this.desc.positionAttribute===t&&(this._posDirty=!0),delete this._reglData,this}updateSubData(t,e,n){const i=this.data[t];if(!i)return this;let o;if(this._incrVersion(),i.buffer&&i.buffer.destroy&&(o=i),t===this.desc.positionAttribute&&this._updateSubBoundingBox(e),o){const s=Y4[o.buffer._buffer.dtype];if(e.BYTES_PER_ELEMENT!==s){const a=function(l,h){return l instanceof Uint8Array||l instanceof Uint16Array||l instanceof Uint32Array||l instanceof Uint8ClampedArray?h===1?Uint8Array:h===2?Uint16Array:Uint32Array:l instanceof Int8Array||l instanceof Int16Array||l instanceof Int32Array?h===1?Int8Array:h===2?Int16Array:Int32Array:l instanceof Float32Array||l instanceof Float64Array?h===4?Float32Array:Float64Array:null}(e,s);e=new a(e)}o.buffer.subdata(e,n*s)}else{const s=this.data[t].data?this.data[t].data:this.data[t];for(let a=0;a<e.length;a++)s[n+a]=e[a]}return this._prepareData(!1),this.desc.positionAttribute===t&&(this._posDirty=!0),delete this._reglData,this}getPrimitive(){return this.desc.primitive}getElements(){return this.elements}setElements(t,e){if(!t)throw new Error("elements data is invalid");this._incrVersion();const n=this.elements;return this.count=e===void 0?Bw(t):e,this.elements=t&&t.destroy?t:n.destroy?n(t):t,this._markVAODirty(!0),this}deleteElements(){return this.elements&&this.elements.length!==0?(this._incrVersion(),this.elements&&this.elements.destroy&&!this.elements[mr]&&(this.elements.destroy(),this.elements[mr]=1),this.elements=[],this._markVAODirty(!0),this):this}_markVAODirty(t){if(this._vao){for(const e in this._vao)t?this._vao[e].vao.destroy():this._vao[e].dirty=!0;t&&(this._vao={})}}setDrawCount(t){return this._incrVersion(),this.count1=t,this}getDrawCount(){return this.count1>=0?this.count1:this.count}setDrawOffset(t){return this._incrVersion(),this.offset=t,this}getDrawOffset(){return this.offset||0}dispose(){if(this._deleteVAO(),this._forEachBuffer(t=>{if(!t[mr]){let e=t[Ro];e&&e--,e<=0?(t[mr]=!0,t.destroy()):t[Ro]=e}}),this.properties){const t=this.properties.oldElementsBeforeHighlight;t&&!t[mr]&&t.destroy&&(t.destroy(),t[mr]=!0),delete this.properties.oldElementsBeforeHighlight,delete this.properties.hasInvisible}this.data={},this._buffers={},delete this._reglData,this.count=0,this.elements=[],delete this._tempPosArray,this._disposed=!0}isDisposed(){return!!this._disposed}updateBoundingBox(){let t=this.boundingBox;t||(t=this.boundingBox=new tu);let e,n,i=this.data[this.desc.positionAttribute];if(Vr(i)||(i.data?i=i.data:Tf(i)?i=this._getAttributeData(this.desc.positionAttribute):i.array&&(e=i.min,n=i.max,i=i.array)),i&&i.length){const o=t.min,s=t.max;if(e&&n)ie(o,...e),ie(s,...n);else{ie(o,i[0],i[1],i[2]),ie(s,i[0],i[1],i[2]);for(let a=3;a<i.length;){const l=i[a++],h=i[a++],u=i[a++];l<o[0]&&(o[0]=l),h<o[1]&&(o[1]=h),u<o[2]&&(o[2]=u),l>s[0]&&(s[0]=l),h>s[1]&&(s[1]=h),u>s[2]&&(s[2]=u)}}t.updateVertex(),t.dirty()}}_updateSubBoundingBox(t){const e=this.boundingBox,n=e.min,i=e.max,o=this.desc.positionSize;for(let s=0;s<t.length;){const a=t[s++],l=t[s++];let h=0;o===3&&(h=t[s++]),a<n[0]&&(n[0]=a),l<n[1]&&(n[1]=l),h<n[2]&&(n[2]=h),a>i[0]&&(i[0]=a),l>i[1]&&(i[1]=l),h>i[2]&&(i[2]=h)}e.updateVertex(),e.dirty()}_getAttributeData(t){const e=this.data[t]&&this.data[t].array?this.data[t].array:this.data[t],n=e.buffer;if(Tf(e)){const i=this._buffers[n]?this._buffers[n].data:e.array,{count:o,size:s,stride:a,offset:l,componentType:h}=e,u=Eo.getTypedArrayCtor(h);if((a===0||a===s*u.BYTES_PER_ELEMENT)&&l%u.BYTES_PER_ELEMENT==0)return new u(i,l,o*s);if(t===this.desc.positionAttribute)return!this._tempPosArray||this._tempPosArray&&this._tempPosArray.length<s*o?(this._tempPosArray=new u(s*o),Eo.readInterleavedArray(this._tempPosArray,i,o,s,a,l,h)):this._posDirty?(this._posDirty=!1,Eo.readInterleavedArray(this._tempPosArray,i,o,s,a,l,h)):this._tempPosArray;{const c=new u(s*o);return Eo.readInterleavedArray(c,i,o,s,a,l,h)}}return e}createTangent(t="aTangent"){this._incrVersion();const{normalAttribute:e,positionAttribute:n,uv0Attribute:i}=this.desc,o=this._getAttributeData(e),s=this._getAttributeData(n),a=Ow(s,o,this.data[i],this.elements),l=this.data[t]=new Float32Array(a.length),h=[0,0,0,0],u=[0,0,0],c=[0,0,0,0];for(let f=0;f<a.length;f+=4){const d=f/4*3;ie(u,o[d],o[d+1],o[d+2]),Tr(h,a[f],a[f+1],a[f+2],a[f+3]),Mw(c,u,h),pf(l.subarray(f,f+4),c)}delete this._reglData}createNormal(t="aNormal"){this._incrVersion();const e=this._getAttributeData(this.desc.positionAttribute);this.data[t]=Sw(e.array||e,this.elements),delete this._reglData}createBarycentric(t="aBarycentric"){if(this.desc.primitive!=="triangles")throw new Error("Primitive must be triangles to create bary centric data");this._incrVersion();const e=new Uint8Array(3*this._vertexCount);for(let n=0,i=this.elements.length;n<i;)for(let o=0;o<3;o++)e[3*this.elements[n++]+o]=1;this.data[t]=e,delete this._reglData}buildUniqueVertex(){this._incrVersion();const t=this.data,e=this.elements;if(!Vr(e))throw new Error("elements must be array to build unique vertex.");const n=Object.keys(t),i={};let o=t[this.desc.positionAttribute];if(o=o.length?o:o.array,!Vr(o))throw new Error(this.desc.positionAttribute+" must be array to build unique vertex.");const s=this._vertexCount,a=e.length;for(let h=0;h<n.length;h++){const u=n[h],c=Vr(t[u])?t[u]:t[u].array,f=c.length/s;if(!Vr(c))throw new Error(u+" must be array to build unique vertex.");i[u]=c,t[u]=new c.constructor(a*f)}let l=0;for(let h=0;h<a;h++){const u=e[h];for(let c=0;c<n.length;c++){const f=n[c],d=t[f],p=i[f].length/s;for(let g=0;g<p;g++)d[l*p+g]=i[f][u*p+g]}e[h]=l++}o=this.data[this.desc.positionAttribute],this._vertexCount=Math.ceil(o.length/this.desc.positionSize),delete this._reglData}getMemorySize(){let t=0;for(const e in this.data)Ci(this.data,e)&&(t+=s0(this.data[e]));if(this.elements){const e=this.elements;e.destroy?t+=e._elements.buffer.byteLength:e.BYTES_PER_ELEMENT?t+=e.length*e.BYTES_PER_ELEMENT:e.length&&(t+=4*e.length)}return t}_deleteVAO(){for(const t in this._vao)this._vao[t].vao.destroy();this._vao={}}_forEachBuffer(t){this.elements&&this.elements.destroy&&t(this.elements);for(const e in this.data)Ci(this.data,e)&&this.data[e]&&this.data[e].buffer&&this.data[e].buffer.destroy&&t(this.data[e].buffer);for(const e in this._buffers)Ci(this._buffers,e)&&this._buffers[e]&&this._buffers[e].buffer&&this._buffers[e].buffer.destroy&&t(this._buffers[e].buffer)}getElementsType(t){return t instanceof Uint8Array?"uint8":t instanceof Uint16Array?"uint16":t instanceof Uint32Array?"uint32":void 0}_incrVersion(){this._version++}};function Bw(r){if(Io(r))return r;if(r.count!==void 0)return r.count;if(r.destroy)return r._elements.vertCount;if(r.length!==void 0)return r.length;if(r.data)return r.data.length;throw new Error("invalid elements length")}const K4=["points","lines","line strip","line loop","triangles","triangle strip","triangle fan"];function jw(r){return K4[r]}const Q4={9729:"linear",9728:"nearest"};function tD(r){return Q4[r]}const eD={9729:"linear",9728:"nearest",9984:"nearest mipmap nearest",9985:"linear mipmap nearest",9986:"nearest mipmap linear",9987:"linear mipmap linear"};function nD(r){return eD[r]}const rD={10497:"repeat",33071:"clamp",33648:"mirror"};function Vw(r){return rD[r]}const Cf="__reshader_webgl_buffer",Pf="__reshader_webgl_tex";function iD(r,t,e){let n;if(Vr(t)?t.buffer&&t.byteOffset!==void 0&&(n=t):t.array&&t.array.buffer&&t.array.byteOffset!==void 0&&(n=t.array),!n)return null;const i=n.buffer,o=n.byteOffset;i[Cf]||(i[Cf]={});let s=i[Cf][o];if(!s){const a={};e&&$n(a,e),a.data=n,s=r.buffer(a),i[Cf][o]=s}return s}function oD(r,t){const e=t.data;if(!e||!e.buffer)return r.texture(t);const n=e.buffer,i=e.byteOffset;n[Pf]||(n[Pf]={});let o=n[Pf][i];return o||(o=r.texture(t),n[Pf][i]=o),o}const sD=[0,0,0],aD=[0,0,0],rl=[0,0,0],lD=[],hD=[],uD=[],Gw=["a","b","c"];let cD=class extends ar{constructor(t,e,n,i){super(t,e,n,{primitive:jw(1),positionAttribute:i.positionAttribute})}_getPosAttritute(){const t=this.data[this.desc.positionAttribute];if(!t.length)return[];const e=Math.pow(10,4),n=Math.cos(Math.PI/180*.8),i=this.elements,o=t.length?t:t.array,s=i.length?i?i.length:o.length/3:i,a=[0,0,0],l=new Array(3),h={},u=[],c=new fD;for(let f=0;f<s;f+=3){i.length?(a[0]=i[f],a[1]=i[f+1],a[2]=i[f+2]):(a[0]=f,a[1]=f+1,a[2]=f+2),c.a=d0(lD,o,a[0]),c.b=d0(hD,o,a[1]),c.c=d0(uD,o,a[2]);const d=c.getNormal(),p=c.a,g=c.b,m=c.c;if(l[0]=`${Math.round(p[0]*e)},${Math.round(p[1]*e)},${Math.round(p[2]*e)}`,l[1]=`${Math.round(g[0]*e)},${Math.round(g[1]*e)},${Math.round(g[2]*e)}`,l[2]=`${Math.round(m[0]*e)},${Math.round(m[1]*e)},${Math.round(m[2]*e)}`,l[0]!==l[1]&&l[1]!==l[2]&&l[2]!==l[0])for(let y=0;y<3;y++)this._calEdgeData(y,a,c,h,l,n,d,u)}for(const f in h)if(h[f]){const{index0:d,index1:p}=h[f];u.push(o[3*d],o[3*d+1],o[3*d+2]),u.push(o[3*p],o[3*p+1],o[3*p+2])}return this.elements=this._createElements(u),u}_calEdgeData(t,e,n,i,o,s,a,l){const h=(t+1)%3,u=o[t],c=o[h],f=n[Gw[t]],d=n[Gw[h]],p=`${u}_${c}`,g=`${c}_${u}`;g in i&&i[g]?(Jb(a,i[g].normal)<=s&&(l.push(f[0],f[1],f[2]),l.push(d[0],d[1],d[2])),i[g]=null):p in i||(i[p]={index0:e[t],index1:e[h],normal:Ar([0,0,0],a)})}_createElements(t){const e=[],n=t.length/3;for(let i=0;i<n;i++)e.push(i);return e}},fD=class{constructor(t=[0,0,0],e=[0,0,0],n=[0,0,0]){this.a=t,this.b=e,this.c=n}getNormal(){const t=Co(sD,this.a,this.b),e=Co(aD,this.a,this.c);Ys(rl,t,e);const n=Wa(rl);return ie(rl,rl[0]/n,rl[1]/n,rl[2]/n)}};function d0(r,t,e){return ie(r,t[3*e],t[3*e+1],t[3*e+2])}let dD=class{},Gr=class extends f0(dD){constructor(t={},e){super(),this._version=0,this._propVerion=0,this.uniforms=Iw({},e||{},t);for(const n in t){const i=Object.getOwnPropertyDescriptor(t,n).get;i&&Object.defineProperty(this.uniforms,n,{get:i})}this.unlit=!1,this._reglUniforms={},this.refCount=0,this._bindedOnTextureComplete=this._onTextureComplete.bind(this),this._genUniformKeys(),this._checkTextures()}set version(t){throw new Error("Material.version is read only.")}get version(){return this._version}get propVersion(){return this._propVerion}set doubleSided(t){this._doubleSided=t}get doubleSided(){return this._doubleSided}isReady(){return this._loadingCount<=0}set(t,e){const n=di(this.uniforms[t])&&!di(e)||!di(this.uniforms[t])&&di(e);if(this.uniforms[t]&&this.isTexture(t)&&this.uniforms[t].dispose(),di(e))di(this.uniforms[t])||delete this.uniforms[t];else if(this.uniforms[t]=e,this._reglUniforms){const i=Object.getOwnPropertyDescriptor(this._reglUniforms,t);i&&!i.get&&(this._propVerion++,this._reglUniforms[t]=e)}return this.isTexture(t)&&this._checkTextures(),n&&(this._genUniformKeys(),this._incrVersion()),this}setFunctionUniform(t,e){return this._genUniformKeys(),this._incrVersion(),Object.defineProperty(this.uniforms,t,{enumerable:!0,get:e}),this}hasFunctionUniform(t){return Object.prototype.hasOwnProperty.call(this.uniforms,t)}get(t){return this.uniforms[t]}isDirty(){return this._uniformVer!==this.version}appendDefines(t,e){const n=this.uniforms;return n&&(n.jointTexture&&(t.HAS_SKIN=1),n.morphWeights1&&(t.HAS_MORPH=1),(n.khr_offset||n.khr_rotation||n.khr_scale)&&(t.HAS_KHR_TEXTURE_TRANSFORM=1)),t}hasSkinAnimation(){return!!(this.uniforms&&this.uniforms.jointTexture&&this.uniforms.skinAnimation)}getUniforms(t){if(this._reglUniforms&&!this.isDirty())return this._reglUniforms;const e=this.uniforms,n={};for(const i in e)this.isTexture(i)?Object.defineProperty(n,i,{enumerable:!0,configurable:!0,get:function(){return e[i].getREGLTexture(t)}}):Object.getOwnPropertyDescriptor(e,i).get?Object.defineProperty(n,i,{enumerable:!0,configurable:!0,get:function(){return e[i]}}):n[i]=e[i];return this._reglUniforms=n,this._uniformVer=this.version,n}isTexture(t){return this.uniforms[t]instanceof zw}dispose(){for(const t in this.uniforms){const e=this.uniforms[t];e&&(e.dispose?e.dispose():e.destroy&&!e[mr]&&(e.destroy(),e[mr]=!0))}delete this.uniforms,delete this._reglUniforms,this._disposed=!0}isDisposed(){return!!this._disposed}_checkTextures(){this._loadingCount=0;for(const t in this.uniforms)if(this.isTexture(t)){const e=this.uniforms[t];e.isReady()||(this._loadingCount++,e.on("complete",this._bindedOnTextureComplete))}}_onTextureComplete(){this._loadingCount--,this._incrVersion(),this._loadingCount<=0&&(this._disposed||this.fire("complete"))}getUniformKeys(){return this._uniformKeys}_genUniformKeys(){const t=[];for(const e in this.uniforms)Ci(this.uniforms,e)&&!di(this.uniforms[e])&&t.push(e);this._uniformKeys=t.join()}_incrVersion(){this._version++}getMemorySize(){const t=this.uniforms;let e=0;for(const n in t)this.isTexture(n)?e+=t[n].getMemorySize():this.uniforms[n]&&this.uniforms[n].destroy&&(e+=Fw(this.uniforms[n]));return e}};const Uw={baseColorFactor:[1,1,1,1],materialShininess:32,environmentExposure:1,specularStrength:32,opacity:1,extrusionOpacity:0,extrusionOpacityRange:[0,1.8],baseColorTexture:null,normalTexture:null,emissiveTexture:null,occlusionTexture:null,uvScale:[1,1],uvOffset:[0,0],alphaTest:0};let p0=class b3 extends Gr{constructor(t){super(t,Uw)}static convertFrom(t){const e={};for(const n in Uw)e[n]=t.get(n);return new b3(e)}appendDefines(t,e){super.appendDefines(t,e);const n=this.uniforms;return n.extrusionOpacity&&(t.HAS_EXTRUSION_OPACITY=1),e.data[e.desc.colorAttribute]&&(t.HAS_COLOR=1),e.data[e.desc.color0Attribute]&&(t.HAS_COLOR0=1,t.COLOR0_SIZE=e.getColor0Size()),e.data[e.desc.tangentAttribute]?t.HAS_TANGENT=1:e.data[e.desc.normalAttribute]&&(t.HAS_NORMAL=1),e.data[e.desc.uv0Attribute]&&(n.baseColorTexture&&(t.HAS_BASECOLOR_MAP=1),n.occlusionTexture&&e.data[e.desc.uv1Attribute]&&(t.HAS_AO_MAP=1),n.emissiveTexture&&(t.HAS_EMISSIVE_MAP=1),n.normalTexture&&(t.HAS_NORMAL_MAP=1),(t.HAS_BASECOLOR_MAP||t.HAS_AO_MAP||t.HAS_EMISSIVE_MAP||t.HAS_NORMAL_MAP)&&(t.HAS_MAP=1)),t}};const pD={diffuseFactor:[1,1,1,1],specularFactor:[1,1,1],glossinessFactor:1,diffuseTexture:null,specularGlossinessTexture:null,normalTexture:null,emissiveTexture:null,occlusionTexture:null};function $w(r){return class extends r{constructor(...t){let e=t[0];e=$n({},pD,e||{}),super(e,t)}appendDefines(t,e){if(super.appendDefines(t,e),t.SHADING_MODEL_SPECULAR_GLOSSINESS=1,!e.data[e.desc.uv0Attribute])return t;const n=this.uniforms;return n.diffuseTexture&&(t.HAS_DIFFUSE_MAP=1),n.specularGlossinessTexture&&(t.HAS_SPECULARGLOSSINESS_MAP=1),(t.HAS_SPECULARGLOSSINESS_MAP||t.HAS_DIFFUSE_MAP)&&(t.HAS_MAP=1),t}}}let gD=class extends $w(p0){};const Ww=new Array(16);let g0=0,nn=class{constructor(t,e,n={}){this._version=0,this._geometry=t,this._material=e,this.transparent=!!n.transparent,this.bloom=!!n.bloom,this.ssr=!!n.ssr,this._castShadow=di(n.castShadow)||n.castShadow,this.needUpdateShadow=!1,this.picking=!!n.picking,this.disableVAO=!!n.disableVAO,this.uniforms={},this._localTransform=mn(new Array(16)),this._positionMatrix=mn(new Array(16)),this.properties={},this._dirtyUniforms=!0,this._dirtyGeometry=!0,Object.defineProperty(this,"uuid",{value:g0++}),g0>Number.MAX_VALUE-10&&(g0=0)}set material(t){this._material!==t&&this.setMaterial(t)}get material(){return this._material}set version(t){throw new Error("Mesh.version is read only.")}get version(){return this._version}get geometry(){return this._geometry}set geometry(t){this._geometry!==t&&(this._incrVersion(),this._dirtyGeometry=!0),this._geometry=t}set localTransform(t){this._prevTMat||(this._prevTMat=new Array(16)),Array.isArray(t)&&!df(this._prevTMat,t)&&(this._incrVersion(),this._prevTMat=io(this._prevTMat,t)),this._localTransform=t}get localTransform(){return Si(this._localTransform)?this._localTransform():this._localTransform}set positionMatrix(t){this._prevPMat||(this._prevPMat=new Array(16)),Array.isArray(t)&&!df(this._prevPMat,t)&&(this._incrVersion(),this._prevPMat=io(this._prevPMat,t)),this._positionMatrix=t}get positionMatrix(){return Si(this._positionMatrix)?this._positionMatrix():this._positionMatrix}get config(){return this._options||(this._options={}),this._options.transparent=this.transparent,this._options.castShadow=this.castShadow,this._options.bloom=this.bloom,this._options.ssr=this.ssr,this._options.picking=this.picking,this._options}get defines(){return this._getDefines()}set defines(t){this.setDefines(t)}get castShadow(){return this._castShadow&&(!this.material||!this.material.unlit)}set castShadow(t){this._castShadow=t}setMaterial(t){return this._material=t,this._dirtyUniforms=!0,delete this._materialVer,this.dirtyDefines=!0,this}setParent(t){return this.parent=t,this}setLocalTransform(t){return this.localTransform=t,this}setPositionMatrix(t){this.positionMatrix=t}setUniform(t,e){return this._updateUniformState(t),this.uniforms[t]=e,this}setFunctionUniform(t,e){return this._updateUniformState(t),Object.defineProperty(this.uniforms,t,{enumerable:!0,get:e}),this}hasFunctionUniform(t){return Object.prototype.hasOwnProperty.call(this.uniforms,t)}_updateUniformState(t){this.uniforms[t]===void 0?this._dirtyUniforms=!0:(this._dirtyProps=this._dirtyProps||[],this._dirtyProps.push(t))}getUniform(t){return this.uniforms[t]}getDefines(){const t={};return $n(t,this._getDefines()),this._material&&this._geometry&&this._material.appendDefines(t,this._geometry),t}_getDefines(){this._defines||(this._defines={});const t=this._geometry,e=t.data[t.desc.positionAttribute],n=t.data[t.desc.uv0Attribute],i=t.data[t.desc.normalAttribute];return e&&e.quantization&&(this._defines.HAS_DRACO_POSITION=1),n&&n.quantization&&(this._defines.HAS_DRACO_TEXCOORD=1),i&&i.quantization&&(this._defines.HAS_DRACO_NORMAL=1),this._defines}setDefines(t){const e=this._bakDefines;return this._defines=t,this.dirtyDefines=this.dirtyDefines||!!e!=!!t||!function(n,i){if(!n&&!i)return!0;const o=Object.getOwnPropertyNames(n),s=Object.getOwnPropertyNames(i);if(o.length!==s.length)return!1;for(let a=0;a<o.length;a++)if(n[o[a]]!==i[o[a]])return!1;return!0}(e,t),this.dirtyDefines&&(this._bakDefines=$n({},t)),this}hasSkinAnimation(){return this._material&&this._material.hasSkinAnimation()}_getDefinesKey(){return this.dirtyDefines=!1,this._createDefinesKey(this.getDefines())}getCommandKey(t){if(!this._commandKey||this.dirtyDefines||this._material&&this._materialKeys!==this._material.getUniformKeys()){let e=this._getDefinesKey();e+="_"+(Io(this.getElements())?"count":"elements"),e+="_"+ +!!this.disableVAO,this._material&&(e+="_"+ +!!this._material.doubleSided),this._commandKey=e,this._material&&(this._materialKeys=this._material.getUniformKeys())}return this._commandKey}getUniforms(t){if(this._dirtyUniforms||this._dirtyGeometry||this._material&&this._materialVer!==this._material.version){this._uniformDescriptors=new Set,this._realUniforms={},this._prepareUniformsForDraco();const e=this.uniforms;for(const n in this.uniforms)Ci(this.uniforms,n)&&(Object.getOwnPropertyDescriptor(e,n).get?(this._uniformDescriptors.add(n),Object.defineProperty(this._realUniforms,n,{enumerable:!0,configurable:!0,get:function(){return e[n]}})):this._realUniforms[n]=e[n]);if(this._material){const n=this._material.getUniforms(t);for(const i in n)Ci(n,i)&&!Ci(this._realUniforms,i)&&(Object.getOwnPropertyDescriptor(n,i).get?(this._uniformDescriptors.add(i),Object.defineProperty(this._realUniforms,i,{enumerable:!0,configurable:!0,get:function(){return n[i]}})):this._realUniforms[i]===void 0&&(this._realUniforms[i]=n[i]))}this._dirtyUniforms=!1,this._dirtyGeometry=!1,this._materialVer=this._material&&this._material.version,this._materialPropVer=this._material&&this._material.propVersion,this._dirtyProps=null}else if(this._dirtyProps||this._material&&this._material.propVersion!==this._materialPropVer){if(this._dirtyProps)for(const e of this._dirtyProps)this._realUniforms[e]=this.uniforms[e];if(this._material&&this._material.propVersion!==this._materialPropVer){const e=this._material.getUniforms(t);for(const n in e)Ci(e,n)&&!this._uniformDescriptors.has(n)&&(Object.getOwnPropertyDescriptor(e,n).get||this._realUniforms[n]===e[n]||(this._realUniforms[n]=e[n]));this._materialPropVer=this._material.propVersion}this._dirtyProps=null}return this._realUniforms.modelMatrix=this.localTransform,this._realUniforms.positionMatrix=this.positionMatrix,this._realUniforms}_prepareUniformsForDraco(){const t=this._geometry,e=t.data[t.desc.positionAttribute],n=t.data[t.desc.uv0Attribute],i=t.data[t.desc.normalAttribute];if(e&&e.quantization){const o=e.quantization,s=o.range/(1<<o.quantizationBits);this._realUniforms.minValues_pos=o.minValues,this._realUniforms.gltf_u_dec_position_normConstant=s}if(n&&n.quantization){const o=n.quantization;this._realUniforms.minValues_tex=o.minValues,this._realUniforms.gltf_u_dec_texcoord_0_normConstant=o.range/(1<<o.quantizationBits)}i&&i.quantization&&(this._realUniforms.gltf_u_dec_normal_rangeConstant=(1<<i.quantization.quantizationBits)-1)}getMaterial(){return this._material}getElements(){return this._geometry.getElements()}_getREGLAttrData(t,e){return this._geometry.getREGLData(t,e,this.disableVAO)}getREGLProps(t,e){const n=this.getUniforms(t);return $n(n,this._getREGLAttrData(t,e)),el(t)&&!this.disableVAO||(n.elements=this._geometry.getElements()),n.meshProperties=this.properties,n.meshConfig=this.config,n.count=this._geometry.getDrawCount(),n.offset=this._geometry.getDrawOffset(),n.primitive=this._geometry.getPrimitive(),n}dispose(){return delete this._geometry,delete this._material,this.uniforms=null,this}isValid(){return this._geometry&&!this._geometry.isDisposed()&&(!this._material||!this._material.isDisposed())}getBoundingBox(){return this._bbox||this.updateBoundingBox(),qt(Ww,this.localTransform,this.positionMatrix),df(Ww,this._currentTransform)&&this._geometry.boundingBox.equals(this._geoBox)||this.updateBoundingBox(),this._bboxArr}updateBoundingBox(){const t=this._geometry.boundingBox;this._bbox||(this._bbox=new tu),this._bboxArr||(this._bboxArr=[[0,0,0],[0,0,0]]),this._geoBox||(this._geoBox=new tu),tu.copy(this._bbox,t),this._bbox.updateVertex(),this.constructor.name==="InstancedMesh"?(this._bbox.transform(this.localTransform,this.positionMatrix),this._currentTransform=qt(this._currentTransform||new Array(16),this.positionMatrix,this.localTransform)):(this._bbox.transform(this.positionMatrix,this.localTransform),this._currentTransform=qt(this._currentTransform||new Array(16),this.localTransform,this.positionMatrix)),tu.copy(this._geoBox,t),Ar(this._bboxArr[0],this._bbox.min),Ar(this._bboxArr[1],this._bbox.max)}_createDefinesKey(t){const e=[];for(const n in t)e.push(n,t[n]);return e.join(",")}_incrVersion(){this._version++}getMemorySize(){return(this.geometry&&this.geometry.getMemorySize()||0)+(this.material&&this.material.getMemorySize()||0)}getWorldTransform(){const t=this.parent;return t?qt(new Array(16),t.getWorldTransform(),this.localTransform):this.localTransform}},Zw=class extends nn{constructor(t,e,n,i,o={}){super(n,i,o),this._instanceCount=e,this.instancedData=t||{},this._checkInstancedProp(),this._vao={}}get instanceCount(){return this._instanceCount}set instanceCount(t){this._incrVersion(),this._instanceCount=t}getMemorySize(){return super.getMemorySize()+this._getInstanceMemorySize()}_getInstanceMemorySize(){let t=0;for(const e in this.instancedData)Ci(this.instancedData,e)&&(t+=s0(this.instancedData[e]));return t}_checkInstancedProp(){for(const t in this.instancedData)if(this.geometry.data[t])throw new Error(`Duplicate attribute ${t} defined in geometry and instanced data`)}_getREGLAttrData(t,e){const n=this.geometry.getAttrData(e);if(el(t)){const i=e.key;if(!this._vao[i]||this._vao[i].dirty){const o=e.map(l=>l.name),s=[];for(let l=0;l<o.length;l++){const h=n[o[l]];s.push(h&&h.buffer||this.instancedData[o[l]])}const a={attributes:s,primitive:this.geometry.getPrimitive()};this._vao[i]?this._vao[i].vao(a):this._vao[i]={vao:t.vao(a)},delete this._vao[i].dirty}return this._vao[i]}return n}getDefines(){const t=super.getDefines();return t.HAS_INSTANCE=1,t}getCommandKey(t){return"i_"+super.getCommandKey(t)}updateInstancedData(t,e){const n=this.instancedData[t];if(!n)return this;if(this._incrVersion(),this.instancedData[t]=e,n.buffer&&n.buffer.destroy&&n.buffer.destroy(),this._vao)for(const i in this._vao)this._vao[i].dirty=!0;return this}generateInstancedBuffers(t){const e=this.instancedData,n={};for(const i in e){if(!e[i])continue;const o=e[i];o.buffer!==void 0&&o.buffer.destroy?(n[i]=o,n[i].divisor&&(n[i].divisor=1)):n[i]=e[i].destroy?{buffer:e[i],divisor:1}:{buffer:t.buffer({data:e[i],dimension:e[i].length/this._instanceCount}),divisor:1}}return this.instancedData=n,this}getREGLProps(t,e){const n=super.getREGLProps(t,e);return el(t)||$n(n,this.instancedData),n.elements=this.geometry.getElements(),n.instances=this._instanceCount,n}disposeInstancedData(){const t=this.instancedData;if(t)for(const e in t){if(!t[e])continue;const n=t[e].destroy?t[e]:t[e].buffer;n.destroy&&!n[mr]&&(n[mr]=1,n.destroy())}this.instancedData={};for(const e in this._vao)this._vao[e].vao.destroy();this._vao={}}};const mD={};let un=class{constructor(t){this.regl=t}render(t,e,n,i){t.setUniforms(e||mD),t.setFramebuffer(i);let o=0;if(n){const{opaques:s,transparents:a}=n.getSortedMeshes();o+=t.draw(this.regl,s),o+=t.draw(this.regl,a)}else o+=t.draw(this.regl);return o}clear(t){this.regl.clear(t)}};const Ef={getArrayBuffer:(r,t)=>Ef.get(r,{responseType:"arraybuffer"},t),get:function(r,t,e){const n=Ef._getClient(e);if(n.open("GET",r,!0),t){for(const i in t.headers)n.setRequestHeader(i,t.headers[i]);n.withCredentials=t.credentials==="include",t.responseType&&(n.responseType=t.responseType)}return n.send(null),n},_wrapCallback:function(r,t){return function(){r.readyState===4&&(r.status===200?r.responseType==="arraybuffer"?r.response.byteLength===0?t(new Error("http status 200 returned without content.")):t(null,{data:r.response,cacheControl:r.getResponseHeader("Cache-Control"),expires:r.getResponseHeader("Expires"),contentType:r.getResponseHeader("Content-Type")}):t(null,r.responseText):t(new Error(r.statusText+","+r.status)))}},_getClient:function(r){let t;try{t=new XMLHttpRequest}catch{try{t=new ActiveXObject("Msxml2.XMLHTTP")}catch{try{t=new ActiveXObject("Microsoft.XMLHTTP")}catch{}}}return t.onreadystatechange=Ef._wrapCallback(t,r),t}};let yD=class{constructor(t,e){this.defaultTexture=t,this.defaultCubeTexture=new Array(6),this.urlModifier=e,this.resources={}}setURLModifier(t){this.urlModifier=t}get(t){return Array.isArray(t)?this._loadImages(t):this._loadImage(t)}getArrayBuffer(t){if(Array.isArray(t)){const e=t.map(n=>this.getArrayBuffer(n));return Promise.all(e)}return new Promise((e,n)=>{let i=t;this.urlModifier&&(i=this.urlModifier(t)),Ef.getArrayBuffer(i,(o,s)=>{o?n(o):e({url:t,data:s})})})}disposeRes(t){return Array.isArray(t)?t.forEach(e=>this._disposeOne(e)):this._disposeOne(t),this}isLoading(){return this._count&&this._count>0}getDefaultTexture(t){return Array.isArray(t)?this._getBlankTextures(t.length):this.defaultTexture}_disposeOne(t){const e=this.resources;e[t]&&(e[t].count--,e[t].count<=0&&delete e[t])}_loadImage(t){const e=this.resources;return e[t]?Promise.resolve({url:t,data:e[t].image}):new Promise((n,i)=>{const o=new Image;o.crossOrigin="anonymous",o.onload=function(){e[t]={image:o,count:1},n({url:t,data:o})},o.onerror=function(s){i(s)},o.onabort=function(){i(`image(${t}) loading aborted.`)},o.src=this.urlModifier?this.urlModifier(t):t})}_loadImages(t){const e=t.map(n=>this._loadImage(n));return Promise.all(e)}_getBlankTextures(t){const e=new Array(t);for(let n=0;n<6;n++)e.push(this.defaultTexture);return e}},Of=class extends f0(yD){};const Xw=[0,0,0],Yw=[0,0,0];let vD=0,ur=class{constructor(t){this._id=vD++,this.sortedMeshes={},this.setMeshes(t),this._compareBinded=this._compare.bind(this),this.dirty()}setMeshes(t){if(this.clear(),!t||Array.isArray(t)&&!t.length||t===this.meshes)return this;t=Array.isArray(t)?t:[t],this.meshes=[];for(let e=0;e<t.length;e++){const n=t[e];n&&(n._scenes=n._scenes||{},n._scenes[this._id]=1,this.meshes.push(n))}return this.dirty(),this}addMesh(t){if(!t||Array.isArray(t)&&!t.length)return this;if(Array.isArray(t))t.forEach(e=>{const n=e._scenes=e._scenes||{};n[this._id]||(n[this._id]=1,this.meshes.push(e),this.dirty())});else{const e=t._scenes=t._scenes||{};e[this._id]||(e[this._id]=1,this.meshes.push(t),this.dirty())}return this}removeMesh(t){if(!t||Array.isArray(t)&&!t.length)return this;if(Array.isArray(t)){let e=!1;for(let n=0;n<t.length;n++){const i=t[n]._scenes;i&&i[this._id]&&(e=!0,this.dirty(),delete i[this._id])}e&&(this.meshes=this.meshes.filter(n=>t.indexOf(n)<0))}else{const e=t._scenes;if(!e||!e[this._id])return this;const n=this.meshes.indexOf(t);n>=0&&this.meshes.splice(n,1),delete e[this._id],this.dirty()}return this}getMeshes(){return this.meshes||[]}clear(){if(this.meshes)for(let t=0;t<this.meshes.length;t++)delete this.meshes[t]._scenes[this._id];return this.meshes=[],this.sortedMeshes.opaques=[],this.sortedMeshes.transparents=[],this}dirty(){return this._dirty=!0,this}sortMeshes(t){const e=this.meshes;this.sortFunction&&e.sort(this.sortFunction);let n=this.sortedMeshes.transparents;if(this._dirty){const i=this.sortedMeshes.opaques=[];n=this.sortedMeshes.transparents=[];for(let o=0,s=e.length;o<s;o++)e[o].transparent?n.push(e[o]):i.push(e[o])}t&&n.length>1&&(this._cameraPosition=t,n.sort(this._compareBinded),delete this._cameraPosition),this._dirty=!1}getSortedMeshes(){return this._dirty&&this.sortMeshes(),this.sortedMeshes||{}}_compare(t,e){return Xa(Xw,t.geometry.boundingBox.getCenter(),t.localTransform),Xa(Yw,e.geometry.boundingBox.getCenter(),e.localTransform),qa(Yw,this._cameraPosition)-qa(Xw,this._cameraPosition)}};const kf=String.fromCharCode,xD=8,_D=32767;function bD(r,t,e,n){if(r[3]>0){const i=Math.pow(2,r[3]-128-8+n);t[e+0]=r[0]*i,t[e+1]=r[1]*i,t[e+2]=r[2]*i}else t[e+0]=0,t[e+1]=0,t[e+2]=0;return t[e+3]=1,t}function wD(r,t,e){const n=r[t]/e,i=r[t+1]/e,o=r[t+2]/e;let s=Dw(Math.max(Math.max(n,i),Math.max(o,1e-6)),0,1);s=Math.ceil(255*s)/255,r[t]=Math.min(255,n/s*255),r[t+1]=Math.min(255,i/s*255),r[t+2]=Math.min(255,o/s*255),r[t+3]=Math.min(255,255*s)}function qw(r,t,e,n){let i=0,o=0,s=n;for(;s>0;)if(r[o][0]=t[e++],r[o][1]=t[e++],r[o][2]=t[e++],r[o][3]=t[e++],r[o][0]===1&&r[o][1]===1&&r[o][2]===1){for(let h=r[o][3]<<i>>>0;h>0;h--)(l=r[o])[0]=(a=r[o-1])[0],l[1]=a[1],l[2]=a[2],l[3]=a[3],o++,s--;i+=8}else o++,s--,i=0;var a,l;return e}function AD(r,t,e,n){if(n<xD|n>_D)return qw(r,t,e,n);let i=t[e++];if(i!==2)return qw(r,t,e-1,n);if(r[0][1]=t[e++],r[0][2]=t[e++],i=t[e++],(r[0][2]<<8>>>0|i)>>>0!==n)return null;for(let o=0;o<4;o++)for(let s=0;s<n;){let a=t[e++];if(a>128){a=(127&a)>>>0;const l=t[e++];for(;a--;)r[s++][o]=l}else for(;a--;)r[s++][o]=t[e++]}return e}function TD(r,t=0,e=9){const n=new Uint8Array(r),i=n.length;if(function(g,m,y){let x="";for(let v=m;v<y;v++)x+=kf(g[v]);return x}(n,0,2)!=="#?")return null;for(var o=2;o<i&&(kf(n[o])!==`
`||kf(n[o+1])!==`
`);o++);if(o>=i)return null;o+=2;let s="";for(;o<i;o++){const g=kf(n[o]);if(g===`
`)break;s+=g}const a=s.split(" "),l=parseInt(a[1]),h=parseInt(a[3]);if(!h||!l)return null;let u=o+1;const c=[];for(let g=0;g<h;g++){c[g]=[];for(let m=0;m<4;m++)c[g][m]=0}let f=0;const d=new Array(h*l*4);let p=0;for(let g=0;g<l;g++){if(u=AD(c,n,u,h),!u)return null;for(let m=0;m<h;m++)bD(c[m],d,p,t),f=Math.max(f,d[p],d[p+1],d[p+2],d[p+3]),p+=4}f=Math.min(f,e),p=0;for(let g=0;g<l;g++)for(let m=0;m<h;m++)wD(d,p,f),p+=4;return{width:h,height:l,pixels:d,rgbmRange:f}}let If=class extends zw{onLoad({data:t}){const e=this.config;if(e){if(e.hdr){if(!(t=TD(t.data,0,e.maxRange)))throw new Error("Invalid hdr data"+(e.url?":"+e.url:""));this.rgbmRange=t.rgbmRange,e.data=t.pixels}else e.data=t;e.width=e.width||t.width,e.height=e.height||t.height,this._updateREGL()}}createREGLTexture(t){if(Vr(this.config.data)||Vr(this.config.mipmap)){const e=oD(t,this.config);return e[nl]||(e[nl]=0),e[nl]++,e}return t.texture(this.config)}},Rf=class extends ar{constructor(t){super({aPosition:new(Rw(t=t||0))([-1,-1,t,1,-1,t,-1,1,t,1,1,t]),aNormal:new Int8Array([0,0,1,0,0,1,0,0,1,0,0,1])},new Uint16Array([0,1,3,3,2,0]))}};const m0={vsm_shadow_vert:`
uniform mat4 shadow_lightProjViewModelMatrix;
varying vec4 shadow_vLightSpacePos;
void shadow_computeShadowPars(vec4 position) {
    shadow_vLightSpacePos = shadow_lightProjViewModelMatrix * position;
}`,vsm_shadow_frag:`
uniform sampler2D shadow_shadowMap;
uniform float shadow_opacity;
uniform vec3 shadow_color;
#if defined(USE_ESM)
    uniform float esm_shadow_threshold;
#endif
varying vec4 shadow_vLightSpacePos;
#ifdef PACK_FLOAT
    #include <common_pack_float>
#endif
#if defined(USE_ESM)
float esm(vec3 projCoords, vec4 shadowTexel) {
    float compare = projCoords.z;
    float c = 120.0;
    #ifdef PACK_FLOAT
        float depth = common_decodeDepth(shadowTexel);
        if (depth >= 1.0 - 1E-6 || compare <= depth) {
            return 1.0;
        }
    #else
        float depth = shadowTexel.r;
    #endif
    depth = exp(-c * min(compare - depth, 0.05));
    return clamp(depth, esm_shadow_threshold, 1.0);
}
#endif
#if defined(USE_VSM)
float vsm_shadow_chebyshevUpperBound(vec3 projCoords, vec4 shadowTexel){
    vec2 moments = shadowTexel.rg;
    float distance = projCoords.z;
    if (distance >= 1.0 || distance <= moments.x)
        return 1.0 ;
    float variance = moments.y - (moments.x * moments.x);
    variance = max(variance, 0.00002);
    float d = distance - moments.x;
    float p_max = variance / (variance + d * d);
    return p_max;
}
#endif
float shadow_computeShadow_coeff(sampler2D shadowMap, vec3 projCoords) {
    vec2 uv = projCoords.xy;
    vec4 shadowTexel = texture2D(shadowMap, uv);
    #if defined(USE_ESM)
        float esm_coeff = esm(projCoords, shadowTexel);
        float coeff = esm_coeff * esm_coeff;
    #endif
    #if defined(USE_VSM)
        float vsm_coeff = vsm_shadow_chebyshevUpperBound(projCoords, shadowTexel);
        float coeff = vsm_coeff;
    #endif
    return 1.0 - (1.0 - coeff) * shadow_opacity;
}
float shadow_computeShadow() {
    vec3 projCoords = shadow_vLightSpacePos.xyz / shadow_vLightSpacePos.w;
    projCoords = projCoords * 0.5 + 0.5;
    if(projCoords.z >= 1.0 || projCoords.x < 0.0 || projCoords.x > 1.0 || projCoords.y < 0.0 || projCoords.y > 1.0) return 1.0;
    return shadow_computeShadow_coeff(shadow_shadowMap, projCoords);
}
vec3 shadow_blend(vec3 color, float coeff) {
    color = color * coeff + shadow_color * shadow_opacity * (1.0 - coeff);
    return color;
}`,fbo_picking_vert:`
#ifdef ENABLE_PICKING
#if HAS_PICKING_ID == 1
attribute float aPickingId;
#elif HAS_PICKING_ID == 2
uniform float uPickingId;
#endif
varying float vPickingId;
varying float vFbo_picking_viewZ;
varying float vFbo_picking_visible;
#endif
varying float vFbo_picking_fragDepth;
void fbo_picking_setData(float viewPosZ, bool visible) {
    #ifdef ENABLE_PICKING
    #if HAS_PICKING_ID == 1
       vPickingId = aPickingId;
    #elif HAS_PICKING_ID == 2
        vPickingId = uPickingId;
    #endif
        vFbo_picking_viewZ = viewPosZ;
    #endif
    vFbo_picking_visible = visible ? 1.0 : 0.0;
    vFbo_picking_fragDepth = viewPosZ + 1.0;
}`,common_pack_float:`const float COMMON_FLOAT_MAX =  1.70141184e38;
const float COMMON_FLOAT_MIN = 1.17549435e-38;
float common_packFloat(vec4 val){
    vec4 scl = floor(255.0 * val + 0.5);
    float sgn = (scl.a < 128.0) ? 1.0 : -1.0;
    float exn = mod(scl.a * 2.0, 256.0) + floor(scl.b / 128.0) - 127.0;
    float man = 1.0 +
        (scl.r / 8388608.0) +
        (scl.g / 32768.0) +
        mod(scl.b, 128.0) / 128.0;
    return sgn * man * pow(2.0, exn);
}
vec4 common_unpackFloat(highp float v) {
    highp float av = abs(v);
    if(av < COMMON_FLOAT_MIN) {
        return vec4(0.0, 0.0, 0.0, 0.0);
    } else if(v > COMMON_FLOAT_MAX) {
        return vec4(127.0, 128.0, 0.0, 0.0) / 255.0;
    } else if(v < -COMMON_FLOAT_MAX) {
        return vec4(255.0, 128.0, 0.0, 0.0) / 255.0;
    }
    highp vec4 c = vec4(0,0,0,0);
    highp float e = floor(log2(av));
    highp float m = av * pow(2.0, -e) - 1.0;
    c[1] = floor(128.0 * m);
    m -= c[1] / 128.0;
    c[2] = floor(32768.0 * m);
    m -= c[2] / 32768.0;
    c[3] = floor(8388608.0 * m);
    highp float ebias = e + 127.0;
    c[0] = floor(ebias / 2.0);
    ebias -= c[0] * 2.0;
    c[1] += floor(ebias) * 128.0;
    c[0] += 128.0 * step(0.0, -v);
    return c / 255.0;
}
vec4 common_encodeDepth(const in float depth) {
    float alpha = 1.0;
    vec4 pack = vec4(0.0);
    pack.a = alpha;
    const vec3 code = vec3(1.0, 255.0, 65025.0);
    pack.rgb = vec3(code * depth);
    pack.gb = fract(pack.gb);
    pack.rg -= pack.gb * (1.0 / 256.0);
    pack.b -= mod(pack.b, 4.0 / 255.0);
    return pack;
}
float common_decodeDepth(const in vec4 pack) {
    return pack.r + pack.g / 255.0;
}`,invert_matrix:`mat4 invert_matrix(mat4 matrix) {
    #if __VERSION__ == 300
        return inverse(matrix);
    #else
        vec4 vector1 = matrix[0], vector2 = matrix[1], vector3 = matrix[2], vector4 = matrix[3];
        float a00 = vector1.x, a01 = vector1.y, a02 = vector1.z, a03 = vector1.w;
        float a10 = vector2.x, a11 = vector2.y, a12 = vector2.z, a13 = vector2.w;
        float a20 = vector3.x, a21 = vector3.y, a22 = vector3.z, a23 = vector3.w;
        float a30 = vector4.x, a31 = vector4.y, a32 = vector4.z, a33 = vector4.w;
        float b00 = a00 * a11 - a01 * a10;
        float b01 = a00 * a12 - a02 * a10;
        float b02 = a00 * a13 - a03 * a10;
        float b03 = a01 * a12 - a02 * a11;
        float b04 = a01 * a13 - a03 * a11;
        float b05 = a02 * a13 - a03 * a12;
        float b06 = a20 * a31 - a21 * a30;
        float b07 = a20 * a32 - a22 * a30;
        float b08 = a20 * a33 - a23 * a30;
        float b09 = a21 * a32 - a22 * a31;
        float b10 = a21 * a33 - a23 * a31;
        float b11 = a22 * a33 - a23 * a32;
        float det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;
        det = 1.0 / det;
        mat4 m = mat4(
            (a11 * b11 - a12 * b10 + a13 * b09) * det,
            (a02 * b10 - a01 * b11 - a03 * b09) * det,
            (a31 * b05 - a32 * b04 + a33 * b03) * det,
            (a22 * b04 - a21 * b05 - a23 * b03) * det,
            (a12 * b08 - a10 * b11 - a13 * b07) * det,
            (a00 * b11 - a02 * b08 + a03 * b07) * det,
            (a32 * b02 - a30 * b05 - a33 * b01) * det,
            (a20 * b05 - a22 * b02 + a23 * b01) * det,
            (a10 * b10 - a11 * b08 + a13 * b06) * det,
            (a01 * b08 - a00 * b10 - a03 * b06) * det,
            (a30 * b04 - a31 * b02 + a33 * b00) * det,
            (a21 * b02 - a20 * b04 - a23 * b00) * det,
            (a11 * b07 - a10 * b09 - a12 * b06) * det,
            (a00 * b09 - a01 * b07 + a02 * b06) * det,
            (a31 * b01 - a30 * b03 - a32 * b00) * det,
            (a20 * b03 - a21 * b01 + a22 * b00) * det
        );
        return m;
    #endif
}
mat4 transpose_matrix(mat4 matrix) {
    #if __VERSION__ == 300
        return transpose(matrix);
    #else
        vec4 vector1 = matrix[0], vector2 = matrix[1], vector3 = matrix[2], vector4 = matrix[3];
        float a01 = vector1.y, a02 = vector1.z, a03 = vector1.w;
        float a12 = vector2.z, a13 = vector2.w;
        float a23 = vector3.w;
        mat4 m = mat4(
            vector1.x,
            vector2.x,
            vector3.x,
            vector4.x,
            a01,
            vector2.y,
            vector3.y,
            vector4.y,
            a02,
            a12,
            vector3.z,
            vector4.z,
            a03,
            a13,
            a23,
            vector4.w
        );
        return m;
    #endif
}`,get_output:`#include <invert_matrix>
#include <draco_decode_vert>
#ifdef HAS_INSTANCE
    #include <instance_vert>
    #ifdef HAS_INSTANCE_COLOR
        varying vec4 vInstanceColor;
    #endif
#endif
#ifdef HAS_SKIN
    uniform int skinAnimation;
    #include <skin_vert>
#endif
#include <mask_vert>
#ifdef HAS_MORPH
    attribute vec3 POSITION0;
    attribute vec3 POSITION1;
    attribute vec3 POSITION2;
    attribute vec3 POSITION3;
    attribute vec3 POSITION4;
    attribute vec3 POSITION5;
    attribute vec3 POSITION6;
    attribute vec3 POSITION7;
    #ifdef HAS_MORPHNORMALS
        attribute vec3 NORMAL0;
        attribute vec3 NORMAL1;
        attribute vec3 NORMAL2;
        attribute vec3 NORMAL3;
    #endif
    uniform vec4 morphWeights1;
    uniform vec4 morphWeights2;
#endif
#ifdef HAS_TERRAIN_ALTITUDE
attribute float aTerrainAltitude;
#endif
mat4 getPositionMatrix() {
    mat4 worldMatrix;
    #ifdef HAS_INSTANCE
        #ifdef HAS_INSTANCE_COLOR
            vInstanceColor = instance_getInstanceColor();
        #endif
        mat4 attributeMatrix = instance_getAttributeMatrix();
        #ifdef HAS_SKIN
            if (skinAnimation == 1) {
                worldMatrix = attributeMatrix * positionMatrix * skin_getSkinMatrix();
            } else {
                worldMatrix = attributeMatrix * positionMatrix;
            }
        #else
            worldMatrix = attributeMatrix * positionMatrix;
        #endif
    #else
        #ifdef HAS_SKIN
            if (skinAnimation == 1) {
                worldMatrix = skin_getSkinMatrix() * positionMatrix;
            } else {
                worldMatrix = positionMatrix;
            }
        #else
            worldMatrix = positionMatrix;
        #endif
    #endif
    return worldMatrix;
}
#ifdef HAS_MIN_ALTITUDE
uniform float minAltitude;
#endif
vec4 getPosition(vec3 aPosition) {
    vec3 position = decode_getPosition(aPosition);
    #ifdef HAS_MORPH
        vec4 POSITION = vec4(position + morphWeights1[0] * POSITION0 + morphWeights1[1] * POSITION1 + morphWeights1[2] * POSITION2 + morphWeights1[3] * POSITION3
        + morphWeights2[0] * POSITION4 + morphWeights2[1] * POSITION5 + morphWeights2[2] * POSITION6 + morphWeights2[3] * POSITION7
        , 1.0);
    #else
        vec4 POSITION = vec4(position, 1.0);
    #endif
    #ifdef HAS_TERRAIN_ALTITUDE
        POSITION.z += aTerrainAltitude * 100.0;
    #endif
    #ifdef HAS_MIN_ALTITUDE
        POSITION.z += minAltitude * 100.0;
    #endif
    return POSITION;
}
vec3 appendMorphNormal(vec3 NORMAL) {
    #ifdef HAS_MORPHNORMALS
        vec3 normal = NORMAL + morphWeights1[0] * NORMAL0 + morphWeights1[1] * NORMAL1 + morphWeights1[2] * NORMAL2 + morphWeights1[3] * NORMAL3;
    #else
        vec3 normal = NORMAL;
    #endif
    return normal;
}`,instance_vert:`attribute vec4 instance_vectorA;
attribute vec4 instance_vectorB;
attribute vec4 instance_vectorC;
#ifdef HAS_INSTANCE_TERRAIN_ALTITUDE
attribute float aTerrainAltitude;
uniform float terrainAltitudeScale;
#endif
mat4 instance_getAttributeMatrix() {
    mat4 mat =  mat4(
        instance_vectorA.x, instance_vectorB.x, instance_vectorC.x, 0.0,
        instance_vectorA.y, instance_vectorB.y, instance_vectorC.y, 0.0,
        instance_vectorA.z, instance_vectorB.z, instance_vectorC.z, 0.0,
        instance_vectorA.w, instance_vectorB.w, instance_vectorC.w, 1.0
    );
    #ifdef HAS_INSTANCE_TERRAIN_ALTITUDE
        mat4 terrainMat = mat4(
            1., 0., 0., 0.,
            0., 1., 0., 0.,
            0., 0., 1., 0.,
            0., 0., aTerrainAltitude * terrainAltitudeScale, 1.
        );
        mat = terrainMat * mat;
    #endif
    return mat;
}
#ifdef HAS_INSTANCE_HIGHLIGHT
    attribute vec4 highlight_color;
#endif
#ifdef HAS_INSTANCE_COLOR
   
    attribute vec4 instance_color;
    vec4 instance_getInstanceColor() {
        vec4 color = instance_color;
        #ifdef HAS_INSTANCE_HIGHLIGHT
            color = instance_color * highlight_color;
        #endif
        return color;
    }
#endif`,skin_vert:`attribute vec4 WEIGHTS_0;
attribute vec4 JOINTS_0;
uniform sampler2D jointTexture;
uniform vec2 jointTextureSize;
uniform float numJoints;
#define ROW0_U ((0.5 + 0.0) / 4.)
#define ROW1_U ((0.5 + 1.0) / 4.)
#define ROW2_U ((0.5 + 2.0) / 4.)
#define ROW3_U ((0.5 + 3.0) / 4.)
mat4 skin_getBoneMatrix(float jointNdx) {
    float v = (jointNdx + 0.5) / numJoints;
    return mat4(
        texture2D(jointTexture, vec2(ROW0_U, v)),
        texture2D(jointTexture, vec2(ROW1_U, v)),
        texture2D(jointTexture, vec2(ROW2_U, v)),
        texture2D(jointTexture, vec2(ROW3_U, v)));
}
mat4 skin_getSkinMatrix() {
        mat4 skinMatrix = skin_getBoneMatrix(JOINTS_0[0]) * WEIGHTS_0[0] +
                        skin_getBoneMatrix(JOINTS_0[1]) * WEIGHTS_0[1] +
                        skin_getBoneMatrix(JOINTS_0[2]) * WEIGHTS_0[2] +
                        skin_getBoneMatrix(JOINTS_0[3]) * WEIGHTS_0[3];
        return skinMatrix;
}`,heatmap_render_vert:`#ifdef HAS_HEATMAP
varying vec2 heatmap_vTexCoord;
void heatmap_compute(mat4 matrix, vec3 position) {
    vec4 pos = matrix * vec4(position.xy, 0., 1.);
    heatmap_vTexCoord = (1. + pos.xy / pos.w) / 2.;
}
#endif`,heatmap_render_frag:`#ifdef HAS_HEATMAP
uniform sampler2D heatmap_inputTexture;
uniform sampler2D heatmap_colorRamp;
uniform float heatmap_heatmapOpacity;
varying vec2 heatmap_vTexCoord;
vec4 heatmap_getColor(vec4 color) {
    float t = texture2D(heatmap_inputTexture, heatmap_vTexCoord).r;
    vec4 heatmapColor = texture2D(heatmap_colorRamp, vec2(t, 0.5)) * heatmap_heatmapOpacity;
    return color * (1.0 - heatmapColor.a) + heatmapColor * heatmapColor.a;
}
#endif`,line_extrusion_vert:`#ifdef IS_LINE_EXTRUSION
    #define ALTITUDE_SCALE 32767.0;
    #define EXTRUDE_SCALE 63.0;
    attribute vec2 aExtrude;
    #ifdef HAS_LINE_WIDTH
        attribute float aLineWidth;
    #else
        uniform float lineWidth;
    #endif
    #ifdef HAS_LINE_HEIGHT
        attribute float aLineHeight;
    #else
        uniform float lineHeight;
    #endif
    uniform float linePixelScale;
    vec3 getLineExtrudePosition(vec3 position) {
        #ifdef HAS_LINE_WIDTH
            float lineWidth = aLineWidth / 2.0;
        #endif
        #ifdef HAS_LINE_HEIGHT
            float lineHeight = aLineHeight / 10.0;
        #endif
        float halfwidth = lineWidth / 2.0;
        float outset = halfwidth;
        vec2 dist = outset * aExtrude / EXTRUDE_SCALE;
        position.z *= lineHeight / ALTITUDE_SCALE;
        return position + vec3(dist, 0.0) * linePixelScale;
    }
#endif`,gl2_vert:`#if __VERSION__ == 300
    #define texture2D texture
    #define varying out
    #define attribute in
#endif`,gl2_frag:`#if __VERSION__ == 300
    #define varying in
    #define gl_FragDepthEXT gl_FragDepth
    #define texture2D texture
    #define textureCube texture
    #define texture2DProj textureProj
    #define texture2DLodEXT textureLod
    #define texture2DProjLodEXT textureProjLod
    #define textureCubeLodEXT textureLod
    #define texture2DGradEXT textureGrad
    #define texture2DProjGradEXT textureProjGrad
    #define textureCubeGradEXT textureGrad
    #define texture2D texture
    out vec4 glFragColor;
#else
    vec4 glFragColor;
#endif`,hsv_frag:`
const mediump vec4 HSV_K0 = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
const mediump vec4 HSV_K1 = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
const mediump float HSV_E = 1.0e-10;
vec3 hsv_rgb2hsv(vec3 c) {
    vec4 K = HSV_K0;
    vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));
    vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));
    float d = q.x - min(q.w, q.y);
    float e = HSV_E;
    return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);
}
vec3 hsv_hsv2rgb(vec3 c) {
    vec4 K = HSV_K1;
    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
vec4 hsv_apply(vec4 c, vec3 hsvOffset) {
    vec3 hsv = hsv_rgb2hsv(c.rgb);
    hsv += hsv * hsvOffset;
    hsv = clamp(hsv, 0.0, 1.0);
    return vec4(hsv_hsv2rgb(hsv), c.a);
}
vec3 hsv_apply(vec3 c, vec3 hsvOffset) {
    vec3 hsv = hsv_rgb2hsv(c.rgb);
    hsv += hsv * hsvOffset;
    hsv = clamp(hsv, 0.0, 1.0);
    return hsv_hsv2rgb(hsv);
}
mat4 contrastMatrix(float contrast)
{
    float t = (1.0 - contrast) / 2.0;
    return mat4(
        contrast, 0., 0., 0.,
        0., contrast, 0., 0.,
        0., 0., contrast, 0.,
        t, t, t, 1
    );
}`,snow_frag:`#ifdef HAS_SNOW
    float lerp(float a, float b, float w) {
        return a + w * (b - a);
    }
    vec3 snow(vec4 sceneColor, vec3 normalColor, float height) {
        float snowIntense = normalColor.b;
        vec3 fixedC = vec3(1.0, 1.0, 1.0);
        if (height < 1.0) {
            float r = lerp(0.5, fixedC.x, snowIntense);
            float g = lerp(0.5, fixedC.y, snowIntense);
            float b = lerp(0.5, fixedC.z, snowIntense);
            return vec3(r, g, b);
        } else {
            float r = lerp(sceneColor.r, fixedC.x, snowIntense);
            float g = lerp(sceneColor.g, fixedC.y, snowIntense);
            float b = lerp(sceneColor.b, fixedC.z, snowIntense);
            return vec3(r, g, b);
        }
    }
#endif`,draco_decode_vert:`#if defined(HAS_TANGENT)
    attribute vec4 aTangent;
#elif defined(HAS_NORMAL)
    #ifdef HAS_DRACO_NORMAL
        attribute vec2 aNormal;
        uniform float gltf_u_dec_normal_rangeConstant;
    #else
        attribute vec3 aNormal;
    #endif
#endif
#ifdef HAS_DRACO_POSITION
    uniform float gltf_u_dec_position_normConstant;
    uniform vec3 minValues_pos;
    vec3 decodeDracoPosition(vec3 aPosition) {
        return minValues_pos + aPosition * gltf_u_dec_position_normConstant;
    }
#endif
#ifdef HAS_DRACO_TEXCOORD
    uniform vec2 minValues_tex;
    uniform float gltf_u_dec_texcoord_0_normConstant;
    vec2 decodeDracoTexcoord(vec2 aTexCoord) {
        return minValues_tex + aTexCoord * gltf_u_dec_texcoord_0_normConstant;
    }
#endif
#ifdef HAS_WEB3D_quantized_attributes_TEXCOORD
    uniform mat3 decodeMatrix;
#endif
#ifdef HAS_DRACO_NORMAL
    float czm_signNotZero(float value) {
        return value >= 0.0 ? 1.0 : -1.0;
    }
    vec2 czm_signNotZero(vec2 value) {
        return vec2(czm_signNotZero(value.x), czm_signNotZero(value.y));
    }
    vec3 decodeDracoNormal(vec2 encoded, float range)
    {
        if (encoded.x == 0.0 && encoded.y == 0.0) {
            return vec3(0.0, 0.0, 0.0);
        }
        encoded = encoded / range * 2.0 - 1.0;
        vec3 v = vec3(encoded.x, encoded.y, 1.0 - abs(encoded.x) - abs(encoded.y));
        if (v.z < 0.0) {
            v.xy = (1.0 - abs(v.yx)) * czm_signNotZero(v.xy);
        }
        return normalize(v);
    }
    vec3 decode_getNormal(vec2 aNormal) {
        return decodeDracoNormal(aNormal, gltf_u_dec_normal_rangeConstant).zxy;
    }
#endif
#ifdef HAS_COMPRESSED_INT16
    #ifdef HAS_COMPRESSED_INT16_POSITION
      uniform vec2 compressedPositionRange;
    #endif
    #ifdef HAS_COMPRESSED_INT16_TEXCOORD_0
      uniform vec2 compressedTexcoordRange_0;
    #endif
    #ifdef HAS_COMPRESSED_INT16_TEXCOORD_1
      uniform vec2 compressedTexcoordRange_1;
    #endif
    #ifdef HAS_COMPRESSED_INT16_NORMAL
      uniform vec2 compressedNormalRange;
    #endif
    #ifdef HAS_COMPRESSED_INT16_RATIO
      uniform float compressed_ratio;
    #endif
    float int16ToFloat32(float value, vec2 range) {
        float v = (value >= 32768.0) ? -(65536.0 - value) / 32768.0 : value / 32767.0;
        return (v + 1.0) * (range.y - range.x) / 2.0 + range.x;
    }
#endif
vec3 decode_getPosition(vec3 aPosition) {
    vec3 position = aPosition;
    #if defined(HAS_COMPRESSED_INT16) && defined(HAS_COMPRESSED_INT16_POSITION)
        float x = int16ToFloat32(aPosition.x, compressedPositionRange);
        float y = int16ToFloat32(aPosition.y, compressedPositionRange);
        float z = int16ToFloat32(aPosition.z, compressedPositionRange);
        #ifdef HAS_COMPRESSED_INT16_RATIO
          position = vec3(x / compressed_ratio, y / compressed_ratio, z);
        #else
          position = vec3(x, y, z);
        #endif
    #endif
    #ifdef HAS_DRACO_POSITION
        return decodeDracoPosition(position);
    #else
        return position;
    #endif
}
vec2 decode_getTexcoord(vec2 aTexCoord) {
    vec2 texcoord = aTexCoord;
    #if defined(HAS_COMPRESSED_INT16) && (defined(HAS_COMPRESSED_INT16_TEXCOORD_0) || defined(HAS_COMPRESSED_INT16_TEXCOORD_1))
        float x = int16ToFloat32(aTexCoord.x, compressedTexcoordRange_0);
        float y = int16ToFloat32(aTexCoord.y, compressedTexcoordRange_0);
        texcoord = vec2(x, y);
    #endif
    #ifdef HAS_DRACO_TEXCOORD
        return decodeDracoTexcoord(texcoord);
    #elif defined(HAS_WEB3D_quantized_attributes_TEXCOORD)
        vec3 web3dTexcoord = decodeMatrix * vec3(texcoord, 1.0);
        return vec2(web3dTexcoord.x, web3dTexcoord.y);
    #else
        return texcoord;
    #endif
}
vec3 decode_getNormal(vec3 aNormal) {
    #ifdef HAS_COMPRESSED_INT16_NORMAL
        aNormal.x = int16ToFloat32(aNormal.x, compressedNormalRange);
        aNormal.y = int16ToFloat32(aNormal.y, compressedNormalRange);
        aNormal.z = int16ToFloat32(aNormal.z, compressedNormalRange);
    #endif
    return aNormal;
}`,highlight_vert:`#if defined(HAS_HIGHLIGHT_COLOR)
    attribute vec4 aHighlightColor;
    varying vec4 vHighlightColor;
#endif
#if defined(HAS_HIGHLIGHT_OPACITY)
    attribute float aHighlightOpacity;
    varying float vHighlightOpacity;
#endif
void highlight_setVarying() {
    #if defined(HAS_HIGHLIGHT_COLOR)
        vHighlightColor = aHighlightColor / 255.0;
    #endif
    #if defined(HAS_HIGHLIGHT_OPACITY)
        vHighlightOpacity = aHighlightOpacity / 255.0;
    #endif
}`,highlight_frag:`#if defined(HAS_HIGHLIGHT_COLOR)
	varying vec4 vHighlightColor;
#endif
#if defined(HAS_HIGHLIGHT_OPACITY)
    varying float vHighlightOpacity;
#endif
vec4 highlight_blendColor(vec4 color) {
	vec4 outColor;
	#if defined(HAS_HIGHLIGHT_COLOR)
		color.rgb = color.rgb * (1.0 - vHighlightColor.a) + vHighlightColor.rgb * vHighlightColor.a;
		#ifndef HAS_HIGHLIGHT_COLOR_POINT
        	color.a = color.a * (1.0 - vHighlightColor.a) + vHighlightColor.a;
        #endif
        outColor = color;
	#else
		outColor = color;
	#endif
	#if defined(HAS_HIGHLIGHT_OPACITY)
		outColor *= vHighlightOpacity;
	#endif
	return outColor;
}`,mask_vert:`#ifdef HAS_MASK_EXTENT
    uniform vec4 mask_extent;
    uniform sampler2D mask_colorExtent;
    uniform sampler2D mask_modeExtent;
    uniform float mask_maskMode;
    uniform float mask_hasFlatOut;
    uniform mat4 viewMatrix;
    uniform float mask_heightRatio;
    uniform float mask_heightOffset;
    varying vec4 vWorldPosition;
    varying vec2 vUVInExtent;
    varying float vHeightRatio;
    varying float vHeightOffset;
    const float CLIPINSIDE_MODE = 0.2;
    const float FLATINSIDE_MODE = 0.3;
    const float FLATOUTSIDE_MODE = 0.4;
    const float ELEVATE_MODE = 0.7;
    float random (vec2 st) {
        return fract(sin(dot(st.xy,vec2(12.9898,78.233)))*43758.5453123) * 0.1;
    }
    bool isInExtent(vec4 color) {
        return length(color.rgb) > 0.0;
    }
    float getFlatHeight(float maskMode, float flatHeight, float height) {
      if (maskMode <= ELEVATE_MODE && maskMode > 0.6) {
          return flatHeight + height;
      } else {
        return flatHeight;
      }
    }
    vec4 getNoErrorPosition(vec4 position, vec4 wPosition) {
      vec4 realPos = modelViewMatrix * position;      vec4 pos = viewMatrix * wPosition;      vec4 tempPos = viewMatrix * modelMatrix * position;      float deltaX = realPos.x - tempPos.x;
      float deltaY = realPos.y - tempPos.y;
      float deltaZ = realPos.z - tempPos.z;
      pos.x = pos.x + deltaX;
      pos.y = pos.y + deltaY;
      pos.z = pos.z + deltaZ;
      return pos;
    }
    vec4 getMaskPosition(vec4 position, mat4 modelMatrix) {
        vWorldPosition = modelMatrix * position;
        float w = mask_extent.z - mask_extent.x;
        float h = mask_extent.y - mask_extent.w;
        vec2 uvInExtent = vec2((vWorldPosition.x - mask_extent.x) / abs(w), 1.0 - (vWorldPosition.y - mask_extent.w) / h);
        vec4 extentColor = texture2D(mask_colorExtent, uvInExtent);
        vec3 maskOptionColor = texture2D(mask_modeExtent, uvInExtent).rgb;
        float maskMode = maskOptionColor.r;
        float flatHeight = maskOptionColor.g / mask_heightRatio + mask_heightOffset;
        float height = getFlatHeight(maskMode, flatHeight, vWorldPosition.z);
        vec4 wPosition = vec4(vWorldPosition.x, vWorldPosition.y, height, vWorldPosition.w);
        vUVInExtent = uvInExtent;
        vHeightRatio = mask_heightRatio;
        vHeightOffset = mask_heightOffset;
        if (maskMode <= FLATOUTSIDE_MODE && maskMode > FLATINSIDE_MODE) {
            return modelViewMatrix * position;;
        } else if (mask_hasFlatOut == 1.0) {
            return getNoErrorPosition(position, wPosition);
        }
        if (isInExtent(extentColor) == true && maskMode <= FLATINSIDE_MODE && maskMode > CLIPINSIDE_MODE) {
            return getNoErrorPosition(position, wPosition);
        } if (isInExtent(extentColor) == true && maskMode <= ELEVATE_MODE && maskMode > 0.6) {
            return getNoErrorPosition(position, wPosition);
        } else {
            return modelViewMatrix * position;
        }
    }
#endif`,mask_frag:`#ifdef HAS_MASK_EXTENT
    uniform sampler2D mask_colorExtent;
    uniform sampler2D mask_modeExtent;
    uniform float mask_hasClipOut;
    varying float vHeightRatio;
    varying float vHeightOffset;
    varying vec2 vUVInExtent;
    varying vec4 vWorldPosition;
    const float CLIPINSIDE_MODE = 0.1;
    const float CLIPOUTSIDE_MODE = 0.2;
    const float FLATINSIDE_MODE = 0.3;
    const float FLATOUTSIDE_MODE = 0.4;
    const float COLOR_MODE = 0.5;
    const float VIDEO_MODE = 0.6;
    bool isInExtent(vec4 color) {
        return length(color.rgb) > 0.0;
    }
    vec4 setMask(vec4 glFragColor) {
        vec4 extentColor = texture2D(mask_colorExtent, vUVInExtent);
        vec4 modeColor = texture2D(mask_modeExtent, vUVInExtent);
        float maskMode = modeColor.r;
        float minHeight = modeColor.b / vHeightRatio + vHeightOffset;
        float maxHeight = modeColor.a / vHeightRatio + vHeightOffset;
        if (maskMode > CLIPINSIDE_MODE && maskMode <= CLIPOUTSIDE_MODE) {
            if (minHeight == 0.0 && maxHeight == 0.0) {
                return glFragColor;
            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {
                return glFragColor;
            } else {
              discard;
            }
        } else if (mask_hasClipOut == 1.0) {
            discard;
        }
        if (isInExtent(extentColor) == true && maskMode <= CLIPINSIDE_MODE && maskMode > 0.0) {
            if (minHeight == 0.0 && maxHeight == 0.0) {
                discard;
            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {
                discard;
            } else {
              return glFragColor;
            }
        } else if (isInExtent(extentColor) == true && maskMode <= VIDEO_MODE && maskMode > FLATOUTSIDE_MODE) {
            if (minHeight == 0.0 && maxHeight == 0.0) {
                glFragColor = vec4(mix(extentColor.rgb, glFragColor.rgb, 1.0 - extentColor.a), glFragColor.a);
            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {
                glFragColor = vec4(mix(extentColor.rgb, glFragColor.rgb, 1.0 - extentColor.a), glFragColor.a);
            }
        }
        return glFragColor;
    }
#endif`,computeTexcoord_frag:`#ifdef HAS_KHR_TEXTURE_TRANSFORM
    uniform vec2 khr_offset;
    uniform float khr_rotation;
    uniform vec2 khr_scale;
    vec2 khr_tex_transformTexCoord(vec2 texCoords, vec2 offset, float rotation, vec2 scale) {
        rotation = -rotation;
        mat3 transform = mat3(
        cos(rotation) * scale.x, sin(rotation) * scale.x, 0.0, -sin(rotation) * scale.y, cos(rotation) * scale.y, 0.0, offset.x, offset.y, 1.0);
        vec2 transformedTexCoords = (transform * vec3(fract(texCoords), 1.0)).xy;
        return transformedTexCoords;
    }
#endif
varying highp vec2 vTexCoord;
#ifdef HAS_I3S_UVREGION
    varying vec4 vUvRegion;
#endif
vec2 computeTexCoord(vec2 texCoord) {
    #ifdef HAS_I3S_UVREGION
        vec2 atlasScale = vUvRegion.zw - vUvRegion.xy;
        vec2 uvAtlas = fract(texCoord) * atlasScale + vUvRegion.xy;
        return uvAtlas;
    #elif defined(HAS_KHR_TEXTURE_TRANSFORM)
        return khr_tex_transformTexCoord(texCoord, khr_offset, khr_rotation, khr_scale);
    #else
        return texCoord;
    #endif
}`,terrain_normal_frag:`#ifdef HAS_TERRAIN_NORMAL
    uniform sampler2D terrainHeightTexture;
    uniform vec2 terrainHeightMapResolution;
    uniform vec2 terrainResolution;
    uniform float terrainHeightScale;
    uniform float terrainTileResolution;
    uniform vec4 terrainUnpackFactors;
    float getHeight(vec2 uv) {
        vec4 color = texture2D(terrainHeightTexture, uv) * 255.0;
        color.a = -1.0;
        return dot(color, terrainUnpackFactors) / 4.0;
    }
    vec3 convertTerrainHeightToNormalMap(vec2 uv) {
        uv.y = 1.0 - uv.y;
        vec2 epsilon = 1.0 / terrainHeightMapResolution;
        float a = getHeight(uv + vec2(-epsilon.x, -epsilon.y));
        float b = getHeight(uv + vec2(0, -epsilon.y));
        float c = getHeight(uv + vec2(epsilon.x, -epsilon.y));
        float d = getHeight(uv + vec2(-epsilon.x, 0));
        float e = getHeight(uv + vec2(epsilon.x, 0));
        float f = getHeight(uv + vec2(-epsilon.x, epsilon.y));
        float g = getHeight(uv + vec2(0, epsilon.y));
        float h = getHeight(uv + vec2(epsilon.x, epsilon.y));
        vec2 dxy = vec2(
            (c + e + e + h) - (a + d + d + f),
            (f + g + g + h) - (a + b + b + c)
        );
        return normalize(vec3(dxy / epsilon, terrainResolution ));
    }
#endif`,vertex_color_vert:`#ifdef HAS_VERTEX_COLOR
attribute float aVertexColorType;
uniform vec4 vertexColorsOfType[VERTEX_TYPES_COUNT];
varying vec4 vertexColor_color;
void vertexColor_update() {
    vertexColor_color = vertexColorsOfType[int(aVertexColorType)];
}
#endif`,vertex_color_frag:`#ifdef HAS_VERTEX_COLOR
varying vec4 vertexColor_color;
vec4 vertexColor_get() {
	return vertexColor_color;
}
#endif`,excavate_vert:`#ifdef HAS_EXCAVATE_ANALYSIS
  uniform vec4 excavateExtent;
  varying vec2 vCoordinateTexcoord;
  varying float vHeight;
  float getWorldHeight() {
    vec4 wPosition = modelMatrix * getPosition(aPosition);
    return wPosition.z;
  }
  vec2 getCoordinateTexcoord() {
    mat4 localPositionMatrix = getPositionMatrix();
    vec4 wPosition = modelMatrix * localPositionMatrix * getPosition(aPosition);
    float x = (wPosition.x - excavateExtent.x) / (excavateExtent.z - excavateExtent.x);
    float y = (wPosition.y - excavateExtent.y) / (excavateExtent.w - excavateExtent.y);
    return vec2(x, y);
  }
#endif`,excavate_frag:`#ifdef HAS_EXCAVATE_ANALYSIS
  uniform sampler2D heightmap;
  uniform float excavateHeight;
  varying vec2 vCoordinateTexcoord;
  varying float vHeight;
  const vec2 range = vec2(-100.0, 1000.0);
  float decodeHeight(const in vec4 pack) {
      return pack.r + pack.g / 255.0;
  }
  vec4 excavateColor(vec4 fragColor) {
      float samplerHeight = decodeHeight(texture2D(heightmap, vCoordinateTexcoord));
      float realHeight = samplerHeight * (range.y - range.x) + range.x;
      if(realHeight < range.x || realHeight > range.y) {
          realHeight = 0.0;
      }
      if(vHeight > realHeight) {
          discard;
      }
      return fragColor;
  }
#endif`,srgb_frag:`vec3 linearTosRGB(const in vec3 color) {
    return vec3( color.r < 0.0031308 ? color.r * 12.92 : 1.055 * pow(color.r, 1.0/2.4) - 0.055, color.g < 0.0031308 ? color.g * 12.92 : 1.055 * pow(color.g, 1.0/2.4) - 0.055, color.b < 0.0031308 ? color.b * 12.92 : 1.055 * pow(color.b, 1.0/2.4) - 0.055);
}
vec3 sRGBToLinear(const in vec3 color) {
    return vec3( color.r < 0.04045 ? color.r * (1.0 / 12.92) : pow((color.r + 0.055) * (1.0 / 1.055), 2.4), color.g < 0.04045 ? color.g * (1.0 / 12.92) : pow((color.g + 0.055) * (1.0 / 1.055), 2.4), color.b < 0.04045 ? color.b * (1.0 / 12.92) : pow((color.b + 0.055) * (1.0 / 1.055), 2.4));
}`};var Df={register(r,t){if(m0[r])throw new Error(`Key of ${r} is already registered in ShaderLib.`);m0[r]=t},compile:r=>Jw(r)};const MD=/^[ \t]*#include +<([\w\d.]+)>/gm;function Jw(r){return r.replace(MD,SD)}function SD(r,t){const e=m0[t];if(!e)throw new Error("Can not resolve #include <"+t+">");return Jw(e)}const CD="function",PD="array";let ED=0;const Ff={};let OD=class{constructor({vert:t,frag:e,uniforms:n,defines:i,extraCommandProps:o}){this.vert=t,this.frag=e;const s=ED++;Object.defineProperty(this,"uid",{enumerable:!0,configurable:!1,get:()=>s}),this.shaderDefines=i&&$n({},i)||{},n=this.uniforms=(n||[]).slice(),this.contextDesc={};for(let a=0,l=n.length;a<l;a++){const h=n[a];if(kw(h))if(h.indexOf("[")>0){const{name:u,len:c}=Kw(h);this.contextDesc[u]={name:u,type:"array",length:c}}else this.contextDesc[h]=null;else if(h.name.indexOf("[")>0){const{name:u,len:c}=Kw(h.name);this.contextDesc[u]={name:u,type:"array",length:c,fn:h.fn}}else this.contextDesc[h.name]=h}this.extraCommandProps=o&&$n({},o)||{},this.commands={},this._compileSource()}set shaderDefines(t){this._shaderDefines=t,this.dkey=Object.keys(this._shaderDefines).join()}get shaderDefines(){return this._shaderDefines||{}}setDefines(t){this.shaderDefines=t}setFramebuffer(t){return this.context.framebuffer=t,this}appendDescUniforms(t,e){const n=e,i=this.contextDesc;for(const o in i)if(i[o])if(i[o].type==="array"){const s=o,a=i[o].length;let l=e[o];if(i[o].fn&&(l=i[o].fn(null,e)),!l)continue;if(l.length!==a)throw new Error(`${s} uniform's length is not ${a}`);n[s]=n[s]||{};for(let h=0;h<a;h++)n[s][`${h}`]=l[h].getREGLTexture?l[h].getREGLTexture(t):l[h]}else i[o].type==="function"&&(Object.getOwnPropertyDescriptor(n,o)||Object.defineProperty(n,o,{configurable:!1,enumerable:!0,get:function(){return i[o].fn(null,e)}}));return n}setUniforms(t){if(t.modelMatrix||t.positionMatrix)throw new Error("modelMatrix or positionMatrix is reserved uniform name for Mesh, please change to another name");return this.contextKeys=t?Object.keys(t).join():null,this.context=t,this}getVersion(t,e){return e.substring(0,8)==="#version"?"":t.limits.version.indexOf("WebGL 2.0")===0&&this.version===300?`#version 300 es
`:`#version 100
`}getActiveVars(t,e,n,i){const o=i;if(Ff[o])return Ff[o];const s=t._gl,a=s.createProgram(),l=s.createShader(35633);s.shaderSource(l,e),s.compileShader(l);const h=s.createShader(35632);s.shaderSource(h,n),s.compileShader(h),s.attachShader(a,h),s.attachShader(a,l),s.linkProgram(a);const u=s.getProgramParameter(a,35721),c=[];for(let p=0;p<u;++p){const g=s.getActiveAttrib(a,p);g&&c.push({name:g.name,type:g.type})}const f=s.getProgramParameter(a,35718),d=[];for(let p=0;p<f;++p){const g=s.getActiveUniform(a,p);let m=g.name;g.name.indexOf("[")>0&&(m=m.replace("[0]","")),d.push(m)}return s.deleteProgram(a),s.deleteShader(l),s.deleteShader(h),Ff[o]={activeUniforms:d,activeAttributes:c},Ff[o]}createREGLCommand(t,e,n,i,o,s={}){const a=el(t)&&!o,l=$n({},this.shaderDefines||{},e||{}),h=this._insertDefines(this.vert,l),u=this.getVersion(t,h)+h,c=this._insertDefines(this.frag,l),f=this.getVersion(t,c)+c,d=u0(u)+"_"+u0(f),{activeAttributes:p,activeUniforms:g}=this.getActiveVars(t,u,f,d),m={};p.forEach((w,b)=>{const A=w.name;m[A]=a?b:t.prop(A)});const y={};g.forEach(w=>{y[w]=t.prop(w)});const x=this.contextDesc;for(const w in x)if(x[w]&&x[w].type===CD)y[w]=x[w].fn;else if(x[w]&&x[w].type===PD){const b=x[w].name,A=x[w].length;for(let T=0;T<A;T++){const S=`${b}[${T}]`;y[S]=t.prop(S)}}else y[w]=t.prop(w);const v={vert:u,frag:f,uniforms:y,attributes:m};a&&(v.vao=t.prop("vao")),a&&!i||!n||Io(n)||(v.elements=t.prop("elements")),v.count=t.prop("count"),v.offset=t.prop("offset"),v.primitive=t.prop("primitive"),v.framebuffer=t.prop("framebuffer"),i&&(v.instances=t.prop("instances")),$n(v,this.extraCommandProps,s);const _=t(v);return p.key=p.map(w=>w.name).join(),_.activeAttributes=p,_}dispose(){for(const t in this.commands){const e=this.commands[t];e&&e.destroy&&!e[mr]&&(e[mr]=!0,e.destroy())}this.commands={},delete this.vert,delete this.frag}_insertDefines(t,e){const n=[];for(const i in e)Ci(e,i)&&!Si(e[i])&&n.push(`#define ${i} ${e[i]}
`);return n.join("")+t}_compileSource(){this.vert=Df.compile(this.vert),this.frag=Df.compile(this.frag)}};function Kw(r){const t=r.indexOf("["),e=r.indexOf("]");return{name:r.substring(0,t),len:+r.substring(t+1,e)}}let Ye=class extends OD{draw(t,e){if(!e||!e.length)return 0;const n=[];let i,o=0;for(let s=0,a=e.length;s<a;s++){if(!e[s].isValid()){s===a-1&&i&&n.length&&i(n);continue}if(!e[s].geometry.getDrawCount()||!this._runFilter(e[s])){s===a-1&&i&&n.length&&i(n);continue}const l=this.getMeshCommand(t,e[s]);n.length&&i!==l&&(i(n),n.length=0);const h=e[s].getREGLProps(t,l.activeAttributes);this._ensureContextDefines(h),h.shaderContext=this.context,this.appendDescUniforms(t,h),n.push(h),o++,s<a-1?i=l:s===a-1&&l(n)}return o}_ensureContextDefines(t){if(this.context&&(t.contextKeys||(t.contextKeys={}),t.contextKeys[this.uid]!==this.contextKeys)){for(const e in this.context)e==="framebuffer"||Object.getOwnPropertyDescriptor(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:function(){return this.shaderContext[e]}});Object.getOwnPropertyDescriptor(t,"framebuffer")||Object.defineProperty(t,"framebuffer",{configurable:!1,enumerable:!0,get:function(){return this.targetFramebuffer||this.shaderContext&&this.shaderContext.framebuffer}}),t.contextKeys[this.uid]=this.contextKeys}}_runFilter(t){const e=this.filter;if(!e)return!0;if(Array.isArray(e)){for(let n=0;n<e.length;n++)if(!e[n](t))return!1;return!0}return e(t)}getMeshCommand(t,e){this._cmdKeys||(this._cmdKeys={});const n=this.dkey||"default";let i=this._cmdKeys[n];i||(i=this._cmdKeys[n]={});const o=e.getCommandKey(t);i[o]||(i[o]=n+"_"+e.getCommandKey(t));const s=i[o];let a=this.commands[s];if(!a){const l=e.getDefines(),h=e.getMaterial(),u={};h&&h.doubleSided&&this.extraCommandProps&&this.extraCommandProps.cull&&(u.cull={enable:!1}),a=this.commands[s]=this.createREGLCommand(t,l,e.getElements(),e instanceof Zw,e.disableVAO,u)}return a}},Qw=class extends Ye{constructor(t={}){const e=[],n=[],i=t.uniforms,o=[{name:"modelNormalMatrix",type:"function",fn:function(s,a){return Yh(e,a.modelMatrix)}},{name:"modelViewMatrix",type:"function",fn:function(s,a){return qt(n,a.viewMatrix,a.modelMatrix)}}];i&&o.push(...i),super({vert:t.vert||`#include <gl2_vert>
attribute vec3 aPosition;
#include <line_extrusion_vert>
#ifdef HAS_MAP
uniform vec2 uvScale;
uniform vec2 uvOffset;
attribute vec2 aTexCoord;
varying vec2 vTexCoord;
#ifdef HAS_I3S_UVREGION
attribute vec4 uvRegion;
varying vec4 vUvRegion;
#endif
#if defined(HAS_AO_MAP)
attribute vec2 aTexCoord1;
varying vec2 vTexCoord1;
#endif
#endif
#if defined(HAS_COLOR)
attribute vec4 aColor;
#elif defined(HAS_COLOR0)
#if COLOR0_SIZE == 3
attribute vec3 aColor0;
#else
attribute vec4 aColor0;
#endif
varying vec4 vColor;
#endif
varying vec3 vFragPos;
varying vec3 vNormal;
uniform mat4 projMatrix;
uniform mat3 modelNormalMatrix;
uniform mat4 modelViewMatrix;
uniform mat4 modelMatrix;
uniform mat4 positionMatrix;
uniform vec2 halton;
uniform vec2 outSize;
uniform mat4 projViewMatrix;
#include <highlight_vert>
#include <get_output>
#include <heatmap_render_vert>
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
#include <vsm_shadow_vert>
#endif
#ifdef HAS_EXTRUSION_OPACITY
attribute float aExtrusionOpacity;
varying float vExtrusionOpacity;
#endif
#if defined(HAS_TANGENT)
varying vec4 vTangent;
#endif
void c(const highp vec4 q, out highp vec3 d) {
  d = vec3(.0, .0, 1.) + vec3(2., -2., -2.) * q.x * q.zwx + vec3(2., 2., -2.) * q.y * q.wzy;
}
void c(const highp vec4 q, out highp vec3 d, out highp vec3 t) {
  c(q, d);
  t = vec3(1., .0, .0) + vec3(-2., 2., -2.) * q.y * q.yxw + vec3(-2., 2., 2.) * q.z * q.zwx;
}
void main() {
  
#ifdef IS_LINE_EXTRUSION
vec4 e = getPosition(getLineExtrudePosition(aPosition));
#else
vec4 e = getPosition(aPosition);
#endif
mat4 f = getPositionMatrix();
  vFragPos = vec3(modelMatrix * f * e);
#if defined(HAS_NORMAL) || defined(HAS_TANGENT)
mat3 h = modelNormalMatrix * mat3(f);
  vec3 i;
#if defined(HAS_TANGENT)
vec3 t;
  c(aTangent, i, t);
  vTangent = vec4(h * t, aTangent.w);
#else
i = decode_getNormal(aNormal);
#endif
vec3 j = appendMorphNormal(i);
  vNormal = normalize(h * j);
#else
vNormal = vec3(.0);
#endif
mat4 k = projMatrix;
  k[2].xy += halton.xy / outSize.xy;
#ifdef HAS_MASK_EXTENT
gl_Position = k * getMaskPosition(f * e, modelMatrix);
#else
gl_Position = k * modelViewMatrix * f * e;
#endif
#ifdef HAS_MAP
vec2 l = decode_getTexcoord(aTexCoord);
  vTexCoord = l * uvScale + uvOffset;
#endif
#ifdef HAS_AO_MAP
vec2 m = decode_getTexcoord(aTexCoord1);
  vTexCoord1 = m * uvScale + uvOffset;
#endif
#ifdef HAS_EXTRUSION_OPACITY
vExtrusionOpacity = aExtrusionOpacity;
#endif
#if defined(HAS_COLOR)
vColor = aColor / 255.;
#elif defined(HAS_COLOR0)
#if COLOR0_SIZE == 3
vColor = vec4(aColor0 / 255., 1.);
#else
vColor = aColor0 / 255.;
#endif
#endif
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
shadow_computeShadowPars(f * e);
#endif
#ifdef HAS_HEATMAP
heatmap_compute(projMatrix * modelViewMatrix * f, e);
#endif
#ifdef HAS_I3S_UVREGION
vUvRegion = uvRegion / 65535.;
#endif
highlight_setVarying();
}`,frag:t.frag||`precision mediump float;
#include <gl2_frag>
uniform vec4 baseColorFactor;
uniform float materialShininess;
uniform float environmentExposure;
uniform float specularStrength;
uniform vec3 light0_viewDirection;
uniform vec3 ambientColor;
uniform vec4 light0_diffuse;
uniform vec3 lightSpecular;
uniform vec3 cameraPosition;
uniform float alphaTest;
#ifdef HAS_TOON
uniform float toons;
uniform float specularToons;
#endif
#ifdef HAS_TANGENT
varying vec4 vTangent;
#endif
#ifdef HAS_MAP
#include <computeTexcoord_frag>
#endif
varying vec3 vNormal;
varying vec3 vFragPos;
#ifdef HAS_INSTANCE_COLOR
varying vec4 vInstanceColor;
#endif
#ifdef HAS_BASECOLOR_MAP
uniform sampler2D baseColorTexture;
#endif
#ifdef HAS_EXTRUSION_OPACITY
uniform vec2 extrusionOpacityRange;
varying float vExtrusionOpacity;
#endif
#if defined(HAS_COLOR) || defined(HAS_COLOR0)
varying vec4 vColor;
#elif defined(IS_LINE_EXTRUSION)
uniform vec4 lineColor;
#else
uniform vec4 polygonFill;
#endif
#ifdef HAS_LAYER_OPACITY
uniform float layerOpacity;
#endif
#ifdef IS_LINE_EXTRUSION
uniform float lineOpacity;
#else
uniform float polygonOpacity;
#endif
#ifdef HAS_AO_MAP
uniform sampler2D occlusionTexture;
varying vec2 vTexCoord1;
#endif
#ifdef HAS_NORMAL_MAP
uniform sampler2D normalTexture;
#endif
#ifdef HAS_EMISSIVE_MAP
uniform sampler2D emissiveTexture;
#endif
#ifdef SHADING_MODEL_SPECULAR_GLOSSINESS
uniform vec4 diffuseFactor;
uniform vec3 specularFactor;
#ifdef HAS_DIFFUSE_MAP
uniform sampler2D diffuseTexture;
#endif
#ifdef HAS_SPECULARGLOSSINESS_MAP
uniform sampler2D specularGlossinessTexture;
#endif
#endif
#include <heatmap_render_frag>
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
#include <vsm_shadow_frag>
#endif
#include <highlight_frag>
#include <mask_frag>
vec3 c() {
  
#if defined(HAS_NORMAL_MAP)
vec3 d = normalize(vNormal);
  vec3 e = texture2D(normalTexture, computeTexCoord(vTexCoord)).xyz * 2. - 1.;
#if defined(HAS_TANGENT)
vec3 t = normalize(vTangent.xyz);
  vec3 b = normalize(cross(d, t) * sign(vTangent.w));
  mat3 f = mat3(t, b, d);
  return normalize(f * e);
#else
return normalize(e);
#endif
#else
return normalize(vNormal);
#endif
}
vec4 h(const in vec4 i) {
  return vec4(i.r < .0031308 ? i.r * 12.92 : 1.055 * pow(i.r, 1. / 2.4) - .055, i.g < .0031308 ? i.g * 12.92 : 1.055 * pow(i.g, 1. / 2.4) - .055, i.b < .0031308 ? i.b * 12.92 : 1.055 * pow(i.b, 1. / 2.4) - .055, i.a);
}
vec4 j() {
  
#if defined(HAS_BASECOLOR_MAP)
return texture2D(baseColorTexture, computeTexCoord(vTexCoord));
#elif defined(HAS_DIFFUSE_MAP)
return texture2D(diffuseTexture, computeTexCoord(vTexCoord));
#elif defined(SHADING_MODEL_SPECULAR_GLOSSINESS)
return diffuseFactor;
#else
return baseColorFactor;
#endif
}
vec3 k() {
  
#if defined(HAS_SPECULARGLOSSINESS_MAP)
return texture2D(specularGlossinessTexture, computeTexCoord(vTexCoord)).rgb;
#elif defined(SHADING_MODEL_SPECULAR_GLOSSINESS)
return specularFactor;
#else
return vec3(1.);
#endif
}
void main() {
  vec4 l = j();
  vec3 m = environmentExposure * ambientColor * l.rgb;
#ifdef HAS_INSTANCE_COLOR
m *= vInstanceColor.rgb;
#endif
vec3 o = c();
  vec3 u = normalize(-light0_viewDirection);
  float v = max(dot(o, u), .0);
#ifdef HAS_TOON
float A = floor(v * toons);
  v = A / toons;
#endif
vec3 B = light0_diffuse.rgb * v * l.rgb;
#if defined(HAS_COLOR) || defined(HAS_COLOR0)
vec3 i = vColor.rgb;
#elif defined(IS_LINE_EXTRUSION)
vec3 i = lineColor.rgb;
#else
vec3 i = polygonFill.rgb;
#endif
#ifdef HAS_INSTANCE_COLOR
i *= vInstanceColor.rgb;
#endif
m *= i.rgb;
  B *= i.rgb;
  vec3 C = normalize(cameraPosition - vFragPos);
  vec3 D = normalize(u + C);
  float E = pow(max(dot(o, D), .0), materialShininess);
#ifdef HAS_TOON
float F = floor(E * specularToons);
  E = F / specularToons;
#endif
vec3 G = specularStrength * lightSpecular * E * k();
#ifdef HAS_OCCLUSION_MAP
float H = texture2D(occlusionTexture, computeTexCoord(vTexCoord1)).r;
  m *= H;
#endif
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
float I = shadow_computeShadow();
  B = shadow_blend(B, I).rgb;
  G = shadow_blend(G, I).rgb;
  m = shadow_blend(m, I).rgb;
#endif
vec3 J = m + B + G;
#ifdef HAS_EMISSIVE_MAP
vec3 K = texture2D(emissiveTexture, computeTexCoord(vTexCoord)).rgb;
  J += K;
#endif
#ifdef IS_LINE_EXTRUSION
glFragColor = vec4(J, lineOpacity * l.a);
#else
glFragColor = vec4(J, polygonOpacity * l.a);
#endif
#if defined(HAS_COLOR) || defined(HAS_COLOR0)
float L = vColor.a;
#elif defined(IS_LINE_EXTRUSION)
float L = lineColor.a;
#else
float L = polygonFill.a;
#endif
glFragColor *= L;
#ifdef HAS_EXTRUSION_OPACITY
float M = extrusionOpacityRange.x;
  float N = extrusionOpacityRange.y;
  float O = M + vExtrusionOpacity * (N - M);
  O = clamp(O, .0, 1.);
  glFragColor *= O;
#endif
if(glFragColor.a < alphaTest) {
    discard;
  }
#ifdef HAS_HEATMAP
glFragColor = heatmap_getColor(glFragColor);
#endif
glFragColor = highlight_blendColor(glFragColor);
#ifdef HAS_LAYER_OPACITY
glFragColor *= layerOpacity;
#endif
#ifdef HAS_MASK_EXTENT
glFragColor = setMask(glFragColor);
#endif
#if __VERSION__ == 100
gl_FragColor = glFragColor;
#endif
}`,uniforms:o,defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}}),this.version=300}getGeometryDefines(t){const e={};return t.data[t.desc.tangentAttribute]?e.HAS_TANGENT=1:t.data[t.desc.normalAttribute]&&(e.HAS_NORMAL=1),e}};var lo=`#if __VERSION__ == 300
#define attribute in
#define varying out
#endif
attribute vec2 aPosition;
attribute vec2 aTexCoord;
varying vec2 vTexCoord;
void main() {
  gl_Position = vec4(aPosition, 0., 1.);
  vTexCoord = aTexCoord;
}`;const tA=new Int8Array([-1,1,-1,-1,1,1,1,1,-1,-1,1,-1]),kD=new Uint8Array([0,1,0,0,1,1,1,1,0,0,1,0]);let Dr=class extends Ye{constructor(t){t.vert=t.vert||lo,t.extraCommandProps=t.extraCommandProps||{},t.extraCommandProps.depth||(t.extraCommandProps.depth={enable:!1,mask:!1}),t.extraCommandProps.stencil||(t.extraCommandProps.stencil={enable:!1}),super(t)}draw(t){return this._quadMesh||this._createQuadMesh(t),super.draw(t,this._quadMesh)}getMeshCommand(t){const e=this.dkey||"";return this.commands[e+"_quad"]||(this.commands[e+"_quad"]=this.createREGLCommand(t,null,this._quadMesh[0].getElements())),this.commands[e+"_quad"]}_createQuadMesh(t){const e=new ar({aPosition:tA,aTexCoord:kD},null,tA.length/2,{positionSize:2,primitive:"triangles"});e.generateBuffers(t),this._quadMesh=[new nn(e)]}dispose(){if(this._quadMesh){const t=this._quadMesh[0];t.geometry.dispose(),t.dispose()}return delete this._quadMesh,super.dispose()}},ID=class extends Dr{constructor(){super({vert:lo,frag:`#define SHADER_NAME FXAA
#define FXAA_REDUCE_MIN   (1.0/ 128.0)
#define FXAA_REDUCE_MUL   (1.0 / 8.0)
#define FXAA_SPAN_MAX     8.0
precision mediump float;
varying vec2 vTexCoord;
uniform float enableFXAA;
uniform float enableToneMapping;
uniform float enableSharpen;
uniform vec2 resolution;
uniform sampler2D textureSource;
#ifdef HAS_NOAA_TEX
uniform sampler2D noAaTextureSource;
#endif
#ifdef HAS_POINT_TEX
uniform sampler2D pointTextureSource;
#endif
#ifdef HAS_TAA_TEX
uniform sampler2D taaTextureSource;
#ifdef HAS_FXAA_TEX
uniform sampler2D fxaaTextureSource;
#endif
#endif
uniform float pixelRatio;
uniform float sharpFactor;
#ifdef HAS_OUTLINE_TEX
uniform sampler2D textureOutline;
uniform float enableOutline;
uniform float highlightFactor;
uniform float outlineFactor;
uniform float outlineWidth;
uniform vec3 outlineColor;
#endif
vec2 c;
vec4 d(vec2 e) {
  
#ifdef HAS_TAA_TEX
vec4 f = texture2D(textureSource, e);
  vec4 taa = texture2D(taaTextureSource, e);
#ifdef HAS_FXAA_TEX
vec4 h = texture2D(fxaaTextureSource, e);
#else
vec4 h = vec4(.0);
#endif
vec4 i = taa + f * (1. - taa.a);
  return h + i * (1. - h.a);
#else
return texture2D(textureSource, e);
#endif
}
vec4 j(vec2 k) {
  vec4 l;
  mediump vec2 m = vec2(1. / resolution.x, 1. / resolution.y);
  vec3 n = d((k + vec2(-1., -1.)) * m).xyz;
  vec3 o = d((k + vec2(1., -1.)) * m).xyz;
  vec3 u = d((k + vec2(-1., 1.)) * m).xyz;
  vec3 v = d((k + vec2(1.)) * m).xyz;
  vec4 A = d(k * m);
  vec3 B = A.xyz;
  vec3 C = vec3(.299, .587, .114);
  float D = dot(n, C);
  float E = dot(o, C);
  float F = dot(u, C);
  float G = dot(v, C);
  float H = dot(B, C);
  float I = min(H, min(min(D, E), min(F, G)));
  float J = max(H, max(max(D, E), max(F, G)));
  mediump vec2 K;
  K.x = -((D + E) - (F + G));
  K.y = (D + F) - (E + G);
  float L = max((D + E + F + G) * (.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);
  float M = 1. / (min(abs(K.x), abs(K.y)) + L);
  K = min(vec2(FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), K * M)) * m;
  vec4 N = .5 * (d(k * m + K * (1. / 3. - .5)) + d(k * m + K * (2. / 3. - .5)));
  vec4 O = N * .5 + .25 * (d(k * m + K * -.5) + d(k * m + K * .5));
  float P = dot(O.xyz, C);
  if(P < I || P > J)
    l = N;
  else
    l = O;
  return l;
}
vec3 Q(const in vec3 l, const float R) {
  vec2 S = pixelRatio / resolution.xy;
  float T = .0;
  vec4 n = texture2D(textureSource, c + S * vec2(-1., -1.));
  n.rgb = mix(vec3(.0), n.rgb, sign(n.a));
  T += mix(.0, 1., sign(n.a));
  vec4 v = texture2D(textureSource, c + S * vec2(1.));
  v.rgb = mix(vec3(.0), v.rgb, sign(v.a));
  T += mix(.0, 1., sign(v.a));
  vec4 o = texture2D(textureSource, c + S * vec2(1., -1.));
  o.rgb = mix(vec3(.0), o.rgb, sign(o.a));
  T += mix(.0, 1., sign(o.a));
  vec4 u = texture2D(textureSource, c + S * vec2(-1., 1.));
  u.rgb = mix(vec3(.0), u.rgb, sign(u.a));
  T += mix(.0, 1., sign(u.a));
  return l + R * (T * l - n.rgb - o.rgb - u.rgb - v.rgb);
}
vec4 U(const in vec4 l) {
  return vec4(Q(l.rgb, sharpFactor), l.a);
}
vec3 V(const vec3 x) {
  const float a = 2.51;
  const float b = .03;
  const float W = 2.43;
  const float X = .59;
  const float Y = .14;
  return (x * (a * x + b)) / (x * (W * x + X) + Y);
}
vec3 Z(vec3 l) {
  l = l / (l + vec3(1.));
  return l = pow(l, vec3(1. / 2.2));
}
#ifdef HAS_OUTLINE_TEX
vec4 ba() {
  float bb = 2.;
  float bc = 1.;
  float bd = pixelRatio / resolution[0] * outlineWidth;
  float be = pixelRatio / resolution[1] * outlineWidth;
  vec4 bf = (texture2D(textureOutline, c + vec2(bd, be)));
  vec4 bg = (texture2D(textureOutline, c + vec2(bd, .0)));
  vec4 bh = (texture2D(textureOutline, c + vec2(bd, -be)));
  vec4 bi = (texture2D(textureOutline, c + vec2(.0, -be)));
  vec4 bj = (texture2D(textureOutline, c + vec2(-bd, -be)));
  vec4 bk = (texture2D(textureOutline, c + vec2(-bd, .0)));
  vec4 bl = (texture2D(textureOutline, c + vec2(-bd, be)));
  vec4 bm = (texture2D(textureOutline, c + vec2(.0, be)));
  vec4 bn = -bb * bk + bb * bg + -bc * bl + bc * bf + -bc * bj + bc * bh;
  vec4 bo = -bb * bi + bb * bm + -bc * bj + bc * bl + -bc * bh + bc * bf;
  float bp = sqrt(dot(bo, bo) + dot(bn, bn));
  bool bq = bp < 1. / 65025.;
  vec3 br = (texture2D(textureOutline, c)).r * outlineColor;
  if(br == vec3(.0) || (highlightFactor == .0 && bq)) {
    return vec4(.0);
  }
  float bs = bq ? highlightFactor : min(1., sqrt(bp) * outlineFactor);
  return bs * vec4(br, 1.);
}
vec4 bt(const in vec4 l) {
  vec4 ba = ba();
  return ba + vec4(l) * (1. - ba.a);
}
#endif
void main() {
  c = vTexCoord;
  vec4 l;
  if(enableFXAA == 1.) {
    l = j(c * resolution);
  } else {
    l = d(vTexCoord);
  }
  if(enableSharpen == 1.) {
    l = U(l);
  }
#if defined(HAS_NOAA_TEX) || defined(HAS_POINT_TEX)
vec4 bu = vec4(.0);
  vec4 bv = vec4(.0);
#ifdef HAS_POINT_TEX
bu = texture2D(pointTextureSource, vTexCoord);
#endif
#ifdef HAS_NOAA_TEX
bv = texture2D(noAaTextureSource, vTexCoord);
#endif
vec4 bw = bu + bv * (1. - bu.a);
  l = bw + l * (1. - bw.a);
#endif
if(enableToneMapping == 1.) {
    l.rgb = Z(l.rgb);
  }
#ifdef HAS_OUTLINE_TEX
l = bt(l);
#endif
gl_FragColor = l;
}`,extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}})}getMeshCommand(t,e){const n=this.dkey||"";return this.commands[n+"_fxaa"]||(this.commands[n+"_fxaa"]=this.createREGLCommand(t,null,e.getElements())),this.commands[n+"_fxaa"]}},RD=class extends Dr{constructor(){super({vert:lo,frag:`precision mediump float;
varying vec2 vTexCoord;
uniform vec2 resolution;
uniform sampler2D textureSource;
uniform float enableVignette;
uniform float enableGrain;
uniform float enableLut;
uniform float timeGrain;
uniform float grainFactor;
uniform vec2 lensRadius;
uniform float frameMod;
uniform sampler2D lookupTable;
float c(const in vec2 d) {
  vec3 e = fract(vec3(d.xyx) * .1031);
  e += dot(e, e.yzx + 19.19);
  return fract((e.x + e.y) * e.z);
}
float f() {
  float h = c(gl_FragCoord.xy + 1000.0 * fract(timeGrain));
  float i = h * 2. - 1.;
  h = i * inversesqrt(abs(i));
  h = max(-1., h);
  h = h - sign(i) + .5;
  return (h + .5) * .5;
}
vec4 j(const in vec4 k) {
  float l = f();
  return vec4(mix(k.rgb, k.rgb * (k.rgb + (1. - k.rgb) * 2. * l), grainFactor), k.a);
}
float m(const in float k) {
  return k < .0031308 ? k * 12.92 : 1.055 * pow(k, 1. / 2.4) - .055;
}
vec3 m(const in vec3 k) {
  return vec3(k.r < .0031308 ? k.r * 12.92 : 1.055 * pow(k.r, 1. / 2.4) - .055, k.g < .0031308 ? k.g * 12.92 : 1.055 * pow(k.g, 1. / 2.4) - .055, k.b < .0031308 ? k.b * 12.92 : 1.055 * pow(k.b, 1. / 2.4) - .055);
}
vec4 m(const in vec4 k) {
  return vec4(k.r < .0031308 ? k.r * 12.92 : 1.055 * pow(k.r, 1. / 2.4) - .055, k.g < .0031308 ? k.g * 12.92 : 1.055 * pow(k.g, 1. / 2.4) - .055, k.b < .0031308 ? k.b * 12.92 : 1.055 * pow(k.b, 1. / 2.4) - .055, k.a);
}
float n(const in float k) {
  return k < .04045 ? k * (1. / 12.92) : pow((k + .055) * (1. / 1.055), 2.4);
}
vec3 n(const in vec3 k) {
  return vec3(k.r < .04045 ? k.r * (1. / 12.92) : pow((k.r + .055) * (1. / 1.055), 2.4), k.g < .04045 ? k.g * (1. / 12.92) : pow((k.g + .055) * (1. / 1.055), 2.4), k.b < .04045 ? k.b * (1. / 12.92) : pow((k.b + .055) * (1. / 1.055), 2.4));
}
vec4 n(const in vec4 k) {
  return vec4(k.r < .04045 ? k.r * (1. / 12.92) : pow((k.r + .055) * (1. / 1.055), 2.4), k.g < .04045 ? k.g * (1. / 12.92) : pow((k.g + .055) * (1. / 1.055), 2.4), k.b < .04045 ? k.b * (1. / 12.92) : pow((k.b + .055) * (1. / 1.055), 2.4), k.a);
}
float o(const in vec2 d, const in float u) {
  vec3 v = vec3(.06711056, .00583715, 52.9829189);
  return fract(v.z * fract(dot(d.xy + u * vec2(47., 17.) * .695, v.xy)));
}
float A() {
  vec2 B = lensRadius;
  B.y = min(B.y, B.x - 1e-4);
  float C = o(gl_FragCoord.xy, frameMod);
  C = (B.x - B.y) * (B.x + B.y) * .07 * (C - .5);
  return smoothstep(B.x, B.y, C + distance(vTexCoord, vec2(.5)));
}
vec4 D(const in vec4 k) {
  float l = A();
  return vec4(m(n(k.rgb) * l), clamp(k.a + (1. - l), .0, 1.));
}
vec4 E(in vec4 F, in sampler2D G) {
  mediump float H = F.b * 63.;
  mediump vec2 I;
  I.y = floor(floor(H) / 8.);
  I.x = floor(H) - I.y * 8.;
  mediump vec2 J;
  J.y = floor(ceil(H) / 8.);
  J.x = ceil(H) - J.y * 8.;
  highp vec2 K;
  K.x = I.x * .125 + .5 / 512. + (.125 - 1. / 512.) * F.r;
  K.y = I.y * .125 + .5 / 512. + (.125 - 1. / 512.) * F.g;
#ifdef LUT_FLIP_Y
K.y = 1. - K.y;
#endif
highp vec2 L;
  L.x = J.x * .125 + .5 / 512. + (.125 - 1. / 512.) * F.r;
  L.y = J.y * .125 + .5 / 512. + (.125 - 1. / 512.) * F.g;
#ifdef LUT_FLIP_Y
L.y = 1. - L.y;
#endif
lowp vec4 M = texture2D(G, K);
  lowp vec4 N = texture2D(G, L);
  lowp vec4 O = mix(M, N, fract(H));
  return O;
}
void main() {
  vec4 k = texture2D(textureSource, vTexCoord);
  if(enableLut == 1.) {
    k = E(k, lookupTable);
  }
  if(enableVignette == 1.) {
    k = D(k);
  }
  if(enableGrain == 1.) {
    k = j(k);
  }
  gl_FragColor = k;
}`,extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}})}getMeshCommand(t,e){return this.commands.postprocess||(this.commands.postprocess=this.createREGLCommand(t,null,e.getElements())),this.commands.postprocess}};const il=[[.263385,-.0252475],[-.38545,.054485],[-.139795,-.5379925],[-.2793775,.6875475],[.7139025,.4710925],[.90044,-.16422],[.4481775,-.82799],[-.9253375,-.2910625],[.3468025,1.02292],[-1.13742,.33522],[-.7676225,-.9123175],[-.2005775,-1.1774125],[-.926525,.96876],[1.12909,-.7500325],[.9603,1.14625]],eu=il.length,as=[0,0];for(let r=0;r<il.length;r++)as[0]+=il[r][0],as[1]+=il[r][1];as[0]/=eu,as[1]/=eu;let DD=class{constructor(t){this._frameNum=0,this._ratio=t||.05,this._avg=[as[0]*this._ratio,as[1]*this._ratio]}getRatio(){return this._ratio}setRatio(t){this._ratio!==t&&(this._ratio=t,this.reset()),this._avg=[as[0]*this._ratio,as[1]*this._ratio]}getAverage(){return this._avg}reset(){this._frameNum=0}getJitter(t){const e=this._frameNum%eu,n=this._ratio;return Pe(t,il[e][0]*n,il[e][1]*n),t}frame(){this._frameNum++,this._frameNum%eu==0&&(this._frameNum=0)}getSampleCount(){return eu}},FD=class{constructor(t,e,n=5){this._regl=t,this._renderer=new un(t),this._inputRGBM=e,this._level=n}render(t,e){this._initShaders(),this._createTextures(t),this._blur(t,e||0);const n={blurTex0:this._blur01Tex,blurTex1:this._blur11Tex,blurTex2:this._blur21Tex,blurTex3:this._blur31Tex,blurTex4:this._blur41Tex};return this._level>5&&(n.blurTex5=this._blur51Tex,n.blurTex6=this._blur61Tex),n}_blur(t,e){let n=this._blurUniforms;n||(n=this._blurUniforms={rgbmRange:7,blurDir:[0,0],outSize:[0,0],pixelRatio:[1,1],outputSize:[0,0]}),Pe(n.outSize,t.width,t.height),this._blurOnce(this._blur0Shader,t,this._blur00FBO,this._blur01FBO,.5,e),this._blurOnce(this._blur1Shader,this._blur01FBO.color[0],this._blur10FBO,this._blur11FBO,.5),this._blurOnce(this._blur2Shader,this._blur11FBO.color[0],this._blur20FBO,this._blur21FBO,.5),this._blurOnce(this._blur3Shader,this._blur21FBO.color[0],this._blur30FBO,this._blur31FBO,.5),this._blurOnce(this._blur4Shader,this._blur31FBO.color[0],this._blur40FBO,this._blur41FBO,.5),this._level>5&&(this._blurOnce(this._blur5Shader,this._blur41FBO.color[0],this._blur50FBO,this._blur51FBO,.5),this._blurOnce(this._blur6Shader,this._blur51FBO.color[0],this._blur60FBO,this._blur51FBO,.5))}_blurOnce(t,e,n,i,o,s){const a=Math.ceil(o*e.width),l=Math.ceil(o*e.height);n.width===a&&n.height===l||n.resize(a,l),i.width===a&&i.height===l||i.resize(a,l);const h=this._blurUniforms;h.luminThreshold=s,h.TextureBlurInput=e,h.inputRGBM=+this._inputRGBM,Pe(h.blurDir,0,1),Pe(h.outputSize,n.width,n.height),this._renderer.render(t,h,null,n),h.luminThreshold=0,h.inputRGBM=1,Pe(h.blurDir,1,0),h.TextureBlurInput=n.color[0],this._renderer.render(t,h,null,i)}dispose(){this._blur0Shader&&(this._blur0Shader.dispose(),delete this._blur0Shader,this._blur1Shader.dispose(),this._blur2Shader.dispose(),this._blur3Shader.dispose(),this._blur4Shader.dispose(),this._blur5Shader&&(this._blur5Shader.dispose(),this._blur6Shader.dispose(),delete this._blur5Shader)),this._blur00Tex&&(delete this._blur00Tex,this._blur00FBO.destroy(),this._blur01FBO.destroy(),this._blur10FBO.destroy(),this._blur11FBO.destroy(),this._blur20FBO.destroy(),this._blur21FBO.destroy(),this._blur30FBO.destroy(),this._blur31FBO.destroy(),this._blur40FBO.destroy(),this._blur41FBO.destroy(),this._blur50FBO&&(this._blur50FBO.destroy(),this._blur51FBO.destroy(),this._blur60FBO.destroy(),this._blur61FBO.destroy()))}_createTextures(t){if(this._blur00Tex)return;let e=t.width,n=t.height;this._blur00Tex=this._createColorTex(t,e,n),this._blur00FBO=this._createBlurFBO(this._blur00Tex),this._blur01Tex=this._createColorTex(t),this._blur01FBO=this._createBlurFBO(this._blur01Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur10Tex=this._createColorTex(t,e,n),this._blur10FBO=this._createBlurFBO(this._blur10Tex),this._blur11Tex=this._createColorTex(t,e,n),this._blur11FBO=this._createBlurFBO(this._blur11Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur20Tex=this._createColorTex(t,e,n),this._blur20FBO=this._createBlurFBO(this._blur20Tex),this._blur21Tex=this._createColorTex(t,e,n),this._blur21FBO=this._createBlurFBO(this._blur21Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur30Tex=this._createColorTex(t,e,n),this._blur30FBO=this._createBlurFBO(this._blur30Tex),this._blur31Tex=this._createColorTex(t,e,n),this._blur31FBO=this._createBlurFBO(this._blur31Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur40Tex=this._createColorTex(t,e,n),this._blur40FBO=this._createBlurFBO(this._blur40Tex),this._blur41Tex=this._createColorTex(t,e,n),this._blur41FBO=this._createBlurFBO(this._blur41Tex),this._level>5&&(e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur50Tex=this._createColorTex(t,e,n),this._blur50FBO=this._createBlurFBO(this._blur50Tex),this._blur51Tex=this._createColorTex(t,e,n),this._blur51FBO=this._createBlurFBO(this._blur51Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur60Tex=this._createColorTex(t,e,n),this._blur60FBO=this._createBlurFBO(this._blur60Tex),this._blur61Tex=this._createColorTex(t,e,n),this._blur61FBO=this._createBlurFBO(this._blur61Tex))}_createColorTex(t,e,n){return this._regl.texture({min:"linear",mag:"linear",type:"uint8",width:e||t.width,height:n||t.height})}_createBlurFBO(t){return this._regl.framebuffer({width:t.width,height:t.height,colors:[t],depth:!1,stencil:!1})}_initShaders(){if(!this._blur0Shader){const t={vert:lo,extraCommandProps:{viewport:{x:0,y:0,width:(e,n)=>n.outputSize[0],height:(e,n)=>n.outputSize[1]}},frag:`#version 100
precision highp float;
uniform float rgbmRange;
uniform sampler2D TextureBlurInput;
uniform sampler2D TextureInput;
uniform vec2 blurDir;
uniform vec2 pixelRatio;
uniform vec2 outputSize;
uniform float inputRGBM;
uniform float luminThreshold;
#define SHADER_NAME GAUSSIAN_BLUR0
const vec3 c = vec3(.2126, .7152, .0722);
float d(const in vec3 e) {
  return dot(e, c);
}
vec4 f(vec4 e) {
  float h = max(sign(d(e.rgb) - luminThreshold), .0);
  return e * h;
}
vec2 i;
vec4 j(const in vec3 e, const in float k) {
  vec4 l;
  vec3 m = e / k;
  l.a = clamp(max(max(m.r, m.g), max(m.b, 1e-6)), .0, 1.);
  l.a = ceil(l.a * 255.) / 255.;
  l.rgb = m / l.a;
  return l;
}
vec3 n(const in vec4 e, const in float k) {
  if(inputRGBM == .0)
    return e.rgb;
  return k * e.rgb * e.a;
}
vec4 o() {
  vec3 u = .375 * (f(vec4(n(texture2D(TextureBlurInput, i.xy), rgbmRange), 1.))).rgb;
  vec2 v;
  vec2 A = pixelRatio.xy * blurDir.xy / outputSize.xy;
  v = A * 1.2;
  u += .3125 * (f(vec4(n(texture2D(TextureBlurInput, i.xy + v.xy), rgbmRange), 1.))).rgb;
  u += .3125 * (f(vec4(n(texture2D(TextureBlurInput, i.xy - v.xy), rgbmRange), 1.))).rgb;
  return vec4(u, 1.);
}
void main(void) {
  i = gl_FragCoord.xy / outputSize.xy;
  vec4 e = o();
  e = j(e.rgb, rgbmRange);
  gl_FragColor = e;
}`};this._blur0Shader=new Dr(t),t.frag=`#version 100
precision highp float;
uniform float rgbmRange;
uniform sampler2D TextureBlurInput;
uniform sampler2D TextureInput;
uniform vec2 blurDir;
uniform vec2 pixelRatio;
uniform vec2 outputSize;
#define SHADER_NAME GAUSSIAN_BLUR1
vec2 c;
vec4 d(const in vec3 e, const in float f) {
  if(f <= .0)
    return vec4(e, 1.);
  vec4 h;
  vec3 i = e / f;
  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);
  h.a = ceil(h.a * 255.) / 255.;
  h.rgb = i / h.a;
  return h;
}
vec3 j(const in vec4 e, const in float f) {
  if(f <= .0)
    return e.rgb;
  return f * e.rgb * e.a;
}
vec4 k() {
  vec3 l = .3125 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;
  vec2 m;
  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;
  m = n * 1.2857142857142858;
  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;
  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;
  return vec4(l, 1.);
}
void main(void) {
  c = gl_FragCoord.xy / outputSize.xy;
  vec4 e = k();
  e = d(e.rgb, rgbmRange);
  gl_FragColor = e;
}`,this._blur1Shader=new Dr(t),t.frag=`#version 100
precision highp float;
uniform float rgbmRange;
uniform sampler2D TextureBlurInput;
uniform sampler2D TextureInput;
uniform vec2 blurDir;
uniform vec2 pixelRatio;
uniform vec2 outputSize;
#define SHADER_NAME GAUSSIAN_BLUR2
vec2 c;
vec4 d(const in vec3 e, const in float f) {
  if(f <= .0)
    return vec4(e, 1.);
  vec4 h;
  vec3 i = e / f;
  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);
  h.a = ceil(h.a * 255.) / 255.;
  h.rgb = i / h.a;
  return h;
}
vec3 j(const in vec4 e, const in float f) {
  if(f <= .0)
    return e.rgb;
  return f * e.rgb * e.a;
}
vec4 k() {
  vec3 l = .2734375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;
  vec2 m;
  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;
  m = n * 1.3333333333333333;
  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;
  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;
  m = n * 3.111111111111111;
  l += .03515625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;
  l += .03515625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;
  return vec4(l, 1.);
}
void main(void) {
  c = gl_FragCoord.xy / outputSize.xy;
  vec4 e = k();
  e = d(e.rgb, rgbmRange);
  gl_FragColor = e;
}`,this._blur2Shader=new Dr(t),t.frag=`#version 100
precision highp float;
uniform float rgbmRange;
uniform sampler2D TextureBlurInput;
uniform sampler2D TextureInput;
uniform vec2 blurDir;
uniform vec2 pixelRatio;
uniform vec2 outputSize;
#define SHADER_NAME GAUSSIAN_BLUR3
vec2 c;
vec4 d(const in vec3 e, const in float f) {
  if(f <= .0)
    return vec4(e, 1.);
  vec4 h;
  vec3 i = e / f;
  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);
  h.a = ceil(h.a * 255.) / 255.;
  h.rgb = i / h.a;
  return h;
}
vec3 j(const in vec4 e, const in float f) {
  if(f <= .0)
    return e.rgb;
  return f * e.rgb * e.a;
}
vec4 k() {
  vec3 l = .24609375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;
  vec2 m;
  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;
  m = n * 1.3636363636363635;
  l += .322265625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;
  l += .322265625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;
  m = n * 3.1818181818181817;
  l += .0537109375 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;
  l += .0537109375 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;
  return vec4(l, 1.);
}
void main(void) {
  c = gl_FragCoord.xy / outputSize.xy;
  vec4 e = k();
  e = d(e.rgb, rgbmRange);
  gl_FragColor = e;
}`,this._blur3Shader=new Dr(t),t.frag=`#version 100
precision highp float;
uniform float rgbmRange;
uniform sampler2D TextureBlurInput;
uniform sampler2D TextureInput;
uniform vec2 blurDir;
uniform vec2 pixelRatio;
uniform vec2 outputSize;
#define SHADER_NAME GAUSSIAN_BLUR4
vec2 c;
vec4 d(const in vec3 e, const in float f) {
  if(f <= .0)
    return vec4(e, 1.);
  vec4 h;
  vec3 i = e / f;
  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);
  h.a = ceil(h.a * 255.) / 255.;
  h.rgb = i / h.a;
  return h;
}
vec3 j(const in vec4 e, const in float f) {
  if(f <= .0)
    return e.rgb;
  return f * e.rgb * e.a;
}
vec4 k() {
  vec3 l = .2255859375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;
  vec2 m;
  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;
  m = n * 1.3846153846153846;
  l += .314208984375 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;
  l += .314208984375 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;
  m = n * 3.230769230769231;
  l += .06982421875 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;
  l += .06982421875 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;
  m = n * 5.076923076923077;
  l += .003173828125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;
  l += .003173828125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;
  return vec4(l, 1.);
}
void main(void) {
  c = gl_FragCoord.xy / outputSize.xy;
  vec4 e = k();
  e = d(e.rgb, rgbmRange);
  gl_FragColor = e;
}`,this._blur4Shader=new Dr(t),this._level>5&&(t.frag=`precision highp float;
uniform float rgbmRange;
uniform sampler2D TextureBlurInput;
uniform sampler2D TextureInput;
uniform vec2 blurDir;
uniform vec2 outSize;
uniform vec2 pixelRatio;
uniform vec2 outputSize;
#define SHADER_NAME GAUSSIAN_BLUR5
vec2 c;
vec4 d(const in vec3 e, const in float f) {
  if(f <= .0)
    return vec4(e, 1.);
  vec4 h;
  vec3 i = e / f;
  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);
  h.a = ceil(h.a * 255.) / 255.;
  h.rgb = i / h.a;
  return h;
}
vec3 j(const in vec4 e, const in float f) {
  if(f <= .0)
    return e.rgb;
  return f * e.rgb * e.a;
}
vec4 k() {
  vec3 l = .20947265625 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;
  vec2 m;
  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;
  n *= outSize.y * .00075;
  m = n * 1.4;
  l += .30548095703125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;
  l += .30548095703125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;
  m = n * 3.2666666666666666;
  l += .08331298828125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;
  l += .08331298828125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;
  m = n * 5.133333333333334;
  l += .00640869140625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;
  l += .00640869140625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;
  return vec4(l, 1.);
}
void main(void) {
  c = gl_FragCoord.xy / outputSize.xy;
  vec4 e = k();
  e = d(e.rgb, rgbmRange);
  gl_FragColor = e;
}`,this._blur5Shader=new Dr(t),t.frag=`#version 100
precision highp float;
uniform float rgbmRange;
uniform sampler2D TextureBlurInput;
uniform sampler2D TextureInput;
uniform vec2 blurDir;
uniform vec2 outSize;
uniform vec2 pixelRatio;
uniform vec2 outputSize;
#define SHADER_NAME GAUSSIAN_BLUR6
vec2 c;
vec4 d(const in vec3 e, const in float f) {
  if(f <= .0)
    return vec4(e, 1.);
  vec4 h;
  vec3 i = e / f;
  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);
  h.a = ceil(h.a * 255.) / 255.;
  h.rgb = i / h.a;
  return h;
}
vec3 j(const in vec4 e, const in float f) {
  if(f <= .0)
    return e.rgb;
  return f * e.rgb * e.a;
}
vec4 k() {
  vec3 l = .196380615234375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;
  vec2 m;
  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;
  n *= outSize.y * .00075;
  m = n * 1.411764705882353;
  l += .2967529296875 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;
  l += .2967529296875 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;
  m = n * 3.2941176470588234;
  l += .09442138671875 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;
  l += .09442138671875 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;
  m = n * 5.176470588235294;
  l += .0103759765625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;
  l += .0103759765625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;
  return vec4(l, 1.);
}
void main(void) {
  c = gl_FragCoord.xy / outputSize.xy;
  vec4 e = k();
  e = d(e.rgb, rgbmRange);
  gl_FragColor = e;
}`,this._blur6Shader=new Dr(t))}}},LD=class{constructor(t){this._regl=t,this._renderer=new un(t)}render(t,e,n,i,o,s,a,l,h){this._initShaders(),this._createTextures(t);const u=this._blurPass.render(e,n);return this._combine(t,u,e,i,o,s,a,l,h)}_combine(t,e,n,i,o,s,a,l,h){h||this._combineTex.width===t.width&&this._combineTex.height===t.height||this._combineFBO.resize(t.width,t.height);let u=this._combineUniforms;const{blurTex0:c,blurTex1:f,blurTex2:d,blurTex3:p,blurTex4:g}=e;u||(u=this._combineUniforms={bloomFactor:0,bloomRadius:0,rgbmRange:7,TextureBloomBlur1:c,TextureBloomBlur2:f,TextureBloomBlur3:d,TextureBloomBlur4:p,TextureBloomBlur5:g,TextureInput:null,TextureSource:null,outputSize:[0,0]}),u.noAaTextureSource=s,u.pointTextureSource=a,u.enableAA=l,u.bloomFactor=i,u.bloomRadius=o,u.TextureInput=n,u.TextureSource=t,Pe(u.outputSize,t.width,t.height);const m={};return s?m.HAS_NOAA_TEX=1:delete m.HAS_NOAA_TEX,a?m.HAS_POINT_TEX=1:delete m.HAS_POINT_TEX,this._combineShader.setDefines(m),this._renderer.render(this._combineShader,u,null,h?null:this._combineFBO),h?null:this._combineTex}dispose(){this._combineFBO&&(this._combineFBO.destroy(),delete this._combineFBO),this._blurPass&&(this._blurPass.dispose(),delete this._blurPass),delete this._uniforms}_createTextures(t){this._combineTex||(this._combineTex=this._createColorTex(t,t.width,t.height,"uint8"),this._combineFBO=this._createBlurFBO(this._combineTex))}_createColorTex(t,e,n,i){return this._renderer.regl.texture({min:"linear",mag:"linear",type:i,width:e||t.width,height:n||t.height})}_createBlurFBO(t){return this._renderer.regl.framebuffer({width:t.width,height:t.height,colors:[t],depth:!1,stencil:!1})}_initShaders(){if(!this._combineShader){const t={x:0,y:0,width:(e,n)=>n.outputSize[0],height:(e,n)=>n.outputSize[1]};this._blurPass=new FD(this._regl,!1),this._combineShader=new Dr({vert:lo,frag:`#define FXAA_REDUCE_MIN   (1.0/ 128.0)
#define FXAA_REDUCE_MUL   (1.0 / 8.0)
#define FXAA_SPAN_MAX     8.0
precision highp float;
uniform float bloomFactor;
uniform float bloomRadius;
uniform float rgbmRange;
uniform sampler2D TextureBloomBlur1;
uniform sampler2D TextureBloomBlur2;
uniform sampler2D TextureBloomBlur3;
uniform sampler2D TextureBloomBlur4;
uniform sampler2D TextureBloomBlur5;
uniform sampler2D TextureInput;
uniform sampler2D TextureSource;
#ifdef HAS_NOAA_TEX
uniform sampler2D noAaTextureSource;
#endif
#ifdef HAS_POINT_TEX
uniform sampler2D pointTextureSource;
#endif
uniform float enableAA;
uniform vec2 outputSize;
#define SHADER_NAME bloomCombine
vec2 c;
vec3 d(const in vec3 e) {
  return vec3(e.r < .0031308 ? e.r * 12.92 : 1.055 * pow(e.r, 1. / 2.4) - .055, e.g < .0031308 ? e.g * 12.92 : 1.055 * pow(e.g, 1. / 2.4) - .055, e.b < .0031308 ? e.b * 12.92 : 1.055 * pow(e.b, 1. / 2.4) - .055);
}
vec3 f(const in vec4 e, const in float h) {
  if(h <= .0)
    return e.rgb;
  return h * e.rgb * e.a;
}
float i(const float j, const float k) {
  return mix(j, k * 2. - j, bloomRadius);
}
vec4 l(sampler2D m, vec2 n) {
  vec4 e;
  mediump vec2 o = vec2(1. / outputSize.x, 1. / outputSize.y);
  vec3 u = texture2D(m, (n + vec2(-1., -1.)) * o).xyz;
  vec3 v = texture2D(m, (n + vec2(1., -1.)) * o).xyz;
  vec3 A = texture2D(m, (n + vec2(-1., 1.)) * o).xyz;
  vec3 B = texture2D(m, (n + vec2(1.)) * o).xyz;
  vec4 C = texture2D(m, n * o);
  vec3 D = C.xyz;
  vec3 E = vec3(.299, .587, .114);
  float F = dot(u, E);
  float G = dot(v, E);
  float H = dot(A, E);
  float I = dot(B, E);
  float J = dot(D, E);
  float K = min(J, min(min(F, G), min(H, I)));
  float L = max(J, max(max(F, G), max(H, I)));
  mediump vec2 M;
  M.x = -((F + G) - (H + I));
  M.y = (F + H) - (G + I);
  float N = max((F + G + H + I) * (.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);
  float O = 1. / (min(abs(M.x), abs(M.y)) + N);
  M = min(vec2(FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), M * O)) * o;
  vec4 P = .5 * (texture2D(m, n * o + M * (1. / 3. - .5)) + texture2D(m, n * o + M * (2. / 3. - .5)));
  vec4 Q = P * .5 + .25 * (texture2D(m, n * o + M * -.5) + texture2D(m, n * o + M * .5));
  float R = dot(Q.xyz, E);
  if(R < K || R > L)
    e = P;
  else
    e = Q;
  return e;
}
vec4 S() {
  vec3 T = vec3(.0);
  const float U = .6;
  const float V = 1.1;
  const float W = .9;
  const float X = .6;
  const float Y = .3;
  const float Z = .1;
  T += (vec4(f(texture2D(TextureBloomBlur1, c), rgbmRange), 1.)).rgb * i(V, U);
  T += (vec4(f(texture2D(TextureBloomBlur2, c), rgbmRange), 1.)).rgb * i(W, U);
  T += (vec4(f(texture2D(TextureBloomBlur3, c), rgbmRange), 1.)).rgb * i(X, U);
  T += (vec4(f(texture2D(TextureBloomBlur4, c), rgbmRange), 1.)).rgb * i(Y, U);
  T += (vec4(f(texture2D(TextureBloomBlur5, c), rgbmRange), 1.)).rgb * i(Z, U);
  vec4 ba;
  if(enableAA == 1.) {
    ba = l(TextureInput, gl_FragCoord.xy);
  } else {
    ba = texture2D(TextureInput, c);
  }
  ba.rgb = mix(vec3(.0), ba.rgb, sign(ba.a));
  vec4 bb = texture2D(TextureSource, c);
#ifdef HAS_NOAA_TEX
vec4 bc = texture2D(noAaTextureSource, c);
  bb = bc + bb * (1. - bc.a);
#endif
vec4 bd = vec4(.0);
#ifdef HAS_POINT_TEX
bd = texture2D(pointTextureSource, c);
#endif
float be = sqrt((T.r + T.g + T.b) / 3.);
  vec4 bf = vec4(d(T * bloomFactor), be);
  return bd + (ba + bb * (1. - ba.a)) * (1. - bd.a) + bf;
}
void main(void) {
  c = gl_FragCoord.xy / outputSize.xy;
  vec4 e = S();
  gl_FragColor = e;
}`,extraCommandProps:{viewport:t}})}}},zD=class extends Dr{constructor(){const t=[];super({vert:lo,frag:`precision highp float;
#include <gl2_frag>
#define SHADER_NAME COPY_DEPTH
uniform sampler2D TextureDepth;
uniform vec2 textureSize;
#include <common_pack_float>
void main(void) {
  vec2 c = gl_FragCoord.xy / textureSize.xy;
  float d = texture2D(TextureDepth, c).r;
  glFragColor = common_encodeDepth(d);
#if __VERSION__ == 100
gl_FragColor = glFragColor;
#endif
}`,uniforms:[{name:"textureSize",type:"function",fn:(e,n)=>(t[0]=n.TextureDepth.width,t[1]=n.TextureDepth.height,t)}],extraCommandProps:{viewport:{x:0,y:0,width:(e,n)=>n.TextureDepth.width,height:(e,n)=>n.TextureDepth.height}}}),this.version=300}getMeshCommand(t,e){return this.commands.copy_depth||(this.commands.copy_depth=this.createREGLCommand(t,null,e.getElements())),this.commands.copy_depth}},Lf=class{static getUniformDeclares(){const t=[[0,0,0,0],[0,0,0,0]],e=new Array(16);return[{name:"invProjMatrix",type:"function",fn:(n,i)=>$s(e,i.projMatrix)},{name:"outputFovInfo",type:"array",length:2,fn:function(n,i){const o=Math.tan(.5*i.fov),s=i.outSize[0]/i.outSize[1]*o;return Tr(t[0],s,o,s,-o),Tr(t[1],-s,o,-s,-o),t}},{name:"reprojViewProjMatrix",type:"function",fn:(n,i)=>qt([],i.prevProjViewMatrix,i.cameraWorldMatrix)}]}static getDefines(){return{HAS_SSR:1}}constructor(t){this._regl=t,this._renderer=new un(t),this._inputRGBM=0}setup(t){this._initShaders(),this._createTextures(t)}getSSRUniforms(t,e,n){if(!this._depthCopy)return null;const i=this._depthCopy;return{TextureDepth:i,TextureReflected:this.getMipmapTexture(),ssrFactor:e||1,ssrQuality:n||2,outSize:[i.width,i.height],fov:t.getFov()*Math.PI/180,prevProjViewMatrix:this._projViewMatrix||t.projViewMatrix,cameraWorldMatrix:t.cameraWorldMatrix}}genMipMap(t,e,n){return this.setup(t),this._mipmap(t),this.copyDepthTex(e),this._projViewMatrix||(this._projViewMatrix=[]),io(this._projViewMatrix,n),delete this._depthCopied,this._outputTex}getPrevProjViewMatrix(){return this._projViewMatrix}copyDepthTex(t){return this._depthCopied?null:(this.setup(t),this._depthCopy?t.width===this._depthCopy.width&&t.height===this._depthCopy.height||this._depthCopyFBO.resize(t.width,t.height):(this._depthCopy=this._regl.texture({min:"nearest",mag:"nearest",mipmap:!1,type:"uint8",width:t.width,height:t.height}),this._depthCopyFBO=this._regl.framebuffer({width:t.width,height:t.height,colors:[this._depthCopy],colorFormat:"rgba"})),this._renderer.render(this._copyDepthShader,{TextureDepth:t},null,this._depthCopyFBO),this._depthCopied=!0,this._depthCopy)}_mipmap(t){const e=this._targetFBO,n=Math.ceil(.5*t.width),i=Math.ceil(.5*t.height);e.width===n&&e.height===i||e.resize(n,i);let o=this._blurUniforms;o||(o=this._blurUniforms={rgbmRange:7,outputSize:[0,0]}),o.TextureInput=t,o.inputRGBM=+this._inputRGBM,Pe(o.outputSize,e.width,e.height),this._renderer.render(this._ssrQuadShader,o,null,e)}getMipmapTexture(){return this._outputTex||(this._outputTex=this._renderer.regl.texture({type:"uint8",width:2,height:2})),this._outputTex}dispose(){this._copyDepthShader&&(this._ssrQuadShader.dispose(),this._copyDepthShader.dispose(),this._targetFBO.destroy(),delete this._copyDepthShader),this._depthCopy&&(this._depthCopyFBO.destroy(),delete this._depthCopy,delete this._depthCopyFBO)}_initShaders(){this._copyDepthShader||(this._copyDepthShader=new zD,this._ssrQuadShader=new Dr({vert:lo,frag:`#version 100
precision mediump float;
uniform sampler2D TextureInput;
uniform vec2 outputSize;
#define SHADER_NAME QUAD
vec2 c;
void main(void) {
  c = gl_FragCoord.xy / outputSize.xy;
  vec4 d = texture2D(TextureInput, c.xy);
  gl_FragColor = d;
}`,extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.outputSize[0],height:(t,e)=>e.outputSize[1]}}}))}_createTextures(t){if(!this._targetFBO){const e=this._regl;this._outputTex&&this._outputTex.destroy(),this._outputTex=e.texture({min:"linear",mag:"linear",type:"uint8",width:t.width,height:t.height}),this._targetFBO=e.framebuffer({width:t.width,height:t.height,colors:[this._outputTex],depth:!1,stencil:!1})}}},HD=class extends Ye{constructor(t){const e=[];super({vert:`#define SHADER_NAME HEATMAP
uniform mat4 projViewModelMatrix;
uniform float extrudeScale;
uniform float heatmapIntensity;
attribute vec3 aPosition;
varying vec2 vExtrude;
#ifdef HAS_HEAT_WEIGHT
attribute highp float aWeight;
varying highp float weight;
#else
uniform highp float heatmapWeight;
#endif
uniform mediump float heatmapRadius;
const highp float c = 1. / 255. / 16.;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
  
#ifdef HAS_HEAT_WEIGHT
highp float d = aWeight / 255.;
  weight = d;
#else
highp float d = heatmapWeight;
#endif
mediump float e = heatmapRadius;
  vec2 f = vec2(mod(aPosition.xy, 2.) * 2. - 1.);
  float h = sqrt(-2. * log(c / d / heatmapIntensity / GAUSS_COEF)) / 3.;
  vExtrude = h * f;
  vec2 i = vExtrude * e * extrudeScale;
  vec4 j = vec4(floor(aPosition.xy * .5) + i, aPosition.z, 1);
  gl_Position = projViewModelMatrix * j;
}`,frag:`#define SHADER_NAME HEATMAP
precision mediump float;
uniform highp float heatmapIntensity;
varying vec2 vExtrude;
#ifdef HAS_HEAT_WEIGHT
varying highp float weight;
#else
uniform highp float heatmapWeight;
#endif
#define GAUSS_COEF 0.3989422804014327
void main() {
  
#ifdef HAS_HEAT_WEIGHT
highp float c = weight;
#else
highp float c = heatmapWeight;
#endif
float d = -.5 * 3. * 3. * dot(vExtrude, vExtrude);
  float e = c * heatmapIntensity * GAUSS_COEF * exp(d);
  gl_FragColor = vec4(e, 1., 1., 1.);
}`,uniforms:[{name:"extrudeScale",type:"function",fn:function(n,i){return i.resolution/i.dataResolution*i.tileRatio}},{name:"projViewModelMatrix",type:"function",fn:function(n,i){return qt(e,i.projViewMatrix,i.modelMatrix)}}],extraCommandProps:$n({},t&&t.extraCommandProps||{},{blend:{enable:!0,func:{src:"one",dst:"one"},equation:"add"}})})}};var eA=[-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1],nA=`#define SHADER_NAME SKYBOX
#if __VERSION__ == 100
#ifdef GL_EXT_shader_texture_lod
#extension GL_EXT_shader_texture_lod : enable
#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)
#else
#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)
#endif
#else
#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)
#endif
precision highp float;
#include <gl2_frag>
#include <hsv_frag>
uniform vec3 hsv;
varying vec3 vWorldPos;
#ifdef USE_AMBIENT
uniform vec3 diffuseSPH[9];
#else
uniform samplerCube cubeMap;
uniform float bias;
uniform float size;
#endif
uniform float environmentExposure;
#if defined(INPUT_RGBM) || defined(ENC_RGBM)
uniform float rgbmRange;
#endif
vec4 c(const in vec3 d, const in float e) {
  if(e <= .0)
    return vec4(d, 1.);
  vec4 f;
  vec3 h = d / e;
  f.a = clamp(max(max(h.r, h.g), max(h.b, 1e-6)), .0, 1.);
  f.a = ceil(f.a * 255.) / 255.;
  f.rgb = h / f.a;
  return f;
}
vec3 i(const in vec4 d, const in float e) {
  if(e <= .0)
    return d.rgb;
  return e * d.rgb * d.a;
}
vec4 j(const in samplerCube k, const in vec3 l, const in float m, const in float n) {
  vec3 o = l;
  return textureCubeLod(k, o, n);
}
vec3 u(const in vec3 v, const in vec3 A[9]) {
  float x = v.x;
  float y = v.y;
  float z = v.z;
  vec3 B = (A[0] + A[1] * x + A[2] * y + A[3] * z + A[4] * z * x + A[5] * y * z + A[6] * y * x + A[7] * (3. * z * z - 1.) + A[8] * (x * x - y * y));
  return max(B, vec3(.0));
}
float C(const in vec2 D) {
  vec3 E = fract(vec3(D.xyx) * .1031);
  E += dot(E, E.yzx + 19.19);
  return fract((E.x + E.y) * E.z);
}
void main() {
  vec4 F;
#ifdef USE_AMBIENT
vec3 v = normalize(vWorldPos + mix(-.5 / 255., .5 / 255., C(gl_FragCoord.xy)) * 2.);
  F = vec4(u(v, diffuseSPH), 1.);
  if(length(hsv) > .0) {
    F.rgb = hsv_apply(F.rgb, hsv);
  }
#else
F = j(cubeMap, vWorldPos, size, bias);
#endif
F.rgb *= environmentExposure;
#ifdef ENC_RGBM
#if !defined(USE_AMBIENT) && defined(INPUT_RGBM)
if(length(hsv) > .0) {
    F.rgb = hsv_apply(i(F, rgbmRange).rgb, hsv);
    F = c(F.rgb, rgbmRange);
  }
#else
F = c(F.rgb, rgbmRange);
#endif
glFragColor = F;
#elif !defined(USE_AMBIENT) && defined(INPUT_RGBM)
glFragColor = vec4(i(F, rgbmRange), 1.);
  if(length(hsv) > .0) {
    glFragColor.rgb = hsv_apply(clamp(glFragColor.rgb, .0, 1.), hsv);
  }
#else
if(length(hsv) > .0) {
    F.rgb = hsv_apply(F.rgb, hsv);
  }
  glFragColor = F;
#endif
#if __VERSION__ == 100
gl_FragColor = glFragColor;
#endif
}`;let ND=class extends Ye{constructor(){super({vert:`#include <gl2_vert>
attribute vec3 aPosition;
uniform mat4 projMatrix;
uniform mat4 viewMatrix;
uniform mat3 transformMatrix;
varying vec3 vWorldPos;
void main() {
  vWorldPos = aPosition;
  mat4 c = mat4(mat3(viewMatrix) * transformMatrix);
  vec4 d = projMatrix * c * vec4(vWorldPos, 1.);
  gl_Position = d.xyww;
}`,frag:nA,extraCommandProps:{depth:{enable:!0,range:[1,1],func:"lequal"},viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}}),this.version=300}setMode(t,e,n){const i={};return t&&(i.INPUT_RGBM=1),e&&(i.ENC_RGBM=1),n===0&&(i.USE_AMBIENT=1),this._skyboxMesh?this._skyboxMesh[0].setDefines(i):this._meshDefines=i,this}draw(t){return this._skyboxMesh||this._createSkyboxMesh(t),super.draw(t,this._skyboxMesh)}_createSkyboxMesh(t){const e=new ar({aPosition:new Int8Array(eA)},null,eA.length/3);e.generateBuffers(t),this._skyboxMesh=[new nn(e)],this._meshDefines&&(this._skyboxMesh[0].setDefines(this._meshDefines),delete this._meshDefines)}dispose(){if(this._skyboxMesh){const t=this._skyboxMesh[0];t.geometry.dispose(),t.dispose()}return delete this._skyboxMesh,super.dispose()}},BD=class extends Ye{constructor(t,e){const n={blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"},viewport:t};e&&e.extraCommandProps&&$n(n,e.extraCommandProps);const i=[];super({vert:`#define SHADER_NAME HEATMAP_DISPLAY
uniform mat4 projViewModelMatrix;
attribute vec3 aPosition;
void main() {
  gl_Position = projViewModelMatrix * vec4(aPosition, 1.);
}`,frag:`#define SHADER_NAME HEATMAP_DISPLAY
precision mediump float;
uniform sampler2D inputTexture;
uniform sampler2D colorRamp;
uniform vec2 textureOutputSize;
uniform float heatmapOpacity;
void main() {
  vec2 c = gl_FragCoord.xy / textureOutputSize.xy;
  float t = texture2D(inputTexture, c).r;
  vec4 d = texture2D(colorRamp, vec2(t, .5));
  gl_FragColor = d * heatmapOpacity;
}`,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(o,s){return qt(i,s.projViewMatrix,s.modelMatrix)}}],extraCommandProps:n})}},jD=class extends Dr{constructor(){super({vert:lo,frag:`precision highp float;
uniform sampler2D texture;
uniform vec2 size;
uniform float enableSharpen;
uniform float sharpFactor;
uniform float pixelRatio;
vec2 c;
vec3 d(const in vec3 e, const float f) {
  vec2 h = pixelRatio / size.xy;
  float i = .0;
  vec4 j = texture2D(texture, c + h * vec2(-1., -1.));
  j.rgb = mix(vec3(.0), j.rgb, sign(j.a));
  i += mix(.0, 1., sign(j.a));
  vec4 k = texture2D(texture, c + h * vec2(1.));
  k.rgb = mix(vec3(.0), k.rgb, sign(k.a));
  i += mix(.0, 1., sign(k.a));
  vec4 l = texture2D(texture, c + h * vec2(1., -1.));
  l.rgb = mix(vec3(.0), l.rgb, sign(l.a));
  i += mix(.0, 1., sign(l.a));
  vec4 m = texture2D(texture, c + h * vec2(-1., 1.));
  m.rgb = mix(vec3(.0), m.rgb, sign(m.a));
  i += mix(.0, 1., sign(m.a));
  return e + f * (i * e - j.rgb - l.rgb - m.rgb - k.rgb);
}
void main() {
  c = gl_FragCoord.xy / size;
  vec4 e = texture2D(texture, c);
  if(enableSharpen == 1.) {
    e.rgb = d(e.rgb, sharpFactor);
  }
  gl_FragColor = e;
}`,extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.size[0],height:(t,e)=>e.size[1]}}})}getMeshCommand(t,e){return this.commands.copy||(this.commands.copy=this.createREGLCommand(t,null,e.getElements())),this.commands.copy}};const VD=[];let GD=class{constructor(t,e,n){this._regl=t,this._layer=n,this._viewport=e,this._init()}_init(){this._shader=new Ye({vert:`attribute vec3 aPosition;
uniform mat4 projMatrix;
uniform mat4 modelMatrix;
uniform mat4 modelViewMatrix;
uniform mat4 positionMatrix;
varying vec4 vWorldPosition;
#include <get_output>
void main() {
  vec4 c = getPosition(aPosition);
  mat4 d = getPositionMatrix();
  vec4 e = modelMatrix * d * c;
  gl_Position = projMatrix * modelViewMatrix * d * c;
  vWorldPosition = e;
}`,frag:`precision mediump float;
varying vec4 vWorldPosition;
uniform vec2 fogDist;
uniform vec3 cameraPosition;
uniform float rainDepth;
void main() {
  vec3 c = vec3(vWorldPosition[0] - cameraPosition[0], vWorldPosition[1] - cameraPosition[1], vWorldPosition[2] - cameraPosition[2]);
  float d = length(c);
  float e = clamp(1. - (d - fogDist.x) / (fogDist.y - fogDist.x), .0, 1.);
  if(vWorldPosition[2] < rainDepth) {
    gl_FragColor = vec4(e, .0, .0, 1.);
  } else {
    gl_FragColor = vec4(e, 1., .0, 1.);
  }
}`,uniforms:[{name:"modelViewMatrix",type:"function",fn:function(e,n){return qt(VD,n.viewMatrix,n.modelMatrix)}}],extraCommandProps:{viewport:this._viewport}});const t=this._layer.getRenderer().createFBOInfo();this._fbo=this._regl.framebuffer(t),this._scene=new ur,this.renderer=new un(this._regl)}render(t,e){return this._resize(),this.renderer.clear({color:[0,0,0,1],depth:1,framebuffer:this._fbo}),this._scene.setMeshes(t),this.renderer.render(this._shader,{projMatrix:e.projMatrix,viewMatrix:e.viewMatrix,cameraPosition:e.cameraPosition,fogDist:e.fogDist,rainDepth:e.rainDepth},this._scene,this._fbo),this._fbo}dispose(){this._fbo&&this._fbo.destroy(),this._shader&&this._shader.dispose()}_resize(){const t=Si(this._viewport.width.data)?this._viewport.width.data():this._viewport.width,e=Si(this._viewport.height.data)?this._viewport.height.data():this._viewport.height;!this._fbo||this._fbo.width===t&&this._fbo.height===e||this._fbo.resize(t,e)}},UD=class extends Dr{constructor(){super({vert:lo,frag:`#if __VERSION__ == 100
#ifdef GL_OES_standard_derivatives
#extension GL_OES_standard_derivatives : enable
#endif
#endif
precision mediump float;
#include <gl2_frag>
varying vec2 vTexCoord;
#ifdef HAS_RAIN
uniform sampler2D ripplesMap;
#endif
#ifdef HAS_SNOW
uniform sampler2D normalMap;
#endif
#ifdef HAS_FOG
uniform vec3 fogColor;
#endif
uniform sampler2D sceneMap;
uniform sampler2D mixFactorMap;
uniform float time;
uniform vec2 resolution;
uniform float snowIntensity;
float c(float a, float b, float w) {
  return a + w * (b - a);
}
#define HASHSCALE1 .1031
#define HASHSCALE3 vec3(.1031, .1030, .0973)
#define HASHSCALE4 vec3(.1031, .1030, .0973, .1099)
float d = .5;
float e = .2;
float f = .5;
float h = 20.;
float i(float p) {
  vec3 j = fract(vec3(p) * HASHSCALE1);
  j += dot(j, j.yzx + 19.19);
  return fract((j.x + j.y) * j.z);
}
vec2 k(vec2 p) {
  vec3 j = fract(vec3(p.xyx) * HASHSCALE3);
  j += dot(j, j.yzx + 19.19);
  return fract((j.xx + j.yz) * j.zy);
}
vec2 l(vec2 m) {
  float x = fract(sin(dot(m.xy, vec2(122.9898, 783.233))) * 43758.5453);
  float y = fract(sin(dot(m.xy, vec2(457.6537, 537.2793))) * 37573.5913);
  return vec2(x, y);
}
vec3 n(vec2 o, float u) {
  vec3 v = vec3(.0);
  o = o * (2. + u);
  float A = e * snowIntensity;
  float B = o.y * (((i(u) * 2. - 1.) * .5 + 1.) * A);
  float C = (f * time);
  o += vec2(B, C);
  vec2 D = k(floor(o) + 31.1759 * u);
  o = fract(o);
  o -= (D * 2. - 1.) * .35;
  o -= .5;
  float r = length(o);
  float E = .05 * (1. + .3 * sin(time * d));
  float F = smoothstep(E, -E, r);
  vec3 G = vec3(F) * D.x;
  return G;
}
vec3 H() {
  vec3 v = vec3(0);
  vec2 o = gl_FragCoord.xy / resolution.xy;
  o *= vec2(resolution.x / resolution.y, 1.);
  float I = h * snowIntensity;
  for(float J = 0.; J < I; J++) {
    v += n(o, J);
  }
  return v;
}
vec3 K(vec4 L, vec4 M, float N) {
  float O = M.b;
  vec3 P = vec3(1.);
  if(N < 1.) {
    float r = c(.5, P.x, O);
    float g = c(.5, P.y, O);
    float b = c(.5, P.z, O);
    return vec3(r, g, b);
  } else {
    float r = c(L.r, P.x, O);
    float g = c(L.g, P.y, O);
    float b = c(L.b, P.z, O);
    return vec3(r, g, b);
  }
}
void main() {
  vec4 L = texture2D(sceneMap, vTexCoord);
  glFragColor = L;
  vec4 Q = texture2D(mixFactorMap, vTexCoord);
#ifdef HAS_RAIN
vec4 R = texture2D(ripplesMap, vTexCoord);
  if(Q.g < 1.) {
    L = mix(L, R, .4);
  }
  glFragColor = L;
#endif
#ifdef HAS_SNOW
vec3 S = H();
  glFragColor = vec4(L.rgb + S, L.a);
#endif
#ifdef HAS_FOG
float T = Q.r;
  vec3 U = mix(fogColor, glFragColor.rgb, T);
  glFragColor = vec4(U, L.a);
#endif
#if __VERSION__ == 100
gl_FragColor = glFragColor;
#endif
}`,extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}})}};const $D=[],WD=[.03,.03,.03],ZD=[],XD=[],YD=[],qD=jm([],qs([],90,0,0),[0,0,0]);let JD=class{constructor(t,e){this._regl=t,this._viewport=e,this._init()}_init(){this._shader=new Ye({vert:`#include <gl2_vert>
attribute vec3 aPosition;
attribute vec3 aNormal;
attribute vec2 aTexCoord;
uniform mat4 projMatrix;
uniform mat4 modelMatrix;
uniform mat4 modelViewMatrix;
uniform mat4 positionMatrix;
varying vec2 vTexCoord;
#include <get_output>
void main() {
  vec4 c = getPosition(aPosition);
  mat4 d = getPositionMatrix();
  gl_Position = projMatrix * modelViewMatrix * d * c;
  vTexCoord = aTexCoord;
}`,frag:`#if __VERSION__ == 100
#ifdef GL_OES_standard_derivatives
#extension GL_OES_standard_derivatives : enable
#endif
#endif
precision mediump float;
#include <gl2_frag>
varying vec2 vTexCoord;
uniform float rippleRadius;
uniform float density;
uniform float time;
vec3 c(vec2 p) {
  vec3 q = vec3(dot(p, vec2(127.1, 311.7)), dot(p, vec2(269.5, 183.3)), dot(p, vec2(419.2, 371.9)));
  return fract(sin(q) * 43758.5453);
}
float d(in vec2 x) {
  vec2 e = x * density / 4000.0;
  vec2 p = floor(e);
  vec2 f = fract(e);
  float h = .0;
  for(int i = -4; i <= 4; i++)
    for(int k = -4; k <= 4; k++) {
      vec2 g = vec2(float(k), float(i));
      vec3 l = c(p + g);
      vec2 r = g - f + l.xy;
      float m = sqrt(dot(r, r));
      float n = max(mix(smoothstep(.99, .999, max(cos(m - time * 2. + (l.x + l.y) * 5.), 0.)), 0., m), 0.);
      h += n;
    }
  return h;
}
void main() {
  vec2 u = vTexCoord;
  float A = 24. / (rippleRadius * .01);
  float f = d(A * u) * smoothstep(.0, .4, sin(u.x * 3.151592) * sin(u.y * 3.141592));
  vec3 B = vec3(-dFdx(f), -dFdy(f), -dFdy(f));
  glFragColor = vec4(B, 1.);
#if __VERSION__ == 100
gl_FragColor = glFragColor;
#endif
}`,uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return qt($D,e.viewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:this._viewport}}),this._shader.version=300,this._fbo=this._regl.framebuffer({color:this._regl.texture({width:this._viewport.width(),height:this._viewport.height(),wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this._scene=new ur,this.renderer=new un(this._regl)}_transformRipples(t){const e=t.coordinateToPointAtRes(t.getCenter(),t.getGLRes()),n=t.getGLScale()/t.getGLScale(this._fixZoom),i=ie(XD,n,n,n),o=Vm(i,WD,i),s=mn(YD);$a(s,qs(ZD,0,0,0),[e.x,e.y,0],o),qt(s,s,qD),this._mesh.setLocalTransform(s)}_createRipplesMask(t){this._fixZoom=t.getZoom();const e=800*Math.pow(2,16.685648411389433-this._fixZoom),n={};n.POSITION=[-e,0,-e,e,0,-e,-e,0,e,e,0,e],n.NORMAL=[0,1,0,0,1,0,0,1,0,0,1,0],n.TEXCOORD_0=[0,0,1,0,0,1,1,1];const i=new ar(n,[3,1,0,0,2,3],0,{positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0"});i.generateBuffers(this._regl);const o=new Gr;return new nn(i,o)}render(t,e){return this._resize(),this.renderer.clear({color:[0,0,0,1],depth:1,framebuffer:this._fbo}),this._mesh=this._mesh||this._createRipplesMask(t),this._scene.setMeshes(this._mesh),this._transformRipples(t),this.renderer.render(this._shader,{projMatrix:e.projMatrix,viewMatrix:e.viewMatrix,time:e.time,rippleRadius:e.rippleRadius,density:e.density},this._scene,this._fbo),this._fbo}dispose(){this._fbo&&this._fbo.destroy(),this._shader&&this._shader.dispose()}_resize(){const t=Si(this._viewport.width.data)?this._viewport.width.data():this._viewport.width,e=Si(this._viewport.height.data)?this._viewport.height.data():this._viewport.height;!this._fbo||this._fbo.width===t&&this._fbo.height===e||this._fbo.resize(t,e)}};var rA=`attribute vec3 aPosition;
uniform mat4 positionMatrix;
uniform mat4 projViewModelMatrix;
#ifdef HAS_VIDEO
attribute vec2 aTexCoord;
varying vec2 uv;
#endif
#include <get_output>
void main() {
  mat4 c = getPositionMatrix();
  vec4 d = c * getPosition(aPosition);
  gl_Position = projViewModelMatrix * d;
#ifdef HAS_VIDEO
uv = aTexCoord;
#endif
}`;const iA=[0,0,0,1];let oA=class{constructor(t,e){this.regl=t,this._viewport=e,this.renderer=new un(t),this._init()}_init(){this._maskColorFbo=this.renderer.regl.framebuffer({color:this.renderer.regl.texture({width:1,height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this._maskModeFbo=this.renderer.regl.framebuffer({color:this.renderer.regl.texture({width:1,height:1,wrap:"clamp",mag:"nearest",min:"nearest"}),depth:!0});const t=[{name:"projViewModelMatrix",type:"function",fn:(e,n)=>qt([],n.projViewMatrix,n.modelMatrix)}];this._maskColorShader=new Ye({vert:rA,frag:`#ifdef GL_ES
precision highp float;
#endif
uniform vec4 maskColor;
#ifdef HAS_VIDEO
uniform sampler2D maskTexture;
varying vec2 uv;
#endif
void main() {
  
#ifdef HAS_VIDEO
gl_FragColor = texture2D(maskTexture, uv);
  gl_FragColor.a = maskColor.a;
#else
gl_FragColor = maskColor;
#endif
}`,uniforms:t,extraCommandProps:{viewport:this._viewport}}),this._maskModeShader=new Ye({vert:rA,frag:`#ifdef GL_ES
precision highp float;
#endif
uniform float maskMode;
#ifdef HAS_MASK_FLAT
uniform float flatHeight;
#endif
#ifdef HAS_MASK_COLOR
uniform vec2 heightRange;
#endif
void main() {
  
#if defined(HAS_MASK_FLAT)
gl_FragColor = vec4(maskMode, flatHeight, .0, 1.);
#elif defined(HAS_MASK_COLOR)
gl_FragColor = vec4(maskMode, .0, heightRange.x, heightRange.y);
#else
gl_FragColor = vec4(maskMode, .0, .0, .0);
#endif
}`,uniforms:t,extraCommandProps:{viewport:this._viewport}}),this._scene=new ur}render(t,e){this._resize(),this.renderer.clear({color:iA,depth:1,framebuffer:this._maskColorFbo}),this.renderer.clear({color:iA,depth:1,framebuffer:this._maskModeFbo}),this._scene.setMeshes(t);const n={projViewMatrix:e};return this.renderer.render(this._maskColorShader,n,this._scene,this._maskColorFbo),this.renderer.render(this._maskModeShader,n,this._scene,this._maskModeFbo),{colorExtent:this._maskColorFbo,modeExtent:this._maskModeFbo}}_resize(){const t=Si(this._viewport.width)?this._viewport.width():this._viewport.width.data(),e=Si(this._viewport.height)?this._viewport.height():this._viewport.height.data();!this._maskColorFbo||this._maskColorFbo.width===t&&this._maskColorFbo.height===e||(this._maskColorFbo.resize(t,e),this._maskModeFbo.resize(t,e))}dispose(){this._maskColorFbo&&(this._maskColorFbo.destroy(),delete this._maskColorFbo),this._maskModeFbo&&(this._maskModeFbo.destroy(),delete this._maskModeFbo),this._maskColorShader&&(this._maskColorShader.dispose(),delete this._maskColorShader),this._maskModeShader&&(this._maskModeShader.dispose(),delete this._maskModeShader)}};const sA=[],y0={width:4,type:"float"};let KD=class{constructor(t,e,n){this._regl=t,this.joints=e,this.inverseBindMatrices=[],this.jointMatrices=[],this.jointData=new Float32Array(16*e.length);for(let i=0;i<e.length;++i)this.inverseBindMatrices.push(new Float32Array(n.buffer,n.byteOffset+16*Float32Array.BYTES_PER_ELEMENT*i,16)),this.jointMatrices.push(new Float32Array(this.jointData.buffer,16*Float32Array.BYTES_PER_ELEMENT*i,16));this.jointTextureSize=[4,6]}update(t,e,n){$s(sA,t);for(let o=0;o<this.joints.length;++o){const s=this.jointMatrices[o];qt(s,sA,e[this.joints[o].nodeIndex]),qt(s,s,this.inverseBindMatrices[o])}y0.height=this.joints.length,y0.data=this.jointData;const i=y0;return n?n(i):n=this._regl.texture(i),n}};const QD=[0,0,0],tF=[0,0,0,1],eF=[1,1,1],nF=[];let v0=class{constructor(t=[0,0,0],e=[0,0,0,1],n=[1,1,1]){this.translation=t,this.rotation=e,this.scale=n}getMatrix(){return $a(nF,this.rotation,this.translation,this.scale)}decompose(t){UR(this.translation,t),$R(this.rotation,t),Wb(this.scale,t)}update(t){t&&(t.translation&&!Ya(t.translation,QD)&&Ar(this.translation,t.translation),t.rotation&&!s4(t.rotation,tF)&&ew(this.rotation,t.rotation),t.scale&&!Ya(t.scale,eF)&&Ar(this.scale,t.scale))}},rF=class{constructor(t){this._init(t)}_init(t){this.bbox=t.bbox,this.geometry=t.geometry,this.nodeMatrix=t.nodeMatrix,this.materialInfo=t.materialInfo,this.extraInfo=t.extraInfo,this.animationMatrix=t.animationMatrix,this.morphWeights=t.morphWeights,this.skin=t.skin,this.nodeIndex=t.nodeIndex}copyEdgeGeometry(){this.copyGeometry||(this.copyGeometry=this._copyEdgeGeometry(this.geometry))}createCopyBarycentric(){this.copyGeometry&&!this.copyGeometry.data.aBarycentric&&(this.copyGeometry.buildUniqueVertex(),this.copyGeometry.createBarycentric("aBarycentric"))}_copyEdgeGeometry(t){const e=t.data,n=t.indices||t.elements,i={};for(const l in e)if(l===t.desc.positionAttribute)if(Vr(e[l]))i[l]=e[l].slice();else if(e[l].buffer&&e[l].buffer.destroy)i[l]={buffer:e[l].buffer},Vr(e[l].array)&&(i[l].array=e[l].array.slice());else{const h=t._getAttributeData(l);i[l]=l!==t.desc.positionAttribute?h:h.slice()}const o=n.length!==void 0?n.slice():n,s=JSON.parse(JSON.stringify(t.desc)),a=new cD(i,o,0,s);return a.properties=t.properties,a}},Do=0;const iF=[];let oF=class{constructor(t,e){this.gltf=t,this.regl=e,this.geometries=[],e&&(this._emptyTexture=e.texture({width:2,height:2}))}getMeshesInfo(){return this.gltf?this.geometries.length?this.geometries:(this._createTextures(this.gltf.textures),this._createSkins(this.gltf.skins),this.gltf.scenes[0].nodes.forEach(t=>{this._parserNode(t,this.geometries)}),this._checkBaseColorFactor(),this.geometries):null}getGLTFBBox(){if(!this.gltf)return null;const t=this.geometries;if(!t||!t.length)return null;const e=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0];for(let i=0;i<t.length;i++){const o=t[i].bbox,s=o.min,a=o.max;s[0]<e[0]&&(e[0]=s[0]),s[1]<e[1]&&(e[1]=s[1]),s[2]<e[2]&&(e[2]=s[2]),a[0]>n[0]&&(n[0]=a[0]),a[1]>n[1]&&(n[1]=a[1]),a[2]>n[2]&&(n[2]=a[2])}return{min:e,max:n}}_createSkins(t){if(t){this._skinMap={};for(let e=0;e<t.length;e++){const n=t[e];n.joints=n.joints.map(i=>this.gltf.nodes[i]),this._skinMap[e]=new KD(this.regl,n.joints,n.inverseBindMatrices.array),delete n.inverseBindMatrices}}}_createTextures(t){if(t){this._textureMap={};for(let e=0;e<t.length;e++){const n=t[e];this._textureMap[e]||(this._textureMap[e]=this._toTexture(n),delete n.image)}}}_checkBaseColorFactor(){if(!this._checkBaseColorFactorAlpha())for(let t=0;t<this.geometries.length;t++){const e=this.geometries[t].materialInfo.baseColorFactor;e&&e[3]===0&&(e[3]=1)}}_checkBaseColorFactorAlpha(){for(let t=0;t<this.geometries.length;t++){const e=this.geometries[t].materialInfo.baseColorFactor;if(e&&e[3]>0)return!0}return!1}dispose(){this._emptyTexture&&this._emptyTexture.destroy();const t=this.getMeshesInfo();if(t){t.forEach(e=>{e.geometry.dispose();for(const n in e.materialInfo){const i=e.materialInfo[n];i.destroy&&!i[mr]&&i.destroy()}});for(const e in this._textureMap){const n=this._textureMap[e];n.destroy&&!n[mr]&&n.destroy()}delete this.gltf}}updateAnimation(t,e,n,i,o,s,a,l){const h=this.gltf;if(!h||(Do=h.animations?Eo.getAnimationTimeSpan(h,i):null,!Do))return;t-=o;let u=0;u=e||!e&&this._isFirstLoop(t,n,i,o)?t*n*.001%(Do.max-Do.min)+Do.min:t*n*.001+Do.min,h.scenes[0].nodes.forEach(c=>{this._updateNodeMatrix(i,u,c,null,s,l)});for(const c in this.gltf.nodes){const f=this.gltf.nodes[c],d=s[f.nodeIndex];if(f.skin&&d){const p=f.skin.update(d,s,a[f.nodeIndex]&&a[f.nodeIndex].jointTexture);a[f.nodeIndex]||(a[f.nodeIndex]={jointTextureSize:f.skin.jointTextureSize,numJoints:f.skin.joints.length}),a[f.nodeIndex].jointTexture=p}}}_isFirstLoop(t,e,n,i){const o=this.gltf;return!i||!o||(Do=o.animations?Eo.getAnimationTimeSpan(o,n):null,t*e*.001/(Do.max-Do.min)<1)}hasSkinAnimation(){return!!this._isAnimation}_updateNodeMatrix(t,e,n,i,o,s){n.trs&&(s?s.indexOf(Number(n.nodeIndex))>-1&&this._updateNodeTRS(n,e,t):this._updateNodeTRS(n,e,t)),o[n.nodeIndex]=i?qt(o[n.nodeIndex]||[],i,n.matrix||n.trs.getMatrix()):io(o[n.nodeIndex]||[],n.matrix||n.trs.getMatrix()),n.children&&n.children.forEach(a=>{this._updateNodeMatrix(t,e,a,o[n.nodeIndex],o,s)})}_updateNodeTRS(t,e,n){const i=Eo.getAnimationClip(this.gltf,Number(t.nodeIndex),e,n);i.weights&&this._updateMorph(t,i.weights),t.trs.update(i)}_updateMorph(t,e){const n=e.length;if(!t.influencesList){t.influencesList=[];for(let s=0;s<n;s++)t.influencesList[s]=[s,0]}const i=t.influencesList;for(let s=0;s<i.length;s++){const a=i[s];a[0]=s,a[1]=e[s]}i.sort(aF);const o=[];for(let s=0;s<8;s++)o[s]=[s,0];for(let s=0;s<8;s++)s<n&&i[s][1]?(o[s][0]=i[s][0],o[s][1]=i[s][1]):(o[s][0]=Number.MAX_SAFE_INTEGER,o[s][1]=0);o.sort(sF),t.geometries.forEach(s=>{const a=s.properties.morphTargets;for(let l=0;l<8;l++){const h=o[l],u=h[0],c=h[1];u!==Number.MAX_SAFE_INTEGER&&c?(s.updateData("POSITION"+l,a["POSITION_"+u].array),s.properties.morphWeights[l]=c):s.properties.morphWeights[l]=0}})}_parserNode(t,e,n){if(t.isParsed)return;t.nodeMatrix=t.nodeMatrix||mn([]),t.localMatrix=t.localMatrix||mn([]),t.matrix?(t.trs=new v0,t.trs.decompose(t.matrix)):t.trs=new v0(t.translation,t.rotation,t.scale),t.localMatrix=t.trs.getMatrix(),n?qt(t.nodeMatrix,n,t.matrix||t.localMatrix):io(t.nodeMatrix,t.matrix||t.localMatrix);const i=t.nodeMatrix;if(t.children)for(let o=0;o<t.children.length;o++)this._parserNode(t.children[o],e,i);if(Js(t.skin)){this._isAnimation=!0;const o=t.skin;t.trs=new v0,t.skin=this._skinMap[o]}Js(t.mesh)&&(t.mesh=this.gltf.meshes[t.mesh],t.mesh.node=t,t.geometries=t.geometries||[],t.mesh.primitives.forEach(o=>{const s=this._createMaterialInfo(o.material),a=function(c,f,d){const p=c.attributes,g=p.COLOR_0;if(g&&g.array instanceof Float32Array){const v=new Uint8Array(g.array.length);for(let _=0;_<v.length;_++)v[_]=Math.round(255*g.array[_]);g.array=v}else if(g&&(g.array instanceof Uint16Array||g.array instanceof Int16Array||g.array instanceof Uint32Array||g.array instanceof Int32Array)){const v=new Uint8Array(g.array);g.array=v}d&&p.TEXCOORD_0&&!p.TEXCOORD_0&&(p.TEXCOORD_1=p.TEXCOORD_0);const m={};for(const v in p)m[v]=$n({},p[v]),f&&(m[v].buffer=iD(f,p[v],{dimension:p[v].itemSize}));if(c.morphTargets){const v=Tf(m.POSITION)?m.POSITION.itemSize*m.POSITION.count:m.POSITION.array.length;for(let _=0;_<8;_++)m[`POSITION${_}`]||(m[`POSITION${_}`]=new Float32Array(v).fill(0));for(let _=0;_<4;_++)m[`NORMAL${_}`]||(m[`NORMAL${_}`]=new Float32Array(m.NORMAL.array?m.NORMAL.array.length:m.NORMAL.length).fill(0))}let y=c.indices;y&&y.bufferView===void 0&&y.array&&(y=y.array);const x=new ar(m,y,0,{primitive:Io(c.mode)?jw(c.mode):c.mode,positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0",uv1Attribute:"TEXCOORD_1",color0Attribute:"COLOR_0"});return c.morphTargets&&(x.properties.morphWeights=[]),c.mode>3&&!x.data.NORMAL&&x.createNormal("NORMAL"),x}(o,this.regl,s.occlusionTexture);a.properties.morphTargets=o.morphTargets,t.geometries.push(a);let l=a.boundingBox.copy();l=l.transform(mn(iF),i);const h={geometry:a,bbox:l,nodeMatrix:i,materialInfo:s,extraInfo:this._createExtralInfo(o.material),animationMatrix:t.trs.getMatrix(),morphWeights:t.weights,nodeIndex:t.nodeIndex};t.skin&&(h.skin={jointTextureSize:[4,6],numJoints:t.skin.joints.length,jointTexture:t.skin.jointTexture});const u=new rF(h);e.push(u)})),t.isParsed=!0}_createMaterialInfo(t){const e={};if(this.gltf.materials&&this.gltf.materials[t]){const n=this.gltf.materials[t],i=n.pbrMetallicRoughness;if(i){const s=i.metallicRoughnessTexture,a=i.baseColorTexture;a&&(e.baseColorTexture=this._getTexture(a),a.KHR_texture_transform&&(e.khr_offset=a.KHR_texture_transform.offset||[0,0],e.khr_rotation=a.KHR_texture_transform.rotation||0,e.khr_scale=a.KHR_texture_transform.scale||[1,1])),i.baseColorFactor&&(e.baseColorFactor=i.baseColorFactor),s?e.metallicRoughnessTexture=this._getTexture(s):(e.metallicFactor=Js(i.metallicFactor)?i.metallicFactor:1,e.roughnessFactor=Js(i.roughnessFactor)?i.roughnessFactor:1)}const o=n.extensions;if(o&&o.KHR_materials_pbrSpecularGlossiness){const s=o.KHR_materials_pbrSpecularGlossiness;e.name="pbrSpecularGlossiness";for(const a in s)e[a]=Js(s[a].index)?this._getTexture(s[a]):s[a]}n.normalTexture&&(e.normalTexture=this._getTexture(n.normalTexture)),n.occlusionTexture&&(e.occlusionTexture=this._getTexture(n.occlusionTexture)),n.emissiveTexture&&(e.emissiveTexture=this._getTexture(n.emissiveTexture)),n.emissiveFactor&&(e.emissiveFactor=n.emissiveFactor),e.alphaCutoff=n.alphaCutoff||.5}return e}_createExtralInfo(t){const e={};if(this.gltf.materials&&this.gltf.materials[t]){const n=this.gltf.materials[t];e.doubleSided=n.doubleSided,e.alphaMode=n.alphaMode||"OPAQUE"}return e}_getTexture(t){const e=t.extensions,n=t.index;if(!Js(n))return null;e&&e.KHR_texture_transform&&(t.KHR_texture_transform=e.KHR_texture_transform);const i=this._textureMap[n];return i.texInfo=t,i}_toTexture(t){if(!t)return this._emptyTexture;const e=t.sampler||{};return new If({width:t.image.width,height:t.image.height,data:t.image.array,mag:tD(e.magFilter)||"linear",min:nD(e.minFilter)||"linear",wrapS:Vw(e.wrapS)||"repeat",wrapT:Vw(e.wrapT)||"repeat"})}};function sF(r,t){return r[0]-t[0]}function aF(r,t){return Math.abs(t[1])-Math.abs(r[1])}function lF(r,t){const{fetchOptions:e,gltfLoaderOptions:n,urlModifier:i}=t,o=n||{};o.urlModifier=i;const s=r.lastIndexOf("/"),a=r.slice(0,s),l=r.slice(r.lastIndexOf(".")).toLowerCase();return l===".gltf"?Po.getJSON(r,e,i).then(h=>aA(a,h,o)):l===".glb"?Po.getArrayBuffer(r,e,i).then(h=>aA(a,{buffer:h.data,byteOffset:0},o)):null}function hF(r,t){return new oF(r,t)}function aA(r,t,e){return new Eo(r,t,e).load()}const lA=[-1,0,-1,1,0,-1,-1,0,1,1,0,1],uF=[0,1,0,0,1,0,0,1,0,0,1,0],hA=[3,1,0,0,2,3],uA=[0,0,1,0,0,1,1,1],zf={vertices:[-.8111000061035156,2.0102999210357666,-.8111000061035156,0,.010300000198185444,-0,-.8111000061035156,2.0102999210357666,.8111000061035156,-.8111000061035156,2.0102999210357666,.8111000061035156,0,.010300000198185444,-0,.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,.8111000061035156,0,.010300000198185444,-0,.8111000061035156,2.0102999210357666,-.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,0,.010300000198185444,-0,-.8111000061035156,2.0102999210357666,-.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,-.8111000061035156,2.0102999210357666,-.8111000061035156,0,2.9419000148773193,-0,.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,0,2.9419000148773193,-0,-.8111000061035156,2.0102999210357666,-.8111000061035156,-.8111000061035156,2.0102999210357666,.8111000061035156,0,2.9419000148773193,-0,-.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,.8111000061035156,0,2.9419000148773193,-0],normals:[-.9267006516456604,-.3758002817630768,-0,-.9267006516456604,-.3758002817630768,-0,-.9267006516456604,-.3758002817630768,-0,0,-.3758002817630768,.9267006516456604,0,-.3758002817630768,.9267006516456604,0,-.3758002817630768,.9267006516456604,.9267006516456604,-.3758002817630768,-0,.9267006516456604,-.3758002817630768,-0,.9267006516456604,-.3758002817630768,-0,0,-.3758002817630768,-.9267006516456604,0,-.3758002817630768,-.9267006516456604,0,-.3758002817630768,-.9267006516456604,0,.656676173210144,-.7541726231575012,0,.656676173210144,-.7541726231575012,0,.656676173210144,-.7541726231575012,.7541726231575012,.656676173210144,-0,.7541726231575012,.656676173210144,-0,.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,0,.656676173210144,.7541726231575012,0,.656676173210144,.7541726231575012,0,.656676173210144,.7541726231575012],indices:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23]},cF=["cube","plane","pyramid"],Ks={cube:{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1])},NORMAL:{array:new Int8Array([0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1])},TEXCOORD_0:{array:new Int8Array([0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1])}},indices:new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60]}]}]},"plane-cube":{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array(lA)},TEXCOORD_0:{array:new Int8Array(uA)}},indices:new Uint16Array(hA),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60],translation:[0,-60,0]},{mesh:0,scale:[60,60,60],translation:[0,60,0]},{mesh:0,scale:[60,60,60],translation:[60,0,0],rotation:[0,0,.7071067811865475,.7071067811865476]},{mesh:0,scale:[60,60,60],translation:[-60,0,0],rotation:[0,0,.7071067811865475,.7071067811865476]},{mesh:0,scale:[60,60,60],translation:[0,0,60],rotation:[.7071067811865475,0,0,.7071067811865476]},{mesh:0,scale:[60,60,60],translation:[0,0,-60],rotation:[.7071067811865475,0,0,.7071067811865476]}]}]},plane:{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array(lA)},NORMAL:{array:new Int8Array(uF)},TEXCOORD_0:{array:new Int8Array(uA)}},indices:new Uint16Array(hA),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60]}]}]},pyramid:{meshes:[{primitives:[{attributes:{POSITION:{array:new Float32Array(zf.vertices)},NORMAL:{array:new Float32Array(zf.normals)},TEXCOORD_0:{array:new Float32Array(zf.uv)}},indices:new Uint16Array(zf.indices),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60]}]}]}};let fF=class{constructor(t,e){this.regl=t,this.resourceMap={},this.options=e||{}}getGLTF(t){return this.resourceMap[t]}loginGLTF(t,e){if(this.resourceMap[t])this.resourceMap[t].refCount+=1;else{if(Ks[t]){const n=function(i){let o=null;return Ks[i]&&(o={meshes:Ks[i].meshes},o.scenes=JSON.parse(JSON.stringify(Ks[i].scenes))),o}(t);this.resourceMap[t]=this._exportGLTFResource(n,t,!1)}else this.resourceMap[t]=e?e(t).then(n=>(this.resourceMap[t]=this._exportGLTFResource(n,t),this.resourceMap[t])):this._loadGLTFModel(t);this.resourceMap[t].refCount=1}}logoutGLTF(t){if(this.resourceMap[t]&&(this.resourceMap[t].refCount-=1,this.resourceMap[t].refCount<1)){const e=this.resourceMap[t].resources;if(e)for(let n=0;n<e.length;n++)e[n].geometry.dispose(),e[n].copyGeometry&&e[n].copyGeometry.dispose(),e[n].material&&e[n].material.dispose();this.resourceMap[t].gltfPack&&this.resourceMap[t].gltfPack.dispose(),delete this.resourceMap[t]}}isSimpleModel(t){return Ks[t]}addSimpleModel(t,e){(function(n,i){typeof n=="string"&&cF.indexOf(n)<0&&(Ks[n]=i)})(t,e)}removeSimpleModel(t){delete Ks[t]}_exportGLTFResource(t,e,n=!0){if(!t)return null;const i=hF(t,n?this.regl:null),o=i.getMeshesInfo();return{bbox:i.getGLTFBBox(),gltfPack:i,resources:o,json:t.json,refCount:this.resourceMap[e]?this.resourceMap[e].refCount:0}}fetchGLTF(t){return lF(t,this.options).then(e=>e)}_loadGLTFModel(t){return this.fetchGLTF(t).then(e=>(this.resourceMap[t]=this._exportGLTFResource(e,t),this.resourceMap[t]))}};const Hf=function(){const r=[0,0,0],t=90*Math.PI/180,e=[0,0,0,0],n=new Array(16);return function(i,o,s,a,l,h){const u=[Zs([],r,[1,0,0],h&&h[0]||[0,-1,0]),Zs([],r,[-1,0,0],h&&h[1]||[0,-1,0]),Zs([],r,[0,1,0],h&&h[2]||[0,0,1]),Zs([],r,[0,-1,0],h&&h[3]||[0,0,-1]),Zs([],r,[0,0,1],h&&h[4]||[0,-1,0]),Zs([],r,[0,0,-1],h&&h[5]||[0,-1,0])],c={context:{viewMatrix:function(f,d,p){return u[p]},projMatrix:ZR(n,t,1,.5,1.1)}};return o&&(c.framebuffer=o.faces?function(f,d,p){return o.faces[p]}:o),i(c)(6,(f,d,p)=>{const g={color:e,depth:1};o&&(g.framebuffer=o.faces?o.faces[p]:o),i.clear(g),s(a),l&&l()}),o}}();var ls={vertices:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],textures:[1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},Nf=`#define SHADER_NAME CUBE_MAP
attribute vec3 aPosition;
varying vec3 vWorldPos;
uniform mat4 projMatrix;
uniform mat4 viewMatrix;
void main() {
  vWorldPos = aPosition;
  gl_Position = projMatrix * viewMatrix * vec4(vWorldPos, 1.);
}`,dF=`precision highp float;
#define PI 3.1415926
varying vec3 vWorldPos;
uniform sampler2D equirectangularMap;
const vec2 c = vec2(.1591, .3183);
vec2 d(vec3 e) {
  vec2 f = vec2(atan(e.y, e.x), asin(e.z));
  f *= c;
  f += .5;
  return f;
}
vec3 h(const in vec4 i, const in float j) {
  return j * i.rgb * i.a;
}
vec4 k(const in vec3 i, const in float j) {
  vec4 l;
  vec3 m = i / j;
  l.a = clamp(max(max(m.r, m.g), max(m.b, 1e-6)), .0, 1.);
  l.a = ceil(l.a * 255.) / 255.;
  l.rgb = m / l.a;
  return l;
}
void main() {
  vec2 f = d(normalize(vWorldPos));
  vec4 i = texture2D(equirectangularMap, f);
#ifdef INPUT_RGBM
gl_FragColor = i;
#else
gl_FragColor = vec4(h(i, 7.), 1.);
#endif
}`,pF=`#define SHADER_NAME PBR_prefilter
precision highp float;
varying vec3 vWorldPos;
uniform samplerCube environmentMap;
uniform sampler2D distributionMap;
uniform float roughness;
uniform float resolution;
uniform float rgbmRange;
const float c = 3.14159265359;
float d(vec3 e, vec3 f, float h) {
  float a = h * h;
  float i = a * a;
  float j = max(dot(e, f), .0);
  float k = j * j;
  float l = i;
  float m = (k * (i - 1.) + 1.);
  m = c * m * m;
  return l / m;
}
vec3 n(float o, vec3 e, float h) {
  vec4 u = texture2D(distributionMap, vec2(h, o));
  vec3 f = u.xyz;
  float v = sign(u.w - .5);
  float A = sign(u.w - 200.0 / 255. * clamp(v, .0, 1.) - .15);
  f.x *= v;
  f.y *= A;
  vec3 B = abs(e.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);
  vec3 C = normalize(cross(B, e));
  vec3 D = cross(e, C);
  vec3 E = C * f.x + D * f.y + e * f.z;
  return normalize(E);
}
vec4 F(const in vec3 G, const in float I) {
  if(I <= .0)
    return vec4(G, 1.);
  vec4 J;
  vec3 K = G / I;
  J.a = clamp(max(max(K.r, K.g), max(K.b, 1e-6)), .0, 1.);
  J.a = ceil(J.a * 255.) / 255.;
  J.rgb = K / J.a;
  return J;
}
vec3 L(const in vec4 G, const in float I) {
  if(I <= .0)
    return G.rgb;
  return I * G.rgb * G.a;
}
void main() {
  vec3 e = normalize(vWorldPos);
  vec3 M = e;
  vec3 O = M;
  const int P = 1024;
  vec3 Q = vec3(.0);
  float S = .0;
  for(int T = 0; T < P; ++T) {
    vec3 f = n(float(T) / float(P), e, roughness);
    vec3 U = normalize(2. * dot(O, f) * f - O);
    float W = max(dot(e, U), .0);
    if(W > .0) {
      Q += L(textureCube(environmentMap, U), rgbmRange).rgb * W;
      S += W;
    }
  }
  Q = Q / S;
  gl_FragColor = F(Q, rgbmRange);
}`,gF=`precision highp float;
varying vec2 vTexCoords;
uniform sampler2D distributionMap;
const float c = 3.14159265359;
vec4 d(float a, float b) {
  a *= 65535.;
  b *= 65535.;
  vec4 rgba;
  rgba[0] = mod(a, 255.);
  rgba[1] = (a - rgba[0]) / 65280.0;
  rgba[2] = mod(b, 255.);
  rgba[3] = (b - rgba[2]) / 65280.0;
  return rgba;
}
vec3 e(float f, vec3 h, float i) {
  vec4 j = texture2D(distributionMap, vec2(i, f));
  vec3 k = j.xyz;
  float l = sign(j.w - .5);
  float m = sign(j.w - clamp(l, .0, 1.) * 200.0 / 255. - .15);
  k.x *= l;
  k.y *= m;
  vec3 n = abs(h.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);
  vec3 o = normalize(cross(n, h));
  vec3 u = cross(h, o);
  vec3 v = o * k.x + u * k.y + h * k.z;
  return normalize(v);
}
float A(float B, float i) {
  float a = i;
  float C = (a * a) / 2.;
  float D = B;
  float E = B * (1. - C) + C;
  return D / E;
}
float F(float B, float G, float i) {
  float I = A(B, i);
  float J = A(G, i);
  return J * I;
}
vec2 K(float B, float i) {
  vec3 L;
  L.x = sqrt(1. - B * B);
  L.y = .0;
  L.z = B;
  float M = .0;
  float O = .0;
  vec3 h = vec3(.0, .0, 1.);
  const int P = 1024;
  for(int Q = 0; Q < P; ++Q) {
    vec3 k = e(float(Q) / float(P), h, i);
    vec3 R = normalize(2. * dot(L, k) * k - L);
    float G = max(R.z, .0);
    float S = max(k.z, .0);
    float T = max(dot(L, k), .0);
    float B = max(dot(h, L), .0);
    if(G > .0) {
      float U = F(B, G, i);
      float W = (U * T) / (S * B);
      float X = pow(1. - T, 5.);
      M += (1. - X) * W;
      O += X * W;
    }
  }
  M /= float(P);
  O /= float(P);
  return vec2(M, O);
}
void main() {
  vec2 Y = K(vTexCoords.x, vTexCoords.y);
  gl_FragColor = d(Y.x, Y.y);
}`,mF=`attribute vec3 aPosition;
attribute vec2 aTexCoord;
varying vec2 vTexCoords;
void main() {
  vTexCoords = aTexCoord;
  gl_Position = vec4(aPosition, 1.);
}`;/*!
 * from claygl
 * https://github.com/pissang/claygl/
 * License: BSD-2-Clause
 */function yF(r,t){const e=r[0],n=r[1],i=r[2];return t===0?1:t===1?e:t===2?n:t===3?i:t===4?e*i:t===5?n*i:t===6?e*n:t===7?3*i*i-1:e*e-n*n}const vF={px:[2,1,0,-1,-1,1],nx:[2,1,0,1,-1,-1],py:[0,2,1,1,-1,-1],ny:[0,2,1,1,1,1],pz:[0,1,2,-1,-1,-1],nz:[0,1,2,1,-1,1]},cA=["px","nx","py","ny","pz","nz"],fA=Df.compile(nA);function dA(r,t,e){const n=r({frag:fA,vert:Nf,attributes:{aPosition:ls.vertices},uniforms:{projMatrix:r.context("projMatrix"),viewMatrix:r.context("viewMatrix"),cubeMap:t,environmentExposure:1,bias:0,size:e,hsv:[0,0,0]},elements:ls.indices}),i=[],o=r.framebuffer(e);return Hf(r,o,n,{size:e},function(){const s=r.read();i.push(new s.constructor(s))}),n.destroy(),o.destroy(),i}const pA=new Int8Array([-1,1,0,-1,-1,0,1,1,0,1,-1,0]),xF=new Int8Array([0,1,0,0,1,1,1,0]);function gA(r,t,e,n){t=t||256;const i=mA(e=e||1024,n=n||256),o=r.texture({data:i,width:n,height:e,min:"nearest",mag:"nearest"}),s=r.buffer(pA),a=r.buffer(xF),l=r.framebuffer({radius:t,colorType:"uint8",colorFormat:"rgba",min:"linear",mag:"linear"}),h=r({frag:gF,vert:mF,attributes:{aPosition:{buffer:s},aTexCoord:{buffer:a}},uniforms:{distributionMap:o},framebuffer:l,viewport:{x:0,y:0,width:t,height:t},count:pA.length/3,primitive:"triangle strip"});return h(),h.destroy(),s.destroy(),a.destroy(),o.destroy(),l}function mA(r,t){const e=new Array(r*t*4);for(let n=0;n<r;n++){const{x:i,y:o}=_F(n,r);for(let s=0;s<t;s++){const a=s/t,l=a*a,h=2*Math.PI*i,u=Math.sqrt((1-o)/(1+(l*l-1)*o)),c=Math.sqrt(1-u*u),f=4*(n*t+s),d=c*Math.cos(h),p=c*Math.sin(h);e[f]=Math.abs(255*d),e[f+1]=Math.abs(255*p),e[f+2]=255*u,e[f+3]=(d>0?200:0)+(p>0?55:0)}}return e}function _F(r,t){let e=(r<<16|r>>>16)>>>0;return e=((1431655765&e)<<1|(2863311530&e)>>>1)>>>0,e=((858993459&e)<<2|(3435973836&e)>>>2)>>>0,e=((252645135&e)<<4|(4042322160&e)>>>4)>>>0,e=(((16711935&e)<<8|(4278255360&e)>>>8)>>>0)/4294967296,{x:r/t,y:e}}var bF=Object.freeze({__proto__:null,createIBLMaps:function(r,t={}){const e=t.envTexture,n=t.envCubeSize||512,i=t.sampleSize||1024,o=t.roughnessLevels||256,s=t.prefilterCubeSize||256;let a;if(Array.isArray(e)){const f=r.cube({flipY:!0,faces:e});a=function(d,p,g,m,y){const x=d({frag:`#define ENC_RGBM 1
`+fA,vert:Nf,attributes:{aPosition:ls.vertices},uniforms:{hsv:[0,0,0],projMatrix:d.context("projMatrix"),viewMatrix:d.context("viewMatrix"),cubeMap:p,bias:0,size:p.width,environmentExposure:1,rgbmRange:y},elements:ls.indices}),v=d.cube({width:g,height:g,min:"linear",mag:"linear",format:"rgba"}),_=d.framebufferCube({radius:g,color:v});return Hf(d,_,x,{size:g},null,[[0,0,-1],[0,0,-1],[0,0,1],[0,0,1],[0,-1,0],[0,-1,0]]),x.destroy(),_}(r,f,n,0,t.rgbmRange),f.destroy()}else a=function(f,d,p,g){p=p||512;const m=f({frag:`#define INPUT_RGBM 1
`+dF,vert:Nf,attributes:{aPosition:ls.vertices},uniforms:{projMatrix:f.context("projMatrix"),viewMatrix:f.context("viewMatrix"),equirectangularMap:d},elements:ls.indices}),y=f.cube({width:p,height:p,min:"linear",mag:"linear",format:"rgba"}),x=f.framebufferCube({radius:p,color:y});return Hf(f,x,m),m.destroy(),x}(r,e,n);const{prefilterMap:l,prefilterMipmap:h}=function(f,d,p,g,m,y){const x=function(_,w,b,A,T,S){T=T||1024,S=S||256;const M=mA(T,S),E=_.texture({data:M,width:S,height:T,min:"nearest",mag:"nearest"}),P=_({frag:pF,vert:Nf,attributes:{aPosition:ls.vertices},uniforms:{projMatrix:_.context("projMatrix"),viewMatrix:_.context("viewMatrix"),environmentMap:w,distributionMap:E,roughness:_.prop("roughness"),resolution:A,rgbmRange:b||7},elements:ls.indices,viewport:{x:0,y:0,width:_.prop("size"),height:_.prop("size")}});let k=A;const O=_.texture({radius:A,min:"linear",mag:"linear"}),I=_.framebuffer({radius:A,color:O}),D=Math.log(k)/Math.log(2),z=[];for(let L=0;L<=D;L++){let $=0;Hf(_,I,P,{roughness:L/(D-1),size:k},function(){const Z=_.read({framebuffer:I});z[$]||(z[$]={mipmap:[]}),z[$].mipmap.push(Z),$++}),k/=2,I.resize(k)}return E.destroy(),I.destroy(),P.destroy(),z}(f,d,p,g,m,y);return{prefilterMap:f.cube({radius:g,min:"linear mipmap linear",mag:"linear",faces:x}),prefilterMipmap:x}}(r,a,t.rgbmRange,s,i,o);let u;if(!t.ignoreSH){const f=s;u=function(p,g,m){const y=new Array(9),x=[],v=[],_=[];for(let w=0;w<9;w++){const b=[0,0,0];for(let A=0;A<cA.length;A++){const T=p[A],S=[0,0,0];let M=0,E=0;const P=vF[cA[A]];for(let k=0;k<m;k++)for(let O=0;O<g;O++){x[0]=O/(g-1)*2-1,x[1]=k/(m-1)*2-1,x[2]=-1,Za(x,x),_[0]=x[P[0]]*P[3],_[1]=x[P[1]]*P[4],_[2]=x[P[2]]*P[5],v[0]=T[E++]/255,v[1]=T[E++]/255,v[2]=T[E++]/255;const I=T[E++]/255*7;v[0]*=I,v[1]*=I,v[2]*=I,qb(S,S,v,yF(_,w)*-x[2]),M+=-x[2]}qb(b,b,S,1/M)}y[w]=Xs(b,b,1/6)}return y}(dA(r,l,f),f,f);const d=[];for(let p=0;p<u.length;p++)d.push(...u[p]);u=d}const c={rgbmRange:t.rgbmRange,envMap:a,prefilterMap:l};return u&&(c.sh=u),t.format==="array"&&(c.envMap={width:a.width,height:a.height,faces:dA(r,a,n)},c.prefilterMap={width:l.width,height:l.height,faces:h},a.destroy(),l.destroy()),c},generateDFGLUT:gA});const wF={uvScale:[1,1],uvOffset:[0,0],uvRotation:0,textureOrigin:null,textureWidth:null,baseColorFactor:[1,1,1,1],emissiveFactor:[0,0,0],baseColorIntensity:1,emitColorFactor:1,occlusionFactor:1,roughnessFactor:.4,metallicFactor:0,normalMapFactor:1,specularF0:.5,emitMultiplicative:1,normalMapFlipY:0,outputSRGB:1,baseColorTexture:null,normalTexture:null,occlusionTexture:null,metallicRoughnessTexture:null,emissiveTexture:null,uvOrigin:[0,0],noiseTexture:null,specularAAVariance:20,specularAAThreshold:20,hsv:[0,0,0],contrast:1,bumpTexture:null,bumpScale:.05,bumpMinLayers:5,bumpMaxLayers:20,alphaTest:0};let yA=class extends Gr{constructor(t){const e=$n({},wF);(t.metallicRoughnessTexture||t.metallicRoughnessTexture)&&(e.roughnessFactor=1,e.metallicFactor=1),super(t,e)}appendDefines(t,e){super.appendDefines(t,e);const n=this.uniforms;return n.GAMMA_CORRECT_INPUT&&(t.GAMMA_CORRECT_INPUT=1),e.data[e.desc.colorAttribute]&&(t.HAS_COLOR=1),e.data[e.desc.color0Attribute]&&(t.HAS_COLOR0=1,t.COLOR0_SIZE=e.getColor0Size()),e.data[e.desc.tangentAttribute]?t.HAS_TANGENT=1:e.data[e.desc.normalAttribute]&&(t.HAS_NORMAL=1),e.data.aVertexColorType&&(t.HAS_VERTEX_COLOR=1),e.data[e.desc.uv0Attribute]&&(n.baseColorTexture&&(t.HAS_ALBEDO_MAP=1),n.metallicRoughnessTexture&&(t.HAS_METALLICROUGHNESS_MAP=1),n.occlusionTexture&&e.data[e.desc.uv1Attribute]&&(t.HAS_AO_MAP=1),n.emissiveTexture&&(t.HAS_EMISSIVE_MAP=1),n.normalTexture&&(t.HAS_NORMAL_MAP=1),n.bumpTexture&&(t.HAS_BUMP_MAP=1),n.skinTexture&&(t.HAS_SKIN_MAP=1),(t.HAS_ALBEDO_MAP||t.HAS_METALLICROUGHNESS_MAP||t.HAS_AO_MAP||t.HAS_EMISSIVE_MAP||t.HAS_NORMAL_MAP||t.HAS_BUMP_MAP||t.HAS_SKIN_MAP)&&(t.HAS_MAP=1),n.noiseTexture&&(t.HAS_RANDOM_TEX=1),e.data[e.desc.tangentAttribute]?t.HAS_TANGENT=1:e.data[e.desc.normalAttribute]&&(t.HAS_NORMAL=1)),t}},AF=class extends $w(yA){};function TF(r,t,e){if(e.ambientUpdate){const{iblTexes:n}=r;if(n){const i=e.target;x0(n),r.iblTexes=Bf(t,i)}else r.iblTexes=Bf(t,e.target)}}const MF=[0,0];function Bf(r,t){const e=t.getLightManager(),n=e&&e.getAmbientResource();return n?{prefilterMap:r.cube({width:n.prefilterMap.width,height:n.prefilterMap.height,faces:n.prefilterMap.faces,min:"linear mipmap linear",mag:"linear",format:"rgba"}),sh:n.sh,rgbmRange:n.rgbmRange}:null}function x0(r){for(const t in r)r[t].destroy&&r[t].destroy(),delete r[t]}var SF=Object.freeze({__proto__:null,createIBLTextures:Bf,disposeIBLTextures:x0,getIBLResOnCanvas:function(r){const{dfgLUT:t,iblTexes:e}=r;return{dfgLUT:t,iblTexes:e}},getPBRUniforms:function(r,t,e,n,i){const o=r.viewMatrix,s=r.projMatrix,a=r.cameraPosition,l=r.getRenderer().canvas,h=function(c,f){const d=c.getLightManager(),p=d&&d.getAmbientResource(),g=d&&d.getAmbientLight()||{},m=d&&d.getDirectionalLight()||{};let y;if(p){const x=f.prefilterMap.width,v=Math.log(x)/Math.log(2);y={prefilterMap:f.prefilterMap,diffuseSPH:f.sh,prefilterMiplevel:[v,v],prefilterSize:[x,x],hdrHSV:g.hsv||[0,0,0]}}else y={ambientColor:g.color||[.2,.2,.2]};return y.rgbmRange=p?f.rgbmRange:7,y.environmentExposure=Io(g.exposure)?g.exposure:1,y.environmentOrientation=g.orientation||0,y.light0_diffuse=[...m.color||[1,1,1],1],y.light0_viewDirection=m.direction||[1,1,-1],y}(r,t),u=$n({viewMatrix:o,projMatrix:s,projViewMatrix:r.projViewMatrix,cameraPosition:a,outSize:[l.width,l.height],cameraNearFar:[r.cameraNear,r.cameraFar]},h);return u.brdfLUT=e,n&&n.renderUniforms&&$n(u,n.renderUniforms),u.halton=i||MF,u},isSupported:function(r){return r.hasExtension("EXT_shader_texture_lod")},loginIBLResOnCanvas:function(r,t,e){if(!r.dfgLUT&&(r.dfgLUT=gA(t),r.dfgLUT.mtkRefCount=0,e)){const i=TF.bind(this,r,t);e.on("updatelights",i),r._iblResListener=i}r.dfgLUT.mtkRefCount++;const n=e.getLightManager();return n&&n.getAmbientResource()?(r.iblTexes||(r.iblTexes=Bf(t,e)),{dfgLUT:r.dfgLUT,iblTexes:r.iblTexes}):{dfgLUT:r.dfgLUT,iblTexes:null}},logoutIBLResOnCanvas:function(r,t){let e=!1;r.dfgLUT&&(r.dfgLUT.mtkRefCount--,r.dfgLUT.mtkRefCount<=0)&&(e=!0,t&&t.off("updatelights",r._iblResListener),r.dfgLUT.destroy(),delete r.dfgLUT),r.iblTexes&&e&&(x0(r.iblTexes),delete r.iblTexes)}});let CF=class extends Ye{constructor(t){super({vert:`attribute vec3 aPosition;
uniform mat4 lightProjViewModelMatrix;
uniform mat4 positionMatrix;
uniform mat4 modelViewMatrix;
uniform mat4 modelMatrix;
#include <line_extrusion_vert>
#include <get_output>
varying vec4 vPosition;
void main() {
  mat4 c = getPositionMatrix();
#ifdef IS_LINE_EXTRUSION
vec3 d = getLineExtrudePosition(aPosition);
  vec4 e = getPosition(d);
#else
vec4 e = getPosition(aPosition);
#endif
gl_Position = lightProjViewModelMatrix * c * e;
  vPosition = gl_Position;
}`,frag:`#define SHADER_NAME vsm_mapping
#ifdef USE_VSM
#extension GL_OES_standard_derivatives : enable
#endif
precision highp float;
varying vec4 vPosition;
#ifdef PACK_FLOAT
#include <common_pack_float>
#endif
void main() {
  
#if defined(USE_VSM)
float c = vPosition.z / vPosition.w;
  c = c * .5 + .5;
  float d = c;
  float e = c * c;
  float f = dFdx(c);
  float h = dFdy(c);
  e += .25 * (f * f + h * h);
  gl_FragColor = vec4(d, e, c, .0);
#endif
#if defined(USE_ESM)
#ifdef PACK_FLOAT
gl_FragColor = common_encodeDepth(gl_FragCoord.z);
#else
gl_FragColor = vec4(gl_FragCoord.z, .0, .0, 1.);
#endif
#endif
}`,uniforms:[{name:"lightProjViewModelMatrix",type:"function",fn:function(e,n){return qt([],n.lightProjViewMatrix,n.modelMatrix)}}],extraCommandProps:{},defines:t})}filter(t){return t.castShadow}},PF=class extends Dr{constructor({blurOffset:t}){super({vert:lo,frag:`precision highp float;
varying vec2 vTexCoord;
uniform sampler2D textureSource;
uniform vec2 resolution;
#include <common_pack_float>
void main() {
  float c = .0;
  float d = .0;
  for(int x = -BOXBLUR_OFFSET; x <= BOXBLUR_OFFSET; ++x)
    for(int y = -BOXBLUR_OFFSET; y <= BOXBLUR_OFFSET; ++y) {
      vec2 e = vTexCoord.st + vec2(float(x) / resolution.x, float(y) / resolution.y);
      e = clamp(e, .0, 1.);
      float f = common_decodeDepth(texture2D(textureSource, e));
      float s = max(.0, sign(1. - f));
      d += sign(f) * s;
      c += f;
    }
  float h = c / max(1., d);
  gl_FragColor = common_encodeDepth(h);
}`,defines:{BOXBLUR_OFFSET:t||2}}),this._blurOffset=t||2}getMeshCommand(t,e){const n="box_shadow_blur_"+this._blurOffset;return this.commands[n]||(this.commands[n]=this.createREGLCommand(t,null,e.getElements())),this.commands[n]}},vA=null,xA=null,EF=class{constructor(t,{width:e,height:n,blurOffset:i,defines:o}){this.renderer=t,this.width=e||512,this.height=n||512,this.blurOffset=di(i)?2:i,this._init(o)}render(t,{cameraProjViewMatrix:e,lightDir:n,farPlane:i,cameraLookAt:o}){return{lightProjViewMatrix:this._renderShadow(t,e,n,i,o),shadowMap:this.blurTex||this.depthTex,depthFBO:this.depthFBO,blurFBO:this.blurFBO}}resize(t,e){return this.depthTex&&(this.depthTex.resize(t,e),this.depthFBO.resize(t,e)),this.width=t,this.blurFBO&&(this.blurTex.resize(t,e),this.blurFBO.resize(t,e)),this.height=e,this}_renderShadow(t,e,n,i,o){const s=this.renderer,a=vA(e);if(i)for(let h=4;h<8;h++)a[h]=i[h-4];const l=xA(o,a,n);return s.clear({color:[1,0,0,1],depth:1,framebuffer:this.depthFBO}),s.render(this.shadowMapShader,{lightProjViewMatrix:l},t,this.depthFBO),this.blurFBO&&(this.boxBlurShader||(this.boxBlurShader=new PF({blurOffset:this.blurOffset})),s.clear({color:[1,0,0,1],depth:1,framebuffer:this.blurFBO}),s.render(this.boxBlurShader,{resolution:[this.depthTex.width,this.depthTex.height],textureSource:this.depthTex},null,this.blurFBO)),l}_init(t){const e=this.renderer.regl,n="uint8",i=this.width,o=this.height;this.depthTex=e.texture({width:i,height:o,format:"rgb",type:n,min:"nearest",mag:"nearest"}),this.shadowMapShader=new CF(t),this.shadowMapShader.filter=s=>s.castShadow,this.depthFBO=e.framebuffer({color:this.depthTex}),this.blurOffset<=0||(this.blurTex=e.texture({width:i,height:o,format:"rgb",type:n,min:"linear",mag:"linear"}),this.blurFBO=e.framebuffer({color:this.blurTex}))}dispose(){this.depthTex&&(this.depthTex.destroy(),this.depthFBO.destroy(),delete this.depthTex,delete this.depthFBO),this.blurTex&&(this.blurTex.destroy(),this.blurFBO.destroy(),delete this.blurTex,delete this.blurFBO),this.shadowMapShader&&(this.shadowMapShader.dispose(),delete this.shadowMapShader),this.boxBlurShader&&(this.boxBlurShader.dispose(),delete this.boxBlurShader)}};vA=function(){const r=[[-1,-1,-1,1],[1,-1,-1,1],[1,1,-1,1],[-1,1,-1,1],[-1,-1,1,1],[1,-1,1,1],[1,1,1,1],[-1,1,1,1]],t=new Array(16);return function(e){$s(t,e);const n=[];for(let i=0;i<r.length;i++){const o=ss([],r[i],t);Jh(o,o,1/o[3]),n.push(o)}return n}}(),xA=function(){let r=new Array(4);const t=new Array(3),e=[0,0,0,0],n=[0,1,0],i=new Array(3);let o=new Array(16),s=new Array(16);const a=new Array(16),l=[1,1,1],h=[0,0,0];return function(u,c,f){Tr(e,...u,1),Xs(t,f,-1),o=Zs(o,os(i,e,Za(i,t)),e,n),ss(r,c[0],o);let d=r[2],p=r[2],g=r[0],m=r[0],y=r[1],x=r[1];for(let b=1;b<8;b++)r=ss(r,c[b],o),r[2]>p&&(p=r[2]),r[2]<d&&(d=r[2]),r[0]>m&&(m=r[0]),r[0]<g&&(g=r[0]),r[1]>x&&(x=r[1]),r[1]<y&&(y=r[1]);s=YR(s,-1,1,-1,1,-p,-d);const v=l[0]=2/(m-g),_=l[1]=-2/(x-y);h[0]=-.5*(g+m)*v,h[1]=-.5*(y+x)*_,mn(a),oo(a,a,h),so(a,a,l);const w=qt(s,a,s);return qt(new Array(16),w,o)}}();let OF=class extends Ye{constructor(t){super({vert:`#define SHADER_NAME SHADOW_DISPLAY
attribute vec3 aPosition;
uniform mat4 projMatrix;
uniform mat4 modelViewMatrix;
uniform vec2 halton;
uniform vec2 globalTexSize;
varying vec4 vPosition;
#include <vsm_shadow_vert>
void main() {
  vec4 c = vec4(aPosition, 1.);
  vec4 d = modelViewMatrix * c;
  mat4 e = projMatrix;
  e[2].xy += halton.xy / globalTexSize.xy;
  gl_Position = e * d;
  vPosition = gl_Position;
  shadow_computeShadowPars(c);
}`,frag:`#define SHADER_NAME SHADOW_DISPLAY
precision mediump float;
uniform vec3 color;
#include <vsm_shadow_frag>
void main() {
  float c = shadow_computeShadow();
  float d = 1. - c;
  gl_FragColor = vec4(color * d, d);
}`,uniforms:[{name:"modelViewMatrix",type:"function",fn:function(e,n){const i=[];return qt(i,n.viewMatrix,n.modelMatrix),i}}],defines:t||{USE_ESM:1},extraCommandProps:{depth:{enable:!0,mask:!1},viewport:{x:0,y:0,width:(e,n)=>n.globalTexSize[0],height:(e,n)=>n.globalTexSize[1]}}})}getMeshCommand(t,e){return this.commands.shadow_display||(this.commands.shadow_display=this.createREGLCommand(t,null,e.getElements())),this.commands.shadow_display}};function jf(r){return 256*r[2]*256+256*r[1]+r[0]}const nu=new Uint8Array(4),kF=new Float32Array(nu.buffer);let Vf,_A;const _0=[1,1],b0=`
    vec3 unpack(highp float f) {
        highp vec3 color;
        color.b = floor(f / 65536.0);
        color.g = floor((f - color.b * 65536.0) / 256.0);
        color.r = f - floor(color.b * 65536.0) - floor(color.g * 256.0);
        // now we have a vec3 with the 3 components in range [0..255]. Let's normalize it!
        return color / 255.0;
    }
`,IF=`
    precision highp float;

    varying float vPickingId;
    varying float vFbo_picking_visible;

    uniform float fbo_picking_meshId;

    ${b0}

    void main() {
        if (vFbo_picking_visible == 0.0) {
            discard;
            return;
        }
        gl_FragColor = vec4(unpack(vPickingId), fbo_picking_meshId / 255.0);
    }
`,RF=`
    precision highp float;

    uniform int fbo_picking_meshId;
    varying float vFbo_picking_visible;

    ${b0}

    void main() {
        if (vFbo_picking_visible == 0.0) {
            discard;
            return;
        }
        gl_FragColor = vec4(unpack(float(fbo_picking_meshId)), 1.0);
        // gl_FragColor = vec4(unpack(float(35)), 1.0);
    }
`,DF=`
    precision highp float;

    varying float vPickingId;
    varying float vFbo_picking_visible;

    ${b0}

    void main() {
        if (vFbo_picking_visible == 0.0) {
            discard;
            return;
        }
        gl_FragColor = vec4(unpack(vPickingId), 1.0);
    }
`;let Pi=class{constructor(t,{vert:e,uniforms:n,defines:i,extraCommandProps:o},s,a){this._renderer=t,this._fbo=s,this._map=a,this._clearFbo(s),this._vert=e,this._uniforms=n,this._defines=i,this._extraCommandProps=$n({},o),delete this._extraCommandProps.blend,delete this._extraCommandProps.stencil,this._currentMeshes=[],this._init()}_init(){const t=[];this._uniforms&&t.push(...this._uniforms);const e={ENABLE_PICKING:1,HAS_PICKING_ID:1};if(this._defines)for(const s in this._defines)e[s]=this._defines[s];const n=this._vert,i=this._extraCommandProps;this._shader0=new Ye({vert:n,frag:IF,uniforms:t,defines:e,extraCommandProps:i}),this._shader2=new Ye({vert:n,frag:DF,uniforms:t,defines:e,extraCommandProps:i});const o={ENABLE_PICKING:1,HAS_PICKING_ID:1};if(this._defines)for(const s in this._defines)o[s]=this._defines[s];this._shader1=new Ye({vert:n,frag:RF,uniforms:t,defines:o,extraCommandProps:i}),this._depthShader=new Ye({vert:n,frag:`
    #ifdef GL_ES
        precision highp float;
    #endif
    #if __VERSION__ == 100 && defined(GL_EXT_frag_depth)
        #extension GL_EXT_frag_depth : enable
    #endif
    #include <gl2_frag>
    #include <common_pack_float>
    varying float vFbo_picking_viewZ;
    uniform float logDepthBufFC;
    varying float vFbo_picking_fragDepth;

    const float PackUpscale = 256. / 255.;
    const float UnpackDownscale = 255. / 256.;
    const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );
    const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );
    const float ShiftRight8 = 1. / 256.;
    vec4 packDepthToRGBA(const in float v ) {
        vec4 r = vec4(fract(v * PackFactors), v);
        r.yzw -= r.xyz * ShiftRight8;
        return r * PackUpscale;
    }

    void main() {
        float fragDepth = vFbo_picking_fragDepth > 1.0 ? vFbo_picking_fragDepth : vFbo_picking_viewZ + 1.0;
        #if __VERSION__ == 300 || __VERSION__ == 100 && defined(GL_EXT_frag_depth)
            gl_FragDepthEXT = log2(fragDepth) * logDepthBufFC * 0.5;
        #endif
        vec4 depthColor = packDepthToRGBA(fragDepth - 1.0);
        glFragColor = common_unpackFloat(dot(depthColor, UnpackFactors));
        #if __VERSION__ == 100
            gl_FragColor = glFragColor;
        #endif
    }
`,uniforms:t,defines:o,extraCommandProps:i}),this._scene=new ur,this._scene1=new ur}filter(){return!0}render(t,e,n=!1){if(!t||!t.length)return this;const i=this._fbo;n&&this.clear(),t=t.filter(s=>s&&s.isValid()),this._scene.setMeshes(t);const o=this._getShader(t,n);o.filter=this.filter,this._currentShader&&o!==this._currentShader&&this.clear(),this._currentShader=o,t.forEach((s,a)=>{s.setUniform("fbo_picking_meshId",a+this._currentMeshes.length)});for(let s=0;s<t.length;s++)this._currentMeshes.push(t[s]);return this._renderer.render(o,e,this._scene,i),this}pickAll(t,e,n,i,o){n=bA(n);const{meshIds:s,pickingIds:a,coords:l,points:h}=this._pick(t,e,n,i,o),u=[];if(a&&s){const c={};for(let f=0;f<s.length;f++){const d=`${a[f]}_${s[f]}`;s[f]==null||a[f]==null||c[d]||(c[d]=!0,u.push({meshId:s[f],pickingId:a[f],point:h[f]||null,coordinate:l[f]||null}))}}return u}pick(t,e,n,i,o={}){n=bA(n);const{meshIds:s,pickingIds:a,width:l,coords:h,points:u}=this._pick(t,e,n,i,o);if(a&&s){const c=[];for(let f=0;f<=n[0];f++)c.push(f),f>0&&c.push(-f);for(let f=0;f<c.length;f++)for(let d=0;d<c.length;d++){const p=(c[d]+n[1])*l+(c[f]+n[0]);if(s[p]!=null)return{meshId:s[p],pickingId:a[p],point:u[p]||null,coordinate:h[p]||null}}}return{pickingId:null,meshId:null,point:null}}_pick(t,e,n,i,o={}){const s=this._currentShader,a=this._currentMeshes;if(!s||!a||!a.length)return{pickingId:null,meshId:null,point:null};t=Math.round(t),e=Math.round(e);const l=this._fbo;if(t<=2||t>=l.width-2||e<=2||e>=l.height-2)return{pickingId:null,meshId:null,point:null};const{px:h,py:u,width:c,height:f}=this._getParams(t,e,n,l),d=new Uint8Array(4*c*f),p=this._renderer.regl.read({data:d,x:h,y:u,framebuffer:l,width:c,height:f}),g=[];let m=[];for(let A=0;A<p.length;A+=4){const{pickingId:T,meshId:S}=this._packData(p.subarray(A,A+4),s);g.push(S),m.push(T)}const y={},x=g.filter(A=>A!=null&&!y[A]&&(y[A]=1,!0)).map(A=>a[A]);let v;for(let A=0;A<x.length;A++)if(x[A]&&x[A].geometry){v=x[A];break}if(!v)return{pickingId:null,meshId:null,point:null};const _=v.geometry.desc.pickingIdAttribute;g.length&&s===this._shader1&&(v.getUniform("uPickingId")!==void 0||v.geometry.data[_])&&(m=this._getPickingId(h,u,c,f,d,x,i));const w=[],b=[];if(g.length&&o.returnPoint){const{viewMatrix:A,projMatrix:T}=o,S=this._pickDepth(h,u,c,f,d,x,i);for(let M=0;M<S.length;M++)if(S[M]&&g[M]!=null){const E=this._getWorldPos(t,e,S[M],A,T),P=this._convertPickPoint(E);w.push(E),b.push(P)}else w.push(null),b.push(null)}return{meshIds:g,pickingIds:m,coords:b,points:w,width:c,height:f}}_convertPickPoint(t){const e=this._map;if(!e)return null;const n=e.getGLRes();if(!Vf){const s=e.getCenter();_A=new s.constructor(0,0,0);const a=e.coordToPoint(s);Vf=new a.constructor(0,0)}Vf.set(t[0],t[1]);const i=e.pointAtResToCoord(Vf,n,_A),o=e.pointAtResToAltitude(t[2],n);return[i.x,i.y,o]}clear(){return this._fbo&&this._clearFbo(this._fbo),this._currentMeshes=[],delete this._currentShader,this}getMeshAt(t){return this._currentMeshes?this._currentMeshes[t]:null}getRenderedMeshes(){return this._currentMeshes}dispose(){this.clear(),this._shader0&&this._shader0.dispose(),this._shader1&&this._shader1.dispose(),this._shader2&&this._shader2.dispose(),this._scene&&this._scene.clear(),this._scene1&&this._scene1.clear()}_getWorldPos(t,e,n,i,o){const s=this._fbo,a=[],l=s.width/2||1,h=s.height/2||1,u=[(t-l)/l,(h-e)/h,0,1],c=[(t-l)/l,(h-e)/h,1,1],f=$s(a,o),d=[],p=[];Gf(d,u,f),Gf(p,c,f);const g=-d[2],m=(n-g)/(-p[2]-g),y=qt(a,o,i),x=$s(a,y),v=Gf(u,u,x),_=Gf(c,c,x);return[Af(v[0],_[0],m),Af(v[1],_[1],m),Af(v[2],_[2],m)]}_getPickingId(t,e,n,i,o,s,a){const l=this._renderer.regl,h=this._getFBO1();this._clearFbo(h),this._scene1.setMeshes(s),this._renderer.render(this._shader2,a,this._scene1,h);const u=l.read({data:o,x:t,y:e,framebuffer:h,width:n,height:i}),c=[];for(let f=0;f<u.length;f+=4)c.push(jf(u.subarray(f,f+4)));return c}_pickDepth(t,e,n,i,o,s,a){const l=this._renderer.regl,h=this._getFBO1();this._scene1.setMeshes(s),this._clearFbo(h),a.logDepthBufFC=2/(Math.log(this._map.cameraFar+1)/Math.LN2),this._renderer.render(this._depthShader,a,this._scene1,h);const u=l.read({data:o,x:t,y:e,framebuffer:h,width:n,height:i}),c=[];for(let d=0;d<u.length;d+=4)c.push((f=u.subarray(d,d+4),nu[0]=f[3],nu[1]=f[2],nu[2]=f[1],nu[3]=f[0],kF[0]));var f;return c}_packData(t,e){if(t[0]===255&&t[1]===255&&t[2]===255&&t[3]===255)return{meshId:null,pickingId:null};let n=null,i=null;return e===this._shader1?i=jf(t):e===this._shader0?(i=t[3],n=jf(t)):(i=null,n=jf(t)),{meshId:i,pickingId:n}}_clearFbo(t){this._renderer.regl.clear({color:[1,1,1,1],depth:1,stencil:0,framebuffer:t})}_getShader(t,e){return e&&t.length<256?this._shader0:this._shader1}_getFBO1(){const t=this._renderer.regl,e=this._fbo;return this._fbo1?this._fbo1.width===e.width&&this._fbo1.height===e.height||this._fbo1.resize(e.width,e.height):this._fbo1=t.framebuffer(e.width,e.height),this._fbo1}_getParams(t,e,n,i){const o=n[0],s=n[1];e=i.height-e;let a=2*o+1,l=2*s+1;const h=(t-=o)+a,u=(e-=s)+l;return h>i.width&&(a-=h-i.width),u>i.height&&(l-=u-i.height),{px:t=t<0?0:t,py:e=e<0?0:e,width:a,height:l}}getPickingVert(){return this._vert}getUniformDeclares(){return this._uniforms}};function Gf(r,t,e){const n=t[0],i=t[1],o=t[2],s=1/(e[3]*n+e[7]*i+e[11]*o+e[15]);return r[0]=(e[0]*n+e[4]*i+e[8]*o+e[12])*s,r[1]=(e[1]*n+e[5]*i+e[9]*o+e[13])*s,r[2]=(e[2]*n+e[6]*i+e[10]*o+e[14])*s,r}function bA(r){return Io(r)&&(_0[0]=_0[1]=r,r=_0),r}function FF(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var w0={exports:{}};function Uf(r,t,e){e=e||2;var n,i,o,s,a,l,h,u=t&&t.length,c=u?t[0]*e:r.length,f=wA(r,0,c,e,!0),d=[];if(!f||f.next===f.prev)return d;if(u&&(f=function(g,m,y,x){var v,_,w,b=[];for(v=0,_=m.length;v<_;v++)(w=wA(g,m[v]*x,v<_-1?m[v+1]*x:g.length,x,!1))===w.next&&(w.steiner=!0),b.push(GF(w));for(b.sort(BF),v=0;v<b.length;v++)y=jF(b[v],y);return y}(r,t,f,e)),r.length>80*e){n=o=r[0],i=s=r[1];for(var p=e;p<c;p+=e)(a=r[p])<n&&(n=a),(l=r[p+1])<i&&(i=l),a>o&&(o=a),l>s&&(s=l);h=(h=Math.max(o-n,s-i))!==0?32767/h:0}return ru(f,d,e,n,i,h,0),d}function wA(r,t,e,n,i){var o,s;if(i===M0(r,t,e,n)>0)for(o=t;o<e;o+=n)s=MA(o,r[o],r[o+1],s);else for(o=e-n;o>=t;o-=n)s=MA(o,r[o],r[o+1],s);return s&&$f(s,s.next)&&(ou(s),s=s.next),s}function Qs(r,t){if(!r)return r;t||(t=r);var e,n=r;do if(e=!1,n.steiner||!$f(n,n.next)&&zn(n.prev,n,n.next)!==0)n=n.next;else{if(ou(n),(n=t=n.prev)===n.next)break;e=!0}while(e||n!==t);return t}function ru(r,t,e,n,i,o,s){if(r){!s&&o&&function(u,c,f,d){var p=u;do p.z===0&&(p.z=A0(p.x,p.y,c,f,d)),p.prevZ=p.prev,p.nextZ=p.next,p=p.next;while(p!==u);p.prevZ.nextZ=null,p.prevZ=null,function(g){var m,y,x,v,_,w,b,A,T=1;do{for(y=g,g=null,_=null,w=0;y;){for(w++,x=y,b=0,m=0;m<T&&(b++,x=x.nextZ);m++);for(A=T;b>0||A>0&&x;)b!==0&&(A===0||!x||y.z<=x.z)?(v=y,y=y.nextZ,b--):(v=x,x=x.nextZ,A--),_?_.nextZ=v:g=v,v.prevZ=_,_=v;y=x}_.nextZ=null,T*=2}while(w>1)}(p)}(r,n,i,o);for(var a,l,h=r;r.prev!==r.next;)if(a=r.prev,l=r.next,o?zF(r,n,i,o):LF(r))t.push(a.i/e|0),t.push(r.i/e|0),t.push(l.i/e|0),ou(r),r=l.next,h=l.next;else if((r=l)===h){s?s===1?ru(r=HF(Qs(r),t,e),t,e,n,i,o,2):s===2&&NF(r,t,e,n,i,o):ru(Qs(r),t,e,n,i,o,1);break}}}function LF(r){var t=r.prev,e=r,n=r.next;if(zn(t,e,n)>=0)return!1;for(var i=t.x,o=e.x,s=n.x,a=t.y,l=e.y,h=n.y,u=i<o?i<s?i:s:o<s?o:s,c=a<l?a<h?a:h:l<h?l:h,f=i>o?i>s?i:s:o>s?o:s,d=a>l?a>h?a:h:l>h?l:h,p=n.next;p!==t;){if(p.x>=u&&p.x<=f&&p.y>=c&&p.y<=d&&ol(i,a,o,l,s,h,p.x,p.y)&&zn(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function zF(r,t,e,n){var i=r.prev,o=r,s=r.next;if(zn(i,o,s)>=0)return!1;for(var a=i.x,l=o.x,h=s.x,u=i.y,c=o.y,f=s.y,d=a<l?a<h?a:h:l<h?l:h,p=u<c?u<f?u:f:c<f?c:f,g=a>l?a>h?a:h:l>h?l:h,m=u>c?u>f?u:f:c>f?c:f,y=A0(d,p,t,e,n),x=A0(g,m,t,e,n),v=r.prevZ,_=r.nextZ;v&&v.z>=y&&_&&_.z<=x;){if(v.x>=d&&v.x<=g&&v.y>=p&&v.y<=m&&v!==i&&v!==s&&ol(a,u,l,c,h,f,v.x,v.y)&&zn(v.prev,v,v.next)>=0||(v=v.prevZ,_.x>=d&&_.x<=g&&_.y>=p&&_.y<=m&&_!==i&&_!==s&&ol(a,u,l,c,h,f,_.x,_.y)&&zn(_.prev,_,_.next)>=0))return!1;_=_.nextZ}for(;v&&v.z>=y;){if(v.x>=d&&v.x<=g&&v.y>=p&&v.y<=m&&v!==i&&v!==s&&ol(a,u,l,c,h,f,v.x,v.y)&&zn(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;_&&_.z<=x;){if(_.x>=d&&_.x<=g&&_.y>=p&&_.y<=m&&_!==i&&_!==s&&ol(a,u,l,c,h,f,_.x,_.y)&&zn(_.prev,_,_.next)>=0)return!1;_=_.nextZ}return!0}function HF(r,t,e){var n=r;do{var i=n.prev,o=n.next.next;!$f(i,o)&&AA(i,n,n.next,o)&&iu(i,o)&&iu(o,i)&&(t.push(i.i/e|0),t.push(n.i/e|0),t.push(o.i/e|0),ou(n),ou(n.next),n=r=o),n=n.next}while(n!==r);return Qs(n)}function NF(r,t,e,n,i,o){var s=r;do{for(var a=s.next.next;a!==s.prev;){if(s.i!==a.i&&UF(s,a)){var l=TA(s,a);return s=Qs(s,s.next),l=Qs(l,l.next),ru(s,t,e,n,i,o,0),void ru(l,t,e,n,i,o,0)}a=a.next}s=s.next}while(s!==r)}function BF(r,t){return r.x-t.x}function jF(r,t){var e=function(i,o){var s,a=o,l=i.x,h=i.y,u=-1/0;do{if(h<=a.y&&h>=a.next.y&&a.next.y!==a.y){var c=a.x+(h-a.y)*(a.next.x-a.x)/(a.next.y-a.y);if(c<=l&&c>u&&(u=c,s=a.x<a.next.x?a:a.next,c===l))return s}a=a.next}while(a!==o);if(!s)return null;var f,d=s,p=s.x,g=s.y,m=1/0;a=s;do l>=a.x&&a.x>=p&&l!==a.x&&ol(h<g?l:u,h,p,g,h<g?u:l,h,a.x,a.y)&&(f=Math.abs(h-a.y)/(l-a.x),iu(a,i)&&(f<m||f===m&&(a.x>s.x||a.x===s.x&&VF(s,a)))&&(s=a,m=f)),a=a.next;while(a!==d);return s}(r,t);if(!e)return t;var n=TA(e,r);return Qs(n,n.next),Qs(e,e.next)}function VF(r,t){return zn(r.prev,r,t.prev)<0&&zn(t.next,r,r.next)<0}function A0(r,t,e,n,i){return(r=1431655765&((r=858993459&((r=252645135&((r=16711935&((r=(r-e)*i|0)|r<<8))|r<<4))|r<<2))|r<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function GF(r){var t=r,e=r;do(t.x<e.x||t.x===e.x&&t.y<e.y)&&(e=t),t=t.next;while(t!==r);return e}function ol(r,t,e,n,i,o,s,a){return(i-s)*(t-a)>=(r-s)*(o-a)&&(r-s)*(n-a)>=(e-s)*(t-a)&&(e-s)*(o-a)>=(i-s)*(n-a)}function UF(r,t){return r.next.i!==t.i&&r.prev.i!==t.i&&!function(e,n){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==n.i&&i.next.i!==n.i&&AA(i,i.next,e,n))return!0;i=i.next}while(i!==e);return!1}(r,t)&&(iu(r,t)&&iu(t,r)&&function(e,n){var i=e,o=!1,s=(e.x+n.x)/2,a=(e.y+n.y)/2;do i.y>a!=i.next.y>a&&i.next.y!==i.y&&s<(i.next.x-i.x)*(a-i.y)/(i.next.y-i.y)+i.x&&(o=!o),i=i.next;while(i!==e);return o}(r,t)&&(zn(r.prev,r,t.prev)||zn(r,t.prev,t))||$f(r,t)&&zn(r.prev,r,r.next)>0&&zn(t.prev,t,t.next)>0)}function zn(r,t,e){return(t.y-r.y)*(e.x-t.x)-(t.x-r.x)*(e.y-t.y)}function $f(r,t){return r.x===t.x&&r.y===t.y}function AA(r,t,e,n){var i=Zf(zn(r,t,e)),o=Zf(zn(r,t,n)),s=Zf(zn(e,n,r)),a=Zf(zn(e,n,t));return i!==o&&s!==a||!(i!==0||!Wf(r,e,t))||!(o!==0||!Wf(r,n,t))||!(s!==0||!Wf(e,r,n))||!(a!==0||!Wf(e,t,n))}function Wf(r,t,e){return t.x<=Math.max(r.x,e.x)&&t.x>=Math.min(r.x,e.x)&&t.y<=Math.max(r.y,e.y)&&t.y>=Math.min(r.y,e.y)}function Zf(r){return r>0?1:r<0?-1:0}function iu(r,t){return zn(r.prev,r,r.next)<0?zn(r,t,r.next)>=0&&zn(r,r.prev,t)>=0:zn(r,t,r.prev)<0||zn(r,r.next,t)<0}function TA(r,t){var e=new T0(r.i,r.x,r.y),n=new T0(t.i,t.x,t.y),i=r.next,o=t.prev;return r.next=t,t.prev=r,e.next=i,i.prev=e,n.next=e,e.prev=n,o.next=n,n.prev=o,n}function MA(r,t,e,n){var i=new T0(r,t,e);return n?(i.next=n.next,i.prev=n,n.next.prev=i,n.next=i):(i.prev=i,i.next=i),i}function ou(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function T0(r,t,e){this.i=r,this.x=t,this.y=e,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function M0(r,t,e,n){for(var i=0,o=t,s=e-n;o<e;o+=n)i+=(r[s]-r[o])*(r[o+1]+r[s+1]),s=o;return i}w0.exports=Uf,w0.exports.default=Uf,Uf.deviation=function(r,t,e,n){var i=t&&t.length,o=Math.abs(M0(r,0,i?t[0]*e:r.length,e));if(i)for(var s=0,a=t.length;s<a;s++)o-=Math.abs(M0(r,t[s]*e,s<a-1?t[s+1]*e:r.length,e));var l=0;for(s=0;s<n.length;s+=3){var h=n[s]*e,u=n[s+1]*e,c=n[s+2]*e;l+=Math.abs((r[h]-r[c])*(r[u+1]-r[h+1])-(r[h]-r[u])*(r[c+1]-r[h+1]))}return o===0&&l===0?0:Math.abs((l-o)/o)},Uf.flatten=function(r){for(var t=r[0][0].length,e={vertices:[],holes:[],dimensions:t},n=0,i=0;i<r.length;i++){for(var o=0;o<r[i].length;o++)for(var s=0;s<t;s++)e.vertices.push(r[i][o][s]);i>0&&e.holes.push(n+=r[i-1].length)}return e};var SA=FF(w0.exports);const Qn={PBRHelper:bF,StandardMaterial:yA,StandardSpecularGlossinessMaterial:AF,StandardShader:class extends Ye{constructor(r={}){let t=r.extraCommandProps||{};const e=r.uniforms;t=$n({},t);const n=r.defines||{},i=[],o=[],s=[],a=[],l=[],h=[{name:"modelNormalMatrix",type:"function",fn:(u,c)=>Yh(i,c.modelMatrix)},{name:"modelViewNormalMatrix",type:"function",fn:(u,c)=>{const f=qt(o,c.viewMatrix,c.modelMatrix),d=$s(f,f),p=$b(d,d);return Yh(s,p)}},{name:"modelViewMatrix",type:"function",fn:(u,c)=>qt(a,c.viewMatrix,c.modelMatrix)},{name:"environmentTransform",type:"function",fn:(u,c)=>Bm(l,Math.PI*(c.environmentOrientation||0)/180)}];e&&h.push(...e),super({vert:r.vert||`#include <gl2_vert>
#define SHADER_NAME PBR
precision highp float;
attribute vec3 aPosition;
#if defined(HAS_MAP)
attribute vec2 aTexCoord;
uniform vec2 uvOrigin;
uniform vec2 uvScale;
uniform vec2 uvOffset;
uniform float uvRotation;
#ifdef HAS_I3S_UVREGION
attribute vec4 uvRegion;
varying vec4 vUvRegion;
#endif
#if defined(HAS_AO_MAP)
attribute vec2 aTexCoord1;
varying vec2 vTexCoord1;
#endif
#endif
vec3 c;
vec3 d;
vec4 e;
uniform mat4 modelMatrix;
uniform mat4 modelViewMatrix;
uniform mat4 positionMatrix;
uniform mat4 projMatrix;
uniform mediump vec3 cameraPosition;
uniform mat3 modelNormalMatrix;
#ifdef HAS_SSR
uniform mat3 modelViewNormalMatrix;
varying vec3 vViewNormal;
#ifdef HAS_TANGENT
varying vec4 vViewTangent;
#endif
#endif
varying vec3 vModelNormal;
varying vec4 vViewVertex;
#if defined(HAS_TANGENT)
varying vec4 vModelTangent;
varying vec3 vModelBiTangent;
#endif
varying vec3 vModelVertex;
#if defined(HAS_MAP)
varying vec2 vTexCoord;
#endif
#if defined(HAS_COLOR)
attribute vec4 aColor;
varying vec4 vColor;
#endif
#ifdef HAS_OPACITY
attribute float aOpacity;
#endif
varying float vOpacity;
#include <highlight_vert>
#if defined(HAS_COLOR0)
#if COLOR0_SIZE == 3
attribute vec3 aColor0;
varying vec3 vColor0;
#else
attribute vec4 aColor0;
varying vec4 vColor0;
#endif
#endif
#include <line_extrusion_vert>
#include <get_output>
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
#include <vsm_shadow_vert>
#endif
#include <heatmap_render_vert>
#include <vertex_color_vert>
#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)
varying vec3 vTangentViewPos;
varying vec3 vTangentFragPos;
#if __VERSION__ == 100
mat3 f(in mat3 h) {
  vec3 i = h[0];
  vec3 j = h[1];
  vec3 k = h[2];
  return mat3(vec3(i.x, j.x, k.x), vec3(i.y, j.y, k.y), vec3(i.z, j.z, k.z));
}
#else
mat3 f(in mat3 h) {
  return transpose(h);
}
#endif
#endif
void l(const highp vec4 q, out highp vec3 m) {
  m = vec3(.0, .0, 1.) + vec3(2., -2., -2.) * q.x * q.zwx + vec3(2., 2., -2.) * q.y * q.wzy;
}
void l(const highp vec4 q, out highp vec3 m, out highp vec3 t) {
  l(q, m);
  t = vec3(1., .0, .0) + vec3(-2., 2., -2.) * q.y * q.yxw + vec3(-2., 2., 2.) * q.z * q.zwx;
}
const float o = .5;
vec2 u(vec2 v, float A) {
  return vec2(cos(A) * (v.x - o) + sin(A) * (v.y - o) + o, cos(A) * (v.y - o) - sin(A) * (v.x - o) + o);
}
#if defined(HAS_MAP)
vec2 B(vec2 v) {
  vec2 C = decode_getTexcoord(v);
#ifdef HAS_RANDOM_TEX
vec2 D = uvOrigin;
  vec2 E = C * uvScale + uvOffset;
  return mod(D, 1.) + E;
#else
vec2 D = uvOrigin;
  vec2 E = C * uvScale;
  if(uvRotation != .0) {
    D = u(D, uvRotation);
    E = u(E, uvRotation);
  }
  return mod(D, 1.) + E + uvOffset;
#endif
}
#endif
#ifdef PICKING_MODE
#include <fbo_picking_vert>
#endif
#include <excavate_vert>
void main() {
  mat4 F = getPositionMatrix();
#ifdef IS_LINE_EXTRUSION
vec3 G = getLineExtrudePosition(aPosition);
  vec4 H = getPosition(G);
#else
vec4 H = getPosition(aPosition);
#endif
vModelVertex = (modelMatrix * H).xyz;
  vec4 I = F * H;
  vec4 J = modelViewMatrix * I;
  vViewVertex = J;
#ifdef HAS_MASK_EXTENT
gl_Position = projMatrix * getMaskPosition(I, modelMatrix);
#else
gl_Position = projMatrix * J;
#endif
#ifdef PICKING_MODE
float K = 1.;
#if defined(HAS_COLOR)
K *= aColor.a;
#endif
#if defined(HAS_COLOR0) && COLOR0_SIZE == 4
K *= aColor0.a;
#endif
fbo_picking_setData(gl_Position.w, K != .0);
#else
#if defined(HAS_MAP)
vTexCoord = B(aTexCoord);
#ifdef HAS_AO_MAP
vTexCoord1 = B(aTexCoord1);
#endif
#ifdef HAS_I3S_UVREGION
vUvRegion = uvRegion / 65535.;
#endif
#endif
#if defined(HAS_TANGENT) || defined(HAS_NORMAL)
mat3 L = mat3(F);
  mat3 M = modelNormalMatrix * L;
#if defined(HAS_TANGENT)
vec3 t;
  l(aTangent, d, t);
  vModelTangent = vec4(M * t, aTangent.w);
#else
d = decode_getNormal(aNormal);
#endif
vec3 N = d;
  vModelNormal = M * N;
#else
d = vec3(.0);
  vModelNormal = vec3(.0);
#endif
#if defined(HAS_TANGENT)
vModelBiTangent = cross(vModelNormal, vModelTangent.xyz) * sign(aTangent.w);
#endif
#ifdef HAS_SSR
mat3 O = modelViewNormalMatrix * L;
  vViewNormal = O * d;
#if defined(HAS_TANGENT)
vec4 P = vec4(t, aTangent.w);
  vViewTangent = vec4(O * P.xyz, P.w);
#endif
#endif
#if defined(HAS_COLOR)
vColor = aColor / 255.;
#endif
#ifdef HAS_OPACITY
vOpacity = aOpacity / 255.;
#else
vOpacity = 1.;
#endif
highlight_setVarying();
#if defined(HAS_COLOR0)
vColor0 = aColor0 / 255.;
#endif
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
shadow_computeShadowPars(I);
#endif
#ifdef HAS_HEATMAP
heatmap_compute(projMatrix * modelViewMatrix * F, H);
#endif
#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)
mat3 Q = f(mat3(vModelTangent.xyz, vModelBiTangent, vModelNormal));
  vTangentViewPos = Q * cameraPosition;
  vTangentFragPos = Q * vModelVertex;
#endif
#ifdef HAS_VERTEX_COLOR
vertexColor_update();
#endif
#ifdef HAS_EXCAVATE_ANALYSIS
vCoordinateTexcoord = getCoordinateTexcoord();
  vHeight = getWorldHeight();
#endif
#endif
}`,frag:r.frag||`#define PI 3.141593
#if __VERSION__ == 100
#if defined(GL_EXT_shader_texture_lod)
#extension GL_EXT_shader_texture_lod : enable
#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)
#else
#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)
#endif
#if defined(GL_OES_standard_derivatives)
#extension GL_OES_standard_derivatives : enable
#endif
#else
#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)
#endif
#define saturate(x)        clamp(x, 0.0, 1.0)
precision mediump float;
#include <gl2_frag>
#include <hsv_frag>
#include <srgb_frag>
uniform vec3 hsv;
uniform float contrast;
struct MaterialUniforms {
  vec2 roughnessMetalness;
  vec3 albedo;
  float alpha;
  vec3 normal;
  vec3 emit;
  float ao;
  vec3 specularColor;
  float glossiness;
  vec4 skinColor;
} c;
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
#include <vsm_shadow_frag>
#endif
uniform vec3 cameraPosition;
uniform float alphaTest;
#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)
uniform vec4 diffuseFactor;
uniform vec3 specularFactor;
uniform float glossinessFactor;
#if defined(HAS_DIFFUSE_MAP)
uniform sampler2D diffuseTexture;
#endif
#if defined(HAS_SPECULARGLOSSINESS_MAP)
uniform sampler2D specularGlossinessTexture;
#endif
#endif
uniform vec3 emissiveFactor;
uniform vec4 baseColorFactor;
uniform float baseColorIntensity;
uniform float emitColorFactor;
uniform float occlusionFactor;
uniform float environmentExposure;
uniform float roughnessFactor;
uniform float metallicFactor;
uniform float normalMapFactor;
uniform float rgbmRange;
uniform float specularF0;
uniform int emitMultiplicative;
uniform int normalMapFlipY;
uniform int outputSRGB;
uniform mat3 environmentTransform;
#if defined(HAS_ALBEDO_MAP)
uniform sampler2D baseColorTexture;
#endif
#if defined(HAS_METALLICROUGHNESS_MAP)
uniform sampler2D metallicRoughnessTexture;
#endif
#if defined(HAS_EMISSIVE_MAP)
uniform sampler2D emissiveTexture;
#endif
#if defined(HAS_AO_MAP)
uniform sampler2D occlusionTexture;
varying vec2 vTexCoord1;
#endif
#if defined(HAS_NORMAL_MAP) && defined(HAS_TANGENT)
uniform sampler2D normalTexture;
#endif
#if defined(HAS_SKIN_MAP)
uniform sampler2D skinTexture;
#endif
#if defined(HAS_ALPHAMODE)
uniform float alphaCutoff;
#endif
#ifdef HAS_RANDOM_TEX
uniform highp vec2 uvOrigin;
uniform sampler2D noiseTexture;
#endif
uniform sampler2D brdfLUT;
#if defined(HAS_IBL_LIGHTING)
uniform vec3 hdrHSV;
uniform samplerCube prefilterMap;
uniform vec3 diffuseSPH[9];
uniform vec2 prefilterMiplevel;
uniform vec2 prefilterSize;
#else
uniform vec3 ambientColor;
#endif
uniform vec2 cameraNearFar;
uniform vec3 light0_viewDirection;
uniform vec4 light0_diffuse;
#ifdef HAS_SSR
varying vec3 vViewNormal;
#if defined(HAS_TANGENT)
varying vec4 vViewTangent;
#endif
#endif
varying vec3 vModelVertex;
varying vec4 vViewVertex;
#if defined(HAS_MAP)
#include <computeTexcoord_frag>
#endif
varying vec3 vModelNormal;
#if defined(HAS_TANGENT)
varying vec4 vModelTangent;
varying vec3 vModelBiTangent;
#endif
#if defined(HAS_COLOR0)
#if COLOR0_SIZE == 3
varying vec3 vColor0;
#else
varying vec4 vColor0;
#endif
#endif
#if defined(HAS_COLOR)
varying vec4 vColor;
#elif defined(IS_LINE_EXTRUSION)
uniform vec4 lineColor;
#else
uniform vec4 polygonFill;
#endif
#ifdef HAS_LAYER_OPACITY
uniform float layerOpacity;
#endif
varying float vOpacity;
#ifdef HAS_INSTANCE_COLOR
varying vec4 vInstanceColor;
#endif
#ifdef IS_LINE_EXTRUSION
uniform float lineOpacity;
#else
uniform float polygonOpacity;
#endif
#ifdef HAS_PATTERN
uniform sampler2D linePatternFile;
uniform vec2 atlasSize;
uniform float flipY;
uniform float currentTime;
uniform float animSpeedScale;
#ifdef HAS_PATTERN_ANIM
varying float vLinePatternAnimSpeed;
#else
uniform float linePatternAnimSpeed;
#endif
#ifdef HAS_PATTERN_GAP
varying float vLinePatternGap;
#else
uniform float linePatternGap;
#endif
uniform vec4 linePatternGapColor;
uniform vec2 uvScale;
varying float vPatternHeight;
varying float vLinesofar;
varying vec4 vTexInfo;
varying float vNormalY;
vec2 d(vec2 e) {
  vec2 f = mod(e, 1.);
  vec2 h = vTexInfo.xy;
  vec2 i = vTexInfo.zw;
  return (h + f * i) / atlasSize;
}
#endif
#include <heatmap_render_frag>
#include <snow_frag>
#include <mask_frag>
#include <terrain_normal_frag>
#include <vertex_color_frag>
#include <excavate_frag>
#ifdef HAS_RANDOM_TEX
const float j = .5;
vec2 k(vec2 f, float l) {
  return vec2(cos(l) * (f.x - j) + sin(l) * (f.y - j) + j, cos(l) * (f.y - j) - sin(l) * (f.x - j) + j);
}
float m(vec3 n) {
  return n.x + n.y + n.z;
}
#endif
vec4 o(sampler2D u, in vec2 f) {
  
#ifdef HAS_RANDOM_TEX
highp vec2 A = uvOrigin;
  highp vec2 B = f + A - mod(A, 1.);
  float C = texture2D(noiseTexture, .005 * B).x;
  vec2 D = dFdx(B);
  vec2 E = dFdx(B);
  float F = C * 8.;
  float G = fract(F);
#if 1
float H = floor(F);
  float I = H + 1.;
#else
float H = floor(F + .5);
  float I = floor(F);
  G = min(G, 1. - G) * 2.;
#endif
vec2 J = sin(vec2(3., 7.) * H);
  vec2 K = sin(vec2(3., 7.) * I);
  float L = .5;
  vec4 M = texture2DGradEXT(u, f + L * J, D, E);
  vec4 N = texture2DGradEXT(u, f + L * K, D, E);
  return mix(M, N, smoothstep(.2, .8, G - .1 * m(M.xyz - N.xyz)));
#else
return texture2D(u, f);
#endif
}
#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)
uniform sampler2D bumpTexture;
uniform float bumpScale;
uniform float bumpMaxLayers;
uniform float bumpMinLayers;
vec2 O(vec2 f, vec3 P) {
  float Q = mix(bumpMaxLayers, bumpMinLayers, abs(dot(vec3(.0, .0, 1.), P)));
  float R = 1. / Q;
  float S = .0;
  vec2 T = P.xy * bumpScale / (P.z * Q);
  vec2 U = f;
  float V = o(bumpTexture, U).r;
  for(int W = 0; W < 30; W++) {
    S += R;
    U -= T;
    V = o(bumpTexture, U).r;
    if(V < S) {
      break;
    }
  }
  vec2 X = U + T;
  float Y = V - S;
  float Z = o(bumpTexture, X).r - S + R;
  return mix(U, X, Y / (Y - Z));
}
varying vec3 vTangentViewPos;
varying vec3 vTangentFragPos;
#endif
#define SHADER_NAME PBR
vec3 ba(const in vec4 bb, const in float bc) {
  if(bc <= .0)
    return bb.rgb;
  return bc * bb.rgb * bb.a;
}
vec3 bd() {
  return c.albedo;
}
float be() {
  
#if defined(HAS_ALPHAMODE)
if(c.alpha >= alphaCutoff) {
    return 1.;
  } else {
    return .0;
  }
#else
return c.alpha;
#endif
}
float bf() {
  
#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)
vec3 bb = c.specularColor;
  return max(max(bb.r, bb.g), bb.b);
#else
return c.roughnessMetalness.y;
#endif
}
float bg() {
  
#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)
return 1. - c.glossiness;
#else
return c.roughnessMetalness.x;
#endif
}
vec3 bh() {
  return c.emit;
}
vec4 bi() {
  return c.skinColor;
}
vec3 bj() {
  return c.normal;
}
float bk() {
  return c.ao;
}
float bl(const in vec4 bm) {
  return bm.r + bm.g / 255.;
}
vec3 bn(const in float bo, in vec3 bp, const in vec3 t, const in vec3 b, in vec3 bq) {
  bp.xy = bo * bp.xy;
  mat3 br = mat3(t, b, bq);
  return normalize(br * bp);
}
float bs(const float bt, const vec3 bp, const vec3 bu) {
  float bv = clamp(dot(bp, bu), 0., 1.);
  float a = bt * bt;
  float bw = a * a;
  float bx = (bv * bw - bv) * bv + 1.;
  return bw / (PI * bx * bx);
}
vec3 by(const vec3 bz, const float bA, const in vec3 bB, const in vec3 bu) {
  float bC = clamp(dot(bB, bu), 0., 1.);
  bC = pow(1. - bC, 5.);
  return bA * bC + (1. - bC) * bz;
}
float bD(const in vec3 bp, const in vec3 bE, const in float bt, const float bF) {
  float bG = clamp(dot(bp, bE), 0., 1.);
  float a = bt * bt;
  float bH = bG * (bF * (1. - a) + a);
  float bI = bF * (bG * (1. - a) + a);
  return .5 / (bI + bH);
}
vec3 bJ(const float bt, const vec3 bp, const vec3 bE, const vec3 bB, const vec3 bK, const float bF, const float bA) {
  vec3 bu = normalize(bE + bB);
  float bL = bs(bt, bp, bu);
  float bM = bD(bp, bE, bt, bF);
  vec3 bN = by(bK, bA, bB, bu);
  return (bL * bM * PI) * bN;
}
void bO(const in vec3 bp, const in vec3 bE, const in float bF, const in float bt, const in vec3 bP, const in vec3 bK, const in vec3 bQ, const in vec3 bB, const in float bA, out vec3 bR, out vec3 bS) {
  if(bF <= .0) {
    bS = bR = vec3(.0);
    return;
  }
  vec3 a = bF * bQ;
  vec3 bT = bJ(bt, bp, bE, bB, bK, bF, bA);
  bS = a * bT;
  bR = a * bP;
}
#if defined(HAS_IBL_LIGHTING)
vec3 bU(const in vec3 bp) {
  vec3 bq = environmentTransform * bp;
  float x = bq.x;
  float y = bq.y;
  float z = bq.z;
  vec3 bV = (diffuseSPH[0] + diffuseSPH[1] * x + diffuseSPH[2] * y + diffuseSPH[3] * z + diffuseSPH[4] * z * x + diffuseSPH[5] * y * z + diffuseSPH[6] * y * x + diffuseSPH[7] * (3. * z * z - 1.) + diffuseSPH[8] * (x * x - y * y));
  if(length(hdrHSV) > .0) {
    bV = hsv_apply(bV, hdrHSV);
  }
  return max(bV, vec3(.0));
}
vec3 bW(const in float bt, const in vec3 bX) {
  vec3 bY = bX;
  float bZ = prefilterMiplevel.x;
  float ca = min(bZ, bt * prefilterMiplevel.y);
  vec3 cb = ba(textureCubeLod(prefilterMap, bY, ca), rgbmRange);
  if(length(hdrHSV) > .0) {
    return hsv_apply(cb, hdrHSV);
  } else {
    return cb;
  }
}
vec3 cc(const in vec3 cd, const in vec3 bE, const in float bt, const in vec3 ce) {
  float cf = 1. - bt;
  vec3 bX = mix(cd, reflect(-bE, cd), cf * (sqrt(cf) + bt));
  float bo = clamp(1. + dot(bX, ce), .0, 1.);
  vec3 cg = bW(bt, environmentTransform * bX) * bo * bo;
  return cg;
}
#else
vec3 cc(const in vec3 bp, const in vec3 ch, const in float bt, const in vec3 ce) {
  return ambientColor;
}
#endif
vec3 ci(const in vec3 cj, const in float bt, const in float bG, const in float bA) {
  vec4 rgba = texture2D(brdfLUT, vec2(bG, bt)) * vec4(255., 65280.0, 255., 65280.0);
  float b = (rgba[3] + rgba[2]);
  float a = (rgba[1] + rgba[0]);
  return (cj * a + b * bA) / 65535.;
}
vec3 ck(const in vec3 bp, const in vec3 ch, const in float bG, const in float bt, const in vec3 bK, const in vec3 ce, const in float bA) {
  return cc(bp, ch, bt, ce) * ci(bK, bt, bG, bA);
}
float cl(const in float cm, const in float bG) {
  float bx = bG + cm;
  return clamp(bx * bx - 1. + cm, .0, 1.);
}
void cn() {
  
#ifdef HAS_MAP
vec2 f = computeTexCoord(vTexCoord);
#endif
#ifdef HAS_UV_FLIP
f.y = 1. - f.y;
#endif
#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)
f = O(f, normalize(vTangentViewPos - vTangentFragPos));
#endif
c.albedo = baseColorIntensity * baseColorFactor.rgb;
  c.alpha = baseColorFactor.a * vOpacity;
#if defined(HAS_PATTERN)
float co = vLinesofar;
  vec2 i = vTexInfo.zw;
#ifdef HAS_PATTERN_GAP
float cp = vLinePatternGap;
#else
float cp = linePatternGap;
#endif
#ifdef HAS_PATTERN_ANIM
float cq = vLinePatternAnimSpeed;
#else
float cq = linePatternAnimSpeed;
#endif
float cr = ceil(i.x * vPatternHeight / i.y);
  float cs = cr * (1. + cp);
  cq /= animSpeedScale;
  co += mod(currentTime * -cq * .2, cs);
  float ct = mod(co / cs, 1.);
  float cu = mod(flipY * vNormalY, 1.);
  vec2 f = d(vec2(ct * (1. + cp) * uvScale[0], cu * uvScale[1]));
  vec4 cv = texture2D(linePatternFile, f);
  float cw = clamp(sign(1. / (1. + cp) - ct) + .000001, .0, 1.);
  cv = mix(linePatternGapColor, cv, cw);
#ifdef IS_SQUARE_TUBE
float n = clamp(sign(abs(vNormalY) - .999999), .0, 1.);
  cv = mix(cv, vec4(1.), n);
#endif
c.albedo *= cv.rgb;
  c.alpha *= cv.a;
#endif
#if defined(HAS_ALBEDO_MAP)
vec4 cx = o(baseColorTexture, f);
  c.albedo *= sRGBToLinear(cx.rgb);
  c.alpha *= cx.a;
#endif
#if defined(HAS_SKIN_MAP)
vec4 cy = o(skinTexture, f);
  c.skinColor = cy;
#endif
#if defined(HAS_COLOR0)
c.albedo *= vColor0.rgb;
#if COLOR0_SIZE == 4
c.alpha *= vColor0.a;
#endif
#endif
#if defined(HAS_COLOR)
c.albedo *= vColor.rgb;
  c.alpha *= vColor.a;
#elif defined(IS_LINE_EXTRUSION)
c.albedo *= lineColor.rgb;
  c.alpha *= lineColor.a;
#else
c.albedo *= polygonFill.rgb;
  c.alpha *= polygonFill.a;
#endif
#if defined(HAS_INSTANCE_COLOR)
c.albedo *= vInstanceColor.rgb;
  c.alpha *= vInstanceColor.a;
#endif
#if defined(IS_LINE_EXTRUSION)
c.alpha *= lineOpacity;
#else
c.alpha *= polygonOpacity;
#endif
#if defined(HAS_METALLICROUGHNESS_MAP)
c.roughnessMetalness = o(metallicRoughnessTexture, f).gb * vec2(roughnessFactor, metallicFactor);
#else
c.roughnessMetalness = vec2(roughnessFactor, metallicFactor);
#endif
c.emit = emissiveFactor;
#if defined(HAS_EMISSIVE_MAP)
if(emitMultiplicative == 1) {
    c.emit *= sRGBToLinear(o(emissiveTexture, f).rgb);
  } else {
    c.emit += sRGBToLinear(o(emissiveTexture, f).rgb);
  }
#endif
c.emit *= emitColorFactor;
#if defined(HAS_AO_MAP)
vec2 cz = computeTexCoord(vTexCoord1);
  c.ao = o(occlusionTexture, cz).r;
#else
c.ao = 1.;
#endif
c.ao *= occlusionFactor;
#if defined(HAS_NORMAL_MAP) && defined(HAS_TANGENT)
vec3 cA = o(normalTexture, f).xyz * 2. - 1.;
  cA.y = normalMapFlipY == 1 ? -cA.y : cA.y;
  c.normal = cA;
#else
c.normal = normalize(vModelNormal);
#endif
#if defined(HAS_TERRAIN_NORMAL) && defined(HAS_TANGENT)
vec3 cA = convertTerrainHeightToNormalMap(f);
  cA.y = normalMapFlipY == 1 ? -cA.y : cA.y;
  c.normal = cA;
#endif
#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)
c.albedo *= diffuseFactor.rgb;
  c.alpha *= diffuseFactor.a;
#if defined(HAS_DIFFUSE_MAP)
vec4 bP = o(diffuseTexture, f);
  c.albedo *= sRGBToLinear(bP.rgb);
  c.alpha *= bP.a;
#endif
c.specularColor = specularFactor;
  c.glossiness = glossinessFactor;
#if defined(HAS_SPECULARGLOSSINESS_MAP)
vec4 cB = o(specularGlossinessTexture, f);
  c.specularColor *= sRGBToLinear(cB.rgb);
  c.glossiness *= cB.a;
#endif
#endif
}
vec3 cC(const vec3 x) {
  const float a = 2.51;
  const float b = .03;
  const float cD = 2.43;
  const float bx = .59;
  const float cE = .14;
  return (x * (a * x + b)) / (x * (cD * x + bx) + cE);
}
vec3 cF(vec3 bb) {
  bb = cC(bb);
  return bb = pow(bb, vec3(1. / 2.2));
}
uniform float specularAAVariance;
uniform float specularAAThreshold;
float cG(float bt, const vec3 cH) {
  
#if defined(GL_OES_standard_derivatives) || __VERSION__ == 300
vec3 cI = dFdx(cH);
  vec3 cJ = dFdy(cH);
  float cK = specularAAVariance * (dot(cI, cI) + dot(cJ, cJ));
  float cL = min(2. * cK, specularAAThreshold);
  float cM = saturate(bt * bt + cL);
  return sqrt(cM);
#else
return bt;
#endif
}
#ifdef HAS_SSR
uniform sampler2D TextureDepth;
uniform highp vec2 outSize;
uniform float ssrFactor;
uniform float ssrQuality;
uniform sampler2D TextureReflected;
uniform highp mat4 projMatrix;
uniform mat4 invProjMatrix;
uniform vec4 outputFovInfo[2];
uniform mat4 reprojViewProjMatrix;
vec3 cN(const in mat4 cO, const in vec3 cP) {
  vec4 cQ = cO * vec4(cP, 1.);
  return vec3(.5 + .5 * cQ.xy / cQ.w, cQ.w);
}
vec3 cR(const in float cS, const in vec2 f) {
  return texture2D(TextureReflected, f).rgb;
}
float cT(float cU) {
  highp mat4 cO = projMatrix;
  highp float z = cU * 2. - 1.;
  return -cO[3].z / (z + cO[2].z);
}
float cV(const vec2 f) {
  float cU = bl(texture2D(TextureDepth, f));
  return cU;
}
float cW(const in vec2 cX, const in float cY) {
  vec3 cZ = vec3(.06711056, .00583715, 52.9829189);
  return fract(cZ.z * fract(dot(cX.xy + cY * vec2(47., 17.) * .695, cZ.xy))) * .5;
}
vec3 da(const in float cY, const in vec3 db, const in vec3 dc, const in vec3 dd, const in vec3 ch, const in float de) {
  vec2 df;
  df.x = cW(gl_FragCoord.yx, cY);
  df.y = fract(df.x * 52.9829189);
  df.y = mix(df.y, 1., .7);
  float dg = 2. * 3.14159 * df.x;
  float dh = pow(max(df.y, .000001), de / (2. - de));
  float di = sqrt(1. - dh * dh);
  vec3 dj = vec3(di * cos(dg), di * sin(dg), dh);
  dj = dj.x * db + dj.y * dc + dj.z * dd;
  return normalize((2. * dot(ch, dj)) * dj - ch);
}
float dk(const in float cY) {
  return (cW(gl_FragCoord.xy, cY) - .5);
}
vec3 dl(const in vec3 dm, const in float dn, const in vec3 dp) {
  vec3 dq = cN(projMatrix, vViewVertex.xyz + dp * dn);
  dq.z = 1. / dq.z;
  dq -= dm;
  float dr = min(1., .99 * (1. - dm.x) / max(1e-5, dq.x));
  float ds = min(1., .99 * (1. - dm.y) / max(1e-5, dq.y));
  float dt = min(1., .99 * dm.x / max(1e-5, -dq.x));
  float dw = min(1., .99 * dm.y / max(1e-5, -dq.y));
  return dq * min(dr, ds) * min(dt, dw);
}
float dx(const in vec3 dm, const in vec3 dq, inout float dy, inout float dz) {
  float dA = (dz + dy) * .5;
  vec3 dB = dm + dq * dA;
  float z = cV(dB.xy);
  float cU = cT(z);
  float dC = -1. / dB.z;
  dy = cU > dC ? dy : dA;
  dz = cU > dC ? dA : dz;
  return dA;
}
vec4 dD(const in vec3 dm, const in float dn, in float dE, const in vec3 dp, const in float bt, const in float cY) {
  int dF = 20;
  float dG = 1. / float(dF);
  dE *= dG;
  vec3 dq = dl(dm, dn, dp);
  float dH = dG;
  vec3 dI = vec3(.0, dH, 1.);
  vec3 dB;
  float z, cU, dC, dJ, dK, dL;
  bool dM;
  float dN = 1.;
  float dA;
  for(int W = 0; W < dF; W++) {
    dB = dm + dq * dI.y;
    z = cV(dB.xy);
    cU = cT(z);
    dC = -1. / dB.z;
    float dO = clamp(sign(.999 - z), .0, 1.);
    dJ = dO * (dC - cU);
    dJ *= clamp(sign(abs(dJ) - dn * dG * dG), .0, 1.);
    dM = abs(dJ + dE) < dE;
    dK = clamp(dI.x / (dI.x - dJ), .0, 1.);
    dL = dM ? dI.y + dK * dG - dG : 1.;
    dI.z = min(dI.z, dL);
    dI.x = dJ;
    if(dM) {
      float dy = dI.y - dG;
      float dz = dI.y;
      dA = dx(dm, dq, dy, dz);
      dA = dx(dm, dq, dy, dz);
      dA = dx(dm, dq, dy, dz);
      dN = dA;
      break;
    }
    dI.y += dG;
  }
  return vec4(dm + dq * dN, 1. - dN);
}
vec4 dP(in vec4 dQ, const in float dR, const in vec3 dS, const in vec3 dT, const in float bt) {
  vec4 dU = mix(outputFovInfo[0], outputFovInfo[1], dQ.x);
  dQ.xyz = vec3(mix(dU.xy, dU.zw, dQ.y), 1.) * -1. / dQ.z;
  dQ.xyz = (reprojViewProjMatrix * vec4(dQ.xyz, 1.)).xyw;
  dQ.xy /= dQ.z;
  float dV = clamp(6. - 6. * max(abs(dQ.x), abs(dQ.y)), .0, 1.);
  dQ.xy = .5 + .5 * dQ.xy;
  vec3 dW = dT * cR(bt * (1. - dQ.w), dQ.xy);
  return vec4(mix(dS, dW, dR * dV), 1.);
}
vec3 ssr(const in vec3 dS, const in vec3 dT, const in float bt, const in vec3 bp, const in vec3 ch) {
  float dX = .0;
  vec4 bV = vec4(.0);
  float de = bt * bt;
  de = de * de;
  vec3 dY = abs(bp.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);
  vec3 db = normalize(cross(dY, bp));
  vec3 dc = cross(bp, db);
  float dR = ssrFactor * clamp(-4. * dot(ch, bp) + 3.8, .0, 1.);
  dR *= clamp(4.7 - bt * 5., .0, 1.);
  vec3 dm = cN(projMatrix, vViewVertex.xyz);
  dm.z = 1. / dm.z;
  vec3 dp = da(dX, db, dc, bp, ch, de);
  float dn = mix(cameraNearFar.y + vViewVertex.z, -vViewVertex.z - cameraNearFar.x, dp.z * .5 + .5);
  float dE = .5 * dn;
  vec4 dQ;
  if(dot(dp, bp) > .001 && dR > .0) {
    dQ = dD(dm, dn, dE, dp, bt, dX);
    if(dQ.w > .0)
      bV += dP(dQ, dR, dS, dT, bt);
    
  }
  return bV.w > .0 ? bV.rgb / bV.w : dS;
}
#endif
#include <highlight_frag>
void main() {
  cn();
  vec3 ch = normalize(cameraPosition - vModelVertex.xyz);
#if defined(HAS_DOUBLE_SIDE)
vec3 ce = gl_FrontFacing ? normalize(vModelNormal) : -normalize(vModelNormal);
#else
vec3 ce = normalize(vModelNormal);
#endif
#if defined(HAS_TANGENT)
vec4 dZ;
  dZ = vModelTangent;
#if defined(HAS_DOUBLE_SIDE)
dZ.xyz = gl_FrontFacing ? normalize(dZ.xyz) : -normalize(dZ.xyz);
#else
dZ.xyz = normalize(dZ.xyz);
#endif
vec3 ea = normalize(vModelBiTangent);
#endif
float bz = .08 * specularF0;
  float eb = bf();
  vec3 ec = bd();
#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)
vec3 ed = c.specularColor;
#else
vec3 ed = mix(vec3(bz), ec, eb);
#endif
ec *= 1. - eb;
  float ee = clamp(50.0 * ed.g, .0, 1.);
  float ef = bg();
  if(specularAAVariance > .0) {
    ef = cG(ef, ce);
  }
  vec3 eg = bh();
  vec3 eh = bj();
  vec3 ei = vec3(eh);
#if defined(HAS_TANGENT) && (defined(HAS_NORMAL_MAP) || defined(HAS_TERRAIN_NORMAL))
ei = bn(normalMapFactor, ei, dZ.xyz, ea, ce);
#endif
vec3 bP = vec3(.0);
  vec3 bK = vec3(.0);
#if defined(HAS_IBL_LIGHTING)
bP = ec * bU(ei) * .5;
#else
bP = ec * ambientColor;
#endif
float bG = dot(ei, ch);
  bK = ck(ei, ch, bG, ef, ed, ce, ee);
  float ej;
  float ek = 1.;
  float el = bk();
  bP *= environmentExposure * el;
#ifdef HAS_IBL_LIGHTING
ek = cl(el, bG);
#endif
#ifdef HAS_SSR
vec3 em = normalize(gl_FrontFacing ? vViewNormal : -vViewNormal);
  vec3 en = em;
#if defined(HAS_TANGENT) && (defined(HAS_NORMAL_MAP) || defined(HAS_TERRAIN_NORMAL))
vec4 eo;
  eo = vViewTangent;
  eo = gl_FrontFacing ? eo : -eo;
  eo.xyz = normalize(eo.xyz);
  vec3 ep = normalize(cross(em, eo.xyz)) * eo.w;
  en = bn(normalMapFactor, eh, eo.xyz, ep, em);
#endif
bK = ssr(bK, ed * ek, ef, en, -normalize(vViewVertex.xyz));
#endif
bK *= environmentExposure * ek;
  vec3 eq, er;
  vec3 es = vModelNormal;
  vec3 et = -light0_viewDirection;
  float eu = dot(et, ei);
  bO(ei, ch, eu, max(.045, ef), ec, ed, light0_diffuse.rgb, et, ee, er, eq);
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
float ev = shadow_computeShadow();
  er = shadow_blend(er, ev).rgb;
  eq = shadow_blend(eq, ev).rgb;
#endif
bP += er;
  bK += eq;
  bP += eg;
  vec3 ew = bK + bP;
  if(outputSRGB == 1)
    ew = linearTosRGB(ew);
  
#ifdef HAS_SKIN_MAP
vec4 ex = bi();
  ew.rgb = ew.rgb * (1. - ex.a) + ex.rgb * ex.a;
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
ew.rgb = shadow_blend(ew.rgb, ev).rgb;
#endif
#endif
float ey = be();
  glFragColor = vec4(ew * ey, ey);
  if(glFragColor.a < alphaTest) {
    discard;
  }
#ifdef HAS_VERTEX_COLOR
glFragColor *= vertexColor_get();
#endif
#ifdef HAS_EXCAVATE_ANALYSIS
glFragColor = excavateColor(glFragColor);
#endif
#ifdef HAS_HEATMAP
glFragColor = heatmap_getColor(glFragColor);
#endif
#ifdef HAS_SNOW
glFragColor.rgb = snow(glFragColor, bj(), 1.);
#endif
if(contrast != 1.) {
    glFragColor = contrastMatrix(contrast) * glFragColor;
  }
  if(length(hsv) > .0) {
    glFragColor = hsv_apply(glFragColor, hsv);
  }
#ifdef OUTPUT_NORMAL
glFragColor = vec4(ce, 1.);
#endif
glFragColor = highlight_blendColor(glFragColor);
#ifdef HAS_LAYER_OPACITY
glFragColor *= layerOpacity;
#endif
#ifdef HAS_MASK_EXTENT
glFragColor = setMask(glFragColor);
#endif
#if __VERSION__ == 100
gl_FragColor = glFragColor;
#endif
}`,uniforms:h,extraCommandProps:t,defines:n}),this.version=300}getGeometryDefines(r){const t={};return r.data[r.desc.tangentAttribute]?t.HAS_TANGENT=1:r.data[r.desc.normalAttribute]&&(t.HAS_NORMAL=1),r.data[r.desc.colorAttribute]&&(t.HAS_COLOR=1),r.data[r.desc.color0Attribute]&&(t.HAS_COLOR0=1,t.COLOR0_SIZE=r.getColor0Size()),t}},StandardDepthShader:class extends Ye{constructor(r={}){const t=[];super({vert:`#define SHADER_NAME depth_vert
precision highp float;
attribute vec3 aPosition;
#include <line_extrusion_vert>
uniform mat4 modelViewMatrix;
uniform mat4 positionMatrix;
uniform mat4 projMatrix;
uniform vec2 outSize;
uniform vec2 halton;
#include <get_output>
void main() {
  mat4 c = getPositionMatrix();
#ifdef IS_LINE_EXTRUSION
vec4 d = getPosition(getLineExtrudePosition(aPosition));
#else
vec4 d = getPosition(aPosition);
#endif
vec4 e = modelViewMatrix * c * d;
  mat4 f = projMatrix;
  f[2].xy += halton.xy / outSize.xy;
  gl_Position = f * e;
}`,frag:`#define SHADER_NAME depth_frag
precision highp float;
void main() {
  gl_FragColor = vec4(1., .0, .0, 1.);
}`,uniforms:[{name:"modelViewMatrix",type:"function",fn:(e,n)=>qt(t,n.viewMatrix,n.modelMatrix)}],extraCommandProps:r.extraCommandProps,defines:r.defines})}},PBRUtils:SF};var CA=Array.isArray,PA=Object.keys,$F=Object.prototype.hasOwnProperty,WF=function r(t,e){if(t===e)return!0;if(t&&e&&typeof t=="object"&&typeof e=="object"){var n=CA(t),i=CA(e),o,s,a;if(n&&i){if(s=t.length,s!=e.length)return!1;for(o=s;o--!==0;)if(!r(t[o],e[o]))return!1;return!0}if(n!=i)return!1;var l=t instanceof Date,h=e instanceof Date;if(l!=h)return!1;if(l&&h)return t.getTime()==e.getTime();var u=t instanceof RegExp,c=e instanceof RegExp;if(u!=c)return!1;if(u&&c)return t.toString()==e.toString();var f=PA(t);if(s=f.length,s!==PA(e).length)return!1;for(o=s;o--!==0;)if(!$F.call(e,f[o]))return!1;for(o=s;o--!==0;)if(a=f[o],!r(t[a],e[a]))return!1;return!0}return t!==t&&e!==e};const su=Us(WF);/*!
 * @maptalks/fusiongl v0.6.13
 * LICENSE : UNLICENSED
 * (c) 2016-2024 maptalks.com
 */function ZF(r){for(let t=1;t<arguments.length;t++){const e=arguments[t];for(const n in e)r[n]=e[n]}return r}function hs(r,...t){for(let e=0;e<t.length;e++)ZF(r,t[e])}class XF{constructor(t){this.context=t,this.COLOR_ATTACHMENT0_WEBGL=36064,this.COLOR_ATTACHMENT1_WEBGL=36065,this.COLOR_ATTACHMENT2_WEBGL=36066,this.COLOR_ATTACHMENT3_WEBGL=36067,this.COLOR_ATTACHMENT4_WEBGL=36068,this.COLOR_ATTACHMENT5_WEBGL=36069,this.COLOR_ATTACHMENT6_WEBGL=36070,this.COLOR_ATTACHMENT7_WEBGL=36071,this.COLOR_ATTACHMENT8_WEBGL=36072,this.COLOR_ATTACHMENT9_WEBGL=36073,this.COLOR_ATTACHMENT10_WEBGL=577040,this.COLOR_ATTACHMENT11_WEBGL=577041,this.COLOR_ATTACHMENT12_WEBGL=577042,this.COLOR_ATTACHMENT13_WEBGL=577043,this.COLOR_ATTACHMENT14_WEBGL=577044,this.COLOR_ATTACHMENT15_WEBGL=577045,this.DRAW_BUFFER0_WEBGL=34853,this.DRAW_BUFFER1_WEBGL=34854,this.DRAW_BUFFER2_WEBGL=34855,this.DRAW_BUFFER3_WEBGL=34856,this.DRAW_BUFFER4_WEBGL=34857,this.DRAW_BUFFER5_WEBGL=34858,this.DRAW_BUFFER6_WEBGL=34859,this.DRAW_BUFFER7_WEBGL=34860,this.DRAW_BUFFER8_WEBGL=34861,this.DRAW_BUFFER9_WEBGL=34862,this.DRAW_BUFFER10_WEBGL=34863,this.DRAW_BUFFER11_WEBGL=34864,this.DRAW_BUFFER12_WEBGL=34865,this.DRAW_BUFFER13_WEBGL=34866,this.DRAW_BUFFER14_WEBGL=34867,this.DRAW_BUFFER15_WEBGL=34868,this.MAX_COLOR_ATTACHMENTS_WEBGL=36063,this.MAX_DRAW_BUFFERS_WEBGL=2178}drawBuffersWEBGL(){return this.context.drawBuffers.apply(this.context,arguments)}}class YF{constructor(t){this.context=t,this.VERTEX_ARRAY_BINDING_OES=34229}createVertexArrayOES(){return this.context.createVertexArray()}deleteVertexArrayOES(){return this.context.deleteVertexArray.apply(this.context,arguments)}isVertexArrayOES(){return this.context.isVertexArray.apply(this.context,arguments)}bindVertexArrayOES(){return this.context.bindVertexArray.apply(this.context,arguments)}}class qF{constructor(t){this.context=t,this.VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE=35070}drawArraysInstancedANGLE(){return this.context.drawArraysInstanced.apply(this.context,arguments)}drawElementsInstancedANGLE(){return this.context.drawElementsInstanced.apply(this.context,arguments)}vertexAttribDivisorANGLE(){return this.context.vertexAttribDivisor.apply(this.context,arguments)}}const S0={webgl_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},oes_element_index_uint:{},oes_texture_float:{},oes_texture_half_float:{HALF_FLOAT_OES:36193},ext_color_buffer_float:{},oes_standard_derivatives:{},ext_frag_depth:{},ext_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},ext_shader_texture_lod:{}},au={has(r,t){const e=r.t,n=r.i;return!(!e&&!n.getExtension(t))&&(t=t.toLowerCase(),e&&S0[t]||t==="webgl_draw_buffers"||t==="oes_vertex_array_object"||t==="angle_instanced_arrays")},mock:(r,t)=>(t=t.toLowerCase(),S0[t]?r.t?(t!=="oes_texture_float"&&t!=="oes_texture_half_float"||r.i.getExtension("EXT_color_buffer_float"),S0[t]):r.i.getExtension(t):t==="webgl_draw_buffers"?new XF(r):t==="oes_vertex_array_object"?new YF(r):t==="angle_instanced_arrays"?new qF(r):null),getInternalFormat:(r,t,e)=>t===6402?33190:t===34041?35056:e===36193&&t===r.RGBA?34842:e===36193&&t===r.RGB?34843:e===r.FLOAT&&t===r.RGBA?34836:e===r.FLOAT&&t===r.RGB?34837:t,getTextureType:(r,t)=>t===36193?r.HALF_FLOAT:t};let JF=1;class Fo{constructor(t){this.uid=JF++,this.states=function(n){return{scissor:[0,0,n.canvas.width,n.canvas.height],viewport:[0,0,n.canvas.width,n.canvas.height],blendColor:[0,0,0,0],blendEquationSeparate:[n.FUNC_ADD,n.FUNC_ADD],blendFuncSeparate:[n.ONE,n.ZERO,n.ONE,n.ZERO],clearColor:[0,0,0,0],clearDepth:[1],clearStencil:[0],colorMask:[!0,!0,!0,!0],cullFace:[n.BACK],depthFunc:[n.LESS],depthMask:[!0],depthRange:[0,1],capabilities:{3042:!1,2884:!1,2929:!1,3024:!1,32823:!1,32926:!1,32928:!1,3089:!1,2960:!1},frontFace:[n.CCW],hint:{33170:[n.DONT_CARE],35723:[n.DONT_CARE]},lineWidth:[1],pixelStorei:{3333:[4],3317:[4],37440:[!1],37441:[!1],37443:[n.BROWSER_DEFAULT_WEBGL]},polygonOffset:[0,0],sampleCoverage:[1,!1],stencilFuncSeparate:{1028:[n.ALWAYS,0,4294967295],1029:[n.ALWAYS,0,4294967295]},stencilMaskSeparate:{1028:[4294967295],1029:[4294967295]},stencilOpSeparate:{1028:[n.KEEP,n.KEEP,n.KEEP],1029:[n.KEEP,n.KEEP,n.KEEP]},program:null,framebuffer:{36160:null,36008:null,36009:null},renderbuffer:{36161:null},textures:{active:-1,units:function(){const i=[],o=n.getParameter(n.MAX_COMBINED_TEXTURE_IMAGE_UNITS);for(let s=0;s<o;s++)i.push({3553:null,34067:null});return i[-1]={3553:null,34067:null},i}()},attributes:{},arrayBuffer:null,elementArrayBuffer:null}}(t),this.i=t,this.i._fusiongl_drawCalls=0,this.t=window.WebGL2RenderingContext!==void 0&&this.i instanceof window.WebGL2RenderingContext;const e=Object.getPrototypeOf(this);this.t?Object.setPrototypeOf(e,window.WebGL2RenderingContext.prototype):Object.setPrototypeOf(e,WebGLRenderingContext.prototype),this.s=t.getParameter(t.MAX_VERTEX_ATTRIBS)}get canvas(){return this.i.canvas}get drawingBufferWidth(){return this.i.drawingBufferWidth}get drawingBufferHeight(){return this.i.drawingBufferHeight}get gl(){return this.i}get buffersOES(){return this.h||(this.h=this.i.getExtension("WEBGL_draw_buffers")),this.h}get vaoOES(){return this.u||(this.u=this.i.getExtension("OES_vertex_array_object")),this.u}get angleOES(){return this.o||(this.o=this.i.getExtension("ANGLE_instanced_arrays")),this.o}get standOES(){return this.l||(this.l=this.i.getExtension("OES_standard_derivatives")),this.l}attachShader(t,e){return this.i.attachShader(t,e)}shaderSource(t,e){return this.i.shaderSource(t,e)}compileShader(t){return this.i.compileShader(t)}createShader(t){return this.i.createShader(t)}createProgram(){return this.i.createProgram()}deleteProgram(t){return this.states.program===t&&(this.states.program=null),this.i.deleteProgram(t)}deleteShader(t){return this.i.deleteShader(t)}detachShader(t,e){return this.i.detachShader(t,e)}getAttachedShaders(t){return this.i.getAttachedShaders(t)}linkProgram(t){return this.i.linkProgram(t)}makeXRCompatible(){return this.i.makeXRCompatible()}getShaderParameter(t,e){return this.i.getShaderParameter(t,e)}getShaderPrecisionFormat(t,e){return this.i.getShaderPrecisionFormat(t,e)}getShaderInfoLog(t){return this.i.getShaderInfoLog(t)}getShaderSource(t){return this.i.getShaderSource(t)}getProgramInfoLog(t){return this.i.getProgramInfoLog(t)}getProgramParameter(t,e){return this.i.getProgramParameter(t,e)}getError(){return this.i.getError()}getContextAttributes(){return this.i.getContextAttributes()}getExtension(t){return au.has(this,t)?au.mock(this,t):this.i.getExtension(t)}getSupportedExtensions(){return this.i.getSupportedExtensions()}getParameter(t){return this.i.getParameter(t)}isEnabled(t){return this.i.isEnabled(t)}isProgram(t){return this.i.isProgram(t)}isShader(t){return this.i.isShader(t)}validateProgram(t){return this.i.validateProgram(t)}clear(t){return this.m(),this.i.clear(t)}drawArrays(t,e,n){return this.m(),this.g(),this.i.drawArrays(t,e,n)}drawElements(t,e,n,i){return this.m(),this.g(),this.i.drawElements(t,e,n,i)}drawBuffers(t){return this.m(),this.g(),this.t?this.i.drawBuffers(t):this.buffersOES.drawBuffersWEBGL(t)}g(){this.i._fusiongl_drawCalls++}resetDrawCalls(){this.i._fusiongl_drawCalls=0}getDrawCalls(){return this.i._fusiongl_drawCalls}v(){const t=this.i,e=t.getParameter(t.CURRENT_PROGRAM),n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),i=[];for(let o=0;o<n;o++)i.push(t.getVertexAttrib(o,t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING));this._={buffers:i,elements:t.getParameter(t.ELEMENT_ARRAY_BUFFER_BINDING),framebuffer:t.getParameter(t.FRAMEBUFFER_BINDING)},window.DEBUGGING&&(console.log(this.uid,this._),console.log(this.uid,this.states.attributes),console.log(this.states.attributes[0].buffer===this._.buffers[0]),console.log(this.states.attributes[1].buffer===this._.buffers[1]),console.log(this.states.attributes[2].buffer===this._.buffers[2]))}finish(){return this.i.finish()}flush(){return this.m(),this.i.flush()}commit(){return this.m(),this.i.commit()}isContextLost(){return this.i.isContextLost()}getFragDataLocation(t,e){return this.i.getFragDataLocation(t,e)}createSampler(){return this.i.createSampler()}deleteSampler(){return this.i.deleteSampler()}bindSampler(){return this.i.bindSampler()}isSampler(){return this.i.isSampler()}getSamplerParameter(){return this.i.getSamplerParameter()}isQuery(t){return this.i.beginQuery(t)}beginQuery(t,e){return this.i.beginQuery(t,e)}deleteQuery(t){return this.i.query(t)}isTransformFeedback(t){return this.i.isTransformFeedback(t)}beginTransformFeedback(t){return this.i.beginTransformFeedback(t)}deleteTransformFeedback(t){return this.i.deleteTransformFeedback(t)}pauseTransformFeedback(){return this.i.pauseTransformFeedback()}resumeTransformFeedback(){return this.i.resumeTransformFeedback()}transformFeedbackVaryings(t,e,n){return this.i.transformFeedbackVaryings(t,e,n)}bindBufferBase(t,e,n){return this.i.bbindBufferBase(t,e,n)}bindBufferRange(t,e,n,i,o){return this.i.bindBufferRange(t,e,n,i,o)}bindTransformFeedback(t,e){return this.i.bindTransformFeedback(t,e)}fenceSync(t,e){return this.i.fenceSync(t,e)}isSync(t){return this.i.isSync(t)}deleteSync(t){return this.i.deleteSync(t)}clientWaitSync(t,e,n){return this.i.clientWaitSync(t,e,n)}waitSync(t,e,n){return this.i.waitSync(t,e,n)}getSyncParameter(t,e){return this.i.getSyncParameter(t,e)}getIndexedParameter(t,e){return this.i.getIndexedParameter(t,e)}}hs(Fo.prototype,{bufferData(...r){return this.m(),this.i.bufferData(...r)},bufferSubData(...r){return this.m(),this.i.bufferSubData(...r)},createBuffer(){return this.i.createBuffer()},deleteBuffer(r){const t=this.states;t.arrayBuffer===r?t.arrayBuffer=null:t.elementArrayBuffer===r&&(t.elementArrayBuffer=null);const e=t.attributes;for(const n in e)e[n].buffer===r&&(e[n].buffer=null);return this.i.deleteBuffer(r)},getBufferParameter(r,t){return this.m(),this.i.getBufferParameter(r,t)},isBuffer(r){return this.i.isBuffer(r)},copyBufferSubData(r,t,e,n,i){return this.i.isBuffer(r,t,e,n,i)},readBuffer(r){return this.i.readBuffer(r)}}),hs(Fo.prototype,{checkFramebufferStatus(r){return this.i.checkFramebufferStatus(r)},createFramebuffer(){return this.i.createFramebuffer()},deleteFramebuffer(r){const t=this.states.framebuffer;for(const e in t)t[e]===r&&(t[e]=null);return this.i.deleteFramebuffer(r)},framebufferRenderbuffer(r,t,e,n){return this.m(),this.i.framebufferRenderbuffer(r,t,e,n)},framebufferTexture2D(r,t,e,n,i){return this.m(),this.i.framebufferTexture2D(r,t,e,n,i)},getFramebufferAttachmentParameter(r,t,e){return this.m(),this.i.getFramebufferAttachmentParameter(r,t,e)},isFramebuffer(r){return this.i.isFramebuffer(r)},readPixels(r,t,e,n,i,o,s){return this.m(),this.i.readPixels(r,t,e,n,i,o,s)},blitFramebuffer(r,t,e,n,i,o,s,a,l,h){return this.m(),this.i.blitFramebuffer(r,t,e,n,i,o,s,a,l,h)}}),hs(Fo.prototype,{createRenderbuffer(){return this.i.createRenderbuffer()},deleteRenderbuffer(r){const t=this.states.renderbuffer;for(const e in t)t[e]===r&&(t[e]=null);return this.i.deleteRenderbuffer(r)},getRenderbufferParameter(r,t){return this.m(),this.i.getRenderbufferParameter(r,t)},isRenderbuffer(r){return this.i.isRenderbuffer(r)},renderbufferStorage(r,t,e,n){return this.m(),this.i.renderbufferStorage(r,t,e,n)},renderbufferStorageMultisample(r,t,e,n,i){return this.m(),this.i.renderbufferStorageMultisample(r,t,e,n,i)}});function KF(r,t){const e=t.length;for(let n=0;n<e;n++)r[n]=t[n];return r}hs(Fo.prototype,{scissor(r,t,e,n){this.m();const i=this.states.scissor;i[0]===r&&i[1]===t&&i[2]===e&&i[3]===n||(i[0]=r,i[1]=t,i[2]=e,i[3]=n,this.i.scissor(r,t,e,n))},viewport(r,t,e,n){this.m();const i=this.states.viewport;i[0]===r&&i[1]===t&&i[2]===e&&i[3]===n||(i[0]=r,i[1]=t,i[2]=e,i[3]=n,this.i.viewport(r,t,e,n))},blendColor(r,t,e,n){this.m();const i=this.states.blendColor;i[0]===r&&i[1]===t&&i[2]===e&&i[3]===n||(i[0]=r,i[1]=t,i[2]=e,i[3]=n,this.i.blendColor(r,t,e,n))},blendEquation(r){this.m();const t=this.states.blendEquationSeparate;t[0]===r&&t[1]===r||(t[0]=r,t[1]=r,this.i.blendEquation(r))},blendEquationSeparate(r,t){this.m();const e=this.states.blendEquationSeparate;e[0]===r&&e[1]===t||(e[0]=r,e[1]=t,this.i.blendEquationSeparate(r,t))},blendFunc(r,t){this.m();const e=this.states.blendFuncSeparate;e[0]===r&&e[2]===r&&e[1]===t&&e[3]===t||(e[0]=r,e[1]=t,e[2]=r,e[3]=t,this.i.blendFunc(r,t))},blendFuncSeparate(r,t,e,n){this.m();const i=this.states.blendFuncSeparate;i[0]===r&&i[1]===t&&i[2]===e&&i[3]===n||(i[0]=r,i[1]=t,i[2]=e,i[3]=n,this.i.blendFuncSeparate(r,t,e,n))},clearColor(r,t,e,n){this.m();const i=this.states.clearColor;i[0]===r&&i[1]===t&&i[2]===e&&i[3]===n||(i[0]=r,i[1]=t,i[2]=e,i[3]=n,this.i.clearColor(r,t,e,n))},clearDepth(r){this.m();const t=this.states.clearDepth;t[0]!==r&&(t[0]=r,this.i.clearDepth(r))},clearStencil(r){this.m();const t=this.states.clearStencil;t[0]!==r&&(t[0]=r,this.i.clearStencil(r))},colorMask(r,t,e,n){this.m();const i=this.states.colorMask;i[0]===r&&i[1]===t&&i[2]===e&&i[3]===n||(i[0]=r,i[1]=t,i[2]=e,i[3]=n,this.i.colorMask(r,t,e,n))},cullFace(r){this.m();const t=this.states.cullFace;t[0]!==r&&(t[0]=r,this.i.cullFace(r))},depthFunc(r){this.m();const t=this.states.depthFunc;t[0]!==r&&(t[0]=r,this.i.depthFunc(r))},depthMask(r){this.m();const t=this.states.depthMask;t[0]!==r&&(t[0]=r,this.i.depthMask(r))},depthRange(r,t){this.m();const e=this.states.depthRange;e[0]===r&&e[1]===t||(e[0]=r,e[1]=t,this.i.depthRange(r,t))},disable(r){this.m();const t=this.states.capabilities;t[r]&&(t[r]=!1,this.i.disable(r))},enable(r){this.m();const t=this.states.capabilities;t[r]||(t[r]=!0,this.i.enable(r))},frontFace(r){this.m();const t=this.states.frontFace;t[0]!==r&&(t[0]=r,this.i.frontFace(r))},hint(r,t){this.m();const e=this.states.hint;e[r][0]!==t&&(e[r][0]=t,this.i.hint(r,t))},lineWidth(r){this.m();const t=this.states.lineWidth;t[0]!==r&&(t[0]=r,this.i.lineWidth(r))},pixelStorei(r,t){this.m();const e=this.states.pixelStorei;e[r]!==t&&(e[r]&&(e[r][0]=t),this.i.pixelStorei(r,t))},polygonOffset(r,t){this.m();const e=this.states.polygonOffset;e[0]===r&&e[1]===t||(e[0]=r,e[1]=t,this.i.polygonOffset(r,t))},sampleCoverage(r,t){this.m();const e=this.states.sampleCoverage;e[0]===r&&e[1]===t||(e[0]=r,e[1]=t,this.i.sampleCoverage(r,t))},stencilFunc(r,t,e){this.m();const n=this.states.stencilFuncSeparate,i=this.i;n[i.FRONT][0]===r&&n[i.FRONT][1]===t&&n[i.FRONT][2]===e&&n[i.BACK][0]===r&&n[i.BACK][1]===t&&n[i.BACK][2]===e||(n[i.FRONT][0]=n[i.BACK][0]=r,n[i.FRONT][1]=n[i.BACK][1]=t,n[i.FRONT][2]=n[i.BACK][2]=e,this.i.stencilFunc(r,t,e))},stencilFuncSeparate(r,t,e,n){if(this.m(),r===this.i.FRONT_AND_BACK)return void this.stencilFunc(t,e,n);const i=this.states.stencilFuncSeparate;i[r][0]===t&&i[r][1]===e&&i[r][2]===n||(i[r][0]=t,i[r][1]=e,i[r][2]=n,this.i.stencilFuncSeparate(r,t,e,n))},stencilMask(r){this.m();const t=this.i,e=this.states.stencilMaskSeparate;e[t.FRONT][0]===r&&e[t.BACK][0]===r||(e[t.FRONT][0]=r,e[t.BACK][0]=r,this.i.stencilMask(r))},stencilMaskSeparate(r,t){if(this.m(),r===this.i.FRONT_AND_BACK)return void this.stencilMask(t);const e=this.states.stencilMaskSeparate;e[r][0]!==t&&(e[r][0]=t,this.i.stencilMaskSeparate(r,t))},stencilOp(r,t,e){this.m();const n=this.states.stencilOpSeparate,i=this.i;n[i.FRONT][0]===r&&n[i.FRONT][1]===t&&n[i.FRONT][2]===e&&n[i.BACK][0]===r&&n[i.BACK][1]===t&&n[i.BACK][2]===e||(n[i.FRONT][0]=n[i.BACK][0]=r,n[i.FRONT][1]=n[i.BACK][1]=t,n[i.FRONT][2]=n[i.BACK][2]=e,this.i.stencilOp(r,t,e))},stencilOpSeparate(r,t,e,n){if(this.m(),r===this.i.FRONT_AND_BACK)return void this.stencilOp(t,e,n);const i=this.states.stencilOpSeparate;i[r][0]===t&&i[r][1]===e&&i[r][2]===n||(i[r][0]=t,i[r][1]=e,i[r][2]=n,this.i.stencilOpSeparate(r,t,e,n))},bindFramebuffer(r,t){this.m();const e=this.states.framebuffer;e[r]!==t&&(e[r]=t,this.i.bindFramebuffer(r,t))},bindRenderbuffer(r,t){this.m();const e=this.states.renderbuffer;e[r]!==t&&(e[r]=t,this.i.bindRenderbuffer(r,t))},bindTexture(r,t){this.m();const e=this.states.textures,n=e.active!==-1?e.active-33984:-1;e.units[n][r]=t,this.i.bindTexture(r,t)},activeTexture(r){this.m();const t=this.i,e=this.states.textures,n=e.active;e.active=r,this.activeUnit!==r&&(t.activeTexture(r),this.activeUnit=r),n===-1&&(e.units[r-33984][t.TEXTURE_2D]=e.units[-1][t.TEXTURE_2D],e.units[r-33984][t.TEXTURE_CUBE_MAP]=e.units[-1][t.TEXTURE_CUBE_MAP],e.units[-1][t.TEXTURE_2D]=null,e.units[-1][t.TEXTURE_CUBE_MAP]=null)},useProgram(r){this.m();const t=this.states;t.program!==r&&(this.states.activeAttribType=0,t.program=r,r.fid===void 0&&(r.fid=0),this.S(),this.i.useProgram(r))},S(){const r=this.states.program;if(!r)return;const t=r.cachedUniforms=r.cachedUniforms||{};for(const e in t)Array.isArray(t[e])?t[e].fill(null):t[e]=null},bindBuffer(r,t){this.m();const e=this.i,n=this.states;r===e.ELEMENT_ARRAY_BUFFER?n.elementArrayBuffer=t:n.arrayBuffer=t,e.bindBuffer(r,t)},bindVertexArray(r){this.m(),this.states.activeAttribType=1;const t=this.i,e=this.states;e.vao!==r&&(e.vao=r,this.t?t.bindVertexArray(r):this.vaoOES.bindVertexArrayOES(r))},vertexAttribPointer(r,t,e,n,i,o){this.m(),this.states.attributes[r]||(this.states.attributes[r]={enable:!0});const s=this.states.attributes[r];return s.buffer=this.states.arrayBuffer,s.args?(s.args[0]=r,s.args[1]=t,s.args[2]=e,s.args[3]=n,s.args[4]=i,s.args[5]=o):s.args=[r,t,e,n,i,o],this.i.vertexAttribPointer(r,t,e,n,i,o)},vertexAttribDivisor(r,t){return this.m(),this.states.attributes[r].divisor=t,this.t?this.i.vertexAttribDivisor(r,t):this.angleOES.vertexAttribDivisorANGLE(r,t)}},{m(){const r=this.i;if(r.A!==this)if(r.A){const t=r.A;this.p(t.states),r.A=this}else r.A=this},p(r){if(!r)return;delete this.activeUnit;const t=this.states,e=this.i;let n=0;for(const u in t)if(u!=="capabilities"&&u!=="textures"&&u!=="attributes"&&u!=="arrayBuffer"&&u!=="elementArrayBuffer"&&u!=="vao"){if(u==="program")t.program!==r.program&&(e.useProgram(t.program),t.program&&(n=e.getProgramParameter(t.program,e.ACTIVE_ATTRIBUTES)));else if(u==="framebuffer")for(const c in t[u])t[u][c]!==r[u][c]&&e.bindFramebuffer(+c,t[u][c]);else if(u==="renderbuffer")for(const c in t[u])t[u][c]!==r[u][c]&&e.bindRenderbuffer(+c,t[u][c]);else if(!su(t[u],r[u])){if(Array.isArray(r[u]))e[u](...t[u]);else if(r[u])for(const c in t[u])su(t[u][c],r[u][c])||e[u](+c,...t[u][c])}}this.S();for(const u in t.capabilities)t.capabilities[u]!==r.capabilities[u]&&e[t.capabilities[u]?"enable":"disable"](+u);const i=t.textures,o=r.textures,s=i.units,a=o.units,l=i.active-e.TEXTURE0;for(let u=0;u<s.length;u++)u===l||s[u][e.TEXTURE_2D]===a[u][e.TEXTURE_2D]&&s[u][e.TEXTURE_CUBE_MAP]===a[u][e.TEXTURE_CUBE_MAP]||(e.activeTexture(e.TEXTURE0+u),e.bindTexture(e.TEXTURE_2D,s[u][e.TEXTURE_2D]),e.bindTexture(e.TEXTURE_CUBE_MAP,s[u][e.TEXTURE_CUBE_MAP]));if(i.active>-1){const u=s[l];u[e.TEXTURE_2D]===a[l][e.TEXTURE_2D]&&u[e.TEXTURE_CUBE_MAP]===a[l][e.TEXTURE_CUBE_MAP]||(e.activeTexture(i.active),e.bindTexture(e.TEXTURE_2D,u[e.TEXTURE_2D]),e.bindTexture(e.TEXTURE_CUBE_MAP,u[e.TEXTURE_CUBE_MAP]))}this.t?e.bindVertexArray(null):this.u&&this.u.bindVertexArrayOES(null);const h=this.s;if(this.t||this.angleOES)for(let u=0;u<h;u++)this.t?e.vertexAttribDivisor(u,0):this.angleOES.vertexAttribDivisorANGLE(u,0);e.bindBuffer(e.ARRAY_BUFFER,t.arrayBuffer),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.elementArrayBuffer),t.activeAttribType===1?this.F(t,e):this.L(t,e,n)},F(r,t){const e=r.vao;e&&(this.t?t.bindVertexArray(e||null):this.u&&this.u.bindVertexArrayOES(e||null))},L(r,t,e){const n=this.s,i=r.attributes;let o=0;for(let s=0;s<n;s++){const a=i[s];if(o<e&&a){if(a.buffer){if(t.bindBuffer(t.ARRAY_BUFFER,a.buffer),t.vertexAttribPointer(...a.args),a.divisor&&(this.t?t.vertexAttribDivisor(s,a.divisor):this.angleOES.vertexAttribDivisorANGLE(s,a.divisor)),a.enable){t.enableVertexAttribArray(s),o++;continue}t.disableVertexAttribArray(s)}t.disableVertexAttribArray(s)}else t.disableVertexAttribArray(s)}}}),hs(Fo.prototype,{compressedTexImage2D(r,t,e,n,i,o,s){return this.m(),this.i.compressedTexImage2D(r,t,e,n,i,o,s)},copyTexImage2D(r,t,e,n,i,o,s,a){return this.m(),this.i.copyTexImage2D(r,t,e,n,i,o,s,a)},copyTexSubImage2D(r,t,e,n,i,o,s,a){return this.m(),this.i.copyTexSubImage2D(r,t,e,n,i,o,s,a)},createTexture(){return this.i.createTexture()},deleteTexture(r){const t=this.states.textures.units;for(let e=0;e<t.length;e++)for(const n in t[e])t[e][n]===r&&(t[e][n]=null);return this.i.deleteTexture(r)},generateMipmap(r){return this.m(),this.i.generateMipmap(r)},getTexParameter(r,t){return this.m(),this.i.getTexParameter(r,t)},isTexture(r){return this.i.isTexture(r)},texImage2D(...r){if(this.m(),this.t){const t=r[r.length-2],e=au.getInternalFormat(this.i,r[2],t);e!==r[2]&&(r[2]=e);const n=au.getTextureType(this.i,t);n!==t&&(r[r.length-2]=n)}return this.i.texImage2D(...r)},texSubImage2D(...r){if(this.m(),this.t){const t=r[r.length-2],e=au.getTextureType(this.i,t);e!==t&&(r[r.length-2]=e)}return this.i.texSubImage2D(...r)},texParameterf(r,t,e){return this.m(),this.i.texParameterf(r,t,e)},texParameteri(r,t,e){return this.m(),this.i.texParameteri(r,t,e)},texStorage2D(r,t,e,n,i){return this.m(),this.i.texStorage2D(r,t,e,n,i)},texImage3D(r,t,e,n,i,o,s,a,l,h){return this.m(),this.i.texImage3D(r,t,e,n,i,o,s,a,l,h)},texStorage3D(r,t,e,n,i,o){return this.m(),this.i.texStorage3D(r,t,e,n,i,o)},texSubImage3D(r,t,e,n,i,o,s,a,l,h,u){return this.m(),this.i.texSubImage3D(r,t,e,n,i,o,s,a,l,h,u)},copyTexSubImage3D(r,t,e,n,i,o,s,a,l){return this.m(),this.i.copyTexSubImage3D(r,t,e,n,i,o,s,a,l)},compressedTexSubImage3D(r,t,e,n,i,o,s,a,l,h,u){return this.m(),this.i.compressedTexSubImage3D(r,t,e,n,i,o,s,a,l,h,u)}}),hs(Fo.prototype,{bindAttribLocation(r,t,e){return this.i.bindAttribLocation(r,t,e)},enableVertexAttribArray(r){return this.m(),this.states.attributes[r]||(this.states.attributes[r]={}),this.states.attributes[r].enable=!0,this.i.enableVertexAttribArray(r)},disableVertexAttribArray(r){return this.m(),this.states.attributes[r]||(this.states.attributes[r]={}),this.states.attributes[r].enable=!1,this.i.disableVertexAttribArray(r)},getActiveAttrib(r,t){return this.i.getActiveAttrib(r,t)},getActiveUniform(r,t){return this.i.getActiveUniform(r,t)},getAttribLocation(r,t){return this.i.getAttribLocation(r,t)},getUniformLocation(r,t){return this.i.getUniformLocation(r,t)},getVertexAttrib(r,t){return this.m(),this.i.getVertexAttrib(r,t)},getVertexAttribOffset(r,t){return this.m(),this.i.getVertexAttribOffset(r,t)},uniformBlockBinding(r,t,e){return this.m(),this.i.uniformBlockBinding(r,t,e)},D(r,...t){const e=this.states.program;if(!e)return!1;let n=r.fid;n===void 0&&(n=r.fid=e.fid++);const i=e.cachedUniforms[n];return!!function(o,s){if(!o)return!1;const a=s.length;for(let l=0;l<a;l++)if(o[l]&&o[l].length!==void 0){const h=o[l].length;for(let u=0;u<h;u++)if(o[l][u]!==s[l][u])return!1}else if(o[l]!==s[l])return!1;return!0}(i,t)||(e.cachedUniforms[n]=function(o,s){o=o||new Array(s.length);const a=s.length;for(let l=0;l<a;l++)o[l]=s[l].length!==void 0?KF(o[l]||[],s[l]):s[l];return o}(i,t),!1)},uniformMatrix2fv(r,t,e){this.D(r,t,e)||(this.m(),this.i.uniformMatrix2fv(r,t,e))},uniformMatrix3fv(r,t,e){this.D(r,t,e)||(this.m(),this.i.uniformMatrix3fv(r,t,e))},uniformMatrix4fv(r,t,e){this.D(r,t,e)||this.i.uniformMatrix4fv(r,t,e)},uniform1f(r,t){return this.m(),this.i.uniform1f(r,t)},uniform1i(r,t){return this.m(),this.i.uniform1i(r,t)},uniform2f(r,t,e){return this.m(),this.i.uniform2f(r,t,e)},uniform2i(r,t,e){return this.m(),this.i.uniform2i(r,t,e)},uniform3f(r,t,e,n){return this.m(),this.i.uniform3f(r,t,e,n)},uniform3i(r,t,e,n){return this.m(),this.i.uniform3i(r,t,e,n)},uniform4f(r,t,e,n,i){return this.m(),this.i.uniform4f(r,t,e,n,i)},uniform4i(r,t,e,n,i){return this.m(),this.i.uniform4i(r,t,e,n,i)},uniform1ui(r,t){return this.m(),this.i.uniform1ui(r,t)},uniform2ui(r,t,e){return this.m(),this.i.uniform2ui(r,t,e)},uniform3ui(r,t,e,n){return this.m(),this.i.uniform3ui(r,t,e,n)},uniform4ui(r,t,e,n,i){return this.m(),this.i.uniform4ui(r,t,e,n,i)},uniform1fv(r,t,e,n){this.m(),n!==void 0?this.i.uniform1fv(r,t,e,n):e!==void 0?this.i.uniform1fv(r,t,e):this.i.uniform1fv(r,t)},uniform2fv(r,t,e,n){this.m(),n!==void 0?this.i.uniform2fv(r,t,e,n):e!==void 0?this.i.uniform2fv(r,t,e):this.i.uniform2fv(r,t)},uniform3fv(r,t,e,n){this.m(),n!==void 0?this.i.uniform3fv(r,t,e,n):e!==void 0?this.i.uniform3fv(r,t,e):this.i.uniform3fv(r,t)},uniform4fv(r,t,e,n){this.m(),n!==void 0?this.i.uniform4fv(r,t,e,n):e!==void 0?this.i.uniform4fv(r,t,e):this.i.uniform4fv(r,t)},uniform1iv(r,t,e,n){this.m(),n!==void 0?this.i.uniform1iv(r,t,e,n):e!==void 0?this.i.uniform1iv(r,t,e):this.i.uniform1iv(r,t)},uniform2iv(r,t,e,n){this.m(),n!==void 0?this.i.uniform2iv(r,t,e,n):e!==void 0?this.i.uniform2iv(r,t,e):this.i.uniform2iv(r,t)},uniform3iv(r,t,e,n){this.m(),n!==void 0?this.i.uniform3iv(r,t,e,n):e!==void 0?this.i.uniform3iv(r,t,e):this.i.uniform3iv(r,t)},uniform4iv(r,t,e,n){this.m(),n!==void 0?this.i.uniform4iv(r,t,e,n):e!==void 0?this.i.uniform4iv(r,t,e):this.i.uniform4iv(r,t)},uniform1uiv(r,t,e,n){this.m(),n!==void 0?this.i.uniform1uiv(r,t,e,n):e!==void 0?this.i.uniform1uiv(r,t,e):this.i.uniform1uiv(r,t)},uniform2uiv(r,t,e,n){this.m(),n!==void 0?this.i.uniform2uiv(r,t,e,n):e!==void 0?this.i.uniform2uiv(r,t,e):this.i.uniform2uiv(r,t)},uniform3uiv(r,t,e,n){this.m(),n!==void 0?this.i.uniform3uiv(r,t,e,n):e!==void 0?this.i.uniform3uiv(r,t,e):this.i.uniform3uiv(r,t)},uniform4uiv(r,t,e,n){this.m(),n!==void 0?this.i.uniform4uiv(r,t,e,n):e!==void 0?this.i.uniform4uiv(r,t,e):this.i.uniform4uiv(r,t)},vertexAttrib1f(r,t){return this.m(),this.i.vertexAttrib1f(r,t)},vertexAttrib2f(r,t,e){return this.m(),this.i.vertexAttrib2f(r,t,e)},vertexAttrib3f(r,t,e,n){return this.m(),this.i.vertexAttrib3f(r,t,e,n)},vertexAttrib4f(r,t,e,n,i){return this.m(),this.i.vertexAttrib4f(r,t,e,n,i)},vertexAttrib1fv(r,t){return this.m(),this.i.vertexAttrib1fv(r,t)},vertexAttrib2fv(r,t){return this.m(),this.i.vertexAttrib2fv(r,t)},vertexAttrib3fv(r,t){return this.m(),this.i.vertexAttrib3fv(r,t)},vertexAttrib4fv(r,t){return this.m(),this.i.vertexAttrib4fv(r,t)},vertexAttribI4i(r,t,e,n,i){return this.m(),this.i.vertexAttribI4i(r,t,e,n,i)},vertexAttribI4ui(r,t,e,n,i){return this.m(),this.i.vertexAttribI4ui(r,t,e,n,i)},vertexAttribI4iv(r,t){return this.m(),this.i.vertexAttribI4iv(r,t)},vertexAttribI4uiv(r,t){return this.m(),this.i.vertexAttribI4uiv(r,t)}}),hs(Fo.prototype,{createVertexArray(){return this.t?this.i.createVertexArray():this.vaoOES.createVertexArrayOES()},deleteVertexArray(r){const t=this.states;return t.vao===r&&(t.vao=null),this.t?this.i.deleteVertexArray(r):this.vaoOES.deleteVertexArrayOES(r)},isVertexArray(r){return this.t?this.i.isVertexArray(r):this.vaoOES.isVertexArrayOES(r)}}),hs(Fo.prototype,{drawArraysInstanced(r,t,e,n){return this.m(),this.g(),this.t?this.i.drawArraysInstanced(r,t,e,n):this.angleOES.drawArraysInstancedANGLE(r,t,e,n)},drawElementsInstanced(r,t,e,n,i){return this.m(),this.g(),this.t?this.i.drawElementsInstanced(r,t,e,n,i):this.angleOES.drawElementsInstancedANGLE(r,t,e,n,i)}});/*!
 * @maptalks/gl v0.98.2
 * LICENSE : UNLICENSED
 * (c) 2016-2024 maptalks.com
 */function QF(r){return r&&r.t&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var EA={exports:{}},OA={exports:{}},tL=function(r){return!(!r||typeof r=="string")&&(r instanceof Array||Array.isArray(r)||r.length>=0&&(r.splice instanceof Function||Object.getOwnPropertyDescriptor(r,r.length-1)&&r.constructor.name!=="String"))},eL=Array.prototype.concat,nL=Array.prototype.slice,kA=OA.exports=function(r){for(var t=[],e=0,n=r.length;e<n;e++){var i=r[e];tL(i)?t=eL.call(t,nL.call(i)):t.push(i)}return t};kA.wrap=function(r){return function(){return r(kA(arguments))}};var rL=OA.exports,lu={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},hu=rL,IA=Object.hasOwnProperty,RA=Object.create(null);for(var C0 in lu)IA.call(lu,C0)&&(RA[lu[C0]]=C0);var pi=EA.exports={to:{},get:{}};function us(r,t,e){return Math.min(Math.max(t,r),e)}function Xf(r){var t=Math.round(r).toString(16).toUpperCase();return t.length<2?"0"+t:t}pi.get=function(r){var t,e;switch(r.substring(0,3).toLowerCase()){case"hsl":t=pi.get.hsl(r),e="hsl";break;case"hwb":t=pi.get.hwb(r),e="hwb";break;default:t=pi.get.rgb(r),e="rgb"}return t?{model:e,value:t}:null},pi.get.rgb=function(r){if(!r)return null;var t,e,n,i=[0,0,0,1];if(t=r.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(n=t[2],t=t[1],e=0;e<3;e++){var o=2*e;i[e]=parseInt(t.slice(o,o+2),16)}n&&(i[3]=parseInt(n,16)/255)}else if(t=r.match(/^#([a-f0-9]{3,4})$/i)){for(n=(t=t[1])[3],e=0;e<3;e++)i[e]=parseInt(t[e]+t[e],16);n&&(i[3]=parseInt(n+n,16)/255)}else if(t=r.match(/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)){for(e=0;e<3;e++)i[e]=parseInt(t[e+1],0);t[4]&&(t[5]?i[3]=.01*parseFloat(t[4]):i[3]=parseFloat(t[4]))}else{if(!(t=r.match(/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)))return(t=r.match(/^(\w+)$/))?t[1]==="transparent"?[0,0,0,0]:IA.call(lu,t[1])?((i=lu[t[1]])[3]=1,i):null:null;for(e=0;e<3;e++)i[e]=Math.round(2.55*parseFloat(t[e+1]));t[4]&&(t[5]?i[3]=.01*parseFloat(t[4]):i[3]=parseFloat(t[4]))}for(e=0;e<3;e++)i[e]=us(i[e],0,255);return i[3]=us(i[3],0,1),i},pi.get.hsl=function(r){if(!r)return null;var t=r.match(/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(t){var e=parseFloat(t[4]);return[(parseFloat(t[1])%360+360)%360,us(parseFloat(t[2]),0,100),us(parseFloat(t[3]),0,100),us(isNaN(e)?1:e,0,1)]}return null},pi.get.hwb=function(r){if(!r)return null;var t=r.match(/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(t){var e=parseFloat(t[4]);return[(parseFloat(t[1])%360+360)%360,us(parseFloat(t[2]),0,100),us(parseFloat(t[3]),0,100),us(isNaN(e)?1:e,0,1)]}return null},pi.to.hex=function(){var r=hu(arguments);return"#"+Xf(r[0])+Xf(r[1])+Xf(r[2])+(r[3]<1?Xf(Math.round(255*r[3])):"")},pi.to.rgb=function(){var r=hu(arguments);return r.length<4||r[3]===1?"rgb("+Math.round(r[0])+", "+Math.round(r[1])+", "+Math.round(r[2])+")":"rgba("+Math.round(r[0])+", "+Math.round(r[1])+", "+Math.round(r[2])+", "+r[3]+")"},pi.to.rgb.percent=function(){var r=hu(arguments),t=Math.round(r[0]/255*100),e=Math.round(r[1]/255*100),n=Math.round(r[2]/255*100);return r.length<4||r[3]===1?"rgb("+t+"%, "+e+"%, "+n+"%)":"rgba("+t+"%, "+e+"%, "+n+"%, "+r[3]+")"},pi.to.hsl=function(){var r=hu(arguments);return r.length<4||r[3]===1?"hsl("+r[0]+", "+r[1]+"%, "+r[2]+"%)":"hsla("+r[0]+", "+r[1]+"%, "+r[2]+"%, "+r[3]+")"},pi.to.hwb=function(){var r=hu(arguments),t="";return r.length>=4&&r[3]!==1&&(t=", "+r[3]),"hwb("+r[0]+", "+r[1]+"%, "+r[2]+"%"+t+")"},pi.to.keyword=function(r){return RA[r.slice(0,3)]};var iL=EA.exports,DA={exports:{}},ta={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},FA={};for(var P0 in ta)ta.hasOwnProperty(P0)&&(FA[ta[P0]]=P0);var pe=DA.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var ei in pe)if(pe.hasOwnProperty(ei)){if(!("channels"in pe[ei]))throw new Error("missing channels property: "+ei);if(!("labels"in pe[ei]))throw new Error("missing channel labels property: "+ei);if(pe[ei].labels.length!==pe[ei].channels)throw new Error("channel and label counts mismatch: "+ei);var oL=pe[ei].channels,sL=pe[ei].labels;delete pe[ei].channels,delete pe[ei].labels,Object.defineProperty(pe[ei],"channels",{value:oL}),Object.defineProperty(pe[ei],"labels",{value:sL})}pe.rgb.hsl=function(r){var t,e,n=r[0]/255,i=r[1]/255,o=r[2]/255,s=Math.min(n,i,o),a=Math.max(n,i,o),l=a-s;return a===s?t=0:n===a?t=(i-o)/l:i===a?t=2+(o-n)/l:o===a&&(t=4+(n-i)/l),(t=Math.min(60*t,360))<0&&(t+=360),e=(s+a)/2,[t,100*(a===s?0:e<=.5?l/(a+s):l/(2-a-s)),100*e]},pe.rgb.hsv=function(r){var t,e,n,i,o,s=r[0]/255,a=r[1]/255,l=r[2]/255,h=Math.max(s,a,l),u=h-Math.min(s,a,l),c=function(f){return(h-f)/6/u+.5};return u===0?i=o=0:(o=u/h,t=c(s),e=c(a),n=c(l),s===h?i=n-e:a===h?i=1/3+t-n:l===h&&(i=2/3+e-t),i<0?i+=1:i>1&&(i-=1)),[360*i,100*o,100*h]},pe.rgb.hwb=function(r){var t=r[0],e=r[1],n=r[2];return[pe.rgb.hsl(r)[0],100*(1/255*Math.min(t,Math.min(e,n))),100*(n=1-1/255*Math.max(t,Math.max(e,n)))]},pe.rgb.cmyk=function(r){var t,e=r[0]/255,n=r[1]/255,i=r[2]/255;return[100*((1-e-(t=Math.min(1-e,1-n,1-i)))/(1-t)||0),100*((1-n-t)/(1-t)||0),100*((1-i-t)/(1-t)||0),100*t]},pe.rgb.keyword=function(r){var t=FA[r];if(t)return t;var e,n,i,o=1/0;for(var s in ta)if(ta.hasOwnProperty(s)){var a=ta[s],l=(n=r,i=a,Math.pow(n[0]-i[0],2)+Math.pow(n[1]-i[1],2)+Math.pow(n[2]-i[2],2));l<o&&(o=l,e=s)}return e},pe.keyword.rgb=function(r){return ta[r]},pe.rgb.xyz=function(r){var t=r[0]/255,e=r[1]/255,n=r[2]/255;return[100*(.4124*(t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92)+.3576*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.1805*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)),100*(.2126*t+.7152*e+.0722*n),100*(.0193*t+.1192*e+.9505*n)]},pe.rgb.lab=function(r){var t=pe.rgb.xyz(r),e=t[0],n=t[1],i=t[2];return n/=100,i/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(e-n),200*(n-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},pe.hsl.rgb=function(r){var t,e,n,i,o,s=r[0]/360,a=r[1]/100,l=r[2]/100;if(a===0)return[o=255*l,o,o];t=2*l-(e=l<.5?l*(1+a):l+a-l*a),i=[0,0,0];for(var h=0;h<3;h++)(n=s+1/3*-(h-1))<0&&n++,n>1&&n--,o=6*n<1?t+6*(e-t)*n:2*n<1?e:3*n<2?t+(e-t)*(2/3-n)*6:t,i[h]=255*o;return i},pe.hsl.hsv=function(r){var t=r[0],e=r[1]/100,n=r[2]/100,i=e,o=Math.max(n,.01);return e*=(n*=2)<=1?n:2-n,i*=o<=1?o:2-o,[t,100*(n===0?2*i/(o+i):2*e/(n+e)),100*((n+e)/2)]},pe.hsv.rgb=function(r){var t=r[0]/60,e=r[1]/100,n=r[2]/100,i=Math.floor(t)%6,o=t-Math.floor(t),s=255*n*(1-e),a=255*n*(1-e*o),l=255*n*(1-e*(1-o));switch(n*=255,i){case 0:return[n,l,s];case 1:return[a,n,s];case 2:return[s,n,l];case 3:return[s,a,n];case 4:return[l,s,n];case 5:return[n,s,a]}},pe.hsv.hsl=function(r){var t,e,n,i=r[0],o=r[1]/100,s=r[2]/100,a=Math.max(s,.01);return n=(2-o)*s,e=o*a,[i,100*(e=(e/=(t=(2-o)*a)<=1?t:2-t)||0),100*(n/=2)]},pe.hwb.rgb=function(r){var t,e,n,i,o,s,a,l=r[0]/360,h=r[1]/100,u=r[2]/100,c=h+u;switch(c>1&&(h/=c,u/=c),n=6*l-(t=Math.floor(6*l)),1&t&&(n=1-n),i=h+n*((e=1-u)-h),t){default:case 6:case 0:o=e,s=i,a=h;break;case 1:o=i,s=e,a=h;break;case 2:o=h,s=e,a=i;break;case 3:o=h,s=i,a=e;break;case 4:o=i,s=h,a=e;break;case 5:o=e,s=h,a=i}return[255*o,255*s,255*a]},pe.cmyk.rgb=function(r){var t=r[0]/100,e=r[1]/100,n=r[2]/100,i=r[3]/100;return[255*(1-Math.min(1,t*(1-i)+i)),255*(1-Math.min(1,e*(1-i)+i)),255*(1-Math.min(1,n*(1-i)+i))]},pe.xyz.rgb=function(r){var t,e,n,i=r[0]/100,o=r[1]/100,s=r[2]/100;return e=-.9689*i+1.8758*o+.0415*s,n=.0557*i+-.204*o+1.057*s,t=(t=3.2406*i+-1.5372*o+-.4986*s)>.0031308?1.055*Math.pow(t,1/2.4)-.055:12.92*t,e=e>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,[255*(t=Math.min(Math.max(0,t),1)),255*(e=Math.min(Math.max(0,e),1)),255*(n=Math.min(Math.max(0,n),1))]},pe.xyz.lab=function(r){var t=r[0],e=r[1],n=r[2];return e/=100,n/=108.883,t=(t/=95.047)>.008856?Math.pow(t,1/3):7.787*t+16/116,[116*(e=e>.008856?Math.pow(e,1/3):7.787*e+16/116)-16,500*(t-e),200*(e-(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116))]},pe.lab.xyz=function(r){var t,e,n,i=r[0];t=r[1]/500+(e=(i+16)/116),n=e-r[2]/200;var o=Math.pow(e,3),s=Math.pow(t,3),a=Math.pow(n,3);return e=o>.008856?o:(e-16/116)/7.787,t=s>.008856?s:(t-16/116)/7.787,n=a>.008856?a:(n-16/116)/7.787,[t*=95.047,e*=100,n*=108.883]},pe.lab.lch=function(r){var t,e=r[0],n=r[1],i=r[2];return(t=360*Math.atan2(i,n)/2/Math.PI)<0&&(t+=360),[e,Math.sqrt(n*n+i*i),t]},pe.lch.lab=function(r){var t,e=r[0],n=r[1];return t=r[2]/360*2*Math.PI,[e,n*Math.cos(t),n*Math.sin(t)]},pe.rgb.ansi16=function(r){var t=r[0],e=r[1],n=r[2],i=1 in arguments?arguments[1]:pe.rgb.hsv(r)[2];if((i=Math.round(i/50))===0)return 30;var o=30+(Math.round(n/255)<<2|Math.round(e/255)<<1|Math.round(t/255));return i===2&&(o+=60),o},pe.hsv.ansi16=function(r){return pe.rgb.ansi16(pe.hsv.rgb(r),r[2])},pe.rgb.ansi256=function(r){var t=r[0],e=r[1],n=r[2];return t===e&&e===n?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(e/255*5)+Math.round(n/255*5)},pe.ansi16.rgb=function(r){var t=r%10;if(t===0||t===7)return r>50&&(t+=3.5),[t=t/10.5*255,t,t];var e=.5*(1+~~(r>50));return[(1&t)*e*255,(t>>1&1)*e*255,(t>>2&1)*e*255]},pe.ansi256.rgb=function(r){if(r>=232){var t=10*(r-232)+8;return[t,t,t]}var e;return r-=16,[Math.floor(r/36)/5*255,Math.floor((e=r%36)/6)/5*255,e%6/5*255]},pe.rgb.hex=function(r){var t=(((255&Math.round(r[0]))<<16)+((255&Math.round(r[1]))<<8)+(255&Math.round(r[2]))).toString(16).toUpperCase();return"000000".substring(t.length)+t},pe.hex.rgb=function(r){var t=r.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!t)return[0,0,0];var e=t[0];t[0].length===3&&(e=e.split("").map(function(i){return i+i}).join(""));var n=parseInt(e,16);return[n>>16&255,n>>8&255,255&n]},pe.rgb.hcg=function(r){var t,e=r[0]/255,n=r[1]/255,i=r[2]/255,o=Math.max(Math.max(e,n),i),s=Math.min(Math.min(e,n),i),a=o-s;return t=a<=0?0:o===e?(n-i)/a%6:o===n?2+(i-e)/a:4+(e-n)/a+4,t/=6,[360*(t%=1),100*a,100*(a<1?s/(1-a):0)]},pe.hsl.hcg=function(r){var t=r[1]/100,e=r[2]/100,n=1,i=0;return(n=e<.5?2*t*e:2*t*(1-e))<1&&(i=(e-.5*n)/(1-n)),[r[0],100*n,100*i]},pe.hsv.hcg=function(r){var t=r[1]/100,e=r[2]/100,n=t*e,i=0;return n<1&&(i=(e-n)/(1-n)),[r[0],100*n,100*i]},pe.hcg.rgb=function(r){var t=r[0]/360,e=r[1]/100,n=r[2]/100;if(e===0)return[255*n,255*n,255*n];var i,o=[0,0,0],s=t%1*6,a=s%1,l=1-a;switch(Math.floor(s)){case 0:o[0]=1,o[1]=a,o[2]=0;break;case 1:o[0]=l,o[1]=1,o[2]=0;break;case 2:o[0]=0,o[1]=1,o[2]=a;break;case 3:o[0]=0,o[1]=l,o[2]=1;break;case 4:o[0]=a,o[1]=0,o[2]=1;break;default:o[0]=1,o[1]=0,o[2]=l}return i=(1-e)*n,[255*(e*o[0]+i),255*(e*o[1]+i),255*(e*o[2]+i)]},pe.hcg.hsv=function(r){var t=r[1]/100,e=t+r[2]/100*(1-t),n=0;return e>0&&(n=t/e),[r[0],100*n,100*e]},pe.hcg.hsl=function(r){var t=r[1]/100,e=r[2]/100*(1-t)+.5*t,n=0;return e>0&&e<.5?n=t/(2*e):e>=.5&&e<1&&(n=t/(2*(1-e))),[r[0],100*n,100*e]},pe.hcg.hwb=function(r){var t=r[1]/100,e=t+r[2]/100*(1-t);return[r[0],100*(e-t),100*(1-e)]},pe.hwb.hcg=function(r){var t=r[1]/100,e=1-r[2]/100,n=e-t,i=0;return n<1&&(i=(e-n)/(1-n)),[r[0],100*n,100*i]},pe.apple.rgb=function(r){return[r[0]/65535*255,r[1]/65535*255,r[2]/65535*255]},pe.rgb.apple=function(r){return[r[0]/255*65535,r[1]/255*65535,r[2]/255*65535]},pe.gray.rgb=function(r){return[r[0]/100*255,r[0]/100*255,r[0]/100*255]},pe.gray.hsl=pe.gray.hsv=function(r){return[0,0,r[0]]},pe.gray.hwb=function(r){return[0,100,r[0]]},pe.gray.cmyk=function(r){return[0,0,0,r[0]]},pe.gray.lab=function(r){return[r[0],0,0]},pe.gray.hex=function(r){var t=255&Math.round(r[0]/100*255),e=((t<<16)+(t<<8)+t).toString(16).toUpperCase();return"000000".substring(e.length)+e},pe.rgb.gray=function(r){return[(r[0]+r[1]+r[2])/3/255*100]};var LA=DA.exports,Yf=LA;function aL(r){var t=function(){for(var h={},u=Object.keys(Yf),c=u.length,f=0;f<c;f++)h[u[f]]={distance:-1,parent:null};return h}(),e=[r];for(t[r].distance=0;e.length;)for(var n=e.pop(),i=Object.keys(Yf[n]),o=i.length,s=0;s<o;s++){var a=i[s],l=t[a];l.distance===-1&&(l.distance=t[n].distance+1,l.parent=n,e.unshift(a))}return t}function lL(r,t){return function(e){return t(r(e))}}function hL(r,t){for(var e=[t[r].parent,r],n=Yf[t[r].parent][r],i=t[r].parent;t[i].parent;)e.unshift(t[i].parent),n=lL(Yf[t[i].parent][i],n),i=t[i].parent;return n.conversion=e,n}var E0=LA,uL=function(r){for(var t=aL(r),e={},n=Object.keys(t),i=n.length,o=0;o<i;o++){var s=n[o];t[s].parent!==null&&(e[s]=hL(s,t))}return e},sl={};Object.keys(E0).forEach(function(r){sl[r]={},Object.defineProperty(sl[r],"channels",{value:E0[r].channels}),Object.defineProperty(sl[r],"labels",{value:E0[r].labels});var t=uL(r);Object.keys(t).forEach(function(e){var n=t[e];sl[r][e]=function(i){var o=function(s){if(s==null)return s;arguments.length>1&&(s=Array.prototype.slice.call(arguments));var a=i(s);if(typeof a=="object")for(var l=a.length,h=0;h<l;h++)a[h]=Math.round(a[h]);return a};return"conversion"in i&&(o.conversion=i.conversion),o}(n),sl[r][e].raw=function(i){var o=function(s){return s==null?s:(arguments.length>1&&(s=Array.prototype.slice.call(arguments)),i(s))};return"conversion"in i&&(o.conversion=i.conversion),o}(n)})});var uu=iL,gi=sl,O0=[].slice,zA=["keyword","gray","hex"],k0={};Object.keys(gi).forEach(function(r){k0[O0.call(gi[r].labels).sort().join("")]=r});var qf={};function Mr(r,t){if(!(this instanceof Mr))return new Mr(r,t);if(t&&t in zA&&(t=null),t&&!(t in gi))throw new Error("Unknown model: "+t);var e,n;if(r==null)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(r instanceof Mr)this.model=r.model,this.color=r.color.slice(),this.valpha=r.valpha;else if(typeof r=="string"){var i=uu.get(r);if(i===null)throw new Error("Unable to parse color from string: "+r);this.model=i.model,n=gi[this.model].channels,this.color=i.value.slice(0,n),this.valpha=typeof i.value[n]=="number"?i.value[n]:1}else if(r.length){this.model=t||"rgb",n=gi[this.model].channels;var o=O0.call(r,0,n);this.color=I0(o,n),this.valpha=typeof r[n]=="number"?r[n]:1}else if(typeof r=="number")r&=16777215,this.model="rgb",this.color=[r>>16&255,r>>8&255,255&r],this.valpha=1;else{this.valpha=1;var s=Object.keys(r);"alpha"in r&&(s.splice(s.indexOf("alpha"),1),this.valpha=typeof r.alpha=="number"?r.alpha:0);var a=s.sort().join("");if(!(a in k0))throw new Error("Unable to parse color from object: "+JSON.stringify(r));this.model=k0[a];var l=gi[this.model].labels,h=[];for(e=0;e<l.length;e++)h.push(r[l[e]]);this.color=I0(h)}if(qf[this.model])for(n=gi[this.model].channels,e=0;e<n;e++){var u=qf[this.model][e];u&&(this.color[e]=u(this.color[e]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function Wn(r,t,e){return(r=Array.isArray(r)?r:[r]).forEach(function(n){(qf[n]||(qf[n]=[]))[t]=e}),r=r[0],function(n){var i;return arguments.length?(e&&(n=e(n)),(i=this[r]()).color[t]=n,i):(i=this[r]().color[t],e&&(i=e(i)),i)}}function cr(r){return function(t){return Math.max(0,Math.min(r,t))}}function I0(r,t){for(var e=0;e<t;e++)typeof r[e]!="number"&&(r[e]=0);return r}Mr.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(r){var t=this.model in uu.to?this:this.rgb(),e=(t=t.round(typeof r=="number"?r:1)).valpha===1?t.color:t.color.concat(this.valpha);return uu.to[t.model](e)},percentString:function(r){var t=this.rgb().round(typeof r=="number"?r:1),e=t.valpha===1?t.color:t.color.concat(this.valpha);return uu.to.rgb.percent(e)},array:function(){return this.valpha===1?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var r={},t=gi[this.model].channels,e=gi[this.model].labels,n=0;n<t;n++)r[e[n]]=this.color[n];return this.valpha!==1&&(r.alpha=this.valpha),r},unitArray:function(){var r=this.rgb().color;return r[0]/=255,r[1]/=255,r[2]/=255,this.valpha!==1&&r.push(this.valpha),r},unitObject:function(){var r=this.rgb().object();return r.r/=255,r.g/=255,r.b/=255,this.valpha!==1&&(r.alpha=this.valpha),r},round:function(r){return r=Math.max(r||0,0),new Mr(this.color.map(function(t){return function(e){return function(n,i){return Number(n.toFixed(i))}(e,t)}}(r)).concat(this.valpha),this.model)},alpha:function(r){return arguments.length?new Mr(this.color.concat(Math.max(0,Math.min(1,r))),this.model):this.valpha},red:Wn("rgb",0,cr(255)),green:Wn("rgb",1,cr(255)),blue:Wn("rgb",2,cr(255)),hue:Wn(["hsl","hsv","hsl","hwb","hcg"],0,function(r){return(r%360+360)%360}),saturationl:Wn("hsl",1,cr(100)),lightness:Wn("hsl",2,cr(100)),saturationv:Wn("hsv",1,cr(100)),value:Wn("hsv",2,cr(100)),chroma:Wn("hcg",1,cr(100)),gray:Wn("hcg",2,cr(100)),white:Wn("hwb",1,cr(100)),wblack:Wn("hwb",2,cr(100)),cyan:Wn("cmyk",0,cr(100)),magenta:Wn("cmyk",1,cr(100)),yellow:Wn("cmyk",2,cr(100)),black:Wn("cmyk",3,cr(100)),x:Wn("xyz",0,cr(100)),y:Wn("xyz",1,cr(100)),z:Wn("xyz",2,cr(100)),l:Wn("lab",0,cr(100)),a:Wn("lab",1),b:Wn("lab",2),keyword:function(r){return arguments.length?new Mr(r):gi[this.model].keyword(this.color)},hex:function(r){return arguments.length?new Mr(r):uu.to.hex(this.rgb().round().color)},rgbNumber:function(){var r=this.rgb().color;return(255&r[0])<<16|(255&r[1])<<8|255&r[2]},luminosity:function(){for(var r=this.rgb().color,t=[],e=0;e<r.length;e++){var n=r[e]/255;t[e]=n<=.03928?n/12.92:Math.pow((n+.055)/1.055,2.4)}return .2126*t[0]+.7152*t[1]+.0722*t[2]},contrast:function(r){var t=this.luminosity(),e=r.luminosity();return t>e?(t+.05)/(e+.05):(e+.05)/(t+.05)},level:function(r){var t=this.contrast(r);return t>=7.1?"AAA":t>=4.5?"AA":""},isDark:function(){var r=this.rgb().color;return(299*r[0]+587*r[1]+114*r[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var r=this.rgb(),t=0;t<3;t++)r.color[t]=255-r.color[t];return r},lighten:function(r){var t=this.hsl();return t.color[2]+=t.color[2]*r,t},darken:function(r){var t=this.hsl();return t.color[2]-=t.color[2]*r,t},saturate:function(r){var t=this.hsl();return t.color[1]+=t.color[1]*r,t},desaturate:function(r){var t=this.hsl();return t.color[1]-=t.color[1]*r,t},whiten:function(r){var t=this.hwb();return t.color[1]+=t.color[1]*r,t},blacken:function(r){var t=this.hwb();return t.color[2]+=t.color[2]*r,t},grayscale:function(){var r=this.rgb().color,t=.3*r[0]+.59*r[1]+.11*r[2];return Mr.rgb(t,t,t)},fade:function(r){return this.alpha(this.valpha-this.valpha*r)},opaquer:function(r){return this.alpha(this.valpha+this.valpha*r)},rotate:function(r){var t=this.hsl(),e=t.color[0];return e=(e=(e+r)%360)<0?360+e:e,t.color[0]=e,t},mix:function(r,t){if(!r||!r.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof r);var e=r.rgb(),n=this.rgb(),i=t===void 0?.5:t,o=2*i-1,s=e.alpha()-n.alpha(),a=((o*s==-1?o:(o+s)/(1+o*s))+1)/2,l=1-a;return Mr.rgb(a*e.red()+l*n.red(),a*e.green()+l*n.green(),a*e.blue()+l*n.blue(),e.alpha()*i+n.alpha()*(1-i))}},Object.keys(gi).forEach(function(r){if(zA.indexOf(r)===-1){var t=gi[r].channels;Mr.prototype[r]=function(){if(this.model===r)return new Mr(this);if(arguments.length)return new Mr(arguments,r);var e,n=typeof arguments[t]=="number"?t:this.valpha;return new Mr((e=gi[this.model][r].raw(this.color),Array.isArray(e)?e:[e]).concat(n),r)},Mr[r]=function(e){return typeof e=="number"&&(e=I0(O0.call(arguments),t)),new Mr(e,r)}}});var HA=QF(Mr);const cL=typeof Object.assign=="function",fL=[];function tr(r){if(cL)Object.assign.apply(Object,arguments);else for(let t=1;t<arguments.length;t++){const e=arguments[t];for(const n in e)r[n]=e[n]}return r}function al(r){return r==null}function Jf(r){return typeof r=="number"&&!isNaN(r)}const dL=[];function NA(r,t){const e=t._get2DExtentAtRes(t.getGLRes()),n=e.getWidth(),i=e.getHeight(),o=r;mn(o);const s=Ar(fL,t.cameraLookAt);return s[2]=0,oo(o,o,s),so(o,o,ie(dL,n,i,1)),o}function BA(r,t){return Object.prototype.hasOwnProperty.call(r,t)}function R0(r){for(let t=1;t<arguments.length;t++){const e=arguments[t];if(e)for(let n=0,i=e.length;n<i;n++)r.push(e[n])}return r.length}const Kf={};function jA(r,t){if(!Array.isArray(t)){const e=t;t=Kf[e]=Kf[e]||HA(t).array()}for(let e=0;e<t.length;e++)r[e]=t[e];return t.length===3&&(r[3]=1),r}function pL(r,t){if(Array.isArray(t))for(let e=0;e<t.length;e++)r[e]=255*t[e];else{const e=t;t=Kf[e]=Kf[e]||HA(t).array();for(let n=0;n<t.length;n++)r[n]=t[n]}return r.length===3&&r.push(255),r}function D0(r,t,e=0){if(!(r&&t instanceof at))return null;const n=r.coordinateToPointAtRes(t,r.getGLRes());return[n.x,n.y,e]}const gL=[0,0],VA=[0,0,0];let F0,cu=class{static getUniformDeclares(){const t=[],e=[];return e.push({name:"shadow_lightProjViewModelMatrix",type:"function",fn:function(n,i){const o=i.shadow_lightProjViewMatrix,s=i.modelMatrix;return qt(t,o,s)}}),e}constructor(t,e){this.renderer=new un(t),this.i=.3,this.h=e,this.o()}resize(){const t=this.canvas;t.width=this.h.getRenderer().canvas.width,t.height=this.h.getRenderer().canvas.height}o(){const t=(this.h.u()||{}).shadow||{},e=this.m(),n=this.getDefines();this.p=new EF(this.renderer,{width:e,height:e,blurOffset:t.blurOffset,defines:n}),this.v=new OF(n),this._()}m(){let t=2048;const e=((this.h.u()||{}).shadow||{}).quality;return e==="medium"?t=1024:e==="low"&&(t=512),t}getDefines(){return{HAS_SHADOWING:1,PACK_FLOAT:1,USE_ESM:1}}render(t,e,n,i,o,s,a,l,h,u){this.M();const c=this.h.getMap(),f=this.m();let d,p;if(u||f!==this.p.width||this.S(c,a,!!t)){f!==this.p.width&&this.p.resize(f,f),this.C=this.C||[],this.T=this.T||[];const g=qt(this.C,e,n),m=Za(this.T,s);F0||(F0=c.getContainerExtent());let y=c.height;c.getPitch()>62&&(y=c._getVisualHeight(62));const x=F0.set(0,c.height-y,c.width,c.height).convertTo(A=>c._containerPointToPointAtRes(A,c.getGLRes())).toArray();t&&a.addMesh(this.k);const v=x.map(A=>[A.x,A.y,0,1]),{lightProjViewMatrix:_,shadowMap:w,blurFBO:b}=this.p.render(a,{cameraProjViewMatrix:g,lightDir:m,farPlane:v,cameraLookAt:c.cameraLookAt});d=this.A=_,p=this.O=w,this.I=b,this.L=a.getMeshes().reduce((A,T)=>(T.castShadow&&T.geometry&&(A[T.uuid]={v0:T.version,v1:T.geometry.version}),A),{}),this.R={count:a.getMeshes().length-+!!t,displayShadow:!!t},this.F=!0}else d=this.A,p=this.O,this.F=!1;return this.P=e,this.H=n,al(o)&&(o=1),t&&a.getMeshes().length&&this.displayShadow(i,o,l,h),{shadow_lightProjViewMatrix:d,shadow_shadowMap:p,shadow_opacity:o,shadow_color:i||VA,esm_shadow_threshold:this.i}}displayShadow(t,e,n,i){const o=this.A,s=this.k,a=this.D||[],l=this.h.getRenderer().canvas,h=this.G=this.G||[];h[0]=l.width,h[1]=l.height,this.renderer.render(this.v,{halton:n||gL,globalTexSize:h,projMatrix:this.P,viewMatrix:this.H,shadow_lightProjViewModelMatrix:qt(a,o,s.localTransform),shadow_shadowMap:this.O,esm_shadow_threshold:this.i,shadow_opacity:e,color:t||VA},this.N,i)}dispose(){this.p.dispose(),this.v.dispose(),this.k&&(this.k.geometry.dispose(),this.k.dispose()),delete this.renderer}isUpdated(){return this.F!==!1}S(t,e,n){if(!this.L)return!0;const i=this.R;if(e.getMeshes().length!==i.count||n!==i.displayShadow)return!0;const o=e.getMeshes();for(let s=0;s<o.length;s++){const a=this.L[o[s].uuid];if(o[s].castShadow&&(o[s].hasSkinAnimation()||!a||a.v0!==o[s].version||a.v1!==o[s].geometry.version))return!0}return!1}_(){const t=new Rf;t.generateBuffers(this.renderer.regl),this.k=new nn(t),this.N=new ur([this.k])}M(){const t=this.h.getMap(),e=NA(this.k.localTransform,t);this.k.setLocalTransform(e)}};const GA=[0,0],Qf=new at(0,0),td=new at(0,0),mL=[],yL=[],ll=[];function hl(r,t,e,n){const i=r.getGLRes(),o=r.distanceToPointAtRes(t,t,i,e?Qf:null,td);return n?o.y:o.x}const{createIBLTextures:UA,disposeIBLTextures:vL,getPBRUniforms:xL}=Qn.PBRUtils,_L=[0,0],bL=[1,1],wL=[],AL=[],TL=[],ML=[],SL=[];let ed=class w3{static getGroundTransform(t,e){return NA(t,e)}constructor(t,e){this.j=t,this.renderer=new un(t),this.h=e,this.B=new Of,this.U=this.V.bind(this),this.o()}needToRedraw(){const t=this.W();return t&&(t[0]||t[1])}getMap(){return this.h&&this.h.getMap()}getSymbol(){const t=this.h.getGroundConfig();return t&&t.symbol}isEnable(){const t=this.h.getGroundConfig();return t&&t.enable}paint(t){if(!this.isEnable())return!1;const e=this.q();if(this.$(t)&&e===this.Y)return!1;const n=this.X(t);n&&this.k.setDefines(n),this.k.material!==this.material&&this.k.setMaterial(this.material);const i=this.h.getGroundConfig();(i&&i.symbol).ssr?this.k.ssr=1:this.k.ssr=0,this.M();const o=this.J(t);o.offsetFactor=t.offsetFactor,o.offsetUnits=t.offsetUnits;const s=t&&t.renderTarget&&t.renderTarget.fbo;return e===this.Y?(this.renderer.render(e,o,this.N,s),this.h.getRenderer().setCanvasUpdated(),!0):(e.filter=t.sceneFilter,this.renderer.render(e,o,this.N,s),this.h.getRenderer().setCanvasUpdated(),!0)}$(t){return!(!this.h.getRenderer().isEnableSSR||!this.h.getRenderer().isEnableSSR())&&!(!t||!t.ssr)}update(){const t=this.h.getGroundConfig();if(!t)return;const e=t&&t.symbol,n=t.urlModifier;if(e){this.Z=this.K(e.polygonFill||[1,1,1,1]),this.tt=e.polygonOpacity===void 0?1:e.polygonOpacity;const i=e.polygonPatternFile;if(i){if(!this.it||this.it._pattern_src!==i){const o=new Image;o.onload=()=>{this.it&&this.it.destroy(),this.it=this.et(o),this.it._pattern_src=i,this.setToRedraw()},o.src=n&&n(i)||i}}else this.it&&(this.it.destroy(),delete this.it)}else this.Z=[1,1,1,1],this.tt=1,this.it&&(this.it.destroy(),delete this.it);this.st()}setToRedraw(){const t=this.h.getRenderer();t&&t.setToRedraw()}dispose(){this.material&&(this.material.dispose(),delete this.material),this.k&&(this.k.geometry.dispose(),this.k.material&&this.k.material.dispose(),this.k.dispose(),delete this.k),this.it&&(this.it.destroy(),delete this.it),this.Y&&(this.Y.dispose(),delete this.Y),this.nt&&(this.nt.dispose(),delete this.nt),this.rt(),this.ht&&(this.ht.destroy(),delete this.ht);const t=this.getMap();t&&t.off("updatelights",this.ot,this)}q(){const t=this.h.getGroundConfig();if(!t||!t.renderPlugin)return this.Y;const e=t.renderPlugin.type;if(e==="lit")return this.nt;if(e==="fill")return this.Y;throw new Error("unsupported render plugin of "+e+" for layer ground")}J(t){const e=this.lt(t);return e.polygonFill=this.Z,e.polygonOpacity=this.tt,this.q()===this.Y&&this.it&&(e.polygonPatternFile=this.it),e}lt(t){let e;return this.h.getGroundConfig().renderPlugin.type==="lit"?(this.ct||(this.ct=UA(this.j,this.getMap())),this.ht||(this.ht=Qn.PBRHelper.generateDFGLUT(this.j)),e=xL(this.getMap(),this.ct,this.ht,t&&t.ssr,t&&t.jitter)):e={projViewMatrix:this.getMap().projViewMatrix},this.ut(e,t),e}ut(t,e){const n=e&&e.includes;if(n)for(const i in n)n[i]&&e[i].renderUniforms&&tr(t,e[i].renderUniforms)}rt(){this.ct&&(vL(this.ct),delete this.ct)}o(){this.getMap().on("updatelights",this.ot,this);const t=this.ft(),e=cu.getUniformDeclares(),n=[];e.push({name:"projViewModelMatrix",type:"function",fn:function(o,s){return qt(n,s.projViewMatrix,s.modelMatrix)}}),this.Y=new Ye({vert:`attribute vec3 aPosition;
uniform mat4 projViewModelMatrix;
uniform mat4 modelMatrix;
#ifdef HAS_PATTERN
    attribute vec2 aTexCoord;
    uniform vec2 uvScale;
    uniform vec2 uvOffset;
    varying vec2 vTexCoord;
#endif
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
    #include <vsm_shadow_vert>
#endif
void main () {
    #ifdef HAS_PATTERN
        vTexCoord = aTexCoord * uvScale + uvOffset;
    #endif
    vec3 position = vec3(aPosition);
    gl_Position = projViewModelMatrix * vec4(position, 1.0);
    #if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
        shadow_computeShadowPars(vec4(position, 1.0));
    #endif
}`,frag:`precision mediump float;
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
    #include <vsm_shadow_frag>
#endif
#ifdef HAS_PATTERN
    uniform sampler2D polygonPatternFile;
    varying vec2 vTexCoord;
#endif
uniform vec4 polygonFill;
uniform float polygonOpacity;
void main() {
    #ifdef HAS_PATTERN
        vec4 color = texture2D(polygonPatternFile, vTexCoord);
    #else
        vec4 color = polygonFill;
    #endif
    gl_FragColor = color * polygonOpacity;
    #if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
        float shadowCoeff = shadow_computeShadow();
        gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, shadowCoeff);
    #endif
}`,uniforms:e,extraCommandProps:t});const i=cu.getUniformDeclares();i.push(...Lf.getUniformDeclares()),this.nt=new Qn.StandardShader({uniforms:i,extraCommandProps:t}),this._(),this.update()}ft(){const t=[0,1],e=this.h.getRenderer().canvas;return{viewport:{x:0,y:0,width:()=>e.width,height:()=>e.height},cull:{enable:!0},depth:{enable:!0,mask:()=>{const n=this.h.getGroundConfig();return n.depth||n.depth===void 0},range:()=>{const n=this.h.getGroundConfig(),i=n&&n.renderPlugin.sceneConfig;return i&&i.depthRange||t},func:"<="},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"},polygonOffset:{enable:!0,offset:{factor:(n,i)=>i.offsetFactor,units:(n,i)=>i.offsetUnits}}}}dt(){const t=this.getMap().getLightManager();return!!(t&&t.getAmbientResource())}_(){const t=new Rf;t.data.aTexCoord=new Uint8Array([0,0,1,0,0,1,1,1]),t.createTangent(),t.generateBuffers(this.renderer.regl),this.k=new nn(t,null,{castShadow:!1});const e=this.nt.getGeometryDefines(t);this.k.setDefines(e),this.N=new ur([this.k])}M(){const t=this.getMap(),e=w3.getGroundTransform(this.k.localTransform,t);this.k.setLocalTransform(e);const n=t.getGLRes(),i=t._get2DExtentAtRes(n),o=i.getWidth(),s=i.getHeight(),a=t.cameraLookAt,l=a[0]-o,h=a[1]-s,u=this.it?this.it.width/this.it.height:1,c=this.getSymbol(),f=this.material?this.material.get("textureOrigin"):c.polygonPatternFileOrigin,d=!!(this.material?this.material.get("uvOffsetInMeter"):c.uvOffsetInMeter),p=(this.material?this.material.get("uvOffset"):c.uvOffset)||_L,g=this.material&&this.material.get("uvScale")||bL,m=this.material?this.material.get("textureWidth"):c.polygonPatternFileWidth,y=this.material?m*(g[1]/g[0]):c.polygonPatternFileHeight,x=this.W(),[v,_,w,b,A]=function(M,E,P,k,O,I,D,z,L,$,Z){const j=M.getGLRes();k&&(Qf.set(k[0],k[1]),M.coordToPointAtRes(Qf,j,td),E-=td.x,P-=td.y);const st=k?Qf:null;$=rw(yL,$);const lt=!L&&$||GA;let rt=L&&$||GA;rt=rw(mL,rt),rt[0]&&(rt[0]=hl(M,rt[0],st)),rt[1]&&(rt[1]=hl(M,rt[1],st,1));let Rt=.5;O&&(Rt=hl(M,O,st));let Ht=Rt/D;if(I&&(Ht=hl(M,I,st,1)),Z&&(Z[0]||Z[1])){const Dt=performance.now()/1e3;let Vt=Z[0],Ct=Z[1];L&&(Vt=-hl(M,Z[0],st),Ct=-hl(M,Z[1],st,1)),Z[0]&&(L?rt[0]=Dt*Vt:lt[0]=Dt*Vt),Z[1]&&(L?rt[1]=Dt*Ct:lt[1]=Dt*Ct)}const ee=(E+rt[0])/(Rt/z[0]),nt=(P-rt[1])/(Ht/z[1]);return ll[0]=Rt/z[0],ll[1]=Ht/z[1],ll[2]=ee,ll[3]=nt,ll[4]=lt,ll}(t,l,h,f,m,y,u,g,d,p,x),T=2*i.getWidth()/v,S=2*i.getHeight()/_;if(!this.material)return this.k.setUniform("uvScale",Pe(wL,T,S)),void this.k.setUniform("uvOffset",Pe(AL,w%1+A[0],b%1+A[1]));this.k.setUniform("uvScale",Pe(SL,T,S)),this.k.setUniform("uvOffset",Pe(TL,w%1+A[0],b%1+A[1])),this.k.setUniform("uvOrigin",Pe(ML,w-w%1,b-b%1)),this.k.setUniform("uvRotation",0)}X(t){let e=!1;const n=this.k.defines,i=this.h.u&&this.h.u(),o=this.h.getGroundConfig();function s(l,h){l?n[h]||(n[h]=1,e=!0):n[h]&&(delete n[h],e=!0)}s(this.dt(),"HAS_IBL_LIGHTING"),s(t&&t.ssr&&o&&o.symbol&&o.symbol.ssr,"HAS_SSR");const a=t&&i&&i.shadow&&i.shadow.enable;return s(a,"HAS_SHADOWING"),s(a,"USE_ESM"),s(!!this.it,"HAS_PATTERN"),e?n:null}st(){const t=this.getSymbol()&&this.getSymbol().material;if(!t)return;const e={};let n=!1;const i=this.h.getGroundConfig();this.B.setURLModifier(i.urlModifier);for(const o in t)if(BA(t,o))if(o.indexOf("Texture")>0){let s=t[o];if(!s)continue;s=typeof s=="string"?{url:s,wrap:"repeat"}:s,s.flipY=!0,s.min="linear mipmap linear",s.mag="linear",s.flipY=!0,e[o]=new If(s,this.B),n=!0}else e[o]=t[o];this.material?(this.gt=new Qn.StandardMaterial(e),this.gt.isReady()?this.V():this.gt.once("complete",this.U)):(this.material=new Qn.StandardMaterial(e),this.material.once("complete",this.U,this)),n||this.V()}V(){this.gt&&(this.material.dispose(),this.material=this.gt,delete this.gt),this.setToRedraw(!0)}et(t){t=c0.resizeToPowerOfTwo(t);const e=this.j,n={width:t.width,height:t.height,data:t,mag:"linear",min:"linear mipmap linear",flipY:!0,wrap:"repeat"};return e.texture(n)}ot(t){if(t.ambientUpdate){this.rt();const e=this.getMap();e&&(this.ct=UA(this.j,e))}this.setToRedraw()}K(t){return jA([],t)}W(){return this.material&&this.material.get("uvOffsetAnim")}getRenderMeshes(){return this.N.getMeshes()}};const{createIBLTextures:CL,disposeIBLTextures:$A}=Qn.PBRUtils,PL=[0,0,0],L0=[],z0=[];let EL=class{constructor(t,e){this.wt=4,this.j=t,this.renderer=new un(t),this.h=e,this.o(),this.vt()}paint(t){if(!this.isEnable()||!this._t)return;const e=this.J(t),n=t&&t.renderTarget&&t.renderTarget.fbo;this.renderer.render(this.yt,e,null,n)}update(){const t=this.getMap();if(!t||!this.isEnable())return;const e=t.getLightManager(),n=e&&e.getAmbientResource();n!==this._t&&this.ct&&($A(this.ct),delete this.ct),this._t=n,this.vt()}dispose(){this.yt.dispose(),$A(this.ct),delete this.yt,delete this.ct,delete this._t}getMap(){return this.h.getMap()}vt(){if(!this._t)return;const t=this.h.u();this.yt.setMode(1,0,t.environment&&t.environment.mode?1:0)}isEnable(){const t=this.h.u();return this.dt()&&t&&t.environment&&t.environment.enable}dt(){const t=this.getMap().getLightManager();return!!(t&&t.getAmbientResource())}J(){const t=this.getMap(),e=this.getMap().getLightManager(),n=e&&e.getAmbientLight();let i=this.ct;i||(i=this.ct=CL(this.j,t));const o=this.h.getRenderer().canvas,s=this.h.u().environment||{},a=s.level||0,l=i.prefilterMap.width,h=this.bt=this.bt||[],u=n&&n.hsv||PL,c=s.brightness||0;return Ar(L0,u),c&&(L0[2]+=c),z0[0]=o.width,z0[1]=o.height,{rgbmRange:i.rgbmRange,cubeMap:i.prefilterMap,bias:a,size:l/Math.pow(2,Math.max(0,a-1)),environmentExposure:Jf(n&&n.exposure)?n.exposure:1,diffuseSPH:i.sh,viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,resolution:z0,hsv:L0,transformMatrix:Bm(h,n&&Math.PI/180*-n.orientation||0)}}o(){const t=this.getMap();if(t.on("updatelights",this.update,this),this.yt=new ND,t.options.lights){const e=this.getMap().getLightManager().getAmbientResource();this._t=e}}};const OL=[],kL=[.03,.03,.03],IL=[],RL=[],DL=[],FL=[1,1,1],LL=[-1200,-1200,0],zL=[1200,1200,1e3],H0={min:[],max:[]},HL=jm([],qs([],90,0,0),[0,0,0]);let WA=class{constructor(t,e){this.j=t,this.renderer=new un(t),this.h=e,this.xt=new NL,this.o()}getMap(){return this.h&&this.h.getMap()}o(){const t=this.h.getRenderer().canvas,e={x:0,y:0,width:()=>t.width,height:()=>t.height};this.yt=new Ye({vert:`attribute vec3 aPosition;
attribute vec3 aNormal;
attribute vec2 aTexCoord;
uniform mat4 projMatrix;
uniform mat4 modelMatrix;
uniform mat4 modelViewMatrix;
uniform mat4 positionMatrix;
uniform vec3 cameraPosition;
uniform float top;
uniform float bottom;
uniform float time;
varying vec2 vTexCoord;
#include <get_output>
float angle(float x, float y){
    return atan(y, x);
}
vec2 getFoot(vec2 camera, vec2 normal, vec2 pos) {
    vec2 position = vec2(0.0, 0.0);
    float distanceLen = distance(pos, normal);
    float a = angle(camera.x - normal.x, camera.y - normal.y);
    pos.x > normal.x ? a -= 0.785 : a += 0.785;
    position.x = cos(a) * distanceLen;
    position.y = sin(a) * distanceLen;
    return position + normal;
    return position;
}
void main()
{
    vec4 localPosition = getPosition(aPosition);
    mat4 localPositionMatrix = getPositionMatrix();
    vec2 foot = getFoot(vec2(cameraPosition.x, cameraPosition.z), vec2(aNormal.x, aNormal.z), vec2(localPosition.x, localPosition.z));
    float height = top - bottom;
    float y = aNormal.y - bottom - height * time;
    y = y + (y < 0.0 ? height : 0.0);
    float ratio = (1.0 - y / height) * (1.0 - y / height);
    y = height * (1.0 - ratio);
    y += bottom;
    y += aPosition.y - aNormal.y;
    localPosition = vec4( foot.x, y, foot.y , 1.0);
    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * localPosition;
    vTexCoord = aTexCoord;
}`,frag:`precision mediump float;
varying vec2 vTexCoord;
uniform vec3 diffuse;
uniform float opacity;
uniform sampler2D rainMap;
void main() {
    vec4 rainColor = texture2D(rainMap, vTexCoord);
    vec4 diffuseColor = vec4(diffuse, opacity);
    diffuseColor *= rainColor;
    gl_FragColor = diffuseColor;
}`,uniforms:[{name:"modelViewMatrix",type:"function",fn:function(n,i){return qt(OL,i.viewMatrix,i.modelMatrix)}}],extraCommandProps:{viewport:e,depth:{enable:!0,mask:!1,func:"less",range:[0,1]},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}}),this.Mt()}Mt(){const t=this.j.texture({width:2,height:2});if(this.St=this.Ct(),!this.St)return;this.Tt=new ur(this.St);const e=this.kt();e.rainTexture?this.At(e.rainTexture).then(n=>{this.St.material.set("rainMap",n)}):(this.St.material.set("rainMap",t),console.warn("should set rain texture."))}Ct(){const t=this.getMap(),e=this.kt();if(!e)return null;this.Ot=t.getZoom();const n=this.It(),i=this.Lt=e.density,o=this.Et=e.rainWidth||1,s=this.Rt=e.rainHeight||1,a=[],l=[],h=[],u=[];for(let g=0;g<i;g++){const m={};m.x=Math.random()*(n.max[0]-n.min[0])+n.min[0],m.y=Math.random()*(n.max[2]-n.min[2])+n.min[2],m.z=Math.random()*(n.max[1]-n.min[1])+n.min[1];const y=(n.max[2]-n.min[2])/37.5*s,x=y/3*o;a.push(m.x+x,m.y+y,m.z,m.x-x,m.y+y,m.z,m.x-x,m.y,m.z,m.x+x,m.y,m.z),l.push(m.x,m.y-y/2,m.z,m.x,m.y-y/2,m.z,m.x,m.y-y/2,m.z,m.x,m.y-y/2,m.z),h.push(1,1,0,1,0,0,1,0),u.push(4*g+0,4*g+1,4*g+2,4*g+0,4*g+2,4*g+3)}const c={};c.POSITION=a,c.NORMAL=l,c.TEXCOORD_0=h;const f=new ar(c,u,0,{primitive:"triangles",positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0"});f.generateBuffers(this.renderer.regl);const d=new Gr({rainMap:this.j.texture({width:2,height:2}),diffuse:e.color||[1,1,1],opacity:e.opacity||1}),p=new nn(f,d);return p.setUniform("top",n.max[2]),p.setUniform("bottom",n.min[2]),this.Ft(p),p.transparent=!0,p}At(t){const e=new Image;return e.src=this.Pt=t,new Promise((n,i)=>{e.onload=()=>{const o=this.j.texture({mag:"linear",min:"linear mipmap nearest",wrapS:"clamp",wrapT:"clamp",data:e});n(o)},e.onerror=o=>{i(o)}})}paint(t){if(!this.Tt)return;const e=this.kt(),n={},i=this.getMap();n.projMatrix=i.projMatrix,n.viewMatrix=i.viewMatrix,n.cameraPosition=i.cameraPosition;const o=e.speed||1,s=this.xt.getElapsedTime()/(2/o)%1;n.time=s,this.St.material.set("diffuse",e.color||FL),this.St.material.set("opacity",e.opacity||1),this.Ft(this.St);const a=t&&t.renderTarget&&t.renderTarget.fbo;this.renderer.render(this.yt,n,this.Tt,a),this.h.getRenderer().setCanvasUpdated()}Ft(t){const e=this.getMap(),n=e.coordinateToPointAtRes(e.getCenter(),e.getGLRes()),i=e.getGLScale()/e.getGLScale(this.Ot),o=ie(RL,i,i,i),s=Vm(o,kL,o),a=mn(DL),l=this.kt(),h=e.getBearing();$a(a,qs(IL,l.windDirectionX||0,l.windDirectionY||0,90-h),[n.x,n.y,0],s),qt(a,a,HL),t.setLocalTransform(a)}setToRedraw(){const t=this.h.getRenderer();t&&t.setToRedraw()}update(){const t=this.kt();if(t){if(this.St||this.Mt(),t.density!==this.Lt||t.rainWidth!==this.Et||t.rainHeight!==this.Rt){const e=this.St.material.get("rainMap");this.St.geometry.dispose(),this.St.dispose(),this.Tt.clear(),this.St=this.Ct(),this.St.material.set("rainMap",e),this.Tt.setMeshes(this.St)}t.rainTexture!==this.Pt&&this.At(t.rainTexture).then(e=>{this.St.material.set("rainMap",e)})}}dispose(){this.St&&(this.St.geometry.dispose(),this.St.material&&this.St.material.dispose(),this.St.dispose(),delete this.St),this.yt&&(this.yt.dispose(),delete this.yt)}isEnable(){const t=this.kt();return t&&t.enable}kt(){const t=this.h.getWeatherConfig();return t&&t.rain}It(){const t=16.685648411389433-this.getMap().getZoom();return Xs(H0.min,LL,Math.pow(2,t)),Xs(H0.max,zL,Math.pow(2,t)),H0}},NL=class{constructor(t){this.autoStart=t===void 0||t,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=(typeof performance>"u"?Date:performance).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let t=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const e=(typeof performance>"u"?Date:performance).now();t=(e-this.oldTime)/1e3,this.oldTime=e,this.elapsedTime+=t}return 0}};const BL=[],jL=[.03,.03,.03],VL=[],GL=[],UL=[],$L=jm([],qs([],90,0,0),[0,0,0]);let ZA=class{constructor(t,e){this.j=t,this.h=e,this.o()}o(){const t=this.h.getRenderer().canvas,e={x:0,y:0,width:()=>t.width,height:()=>t.height};this.yt=new Ye({vert:`#include <gl2_vert>
attribute vec3 aPosition;
attribute vec2 aTexCoord;
varying vec2 vTexCoord;
uniform mat4 projMatrix;
uniform mat4 modelMatrix;
uniform mat4 modelViewMatrix;
uniform mat4 positionMatrix;
#include <get_output>
void main()
{
    mat4 localPositionMatrix = getPositionMatrix();
    vec4 localPosition = getPosition(aPosition);
    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * localPosition;
    vTexCoord = aTexCoord;
}`,frag:`#if __VERSION__ == 100
  #ifdef GL_OES_standard_derivatives
    #extension GL_OES_standard_derivatives : enable
  #endif
#endif
precision mediump float;
#include <gl2_frag>
precision mediump float;
uniform sampler2D perlinTexture;
varying vec2 vTexCoord;
float lerp(float a, float b, float w) {
    return a + w * (b - a);
}
void main() {
    float snowIntense = texture2D(perlinTexture, vTexCoord).r;
    vec3 fixedC = vec3(1.0, 1.0, 1.0);
    float r = lerp(0.5, fixedC.x, snowIntense);
    float g = lerp(0.5, fixedC.y, snowIntense);
    float b = lerp(0.5, fixedC.z, snowIntense);
    glFragColor = vec4(r, g, b, 1.0);
    #if __VERSION__ == 100
        gl_FragColor = glFragColor;
    #endif
}`,uniforms:[{name:"modelViewMatrix",type:"function",fn:function(i,o){return qt(BL,o.viewMatrix,o.modelMatrix)}}],extraCommandProps:{viewport:e}}),this.yt.version=300,this.Tt=new ur,this.Ht=this.Dt(),this.Tt.setMeshes(this.Ht),this.renderer=new un(this.j);const n=this.Gt();n&&(n.snowGroundTexture?this.Nt(n.snowGroundTexture):(this.jt=this.j.texture({width:2,height:2}),console.warn("should set snow ground texture.")))}render(t){this.jt&&this.Ht.material.set("perlinTexture",this.jt);const e=this.h.getMap();this.Bt(e);const n={projMatrix:e.projMatrix,viewMatrix:e.viewMatrix,cameraPosition:e.cameraPosition},i=t&&t.renderTarget&&t.renderTarget.fbo;this.renderer.render(this.yt,n,this.Tt,i),this.h.getRenderer().setCanvasUpdated()}Bt(t){const e=t.coordinateToPointAtRes(t.getCenter(),t.getGLRes()),n=t.getGLScale()/t.getGLScale(this.Ot),i=ie(GL,n,n,n),o=Vm(i,jL,i),s=mn(UL);$a(s,qs(VL,0,0,0),[e.x,e.y,.005],o),qt(s,s,$L),this.Ht.setLocalTransform(s)}Nt(t){const e=new Image;e.onload=()=>{this.jt=this.j.texture({mag:"linear",min:"linear mipmap nearest",wrapS:"repeat",wrapT:"repeat",data:e})},e.onerror=n=>{console.log(n)},e.src=this.Ut=t}Dt(){const t=this.h.getMap();this.Ot=t.getZoom();const e=16e3*Math.pow(2,16.685648411389433-this.Ot),n=[-e,0,-e,e,0,-e,-e,0,e,e,0,e],i={};i.POSITION=n,i.NORMAL=[0,1,0,0,1,0,0,1,0,0,1,0],i.TEXCOORD_0=[0,0,1,0,0,1,1,1];const o=new ar(i,[3,1,0,0,2,3],0,{positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0"});o.generateBuffers(this.j);const s=new Gr({perlinTexture:this.j.texture({with:2,height:2})});return new nn(o,s)}getMeshes(){return this.Ht}dispose(){this.Ht&&(this.Ht.geometry.dispose(),this.Ht.material&&this.Ht.material.dispose(),this.Ht.dispose(),delete this.Ht),this.yt&&(this.yt.dispose(),delete this.yt)}update(){const t=this.Gt();t&&t.snowGroundTexture===!this.Ut&&this.Nt(t.snowGroundTexture)}isEnable(){const t=this.Gt();return t&&t.enable}Gt(){const t=this.h.getWeatherConfig();return t&&t.snow}};const WL=[];let ZL=class{constructor(t,e,n){this.j=t,this.h=e,this.zt=n,this.o()}o(){this.renderer=new un(this.j);const t=this.h.getRenderer(),e=this.Vt={x:0,y:0,width:()=>t.canvas?t.canvas.width:1,height:()=>t.canvas?t.canvas.height:1};this.Wt=e.width,this.qt=e.height,this.$t=this.j.framebuffer({color:this.j.texture({width:t.canvas?t.canvas.width:1,height:t.canvas?t.canvas.height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this.EMPTY_TEXTURE=this.j.texture({with:2,height:2}),this.Yt=new WA(this.j,this.h),this.Xt=new JD(this.j,e),this.Jt=new ZA(this.j,this.h),this.Zt=new GD(this.j,e,this.h),this.Kt=new UD,this.Kt.version=300}getMap(){return this.h&&this.h.getMap()}renderScene(t){this.renderSnowMask(t),this.renderRain(t)}renderRain(t){this.isEnableRain()&&this.Yt.paint(t)}renderSnowMask(t){if(!this.isEnableSnow()||!this.Qt())return;const e=this.getMap();this.Jt.render(t,e)}paint(t,e){if(!e||!e.length)return t;this.ti();const n=this.h.getWeatherConfig(),i={};if(this.isEnableRain()?(i.ripplesMap=this.ii(),this.Kt.shaderDefines.HAS_RAIN=1):delete this.Kt.shaderDefines.HAS_RAIN,this.isEnableSnow()?(this.Kt.shaderDefines.HAS_SNOW=1,i.snowIntensity=c0.isNumber(n.snow.snowIntensity)?n.snow.snowIntensity:.5,e.forEach(o=>{o.defines.HAS_SNOW=1})):(delete this.Kt.shaderDefines.HAS_SNOW,e.forEach(o=>{delete o.defines.HAS_SNOW})),this.isEnableFog()){const o=n.fog;i.fogColor=o.color||[.9,.9,.9],this.Kt.shaderDefines.HAS_FOG=1}else delete this.Kt.shaderDefines.HAS_FOG;return this.Kt.setDefines(this.Kt.shaderDefines),i.mixFactorMap=this.ei(e)||this.EMPTY_TEXTURE,i.sceneMap=t,i.time=this.si()/1e3,i.resolution=Pe(WL,this.$t.width,this.$t.height),this.renderer.render(this.Kt,i,null,this.$t),this.ni=e,this.$t}ei(t){const e={},n=this.getMap(),i=n.getZoom(),o=Math.pow(2,16.685648411389433-i),s=this.h.getWeatherConfig(),a=s.fog;if(!a||!a.enable)return null;const l=a.start||.1,h=a.end||100;e.projMatrix=n.projMatrix,e.viewMatrix=n.viewMatrix,e.cameraPosition=n.cameraPosition,e.fogDist=[l*o,h*o],e.rainDepth=n.altitudeToPoint(s.rain&&s.rain.rainDepth||.1,n.getGLRes());const u=this.Zt.render(t,e);return this.h.getRenderer().ri(u)}ii(){const t=this.getMap(),e=this.h.getWeatherConfig(),n=e.rain.rippleRadius||24,i={};return i.projMatrix=t.projMatrix,i.viewMatrix=t.viewMatrix,i.time=this.si()/1e3,i.rippleRadius=n,i.density=e.rain.density||2e3,this.Xt.render(t,i)}si(){if(!this.h)return 0;if(this.hi===void 0&&(this.hi=0),this.isPlaying()){const t=this.h.getRenderer();this.hi=t.getFrameTime()}return this.hi}isEnable(){const t=this.h.getWeatherConfig();return t&&t.enable}isEnableRain(){const t=this.h.getWeatherConfig();return t&&t.enable&&t.rain&&t.rain.enable}isEnableFog(){const t=this.h.getWeatherConfig();return t&&t.enable&&t.fog&&t.fog.enable}isEnableSnow(){const t=this.h.getWeatherConfig();return t&&t.enable&&t.snow&&t.snow.enable}Qt(){const t=this.h.getWeatherConfig();return this.isEnableSnow()&&t.snow.showGround===!1}isPlaying(){const t=this.h.getWeatherConfig();return!!t&&t.playing!==!1}oi(){return this.isEnableRain()||this.isEnableFog()||this.isEnableSnow()}update(){!this.isEnable()&&this.ni&&this.ni.forEach(t=>{delete t.defines.HAS_SNOW,delete t.defines.HAS_RAIN,delete t.defines.HAS_FOG}),this.isEnableRain()&&(this.Yt=this.Yt||new WA(this.j,this.h),this.Yt.update()),this.isEnableSnow()&&(this.Jt=this.Jt||new ZA(this.j,this.h),this.Jt.update())}getShadowMeshes(){return this.Jt.getMeshes()}ti(){const t=this.Wt(),e=this.qt();!this.$t||this.$t.width===t&&this.$t.height===e||this.$t.resize(t,e)}dispose(){this.$t&&this.$t.destroy(),this.Kt&&(this.Kt.dispose(),delete this.Kt),this.Yt&&(this.Yt.dispose(),delete this.Yt),this.Jt&&(this.Jt.dispose(),delete this.Jt)}};const XA=[],XL=r=>!!r.bloom,YL=r=>!!r.ssr;let YA=class{constructor(t,e){this.j=t,this.h=e,this.ai=new un(t),this.li=new ID,this.ci=new jD,this.ui=new Lf(this.j)}setContextIncludes(){}bloom(t,e,n,i,o,s,a){this.fi||(this.fi=new LD(this.j));const l=this.h.getRenderer().ri(this.di);return this.fi.render(t,l,i,o,s,e,n,a)}drawBloom(t){const e=this.h.getRenderer(),n=this.j,i=this.di;if(i){const{width:f,height:d}=t;i.width===f&&i.height===d||i.resize(f,d),n.clear({color:[0,0,0,0],framebuffer:i})}else{const f=this.gi(t);this.di=n.framebuffer(f)}const o=e.getFrameTime(),s=e.getFrameEvent(),a=e.getFrameContext(),l=a.renderMode,h=a.sceneFilter,u=a.renderTarget;a.isPostProcess=!0,a.renderMode="default",a.sceneFilter=XL,a.renderTarget={fbo:this.di,getFramebuffer:qL,getDepthTexture:JL};const c=e.glCtx;return c.resetDrawCalls(),s?e.forEachRenderer(f=>{e.clearStencil(f,i),f.drawOnInteracting(s,o,a)}):e.forEachRenderer(f=>{e.clearStencil(f,i),f.draw(o,a)}),delete a.isPostProcess,a.renderMode=l,a.sceneFilter=h,a.renderTarget=u,c.getDrawCalls()}genSsrMipmap(t,e){const n=this.h.getMap().projViewMatrix;this.ui.genMipMap(t,e,n)}getPrevSsrProjViewMatrix(){return this.ui&&this.ui.getPrevProjViewMatrix()}drawSSR(t,e,n){n&&this.ui.copyDepthTex(t);const i=this.h.getRenderer(),o=i.getFrameTime(),s=i.getFrameEvent(),a=i.getFrameContext();a.isPostProcess=!0,a.ssr=this.getSSRContext();const l=a.renderMode,h=a.sceneFilter;a.renderMode="default",a.sceneFilter=YL,a.renderTarget.fbo=e;const u=i.glCtx;let c=!1;s?i.forEachRenderer(d=>{i.clearStencil(d,e),c||(u.resetDrawCalls(),c=!0),d.drawOnInteracting(s,o,a)}):i.forEachRenderer(d=>{i.clearStencil(d,e),c||(u.resetDrawCalls(),c=!0),d.draw(o,a)});const f=i.drawGround();return delete a.ssr,delete a.isPostProcess,a.renderMode=l,a.sceneFilter=h,this.mi=u.getDrawCalls()>0,f}getSSRUniforms(){const t=this.h.u(),e=t&&t.postProcess,n=this.h.getMap();return this.ui.getSSRUniforms(n,e.ssr.factor,e.ssr.quality)}getSSRContext(){const t=this.h.u(),e=t&&t.postProcess,n=this.h.getMap(),i=this.ui.getSSRUniforms(n,e.ssr.factor,e.ssr.quality);return i?{renderUniforms:i,defines:{HAS_SSR:1}}:null}fxaa(t,e,n,i,o,s,a,l,h,u,c,f,d,p,g,m){!t||t.width===e.fbo&&t.height===e.height||t.resize(e.width,e.height);const y={};o?y.HAS_TAA_TEX=1:delete y.HAS_TAA_TEX,s?y.HAS_FXAA_TEX=1:delete y.HAS_FXAA_TEX,f?y.HAS_OUTLINE_TEX=1:delete y.HAS_OUTLINE_TEX,n?y.HAS_NOAA_TEX=1:delete y.HAS_NOAA_TEX,i?y.HAS_POINT_TEX=1:delete y.HAS_POINT_TEX,this.li.setDefines(y),this.ai.render(this.li,{textureSource:e,noAaTextureSource:n,pointTextureSource:i,taaTextureSource:o,fxaaTextureSource:s,resolution:Pe(XA,e.width,e.height),enableFXAA:a,enableToneMapping:l,enableSharpen:h,pixelRatio:u,sharpFactor:c,textureOutline:f,highlightFactor:d,outlineFactor:p,outlineWidth:g,outlineColor:m},null,t)}renderFBOToScreen(t,e,n,i){this.pi||(this.pi=[]),this.pi[0]=t.width,this.pi[1]=t.height;const o=this.h.getRenderer();this.ai.render(this.ci,{texture:t.color&&o.ri(t)||t,size:this.pi,enableSharpen:+!!e,sharpFactor:n,pixelRatio:i})}postprocess(t,e,n){this.wi||(this.wi=new RD);const i=this.h&&this.h.getRenderer(),o=n||i.ri(t);return e.resolution=Pe(XA,o.width,o.height),e.textureSource=o,e.timeGrain=performance.now(),this.ai.render(this.wi,e),this.vi}dispose(){this.di&&(this.di.destroy(),delete this.di),this.fi&&(this.fi.dispose(),delete this.fi),this.wi&&(this.wi.dispose(),delete this.wi),this.li&&(this.li.dispose(),delete this.li),this.ci&&(this.ci.dispose(),delete this.ci)}gi(t,e){const{width:n,height:i}=this.h.getRenderer().canvas,o=this.j;let s;s=this.h.getRenderer()._i()?o.renderbuffer({width:n,height:i,samples:this.h.options.multiSamples,format:"rgba8"}):o.texture({min:"nearest",mag:"nearest",format:e||"rgba",width:n,height:i});const a={width:n,height:i,colors:[s]};return t&&(a.depthStencil=t),a}};function qL(r){return r._framebuffer.framebuffer}function JL(r){return r.depthStencil._texture.texture}let KL=class extends Dr{constructor(t){super({vert:`#if __VERSION__ == 300
	#define attribute in
	#define varying out
#endif
attribute vec2 aPosition;
attribute vec2 aTexCoord;
varying vec2 vTexCoord;
void main()
{
  gl_Position = vec4(aPosition, 0., 1.);
  vTexCoord = aTexCoord;
}`,frag:`#if __VERSION__ == 100
  #ifdef GL_OES_standard_derivatives
    #extension GL_OES_standard_derivatives : enable
  #endif
#endif
precision mediump float;
#include <gl2_frag>
varying vec2 vTexCoord;
#ifdef HAS_FLOODANALYSE
    uniform vec3 flood_waterColor;
    uniform float flood_waterOpacity;
    uniform sampler2D floodMap;
#endif
#ifdef HAS_SKYLINE
    uniform sampler2D skylineMap;
#endif
#ifdef HAS_VIEWSHED
    uniform vec4 viewshed_visibleColor;
    uniform vec4 viewshed_invisibleColor;
    uniform sampler2D viewshedMap;
#endif
#ifdef HAS_INSIGHT
    uniform vec4 insight_visibleColor;
    uniform vec4 insight_invisibleColor;
    uniform sampler2D insightMap;
#endif
#ifdef HAS_CUT
    uniform sampler2D meshesMap;
    uniform sampler2D invisibleMap;
#endif
#ifdef HAS_EXCAVATE
    uniform sampler2D excavateMap;
#endif
#ifdef HAS_CROSSCUT
    uniform sampler2D crosscutMap;
    uniform vec4 cutLineColor;
#endif
#ifdef HAS_HEIGHTLIMIT
    uniform vec3 limitColor;
    uniform sampler2D heightLimitMap;
#endif
uniform sampler2D sceneMap;
void main() {
    vec4 sceneColor = texture2D(sceneMap, vTexCoord);
    glFragColor = sceneColor;
    #ifdef HAS_VIEWSHED
        vec4 viewshedColor = texture2D(viewshedMap, vTexCoord);
        if (viewshedColor.r > 0.99) {
            glFragColor = vec4(mix(viewshed_invisibleColor.rgb, sceneColor.rgb, viewshed_invisibleColor.a), sceneColor.a);
        } else if (viewshedColor.g > 0.99) {
            glFragColor = vec4(mix(viewshed_visibleColor.rgb, sceneColor.rgb, viewshed_visibleColor.a), sceneColor.a);
        } else if (viewshedColor.a < 0.01) {
            glFragColor = vec4(viewshedColor.rgb, 1.0);
        }
    #endif
    #ifdef HAS_FLOODANALYSE
        vec4 floodColor = texture2D(floodMap, vTexCoord);
        if (floodColor.r > 0.0) {
            glFragColor = vec4(mix(glFragColor.rgb, flood_waterColor, flood_waterOpacity), glFragColor.a);
        }
    #endif
    #ifdef HAS_SKYLINE
        vec4 skylineColor = texture2D(skylineMap, vTexCoord);
        if (skylineColor.r > 0.0 || skylineColor.g > 0.0 || skylineColor.b > 0.0) {
            glFragColor = skylineColor;
        }
    #endif
    #ifdef HAS_INSIGHT
        vec4 insightColor = texture2D(insightMap, vTexCoord);
        if (insightColor.g > 0.0) {
            glFragColor = insight_visibleColor;
        } else if (insightColor.r > 0.0) {
            glFragColor = insight_invisibleColor;
        }
    #endif
    #ifdef HAS_CUT
        vec4 cutColor = texture2D(invisibleMap, vTexCoord);
        vec4 meshesMapColor = texture2D(meshesMap, vTexCoord);
        if (cutColor.r == 1.0 && cutColor.g == 0.0 && cutColor.b == 0.0) {
            glFragColor = meshesMapColor;
        } else if (cutColor.r == 0.0 && cutColor.g == 1.0 && cutColor.b == 0.0) {
            glFragColor = meshesMapColor;
        } else if (cutColor.r == 0.0 && cutColor.g == 0.0 && cutColor.b == 1.0) {
          glFragColor = sceneColor;
        }
    #endif
    #ifdef HAS_EXCAVATE
        vec4 excavateColor = texture2D(excavateMap, vTexCoord);
        if (excavateColor.r == 1.0 && excavateColor.g == 0.0 && excavateColor.b == 0.0) {
          glFragColor = sceneColor;
        }  else {
          glFragColor = excavateColor;
        }
    #endif
    #ifdef HAS_CROSSCUT
        vec4 crosscutColor = texture2D(crosscutMap, vTexCoord);
        if (crosscutColor.r > 0.0) {
            glFragColor = vec4(mix(cutLineColor.rgb, glFragColor.rgb, 0.99), glFragColor.a);
        }
    #endif
    #ifdef HAS_HEIGHTLIMIT
        vec4 heightLimitColor = texture2D(heightLimitMap, vTexCoord);
        if (heightLimitColor.r > 0.0) {
            glFragColor = vec4(mix(limitColor, glFragColor.rgb, 0.6), glFragColor.a);
        }
    #endif
    #if __VERSION__ == 100
        gl_FragColor = glFragColor;
    #endif
}`,extraCommandProps:{viewport:t,cull:{enable:!0},blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}})}},QL=class{constructor(t,e,n){this.j=t,this.h=e,this.zt=n,this.o()}o(){this.renderer=new un(this.j);const t=this.h.getRenderer(),e=this.Vt={x:0,y:0,width:()=>t.canvas?t.canvas.width:1,height:()=>t.canvas?t.canvas.height:1};this.$t=this.j.framebuffer({color:this.j.texture({width:t.canvas?t.canvas.width:1,height:t.canvas?t.canvas.height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this.yt=new KL(e)}getMap(){return this.h&&this.h.getMap()}paint(t,e){if(!e&&e.length)return t;this.ti();const n={},i=this.h.yi;if(!this.bi())return t;this.j.clear({color:[0,0,0,0],depth:1,stencil:0,framebuffer:this.$t}),delete this.yt.shaderDefines.HAS_FLOODANALYSE,delete this.yt.shaderDefines.HAS_VIEWSHED,delete this.yt.shaderDefines.HAS_SKYLINE,delete this.yt.shaderDefines.HAS_INSIGHT,delete this.yt.shaderDefines.HAS_CUT,delete this.yt.shaderDefines.HAS_CROSSCUT,delete this.yt.shaderDefines.HAS_HEIGHTLIMIT;for(let o=0;o<i.length;o++){const s=i[o];if(!s.isEnable())continue;const a=s.getDefines();tr(this.yt.shaderDefines,a);const l=this.getMap(),h=l.width,u=l.height,c=this.xi(e,s.getExcludeLayers()),f=s.renderAnalysis(c,h,u);f&&tr(n,f)}return n.sceneMap=t,this.yt.setDefines(this.yt.shaderDefines),this.renderer.render(this.yt,n,null,this.$t),this.$t}xi(t,e){let n=[];for(let i=0;i<t.length;i++){if(e.indexOf(t[i].getId())>-1)continue;const o=t[i].getRenderer();if(o&&o.getAnalysisMeshes){const s=o.getAnalysisMeshes();s.forEach(a=>{a.setUniform("useAnalysis",1)}),n=n.concat(s)}}return n}ti(){const t=Jr.isFunction(this.Vt.width.data)?this.Vt.width.data():this.Vt.width,e=Jr.isFunction(this.Vt.height.data)?this.Vt.height.data():this.Vt.height;!this.$t||this.$t.width===t&&this.$t.height===e||this.$t.resize(t,e)}bi(){const t=this.h&&this.h.yi;if(!t)return!1;for(let e=0;e<t.length;e++)if(t[e].isEnable())return!0;return!1}};const ea=[0,0,0,0],N0=[1,1,-1],B0=[0,0],t6=r=>!r.bloom&&!r.ssr,e6=r=>!r.bloom,n6=r=>!r.ssr;let r6=class extends So.CanvasRenderer{setToRedraw(){this.setRetireFrames(),super.setToRedraw()}onAdd(){super.onAdd(),this.prepareCanvas()}updateSceneConfig(){this.Mi&&this.Mi.update(),this.Si&&this.Si.update(),this.Ci&&this.Ci.update(),this.setToRedraw()}render(...t){this.getMap()&&this.layer.isVisible()&&(this.forEachRenderer(e=>{e._replacedDrawFn||(e.draw=this.Ti(e.draw),e.drawOnInteracting=this.ki(e.drawOnInteracting),e.setToRedraw=this.Ai(e.setToRedraw),e._replacedDrawFn=!0)}),this.prepareRender(),this.prepareCanvas(),this.layer.Oi(),this._toRedraw=!1,this.Ii("render",t),this.Li(),this.Ei())}prepareCanvas(){super.prepareCanvas(),this.forEachRenderer(t=>{t.prepareCanvas()})}drawOnInteracting(...t){this.getMap()&&this.layer.isVisible()&&(this.layer.Oi(),this._toRedraw=!1,this.Ii("drawOnInteracting",t),this.Li(),this.Ei())}Ii(t,e){this.Ri="default";const n=this.hasRenderTarget(),i=this.Fi(e);if(n&&(this.Pi.renderTarget=this.Hi()),this.Si.paint(i),this.drawGround(!0),!n)return void this.Di("default",null,t,e,!0);const o=this.glCtx,s=this.layer.u(),a=s&&s.postProcess,l=this.isSSROn(),h=this.isEnableTAA(),u=i.jitter;i.jitter=B0;const c=this.layer.getGroundConfig();if(i.hasSSRGround=!!(l&&c&&c.enable&&c.symbol&&c.symbol.ssr),o.resetDrawCalls(),this.Di(h?"fxaaBeforeTaa":"fxaa",this.Gi,t,e),this.Ni=o.getDrawCalls(),l&&this.ji.drawSSR(this.Bi(),this.Gi),h){const f=this.getMap(),d=this.ji.isTaaNeedRedraw()||this.Ui||f.getRenderer().isViewChanged();i.jitter=d?u:this.zi.getAverage(),i.onlyUpdateDepthInTaa=!d;let p=this.Vi;if(p)p.width===this.Gi.width&&p.height===this.Gi.height||p.resize(this.Gi.width,this.Gi.height);else{const m=this.regl,y=this.createFBOInfo(a,this.Wi);p=this.Vi=m.framebuffer(y)}o.resetDrawCalls(),this.Di("taa",p,t,e),this.qi=o.getDrawCalls(),delete i.onlyUpdateDepthInTaa,i.jitter=B0;let g=this.$i;if(g)g.width===this.Gi.width&&g.height===this.Gi.height||g.resize(this.Gi.width,this.Gi.height);else{const m=this.regl,y=this.createFBOInfo(a,this.Wi);g=this.$i=m.framebuffer(y)}o.resetDrawCalls(),this.Di("fxaaAfterTaa",this.$i,t,e),this.Yi=o.getDrawCalls()}else this.Vi&&(this.Vi.destroy(),this.$i.destroy(),delete this.Vi,delete this.$i,delete this.Yi);a.bloom&&a.bloom.enable&&(this.Xi=this.ji.drawBloom(this.Wi)),l===2&&this.ji.drawSSR(this.Bi(),this.Gi,!0),o.resetDrawCalls(),this.Di("noAa",this.Ji,t,e),this.Zi=o.getDrawCalls(),o.resetDrawCalls(),this.Di("point",this.Ki,t,e,!0),this.Ci.renderScene(i),this.Qi=o.getDrawCalls()}Di(t,e,n,i,o){this.Ri=t;const s=this.Fi(i);s.renderMode=this.Ri,s.renderTarget&&(s.renderTarget.fbo=e),o&&(s.isFinalRender=!0),this.forEachRenderer((a,l)=>{l.isVisible()&&(t==="default"||!a.supportRenderMode&&(t==="fxaa"||t==="fxaaAfterTaa")||a.supportRenderMode&&a.supportRenderMode(t))&&(this.clearStencil(a,e),a[n].apply(a,i))})}Fi(t){let e=t[0];return qA(e)||(e=t[1]),e!==this.te&&(this.forEachRenderer((n,i)=>{i.isVisible()&&n.needRetireFrames&&n.needRetireFrames()&&this.setRetireFrames()}),this.Pi=this.ie(e),this.te=e,this.ee=qA(t[0])?null:t[0]),this.Pi}Li(){if(!this.isEnableOutline())return;const t=this.se(),e=this.glCtx;e.resetDrawCalls(),this.forEachRenderer((n,i)=>{i.isVisible()&&n.drawOutline&&n.drawOutline(t)}),this.ne=e.getDrawCalls()}se(){const{width:t,height:e}=this.canvas;let n=this.re;if(n)t===n.width&&e===n.height||n.resize(t,e);else{const i=this.regl.texture({width:t,height:e,format:"rgba4"});n=this.re=this.regl.framebuffer({width:t,height:e,colors:[i],depth:!1,stencil:!1})}return n}ri(t){if(this._i()){const e=this.he(t);return e.width!==t.width||e.height!==t.height?e.resize(t.width,t.height):this.regl.clear({color:[0,0,0,0],fbo:e}),e.blit(t),e.color[0]}return t.color[0]}Bi(){if(this.Wi.subimage)return this.Wi;const{width:t,height:e}=this.Wi;if(!this.oe){const n=this.regl,i={depthStencil:n.texture({min:"nearest",mag:"nearest",mipmap:!1,type:"depth stencil",width:t,height:e,format:"depth stencil"}),colors:[n.renderbuffer({width:t,height:e,format:"rgba4"})],colorFormat:"rgba4",width:t,height:e};this.oe=n.framebuffer(i)}return this.oe.width===t&&this.oe.height===e||this.oe.resize(t,e),this.regl.clear({color:[0,0,0,0],depth:1,fbo:this.oe}),this.oe.blit(this.Gi,256,"nearest"),this.oe.depthStencil}he(t){if(this.ae||(this.ae=[]),!t.le){const e=this.ce(!0,t.width,t.height),n=this.regl.framebuffer(e);this.ae.push(n),t.le=n}return t.le}_i(){return this.regl.limits.version.indexOf("WebGL 2.0")===0&&this.layer.options.antialias}hasRenderTarget(){const t=this.layer.u(),e=t&&t.postProcess;return!(!e||!e.enable)}testIfNeedRedraw(){if(this.layer.options.forceRedrawPerFrame)return!0;if(this._toRedraw)return this._toRedraw=!1,!0;if(this.getMap().isInteracting()&&(this.Mi&&this.Mi.isEnable()||this.Si&&this.Si.isEnable())||this.Ci&&this.Ci.isEnable())return!0;const t=this.layer.getTerrainLayer();if(t){const n=t.getRenderer();if(n&&n.testIfNeedRedraw())return this.ue=!0,!0}const e=this.fe();for(const n of e){if(!n||!n.isVisible())continue;const i=n.getRenderer();if(i&&i.testIfNeedRedraw())return this.ue=!0,!0}return!1}isRenderComplete(){const t=this.fe();for(const e of t){const n=e.getRenderer();if(n&&!n.isRenderComplete())return!1}return!0}mustRenderOnInteracting(){const t=this.fe();for(const e of t){const n=e.getRenderer();if(n&&n.mustRenderOnInteracting())return!0}return!1}isCanvasUpdated(){if(super.isCanvasUpdated())return!0;const t=this.fe();for(const e of t){const n=e.getRenderer();if(n&&n.isCanvasUpdated())return!0}return!1}isBlank(){if(this.Mi&&this.Mi.isEnable()||this.Si&&this.Si.isEnable())return!1;const t=this.layer.getTerrainLayer();if(t){const n=t.getRenderer();if(n&&!n.isBlank())return!1}const e=this.fe();for(const n of e){const i=n.getRenderer();if(i&&!i.isBlank())return!1}return!0}createContext(){const t=this.layer,e=t.options.glOptions||{alpha:!0,depth:!0,stencil:!0};e.preserveDrawingBuffer=!0,e.antialias=!!t.options.antialias,this.glOptions=e;const n=this.gl=function(l,h,u){const c=u?["webgl","experimental-webgl"]:["webgl2","webgl","experimental-webgl"];let f=null;for(let d=0;d<c.length;++d){try{f=l.getContext(c[d],h)}catch{}if(f)break}return f||console.error("Browser doesn't support WebGL."),f}(this.canvas,e,t.options.onlyWebGL1);this.de(n),n.wrap=()=>new Fo(this.gl),this.glCtx=n.wrap(),this.canvas.gl=this.gl,this.reglGL=n.wrap(),this.regl=Xh({gl:this.reglGL,attributes:e,extensions:t.options.extensions,optionalExtensions:t.options.optionalExtensions}),this.gl.regl=this.regl,this.ge=[0,0],this.Mi=new ed(this.regl,this.layer),this.Si=new EL(this.regl,this.layer);const i=this.layer.getWeatherConfig();this.Ci=new ZL(this.regl,t,i),this.me=new QL(this.regl,t);const o=this.layer.u()||{},s=o&&o.postProcess,a=s&&s.antialias&&s.antialias.jitterRatio||.2;this.zi=new DD(a),this.ji=new YA(this.regl,this.layer,this.zi),this.pe=new cu(this.regl,this.layer)}de(){const t=this.layer,e=this.gl,n=t.options.extensions;n&&n.forEach(o=>{e.getExtension(o)});const i=t.options.optionalExtensions;i&&i.forEach(o=>{e.getExtension(o)}),this.gl.clearColor(0,0,0,0)}clearCanvas(){super.clearCanvas(),this.we()}we(){const t=this.regl;this.Gi&&(t.clear({color:ea,depth:1,stencil:255,framebuffer:this.Gi}),t.clear({color:ea,framebuffer:this.Ji}),t.clear({color:ea,framebuffer:this.Ki}),this.Vi&&this.qi&&t.clear({color:ea,framebuffer:this.Vi}),this.$i&&this.Yi&&t.clear({color:ea,framebuffer:this.$i})),this.re&&t.clear({color:ea,framebuffer:this.re}),t.clear({color:ea,depth:1,stencil:255})}resizeCanvas(){const t=this.canvas.width,e=this.canvas.height;!this.Gi||this.Gi.width===t&&this.Gi.height===e||(super.resizeCanvas(),this.Gi.resize(t,e),this.Ji.resize(t,e),this.Ki.resize(t,e),this.Vi&&this.Vi.resize(t,e),this.$i&&this.$i.resize(t,e),this.we(),this.forEachRenderer(n=>{n.canvas&&n.resizeCanvas()}))}getCanvasImage(){return this.forEachRenderer(t=>{t.getCanvasImage()}),super.getCanvasImage()}fe(){return this.layer.fe()}forEachRenderer(t){const e=this.fe();for(const i of e){if(!i.isVisible()||!i.options.beneathTerrain)continue;const o=i.getRenderer();o&&t(o,i)}const n=this.layer.getTerrainLayer();if(n){const i=n.getRenderer();i&&t(i,n)}for(const i of e){if(!i.isVisible()||i.options.beneathTerrain)continue;const o=i.getRenderer();o&&t(o,i)}}clearStencil(t,e){const n={stencil:t.getStencilValue?t.getStencilValue():255};e&&(n.framebuffer=e),this.regl.clear(n)}onRemove(){this.canvas.pickingFBO&&this.canvas.pickingFBO.destroy&&this.canvas.pickingFBO.destroy(),this.ve(),this.Mi&&(this.Mi.dispose(),delete this.Mi),this.Si&&(this.Si.dispose(),delete this.Si),this.pe&&(this.pe.dispose(),delete this.pe),this.ji&&(this.ji.dispose(),delete this.ji),this.re&&(this.re.destroy(),delete this.re),this.Ci&&(this.Ci.dispose(),delete this.Ci),super.onRemove()}ve(){if(this.Gi&&(this.Gi.destroy(),this.Ji.destroy(),this.Ki.destroy(),this.Vi&&(this.Vi.destroy(),delete this.Vi),this.$i&&(this.$i.destroy(),delete this.$i),delete this.Gi,delete this.Ji,delete this.Ki,this._e&&(this._e.destroy(),delete this._e),this.oe&&(this.oe.destroy(),delete this.oe),this.ae)){for(let t=0;t<this.ae.length;t++)this.ae[t]&&this.ae[t].destroy();delete this.ae}}setRetireFrames(){this.Ui=!0}getFrameTime(){return this.te}getFrameEvent(){return this.ee}getFrameContext(){return this.Pi}drawGround(t){const e=this.layer.getGroundConfig();if(!e||!e.enable||!this.Mi)return!1;const n=this.getFrameContext(),i=n.jitter;n.jitter=B0;const o=this.layer.getPolygonOffsetCount();let s;n.offsetFactor=o+1,n.offsetUnits=o+1,t&&(s=n.sceneFilter,delete n.sceneFilter);const a=this.Mi.paint(n);return this.Mi.needToRedraw()&&this.setToRedraw(),s&&(n.sceneFilter=s),n.jitter=i,a}Ti(t){const e=this;return function(n,i){return(i=i||e.Pi)&&i.renderTarget&&(i.renderTarget.getFramebuffer=JA,i.renderTarget.getDepthTexture=KA),t.call(this,n,i)}}ki(t){const e=this;return function(n,i,o){return(o=o||e.Pi)&&o.renderTarget&&(o.renderTarget.getFramebuffer=JA,o.renderTarget.getDepthTexture=KA),t.call(this,n,i,o)}}Ai(t){return function(...e){return t.apply(this,e)}}isEnableSSR(){const t=this.layer.u(),e=t&&t.postProcess;return e&&e.enable&&e.ssr&&e.ssr.enable}isSSROn(){const t=this.isEnableSSR(),e=this.getMap();if(!t||e.getPitch()<=-.001)return 0;const n=e.projViewMatrix,i=this.ji.getPrevSsrProjViewMatrix();return i&&df(i,n)?1:2}isEnableTAA(){return!1}isEnableSSAO(){return!1}isEnableOutline(){const t=this.layer.u(),e=t&&t.postProcess;return e&&e.enable&&e.outline&&e.outline.enable}isEnableWeather(){const t=this.layer.u(),e=t&&t.weather;return e&&e.enable}ye(){const t=this.layer.getMap();if(!this.R){this.R={center:t.getCenter(),bearing:t.getBearing(),pitch:t.getPitch(),res:t.getResolution()};let a=!1;if(t.options.lights){const l=t.getLightManager().getDirectionalLight().direction||N0;this.R.lightDirection=Ar([],l),a=!0}return{viewChanged:!0,lightDirectionChanged:a}}const e=t.getResolution()/this.R.res,n=t.coordToContainerPoint(this.R.center),i=this.layer.options.viewMoveThreshold,o=n._sub(t.width/2,t.height/2).mag()>i||e<.95||e>1.05;let s=!1;if(t.options.lights){const a=t.getLightManager().getDirectionalLight().direction||N0;s=!Ya(this.R.lightDirection,a),s&&(this.R.lightDirection=Ar([],a))}return o&&(this.R.center=t.getCenter(),this.R.bearing=t.getBearing(),this.R.pitch=t.getPitch(),this.R.res=t.getResolution()),{viewChanged:o,lightDirectionChanged:s}}ie(t){const e=this.layer.u(),n=e&&e.postProcess,i=e&&e.weather,o={timestamp:t,renderMode:this.Ri||"default",includes:{},states:this.ye(),testSceneFilter:u=>!o.sceneFilter||o.sceneFilter(u),isFinalRender:!1,weather:{fog:i&&i.fog}},s=n&&n.antialias&&n.antialias.jitterRatio||.2,a=this.zi;a&&a.setRatio(s);const l=this.isSSROn();let h;if(n&&n.enable){this.isEnableTAA()?((this.getMap().isInteracting()||this.Ui)&&a.reset(),a.getJitter(this.ge),a.frame()):Pe(this.ge,0,0),o.jitter=this.ge;const u=n.bloom&&n.bloom.enable;u&&l?(o.bloom=1,o.sceneFilter=t6):u?(o.bloom=1,o.sceneFilter=e6):l&&(o.sceneFilter=n6),h=this.Hi(),h&&(o.renderTarget=h)}else this.ve();return this.Ri!=="noAa"&&(this.be=this.xe(o),this.be&&(o.includes.shadow=1),this.Me=this.Se(o)),this.be&&(o.shadow=this.be,o.includes.shadow=1),o.states.includesChanged=this.Me,n&&n.enable&&this.ji&&this.ji.setContextIncludes(o),o}Ce(t){const e=this.fe().filter(n=>n.isVisible());return this.layer.getTerrainLayer()&&e.push(this.layer.getTerrainLayer()),this.me.paint(t,e)}Se(t){let e=!1;const n=Object.keys(t.includes),i=this.Te;if(i){const o=n.filter(s=>i.indexOf(s)===-1).concat(i.filter(s=>n.indexOf(s)===-1));o.length&&(e=o.reduce((s,a)=>(s[a]=1,s),{}))}return this.Te=n,e}xe(t){const e=this.layer.u();if(!e||!e.shadow||!e.shadow.enable)return this.pe&&(this.pe.dispose(),delete this.pe),null;this.pe||(this.pe=new cu(this.regl,this.layer));const n={config:e.shadow,defines:this.pe.getDefines(),uniformDeclares:cu.getUniformDeclares()};return n.renderUniforms=this.ke(t),n}ke(t){const e=t.renderTarget&&t.renderTarget.fbo,n=this.layer.u(),i=[];let o=t.states.lightDirectionChanged||t.states.viewChanged;this.forEachRenderer((c,f)=>{if(!c.getShadowMeshes||!f.isVisible())return;const d=c.getShadowMeshes();if(Array.isArray(d))for(let p=0;p<d.length;p++)d[p].needUpdateShadow&&(o=!0),d[p].needUpdateShadow=!1,d[p].hasFunctionUniform("minAltitude")||d[p].setFunctionUniform("minAltitude",()=>f&&f.options.altitude||0),i.push(d[p])}),this.Ae||(this.Ae=new ur),this.Ae.setMeshes(i);const s=this.getMap(),a=n.shadow,l=s.getLightManager(),h=l&&l.getDirectionalLight().direction||N0,u=!n.ground||!n.ground.enable;return this.pe.render(u,s.projMatrix,s.viewMatrix,a.color,a.opacity,h,this.Ae,this.ge,e,o)}Oe(t){let e=[];if(this.forEachRenderer((i,o)=>{if(!i.getAnalysisMeshes||!o.isVisible())return;const s=i.getAnalysisMeshes();e=e.concat(s)}),this.Mi){const i=this.Mi.getRenderMeshes();e=e.concat(i)}const n=this.layer.getWeatherConfig();return this.Ci.paint(t,e,n)}getGroundMesh(){return this.Mi?this.Mi.getRenderMeshes():[]}Hi(){const t=this.layer.u(),e=t&&t.postProcess;if(!this.Gi){const n=this.regl;let i=this.Wi;(!i||!i._texture||i._texture.refCount<=0)&&(i=null);const o=this.createFBOInfo(e,i);this.Wi=o.depth||o.depthStencil,this.Gi=n.framebuffer(o);const s=this.createFBOInfo(e,this.Wi);this.Ji=n.framebuffer(s);const a=this.createFBOInfo(e,this.Wi);this.Ki=n.framebuffer(a),this.we()}return{fbo:this.Gi}}ce(t,e,n){e=e||this.canvas.width,n=n||this.canvas.height;const i=this.regl,o=this._i();let s;return!t&&o?s=i.renderbuffer({width:e,height:n,samples:this.layer.options.multiSamples,format:"rgba8"}):s=i.texture({min:"nearest",mag:"nearest",type:"uint8",width:e,height:n}),{width:e,height:n,colors:[s],colorFormat:o?"rgba8":"rgba"}}createFBOInfo(t,e){const{width:n,height:i}=this.canvas,o=this.regl,s=this.ce(),a=this._i(),l=o.hasExtension("WEBGL_depth_texture");if(a){const h=e||o.renderbuffer({width:n,height:i,format:"depth24 stencil8",samples:this.layer.options.multiSamples});s.depthStencil=h}else if(l){const h=e||o.texture({min:"nearest",mag:"nearest",mipmap:!1,type:"depth stencil",width:n,height:i,format:"depth stencil"});s.depthStencil=h}else{const h=e||o.renderbuffer({width:n,height:i,format:"depth stencil"});s.depthStencil=h}return s}Ei(){if(!this.Gi)return void(this.Ui=!1);const t=this.layer.u(),e=t&&t.postProcess;if(!e||!e.enable){if(this.isEnableWeather())throw new Error("you must enable the post process to turn on weather");return}this.layer.fire("postprocessstart");const n=this.layer.getMap();let i;if(this.isEnableTAA()){const b=this.Ui||n.getRenderer().isViewChanged();b&&this.layer.fire("taastart");const{outputTex:A,redraw:T}=this.ji.taa(this.ri(this.Vi),this.Bi(),{projMatrix:n.projMatrix,needClear:b});i=A,T?this.setToRedraw():this.layer.fire("taaend"),this.Ui=!1}let o=e.sharpen&&e.sharpen.factor;o||o===0||(o=.2);let s=0,a=.2,l=.3,h=1,u=[1,1,0];e.outline&&(s=+!!e.outline.enable,a=ul(e.outline,"highlightFactor",a),l=ul(e.outline,"outlineFactor",l),h=ul(e.outline,"outlineWidth",h),u=ul(e.outline,"outlineColor",u));const c=e.ssr&&e.ssr.enable,f=e.bloom&&e.bloom.enable,d=f&&this.Xi,p=+!(!e.antialias||!e.antialias.enable),g=this.me.bi(),m=this.Ci.oi(),y=f||c||g||m;let x=this._e;if(y){if(!x){const T=this.ce();this._i()&&(T.depthStencil=this.regl.renderbuffer({width:this.canvas.width,height:this.canvas.height,samples:this.layer.options.multiSamples,format:"depth24 stencil8"})),x=this._e=this.regl.framebuffer(T)}const{width:b,height:A}=this.canvas;x.width===b&&x.height===A||x.resize(b,A)}else x=null,this._e&&(this._e.destroy(),delete this._e);let v=this.ri(this.Gi);const _=this.Zi&&this.ri(this.Ji),w=this.Qi&&this.ri(this.Ki);if(this.ji.fxaa(x,v,!d&&_,!d&&w,i,this.Yi&&this.$i&&this.ri(this.$i),p,+!(!e.toneMapping||!e.toneMapping.enable),+!(y||!e.sharpen||!e.sharpen.enable),n.getDevicePixelRatio(),o,s&&this.ne>0&&this.se(),a,l,h,u),x&&(v=this.ri(x)),f&&this.Xi){const b=e.bloom,A=+b.threshold||0,T=ul(b,"factor",1),S=ul(b,"radius",1);v=this.ji.bloom(v,_,w,A,T,S,p)}if(c&&(this.ji.genSsrMipmap(v,this.Bi()),this.ue)){const b=this.Ui;this.setToRedraw(),this.Ui=b,this.ue=!1}this.me&&(v=this.Ce(v)),this.isEnableWeather()&&(v=this.Oe(v)),y&&this.ji.renderFBOToScreen(v,+!(!e.sharpen||!e.sharpen.enable),o,n.getDevicePixelRatio()),this.layer.fire("postprocessend")}};function qA(r){return typeof r=="number"&&!isNaN(r)}function JA(r){return r._framebuffer.framebuffer}function KA(r){return r.depthStencil._texture.texture}function ul(r,t,e){return r[t]==null?e:r[t]}let i6=class extends jb.Actor{constructor(t){super("@maptalks/terrain"),this.mapId=t}checkUrl(t){return t&&Jr.isString(t)?Jr.getAbsoluteURL(t):t}fetchTerrain(t,e,n){t=this.checkUrl(t);const i={actorId:this.actorId,mapId:this.mapId,command:"fetchTerrain",params:{url:t,origin:location.origin,terrainWidth:e.terrainWidth,type:e.type,accessToken:e.accessToken,cesiumIonTokenURL:e.cesiumIonTokenURL,error:e.error,colors:e.colors}};this.send(i,null,(o,s)=>{o?n(o):n(o,s)})}abortTerrain(t,e){const n={actorId:this.actorId,mapId:this.mapId,command:"abortTerrain",params:{url:t}};this.broadcast(n,null,e)}addLayer(t,e,n){const i={actorId:this.actorId,mapId:this.mapId,layerId:t,command:"addLayer",params:{}};this.broadcast(i,null,n)}createTerrainMesh(t,e){const n={actorId:this.actorId,command:"createTerrainMesh",params:t};this.send(n,[t.terrainHeights.data.buffer],(i,o)=>{i?e(i):e(i,o)})}removeLayer(t,e,n){const i={mapId:this.mapId,layerId:t,command:"removeLayer"};this.broadcast(i,null,n)}},o6=class{constructor(t=257){this.gridSize=t;const e=t-1;if(e&e-1)throw new Error(`Expected grid size to be 2^n+1, got ${t}.`);this.numTriangles=e*e*2-2,this.numParentTriangles=this.numTriangles-e*e,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(4*this.numTriangles);for(let n=0;n<this.numTriangles;n++){let i=n+2,o=0,s=0,a=0,l=0,h=0,u=0;for(1&i?a=l=h=e:o=s=u=e;(i>>=1)>1;){const f=o+a>>1,d=s+l>>1;1&i?(a=o,l=s,o=h,s=u):(o=a,s=l,a=h,l=u),h=f,u=d}const c=4*n;this.coords[c+0]=o,this.coords[c+1]=s,this.coords[c+2]=a,this.coords[c+3]=l}}createTile(t){return new s6(t,this)}},s6=class{constructor(t,e){const n=e.gridSize;if(t.length!==n*n)throw new Error(`Expected terrain data of length ${n*n} (${n} x ${n}), got ${t.length}.`);this.terrain=t,this.martini=e,this.errors=new Float32Array(t.length),this.update()}update(){const{numTriangles:t,numParentTriangles:e,coords:n,gridSize:i}=this.martini,{terrain:o,errors:s}=this;for(let a=t-1;a>=0;a--){const l=4*a,h=n[l+0],u=n[l+1],c=n[l+2],f=n[l+3],d=h+c>>1,p=u+f>>1,g=d+p-u,m=p+h-d,y=(o[u*i+h]+o[f*i+c])/2,x=p*i+d,v=Math.abs(y-o[x]);if(s[x]=Math.max(s[x],v),a<e){const _=(u+m>>1)*i+(h+g>>1),w=(f+m>>1)*i+(c+g>>1);s[x]=Math.max(s[x],s[_],s[w])}}}getMesh(t=0){const{gridSize:e,indices:n}=this.martini,{errors:i}=this;let o=0,s=0;const a=e-1;function l(d,p,g,m,y,x){const v=d+g>>1,_=p+m>>1;Math.abs(d-y)+Math.abs(p-x)>1&&i[_*e+v]>t?(l(y,x,d,p,v,_),l(g,m,y,x,v,_)):(n[p*e+d]=n[p*e+d]||++o,n[m*e+g]=n[m*e+g]||++o,n[x*e+y]=n[x*e+y]||++o,s++)}n.fill(0),l(0,0,a,a,a,0),l(a,a,0,0,0,a);const h=new Uint16Array(2*o),u=new Uint32Array(3*s);let c=0;function f(d,p,g,m,y,x){const v=d+g>>1,_=p+m>>1;if(Math.abs(d-y)+Math.abs(p-x)>1&&i[_*e+v]>t)f(y,x,d,p,v,_),f(g,m,y,x,v,_);else{const w=n[p*e+d]-1,b=n[m*e+g]-1,A=n[x*e+y]-1;h[2*w]=d,h[2*w+1]=p,h[2*b]=g,h[2*b+1]=m,h[2*A]=y,h[2*A+1]=x,u[c++]=w,u[c++]=b,u[c++]=A}}return f(0,0,a,a,a,0),f(a,a,0,0,0,a),{vertices:h,triangles:u}}getMeshWithSkirts(t=0,e){const{gridSize:n,indices:i}=this.martini,{errors:o}=this;let s=0,a=0;const l=n-1;let h,u,c=0;const f=[],d=[],p=[],g=[];function m(z,L,$,Z,j,st){const lt=z+$>>1,rt=L+Z>>1;Math.abs(z-j)+Math.abs(L-st)>1&&o[rt*n+lt]>t?(m(j,st,z,L,lt,rt),m($,Z,j,st,lt,rt)):(h=L*n+z,u=Z*n+$,c=st*n+j,i[h]===0&&(z===0?f.push(s):z===l&&d.push(s),L===0?p.push(s):L===l&&g.push(s),i[h]=++s),i[u]===0&&($===0?f.push(s):$===l&&d.push(s),Z===0?p.push(s):Z===l&&g.push(s),i[u]=++s),i[c]===0&&(j===0?f.push(s):j===l&&d.push(s),st===0?p.push(s):st===l&&g.push(s),i[c]=++s),a++)}let y;i.fill(0),m(0,0,l,l,l,0),m(l,l,0,0,0,l),y=e?2*(s+3*f.length-2+3*d.length-2+3*p.length-2+3*g.length-2):2*(s+f.length+d.length+p.length+g.length);const x=3*(a+2*(f.length-1)+2*(d.length-1)+2*(p.length-1)+2*(g.length-1)),v=new Uint16Array(y),_=new Uint32Array(x);let w=0;function b(z,L,$,Z,j,st){const lt=z+$>>1,rt=L+Z>>1;if(Math.abs(z-j)+Math.abs(L-st)>1&&o[rt*n+lt]>t)b(j,st,z,L,lt,rt),b($,Z,j,st,lt,rt);else{const Rt=i[L*n+z]-1,Ht=i[Z*n+$]-1,ee=i[st*n+j]-1;v[2*Rt]=z,v[2*Rt+1]=L,v[2*Ht]=$,v[2*Ht+1]=Z,v[2*ee]=j,v[2*ee+1]=st,_[w++]=Rt,_[w++]=Ht,_[w++]=ee}}b(0,0,l,l,l,0),b(l,l,0,0,0,l),f.sort((z,L)=>v[2*z+1]-v[2*L+1]),d.sort((z,L)=>v[2*L+1]-v[2*z+1]),p.sort((z,L)=>v[2*L]-v[2*z]),g.sort((z,L)=>v[2*z]-v[2*L]);let A,T,S,M,E=2*s,P=0;function k(z){P=z.length;for(let L=0;L<P-1;L++)A=z[L],T=z[L+1],S=E/2,M=(E+(e?6:2))/2,v[E++]=2*A,v[E++]=2*A+1,e&&(v[E++]=2*A,v[E++]=2*A+1,v[E++]=2*T,v[E++]=2*T+1),e?(_[w++]=S+1,_[w++]=S,_[w++]=S+2,_[w++]=S,_[w++]=M,_[w++]=S+2):(_[w++]=A,_[w++]=S,_[w++]=T,_[w++]=S,_[w++]=M,_[w++]=T);v[E++]=2*z[P-1],v[E++]=2*z[P-1]+1}k(f);const O=E;k(d);const I=E;k(p);const D=E;return k(g),{vertices:v,triangles:_,numVerticesWithoutSkirts:s,numTrianglesWithoutSkirts:a,leftSkirtIndex:O,rightSkirtIndex:I,bottomSkirtIndex:D,topSkirtIndex:E}}};const QA={};function tT(r,t,e,n){let i=QA[e];i||(i=QA[e]=new o6(e));const o=i.createTile(t).getMeshWithSkirts(r,!0),{triangles:s,vertices:a,leftSkirtIndex:l,rightSkirtIndex:h,bottomSkirtIndex:u,topSkirtIndex:c}=o;let{numVerticesWithoutSkirts:f,numTrianglesWithoutSkirts:d}=o;f||(f=a.legnth/3,d=s.length/3);const p=a.length/2,g=new Float32Array(3*p),m=new Float32Array(2*p);let y=1/0,x=-1/0;const v=e-1;for(let _=0;_<p;_++){const w=a[2*_],b=a[2*_+1];if(_>=f){const T=w/2*3;let S,M=.001;(_-(_<l/2?f:_<h/2?l/2:_<u/2?h/2:u/2))%3==0?(S=0,M=0):S=g[T+2],g[3*_]=g[T],g[3*_+1]=g[T+1],g[3*_+2]=S,m[2*_]=g[T]/v+M,m[2*_+1]=-g[T+1]/v+M}else g[3*_]=1*w,g[3*_+1]=1*-b,g[3*_+2]=t[b*e+w],m[2*_]=w/v,m[2*_+1]=b/v;const A=g[g.length-1];A<y&&(y=A),A>x&&(x=A)}return{positions:g,texcoords:m,triangles:s,leftSkirtIndex:l,rightSkirtIndex:h,bottomSkirtIndex:u,topSkirtIndex:c,numTrianglesWithoutSkirts:d,numVerticesWithoutSkirts:f,minHeight:y,maxHeight:x,terrainWidth:e}}function eT(r,t,e,n,i,o,s,a,l){const h={};for(let u=0;u<l;u++)h[u+""]=nT(r,t,e,n,i,o,s,a,u);return h}const a6=[];function nT(r,t,e,n,i,o,s,a,l){if((n-=l)<=0)return a6;const h=r.getTileSize().width,u=r._getTileOffset(n,i),c=o[0]-u[0],f=u[1]-o[1],d=r._getTileConfig(),p=r.getSpatialReference().getResolution(n),g=d.tileSystem.scale.y,m=1e-7;let y=0,x=0,v=a/=Math.pow(2,l),_=a;if(c<0?v+=Math.ceil(-c/h-m):c>0&&(y-=Math.ceil(c/h-m)),f>0?x-=Math.ceil(f/h-m):f<0&&(_+=Math.ceil(-f/h-m)),y===0&&x===0&&v<=1&&_<=1){const b=Math.floor(t*a);let A=Math.floor(e*a);const T=A;return g!==s&&(A=rT(d,A,p)),[{x:b,y:A,skinY:T,z:n,offset:u,tileSize:h,id:r._getTileId(b,A,n)}]}const w=[];for(let b=y;b<v;b++)for(let A=x;A<_;A++){const T=t*a+b;let S=e*a+A;const M=S;g!==s&&(S=rT(d,S,p)),w.push({x:T,y:S,skinY:M,z:n,offset:u,tileSize:h,id:r._getTileId(T,S,n)})}return w}function j0(r,t,e,n){let i=r/e*n/t;return i<1?(i=1/i,i=1/Math.round(i)):i=Math.round(i),i}function V0(r,t,e){const n=r.getResolution(t),i=t-Math.log(e/n)*Math.LOG2E;return{zoom:i,res:r.getResolution(i)}}function rT(r,t,e){const n=r.fullExtent,i=r.tileSize.width,o=Math.max(n.top,n.bottom),s=Math.min(n.top,n.bottom);return Math.ceil(o/i/e)-1-Math.floor(s/i/e)-t}function G0(r,t){const e=t*t,n=r!==0?new Float32Array(e):new Uint8Array(e);return n.fill(r),{data:n,width:t,height:t,max:r,min:r}}new W(0,0);const iT=G0(0,5),nd=tT(1,iT.data,iT.width);function oT(r,t,e){const n=e&&e.includes;if(n)for(const i in n)n[i]&&(e[i].uniformDeclares&&t.push(...e[i].uniformDeclares),e[i].defines&&tr(r,e[i].defines))}function l6(r,t){const e=t&&t.includes;if(e)for(const n in e)e[n]&&t[n].renderUniforms&&tr(r,t[n].renderUniforms)}nd.empty=!0;const sT=[],aT=[];let U0=class{constructor(t){this.layer=t,this.regl=t.getRenderer().regl,this.renderer=new un(this.regl),this.Ie=new ur;const e=new Uint8Array(16);e.fill(255),this.Le=this.regl.texture({width:2,height:2,data:e}),this.Ee=new Of(this.Le),this.Re()}setToRedraw(){this.layer.getRenderer().setToRedraw()}getMap(){return this.layer.getMap()}startFrame(t){t&&t.states&&t.states.includesChanged&&(this.shader.dispose(),delete this.shader),this.shader||this.initShader(t),this.Ie.clear()}createTerrainMesh(t,e){const{mesh:n,image:i}=e;let o=e.terrainMesh;const{positions:s,texcoords:a,triangles:l,empty:h}=n;if(o&&o.geometry!==this.Fe)o.geometry.updateData("aPosition",s),o.geometry.updateData("aTexCoord",a),o.geometry.setElements(l);else{const u=h?this.Fe:new ar({aPosition:s,aTexCoord:a},l,0);o?o.geometry=u:(o=new nn(u,null,{disableVAO:!0}),u.generateBuffers(this.regl))}if(!o.uniforms.skin){const u=this.getEmptyTexture();o.setUniform("skin",u)}return o.setUniform("heightTexture",i),this.prepareMesh(o,t,e),o}Pe(t){const e=this.layer.getRenderer();e&&e.updateMaskDefines(t)}He(t){const e=this.De(100)/100,n=mn(t);return so(n,n,[1,1,e]),n}Ge(t,e,n){const i=this.getMap(),o=this.layer.getTileSize().width,s=e.res/i.getGLRes(),a=o/(n-1),{extent2d:l,offset:h}=e;ie(sT,(l.xmin-h[0])*s,(e.extent2d.ymax-h[1])*s,0);const u=mn(t);return oo(u,u,sT),ie(aT,s*a,s*a,1),so(u,u,aT),u}prepareMesh(t,e,n){if(!t.isValid())return;const{mesh:i}=n;this.Pe(t);const{triangles:o,numTrianglesWithoutSkirts:s,terrainWidth:a}=i;t.localTransform=this.Ge(t.localTransform||[],e,a),t.positionMatrix=this.He(t.positionMatrix||[]),t.properties.skirtOffset=3*s,t.properties.skirtCount=o.length-3*s,t.properties.z=e.z,t.properties.minHeight=i.minHeight,t.properties.maxHeight=i.maxHeight,t.properties.terrainWidth=a,t.castShadow=!1,BA(t.uniforms,"minAltitude")||Object.defineProperty(t.uniforms,"minAltitude",{enumerable:!0,get:()=>n.minAltitude||0})}addTerrainImage(t,e){const n=e.terrainMesh;n&&n.geometry&&e.skin&&(n.setUniform("skin",e.skin.color[0]),n.setUniform("polygonOpacity",1),this.Ie.addMesh(n))}endFrame(t){this.updateIBLDefines(this.shader);let e=0;const n=this.getUniformValues(),i=this.Ne(t);return this.shader.filter=t&&t.sceneFilter,l6(n,t),e+=this.renderer.render(this.shader,n,this.Ie,i),e}delete(){this.shader&&(this.shader.dispose(),delete this.shader),this.Le&&(this.Le.destroy(),delete this.Le),this.Fe&&(this.Fe.dispose(),delete this.Fe)}deleteMesh(t){if(!t)return;const e=t.geometry;t.dispose(),e!==this.Fe&&e.dispose()}initShader(t){const e=[],n=[],i={},o=[];oT(i,o,t),this.shader=new Ye({vert:`#define SHADER_NAME TERRAIN_MESH
attribute vec3 aPosition;
attribute vec2 aTexCoord;
uniform float minAltitude;
uniform mat4 projViewModelMatrix;
uniform mat4 projMatrix;
uniform mat4 modelMatrix;
uniform mat4 modelViewMatrix;
uniform mat4 positionMatrix;
uniform float heightScale;
varying vec2 vUv;
#include <mask_vert>
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
    #include <vsm_shadow_vert>
#endif
void main() {
    vec4 position = vec4(aPosition.xy, (aPosition.z + minAltitude) * heightScale, 1.0);
    position = positionMatrix * position;
    #ifdef HAS_MASK_EXTENT
        gl_Position = projMatrix * getMaskPosition(position, modelMatrix);
    #else
        gl_Position = projViewModelMatrix * position;
    #endif
    vUv = aTexCoord;
    #if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
        shadow_computeShadowPars(position);
    #endif
}`,frag:`#define SHADER_NAME TERRAIN_MESH
precision mediump float;
uniform sampler2D skin;
uniform float polygonOpacity;
varying vec2 vUv;
#include <mask_frag>
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
    #include <vsm_shadow_frag>
#endif
void main() {
    vec2 uv = vec2(vUv);
    uv.y = 1.0 - uv.y;
    vec4 color = texture2D(skin, uv);
    #if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
        float shadowCoeff = shadow_computeShadow();
        color.rgb = shadow_blend(color.rgb, shadowCoeff).rgb;
    #endif
    gl_FragColor = color * polygonOpacity;
    #ifdef HAS_MASK_EXTENT
      gl_FragColor = setMask(gl_FragColor);
    #endif
}`,uniforms:o.concat([{name:"modelViewMatrix",type:"function",fn:function(s,a){return qt(n,a.viewMatrix,a.modelMatrix)}},{name:"projViewModelMatrix",type:"function",fn:function(s,a){return qt(e,a.projViewMatrix,a.modelMatrix)}}]),defines:i,extraCommandProps:this.getExtraCommandProps()})}getExtraCommandProps(){const t=this.layer.getRenderer().canvas;return{viewport:{x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1},stencil:{enable:!1},cull:{enable:!0,face:"back"},depth:{enable:!0,mask:()=>!!this.layer.options.depthMask,func:this.layer.options.depthFunc||"<="},blend:{enable:!0,func:{src:this.layer.options.blendSrc,dst:this.layer.options.blendDst},equation:"add"}}}Ne(t){return t&&t.renderTarget&&t.renderTarget.fbo}getUniformValues(){const t=this.getMap(),e=t.projViewMatrix,n=this.layer.getRenderer().getMaskUniforms(),i={viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,projViewMatrix:e,heightScale:1};return tr(i,n),i}De(t){const e=this.layer.getMap();return e?e.altitudeToPoint(t,e.getGLRes()):null}getEmptyTexture(){return this.Le}hasIBL(){const t=this.getMap().getLightManager();return!!(t&&t.getAmbientResource())}updateIBLDefines(t){const e=t.shaderDefines;let n=!1;this.hasIBL()?e[["HAS_IBL_LIGHTING"]]||(e.HAS_IBL_LIGHTING=1,n=!0):e[["HAS_IBL_LIGHTING"]]&&(delete e.HAS_IBL_LIGHTING,n=!0),n&&(t.shaderDefines=e)}Re(){const t=nd,{positions:e,texcoords:n,triangles:i}=t;this.Fe=new ar({aPosition:e,aTexCoord:n},i,0),this.Fe.generateBuffers(this.regl)}};const{getIBLResOnCanvas:h6,getPBRUniforms:u6,loginIBLResOnCanvas:c6,logoutIBLResOnCanvas:f6}=Qn.PBRUtils,lT={baseColorFactor:[1,1,1,1],emissiveFactor:[0,0,0],baseColorIntensity:1,emitColorFactor:1,roughnessFactor:1,metallicFactor:0,emitMultiplicative:1,outputSRGB:1,hsv:[0,0,0],contrast:1,alphaTest:0};let hT=class extends U0{constructor(...t){super(...t),this.createIBLTextures(),this.je=0}updateMaterial(t,e){this.je=e,this.Be=this.Be||{},tr(this.Be,t),this.setToRedraw()}setMaterial(t,e){this.je=e,this.Be=tr({},lT,t),this.setToRedraw()}createIBLTextures(){const t=this.getMap().getRenderer().canvas;c6(t,this.regl,this.getMap()),this.layer.fire("iblupdated")}disposeIBLTextures(){const t=this.getMap().getRenderer().canvas;f6(t,this.getMap())}createTerrainMesh(t,e){const{mesh:n,image:i}=e,{positions:o,texcoords:s,triangles:a,leftSkirtIndex:l,rightSkirtIndex:h,bottomSkirtIndex:u,numVerticesWithoutSkirts:c}=n,f=new Int8Array(o.length);for(let _=2;_<f.length;_+=3)_<3*c?f[_]=1:_<l/2*3?f[_-2]=-1:_<h/2*3?f[_-2]=1:f[_-1]=_<u/2*3?-1:1;const d=new ar({aPosition:o,aTexCoord:s,aNormal:f},a,0);let p;d.createTangent(),delete d.data.aNormal,d.generateBuffers(this.regl),p=i?this.regl.texture({width:i.width,height:i.height,data:i,min:"linear",mag:"linear"}):this.getEmptyTexture();const g=this.getEmptyTexture(),m=tr({},lT,this.layer.options.material||{});m.skinTexture=g,m.terrainHeightTexture=p;const y=new Qn.StandardMaterial(m),x=new nn(d,y);x.properties.matVer=this.je;const v=x.defines;return v.HAS_UV_FLIP=1,v.HAS_TERRAIN_NORMAL=1,v.HAS_MAP=1,x.defines=v,x.setUniform("terrainTileResolution",t.res),this.prepareMesh(x,t,e),x}addTerrainImage(t,e){const n=e.terrainMesh;if(n){if(this.Be&&n.properties.matVer!==this.je){for(const i in this.Be)n.material.set(i,this.Be[i]);n.properties.matVer=this.je}e.skin&&n.material.set("skinTexture",e.skin),n.setUniform("polygonOpacity",1),this.Ie.addMesh(n)}}getUniformValues(){const t=this.getMap(),e=t.getRenderer().canvas,{iblTexes:n,dfgLUT:i}=h6(e),o=u6(t,n,i),s=this.layer.getTileSize().width,a=this.layer.getRenderer().getMaskUniforms(),l=this.De(100)/100;return tr(o,{viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,projViewMatrix:t.projViewMatrix,outSize:[e.width,e.height],polygonFill:[1,1,1,1],terrainHeightMapResolution:[s,s],terrainResolution:[e.width,e.height],terrainHeightScale:l,terrainUnpackFactors:[6553.6,25.6,.1,1e4]}),tr(o,a),o}initShader(t){const e={},n=[];oT(e,n,t),this.shader=new Qn.StandardShader({uniforms:n,defines:e,extraCommandProps:this.getExtraCommandProps()})}delete(){return this.disposeIBLTextures(),super.delete()}};function $0(r,t,e,n){const i=uT.call(this,e,n);this._projViewMatrix=t;const{colorExtent:o,modeExtent:s}=this._extentPass.render(i,t);this._maskUniforms=this._maskUniforms||{},this._maskUniforms.mask_colorExtent=o,this._maskUniforms.mask_extent=r,this._maskUniforms.mask_modeExtent=s,this._maskUniforms.mask_hasFlatOut=W0.call(this,"flat-outside"),this._maskUniforms.mask_hasClipOut=W0.call(this,"clip-outside"),this._maskUniforms.mask_hasVideo=W0.call(this,"video"),this._maskUniforms.mask_heightRatio=e,this._maskUniforms.mask_heightOffset=n,this.setToRedraw()}function uT(r,t){const e=[],n=this.layer.getMasks();for(let i=0;i<n.length;i++){const o=n[i].getMesh(this.regl,r,t);o&&e.push(o)}return e}function d6(){if(!this._extentPass||!this._maskUniforms)return;const r=this._maskUniforms.mask_heightRatio,t=this._maskUniforms.mask_heightOffset,e=uT.call(this,r,t);this._extentPass.render(e,this._projViewMatrix);const n=this.layer.getMasks();for(let i=0;i<n.length;i++)n[i].getMode()==="video"&&n[i].Ue()}function W0(r){const t=this.layer.getMasks();for(let e=0;e<t.length;e++)if(t[e].getMode()===r)return 1;return 0}function cT(){const r=this.layer.getMasks();if(!r)return!1;for(let t=0;t<r.length;t++)if(r[t].getMode()==="video"&&r[t].ze())return!0;return!1}function p6(r){return class extends r{setMask(t,e,n,i){this.viewport||(this.viewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1}),this._extentPass?$0.call(this,t,e,n,i):this.regl?(this._extentPass=new oA(this.regl,this.viewport),$0.call(this,t,e,n,i)):this.layer.once("contextcreate",()=>{this._extentPass=new oA(this.regl,this.viewport),$0.call(this,t,e,n,i)},this)}needToRedraw(){return!!super.needToRedraw()||!!cT.call(this)}getMaskUniforms(){return cT.call(this)&&d6.call(this),this.layer.updateMaskExtent(),this._maskUniforms}getMaskDefines(){return this._maskDefines||(this._maskDefines={}),this._maskUniforms&&this._maskUniforms.mask_colorExtent?this._maskDefines.HAS_MASK_EXTENT=1:delete this._maskDefines.HAS_MASK_EXTENT,this._maskDefines}updateMaskDefines(t){const e=t.getDefines();delete e.HAS_MASK_EXTENT,tr(e,this.getMaskDefines()),t.setDefines(e)}_clearMask(){this._deleteMaskUniforms(),this._extentPass&&(this._extentPass.dispose(),delete this._extentPass),this.setToRedraw()}_deleteMaskUniforms(){delete this._maskUniforms}}}let g6=class{constructor(t,e){this.max=t,this.onRemove=e,this.reset()}reset(){if(this.data){const t=this.data.values();for(const e of t)this.onRemove(e)}return this.data=new Map,this}clear(){this.reset(),delete this.onRemove}add(t,e){return e?(this.has(t)?(this.data.delete(t),this.data.set(t,e)):this.data.set(t,e),this):this}keys(){const t=new Array(this.data.size);let e=0;const n=this.data.keys();for(const i of n)t[e++]=i;return t}has(t){return this.data.has(t)}getAndRemove(t){if(!this.has(t))return null;const e=this.data.get(t);return this.data.delete(t),e}get(t){return this.has(t)?this.data.get(t):null}pop(){if(this.data.size<this.max)return null;const t=this.data.keys().next();return this.data.get(t.value).current?(this.max+=Math.ceil(this.max/2),null):this.getAndRemove(t.value)}remove(t){if(!this.has(t))return this;const e=this.data.get(t);return this.data.delete(t),this.onRemove(e),this}resetCurrent(t){this.data&&this.data.forEach(e=>{e.current=t})}};const cl=new W(0,0),fu=new W(0,0),m6=new Ce(0,0,0,0),y6=new W(0,0),Z0=new W(20,20),fT={color:[0,0,0,0],depth:1,stencil:0};let v6=class extends p6(So.TileLayerCanvasRenderer){isDrawable(){return!0}getTempTileOnLoading(t,e){if(e.image&&!e.image.reset)return e;const n=this.Ve(t);return n.temp=!0,e.image||(e.image=n),delete e.image.reset,e.current=!0,e.info=t,tr(e.image,n),this.We(e.image,t),e}qe(t,e,n){e.reset=!0,delete e.data,delete e.loadTime,delete e.rendered,delete e.minAltitude;const i=t.id+"-temp",o=e.skinImages;if(o)for(let s=0;s<o.length;s++){const a=o[s];if(a){for(let l=0;l<a.length;l++){const h=a[l];h&&(h.refs.delete(i),h.refs.size||n.push(h))}delete a.currentSkins,delete a.tileIds}}delete e.sourceZoom,delete e.skinImages,delete e.skinStatus,delete e.skinTileIds,e.debugTexture&&(e.debugTexture.destroy(),delete e.debugTexture)}Ve(t,e){for(e=e||this.findParentTile(t);e&&e.image&&(e.image.sourceZoom===-1||e.image.originalError);)e=this.findParentTile(e.info);const n=(e&&e.info||t).res,i=this.getMap().pointAtResToDistance(1,1,n),o=e&&e.image&&e.image.data&&this.$e(e,t),s=o&&e.image.sourceZoom!==-1?e.info.z:-1;if(!o||o.width<=1){const l=this.Ye(t,e);return{data:G0(l||0,5),minAltitude:l,mesh:nd,sourceZoom:s}}const a=o.width;return{data:o,mesh:tT(i,o.data,a),sourceZoom:s}}Ye(t,e){if(e&&e.minAltitude)return e.minAltitude;const{idx:n,idy:i,z:o}=t;for(let s=-1;s<=1;s++)for(let a=-1;a<=1;a++){if(s===0&&a===0)continue;const l=this.layer.getTileId(n+s,i+a,o),h=this.layer.tileInfoCache.get(l);if(h&&h.minAltitude)return h.minAltitude}return 0}consumeTile(t,e){if(t.empty&&!t.mesh){const n=this.findParentTile(e);if(!n||n.image&&n.image.empty){t.mesh=nd;const i=this.Ye(e);t.data=G0(i||0,5),t.minAltitude=i,t.sourceZoom=-1}else t=this.Ve(e,n)}this.We(t,e),super.consumeTile(t,e),this.Xe(e)}We(t,e){if(t&&t.mesh){t.terrainMesh=this.Je.createTerrainMesh(e,t),e.minAltitude=t.data.min,e.maxAltitude=t.data.max,delete t.mesh;const n=this.layer.tileInfoCache;if(n&&e.parent&&!t.empty&&!t.temp){const i=n.get(e.parent);if(i){const{minAltitude:o,maxAltitude:s}=e;(i.minAltitude===void 0||i.minAltitude>o)&&(i.minAltitude=o),(i.maxAltitude===void 0||i.maxAltitude<s)&&(i.maxAltitude=s)}}}}Xe(t){const e=this.getMap();if(e.updateCenterAltitude&&e.centerAltitude===void 0&&t.z===this.getCurrentTileZoom()){const n=e._getPrjCenter(),i=e._prjToPointAtRes(n,t.res,y6);t.extent2d.contains(i)&&e.updateCenterAltitude()}}draw(t,e){this.Ze(),this.Je.startFrame(e),super.draw(t,e),this.Ke(e)}drawTile(t,e){const n=this.getMap();if(!t||!n||!e||!this.drawingCurrentTiles&&!this.drawingChildTiles)return;let i=this.drawingCurrentTiles?this.getTileOpacity(e):1;i*=this.layer.options.opacity||1,this.Je.addTerrainImage(t,e,i)}_drawTiles(t,e,n,i,o,s,a){const l=[],h=this.Qe(s,l);this.ts=0;const u=this.layer.getSkinCount();R0(t,h);const c=new Set;for(let f=0;f<u;f++)this.es(f,a,c,l);for(let f=0;f<u;f++)this.es(f,t,c,l);for(let f=0;f<t.length;f++)this.ss(t[f].info,t[f].image);for(let f=0;f<l.length;f++)l[f]&&l[f].texture&&!l[f].refs.size&&(this.ns.delete(l[f].tile.id),this.rs(l[f]));return this.hs(),super._drawTiles(...arguments)}Qe(t,e){const n=[];let i=this.os;i||(i=this.os=new g6(this.layer.options.tempTileCacheSize,o=>{const{info:s,image:a}=o;this.ls(s,a)})),i.resetCurrent(!1);for(let o=0;o<t.length;o++){const s=t[o];let a;i.has(s.id)?a=i.getAndRemove(s.id):(a=i.pop(),a?a.image&&(this.qe(a.info,a.image,e),a.image.temp=!0):a={info:s}),a.current=!0,i.add(s.id,a),n.push(a)}for(let o=0;o<t.length;o++)this.getTempTileOnLoading(t[o],n[o]);return n}hs(){if(!this.ns)return;const t=this.getCurrentTimestamp();if(this.cs&&t-this.cs<1e3)return;const e=new Set;for(const n of this.tileCache.data.values())this.us(n,e);for(const n in this.tilesInView){const i=this.tilesInView[n];this.us(i,e)}if(this.os)for(const n of this.os.data.values())this.us(n,e);e.size&&(this.ns.forEach((n,i)=>{e.has(i)||(console.log("deleted:",i),this.rs(this.ns.get(i)),this.ns.delete(i))}),this.cs=t)}us(t,e){const n=t.image&&t.image.skinImages;if(n&&n.length)for(let i=0;i<n.length;i++){const o=n[i]&&n.currentSkins;if(o)for(const s of o)e.add(s)}}es(t,e,n,i){const o=this.layer.getSkinLayer(t).getRenderer();if(!o)return;const s=[];for(let a=0;a<e.length;a++){const{info:l,image:h}=e[a];if(this.fs(t,l,h,i)){const u=e[a].image.skinImages[t];for(let c=0;c<u.length;c++){const f=u[c].tile.info.id;n.has(f)||(s.push(u[c]),n.add(f))}}}o.renderTerrainSkin(this.regl,this.layer,s)}fs(t,e,n,i){const o=this.getMap();if(delete n.path,!e||!o||!n||!n.terrainMesh)return!1;const s=this.layer.getSkinLayer(t),a=s.getRenderer();if(!a)return!1;n.skinImages||(n.skinImages=[]),n.skinStatus||(n.skinStatus=[]),n.skinTileIds||(n.skinTileIds=[]);const l=a.isAnimating&&a.isAnimating(),h=n.skinStatus[t],u=a.needToRefreshTerrainTileOnZooming&&a.needToRefreshTerrainTileOnZooming(),c=l||u&&n.renderedZoom!==o.getZoom();if(h&&!c)return!1;const f=s.getSpatialReference(),{x:d,y:p,z:g,res:m,offset:y}=e;let x=e.nw;x||(x=e.nw=this.getMap().pointAtResToCoord(e.extent2d.getMin(cl),e.res));const v=this.layer.getTileSize().width,{res:_,zoom:w}=V0(f,g,m),b=j0(_,s.getTileSize().width,m,v);let A=n.skinTileIds[t];if(!A){const $=this.layer._getTileConfig().tileSystem.scale.y;A=n.skinTileIds[t]=eT(s,d,p,w,x,y,$,b,x6)}const T=A[0];let S=!0;const M=[];for(let $=0;$<T.length;$++){const Z=a.getCachedTile(T[$],!1);if(Z)M.push(Z);else{S=!1;const j=a.findParentTile(T[$]);j&&M.push(j)}}const E=n.skinImages[t]||[];E.currentSkins=E.currentSkins||new Set;const P=new Set;let k=!1;for(let $=0;$<E.length;$++){if(!E[$].tile){k=!0;continue}const Z=E[$].tile.info.id;P.add(Z)}if(!M.length)return E.currentSkins.clear(),n.skinImages[t]=[],!1;const O=M.length?M.map($=>$.info.id).join():M[0].info.id;if(!c&&!k&&E.tileIds===O)return!1;E.tileIds=O;let I=!1;E.currentSkins.clear(),E.length=0;const D=E.currentSkins;let z=e.id;n.temp&&(z+="-temp");for(let $=0;$<M.length;$++){const Z=M[$].info.id;D.add(Z);let j=this.ds(Z);j&&(L=j)&&L.texture||(j={tile:tr({},M[$]),layer:s,refs:new Set,texture:a.createTerrainTexture(this.regl)},this.gs(Z,j)),j.refs.add(z),E.push(j),I=!0}var L;return this.ps(e,n,P,D,i),I&&this.ts++,n.skinImages[t]=E,s.fire("renderterrainskin",{tile:e,skinTiles:M}),S&&(n.skinStatus[t]=1),!0}ps(t,e,n,i,o){if(!n.size)return;let s=t.id;e.temp&&(s+="-temp");for(const a of n)if(!i||!i.has(a)){const l=this.ds(a);this.ws(l,s,o)}}ds(t){return this.ns||(this.ns=new Map),this.ns.get(t)}gs(t,e){this.ns.set(t,e)}ss(t,e){const n=this.getMap();if(!t||!n||!e)return;const i=e.skinImages,o=this.vs(e.renderedZoom);if(e.rendered&&!o)return;e.skin?(fT.framebuffer=e.skin,this.regl.clear(fT)):e.skin=this._s(t,e),this.ys();const s=this.layer.options.debug,a=[],l=s&&[],h=this.layer.getTileSize().width;if(i)for(let u=0;u<i.length;u++){const c=i[u];for(let f=0;f<c.length;f++){const{tile:d,texture:p,layer:g}=c[f];if((d.info.offset[0]||d.info.offset[1])&&t.skinTileIds){const v=t.skinTileIds[g.getId()];for(let _=0;_<v.length;_++)if(d.info.x===v[_].x&&d.info.y===v[_].y){d.info.offset=v[_].offset;break}}const m=b6(t,d,h),y=c[f].skinMesh||new nn(this.bs);y.setUniform("skinTexture",p);const x=g.getOpacity();y.setUniform("opacity",al(x)?1:x),y.setUniform("skinDim",m),y.setUniform("tileSize",h),y.setUniform("x",t.x),y.setUniform("y",t.y),c[f].skinMesh=y,a.push(y)}}if(s){const u=e.skinDebugMesh||new nn(this.bs);u.setUniform("tileSize",h);const c=e.debugTexture||this.xs(t,h);e.debugTexture=c,e.skinDebugMesh=u,u.setUniform("opacity",1),u.setUniform("skinTexture",c),u.setUniform("skinDim",[0,0,1]),u.setUniform("tileSize",h),l.push(u)}if(a.length){this.Ms.setMeshes(a);try{this.renderer.render(this.Ss,null,this.Ms,e.skin)}catch(u){throw console.error(e),u}}l&&l.length&&this.layer.options.debug&&(this.Ms.setMeshes(l),this.renderer.render(this.Ss,null,this.Ms,e.skin)),e.rendered=this.Cs(e),e.renderedZoom=n.getZoom()}xs(t,e){e*=2;const{x:n,y:i,z:o}=t,s=`terrain:${n}/${i}/${o}`,a=document.createElement("canvas");a.width=e,a.height=e;const l=a.getContext("2d");l.font="20px monospace";const h=this.layer.options.debugOutline;return l.fillStyle=h,l.strokeStyle=h,l.fillText(s,20,e-40),l.beginPath(),l.lineWidth=4,l.moveTo(0,0),l.lineTo(e,0),l.lineTo(e,e),l.lineTo(0,e),l.lineTo(0,0),l.stroke(),this.regl.texture({data:a,flipY:!0,mag:"linear",min:"linear"})}_s(t){const e=this.layer.getTileSize().width,n=2*e,i=2*e,o=this.regl,s=t.colorsTexture;let a;a=s&&s instanceof Uint8Array?o.texture({data:s,min:"linear",mag:"linear",type:"uint8",width:n,height:i,flipY:!0}):o.texture({min:"linear",mag:"linear",type:"uint8",width:n,height:i,flipY:!0});const l={width:n,height:i,colors:[a],colorFormat:"rgba",ignoreStatusCheck:!0,depthStencil:!1,depth:!1,stencil:!1},h=o.framebuffer(l);return h.colorTex=a,h}Ke(t){this.Je.endFrame(t)&&!Object.keys(this.tilesLoading).length&&this.layer.fire("terrainreadyandrender")}$e(t,e){const{image:n,info:i}=t,o=n.data,s=o.width,{extent2d:a,res:l}=i,{extent2d:h,res:u}=e,c=a.getWidth(),f=a.getHeight();let d=(h.xmin*u/l-a.xmin)/c*(s-1),p=(a.ymax-h.ymax*u/l)/f*(s-1);const g=(h.xmax*u/l-a.xmin)/c*(s-1);let m=Math.round(g-d);const y=Math.log2(m);m=Math.pow(2,Math.round(y))+1,d=Math.floor(d),p=Math.floor(p);const x=new Float32Array(m*m);let v=1/0,_=-1/0;for(let w=0;w<m;w++)for(let b=0;b<m;b++){let A=w+d,T=b+p;A>s-1?A=s-1:A<0&&(A=0),T>s-1?T=s-1:T<0&&(T=0);const S=o.data[A+T*s];x[w+b*m]=S,S<v&&(v=S),S>_&&(_=S)}return{width:m,height:m,data:x,min:v,max:_}}getTileOpacity(t){return this.Cs(t)?super.getTileOpacity(t):(this.resetTileLoadTime(t),0)}Cs(t){const e=this.layer.getSkinCount();if(!e)return!0;if(!t.skinStatus)return!1;for(let n=0;n<e;n++)if(!t.skinStatus[n])return!1;return!0}vs(t){const e=this.getMap().getZoom(),n=this.layer.getSkinLayers();for(let i=0;i<n.length;i++){const o=n[i]&&n[i].getRenderer();if(o&&(o.isAnimating&&o.isAnimating()||o.needToRefreshTerrainTileOnZooming&&o.needToRefreshTerrainTileOnZooming()&&t!==e))return!0}return!1}isValidCachedTile(t){const e=!t.image.skinStatus;return t.image&&!t.image.temp&&(e||this.Cs(t.image))}isTileComplete(t){return t.image&&!t.image.temp&&this.Cs(t.image)}Ts(){const t=this.layer.options;return al(t.terrainWidth)?t.tileSize+1:t.terrainWidth}ks(t,e){const n=this.layer.options.maxAvailableZoom-this.layer.options.zoomOffset,i=t.z-n,o=Math.pow(2,i),s=Math.floor(t.x/o),a=Math.floor(t.y/o),l=Math.floor(t.idx/o),h=Math.floor(t.idy/o),u=dT(s,a);this.As||(this.As={});const c=!this.As[u];return c&&e&&(this.As[u]=new Set,this.As[u].url=this.layer.getTileUrl(s,a,n+this.layer.options.zoomOffset)),{x:s,y:a,idx:l,idy:h,requests:this.As[u],isFirst:c,key:u}}loadTile(t){const e=this.layer,n=this.Ts(),i=e.getSpatialReference().getResolution(t.z);let o=this.getMap().pointAtResToDistance(1,1,i);const s=e.options.zoomOffset||0,a=e.options.maxAvailableZoom&&e.options.maxAvailableZoom-s;if(a&&t.z>a){const f=this.Ve(t);if(f.sourceZoom!==-1)return this.onTileLoad(f,t),f;{const{requests:d,isFirst:p,x:g,y:m,idx:y,idy:x}=this.ks(t,!0);if(d.add(t),!p)return f;const v=t.z-a;o*=Math.pow(2,v);const _=[g,m,a,y,x,t.res*Math.pow(2,v),t.error*Math.pow(2,v)];t=e.createTileNode?e.createTileNode(..._):e.Os(..._)}}const l=t.url,h={},u=e.options,c={terrainWidth:n,type:u.type,accessToken:u.accessToken,cesiumIonTokenURL:u.cesiumIonTokenURL,error:o,colors:u.colors};return this.workerConn.fetchTerrain(l,c,(f,d)=>{if(this.As){const p=dT(t.x,t.y),g=this.As[p];if(g&&g.size){this.tileCache.add(t.id,{info:t,image:h});for(const m of g)this.removeTileLoading(m)}delete this.As[p]}if(f)return f.canceled?void 0:(console.warn(f),void this.onTileError(h,t));Jr.extend(h,d),function(p,g=1){if(al(g)||!p||!p.mesh||g===1)return;const m=p.mesh.positions;if(m)for(let y=0,x=m.length;y<x;y+=3)m[y+2]*=g}(h,this.layer.options.exaggeration),t.colorsTexture=h.colorsTexture,this.onTileLoad(h,t)}),h}deleteTile(t){if(!t||!t.image)return;super.deleteTile(t);const{info:e,image:n}=t;n.temp||(delete e.skinTileIds,this.ls(t.info,n))}ls(t,e){const n=e.skin;n&&(n.destroy(),n.colorTex.destroy(),delete n.colorTex),e.debugTexture&&(e.debugTexture.destroy(),delete e.debugTexture,e.skinDebugMesh.dispose(),delete e.skinDebugMesh);const i=e.skinImages;if(i&&i.length){let o=t.id;e.temp&&(o+="-temp");for(let s=0;s<i.length;s++){const a=i[s];if(a){for(let l=0;l<a.length;l++){if(!a[l]||!a[l].tile)continue;const h=a[l].tile.info.id,u=this.ns&&this.ns.get(h);u&&this.ws(u,o)}a.length=0}}}e.terrainMesh&&this.Je.deleteMesh(e.terrainMesh),e.image&&e.image.close&&e.image.close(),delete e.skinImages,delete e.skin,delete e.skinStatus,delete e.skinTileIds,delete e.terrainMesh,delete e.image,delete e.data,delete e.mesh,delete e.rendered}ws(t,e,n){t&&(t.refs.delete(e),t.refs.size||(n?n.push(t):this.rs(t)))}rs(t){if(!t||!t.tile)return;const e=t.tile.info.id,n=t.layer.getRenderer();delete t.canvas,delete t.layer,t.refs.clear(),t.texture&&(n?n.deleteTerrainTexture(t.texture):t.texture.destroy&&t.texture.destroy(),delete t.texture),t.skinMesh&&(t.skinMesh.dispose(),delete t.skinMesh),n&&(n.removeTileCache&&n.removeTileCache(e),n.deleteTile&&n.constructor.prototype.deleteTile.call(n,t.tile)),delete t.tile,this.ns.delete(e)}Is(){if(!this.ns)return;const t=this.ns.keys();for(const e of t){const n=this.ds(e);this.rs(n)}this.ns.clear()}abortTileLoading(t,e){const n=this.layer,i=n.options.maxAvailableZoom&&n.options.maxAvailableZoom-n.options.zoomOffset;if(e)if(i&&e.z>i){const{requests:o,key:s}=this.ks(e);o&&o.size&&(o.delete(e),o.size||(delete this.As[s],this.workerConn&&this.workerConn.abortTerrain(o.url)))}else e&&e.url&&this.workerConn&&this.workerConn.abortTerrain(e.url);super.abortTileLoading(t,e)}onTileError(t,e){super.onTileError(t,e)}Ls(t){const e=this.getCurrentTileZoom(),n=this.layer.getSpatialReference().getResolution(e),i=this.layer._getTileConfig().getTileIndex(t,n,this.layer.options.repeatWorld);return i.z=e,i}Es(t,e,n,i,o){const s=this.layer.getMinZoom(),a=this.Rs(e,n.x,n.y,n.z,s);if(a&&a.image&&a.image.data){const l=a.info.extent2d,h=a.info.res/o,u=i.x-l.xmin*h,c=l.ymax*h-i.y,f=this.Fs(a.image.data,u/(l.getWidth()*h),c/(l.getHeight()*h));t[0]=f,t[1]=f===null?0:+(a.info.z===n.z)}else t[0]=null,t[1]=0;return t}Rs(t,e,n,i,o){t||(t=this.layer._getTileId(e,n,i));const s=this.tilesInView[t]||this.tileCache.get(t);return!s&&i-1>=o?this.Rs(null,Math.floor(e/2),Math.floor(n/2),i-1,o):s}Fs(t,e,n){const{width:i,height:o,data:s}=t,a=Math.floor((i-1)*e),l=Math.floor((o-1)*n)*i+a;return s[l]===void 0?null:s[l]}Ps(t,e,n){t||(t={tiles:{},dirty:!0,complete:!1});const i=this.layer,o=this.getCurrentTileZoom(),s=i.getSpatialReference().getResolution(o),{xmin:a,ymin:l,xmax:h,ymax:u}=e,c=i._getTileConfig();cl.set(a,l).Hs(n);const f=c._getTileNum(cl,n,!0);fu.set(h,u).Hs(n);const d=c._getTileNum(fu,n,!0),p=Math.min(f.x,d.x),g=Math.max(f.x,d.x),m=Math.min(f.y,d.y),y=Math.max(f.y,d.y),x=n/s;cl.set(a,l).Hs(x),fu.set(h,u).Hs(x);const v=m6.set(cl.x,cl.y,fu.x,fu.y),_=i.getTileSize().width+1;v.Ds(v.getWidth()/_),t.array=t.array||new Float32Array(_*_);const w=t.tiles;t.complete=!0,t.array.fill(0);for(let b=p;b<=g;b++)for(let A=m;A<=y;A++){const T=this.layer._getTileId(b,A,o);if(w[T])continue;const S=this.tileCache.get(T);S?(this.Gs(t.array,S,v,_),t.dirty=!0,w[T]=1):(t.dirty=t.dirty||t.tiles[T]!==void 0,t.tiles[T]&&delete t.tiles[T],t.complete=!1)}return t}Gs(t,e,n,i){const o=e.info.extent2d,s=o.intersection(n),{xmin:a,ymin:l,xmax:h,ymax:u}=s,{data:c}=e.image,f=c.width,d=n.getWidth()/i,p=Math.floor((a-n.xmin)/d),g=Math.floor((l-n.ymin)/d),m=Math.floor((h-n.xmin)/d)-p,y=Math.floor((u-n.ymin)/d)-g,x=o.getWidth()/f,v=Math.floor((a-o.xmin)/x),_=Math.floor((l-o.ymin)/x),w=Math.floor(d/x);for(let b=0;b<=m;b++)for(let A=0;A<=y;A++){const T=b+p+(g+A)*i;let S=0;for(let M=0;M<w;M++)for(let E=0;E<w;E++){const P=(v+Math.floor(b*w))*f+M+_+Math.floor(A*w)+E;S+=c.data[P]}t[T]=S/Math.max(w,1)}return t}clear(){return this.clearTempResources(),super.clear()}clearTempResources(){this.os&&(this.os.reset(),delete this.os),this.ns&&this.Is()}onAdd(){super.onAdd(),this.prepareWorker()}onRemove(){this.workerConn&&(this.workerConn.removeLayer(this.layer.getId(),t=>{if(t)throw t}),this.workerConn.remove(),delete this.workerConn),this.clearTempResources(),this.Ss&&(this.Ss.dispose(),delete this.Ss),this.bs&&(this.bs.dispose(),delete this.bs),delete this.As,super.onRemove(),this.Je&&(this.Je.delete(),delete this.Je)}prepareWorker(){const t=this.layer.getMap();this.workerConn||(this.workerConn=new i6(t.id));const e=this.workerConn;if(!e.isActive())return;const n=this.layer.options||{},i=this.layer.getId();e.addLayer(i,n,o=>{if(o)throw o;this.layer&&(this.ready=!0,this.setToRedraw(),this.layer.fire("workerready"))})}createContext(){this.canvas.gl&&this.canvas.gl.wrap?(this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl):this.Ns(),this.renderer=new un(this.regl),this.layer.fire("contextcreate",{regl:this.regl})}Ze(){const t=this.Je;this.layer.options.shader==="lit"||this.layer.options.shader==="pbr"?(t&&t.constructor===U0||!t)&&(t&&(t.delete(),this.clear(),this.setToRedraw()),this.Je=new hT(this.layer),this.layer.fire("paintercreated")):(t&&t.constructor===hT||!t)&&(t&&(t.delete(),this.clear(),this.setToRedraw()),this.Je=new U0(this.layer),this.layer.fire("paintercreated"))}Ns(){const t=this.layer,e=t.options.glOptions||{alpha:!0,depth:!0,antialias:this.layer.options.antialias};e.preserveDrawingBuffer=!0,e.stencil=!0,this.glOptions=e,this.gl=this.gl||this.js(this.canvas,e),this.regl=Ub.createREGL({gl:this.gl,attributes:e,extensions:["OES_element_index_uint"],optionalExtensions:t.options.glExtensions})}js(t,e){const n=["webgl","experimental-webgl"];let i=null;for(let o=0;o<n.length;++o){try{i=t.getContext(n[o],e)}catch{}if(i)break}return i}resizeCanvas(t){this.canvas&&super.resizeCanvas(t)}clearCanvas(){this.canvas&&super.clearCanvas()}ys(){if(this.Ss)return;const t=this.layer.getTileSize().width;this.Ss=new Ye({vert:`#define SHADER_NAME TERRAIN_SKIN
attribute vec2 aPosition;
void main() {
    gl_Position = vec4(aPosition, 0.0, 1.0);
}`,frag:`#define SHADER_NAME TERRAIN_SKIN
precision mediump float;
uniform float tileSize;
uniform sampler2D skinTexture;
uniform vec3 skinDim;
uniform float opacity;
void main() {
    vec2 fragCoord = gl_FragCoord.xy / 2.0;
    vec2 resolution = vec2(tileSize);
    vec2 uv = (fragCoord - skinDim.xy) /  (resolution * skinDim.z);
    if (uv.x >= 0.0 && uv.x <= 1.0 && uv.y >= 0.0 && uv.y <= 1.0) {
        gl_FragColor = texture2D(skinTexture, uv) * opacity;
    } else {
        gl_FragColor = vec4(0.0);
    }
}`,extraCommandProps:{cull:{enable:!1},viewport:{x:0,y:0,width:2*t,height:2*t},depth:{enable:!1},stencil:{enable:!1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}});const e=new Int8Array([-1,-1,1,1,-1,1,1,1,-1,-1,1,-1]);this.bs=this.bs||new ar({aPosition:e},0,6,{positionSize:2}),this.bs.generateBuffers(this.regl),this.Ms=this.Ms||new ur}updateMaterial(t){this.Je&&t&&this.Je.updateMaterial&&(this.je===void 0&&(this.je=1),this.Je.updateMaterial(t,this.je++))}setMaterial(t){this.Je&&t&&this.Je.setMaterial&&(this.je===void 0&&(this.je=1),this.Je.setMaterial(t,this.je++))}getAnalysisMeshes(){return this.Je&&this.Je.Ie?this.Je.Ie.getMeshes():[]}};const x6=1;function _6(r,t,e,n,i,o,s,a,l=0){r.font="20px monospace",r.fillStyle=e,Z0.y=a-30,r.globalAlpha=1,r.fillText(t,Z0.x+i,Z0.y+o+l),r.globalAlpha=.6,r.strokeStyle=e,r.lineWidth=n,r.beginPath(),r.moveTo(i,o),r.lineTo(i+s,o),r.lineTo(i+s,o+a),r.lineTo(i,o+a),r.lineTo(i,o),r.stroke(),r.globalAlpha=1}function b6(r,t,e){const{res:n,extent2d:i,offset:o}=r,{info:s}=t,a=s.res/n,l=s.offset,h=s.extent2d.xmin*a,u=s.extent2d.ymin*a,c=o[0]-l[0],f=l[1]-o[1];return[h-i.xmin+c,-(i.ymin-u+f),a*s.tileSize/e]}function dT(r,t){return r+"-"+t}So.TileLayerCanvasRenderer.include({renderTerrainSkin(r,t,e){const n=this.layer.getTileSize().width,i=t.options.debug;for(let o=0;o<e.length;o++){const{tile:s,texture:a}=e[o];if(!s.image)continue;const l=document.createElement("canvas");e[o].canvas=l,l.width=n,l.height=n;const h=l.getContext("2d");if(h.drawImage(s.image,0,0),i){const{x:u,y:c,z:f}=s.info;_6(h,`${u}/${c}/${f}`,"yellow",1,0,0,n,n,-18)}a({data:l,width:n,height:n,flipY:!0,min:"linear mipmap linear",mag:"linear"})}},createTerrainTexture(r){const t=this.layer.getTileSize().width,e={width:t,height:t,flipY:!0,min:"linear mipmap linear",mag:"linear",depthStencil:!1,depth:!1,stencil:!1};return r.texture(e)},deleteTerrainTexture(r){r.destroy()}});const w6={"clip-inside":.1,"clip-outside":.2,"flat-inside":.3,"flat-outside":.4,color:.5,video:.6,elevate:.7},A6=[],T6=[1,1,1],pT={polygonFill:[255,0,0],polygonOpacity:.8},X0=new at(0,0),Y0=new at(0,0),rd=[],cs=new at(0,0),M6=new W(0,0),S6=new W(0,0),C6=new W(0,0);let fl=class extends _n{getMode(){return this.Bs}remove(){const t=this.getLayer();return t?(t.removeMask(this),this.Us(),super.remove(),this):this}getMesh(t,e,n){return this.isVisible()?(this.St||(this.St=this.We(t,e,n)),this.zs(this.St,e,n),this.St):null}Vs(t){const e=this.getMap(),n=this.toGeoJSON(),i=SA.flatten(n.geometry.coordinates);for(let u=0;u<i.vertices.length;u+=2){cs.x=i.vertices[u],cs.y=i.vertices[u+1];const c=D0(e,cs);i.vertices[u]=c[0],i.vertices[u+1]=c[1]}const o=D0(e,this.getCenter()),s=[],a=this.getMode()==="video"?4:i.vertices.length/2;for(let u=0;u<a;u++)s.push(i.vertices[2*u]-o[0]),s.push(i.vertices[2*u+1]-o[1]),s.push(0);const l=SA(s,i.holes,3),h=new ar({POSITION:s,TEXCOORD:this.Ws(i.vertices)},l,0,{positionAttribute:"POSITION",uv0Attribute:"TEXCOORD"});return h.generateBuffers(t),h}Ws(t){const e=[0,0,1,0,1,1,0,1];if(this.hasHoles())for(let n=e.length/2-1;n<t.length;n+=2)e[n]=e[n+1]=0;return e}qs(){this.Us(),delete this.St,this.maskGeoJSON&&(this.maskGeoJSON=null)}$s(){return w6[this.Bs]}Ys(){const t=this.getSymbol(),{polygonFill:e,polygonOpacity:n}=t||pT,i=jA([],e);return i[0]/=255,i[1]/=255,i[2]/=255,i[3]=Jf(n)?n:pT.polygonOpacity,i}Xs(t=0){const e=this.getMap(),n=e.getGLRes();return e.altitudeToPoint(t,n)}Js(t){const e=D0(this.getMap(),this.getCenter()),n=$a(t.localTransform,Qb(A6),e,T6);t.localTransform=n}Us(){this.St&&(this.St.material&&this.St.material.dispose(),this.St.geometry&&this.St.geometry.dispose(),this.St.dispose(),delete this.St)}containsPoint(t){const e=this.getExtent();if(cs.set(t[0],t[1]),!e||!e.contains(cs))return!1;const n=this.getHoles();for(let o=0;o<n.length;o++)if(this.Zs(n[o],t))return!1;const i=this.getShell();return this.Zs(i,t)}Zs(t,e){const n=this.Ks(t);let i=0;for(let o=0;o<t.length;o++){X0.x=t[o].x,X0.y=t[o].y;const s=o+1>=t.length?0:o+1;Y0.x=t[s].x,Y0.y=t[s].y,cs.x=e[0],cs.y=e[1],rd[0]=cs,rd[1]=X0,rd[2]=Y0,i+=this.Ks(rd)}return!(Math.abs(i-n)>1e-8)}Ks(t){const e=this.getMap();let n=0;const i=e.getGLRes(),o=e.coordToPointAtRes(t[0],i,M6);for(let h=1;h<t.length-1;h++){const u=e.coordToPointAtRes(t[h],i,S6),c=e.coordToPointAtRes(t[h+1],i,C6);n+=Math.abs((s=o,l=c,((a=u).x-s.x)*(l.y-s.y)-(a.y-s.y)*(l.x-s.x)))/2}var s,a,l;return n}};const P6=["shapechange","heightrangechange","flatheightchange"],dl=new at(0,0),E6=[0,0,0],O6=[0,0,0];function k6(){return this._maskList?(this._maskList.forEach(r=>{r.remove()}),this._maskList=[],this.updateMaskExtent("shapechange"),this):this}function I6(r){const t=this.getMap(),e=t.getView(),n=t.getFitZoom(r),i=r.getCenter();t.setView({center:i,zoom:n,pitch:0,bearing:0});const o=t.getExtent(),s=io([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t.projViewMatrix);return t.setView(e),{mapExtent:o,projViewMatrix:s}}function R6(){for(let r=0;r<this._maskList.length;r++)if(this._maskList[r].isVisible())return!0;return!1}function D6(r){return class extends r{removeMask(t){if(!this._maskList)return this;if(!t)return k6.call(this),this;const e=Array.isArray(t)?t:[t];for(let n=0;n<e.length;n++){const i=e[n],o=this._maskList.indexOf(i);o>-1&&this._maskList.splice(o,1)}return this.updateMaskExtent("shapechange"),this.fire("removemask",{masks:t}),this}setMask(t){return this.removeMask(null),this._maskList||(this._maskList=[]),Array.isArray(t)?t.forEach(e=>{this._maskList.push(e)}):this._maskList.push(t),this._maskList.forEach(e=>{e._bindLayer(this),e.Qs&&e.Qs()}),this.updateMaskExtent("shapechange"),this.fire("setmask",{masks:t}),this}onAdd(){super.onAdd(),this.updateMaskExtent("shapechange")}getMasks(){return this._maskList||[]}onGeometryEvent(t){if(!t||!t.target)return;const e=t.type;e==="shapechange"&&t.target instanceof fl&&t.target.qs(),t.target instanceof fl&&P6.indexOf(e)>-1&&this.updateMaskExtent(e),super.onGeometryEvent&&super.onGeometryEvent(t)}identifyMask(t,e){if(!this.getMap())return[];if(!this._maskList||!this._maskList.length)return[];const n=tr({},e);n.excludeMasks=!0;const i=this.identifyAtPoint(t,n),o=i.length&&i[0].coordinate;if(o){const s=this._maskList;if(!s)return[];const a=[];for(let l=0;l<s.length;l++){const h=s[l].getMode();!s[l].containsPoint(o)||h!=="color"&&h!=="video"||a.push(s[l])}return a}return[]}remove(){this._maskList&&this._maskList.length&&this._maskList.forEach(t=>{t.remove()}),super.remove()}updateMask(t){const e=this.getMap(),{projViewMatrix:n,mapExtent:i}=I6.call(this,t);dl.x=i.xmin,dl.y=i.ymin;const o=gT(E6,dl,e);dl.x=i.xmax,dl.y=i.ymax;const s=gT(O6,dl,e);return{projViewMatrix:n,extentInWorld:[o[0],o[1],s[0],s[1]]}}updateMaskExtent(t){if(!this._maskList||!this.getMap())return;const e=this.getRenderer();if(e&&!this._maskList.length)return void e._clearMask();if(e&&!R6.call(this))return e._deleteMaskUniforms(),void e.setToRedraw();const n=this.getMaskExtent();if(!n)return;const{extent:i,ratio:o,minHeight:s}=n;if(t||!this.tn||!this.tn){const{projViewMatrix:a,extentInWorld:l}=this.updateMask(i);this.tn=a,this.en=l}e?e.setMask(this.en,this.tn,o,s):this.once("renderercreate",a=>{a.renderer.setMask(this.en,this.tn,o,s)})}getMaskExtent(){let t=1/0,e=1/0,n=-1/0,i=-1/0,o=-1/0,s=1/0,a=!1;const l=this.getMap().getExtent();for(let c=0;c<this._maskList.length;c++){const f=this._maskList[c];if(!f.isVisible())continue;const d=f.getExtent();if(d&&l.intersects(d)&&(a=!0,d.xmin<t&&(t=d.xmin),d.ymin<e&&(e=d.ymin),d.xmax>n&&(n=d.xmax),d.ymax>i&&(i=d.ymax),f.sn)){const p=f.sn();p[0]<s&&(s=p[0]),p[1]>o&&(o=p[1])}}if(!a)return null;const{ratio:h,minHeight:u}=function(c,f){const d=c===1/0?0:c,p=f===-1/0?0:f,g=Math.abs(p-d);return g===0?{ratio:1,minHeight:0}:{ratio:Math.pow(g,-1),minHeight:d}}(s,o);return{extent:new gn(t,e,n,i),ratio:h,minHeight:u}}}}function gT(r,t,e,n=0){if(!(e&&t instanceof at))return null;const i=e.coordinateToPointAtRes(t,e.getGLRes());return r[0]=i.x,r[1]=i.y,r[2]=n,r}const F6=new at(0,0),L6=new at(0,0),du=new W(0,0),mT=[],q0={tileGrids:[],count:0},z6="01",H6="1";let id=class extends D6(En){constructor(t,e){e&&!e.tileSystem&&(e.type==="cesium"||e.type==="cesium-ion"?e.tileSystem=[1,1,-180,-90]:e.type==="tianditu"&&(e.tileSystem=[1,-1,-180,90])),super(t,e)}getTileUrl(t,e,n){let i=super.getTileUrl(t,e,n);return this.options.type==="mapbox"&&this.options.requireSkuToken&&(this.nn||(this.nn=this.rn()),i.indexOf("?")>-1?i+="&sku="+this.nn:i+="?sku="+this.nn),i}getMaxAvailableZoom(){return this.getSpatialReference().getMaxZoom()}rn(){let t="";for(let e=0;e<10;e++)t+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return[H6,z6,t].join("")}setSkinLayers(t){this.hn=t;const e=this.getRenderer();e&&(e.clear(),e.setToRedraw())}getSkinTiles(t){const e=this.getRenderer();if(!e)return q0;const n=e.getTileGridsInCurrentFrame().tileGrids[0];if(!n)return q0;const i=t.getId(),o=this._getTileConfig().tileSystem.scale,s=t.getTileSize().width,a=n.tiles;if(!a.length)return q0;const l=this.getMap(),h=n.parents||mT,u=h.length,c=h.concat(a),f=t.getSpatialReference(),d=a[0].extent2d.getWidth(),p=o.x,g=o.y,m=[],y=[],x=new Set,v=this._getTileConfig().tileSystem.scale.y;for(let _=0;_<c.length;_++){const w=c[_],{res:b}=w;let A=w.nw;A||(A=w.nw=l.pointAtResToCoord(w.extent2d.getMin(du),w.res));const{res:T,zoom:S}=V0(f,w.z,b),M=T/b,E=j0(T,s,b,d),{extent2d:P,offset:k}=w,O=E*w.x,I=E*w.y;if(w.skinTileIds||(w.skinTileIds={}),!w.skinTileIds[i]){const z=new Set,L=[],$=nT(t,w.x,w.y,S,A,k,g,E,0);for(let Z=0;Z<$.length;Z++){const j=$[Z];if(z.has(j.id))continue;j.idx=j.x,j.idy=j.y,j.res=T,j.url=t.getTileUrl(j.x,j.y,j.z+t.options.zoomOffset);const st=p*(j.x-O)*s,lt=g*(j.skinY-I)*s,rt=P.xmin*M+st,Rt=P.ymax*M+lt,Ht=P.ymin*M+lt;j.extent2d=v>0?new Ce(rt,Ht,rt+s,Ht+s):new Ce(rt,Rt-s,rt+s,Rt),z.add(j.id),L.push(j)}w.skinTileIds[i]=L}const D=w.skinTileIds[i];for(let z=0;z<D.length;z++)x.has(D[z].id)||(_<u?m.push(D[z]):y.push(D[z]),x.add(D[z].id))}return{tileGrids:[{extent:n.extent,tiles:y,parents:m,count:y.length}],count:y.length}}getSkinLayer(t){return this.getSkinLayers()[t]}getSkinLayers(){return this.hn||mT}getSkinCount(){return this.hn&&this.hn.length||0}queryTerrainByProjCoord(t,e){e=e||[];const n=this.getRenderer();if(!n)return e[0]=null,e[1]=0,e;const i=this.getMap(),o=n.Ls(t);if(!o)return e[0]=null,e[1]=0,e;const s=i._prjToPointAtRes(t,1,du);return n.Es(e,o.id,o,s,1)}queryTileTerrainByProjCoord(t,e,n,i){i=i||[];const o=this.getRenderer();if(!o)return i[0]=null,i[1]=0,i;const s=this.getMap()._prjToPointAtRes(t,1,du);return o.Es(i,e,n,s,1)}queryTileTerrainByPointAtRes(t,e,n,i,o){o=o||[];const s=this.getRenderer();return s?s.Es(o,n,i,t,e):(o[0]=null,o[1]=0,o)}queryTerrain(t,e){if(e=e||[],!this.getRenderer())return e[0]=null,e[1]=0,e;const n=this.getMap().getProjection().project(t,F6);return this.queryTerrainByProjCoord(n,e)}queryTileMesh(t,e){const n=this.getRenderer();n&&n.an(t,e)}getTerrainTiles(t){const{x:e,y:n,z:i,res:o,offset:s}=t,a=t.extent2d.getWidth(),l=this._getTileConfig(),h=this.getSpatialReference(),{res:u,zoom:c}=V0(h,i,o),f=this.getTileSize().width,d=j0(u,f,o,a);let p=t.nw;p||(p=t.nw=this.getMap().pointAtResToCoord(t.extent2d.getMin(du),t.res));const g=eT(this,e,n,c,p,s,l.tileSystem.scale.y,d,1)[0];for(let m=0;m<g.length;m++){const{x:y,y:x}=g[m],v=l.getTilePointNW(y,x,u,du);g[m].res=u,g[m].extent2d=new Ce(v.x,v.y,v.x+f,v.y-f)}return g}isTerrainTileLoaded(t){const e=this.getRenderer();return!!e&&e.isTileCached(t)}updateMaterial(t){if(!t)return;this.options.material||(this.options.material={}),tr(this.options.material,t);const e=this.getRenderer();e&&e.updateMaterial(t)}setMaterial(t){if(!t)return;this.options.material=t;const e=this.getRenderer();e&&e.setMaterial(t)}Os(t,e,n,i,o,s,a,l,h,u){const c=this.getMap(),f=this.options.zoomOffset;h||(h=this._getTileConfig().getTilePrjExtent(t,e,s).convertTo(p=>c._prjToPointAtRes(p,s,L6)));const d=this._getTileOffset(n);return{parent:l,layer:this.getId(),x:t,y:e,z:n,idx:i,idy:o,res:s,extent2d:h,id:u||this._getTileId(t,e,n),url:this.getTileUrl(t,e,n+f),offset:d,error:a,children:[]}}};id.mergeOptions({forceRenderOnMoving:!0,forceRenderOnZooming:!0,forceRenderOnRotating:!0,fadeAnimation:!1,fadeDuration:1e3/60*15,tileLimitPerFrame:2,newTerrainTileRenderLimitPerFrameOnInteracting:1,opacity:1,renderer:"gl",pyramidMode:1,tileSize:256,terrainWidth:65,backZoomOffset:0,depthMask:!0,blendSrc:"one",blendDst:"one minus src alpha",requireSkuToken:!0,cesiumIonTokenURL:"https://api.cesium.com/v1/assets/1/endpoint?access_token=",tileRetryCount:0,shader:"default",terrainTileMode:!0,tempTileCacheSize:64,tileStackStartDepth:7,tileStackDepth:6,currentTilesFirst:!1,exaggeration:1,colors:[]}),id.registerJSONType("TerrainLayer"),id.registerRenderer("gl",v6);const yT=[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],od=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],ho=[],vT=[],N6=[],B6=[],J0=[],j6=[],V6=[],G6=[],K0=new W(0,0),U6=[],$6=[],W6=[],Z6=[],xT=[],_T=[],bT=[],X6=[],Y6=[],q6=[],wT=[];let AT=class{constructor(t,e,n={}){this.setFromPoint(t),this.setToPoint(e),this.ln=n,this.cn={},this.un=0}setFromPoint(t){this.dn=this.gn(t),this.mn()}setToPoint(t){this.pn=this.gn(t),this.mn()}setOptions(t){this.ln=t}mn(){this.cn={},this.un++}test(t,e){const n=[];for(let i=0;i<t.length;i++){const o=t[i],s=o.uuid+"-"+o.version+"-"+o.geometry.version+"-"+this.un;if(this.cn[s]){n.push(this.cn[s]);continue}if(!this.wn(o.getBoundingBox(),e))continue;const a=o.localTransform,l=o.geometry,h=l.data[l.desc.positionAttribute].array,u=l.data[l.desc.altitudeAttribute]&&l.data[l.desc.altitudeAttribute].array||U6,c=l.indices;if(!h||!c){console.warn("there are no POSITION or inidces in mesh");continue}const f=qt(Z6,a,o.positionMatrix),d=this.vn(o,e,h,u,c,l.desc.positionSize,f);if(d){const p={mesh:o,coordinates:d};n.push(p),this.cn[s]=p}}return n}vn(t,e,n,i,o,s,a){const l=sd(e,this.dn.x,this.dn.y,this.dn.z),h=sd(e,this.pn.x,this.pn.y,this.pn.z),u=Pe(N6,l,h),c=[];for(let f=0;f<o.length&&!(f>t.properties.skirtOffset);f+=3){const d=o[f],p=o[f+1],g=o[f+2],m=ie(xT,n[d*s],n[d*s+1],n[d*s+2]),y=this._n(j6,e,m,i[d]/100,a),x=ie(_T,n[p*s],n[p*s+1],n[p*s+2]),v=this._n(V6,e,x,i[p]/100,a),_=ie(bT,n[g*s],n[g*s+1],n[g*s+2]),w=this._n(G6,e,_,i[g]/100,a),b=ie(vT,y,v,w),A=Co($6,y,v),T=Co(W6,y,w),S=this.yn(wT,b,u);if(S){if(!S[0]||!S[1])continue;const M=e.pointAtResToAltitude(S[2],e.getGLRes());K0.x=S[0],K0.y=S[1];const E=e.pointAtResToCoordinate(K0,e.getGLRes());E.z=M,c.push({coordinate:E,indices:[d,p,g],normal:Ys([],A,T)})}}return c.length?c:null}_n(t,e,n,i,o){let s;return Jr.isNumber(i)?(s=e.altitudeToPoint(i,e.getGLRes()),Tr(t,n[0],n[1],0,1),ss(t,t,o),t[2]=s):(s=n[2],Tr(t,n[0],n[1],s,1),ss(t,t,o)),t}yn(t,e,n){const i=e[0],o=e[1],s=e[2],a=n[0],l=n[1],h=a[0],u=a[1],c=a[2],f=l[0]-a[0],d=l[1]-a[1],p=l[2]-a[2];let g=0,m=0,y=0;i[0]===o[0]&&i[0]===s[0]?g=1:i[1]===o[1]&&i[1]===s[1]?m=1:i[2]===o[2]&&i[2]===s[2]?y=1:(g=(e[2][1]-e[0][1])*(e[2][2]-e[0][2])-(e[1][2]-e[0][2])*(e[2][1]-e[0][1]),m=(e[2][0]-e[0][0])*(e[1][2]-e[0][2])-(e[1][0]-e[0][0])*(e[2][2]-e[0][2]),y=(e[1][0]-e[0][0])*(e[2][1]-e[0][1])-(e[2][0]-e[0][0])*(e[1][1]-e[0][1]));const x=-(g*e[0][0]+m*e[0][1]+y*e[0][2]),v=g*f+m*d+y*p;if(v===0)return null;const _=-(g*h+m*u+y*c+x)/v,w=f*_+h,b=d*_+u,A=p*_+c,T=ie(B6,w,b,A);return this.bn(e,T)&&(this.ln.allowPointNotOnLine||this.xn(n,T))?ie(t,w,b,A):null}bn(t,e){const n=this.ln.tolerance||1;if(!this.Mn(t,e))return!1;const i=t[0],o=t[1],s=t[2],a=e;i[2]=o[2]=s[2]=a[2]=0;const l=this.Ks(i,o,s),h=this.Ks(a,i,o),u=this.Ks(a,i,s),c=this.Ks(a,o,s);return!(Math.abs(h+u+c-l)>n)}Mn(t,e){const n=this.ln.tolerance||1,i=t[0],o=t[1],s=t[2],a=Q0(i,o,s,0)-n,l=Q0(i,o,s,1)-n,h=Q0(i,o,s,2)-n,u=ty(i,o,s,0)+n,c=ty(i,o,s,1)+n,f=ty(i,o,s,2)+n;return e[0]>=a&&e[0]<=u&&e[1]>=l&&e[1]<=c&&e[2]>=h&&e[2]<=f}xn(t,e){const n=this.ln.tolerance||1,i=t[0],o=t[1],s=e,a=Wa(Co(J0,i,o)),l=Wa(Co(J0,i,s)),h=Wa(Co(J0,o,s));return!(Math.abs(l+h-a)>n)}Ks(t,e,n){const i=Co(X6,e,t),o=Co(Y6,n,t),s=Ys(q6,i,o);return .5*Wa(s)}gn(t){return t instanceof at?t:Array.isArray(t)?new at(t):null}wn(t,e){const n=[sd(e,this.dn.x,this.dn.y,this.dn.z),sd(e,this.pn.x,this.pn.y,this.pn.z)],i=t[0],o=t[1];for(let s=0;s<yT.length;s+=3)for(let a=0;a<3;a++){const l=s+a;ho[l]=yT[l]>0?o[a]:i[a]}for(let s=0;s<od.length;s+=3){const a=od[s],l=od[s+1],h=od[s+2],u=ie(xT,ho[3*a],ho[3*a+1],ho[3*a+2]),c=ie(_T,ho[3*l],ho[3*l+1],ho[3*l+2]),f=ie(bT,ho[3*h],ho[3*h+1],ho[3*h+2]),d=ie(vT,u,c,f);if(this.yn(wT,d,n))return!0}return!1}};const TT=new at(0,0);function sd(r,t,e,n){if(!r)return null;TT.set(t,e);const i=r.coordinateToPointAtRes(TT,r.getGLRes()),o=r.altitudeToPoint(n||0,r.getGLRes());return[i.x,i.y,o]}function Q0(r,t,e,n){let i=r[n];return i>t[n]&&(i=t[n]),i>e[n]&&(i=e[n]),i}function ty(r,t,e,n){let i=r[n];return i<t[n]&&(i=t[n]),i<e[n]&&(i=e[n]),i}const ey=()=>{},J6=new at(0,0),K6=new at(0,0),Q6=[0,0,0],pu=[0,0,0],pl=[0,0,0,1],gl=[0,0,0,1];let gu=class v1 extends Rr{static fromJSON(t){if(!t||t.type!=="GroupGLLayer")return null;const e=t.layers.map(n=>Rr.fromJSON(n));return new v1(t.id,e,t.options)}constructor(t,e,n){super(t,n),this.layers=e&&e.slice()||[],this.layers.forEach(i=>{if(i.getMap())throw new Error(`layer(${i.getId()} is already added on map`)}),this.Sn(),this.sortLayersByZIndex(),this.Cn={}}sortLayersByZIndex(){if(this.layers&&this.layers.length){for(let t=0,e=this.layers.length;t<e;t++)this.layers[t].__group_gl_order=t;this.layers.sort(ez)}}setSceneConfig(t){this.options.sceneConfig=t;const e=this.getRenderer();return e&&e.updateSceneConfig(),this}getSceneConfig(){return JSON.parse(JSON.stringify(this.u()))}u(){return this.options.sceneConfig||{}}getGroundConfig(){return this.u().ground}getWeatherConfig(){return this.u().weather}addLayer(t,e){if(t.getMap())throw new Error(`layer(${t.getId()}) is already added on map`);if(t.options.renderer!=="gl")throw new Error(`layer(${t.getId()})'s renderer is canvas, not supported to be added to GroupGLLayer`);e===void 0?this.layers.push(t):this.layers.splice(e,0,t),this.Sn(),this.sortLayersByZIndex();const n=this.getRenderer();return n?(this.Tn(t),this.kn(),n.setToRedraw(),this):this}removeLayer(t){Jr.isString(t)&&(t=this.getChildLayer(t));const e=this.layers.indexOf(t);if(e<0)return this;const n=t.getRenderer();n&&n.setTerrainHelper&&n.setTerrainHelper(null),t._doRemove(),this.An(t),delete this.Cn[t.getId()],this.layers.splice(e,1);const i=this.getRenderer();return i?(this.kn(),i.setToRedraw(),this):this}clearLayers(){const t=this.getLayers();for(let e=0;e<t.length;e++)t[e]&&t[e].remove();return this}Oi(){let t=0;for(let n=0;n<this.layers.length;n++){const i=this.layers[n];i.setPolygonOffset&&i.getPolygonOffsetCount&&(t+=i.getPolygonOffsetCount())}let e=0;for(let n=this.layers.length-1;n>=0;n--){const i=this.layers[n];i.setPolygonOffset&&i.getPolygonOffsetCount&&(i.setPolygonOffset(e,t),e+=i.getPolygonOffsetCount())}this.On=e}getPolygonOffsetCount(){return this.On}getLayers(){return this.layers.slice()}fe(){return this.layers}toJSON(){const t=[];if(this.layers)for(let e=0;e<this.layers.length;e++){const n=this.layers[e];n&&n&&n.toJSON&&t.push(n.toJSON())}return{type:this.getJSONType(),id:this.getId(),layers:t,options:this.config()}}onLoadEnd(){this.layers.forEach(t=>{this.Tn(t)}),this.options.terrain&&this.In(),super.onLoadEnd()}Tn(t){const e=this.getMap();this.Cn[t.getId()]=t,t._canvas=this.getRenderer().canvas,t._bindMap(e),t.once("renderercreate",this.Ln,this),t.remove=()=>(this.removeLayer(t),t.constructor.prototype.remove.call(t),delete t.remove,this),t.load(),this.En(t)}onRemove(){this.Rn(),this.layers.forEach(t=>{this.Fn(t),t._doRemove(),this.An(t)}),this.Cn={},this.clearAnalysis(),super.onRemove()}getChildLayer(t){return this.Cn[t]||null}getLayer(t){return this.getChildLayer(t)}En(t){t.on("show hide",this.Pn,this),t.on("idchange",this.Hn,this)}An(t){t.off("show hide",this.Pn,this),t.off("idchange",this.Hn,this)}Pn(){const t=this.getRenderer();t&&t.setToRedraw()}Hn(t){const e=t.new,n=t.old,i=this.getLayer(n);delete this.Cn[n],this.Cn[e]=i}Ln(t){t.renderer.clearCanvas=tz}Sn(){const t={};this.layers.forEach(e=>{const n=e.getId();if(t[n])throw new Error(`Duplicate child layer id (${n}) in the GroupGLLayer (${this.getId()})`);t[n]=1})}addAnalysis(t){this.yi=this.yi||[],this.yi.push(t);const e=this.getRenderer();e&&e.setToRedraw()}removeAnalysis(t){if(this.yi){const n=this.yi.indexOf(t);n>-1&&(this.yi.splice(n,1),t.remove())}const e=this.getRenderer();e&&e.setToRedraw()}clearAnalysis(){this.yi&&(this.yi.forEach(e=>{e.remove()}),this.yi=[]);const t=this.getRenderer();t&&t.setToRedraw()}identify(t,e){const n=this.getMap(),i=this.getRenderer();if(!n||!i)return[];const o=n.coordToContainerPoint(new at(t));return this.identifyAtPoint(o,e)}identifyAtPoint(t,e={}){const n=e.includeInternals,i=this.getLayers(),o=e&&e.childLayers||i,s=this.getMap();if(!s)return[];const a=al(e.count)?1:e.count;let l=[];for(let h=o.length-1;h>=0;h--){const u=o[h];if(i.indexOf(u)<0||!u.identifyAtPoint)continue;const c=u.options.geometryEvents;if(n&&(c===void 0||c===!1||c===0)||u.isGeometryListening&&n&&e.eventTypes.indexOf("mousemove")>=0&&!u.isGeometryListening(e.eventTypes))continue;const f=u.identifyAtPoint(t,e);if(!f||!f.length)continue;const d=u.getId();for(let p=0;p<f.length;p++)f[p]&&(f[p].layer=d);l.push(...f)}if(e.orderByCamera){const h=s.cameraPosition;l.sort((u,c)=>c.point?u.point?qa(u.point,h)-qa(c.point,h):1:-1)}return a&&(l=l.slice(0,a)),l}getTerrain(){return this.options.terrain}setTerrain(t){return this.options.terrain=t,this.getRenderer()?(this.In(),this.getMap().updateCenterAltitude(),this):this}removeTerrain(){return this.setTerrain(null)}updateTerrainMaterial(t){this.Dn&&t&&(this.options.terrain.material?tr(this.options.terrain.material,t):this.options.terrain.material=t,this.Dn.updateMaterial(t))}In(){const t=this.getRenderer();t&&t.setToRedraw();const e=this.options.terrain;if(this.Dn){const o=this.Dn,s=o.options;if(e&&s.urlTemplate===e.urlTemplate&&s.spatialReference===e.spatialReference){for(const a in e)a==="material"?o.setMaterial(e[a]):a!=="urlTemplate"&&a!=="spatialReference"&&o.config(a,e[a]);return this}this.Rn()}if(this.Gn(),!e)return this;this.Dn=new id("__terrain_in_group",e),this.kn();const n=this.Dn;n.on("tileload",this.Nn,this),this.Tn(n);const i=e.masks;return i&&i.length?n.setMask(i):n.removeMask(),this.fire("terrainlayercreated"),this}queryTerrain(t,e){return this.Dn?this.Dn.queryTerrain(t,e):(e&&(e[0]=null,e[1]=0),[null,0])}queryTerrainAtPoint(t,e={}){if(!this.Dn)return null;const n=this.getMap(),i=n.getGLRes(),o=n.width/2||1,s=n.height/2||1,a=t;ie(pu,(a.x-o)/o,(s-a.y)/s,0),ie(pl,pu[0],pu[1],0),ie(gl,pu[0],pu[1],.5),pl[3]=gl[3]=1,MT(pl,pl,n.projViewMatrixInverse),MT(gl,gl,n.projViewMatrixInverse);const l=new W(pl.slice(0,3)),h=new W(gl.slice(0,3)),u=n.pointAtResToCoordinate(l,i,J6);u.z=pl[2]/n.altitudeToPoint(1,i);const c=n.pointAtResToCoordinate(h,i,K6);c.z=gl[2]/n.altitudeToPoint(1,i),this.jn?(this.jn.setFromPoint(u),this.jn.setToPoint(c)):(e.allowPointNotOnLine=!0,this.jn=new AT(u,c,e));const f=this.Dn.getRenderer().getAnalysisMeshes(),d=this.jn.test(f,n),p=[],g=ie(Q6,u.x,u.y,u.z);return d.forEach(m=>{m.coordinates.forEach(y=>{p.push(y.coordinate)})}),p.sort((m,y)=>qa(m.toArray(),g)-qa(y.toArray(),g)),p[0]}queryTerrainByProjCoord(t,e){return this.Dn?this.Dn.queryTerrainByProjCoord(t,e):(e&&(e[0]=null,e[1]=0),[null,0])}kn(){if(!this.Dn)return;const t=this.layers,e=[];for(let n=0;n<t.length;n++){if(!t[n])continue;const i=t[n],o=i.getRenderer();if(o.renderTerrainSkin){if(o.deleteTile===ey){e.push(t[n]);continue}i.getTiles=()=>this.Dn.getSkinTiles(i),o.drawTileOnTerrain?o.drawTile=(...s)=>o.drawTileOnTerrain(...s):o.drawTile=ey,o.deleteTile=ey,e.push(t[n])}o.setTerrainHelper&&o.setTerrainHelper(this.Dn)}this.Dn.setSkinLayers(e)}Fn(t){if(!function(n){if(!n)return!1;const i=n.getRenderer();return i?!!i.renderTerrainSkin:!1}(t))return;const e=t.getRenderer();e&&(e.setTerrainHelper&&e.setTerrainHelper(null),e.clear&&e.clear(),delete e.drawTile,delete e.deleteTile),delete t.getTiles}Gn(){const t=this.layers;for(let e=0;e<t.length;e++)t[e]&&this.Fn(t[e])}Nn(){const t=this.getRenderer();t&&t.setToRedraw()}Rn(){if(this.Dn){const t=this.Dn;t.off("tileload",this.Nn,this),this.An(t),this.Dn._doRemove(),delete this.Dn,this.fire("terrainlayerremoved")}}getTerrainLayer(){return this.Dn}_bindMap(...t){if(this.options.single){const e=t[0].getLayers();for(let n=0;n<e.length;n++)if(e[n]instanceof v1)throw new Error("Only one GroupGLLayer is allowed in a map instance. Set options.single to false if you want to add two or more GroupGLLayers.")}return super._bindMap(...t)}fire(...t){if(t[0]==="layerload"){const e=this.fe();for(const n of e){const i=n.getRenderer();i&&i.isRenderComplete()&&n.fire("layerload")}}super.fire(...t)}};function tz(){}function ez(r,t){const e=r.getZIndex()-t.getZIndex();return e===0?r.__group_gl_order-t.__group_gl_order:e}function MT(r,t,e){const n=t[0],i=t[1],o=t[2],s=1/(e[3]*n+e[7]*i+e[11]*o+e[15]);return r[0]=(e[0]*n+e[4]*i+e[8]*o+e[12])*s,r[1]=(e[1]*n+e[5]*i+e[9]*o+e[13])*s,r[2]=(e[2]*n+e[6]*i+e[10]*o+e[14])*s,r}var ST;gu.mergeOptions({renderer:"gl",antialias:!0,extensions:[],single:!0,onlyWebGL1:!1,optionalExtensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","EXT_frag_depth","EXT_texture_filter_anisotropic","WEBGL_compressed_texture_astc","WEBGL_compressed_texture_etc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_compressed_texture_s3tc_srgb"],forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,viewMoveThreshold:100,geometryEvents:!0,multiSamples:4,forceRedrawPerFrame:!1}),gu.registerJSONType("GroupGLLayer"),gu.registerRenderer("gl",r6),gu.registerRenderer("canvas",null),function(r){r[r.AMBIENT=0]="AMBIENT",r[r.REALISTIC=1]="REALISTIC"}(ST||(ST={}));let nz=class{constructor(t){this.Bn=t,this.B=new Of,this.onHDRLoaded=this.Un.bind(this),this.onHDRError=this.zn.bind(this)}getDirectionalLight(){return this.zt&&this.zt.directional||{}}getAmbientLight(){return this.zt&&this.zt.ambient||{}}getAmbientResource(){return this.Vn}setConfig(t){const e=this.zt;this.Wn=t.urlModifier,this.zt=JSON.parse(JSON.stringify(t));let n=!1;if(t&&t.ambient&&t.ambient.resource){if(!(e&&e.ambient&&function(i,o){return!(!i.resource||i.resource.url!==o.resource.url)}(e.ambient,t.ambient)))return void this.qn();this.Vn&&(t.ambient.prefilterCubeSize!==e.ambient&&e.ambient.prefilterCubeSize&&this.Un(),n=!0,t.ambient.resource.sh&&(this.Vn.sh=t.ambient.resource.sh))}else this.$n(),n=e&&e.ambient&&e.ambient.resource;this.Bn.fire("updatelights",{ambientUpdate:n})}Yn(t){const e=t.getLayers();for(let o=0;o<e.length;o++){const s=e[o]&&e[o].getRenderer();if(s&&s.regl)return s.regl}const n=document.createElement("canvas"),i=Xh({canvas:n,attributes:{depth:!1,stencil:!1,alpha:!1}});return i.Xn=!0,i}qn(){const t=this.zt.ambient.resource,e=t&&t.url;if(!e)return;const n=[];let i=0,o=0;const s=()=>{o++,o>=i&&this.Jn(n)},a=function(){throw new Error(`skybox image with url(${this.src}) failed to load, please check the image's url.`)},l=this.Wn;if(e.top||e.nx){const{front:h,back:u,right:c,left:f,top:d,bottom:p}=e,{nx:g,ny:m,px:y,py:x,nz:v,pz:_}=e;let w;w=h?[f,c,u,h,d,p]:[g,y,v,_,x,m],i=w.length;for(let b=0;b<i;b++){const A=new Image;A.onload=s,A.onerror=a,A.src=l&&l(w[b])||w[b],n[b]=A}}else{const h={url:t.url,arrayBuffer:!0,hdr:!0,flipY:!0};this.B.setURLModifier(l),this.Zn=new If(h,this.B),this.Zn.once("complete",this.onHDRLoaded),this.Zn.once("error",this.onHDRError)}}dispose(){this.$n()}Un(){this.Zn&&(this.Vn=this.Kn(this.Zn),this.Bn.fire("updatelights",{ambientUpdate:!0}))}zn(){this.Bn.fire("hdrerror")}Jn(t){this.Vn=this.Kn(t),this.Bn.fire("updatelights",{ambientUpdate:!0})}Kn(t){const e=this.zt.ambient.resource,n=e.prefilterCubeSize||128,i=this.Yn(this.Bn),o=Qn.PBRHelper.createIBLMaps(i,{envTexture:Array.isArray(t)?t:t.getREGLTexture(i),rgbmRange:Array.isArray(t)?9:t.rgbmRange,ignoreSH:!!e.sh,envCubeSize:n,prefilterCubeSize:n,format:"array"});if(e.sh&&(o.sh=e.sh,Array.isArray(o.sh[0]))){const s=o.sh,a=[];for(let l=0;l<s.length;l++)a.push(...s[l]);o.sh=a}return i.Xn&&(delete this.Zn,i.destroy()),o}$n(){this.Zn&&(this.Zn.dispose(),delete this.Zn),delete this.Vn}},Ei,ml,CT,PT,ny;xe.include({setLights(r){return this.options.lights=r,this.Qn(),this},getLights(){return this.options.lights},Qn(){this.tr||(this.tr=new nz(this)),this.tr.setConfig(this.getLights())},getLightManager(){return this.tr?this.tr:(this.ir||(this.ir=!0,console.warn("map's light config is not set, use map.setLights(config) to set lights.")),null)}}),xe.addOnLoadHook(function(){this.options.lights&&this.Qn()});const rz={color:[0,0,0,0]},ry={enable:!1};xe.include({setPostProcessConfig(r){return this.options.postProcessConfig=r,this},getPostProcessConfig(){return this.options.postProcessConfig}});const iz=So.MapCanvasRenderer.prototype.drawLayerCanvas;So.MapCanvasRenderer.prototype.drawLayerCanvas=function(){const r=iz.apply(this,arguments);return r&&function(t,e){const n=t.map.getPostProcessConfig();if(!n||!n.enable)return;Ei||(i=e.width,o=e.height,Ei=document.createElement("canvas",i,o),ml=Xh({canvas:Ei,attributes:{depth:!1,stencil:!1,alpha:!0,antialias:!1,premultipliedAlpha:!1}}),CT=ml.texture({mag:"linear",min:"linear",mipmap:!1,flipY:!0,width:i,height:o}),PT=ml.texture());var i,o;Ei.width===e.width&&Ei.height===e.height||(Ei.width=e.width,Ei.height=e.height),ml.clear(rz);const s=n.filmicGrain||ry;s.enable===void 0&&(s.enable=!0);const a=n.vignette||ry;a.enable===void 0&&(a.enable=!0);const l=n.colorLUT||ry;l.enable===void 0&&(l.enable=!0),t.er||(t.er={});const h=t.er;if(l.enable){const c=l.lut;if(!h.lutTexture||h.lutTexture.url!==c){const f=new Image;f.onload=function(){const d={data:f,min:"linear",mag:"linear"},p=h.lutTexture?h.lutTexture.texture(d):ml.texture(d);h.lutTexture={url:c,texture:p},t.setLayerCanvasUpdated()},f.src=c}}const u={enableGrain:+!!s.enable,grainFactor:s.factor===void 0?.15:s.factor,timeGrain:performance.now(),enableVignette:+!!a.enable,lensRadius:a.lensRadius||[.8,.25],frameMod:1,enableLut:+!!l.enable,lookupTable:h.lutTexture?h.lutTexture.texture:PT};ny||(ny=new YA(ml)),ny.postprocess(null,u,CT({width:Ei.width,height:Ei.height,data:e,flipY:!0,mag:"linear",min:"linear",mipmap:!1})),s.enable&&t.setLayerCanvasUpdated(),t.context.drawImage(Ei,0,0,Ei.width,Ei.height)}(this,this.canvas),r};const oz=So.MapCanvasRenderer.prototype.renderFrame;So.MapCanvasRenderer.prototype.renderFrame=function(){const r=oz.apply(this,arguments),t=this.map.getPostProcessConfig(),e=t&&t.filmicGrain;return!e||e.enable!==void 0&&e.enable!==!0||this.setLayerCanvasUpdated(),r};const sz=[];function ET(r){r.properties.showOnlyTimestamp&&(delete r.properties.showOnlyTimestamp,iy(r))}function OT(r,t){const e=r.geometry.properties;e.oldElementsBeforeHighlight||(e.oldElementsBeforeHighlight=r.geometry.elements),e.elements&&(e.oldElementsArrBeforeHighlight||(e.oldElementsArrBeforeHighlight=e.elements),e.elements=t)}function iy(r){const t=r.geometry.properties.oldElementsBeforeHighlight;t&&r.geometry.elements!==t&&(r.geometry.deleteElements(),r.geometry.setElements(r.geometry.properties.oldElementsBeforeHighlight),r.geometry.properties.oldElementsArrBeforeHighlight&&(r.geometry.properties.elements=r.geometry.properties.oldElementsArrBeforeHighlight,delete r.geometry.properties.oldElementsArrBeforeHighlight),delete r.geometry.properties.hasInvisible,delete r.geometry.properties.oldElementsBeforeHighlight)}function kT(r){if(!r.properties.highlightTimestamp)return;const t=r.defines;delete t.HAS_HIGHLIGHT_COLOR,delete t.HAS_HIGHLIGHT_OPACITY,r.setDefines(t),delete r.properties.highlightTimestamp,iy(r),oy(r)}function oy(r){if(!r)return;const{hlBloomMesh:t}=r.properties;if(t){const e=t.geometry;e.elements&&e.elements.destroy&&e.deleteElements(),t.dispose(),delete r.properties.hlBloomMesh}}var sy=Object.freeze({__proto__:null,clearHighlight:kT,clearShowOnly:ET,deleteHighlightBloomMesh:oy,highlightMesh:function(r,t,e,n,i){const{highlightTimestamp:o}=t.properties;if(!e)return void(o&&kT(t));if(n===o)return;const s=t.geometry.getVertexCount();let{aHighlightColor:a,aHighlightOpacity:l}=t.geometry.properties;a&&a.fill(0),l&&l.fill(255);let h=!1,u=!1;const c=e.keys();let f=null,d=null;for(const m of c)if(i.has(m)){const y=e.get(m),{color:x,bloom:v,visible:_}=y;let w,{opacity:b}=y;if(x&&(h||(a||(a=new Uint8Array(4*s)),h=!0),w=pL(sz,x)),b=al(b)?1:b,b<1&&(u||(l||(l=new Uint8Array(s),l.fill(255)),u=!0)),_===!1&&(d||(d=new Set),d.add(m)),w||b<1||v){const A=i.get(m);if(A)for(let T=0;T<A.length;T++){const S=A[T];w&&Tr(a.subarray(4*S,4*S+4),...w),b<1&&(l[S]=255*b),v&&(f||(f=[]),f.push(S))}}}const p=t.defines;if(h?(t.geometry.data.aHighlightColor?t.geometry.updateData("aHighlightColor",a):(t.geometry.data.aHighlightColor=a,t.geometry.generateBuffers(r)),t.geometry.properties.aHighlightColor=a,p.HAS_HIGHLIGHT_COLOR=1):p.HAS_HIGHLIGHT_COLOR&&(t.geometry.updateData("aHighlightColor",a),delete p.HAS_HIGHLIGHT_COLOR),u?(t.geometry.data.aHighlightOpacity?t.geometry.updateData("aHighlightOpacity",l):(t.geometry.data.aHighlightOpacity=l,t.geometry.generateBuffers(r)),t.geometry.properties.aHighlightOpacity=l,p.HAS_HIGHLIGHT_OPACITY=1):p.HAS_HIGHLIGHT_OPACITY&&(t.geometry.updateData("aHighlightOpacity",l),delete p.HAS_HIGHLIGHT_OPACITY),d&&d.size>0){let m=[];i.forEach((x,v)=>{d.has(v)||R0(m,x)}),t.geometry.properties.hasInvisible=!0,OT(t,m);const y={data:m,primitive:t.geometry.getPrimitive()};t.geometry.elements!==t.geometry.properties.oldElementsBeforeHighlight&&t.geometry.elements.destroy&&t.geometry.deleteElements(),m=r.elements(y),t.geometry.setElements(m),t.geometry.generateBuffers(r)}else t.geometry.properties.hasInvisible&&iy(t);t.setDefines(p),t.properties.highlightTimestamp=n;let g=t.properties.hlBloomMesh;if(f&&f.length){if(g){const m=io(g.localTransform,t.localTransform),y=io(g.positionMatrix,t.positionMatrix);g.setLocalTransform(m),g.setPositionMatrix(y),t.properties.hlBloomMesh.geometry.setElements(f)}else{const m=new ar(t.geometry.data,f,0,t.geometry.desc);m.generateBuffers(r);const y=t.material;g=new nn(m,y,t.config);const x=t.uniforms;for(const b in x)Object.defineProperty(g.uniforms,b,{enumerable:!0,get:function(){return t.getUniform(b)}});const v=tr({},t.defines);v.HAS_BLOOM=1;const _=io([],t.localTransform),w=io([],t.positionMatrix);g.setLocalTransform(_),g.setPositionMatrix(w),tr(g.properties,t.properties),tr(m.properties,t.geometry.properties),g.setDefines(v),g.bloom=1}t.properties.hlBloomMesh=g}else g&&oy(t)},showOnly:function(r,t,e,n,i){const{showOnlyTimestamp:o}=t.properties;if(!e)return void(o&&ET(t));if(n===o)return;t.properties.showOnlyTimestamp=n;const s=e.keys(),a=[];for(const h of s){if(!i.has(h))continue;const u=i.get(h);u&&R0(a,u)}OT(t,a),t.geometry.elements!==t.geometry.properties.oldElementsBeforeHighlight&&t.geometry.elements.destroy&&t.geometry.deleteElements();const l={data:a,primitive:t.geometry.getPrimitive()};t.geometry.setElements(r.elements(l)),t.geometry.generateBuffers(r)}});const az=[0,0,0,0];let lz=class{constructor(t,e,n,i,o,s){this.renderer=new un(t),this.sceneConfig=e,this.h=n,this.sr=i,this.nr=o,this.On=s||{factor:0,units:0},this.o(),this.rr=[]}render(t,e,n){this.hr();const i=this.h.getMap();this.renderer.regl.clear({color:az,depth:1,stencil:255,framebuffer:this.ar}),this.renderer.render(this.lr,e,t,this.ar);const o=this.h.getRenderer().canvas;this.rr[0]=o.width,this.rr[1]=o.height;const s=tr({colorRamp:this.cr,inputTexture:this.ar,projViewMatrix:i.projViewMatrix,textureOutputSize:this.rr},e);return this.M(),this.renderer.render(this.ur,s,this.N,n)}dispose(){this.lr&&(this.lr.dispose(),delete this.lr),this.ur&&(this.ur.dispose(),delete this.ur),this.k&&(this.k.geometry.dispose(),this.k.dispose(),delete this.k,delete this.N),this.ar&&(this.ar.destroy(),delete this.ar)}dr(){const t=this.sr;let e=this.gr,n=this.mr;n?n.clearRect(0,0,256,1):(e=this.gr=document.createElement("canvas"),e.width=256,e.height=1,n=this.mr=e.getContext("2d"));const i=n.createLinearGradient(0,0,256,1);for(let s=0;s<t.length;s++)i.addColorStop(t[s][0],t[s][1]);n.fillStyle=i,n.fillRect(0,0,256,1),this.cr&&this.cr.destroy();const o=this.renderer.regl;this.cr=o.texture({width:256,height:1,data:e,min:"linear",mag:"linear",premultiplyAlpha:!0})}hr(){const t=this.h.getRenderer().canvas,e=Math.ceil(t.width/4),n=Math.ceil(t.height/4),i=this.ar;i.width===e&&i.height===n||i.resize(e,n)}o(){this.dr(),this.pr(),this.wr(),this._()}_(){const t=new Rf;t.generateBuffers(this.renderer.regl),this.k=new nn(t),this.N=new ur([this.k])}M(){const t=this.h.getMap(),e=ed.getGroundTransform(this.k.localTransform,t);this.k.setLocalTransform(e)}wr(){const t=this.h.getRenderer().canvas,e=this.renderer.regl,n=e.hasExtension("OES_texture_half_float")?"half float":"float",i=Math.ceil(t.width/4),o=Math.ceil(t.height/4),s=e.texture({width:i,height:o,type:n,min:"linear",mag:"linear",format:"rgba"});this.ar=e.framebuffer({width:i,height:o,color:[s]})}pr(){const t=this.h.getRenderer().canvas,e=this.sceneConfig.depthRange,n={viewport:{x:0,y:0,width:()=>t?Math.ceil(t.width/4):1,height:()=>t?Math.ceil(t.height/4):1},depth:{enable:!0,func:"always"}};this.nr&&(n.stencil=this.nr),this.lr=new HD({extraCommandProps:n}),this.ur=new BD({x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1},{extraCommandProps:{stencil:{enable:!1},depth:{enable:!0,range:e||[0,1],func:"<="},polygonOffset:{enable:!0,offset:this.On},scissor:{enable:!1}}})}},ay=class extends fl{constructor(t,e){super(t,e)}We(t){const e=this.Vs(t),n=new nn(e);return this.vr(n),this.Js(n),n}zs(t,e,n){const i=this.$s();t.setUniform("maskMode",i);const o=this.Ys();if(t.setUniform("maskColor",o),Jf(e)){const s=this.sn();s[0]=(s[0]-n)*e,s[1]=(s[1]-n)*e,t.setUniform("heightRange",s)}}setHeightRange(t){this.options.heightRange=t,this._fireEvent("heightrangechange")}getHeightRange(){return this.options.heightRange}sn(){const t=[0,0];return this.options.heightRange&&(t[0]=this.Xs(this.options.heightRange[0]),t[1]=this.Xs(this.options.heightRange[1])),t}vr(t){const e=t.getDefines();e.HAS_MASK_COLOR=1,t.setDefines(e)}},hz=class extends ay{constructor(t,e){super(t,e),this.Bs="clip-inside"}},uz=class extends ay{constructor(t,e){super(t,e),this.Bs="clip-outside"}},ly=class extends fl{constructor(t,e){super(t,e)}setFlatheight(t){this.options.flatHeight=t,this._fireEvent("flatheightchange")}We(t){const e=this.Vs(t),n=new nn(e);return this.vr(n),this.Js(n),n}zs(t){const e=this.$s();t.setUniform("maskMode",e);const n=this.Ys();t.setUniform("maskColor",n);const i=this.Xs(this.options.flatHeight||0);t.setUniform("flatHeight",i)}vr(t){const e=t.getDefines();e.HAS_MASK_FLAT=1,t.setDefines(e)}sn(){const t=[0,this.options.flatHeight];return t[1]=this.Xs(t[1]),t}},cz=class extends ly{constructor(t,e){super(t,e),this.Bs="flat-inside"}},fz=class extends ly{constructor(t,e){super(t,e),this.Bs="flat-outside"}},dz=class extends fl{constructor(t,e){super(t,e),this.Bs="color"}setHeightRange(t){this.options.heightRange=t,this._fireEvent("heightrangechange")}We(t){const e=this.Vs(t),n=new nn(e);return this.vr(n),this.Js(n),n}zs(t,e,n){const i=this.$s();t.setUniform("maskMode",i);const o=this.Ys();if(t.setUniform("maskColor",o),Jf(e)){const s=this.sn();s[0]=(s[0]-n)*e,s[1]=(s[1]-n)*e,t.setUniform("heightRange",s)}}vr(t){const e=t.getDefines();e.HAS_MASK_COLOR=1,t.setDefines(e)}sn(){const t=[0,0];return this.options.heightRange&&(t[0]=this.Xs(this.options.heightRange[0]),t[1]=this.Xs(this.options.heightRange[1])),t}},pz=class extends fl{constructor(t,e){super(t,e),this.Bs="video"}play(){this._r&&this._r.play()}pause(){this._r&&this._r.pause()}setAudio(t){this._r&&(this.video.muted=t)}setUrl(t){this.options.url=t,this.yr(t)}getState(){return this.br}We(t){const e=this.Vs(t),n=new nn(e),i=this.Mr(t);return n.material=new Gr({maskTexture:i}),this.vr(n),this.Js(n),n}zs(t){const e=this.$s();t.setUniform("maskMode",e);const n=this.Ys();t.setUniform("maskColor",n)}vr(t){const e=t.getDefines();e.HAS_VIDEO=1,t.setDefines(e)}Mr(t){return this.yr(),t.texture()}yr(){this.br="stop";const t=this.options.url,e=this.options.elementId;let n=document.getElementById(e);if(t&&(n=document.createElement("video"),n.src=t),!n)throw new Error("there is no element or url setting for video mask");n.autoplay=this.options.autoplay||!0,n.loop=this.options.loop||!0,n.muted=this.options.muted||!0,n.play(),n.addEventListener("playing",()=>{this.br="playing"}),n.addEventListener("pause",()=>{this.br="pause"}),this._r=n}Ue(){const t=this.St;if(t&&t.material){const e=t.material.get("maskTexture");e&&this._r&&this.ze()&&e(this._r)}}ze(){return this.br==="playing"}},gz=class extends ly{constructor(t,e){super(t,e),this.setElevation(e.elevation),this.Bs="elevate"}setElevation(t){this.options.elevation=t,this.setFlatheight(this.options.elevation)}};const mz=new W(0,0),yz=new W(0,0),vz=new W(0,0),fs=new W(0,0);let IT=class extends ay{constructor(t,e){super([],e),this.Sr=t}setPosition(t){this.Sr=t,this.Qs()}getPosition(){return this.Sr}setWidth(t){this.options.width=t,this.Qs()}setLength(t){this.options.length=t,this.Qs()}setHeight(t){this.options.height=t,this.Qs()}setRotation(t){this.options.rotation=t,this.Qs()}Qs(){const t=this.getLayer();if(!t)return;const e=t.getMap();if(e){const{length:n,width:i,height:o}=this.options,s=this.Sr,a=this.options.rotation||0,{coordinates:l,heightRange:h}=this.Cr(e,s,n,i,o,a);this.setCoordinates(l),this.setHeightRange(h)}}Cr(t,e,n,i,o,s){const a=t.getGLRes(),l=t.distanceToPointAtRes(i/2,0,a,mz),h=t.distanceToPointAtRes(0,n/2,a,yz),u=t.coordinateToPointAtRes(e,a,vz),c=u.x-l.x,f=u.x+l.x,d=u.y+h.y,p=u.y-h.y,g=this.Tr([[c,d],[f,d],[f,p],[c,p]],u,s);fs.set(g[0][0],g[0][1]);const m=t.pointAtResToCoordinate(fs,a);fs.set(g[1][0],g[1][1]);const y=t.pointAtResToCoordinate(fs,a);fs.set(g[2][0],g[2][1]);const x=t.pointAtResToCoordinate(fs,a);fs.set(g[3][0],g[3][1]);const v=t.pointAtResToCoordinate(fs,a),_=e.z-o/2,w=[_,e.z+o/2];return{coordinates:[[m.x,m.y,_],[y.x,y.y,_],[x.x,x.y,_],[v.x,v.y,_],[m.x,m.y,_]],heightRange:w}}Tr(t,e,n){for(let i=0;i<t.length;i++)l4(t[i],t[i],[e.x,e.y],n*Math.PI/180);return t}},xz=class extends IT{constructor(t,e){super(t,e),this.Bs="clip-inside"}},_z=class extends IT{constructor(t,e){super(t,e),this.Bs="clip-outside"}};typeof window<"u"&&window.maptalks&&(window.maptalks.GroupGLLayer=gu,window.maptalks.ClipInsideMask=hz,window.maptalks.ClipOutsideMask=uz,window.maptalks.FlatInsideMask=cz,window.maptalks.FlatOutsideMask=fz,window.maptalks.ElevateMask=gz,window.maptalks.ColorMask=dz,window.maptalks.VideoMask=pz,window.maptalks.BoxInsideClipMask=xz,window.maptalks.BoxOutsideClipMask=_z,window.maptalks.RayCaster=AT);const RT=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")},ad=RT(),ds=ad.gl_trans__coders=ad.gl_trans__coders||{};function bz(r){const t=r.toString(),e=t.indexOf("{")+1,n=t.substring(0,e),i=ad.gl_trans__coders=ad.gl_trans__coders||{};let o=`${n}
    const _____getGlobal = ${RT.toString()};
    const g___lobals = _____getGlobal()
    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};`;for(const s in i)s==="inject"||s==="getTranscoder"||s==="registerTranscoder"||(o+='tran_____scoders["'+s+'"] ='+i[s].toString()+`
;`);return o+=`
`+t.substring(n.length),o}ds.inject=bz;function wz(r){return ds[r]}function Az(r,t){ds[r]=t}ds.registerTranscoder=Az,ds.getTranscoder=wz;const ps="${",Tz=`function(e){var n="undefined"!=typeof Float32Array?Float32Array:Array;function t(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}Math.hypot||(Math.hypot=function(){for(var e=0,n=arguments.length;n--;)e+=arguments[n]*arguments[n];return Math.sqrt(e)});function r(){var e=new n(3);return n!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function o(e,t,r){var o=new n(3);return o[0]=e,o[1]=t,o[2]=r,o}function i(e,n){var t=n[0],r=n[1],o=n[2],i=t*t+r*r+o*o;return i>0&&(i=1/Math.sqrt(i)),e[0]=n[0]*i,e[1]=n[1]*i,e[2]=n[2]*i,e}function a(e,n,t){var r=n[0],o=n[1],i=n[2],a=t[0],s=t[1],c=t[2];return e[0]=o*c-i*s,e[1]=i*a-r*c,e[2]=r*s-o*a,e}var s=function(e,n,t){return e[0]=n[0]-t[0],e[1]=n[1]-t[1],e[2]=n[2]-t[2],e};function c(){var e=new n(4);return n!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}r(),function(){var e,t=(e=new n(4),n!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e)}();var f;function l(e,n,t){return e[0]=n,e[1]=t,e}r(),o(1,0,0),o(0,1,0),c(),c(),f=new n(9),n!=Float32Array&&(f[1]=0,f[2]=0,f[3]=0,f[5]=0,f[6]=0,f[7]=0),f[0]=1,f[4]=1,f[8]=1,function(){var e=function(){var e=new n(2);return n!=Float32Array&&(e[0]=0,e[1]=0),e}()}();
/*!
   * @maptalks/gltf-loader v0.98.2
   * LICENSE : UNLICENSED
   * (c) 2016-2024 maptalks.org
   */
let h=0;!function(e){e[0]=0,e[1]=0,e[2]=0,e[3]=1}([]),"undefined"!=typeof TextDecoder&&new TextDecoder("utf-8");const d={get:function(e,n={},t){n||(n={});const r=new AbortController,o=r.signal,i=function(e){for(let n=1;n<arguments.length;n++){const t=arguments[n];for(const n in t)e[n]=t[n]}return e}({},n);i.signal=o,i.method||(i.method="GET"),i.referrerPolicy=i.referrerPolicy||"origin","undefined"==typeof window||i.referrer||(i.referrer=window.location.href),t&&(e=t(e));const a=fetch(e,i).then((e=>{const t=this._(e,n.responseType);return t.message?t:t.then((t=>"arraybuffer"===n.responseType?{data:t,cacheControl:e.headers.get("Cache-Control"),expires:e.headers.get("Expires"),contentType:e.headers.get("Content-Type")}:t)).catch((e=>{if(!e.code||e.code!==DOMException.ABORT_ERR)throw e}))})).catch((e=>{if(!e.code||e.code!==DOMException.ABORT_ERR)throw e}));return a.xhr=r,a},_:(e,n)=>200!==e.status?{status:e.status,statusText:e.statusText,message:\`incorrect http request with status code(${ps}e.status}): ${ps}e.statusText}\`}:"arraybuffer"===n?e.arrayBuffer():"json"===n?e.json():e.text(),getArrayBuffer:(e,n={},t)=>(n||(n={}),n.responseType="arraybuffer",d.get(e,n,t)),getJSON:function(e,n={},t){return n&&n.jsonp?d.jsonp(e):((n=n||{}).responseType="json",d.get(e,n,t))},jsonp:function(e){const n="_maptalks_jsonp_"+h++;e.match(/\\?/)?e+="&callback="+n:e+="?callback="+n;let t=document.createElement("script");return t.type="text/javascript",t.src=e,new Promise((e=>{window[n]=function(r){document.getElementsByTagName("head")[0].removeChild(t),t=null,delete window[n],e(r)},document.getElementsByTagName("head")[0].appendChild(t)}))}};if("undefined"!=typeof TextDecoder&&new TextDecoder("utf-8"),"undefined"!=typeof OffscreenCanvas){let e;try{e=new OffscreenCanvas(2,2).getContext("2d")}catch(y){}}"undefined"!=typeof document&&document.createElement("canvas"),function(){function e(e){throw e}var n=void 0,t=!0,r=this;function o(e,t){var o,i=e.split("."),a=r;!(i[0]in a)&&a.execScript&&a.execScript("var "+i[0]);for(;i.length&&(o=i.shift());)i.length||t===n?a=a[o]?a[o]:a[o]={}:a[o]=t}var i="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array&&"undefined"!=typeof DataView;function a(n,t){this.index="number"==typeof t?t:0,this.i=0,this.buffer=n instanceof(i?Uint8Array:Array)?n:new(i?Uint8Array:Array)(32768),2*this.buffer.length<=this.index&&e(Error("invalid index")),this.buffer.length<=this.index&&this.f()}a.prototype.f=function(){var e,n=this.buffer,t=n.length,r=new(i?Uint8Array:Array)(t<<1);if(i)r.set(n);else for(e=0;e<t;++e)r[e]=n[e];return this.buffer=r},a.prototype.d=function(e,n,t){var r,o=this.buffer,i=this.index,a=this.i,s=o[i];if(t&&1<n&&(e=8<n?(d[255&e]<<24|d[e>>>8&255]<<16|d[e>>>16&255]<<8|d[e>>>24&255])>>32-n:d[e]>>8-n),8>n+a)s=s<<n|e,a+=n;else for(r=0;r<n;++r)s=s<<1|e>>n-r-1&1,8==++a&&(a=0,o[i++]=d[s],s=0,i===o.length&&(o=this.f()));o[i]=s,this.buffer=o,this.i=a,this.index=i},a.prototype.finish=function(){var e,n=this.buffer,t=this.index;return 0<this.i&&(n[t]<<=8-this.i,n[t]=d[n[t]],t++),i?e=n.subarray(0,t):(n.length=t,e=n),e};var s,c=new(i?Uint8Array:Array)(256);for(s=0;256>s;++s){for(var f=h=s,l=7,h=h>>>1;h;h>>>=1)f<<=1,f|=1&h,--l;c[s]=(f<<l&255)>>>0}var d=c;function u(e){this.buffer=new(i?Uint16Array:Array)(2*e),this.length=0}function v(e){var n,t,r,o,a,s,c,f,l,h,d=e.length,u=0,v=Number.POSITIVE_INFINITY;for(f=0;f<d;++f)e[f]>u&&(u=e[f]),e[f]<v&&(v=e[f]);for(n=1<<u,t=new(i?Uint32Array:Array)(n),r=1,o=0,a=2;r<=u;){for(f=0;f<d;++f)if(e[f]===r){for(s=0,c=o,l=0;l<r;++l)s=s<<1|1&c,c>>=1;for(h=r<<16|f,l=s;l<n;l+=a)t[l]=h;++o}++r,o<<=1,a<<=1}return[t,u,v]}function _(e,n){this.h=g,this.w=0,this.input=i&&e instanceof Array?new Uint8Array(e):e,this.b=0,n&&(n.lazy&&(this.w=n.lazy),"number"==typeof n.compressionType&&(this.h=n.compressionType),n.outputBuffer&&(this.a=i&&n.outputBuffer instanceof Array?new Uint8Array(n.outputBuffer):n.outputBuffer),"number"==typeof n.outputIndex&&(this.b=n.outputIndex)),this.a||(this.a=new(i?Uint8Array:Array)(32768))}u.prototype.getParent=function(e){return 2*((e-2)/4|0)},u.prototype.push=function(e,n){var t,r,o,i=this.buffer;for(t=this.length,i[this.length++]=n,i[this.length++]=e;0<t&&(r=this.getParent(t),i[t]>i[r]);)o=i[t],i[t]=i[r],i[r]=o,o=i[t+1],i[t+1]=i[r+1],i[r+1]=o,t=r;return this.length},u.prototype.pop=function(){var e,n,t,r,o,i=this.buffer;for(n=i[0],e=i[1],this.length-=2,i[0]=i[this.length],i[1]=i[this.length+1],o=0;!((r=2*o+2)>=this.length)&&(r+2<this.length&&i[r+2]>i[r]&&(r+=2),i[r]>i[o]);)t=i[o],i[o]=i[r],i[r]=t,t=i[o+1],i[o+1]=i[r+1],i[r+1]=t,o=r;return{index:e,value:n,length:this.length}};var m,g=2,x={NONE:0,r:1,k:g,N:3},p=[];for(m=0;288>m;m++)switch(t){case 143>=m:p.push([m+48,8]);break;case 255>=m:p.push([m-144+400,9]);break;case 279>=m:p.push([m-256+0,7]);break;case 287>=m:p.push([m-280+192,8]);break;default:e("invalid literal: "+m)}function A(e,n){this.length=e,this.G=n}_.prototype.j=function(){var r,o,s,c,f=this.input;switch(this.h){case 0:for(s=0,c=f.length;s<c;){var l,h,d,u=o=i?f.subarray(s,s+65535):f.slice(s,s+65535),v=(s+=o.length)===c,_=n,m=n,x=this.a,A=this.b;if(i){for(x=new Uint8Array(this.a.buffer);x.length<=A+u.length+5;)x=new Uint8Array(x.length<<1);x.set(this.a)}if(l=v?1:0,x[A++]=0|l,d=65536+~(h=u.length)&65535,x[A++]=255&h,x[A++]=h>>>8&255,x[A++]=255&d,x[A++]=d>>>8&255,i)x.set(u,A),A+=u.length,x=x.subarray(0,A);else{for(_=0,m=u.length;_<m;++_)x[A++]=u[_];x.length=A}this.b=A,this.a=x}break;case 1:var b=new a(i?new Uint8Array(this.a.buffer):this.a,this.b);b.d(1,1,t),b.d(1,2,t);var y,E,O,S=w(this,f);for(y=0,E=S.length;y<E;y++)if(O=S[y],a.prototype.d.apply(b,p[O]),256<O)b.d(S[++y],S[++y],t),b.d(S[++y],5),b.d(S[++y],S[++y],t);else if(256===O)break;this.a=b.finish(),this.b=this.a.length;break;case g:var C,M,H,k,N,P,D,R,U,L,F,z,W,G,V,j=new a(i?new Uint8Array(this.a.buffer):this.a,this.b),X=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],B=Array(19);for(C=g,j.d(1,1,t),j.d(C,2,t),M=w(this,f),D=I(P=T(this.L,15)),U=I(R=T(this.K,7)),H=286;257<H&&0===P[H-1];H--);for(k=30;1<k&&0===R[k-1];k--);var K,q,Z,Y,J,$,Q=H,ee=k,ne=new(i?Uint32Array:Array)(Q+ee),te=new(i?Uint32Array:Array)(316),re=new(i?Uint8Array:Array)(19);for(K=q=0;K<Q;K++)ne[q++]=P[K];for(K=0;K<ee;K++)ne[q++]=R[K];if(!i)for(K=0,Y=re.length;K<Y;++K)re[K]=0;for(K=J=0,Y=ne.length;K<Y;K+=q){for(q=1;K+q<Y&&ne[K+q]===ne[K];++q);if(Z=q,0===ne[K])if(3>Z)for(;0<Z--;)te[J++]=0,re[0]++;else for(;0<Z;)($=138>Z?Z:138)>Z-3&&$<Z&&($=Z-3),10>=$?(te[J++]=17,te[J++]=$-3,re[17]++):(te[J++]=18,te[J++]=$-11,re[18]++),Z-=$;else if(te[J++]=ne[K],re[ne[K]]++,3>--Z)for(;0<Z--;)te[J++]=ne[K],re[ne[K]]++;else for(;0<Z;)($=6>Z?Z:6)>Z-3&&$<Z&&($=Z-3),te[J++]=16,te[J++]=$-3,re[16]++,Z-=$}for(r=i?te.subarray(0,J):te.slice(0,J),L=T(re,7),G=0;19>G;G++)B[G]=L[X[G]];for(N=19;4<N&&0===B[N-1];N--);for(F=I(L),j.d(H-257,5,t),j.d(k-1,5,t),j.d(N-4,4,t),G=0;G<N;G++)j.d(B[G],3,t);for(G=0,V=r.length;G<V;G++)if(z=r[G],j.d(F[z],L[z],t),16<=z){switch(G++,z){case 16:W=2;break;case 17:W=3;break;case 18:W=7;break;default:e("invalid code: "+z)}j.d(r[G],W,t)}var oe,ie,ae,se,ce,fe,le,he,de=[D,P],ue=[U,R];for(ce=de[0],fe=de[1],le=ue[0],he=ue[1],oe=0,ie=M.length;oe<ie;++oe)if(ae=M[oe],j.d(ce[ae],fe[ae],t),256<ae)j.d(M[++oe],M[++oe],t),se=M[++oe],j.d(le[se],he[se],t),j.d(M[++oe],M[++oe],t);else if(256===ae)break;this.a=j.finish(),this.b=this.a.length;break;default:e("invalid compression type")}return this.a};var b=function(){function n(n){switch(t){case 3===n:return[257,n-3,0];case 4===n:return[258,n-4,0];case 5===n:return[259,n-5,0];case 6===n:return[260,n-6,0];case 7===n:return[261,n-7,0];case 8===n:return[262,n-8,0];case 9===n:return[263,n-9,0];case 10===n:return[264,n-10,0];case 12>=n:return[265,n-11,1];case 14>=n:return[266,n-13,1];case 16>=n:return[267,n-15,1];case 18>=n:return[268,n-17,1];case 22>=n:return[269,n-19,2];case 26>=n:return[270,n-23,2];case 30>=n:return[271,n-27,2];case 34>=n:return[272,n-31,2];case 42>=n:return[273,n-35,3];case 50>=n:return[274,n-43,3];case 58>=n:return[275,n-51,3];case 66>=n:return[276,n-59,3];case 82>=n:return[277,n-67,4];case 98>=n:return[278,n-83,4];case 114>=n:return[279,n-99,4];case 130>=n:return[280,n-115,4];case 162>=n:return[281,n-131,5];case 194>=n:return[282,n-163,5];case 226>=n:return[283,n-195,5];case 257>=n:return[284,n-227,5];case 258===n:return[285,n-258,0];default:e("invalid length: "+n)}}var r,o,i=[];for(r=3;258>=r;r++)o=n(r),i[r]=o[2]<<24|o[1]<<16|o[0];return i}(),y=i?new Uint32Array(b):b;function w(r,o){function a(n,r){var o,i,a,s,c=n.G,f=[],l=0;switch(o=y[n.length],f[l++]=65535&o,f[l++]=o>>16&255,f[l++]=o>>24,t){case 1===c:i=[0,c-1,0];break;case 2===c:i=[1,c-2,0];break;case 3===c:i=[2,c-3,0];break;case 4===c:i=[3,c-4,0];break;case 6>=c:i=[4,c-5,1];break;case 8>=c:i=[5,c-7,1];break;case 12>=c:i=[6,c-9,2];break;case 16>=c:i=[7,c-13,2];break;case 24>=c:i=[8,c-17,3];break;case 32>=c:i=[9,c-25,3];break;case 48>=c:i=[10,c-33,4];break;case 64>=c:i=[11,c-49,4];break;case 96>=c:i=[12,c-65,5];break;case 128>=c:i=[13,c-97,5];break;case 192>=c:i=[14,c-129,6];break;case 256>=c:i=[15,c-193,6];break;case 384>=c:i=[16,c-257,7];break;case 512>=c:i=[17,c-385,7];break;case 768>=c:i=[18,c-513,8];break;case 1024>=c:i=[19,c-769,8];break;case 1536>=c:i=[20,c-1025,9];break;case 2048>=c:i=[21,c-1537,9];break;case 3072>=c:i=[22,c-2049,10];break;case 4096>=c:i=[23,c-3073,10];break;case 6144>=c:i=[24,c-4097,11];break;case 8192>=c:i=[25,c-6145,11];break;case 12288>=c:i=[26,c-8193,12];break;case 16384>=c:i=[27,c-12289,12];break;case 24576>=c:i=[28,c-16385,13];break;case 32768>=c:i=[29,c-24577,13];break;default:e("invalid distance")}for(o=i,f[l++]=o[0],f[l++]=o[1],f[l++]=o[2],a=0,s=f.length;a<s;++a)g[x++]=f[a];A[f[0]]++,b[f[3]]++,p=n.length+r-1,v=null}var s,c,f,l,h,d,u,v,_,m={},g=i?new Uint16Array(2*o.length):[],x=0,p=0,A=new(i?Uint32Array:Array)(286),b=new(i?Uint32Array:Array)(30),w=r.w;if(!i){for(f=0;285>=f;)A[f++]=0;for(f=0;29>=f;)b[f++]=0}for(A[256]=1,s=0,c=o.length;s<c;++s){for(f=h=0,l=3;f<l&&s+f!==c;++f)h=h<<8|o[s+f];if(m[h]===n&&(m[h]=[]),d=m[h],!(0<p--)){for(;0<d.length&&32768<s-d[0];)d.shift();if(s+3>=c){for(v&&a(v,-1),f=0,l=c-s;f<l;++f)_=o[s+f],g[x++]=_,++A[_];break}0<d.length?(u=E(o,s,d),v?v.length<u.length?(_=o[s-1],g[x++]=_,++A[_],a(u,0)):a(v,-1):u.length<w?v=u:a(u,0)):v?a(v,-1):(_=o[s],g[x++]=_,++A[_])}d.push(s)}return g[x++]=256,A[256]++,r.L=A,r.K=b,i?g.subarray(0,x):g}function E(e,n,t){var r,o,i,a,s,c,f=0,l=e.length;a=0,c=t.length;e:for(;a<c;a++){if(r=t[c-a-1],i=3,3<f){for(s=f;3<s;s--)if(e[r+s-1]!==e[n+s-1])continue e;i=f}for(;258>i&&n+i<l&&e[r+i]===e[n+i];)++i;if(i>f&&(o=r,f=i),258===i)break}return new A(f,n-o)}function T(e,n){var t,r,o,a,s,c=e.length,f=new u(572),l=new(i?Uint8Array:Array)(c);if(!i)for(a=0;a<c;a++)l[a]=0;for(a=0;a<c;++a)0<e[a]&&f.push(a,e[a]);if(t=Array(f.length/2),r=new(i?Uint32Array:Array)(f.length/2),1===t.length)return l[f.pop().index]=1,l;for(a=0,s=f.length/2;a<s;++a)t[a]=f.pop(),r[a]=t[a].value;for(o=function(e,n,t){function r(e){var t=v[e][_[e]];t===n?(r(e+1),r(e+1)):--d[t],++_[e]}var o,a,s,c,f,l=new(i?Uint16Array:Array)(t),h=new(i?Uint8Array:Array)(t),d=new(i?Uint8Array:Array)(n),u=Array(t),v=Array(t),_=Array(t),m=(1<<t)-n,g=1<<t-1;for(l[t-1]=n,a=0;a<t;++a)m<g?h[a]=0:(h[a]=1,m-=g),m<<=1,l[t-2-a]=(l[t-1-a]/2|0)+n;for(l[0]=h[0],u[0]=Array(l[0]),v[0]=Array(l[0]),a=1;a<t;++a)l[a]>2*l[a-1]+h[a]&&(l[a]=2*l[a-1]+h[a]),u[a]=Array(l[a]),v[a]=Array(l[a]);for(o=0;o<n;++o)d[o]=t;for(s=0;s<l[t-1];++s)u[t-1][s]=e[s],v[t-1][s]=s;for(o=0;o<t;++o)_[o]=0;for(1===h[t-1]&&(--d[0],++_[t-1]),a=t-2;0<=a;--a){for(c=o=0,f=_[a+1],s=0;s<l[a];s++)(c=u[a+1][f]+u[a+1][f+1])>e[o]?(u[a][s]=c,v[a][s]=n,f+=2):(u[a][s]=e[o],v[a][s]=o,++o);_[a]=0,1===h[a]&&r(a)}return d}(r,r.length,n),a=0,s=t.length;a<s;++a)l[t[a].index]=o[a];return l}function I(e){var n,t,r,o,a=new(i?Uint16Array:Array)(e.length),s=[],c=[],f=0;for(n=0,t=e.length;n<t;n++)s[e[n]]=1+(0|s[e[n]]);for(n=1,t=16;n<=t;n++)c[n]=f,f+=0|s[n],f<<=1;for(n=0,t=e.length;n<t;n++)for(f=c[e[n]],c[e[n]]+=1,r=a[n]=0,o=e[n];r<o;r++)a[n]=a[n]<<1|1&f,f>>>=1;return a}function O(n,t){switch(this.l=[],this.m=32768,this.e=this.g=this.c=this.q=0,this.input=i?new Uint8Array(n):n,this.s=!1,this.n=C,this.B=!1,!t&&(t={})||(t.index&&(this.c=t.index),t.bufferSize&&(this.m=t.bufferSize),t.bufferType&&(this.n=t.bufferType),t.resize&&(this.B=t.resize)),this.n){case S:this.b=32768,this.a=new(i?Uint8Array:Array)(32768+this.m+258);break;case C:this.b=0,this.a=new(i?Uint8Array:Array)(this.m),this.f=this.J,this.t=this.H,this.o=this.I;break;default:e(Error("invalid inflate mode"))}}var S=0,C=1,M={D:S,C:C};O.prototype.p=function(){for(;!this.s;){var r=Z(this,3);switch(1&r&&(this.s=t),r>>>=1){case 0:var o=this.input,a=this.c,s=this.a,c=this.b,f=o.length,l=n,h=s.length,d=n;switch(this.e=this.g=0,a+1>=f&&e(Error("invalid uncompressed block header: LEN")),l=o[a++]|o[a++]<<8,a+1>=f&&e(Error("invalid uncompressed block header: NLEN")),l===~(o[a++]|o[a++]<<8)&&e(Error("invalid uncompressed block header: length verify")),a+l>o.length&&e(Error("input buffer is broken")),this.n){case S:for(;c+l>s.length;){if(l-=d=h-c,i)s.set(o.subarray(a,a+d),c),c+=d,a+=d;else for(;d--;)s[c++]=o[a++];this.b=c,s=this.f(),c=this.b}break;case C:for(;c+l>s.length;)s=this.f({v:2});break;default:e(Error("invalid inflate mode"))}if(i)s.set(o.subarray(a,a+l),c),c+=l,a+=l;else for(;l--;)s[c++]=o[a++];this.c=a,this.b=c,this.a=s;break;case 1:this.o(B,q);break;case 2:var u,_,m,g,x=Z(this,5)+257,p=Z(this,5)+1,A=Z(this,4)+4,b=new(i?Uint8Array:Array)(P.length),y=n,w=n,E=n,T=n,I=n;for(I=0;I<A;++I)b[P[I]]=Z(this,3);if(!i)for(I=A,A=b.length;I<A;++I)b[P[I]]=0;for(u=v(b),y=new(i?Uint8Array:Array)(x+p),I=0,g=x+p;I<g;)switch(w=Y(this,u),w){case 16:for(T=3+Z(this,2);T--;)y[I++]=E;break;case 17:for(T=3+Z(this,3);T--;)y[I++]=0;E=0;break;case 18:for(T=11+Z(this,7);T--;)y[I++]=0;E=0;break;default:E=y[I++]=w}_=v(i?y.subarray(0,x):y.slice(0,x)),m=v(i?y.subarray(x):y.slice(x)),this.o(_,m);break;default:e(Error("unknown BTYPE: "+r))}}return this.t()};var H,k,N=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],P=i?new Uint16Array(N):N,D=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],R=i?new Uint16Array(D):D,U=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],L=i?new Uint8Array(U):U,F=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],z=i?new Uint16Array(F):F,W=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],G=i?new Uint8Array(W):W,V=new(i?Uint8Array:Array)(288);for(H=0,k=V.length;H<k;++H)V[H]=143>=H?8:255>=H?9:279>=H?7:8;var j,X,B=v(V),K=new(i?Uint8Array:Array)(30);for(j=0,X=K.length;j<X;++j)K[j]=5;var q=v(K);function Z(n,t){for(var r,o=n.g,i=n.e,a=n.input,s=n.c,c=a.length;i<t;)s>=c&&e(Error("input buffer is broken")),o|=a[s++]<<i,i+=8;return r=o&(1<<t)-1,n.g=o>>>t,n.e=i-t,n.c=s,r}function Y(n,t){for(var r,o,i=n.g,a=n.e,s=n.input,c=n.c,f=s.length,l=t[0],h=t[1];a<h&&!(c>=f);)i|=s[c++]<<a,a+=8;return(o=(r=l[i&(1<<h)-1])>>>16)>a&&e(Error("invalid code length: "+o)),n.g=i>>o,n.e=a-o,n.c=c,65535&r}function J(e){if("string"==typeof e){var n,t,r=e.split("");for(n=0,t=r.length;n<t;n++)r[n]=(255&r[n].charCodeAt(0))>>>0;e=r}for(var o,i=1,a=0,s=e.length,c=0;0<s;){s-=o=1024<s?1024:s;do{a+=i+=e[c++]}while(--o);i%=65521,a%=65521}return(a<<16|i)>>>0}function $(n,t){var r,o;if(this.input=n,this.c=0,!t&&(t={})||(t.index&&(this.c=t.index),t.verify&&(this.M=t.verify)),r=n[this.c++],o=n[this.c++],(15&r)===Q)this.method=Q;else e(Error("unsupported compression method"));0!=((r<<8)+o)%31&&e(Error("invalid fcheck flag:"+((r<<8)+o)%31)),32&o&&e(Error("fdict flag is not supported")),this.A=new O(n,{index:this.c,bufferSize:t.bufferSize,bufferType:t.bufferType,resize:t.resize})}O.prototype.o=function(e,n){var t=this.a,r=this.b;this.u=e;for(var o,i,a,s,c=t.length-258;256!==(o=Y(this,e));)if(256>o)r>=c&&(this.b=r,t=this.f(),r=this.b),t[r++]=o;else for(s=R[i=o-257],0<L[i]&&(s+=Z(this,L[i])),o=Y(this,n),a=z[o],0<G[o]&&(a+=Z(this,G[o])),r>=c&&(this.b=r,t=this.f(),r=this.b);s--;)t[r]=t[r++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=r},O.prototype.I=function(e,n){var t=this.a,r=this.b;this.u=e;for(var o,i,a,s,c=t.length;256!==(o=Y(this,e));)if(256>o)r>=c&&(c=(t=this.f()).length),t[r++]=o;else for(s=R[i=o-257],0<L[i]&&(s+=Z(this,L[i])),o=Y(this,n),a=z[o],0<G[o]&&(a+=Z(this,G[o])),r+s>c&&(c=(t=this.f()).length);s--;)t[r]=t[r++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=r},O.prototype.f=function(){var e,n,t=new(i?Uint8Array:Array)(this.b-32768),r=this.b-32768,o=this.a;if(i)t.set(o.subarray(32768,t.length));else for(e=0,n=t.length;e<n;++e)t[e]=o[e+32768];if(this.l.push(t),this.q+=t.length,i)o.set(o.subarray(r,r+32768));else for(e=0;32768>e;++e)o[e]=o[r+e];return this.b=32768,o},O.prototype.J=function(e){var n,t,r,o=this.input.length/this.c+1|0,a=this.input,s=this.a;return e&&("number"==typeof e.v&&(o=e.v),"number"==typeof e.F&&(o+=e.F)),2>o?t=(r=(a.length-this.c)/this.u[2]/2*258|0)<s.length?s.length+r:s.length<<1:t=s.length*o,i?(n=new Uint8Array(t)).set(s):n=s,this.a=n},O.prototype.t=function(){var e,n,t,r,o,a=0,s=this.a,c=this.l,f=new(i?Uint8Array:Array)(this.q+(this.b-32768));if(0===c.length)return i?this.a.subarray(32768,this.b):this.a.slice(32768,this.b);for(n=0,t=c.length;n<t;++n)for(r=0,o=(e=c[n]).length;r<o;++r)f[a++]=e[r];for(n=32768,t=this.b;n<t;++n)f[a++]=s[n];return this.l=[],this.buffer=f},O.prototype.H=function(){var e,n=this.b;return i?this.B?(e=new Uint8Array(n)).set(this.a.subarray(0,n)):e=this.a.subarray(0,n):(this.a.length>n&&(this.a.length=n),e=this.a),this.buffer=e},$.prototype.p=function(){var n,t=this.input;return n=this.A.p(),this.c=this.A.c,this.M&&((t[this.c++]<<24|t[this.c++]<<16|t[this.c++]<<8|t[this.c++])>>>0!==J(n)&&e(Error("invalid adler-32 checksum"))),n};var Q=8;function ee(e,n){this.input=e,this.a=new(i?Uint8Array:Array)(32768),this.h=ne.k;var t,r={};for(t in!n&&(n={})||"number"!=typeof n.compressionType||(this.h=n.compressionType),n)r[t]=n[t];r.outputBuffer=this.a,this.z=new _(this.input,r)}var ne=x;function te(e,n){var t,r,i,a;if(Object.keys)t=Object.keys(n);else for(r in t=[],i=0,n)t[i++]=r;for(i=0,a=t.length;i<a;++i)o(e+"."+(r=t[i]),n[r])}ee.prototype.j=function(){var n,t,r,o,a,s,c,f=0;if(c=this.a,(n=Q)===Q)t=Math.LOG2E*Math.log(32768)-8;else e(Error("invalid compression method"));if(r=t<<4|n,c[f++]=r,n===Q)switch(this.h){case ne.NONE:a=0;break;case ne.r:a=1;break;case ne.k:a=2;break;default:e(Error("unsupported compression type"))}else e(Error("invalid compression method"));return o=a<<6,c[f++]=o|31-(256*r+o)%31,s=J(this.input),this.z.b=f,f=(c=this.z.j()).length,i&&((c=new Uint8Array(c.buffer)).length<=f+4&&(this.a=new Uint8Array(c.length+4),this.a.set(c),c=this.a),c=c.subarray(0,f+4)),c[f++]=s>>24&255,c[f++]=s>>16&255,c[f++]=s>>8&255,c[f++]=255&s,c},o("Zlib.Inflate",$),o("Zlib.Inflate.prototype.decompress",$.prototype.p),te("Zlib.Inflate.BufferType",{ADAPTIVE:M.C,BLOCK:M.D}),o("Zlib.Deflate",ee),o("Zlib.Deflate.compress",(function(e,n){return new ee(e,n).j()})),o("Zlib.Deflate.prototype.compress",ee.prototype.j),te("Zlib.Deflate.CompressionType",{NONE:ne.NONE,FIXED:ne.r,DYNAMIC:ne.k})}.call(self),
/*!
   * @maptalks/reshader.gl v0.98.2
   * LICENSE : UNLICENSED
   * (c) 2016-2024 maptalks.com
   */
t([]),t([]),new Array(16);const u={vsm_shadow_vert:"\\nuniform mat4 shadow_lightProjViewModelMatrix;\\nvarying vec4 shadow_vLightSpacePos;\\nvoid shadow_computeShadowPars(vec4 position) {\\n    shadow_vLightSpacePos = shadow_lightProjViewModelMatrix * position;\\n}",vsm_shadow_frag:"\\nuniform sampler2D shadow_shadowMap;\\nuniform float shadow_opacity;\\nuniform vec3 shadow_color;\\n#if defined(USE_ESM)\\n    uniform float esm_shadow_threshold;\\n#endif\\nvarying vec4 shadow_vLightSpacePos;\\n#ifdef PACK_FLOAT\\n    #include <common_pack_float>\\n#endif\\n#if defined(USE_ESM)\\nfloat esm(vec3 projCoords, vec4 shadowTexel) {\\n    float compare = projCoords.z;\\n    float c = 120.0;\\n    #ifdef PACK_FLOAT\\n        float depth = common_decodeDepth(shadowTexel);\\n        if (depth >= 1.0 - 1E-6 || compare <= depth) {\\n            return 1.0;\\n        }\\n    #else\\n        float depth = shadowTexel.r;\\n    #endif\\n    depth = exp(-c * min(compare - depth, 0.05));\\n    return clamp(depth, esm_shadow_threshold, 1.0);\\n}\\n#endif\\n#if defined(USE_VSM)\\nfloat vsm_shadow_chebyshevUpperBound(vec3 projCoords, vec4 shadowTexel){\\n    vec2 moments = shadowTexel.rg;\\n    float distance = projCoords.z;\\n    if (distance >= 1.0 || distance <= moments.x)\\n        return 1.0 ;\\n    float variance = moments.y - (moments.x * moments.x);\\n    variance = max(variance, 0.00002);\\n    float d = distance - moments.x;\\n    float p_max = variance / (variance + d * d);\\n    return p_max;\\n}\\n#endif\\nfloat shadow_computeShadow_coeff(sampler2D shadowMap, vec3 projCoords) {\\n    vec2 uv = projCoords.xy;\\n    vec4 shadowTexel = texture2D(shadowMap, uv);\\n    #if defined(USE_ESM)\\n        float esm_coeff = esm(projCoords, shadowTexel);\\n        float coeff = esm_coeff * esm_coeff;\\n    #endif\\n    #if defined(USE_VSM)\\n        float vsm_coeff = vsm_shadow_chebyshevUpperBound(projCoords, shadowTexel);\\n        float coeff = vsm_coeff;\\n    #endif\\n    return 1.0 - (1.0 - coeff) * shadow_opacity;\\n}\\nfloat shadow_computeShadow() {\\n    vec3 projCoords = shadow_vLightSpacePos.xyz / shadow_vLightSpacePos.w;\\n    projCoords = projCoords * 0.5 + 0.5;\\n    if(projCoords.z >= 1.0 || projCoords.x < 0.0 || projCoords.x > 1.0 || projCoords.y < 0.0 || projCoords.y > 1.0) return 1.0;\\n    return shadow_computeShadow_coeff(shadow_shadowMap, projCoords);\\n}\\nvec3 shadow_blend(vec3 color, float coeff) {\\n    color = color * coeff + shadow_color * shadow_opacity * (1.0 - coeff);\\n    return color;\\n}",fbo_picking_vert:"\\n#ifdef ENABLE_PICKING\\n#if HAS_PICKING_ID == 1\\nattribute float aPickingId;\\n#elif HAS_PICKING_ID == 2\\nuniform float uPickingId;\\n#endif\\nvarying float vPickingId;\\nvarying float vFbo_picking_viewZ;\\nvarying float vFbo_picking_visible;\\n#endif\\nvarying float vFbo_picking_fragDepth;\\nvoid fbo_picking_setData(float viewPosZ, bool visible) {\\n    #ifdef ENABLE_PICKING\\n    #if HAS_PICKING_ID == 1\\n       vPickingId = aPickingId;\\n    #elif HAS_PICKING_ID == 2\\n        vPickingId = uPickingId;\\n    #endif\\n        vFbo_picking_viewZ = viewPosZ;\\n    #endif\\n    vFbo_picking_visible = visible ? 1.0 : 0.0;\\n    vFbo_picking_fragDepth = viewPosZ + 1.0;\\n}",common_pack_float:"const float COMMON_FLOAT_MAX =  1.70141184e38;\\nconst float COMMON_FLOAT_MIN = 1.17549435e-38;\\nfloat common_packFloat(vec4 val){\\n    vec4 scl = floor(255.0 * val + 0.5);\\n    float sgn = (scl.a < 128.0) ? 1.0 : -1.0;\\n    float exn = mod(scl.a * 2.0, 256.0) + floor(scl.b / 128.0) - 127.0;\\n    float man = 1.0 +\\n        (scl.r / 8388608.0) +\\n        (scl.g / 32768.0) +\\n        mod(scl.b, 128.0) / 128.0;\\n    return sgn * man * pow(2.0, exn);\\n}\\nvec4 common_unpackFloat(highp float v) {\\n    highp float av = abs(v);\\n    if(av < COMMON_FLOAT_MIN) {\\n        return vec4(0.0, 0.0, 0.0, 0.0);\\n    } else if(v > COMMON_FLOAT_MAX) {\\n        return vec4(127.0, 128.0, 0.0, 0.0) / 255.0;\\n    } else if(v < -COMMON_FLOAT_MAX) {\\n        return vec4(255.0, 128.0, 0.0, 0.0) / 255.0;\\n    }\\n    highp vec4 c = vec4(0,0,0,0);\\n    highp float e = floor(log2(av));\\n    highp float m = av * pow(2.0, -e) - 1.0;\\n    c[1] = floor(128.0 * m);\\n    m -= c[1] / 128.0;\\n    c[2] = floor(32768.0 * m);\\n    m -= c[2] / 32768.0;\\n    c[3] = floor(8388608.0 * m);\\n    highp float ebias = e + 127.0;\\n    c[0] = floor(ebias / 2.0);\\n    ebias -= c[0] * 2.0;\\n    c[1] += floor(ebias) * 128.0;\\n    c[0] += 128.0 * step(0.0, -v);\\n    return c / 255.0;\\n}\\nvec4 common_encodeDepth(const in float depth) {\\n    float alpha = 1.0;\\n    vec4 pack = vec4(0.0);\\n    pack.a = alpha;\\n    const vec3 code = vec3(1.0, 255.0, 65025.0);\\n    pack.rgb = vec3(code * depth);\\n    pack.gb = fract(pack.gb);\\n    pack.rg -= pack.gb * (1.0 / 256.0);\\n    pack.b -= mod(pack.b, 4.0 / 255.0);\\n    return pack;\\n}\\nfloat common_decodeDepth(const in vec4 pack) {\\n    return pack.r + pack.g / 255.0;\\n}",invert_matrix:"mat4 invert_matrix(mat4 matrix) {\\n    #if __VERSION__ == 300\\n        return inverse(matrix);\\n    #else\\n        vec4 vector1 = matrix[0], vector2 = matrix[1], vector3 = matrix[2], vector4 = matrix[3];\\n        float a00 = vector1.x, a01 = vector1.y, a02 = vector1.z, a03 = vector1.w;\\n        float a10 = vector2.x, a11 = vector2.y, a12 = vector2.z, a13 = vector2.w;\\n        float a20 = vector3.x, a21 = vector3.y, a22 = vector3.z, a23 = vector3.w;\\n        float a30 = vector4.x, a31 = vector4.y, a32 = vector4.z, a33 = vector4.w;\\n        float b00 = a00 * a11 - a01 * a10;\\n        float b01 = a00 * a12 - a02 * a10;\\n        float b02 = a00 * a13 - a03 * a10;\\n        float b03 = a01 * a12 - a02 * a11;\\n        float b04 = a01 * a13 - a03 * a11;\\n        float b05 = a02 * a13 - a03 * a12;\\n        float b06 = a20 * a31 - a21 * a30;\\n        float b07 = a20 * a32 - a22 * a30;\\n        float b08 = a20 * a33 - a23 * a30;\\n        float b09 = a21 * a32 - a22 * a31;\\n        float b10 = a21 * a33 - a23 * a31;\\n        float b11 = a22 * a33 - a23 * a32;\\n        float det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\\n        det = 1.0 / det;\\n        mat4 m = mat4(\\n            (a11 * b11 - a12 * b10 + a13 * b09) * det,\\n            (a02 * b10 - a01 * b11 - a03 * b09) * det,\\n            (a31 * b05 - a32 * b04 + a33 * b03) * det,\\n            (a22 * b04 - a21 * b05 - a23 * b03) * det,\\n            (a12 * b08 - a10 * b11 - a13 * b07) * det,\\n            (a00 * b11 - a02 * b08 + a03 * b07) * det,\\n            (a32 * b02 - a30 * b05 - a33 * b01) * det,\\n            (a20 * b05 - a22 * b02 + a23 * b01) * det,\\n            (a10 * b10 - a11 * b08 + a13 * b06) * det,\\n            (a01 * b08 - a00 * b10 - a03 * b06) * det,\\n            (a30 * b04 - a31 * b02 + a33 * b00) * det,\\n            (a21 * b02 - a20 * b04 - a23 * b00) * det,\\n            (a11 * b07 - a10 * b09 - a12 * b06) * det,\\n            (a00 * b09 - a01 * b07 + a02 * b06) * det,\\n            (a31 * b01 - a30 * b03 - a32 * b00) * det,\\n            (a20 * b03 - a21 * b01 + a22 * b00) * det\\n        );\\n        return m;\\n    #endif\\n}\\nmat4 transpose_matrix(mat4 matrix) {\\n    #if __VERSION__ == 300\\n        return transpose(matrix);\\n    #else\\n        vec4 vector1 = matrix[0], vector2 = matrix[1], vector3 = matrix[2], vector4 = matrix[3];\\n        float a01 = vector1.y, a02 = vector1.z, a03 = vector1.w;\\n        float a12 = vector2.z, a13 = vector2.w;\\n        float a23 = vector3.w;\\n        mat4 m = mat4(\\n            vector1.x,\\n            vector2.x,\\n            vector3.x,\\n            vector4.x,\\n            a01,\\n            vector2.y,\\n            vector3.y,\\n            vector4.y,\\n            a02,\\n            a12,\\n            vector3.z,\\n            vector4.z,\\n            a03,\\n            a13,\\n            a23,\\n            vector4.w\\n        );\\n        return m;\\n    #endif\\n}",get_output:"#include <invert_matrix>\\n#include <draco_decode_vert>\\n#ifdef HAS_INSTANCE\\n    #include <instance_vert>\\n    #ifdef HAS_INSTANCE_COLOR\\n        varying vec4 vInstanceColor;\\n    #endif\\n#endif\\n#ifdef HAS_SKIN\\n    uniform int skinAnimation;\\n    #include <skin_vert>\\n#endif\\n#include <mask_vert>\\n#ifdef HAS_MORPH\\n    attribute vec3 POSITION0;\\n    attribute vec3 POSITION1;\\n    attribute vec3 POSITION2;\\n    attribute vec3 POSITION3;\\n    attribute vec3 POSITION4;\\n    attribute vec3 POSITION5;\\n    attribute vec3 POSITION6;\\n    attribute vec3 POSITION7;\\n    #ifdef HAS_MORPHNORMALS\\n        attribute vec3 NORMAL0;\\n        attribute vec3 NORMAL1;\\n        attribute vec3 NORMAL2;\\n        attribute vec3 NORMAL3;\\n    #endif\\n    uniform vec4 morphWeights1;\\n    uniform vec4 morphWeights2;\\n#endif\\n#ifdef HAS_TERRAIN_ALTITUDE\\nattribute float aTerrainAltitude;\\n#endif\\nmat4 getPositionMatrix() {\\n    mat4 worldMatrix;\\n    #ifdef HAS_INSTANCE\\n        #ifdef HAS_INSTANCE_COLOR\\n            vInstanceColor = instance_getInstanceColor();\\n        #endif\\n        mat4 attributeMatrix = instance_getAttributeMatrix();\\n        #ifdef HAS_SKIN\\n            if (skinAnimation == 1) {\\n                worldMatrix = attributeMatrix * positionMatrix * skin_getSkinMatrix();\\n            } else {\\n                worldMatrix = attributeMatrix * positionMatrix;\\n            }\\n        #else\\n            worldMatrix = attributeMatrix * positionMatrix;\\n        #endif\\n    #else\\n        #ifdef HAS_SKIN\\n            if (skinAnimation == 1) {\\n                worldMatrix = skin_getSkinMatrix() * positionMatrix;\\n            } else {\\n                worldMatrix = positionMatrix;\\n            }\\n        #else\\n            worldMatrix = positionMatrix;\\n        #endif\\n    #endif\\n    return worldMatrix;\\n}\\n#ifdef HAS_MIN_ALTITUDE\\nuniform float minAltitude;\\n#endif\\nvec4 getPosition(vec3 aPosition) {\\n    vec3 position = decode_getPosition(aPosition);\\n    #ifdef HAS_MORPH\\n        vec4 POSITION = vec4(position + morphWeights1[0] * POSITION0 + morphWeights1[1] * POSITION1 + morphWeights1[2] * POSITION2 + morphWeights1[3] * POSITION3\\n        + morphWeights2[0] * POSITION4 + morphWeights2[1] * POSITION5 + morphWeights2[2] * POSITION6 + morphWeights2[3] * POSITION7\\n        , 1.0);\\n    #else\\n        vec4 POSITION = vec4(position, 1.0);\\n    #endif\\n    #ifdef HAS_TERRAIN_ALTITUDE\\n        POSITION.z += aTerrainAltitude * 100.0;\\n    #endif\\n    #ifdef HAS_MIN_ALTITUDE\\n        POSITION.z += minAltitude * 100.0;\\n    #endif\\n    return POSITION;\\n}\\nvec3 appendMorphNormal(vec3 NORMAL) {\\n    #ifdef HAS_MORPHNORMALS\\n        vec3 normal = NORMAL + morphWeights1[0] * NORMAL0 + morphWeights1[1] * NORMAL1 + morphWeights1[2] * NORMAL2 + morphWeights1[3] * NORMAL3;\\n    #else\\n        vec3 normal = NORMAL;\\n    #endif\\n    return normal;\\n}",instance_vert:"attribute vec4 instance_vectorA;\\nattribute vec4 instance_vectorB;\\nattribute vec4 instance_vectorC;\\n#ifdef HAS_INSTANCE_TERRAIN_ALTITUDE\\nattribute float aTerrainAltitude;\\nuniform float terrainAltitudeScale;\\n#endif\\nmat4 instance_getAttributeMatrix() {\\n    mat4 mat =  mat4(\\n        instance_vectorA.x, instance_vectorB.x, instance_vectorC.x, 0.0,\\n        instance_vectorA.y, instance_vectorB.y, instance_vectorC.y, 0.0,\\n        instance_vectorA.z, instance_vectorB.z, instance_vectorC.z, 0.0,\\n        instance_vectorA.w, instance_vectorB.w, instance_vectorC.w, 1.0\\n    );\\n    #ifdef HAS_INSTANCE_TERRAIN_ALTITUDE\\n        mat4 terrainMat = mat4(\\n            1., 0., 0., 0.,\\n            0., 1., 0., 0.,\\n            0., 0., 1., 0.,\\n            0., 0., aTerrainAltitude * terrainAltitudeScale, 1.\\n        );\\n        mat = terrainMat * mat;\\n    #endif\\n    return mat;\\n}\\n#ifdef HAS_INSTANCE_HIGHLIGHT\\n    attribute vec4 highlight_color;\\n#endif\\n#ifdef HAS_INSTANCE_COLOR\\n   \\n    attribute vec4 instance_color;\\n    vec4 instance_getInstanceColor() {\\n        vec4 color = instance_color;\\n        #ifdef HAS_INSTANCE_HIGHLIGHT\\n            color = instance_color * highlight_color;\\n        #endif\\n        return color;\\n    }\\n#endif",skin_vert:"attribute vec4 WEIGHTS_0;\\nattribute vec4 JOINTS_0;\\nuniform sampler2D jointTexture;\\nuniform vec2 jointTextureSize;\\nuniform float numJoints;\\n#define ROW0_U ((0.5 + 0.0) / 4.)\\n#define ROW1_U ((0.5 + 1.0) / 4.)\\n#define ROW2_U ((0.5 + 2.0) / 4.)\\n#define ROW3_U ((0.5 + 3.0) / 4.)\\nmat4 skin_getBoneMatrix(float jointNdx) {\\n    float v = (jointNdx + 0.5) / numJoints;\\n    return mat4(\\n        texture2D(jointTexture, vec2(ROW0_U, v)),\\n        texture2D(jointTexture, vec2(ROW1_U, v)),\\n        texture2D(jointTexture, vec2(ROW2_U, v)),\\n        texture2D(jointTexture, vec2(ROW3_U, v)));\\n}\\nmat4 skin_getSkinMatrix() {\\n        mat4 skinMatrix = skin_getBoneMatrix(JOINTS_0[0]) * WEIGHTS_0[0] +\\n                        skin_getBoneMatrix(JOINTS_0[1]) * WEIGHTS_0[1] +\\n                        skin_getBoneMatrix(JOINTS_0[2]) * WEIGHTS_0[2] +\\n                        skin_getBoneMatrix(JOINTS_0[3]) * WEIGHTS_0[3];\\n        return skinMatrix;\\n}",heatmap_render_vert:"#ifdef HAS_HEATMAP\\nvarying vec2 heatmap_vTexCoord;\\nvoid heatmap_compute(mat4 matrix, vec3 position) {\\n    vec4 pos = matrix * vec4(position.xy, 0., 1.);\\n    heatmap_vTexCoord = (1. + pos.xy / pos.w) / 2.;\\n}\\n#endif",heatmap_render_frag:"#ifdef HAS_HEATMAP\\nuniform sampler2D heatmap_inputTexture;\\nuniform sampler2D heatmap_colorRamp;\\nuniform float heatmap_heatmapOpacity;\\nvarying vec2 heatmap_vTexCoord;\\nvec4 heatmap_getColor(vec4 color) {\\n    float t = texture2D(heatmap_inputTexture, heatmap_vTexCoord).r;\\n    vec4 heatmapColor = texture2D(heatmap_colorRamp, vec2(t, 0.5)) * heatmap_heatmapOpacity;\\n    return color * (1.0 - heatmapColor.a) + heatmapColor * heatmapColor.a;\\n}\\n#endif",line_extrusion_vert:"#ifdef IS_LINE_EXTRUSION\\n    #define ALTITUDE_SCALE 32767.0;\\n    #define EXTRUDE_SCALE 63.0;\\n    attribute vec2 aExtrude;\\n    #ifdef HAS_LINE_WIDTH\\n        attribute float aLineWidth;\\n    #else\\n        uniform float lineWidth;\\n    #endif\\n    #ifdef HAS_LINE_HEIGHT\\n        attribute float aLineHeight;\\n    #else\\n        uniform float lineHeight;\\n    #endif\\n    uniform float linePixelScale;\\n    vec3 getLineExtrudePosition(vec3 position) {\\n        #ifdef HAS_LINE_WIDTH\\n            float lineWidth = aLineWidth / 2.0;\\n        #endif\\n        #ifdef HAS_LINE_HEIGHT\\n            float lineHeight = aLineHeight / 10.0;\\n        #endif\\n        float halfwidth = lineWidth / 2.0;\\n        float outset = halfwidth;\\n        vec2 dist = outset * aExtrude / EXTRUDE_SCALE;\\n        position.z *= lineHeight / ALTITUDE_SCALE;\\n        return position + vec3(dist, 0.0) * linePixelScale;\\n    }\\n#endif",gl2_vert:"#if __VERSION__ == 300\\n    #define texture2D texture\\n    #define varying out\\n    #define attribute in\\n#endif",gl2_frag:"#if __VERSION__ == 300\\n    #define varying in\\n    #define gl_FragDepthEXT gl_FragDepth\\n    #define texture2D texture\\n    #define textureCube texture\\n    #define texture2DProj textureProj\\n    #define texture2DLodEXT textureLod\\n    #define texture2DProjLodEXT textureProjLod\\n    #define textureCubeLodEXT textureLod\\n    #define texture2DGradEXT textureGrad\\n    #define texture2DProjGradEXT textureProjGrad\\n    #define textureCubeGradEXT textureGrad\\n    #define texture2D texture\\n    out vec4 glFragColor;\\n#else\\n    vec4 glFragColor;\\n#endif",hsv_frag:"\\nconst mediump vec4 HSV_K0 = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\\nconst mediump vec4 HSV_K1 = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\\nconst mediump float HSV_E = 1.0e-10;\\nvec3 hsv_rgb2hsv(vec3 c) {\\n    vec4 K = HSV_K0;\\n    vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\\n    vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\\n    float d = q.x - min(q.w, q.y);\\n    float e = HSV_E;\\n    return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\\n}\\nvec3 hsv_hsv2rgb(vec3 c) {\\n    vec4 K = HSV_K1;\\n    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\\n    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\\n}\\nvec4 hsv_apply(vec4 c, vec3 hsvOffset) {\\n    vec3 hsv = hsv_rgb2hsv(c.rgb);\\n    hsv += hsv * hsvOffset;\\n    hsv = clamp(hsv, 0.0, 1.0);\\n    return vec4(hsv_hsv2rgb(hsv), c.a);\\n}\\nvec3 hsv_apply(vec3 c, vec3 hsvOffset) {\\n    vec3 hsv = hsv_rgb2hsv(c.rgb);\\n    hsv += hsv * hsvOffset;\\n    hsv = clamp(hsv, 0.0, 1.0);\\n    return hsv_hsv2rgb(hsv);\\n}\\nmat4 contrastMatrix(float contrast)\\n{\\n    float t = (1.0 - contrast) / 2.0;\\n    return mat4(\\n        contrast, 0., 0., 0.,\\n        0., contrast, 0., 0.,\\n        0., 0., contrast, 0.,\\n        t, t, t, 1\\n    );\\n}",snow_frag:"#ifdef HAS_SNOW\\n    float lerp(float a, float b, float w) {\\n        return a + w * (b - a);\\n    }\\n    vec3 snow(vec4 sceneColor, vec3 normalColor, float height) {\\n        float snowIntense = normalColor.b;\\n        vec3 fixedC = vec3(1.0, 1.0, 1.0);\\n        if (height < 1.0) {\\n            float r = lerp(0.5, fixedC.x, snowIntense);\\n            float g = lerp(0.5, fixedC.y, snowIntense);\\n            float b = lerp(0.5, fixedC.z, snowIntense);\\n            return vec3(r, g, b);\\n        } else {\\n            float r = lerp(sceneColor.r, fixedC.x, snowIntense);\\n            float g = lerp(sceneColor.g, fixedC.y, snowIntense);\\n            float b = lerp(sceneColor.b, fixedC.z, snowIntense);\\n            return vec3(r, g, b);\\n        }\\n    }\\n#endif",draco_decode_vert:"#if defined(HAS_TANGENT)\\n    attribute vec4 aTangent;\\n#elif defined(HAS_NORMAL)\\n    #ifdef HAS_DRACO_NORMAL\\n        attribute vec2 aNormal;\\n        uniform float gltf_u_dec_normal_rangeConstant;\\n    #else\\n        attribute vec3 aNormal;\\n    #endif\\n#endif\\n#ifdef HAS_DRACO_POSITION\\n    uniform float gltf_u_dec_position_normConstant;\\n    uniform vec3 minValues_pos;\\n    vec3 decodeDracoPosition(vec3 aPosition) {\\n        return minValues_pos + aPosition * gltf_u_dec_position_normConstant;\\n    }\\n#endif\\n#ifdef HAS_DRACO_TEXCOORD\\n    uniform vec2 minValues_tex;\\n    uniform float gltf_u_dec_texcoord_0_normConstant;\\n    vec2 decodeDracoTexcoord(vec2 aTexCoord) {\\n        return minValues_tex + aTexCoord * gltf_u_dec_texcoord_0_normConstant;\\n    }\\n#endif\\n#ifdef HAS_WEB3D_quantized_attributes_TEXCOORD\\n    uniform mat3 decodeMatrix;\\n#endif\\n#ifdef HAS_DRACO_NORMAL\\n    float czm_signNotZero(float value) {\\n        return value >= 0.0 ? 1.0 : -1.0;\\n    }\\n    vec2 czm_signNotZero(vec2 value) {\\n        return vec2(czm_signNotZero(value.x), czm_signNotZero(value.y));\\n    }\\n    vec3 decodeDracoNormal(vec2 encoded, float range)\\n    {\\n        if (encoded.x == 0.0 && encoded.y == 0.0) {\\n            return vec3(0.0, 0.0, 0.0);\\n        }\\n        encoded = encoded / range * 2.0 - 1.0;\\n        vec3 v = vec3(encoded.x, encoded.y, 1.0 - abs(encoded.x) - abs(encoded.y));\\n        if (v.z < 0.0) {\\n            v.xy = (1.0 - abs(v.yx)) * czm_signNotZero(v.xy);\\n        }\\n        return normalize(v);\\n    }\\n    vec3 decode_getNormal(vec2 aNormal) {\\n        return decodeDracoNormal(aNormal, gltf_u_dec_normal_rangeConstant).zxy;\\n    }\\n#endif\\n#ifdef HAS_COMPRESSED_INT16\\n    #ifdef HAS_COMPRESSED_INT16_POSITION\\n      uniform vec2 compressedPositionRange;\\n    #endif\\n    #ifdef HAS_COMPRESSED_INT16_TEXCOORD_0\\n      uniform vec2 compressedTexcoordRange_0;\\n    #endif\\n    #ifdef HAS_COMPRESSED_INT16_TEXCOORD_1\\n      uniform vec2 compressedTexcoordRange_1;\\n    #endif\\n    #ifdef HAS_COMPRESSED_INT16_NORMAL\\n      uniform vec2 compressedNormalRange;\\n    #endif\\n    #ifdef HAS_COMPRESSED_INT16_RATIO\\n      uniform float compressed_ratio;\\n    #endif\\n    float int16ToFloat32(float value, vec2 range) {\\n        float v = (value >= 32768.0) ? -(65536.0 - value) / 32768.0 : value / 32767.0;\\n        return (v + 1.0) * (range.y - range.x) / 2.0 + range.x;\\n    }\\n#endif\\nvec3 decode_getPosition(vec3 aPosition) {\\n    vec3 position = aPosition;\\n    #if defined(HAS_COMPRESSED_INT16) && defined(HAS_COMPRESSED_INT16_POSITION)\\n        float x = int16ToFloat32(aPosition.x, compressedPositionRange);\\n        float y = int16ToFloat32(aPosition.y, compressedPositionRange);\\n        float z = int16ToFloat32(aPosition.z, compressedPositionRange);\\n        #ifdef HAS_COMPRESSED_INT16_RATIO\\n          position = vec3(x / compressed_ratio, y / compressed_ratio, z);\\n        #else\\n          position = vec3(x, y, z);\\n        #endif\\n    #endif\\n    #ifdef HAS_DRACO_POSITION\\n        return decodeDracoPosition(position);\\n    #else\\n        return position;\\n    #endif\\n}\\nvec2 decode_getTexcoord(vec2 aTexCoord) {\\n    vec2 texcoord = aTexCoord;\\n    #if defined(HAS_COMPRESSED_INT16) && (defined(HAS_COMPRESSED_INT16_TEXCOORD_0) || defined(HAS_COMPRESSED_INT16_TEXCOORD_1))\\n        float x = int16ToFloat32(aTexCoord.x, compressedTexcoordRange_0);\\n        float y = int16ToFloat32(aTexCoord.y, compressedTexcoordRange_0);\\n        texcoord = vec2(x, y);\\n    #endif\\n    #ifdef HAS_DRACO_TEXCOORD\\n        return decodeDracoTexcoord(texcoord);\\n    #elif defined(HAS_WEB3D_quantized_attributes_TEXCOORD)\\n        vec3 web3dTexcoord = decodeMatrix * vec3(texcoord, 1.0);\\n        return vec2(web3dTexcoord.x, web3dTexcoord.y);\\n    #else\\n        return texcoord;\\n    #endif\\n}\\nvec3 decode_getNormal(vec3 aNormal) {\\n    #ifdef HAS_COMPRESSED_INT16_NORMAL\\n        aNormal.x = int16ToFloat32(aNormal.x, compressedNormalRange);\\n        aNormal.y = int16ToFloat32(aNormal.y, compressedNormalRange);\\n        aNormal.z = int16ToFloat32(aNormal.z, compressedNormalRange);\\n    #endif\\n    return aNormal;\\n}",highlight_vert:"#if defined(HAS_HIGHLIGHT_COLOR)\\n    attribute vec4 aHighlightColor;\\n    varying vec4 vHighlightColor;\\n#endif\\n#if defined(HAS_HIGHLIGHT_OPACITY)\\n    attribute float aHighlightOpacity;\\n    varying float vHighlightOpacity;\\n#endif\\nvoid highlight_setVarying() {\\n    #if defined(HAS_HIGHLIGHT_COLOR)\\n        vHighlightColor = aHighlightColor / 255.0;\\n    #endif\\n    #if defined(HAS_HIGHLIGHT_OPACITY)\\n        vHighlightOpacity = aHighlightOpacity / 255.0;\\n    #endif\\n}",highlight_frag:"#if defined(HAS_HIGHLIGHT_COLOR)\\n\\tvarying vec4 vHighlightColor;\\n#endif\\n#if defined(HAS_HIGHLIGHT_OPACITY)\\n    varying float vHighlightOpacity;\\n#endif\\nvec4 highlight_blendColor(vec4 color) {\\n\\tvec4 outColor;\\n\\t#if defined(HAS_HIGHLIGHT_COLOR)\\n\\t\\tcolor.rgb = color.rgb * (1.0 - vHighlightColor.a) + vHighlightColor.rgb * vHighlightColor.a;\\n\\t\\t#ifndef HAS_HIGHLIGHT_COLOR_POINT\\n        \\tcolor.a = color.a * (1.0 - vHighlightColor.a) + vHighlightColor.a;\\n        #endif\\n        outColor = color;\\n\\t#else\\n\\t\\toutColor = color;\\n\\t#endif\\n\\t#if defined(HAS_HIGHLIGHT_OPACITY)\\n\\t\\toutColor *= vHighlightOpacity;\\n\\t#endif\\n\\treturn outColor;\\n}",mask_vert:"#ifdef HAS_MASK_EXTENT\\n    uniform vec4 mask_extent;\\n    uniform sampler2D mask_colorExtent;\\n    uniform sampler2D mask_modeExtent;\\n    uniform float mask_maskMode;\\n    uniform float mask_hasFlatOut;\\n    uniform mat4 viewMatrix;\\n    uniform float mask_heightRatio;\\n    uniform float mask_heightOffset;\\n    varying vec4 vWorldPosition;\\n    varying vec2 vUVInExtent;\\n    varying float vHeightRatio;\\n    varying float vHeightOffset;\\n    const float CLIPINSIDE_MODE = 0.2;\\n    const float FLATINSIDE_MODE = 0.3;\\n    const float FLATOUTSIDE_MODE = 0.4;\\n    const float ELEVATE_MODE = 0.7;\\n    float random (vec2 st) {\\n        return fract(sin(dot(st.xy,vec2(12.9898,78.233)))*43758.5453123) * 0.1;\\n    }\\n    bool isInExtent(vec4 color) {\\n        return length(color.rgb) > 0.0;\\n    }\\n    float getFlatHeight(float maskMode, float flatHeight, float height) {\\n      if (maskMode <= ELEVATE_MODE && maskMode > 0.6) {\\n          return flatHeight + height;\\n      } else {\\n        return flatHeight;\\n      }\\n    }\\n    vec4 getNoErrorPosition(vec4 position, vec4 wPosition) {\\n      vec4 realPos = modelViewMatrix * position;      vec4 pos = viewMatrix * wPosition;      vec4 tempPos = viewMatrix * modelMatrix * position;      float deltaX = realPos.x - tempPos.x;\\n      float deltaY = realPos.y - tempPos.y;\\n      float deltaZ = realPos.z - tempPos.z;\\n      pos.x = pos.x + deltaX;\\n      pos.y = pos.y + deltaY;\\n      pos.z = pos.z + deltaZ;\\n      return pos;\\n    }\\n    vec4 getMaskPosition(vec4 position, mat4 modelMatrix) {\\n        vWorldPosition = modelMatrix * position;\\n        float w = mask_extent.z - mask_extent.x;\\n        float h = mask_extent.y - mask_extent.w;\\n        vec2 uvInExtent = vec2((vWorldPosition.x - mask_extent.x) / abs(w), 1.0 - (vWorldPosition.y - mask_extent.w) / h);\\n        vec4 extentColor = texture2D(mask_colorExtent, uvInExtent);\\n        vec3 maskOptionColor = texture2D(mask_modeExtent, uvInExtent).rgb;\\n        float maskMode = maskOptionColor.r;\\n        float flatHeight = maskOptionColor.g / mask_heightRatio + mask_heightOffset;\\n        float height = getFlatHeight(maskMode, flatHeight, vWorldPosition.z);\\n        vec4 wPosition = vec4(vWorldPosition.x, vWorldPosition.y, height, vWorldPosition.w);\\n        vUVInExtent = uvInExtent;\\n        vHeightRatio = mask_heightRatio;\\n        vHeightOffset = mask_heightOffset;\\n        if (maskMode <= FLATOUTSIDE_MODE && maskMode > FLATINSIDE_MODE) {\\n            return modelViewMatrix * position;;\\n        } else if (mask_hasFlatOut == 1.0) {\\n            return getNoErrorPosition(position, wPosition);\\n        }\\n        if (isInExtent(extentColor) == true && maskMode <= FLATINSIDE_MODE && maskMode > CLIPINSIDE_MODE) {\\n            return getNoErrorPosition(position, wPosition);\\n        } if (isInExtent(extentColor) == true && maskMode <= ELEVATE_MODE && maskMode > 0.6) {\\n            return getNoErrorPosition(position, wPosition);\\n        } else {\\n            return modelViewMatrix * position;\\n        }\\n    }\\n#endif",mask_frag:"#ifdef HAS_MASK_EXTENT\\n    uniform sampler2D mask_colorExtent;\\n    uniform sampler2D mask_modeExtent;\\n    uniform float mask_hasClipOut;\\n    varying float vHeightRatio;\\n    varying float vHeightOffset;\\n    varying vec2 vUVInExtent;\\n    varying vec4 vWorldPosition;\\n    const float CLIPINSIDE_MODE = 0.1;\\n    const float CLIPOUTSIDE_MODE = 0.2;\\n    const float FLATINSIDE_MODE = 0.3;\\n    const float FLATOUTSIDE_MODE = 0.4;\\n    const float COLOR_MODE = 0.5;\\n    const float VIDEO_MODE = 0.6;\\n    bool isInExtent(vec4 color) {\\n        return length(color.rgb) > 0.0;\\n    }\\n    vec4 setMask(vec4 glFragColor) {\\n        vec4 extentColor = texture2D(mask_colorExtent, vUVInExtent);\\n        vec4 modeColor = texture2D(mask_modeExtent, vUVInExtent);\\n        float maskMode = modeColor.r;\\n        float minHeight = modeColor.b / vHeightRatio + vHeightOffset;\\n        float maxHeight = modeColor.a / vHeightRatio + vHeightOffset;\\n        if (maskMode > CLIPINSIDE_MODE && maskMode <= CLIPOUTSIDE_MODE) {\\n            if (minHeight == 0.0 && maxHeight == 0.0) {\\n                return glFragColor;\\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\\n                return glFragColor;\\n            } else {\\n              discard;\\n            }\\n        } else if (mask_hasClipOut == 1.0) {\\n            discard;\\n        }\\n        if (isInExtent(extentColor) == true && maskMode <= CLIPINSIDE_MODE && maskMode > 0.0) {\\n            if (minHeight == 0.0 && maxHeight == 0.0) {\\n                discard;\\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\\n                discard;\\n            } else {\\n              return glFragColor;\\n            }\\n        } else if (isInExtent(extentColor) == true && maskMode <= VIDEO_MODE && maskMode > FLATOUTSIDE_MODE) {\\n            if (minHeight == 0.0 && maxHeight == 0.0) {\\n                glFragColor = vec4(mix(extentColor.rgb, glFragColor.rgb, 1.0 - extentColor.a), glFragColor.a);\\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\\n                glFragColor = vec4(mix(extentColor.rgb, glFragColor.rgb, 1.0 - extentColor.a), glFragColor.a);\\n            }\\n        }\\n        return glFragColor;\\n    }\\n#endif",computeTexcoord_frag:"#ifdef HAS_KHR_TEXTURE_TRANSFORM\\n    uniform vec2 khr_offset;\\n    uniform float khr_rotation;\\n    uniform vec2 khr_scale;\\n    vec2 khr_tex_transformTexCoord(vec2 texCoords, vec2 offset, float rotation, vec2 scale) {\\n        rotation = -rotation;\\n        mat3 transform = mat3(\\n        cos(rotation) * scale.x, sin(rotation) * scale.x, 0.0, -sin(rotation) * scale.y, cos(rotation) * scale.y, 0.0, offset.x, offset.y, 1.0);\\n        vec2 transformedTexCoords = (transform * vec3(fract(texCoords), 1.0)).xy;\\n        return transformedTexCoords;\\n    }\\n#endif\\nvarying highp vec2 vTexCoord;\\n#ifdef HAS_I3S_UVREGION\\n    varying vec4 vUvRegion;\\n#endif\\nvec2 computeTexCoord(vec2 texCoord) {\\n    #ifdef HAS_I3S_UVREGION\\n        vec2 atlasScale = vUvRegion.zw - vUvRegion.xy;\\n        vec2 uvAtlas = fract(texCoord) * atlasScale + vUvRegion.xy;\\n        return uvAtlas;\\n    #elif defined(HAS_KHR_TEXTURE_TRANSFORM)\\n        return khr_tex_transformTexCoord(texCoord, khr_offset, khr_rotation, khr_scale);\\n    #else\\n        return texCoord;\\n    #endif\\n}",terrain_normal_frag:"#ifdef HAS_TERRAIN_NORMAL\\n    uniform sampler2D terrainHeightTexture;\\n    uniform vec2 terrainHeightMapResolution;\\n    uniform vec2 terrainResolution;\\n    uniform float terrainHeightScale;\\n    uniform float terrainTileResolution;\\n    uniform vec4 terrainUnpackFactors;\\n    float getHeight(vec2 uv) {\\n        vec4 color = texture2D(terrainHeightTexture, uv) * 255.0;\\n        color.a = -1.0;\\n        return dot(color, terrainUnpackFactors) / 4.0;\\n    }\\n    vec3 convertTerrainHeightToNormalMap(vec2 uv) {\\n        uv.y = 1.0 - uv.y;\\n        vec2 epsilon = 1.0 / terrainHeightMapResolution;\\n        float a = getHeight(uv + vec2(-epsilon.x, -epsilon.y));\\n        float b = getHeight(uv + vec2(0, -epsilon.y));\\n        float c = getHeight(uv + vec2(epsilon.x, -epsilon.y));\\n        float d = getHeight(uv + vec2(-epsilon.x, 0));\\n        float e = getHeight(uv + vec2(epsilon.x, 0));\\n        float f = getHeight(uv + vec2(-epsilon.x, epsilon.y));\\n        float g = getHeight(uv + vec2(0, epsilon.y));\\n        float h = getHeight(uv + vec2(epsilon.x, epsilon.y));\\n        vec2 dxy = vec2(\\n            (c + e + e + h) - (a + d + d + f),\\n            (f + g + g + h) - (a + b + b + c)\\n        );\\n        return normalize(vec3(dxy / epsilon, terrainResolution ));\\n    }\\n#endif",vertex_color_vert:"#ifdef HAS_VERTEX_COLOR\\nattribute float aVertexColorType;\\nuniform vec4 vertexColorsOfType[VERTEX_TYPES_COUNT];\\nvarying vec4 vertexColor_color;\\nvoid vertexColor_update() {\\n    vertexColor_color = vertexColorsOfType[int(aVertexColorType)];\\n}\\n#endif",vertex_color_frag:"#ifdef HAS_VERTEX_COLOR\\nvarying vec4 vertexColor_color;\\nvec4 vertexColor_get() {\\n\\treturn vertexColor_color;\\n}\\n#endif",excavate_vert:"#ifdef HAS_EXCAVATE_ANALYSIS\\n  uniform vec4 excavateExtent;\\n  varying vec2 vCoordinateTexcoord;\\n  varying float vHeight;\\n  float getWorldHeight() {\\n    vec4 wPosition = modelMatrix * getPosition(aPosition);\\n    return wPosition.z;\\n  }\\n  vec2 getCoordinateTexcoord() {\\n    mat4 localPositionMatrix = getPositionMatrix();\\n    vec4 wPosition = modelMatrix * localPositionMatrix * getPosition(aPosition);\\n    float x = (wPosition.x - excavateExtent.x) / (excavateExtent.z - excavateExtent.x);\\n    float y = (wPosition.y - excavateExtent.y) / (excavateExtent.w - excavateExtent.y);\\n    return vec2(x, y);\\n  }\\n#endif",excavate_frag:"#ifdef HAS_EXCAVATE_ANALYSIS\\n  uniform sampler2D heightmap;\\n  uniform float excavateHeight;\\n  varying vec2 vCoordinateTexcoord;\\n  varying float vHeight;\\n  const vec2 range = vec2(-100.0, 1000.0);\\n  float decodeHeight(const in vec4 pack) {\\n      return pack.r + pack.g / 255.0;\\n  }\\n  vec4 excavateColor(vec4 fragColor) {\\n      float samplerHeight = decodeHeight(texture2D(heightmap, vCoordinateTexcoord));\\n      float realHeight = samplerHeight * (range.y - range.x) + range.x;\\n      if(realHeight < range.x || realHeight > range.y) {\\n          realHeight = 0.0;\\n      }\\n      if(vHeight > realHeight) {\\n          discard;\\n      }\\n      return fragColor;\\n  }\\n#endif",srgb_frag:"vec3 linearTosRGB(const in vec3 color) {\\n    return vec3( color.r < 0.0031308 ? color.r * 12.92 : 1.055 * pow(color.r, 1.0/2.4) - 0.055, color.g < 0.0031308 ? color.g * 12.92 : 1.055 * pow(color.g, 1.0/2.4) - 0.055, color.b < 0.0031308 ? color.b * 12.92 : 1.055 * pow(color.b, 1.0/2.4) - 0.055);\\n}\\nvec3 sRGBToLinear(const in vec3 color) {\\n    return vec3( color.r < 0.04045 ? color.r * (1.0 / 12.92) : pow((color.r + 0.055) * (1.0 / 1.055), 2.4), color.g < 0.04045 ? color.g * (1.0 / 12.92) : pow((color.g + 0.055) * (1.0 / 1.055), 2.4), color.b < 0.04045 ? color.b * (1.0 / 12.92) : pow((color.b + 0.055) * (1.0 / 1.055), 2.4));\\n}"};var v={register(e,n){if(u[e])throw new Error(\`Key of ${ps}e} is already registered in ShaderLib.\`);u[e]=n},compile:e=>m(e)};const _=/^[ \\t]*#include +<([\\w\\d.]+)>/gm;function m(e){return e.replace(_,g)}function g(e,n){const t=u[n];if(!t)throw new Error("Can not resolve #include <"+n+">");return m(t)}const x=[[.263385,-.0252475],[-.38545,.054485],[-.139795,-.5379925],[-.2793775,.6875475],[.7139025,.4710925],[.90044,-.16422],[.4481775,-.82799],[-.9253375,-.2910625],[.3468025,1.02292],[-1.13742,.33522],[-.7676225,-.9123175],[-.2005775,-1.1774125],[-.926525,.96876],[1.12909,-.7500325],[.9603,1.14625]],p=x.length,A=[0,0];for(let e=0;e<x.length;e++)A[0]+=x[e][0],A[1]+=x[e][1];A[0]/=p,A[1]/=p;!function(e,n,t){var r=n[0],o=n[1],i=n[2],a=n[3],s=r+r,c=o+o,f=i+i,l=r*s,h=r*c,d=r*f,u=o*c,v=o*f,_=i*f,m=a*s,g=a*c,x=a*f;e[0]=1-(u+_),e[1]=h+x,e[2]=d-g,e[3]=0,e[4]=h-x,e[5]=1-(l+_),e[6]=v+m,e[7]=0,e[8]=d+g,e[9]=v-m,e[10]=1-(l+u),e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1}([],function(e,n,t,r){var o=.5*Math.PI/180;n*=o,t*=o,r*=o;var i=Math.sin(n),a=Math.cos(n),s=Math.sin(t),c=Math.cos(t),f=Math.sin(r),l=Math.cos(r);return e[0]=i*c*l-a*s*f,e[1]=a*s*l+i*c*f,e[2]=a*c*f-i*s*l,e[3]=a*c*l+i*s*f,e}([],90,0,0),[0,0,0]),function(){const e=[0,0,0],n=90*Math.PI/180,t=[0,0,0,0],r=new Array(16)}(),v.compile("#define SHADER_NAME SKYBOX\\n#if __VERSION__ == 100\\n#ifdef GL_EXT_shader_texture_lod\\n#extension GL_EXT_shader_texture_lod : enable\\n#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)\\n#else\\n#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)\\n#endif\\n#else\\n#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)\\n#endif\\nprecision highp float;\\n#include <gl2_frag>\\n#include <hsv_frag>\\nuniform vec3 hsv;\\nvarying vec3 vWorldPos;\\n#ifdef USE_AMBIENT\\nuniform vec3 diffuseSPH[9];\\n#else\\nuniform samplerCube cubeMap;\\nuniform float bias;\\nuniform float size;\\n#endif\\nuniform float environmentExposure;\\n#if defined(INPUT_RGBM) || defined(ENC_RGBM)\\nuniform float rgbmRange;\\n#endif\\nvec4 c(const in vec3 d, const in float e) {\\n  if(e <= .0)\\n    return vec4(d, 1.);\\n  vec4 f;\\n  vec3 h = d / e;\\n  f.a = clamp(max(max(h.r, h.g), max(h.b, 1e-6)), .0, 1.);\\n  f.a = ceil(f.a * 255.) / 255.;\\n  f.rgb = h / f.a;\\n  return f;\\n}\\nvec3 i(const in vec4 d, const in float e) {\\n  if(e <= .0)\\n    return d.rgb;\\n  return e * d.rgb * d.a;\\n}\\nvec4 j(const in samplerCube k, const in vec3 l, const in float m, const in float n) {\\n  vec3 o = l;\\n  return textureCubeLod(k, o, n);\\n}\\nvec3 u(const in vec3 v, const in vec3 A[9]) {\\n  float x = v.x;\\n  float y = v.y;\\n  float z = v.z;\\n  vec3 B = (A[0] + A[1] * x + A[2] * y + A[3] * z + A[4] * z * x + A[5] * y * z + A[6] * y * x + A[7] * (3. * z * z - 1.) + A[8] * (x * x - y * y));\\n  return max(B, vec3(.0));\\n}\\nfloat C(const in vec2 D) {\\n  vec3 E = fract(vec3(D.xyx) * .1031);\\n  E += dot(E, E.yzx + 19.19);\\n  return fract((E.x + E.y) * E.z);\\n}\\nvoid main() {\\n  vec4 F;\\n#ifdef USE_AMBIENT\\nvec3 v = normalize(vWorldPos + mix(-.5 / 255., .5 / 255., C(gl_FragCoord.xy)) * 2.);\\n  F = vec4(u(v, diffuseSPH), 1.);\\n  if(length(hsv) > .0) {\\n    F.rgb = hsv_apply(F.rgb, hsv);\\n  }\\n#else\\nF = j(cubeMap, vWorldPos, size, bias);\\n#endif\\nF.rgb *= environmentExposure;\\n#ifdef ENC_RGBM\\n#if !defined(USE_AMBIENT) && defined(INPUT_RGBM)\\nif(length(hsv) > .0) {\\n    F.rgb = hsv_apply(i(F, rgbmRange).rgb, hsv);\\n    F = c(F.rgb, rgbmRange);\\n  }\\n#else\\nF = c(F.rgb, rgbmRange);\\n#endif\\nglFragColor = F;\\n#elif !defined(USE_AMBIENT) && defined(INPUT_RGBM)\\nglFragColor = vec4(i(F, rgbmRange), 1.);\\n  if(length(hsv) > .0) {\\n    glFragColor.rgb = hsv_apply(clamp(glFragColor.rgb, .0, 1.), hsv);\\n  }\\n#else\\nif(length(hsv) > .0) {\\n    F.rgb = hsv_apply(F.rgb, hsv);\\n  }\\n  glFragColor = F;\\n#endif\\n#if __VERSION__ == 100\\ngl_FragColor = glFragColor;\\n#endif\\n}"),function(){const e=[[-1,-1,-1,1],[1,-1,-1,1],[1,1,-1,1],[-1,1,-1,1],[-1,-1,1,1],[1,-1,1,1],[1,1,1,1],[-1,1,1,1]],n=new Array(16)}(),function(){let e=new Array(4);const n=new Array(3),t=[0,0,0,0],r=[0,1,0],o=new Array(3);let i=new Array(16),a=new Array(16);const s=new Array(16),c=[1,1,1],f=[0,0,0]}();const b=new Uint8Array(4);new Float32Array(b.buffer);var y,w={exports:{}};function E(e,n,t){t=t||2;var r,o,i,a,s,c,f,l=n&&n.length,h=l?n[0]*t:e.length,d=T(e,0,h,t,!0),u=[];if(!d||d.next===d.prev)return u;if(l&&(d=function(e,n,t,r){var o,i,a,s=[];for(o=0,i=n.length;o<i;o++)(a=T(e,n[o]*r,o<i-1?n[o+1]*r:e.length,r,!1))===a.next&&(a.steiner=!0),s.push(R(a));for(s.sort(k),o=0;o<s.length;o++)t=N(s[o],t);return t}(e,n,d,t)),e.length>80*t){r=i=e[0],o=a=e[1];for(var v=t;v<h;v+=t)(s=e[v])<r&&(r=s),(c=e[v+1])<o&&(o=c),s>i&&(i=s),c>a&&(a=c);f=0!==(f=Math.max(i-r,a-o))?32767/f:0}return O(d,u,t,r,o,f,0),u}function T(e,n,t,r,o){var i,a;if(o===Z(e,n,t,r)>0)for(i=n;i<t;i+=r)a=B(i,e[i],e[i+1],a);else for(i=t-r;i>=n;i-=r)a=B(i,e[i],e[i+1],a);return a&&z(a,a.next)&&(K(a),a=a.next),a}function I(e,n){if(!e)return e;n||(n=e);var t,r=e;do{if(t=!1,r.steiner||!z(r,r.next)&&0!==F(r.prev,r,r.next))r=r.next;else{if(K(r),(r=n=r.prev)===r.next)break;t=!0}}while(t||r!==n);return n}function O(e,n,t,r,o,i,a){if(e){!a&&i&&function(e,n,t,r){var o=e;do{0===o.z&&(o.z=D(o.x,o.y,n,t,r)),o.prevZ=o.prev,o.nextZ=o.next,o=o.next}while(o!==e);o.prevZ.nextZ=null,o.prevZ=null,function(e){var n,t,r,o,i,a,s,c,f=1;do{for(t=e,e=null,i=null,a=0;t;){for(a++,r=t,s=0,n=0;n<f&&(s++,r=r.nextZ);n++);for(c=f;s>0||c>0&&r;)0!==s&&(0===c||!r||t.z<=r.z)?(o=t,t=t.nextZ,s--):(o=r,r=r.nextZ,c--),i?i.nextZ=o:e=o,o.prevZ=i,i=o;t=r}i.nextZ=null,f*=2}while(a>1)}(o)}(e,r,o,i);for(var s,c,f=e;e.prev!==e.next;)if(s=e.prev,c=e.next,i?C(e,r,o,i):S(e))n.push(s.i/t|0),n.push(e.i/t|0),n.push(c.i/t|0),K(e),e=c.next,f=c.next;else if((e=c)===f){a?1===a?O(e=M(I(e),n,t),n,t,r,o,i,2):2===a&&H(e,n,t,r,o,i):O(I(e),n,t,r,o,i,1);break}}}function S(e){var n=e.prev,t=e,r=e.next;if(F(n,t,r)>=0)return!1;for(var o=n.x,i=t.x,a=r.x,s=n.y,c=t.y,f=r.y,l=o<i?o<a?o:a:i<a?i:a,h=s<c?s<f?s:f:c<f?c:f,d=o>i?o>a?o:a:i>a?i:a,u=s>c?s>f?s:f:c>f?c:f,v=r.next;v!==n;){if(v.x>=l&&v.x<=d&&v.y>=h&&v.y<=u&&U(o,s,i,c,a,f,v.x,v.y)&&F(v.prev,v,v.next)>=0)return!1;v=v.next}return!0}function C(e,n,t,r){var o=e.prev,i=e,a=e.next;if(F(o,i,a)>=0)return!1;for(var s=o.x,c=i.x,f=a.x,l=o.y,h=i.y,d=a.y,u=s<c?s<f?s:f:c<f?c:f,v=l<h?l<d?l:d:h<d?h:d,_=s>c?s>f?s:f:c>f?c:f,m=l>h?l>d?l:d:h>d?h:d,g=D(u,v,n,t,r),x=D(_,m,n,t,r),p=e.prevZ,A=e.nextZ;p&&p.z>=g&&A&&A.z<=x;){if(p.x>=u&&p.x<=_&&p.y>=v&&p.y<=m&&p!==o&&p!==a&&U(s,l,c,h,f,d,p.x,p.y)&&F(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,A.x>=u&&A.x<=_&&A.y>=v&&A.y<=m&&A!==o&&A!==a&&U(s,l,c,h,f,d,A.x,A.y)&&F(A.prev,A,A.next)>=0)return!1;A=A.nextZ}for(;p&&p.z>=g;){if(p.x>=u&&p.x<=_&&p.y>=v&&p.y<=m&&p!==o&&p!==a&&U(s,l,c,h,f,d,p.x,p.y)&&F(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;A&&A.z<=x;){if(A.x>=u&&A.x<=_&&A.y>=v&&A.y<=m&&A!==o&&A!==a&&U(s,l,c,h,f,d,A.x,A.y)&&F(A.prev,A,A.next)>=0)return!1;A=A.nextZ}return!0}function M(e,n,t){var r=e;do{var o=r.prev,i=r.next.next;!z(o,i)&&W(o,r,r.next,i)&&j(o,i)&&j(i,o)&&(n.push(o.i/t|0),n.push(r.i/t|0),n.push(i.i/t|0),K(r),K(r.next),r=e=i),r=r.next}while(r!==e);return I(r)}function H(e,n,t,r,o,i){var a=e;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&L(a,s)){var c=X(a,s);return a=I(a,a.next),c=I(c,c.next),O(a,n,t,r,o,i,0),void O(c,n,t,r,o,i,0)}s=s.next}a=a.next}while(a!==e)}function k(e,n){return e.x-n.x}function N(e,n){var t=function(e,n){var t,r=n,o=e.x,i=e.y,a=-1/0;do{if(i<=r.y&&i>=r.next.y&&r.next.y!==r.y){var s=r.x+(i-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=o&&s>a&&(a=s,t=r.x<r.next.x?r:r.next,s===o))return t}r=r.next}while(r!==n);if(!t)return null;var c,f=t,l=t.x,h=t.y,d=1/0;r=t;do{o>=r.x&&r.x>=l&&o!==r.x&&U(i<h?o:a,i,l,h,i<h?a:o,i,r.x,r.y)&&(c=Math.abs(i-r.y)/(o-r.x),j(r,e)&&(c<d||c===d&&(r.x>t.x||r.x===t.x&&P(t,r)))&&(t=r,d=c)),r=r.next}while(r!==f);return t}(e,n);if(!t)return n;var r=X(t,e);return I(r,r.next),I(t,t.next)}function P(e,n){return F(e.prev,e,n.prev)<0&&F(n.next,e,e.next)<0}function D(e,n,t,r,o){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-t)*o|0)|e<<8))|e<<4))|e<<2))|e<<1))|(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-r)*o|0)|n<<8))|n<<4))|n<<2))|n<<1))<<1}function R(e){var n=e,t=e;do{(n.x<t.x||n.x===t.x&&n.y<t.y)&&(t=n),n=n.next}while(n!==e);return t}function U(e,n,t,r,o,i,a,s){return(o-a)*(n-s)>=(e-a)*(i-s)&&(e-a)*(r-s)>=(t-a)*(n-s)&&(t-a)*(i-s)>=(o-a)*(r-s)}function L(e,n){return e.next.i!==n.i&&e.prev.i!==n.i&&!function(e,n){var t=e;do{if(t.i!==e.i&&t.next.i!==e.i&&t.i!==n.i&&t.next.i!==n.i&&W(t,t.next,e,n))return!0;t=t.next}while(t!==e);return!1}(e,n)&&(j(e,n)&&j(n,e)&&function(e,n){var t=e,r=!1,o=(e.x+n.x)/2,i=(e.y+n.y)/2;do{t.y>i!=t.next.y>i&&t.next.y!==t.y&&o<(t.next.x-t.x)*(i-t.y)/(t.next.y-t.y)+t.x&&(r=!r),t=t.next}while(t!==e);return r}(e,n)&&(F(e.prev,e,n.prev)||F(e,n.prev,n))||z(e,n)&&F(e.prev,e,e.next)>0&&F(n.prev,n,n.next)>0)}function F(e,n,t){return(n.y-e.y)*(t.x-n.x)-(n.x-e.x)*(t.y-n.y)}function z(e,n){return e.x===n.x&&e.y===n.y}function W(e,n,t,r){var o=V(F(e,n,t)),i=V(F(e,n,r)),a=V(F(t,r,e)),s=V(F(t,r,n));return o!==i&&a!==s||!(0!==o||!G(e,t,n))||!(0!==i||!G(e,r,n))||!(0!==a||!G(t,e,r))||!(0!==s||!G(t,n,r))}function G(e,n,t){return n.x<=Math.max(e.x,t.x)&&n.x>=Math.min(e.x,t.x)&&n.y<=Math.max(e.y,t.y)&&n.y>=Math.min(e.y,t.y)}function V(e){return e>0?1:e<0?-1:0}function j(e,n){return F(e.prev,e,e.next)<0?F(e,n,e.next)>=0&&F(e,e.prev,n)>=0:F(e,n,e.prev)<0||F(e,e.next,n)<0}function X(e,n){var t=new q(e.i,e.x,e.y),r=new q(n.i,n.x,n.y),o=e.next,i=n.prev;return e.next=n,n.prev=e,t.next=o,o.prev=t,r.next=t,t.prev=r,i.next=r,r.prev=i,r}function B(e,n,t,r){var o=new q(e,n,t);return r?(o.next=r.next,o.prev=r,r.next.prev=o,r.next=o):(o.prev=o,o.next=o),o}function K(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function q(e,n,t){this.i=e,this.x=n,this.y=t,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Z(e,n,t,r){for(var o=0,i=n,a=t-r;i<t;i+=r)o+=(e[a]-e[i])*(e[i+1]+e[a+1]),a=i;return o}w.exports=E,w.exports.default=E,E.deviation=function(e,n,t,r){var o=n&&n.length,i=Math.abs(Z(e,0,o?n[0]*t:e.length,t));if(o)for(var a=0,s=n.length;a<s;a++)i-=Math.abs(Z(e,n[a]*t,a<s-1?n[a+1]*t:e.length,t));var c=0;for(a=0;a<r.length;a+=3){var f=r[a]*t,l=r[a+1]*t,h=r[a+2]*t;c+=Math.abs((e[f]-e[h])*(e[l+1]-e[f+1])-(e[f]-e[l])*(e[h+1]-e[f+1]))}return 0===i&&0===c?0:Math.abs((c-i)/i)},E.flatten=function(e){for(var n=e[0][0].length,t={vertices:[],holes:[],dimensions:n},r=0,o=0;o<e.length;o++){for(var i=0;i<e[o].length;i++)for(var a=0;a<n;a++)t.vertices.push(e[o][i][a]);o>0&&t.holes.push(r+=e[o-1].length)}return t},(y=w.exports)&&y.T&&Object.prototype.hasOwnProperty.call(y,"default")&&y.default;class Y{constructor(e=257){this.gridSize=e;const n=e-1;if(n&n-1)throw new Error(\`Expected grid size to be 2^n+1, got ${ps}e}.\`);this.numTriangles=n*n*2-2,this.numParentTriangles=this.numTriangles-n*n,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(4*this.numTriangles);for(let e=0;e<this.numTriangles;e++){let t=e+2,r=0,o=0,i=0,a=0,s=0,c=0;for(1&t?i=a=s=n:r=o=c=n;(t>>=1)>1;){const e=r+i>>1,n=o+a>>1;1&t?(i=r,a=o,r=s,o=c):(r=i,o=a,i=s,a=c),s=e,c=n}const f=4*e;this.coords[f+0]=r,this.coords[f+1]=o,this.coords[f+2]=i,this.coords[f+3]=a}}createTile(e){return new J(e,this)}}class J{constructor(e,n){const t=n.gridSize;if(e.length!==t*t)throw new Error(\`Expected terrain data of length ${ps}t*t} (${ps}t} x ${ps}t}), got ${ps}e.length}.\`);this.terrain=e,this.martini=n,this.errors=new Float32Array(e.length),this.update()}update(){const{numTriangles:e,numParentTriangles:n,coords:t,gridSize:r}=this.martini,{terrain:o,errors:i}=this;for(let a=e-1;a>=0;a--){const e=4*a,s=t[e+0],c=t[e+1],f=t[e+2],l=t[e+3],h=s+f>>1,d=c+l>>1,u=h+d-c,v=d+s-h,_=(o[c*r+s]+o[l*r+f])/2,m=d*r+h,g=Math.abs(_-o[m]);if(i[m]=Math.max(i[m],g),a<n){const e=(c+v>>1)*r+(s+u>>1),n=(l+v>>1)*r+(f+u>>1);i[m]=Math.max(i[m],i[e],i[n])}}}getMesh(e=0){const{gridSize:n,indices:t}=this.martini,{errors:r}=this;let o=0,i=0;const a=n-1;function s(a,c,f,l,h,d){const u=a+f>>1,v=c+l>>1;Math.abs(a-h)+Math.abs(c-d)>1&&r[v*n+u]>e?(s(h,d,a,c,u,v),s(f,l,h,d,u,v)):(t[c*n+a]=t[c*n+a]||++o,t[l*n+f]=t[l*n+f]||++o,t[d*n+h]=t[d*n+h]||++o,i++)}t.fill(0),s(0,0,a,a,a,0),s(a,a,0,0,0,a);const c=new Uint16Array(2*o),f=new Uint32Array(3*i);let l=0;function h(o,i,a,s,d,u){const v=o+a>>1,_=i+s>>1;if(Math.abs(o-d)+Math.abs(i-u)>1&&r[_*n+v]>e)h(d,u,o,i,v,_),h(a,s,d,u,v,_);else{const e=t[i*n+o]-1,r=t[s*n+a]-1,h=t[u*n+d]-1;c[2*e]=o,c[2*e+1]=i,c[2*r]=a,c[2*r+1]=s,c[2*h]=d,c[2*h+1]=u,f[l++]=e,f[l++]=r,f[l++]=h}}return h(0,0,a,a,a,0),h(a,a,0,0,0,a),{vertices:c,triangles:f}}getMeshWithSkirts(e=0,n){const{gridSize:t,indices:r}=this.martini,{errors:o}=this;let i=0,a=0;const s=t-1;let c,f,l=0;const h=[],d=[],u=[],v=[];function _(n,m,g,x,p,A){const b=n+g>>1,y=m+x>>1;Math.abs(n-p)+Math.abs(m-A)>1&&o[y*t+b]>e?(_(p,A,n,m,b,y),_(g,x,p,A,b,y)):(c=m*t+n,f=x*t+g,l=A*t+p,0===r[c]&&(0===n?h.push(i):n===s&&d.push(i),0===m?u.push(i):m===s&&v.push(i),r[c]=++i),0===r[f]&&(0===g?h.push(i):g===s&&d.push(i),0===x?u.push(i):x===s&&v.push(i),r[f]=++i),0===r[l]&&(0===p?h.push(i):p===s&&d.push(i),0===A?u.push(i):A===s&&v.push(i),r[l]=++i),a++)}let m;r.fill(0),_(0,0,s,s,s,0),_(s,s,0,0,0,s),m=n?2*(i+3*h.length-2+3*d.length-2+3*u.length-2+3*v.length-2):2*(i+h.length+d.length+u.length+v.length);const g=3*(a+2*(h.length-1)+2*(d.length-1)+2*(u.length-1)+2*(v.length-1)),x=new Uint16Array(m),p=new Uint32Array(g);let A=0;function b(n,i,a,s,c,f){const l=n+a>>1,h=i+s>>1;if(Math.abs(n-c)+Math.abs(i-f)>1&&o[h*t+l]>e)b(c,f,n,i,l,h),b(a,s,c,f,l,h);else{const e=r[i*t+n]-1,o=r[s*t+a]-1,l=r[f*t+c]-1;x[2*e]=n,x[2*e+1]=i,x[2*o]=a,x[2*o+1]=s,x[2*l]=c,x[2*l+1]=f,p[A++]=e,p[A++]=o,p[A++]=l}}b(0,0,s,s,s,0),b(s,s,0,0,0,s),h.sort(((e,n)=>x[2*e+1]-x[2*n+1])),d.sort(((e,n)=>x[2*n+1]-x[2*e+1])),u.sort(((e,n)=>x[2*n]-x[2*e])),v.sort(((e,n)=>x[2*e]-x[2*n]));let y,w,E,T,I=2*i,O=0;function S(e){O=e.length;for(let t=0;t<O-1;t++)y=e[t],w=e[t+1],E=I/2,T=(I+(n?6:2))/2,x[I++]=2*y,x[I++]=2*y+1,n&&(x[I++]=2*y,x[I++]=2*y+1,x[I++]=2*w,x[I++]=2*w+1),n?(p[A++]=E+1,p[A++]=E,p[A++]=E+2,p[A++]=E,p[A++]=T,p[A++]=E+2):(p[A++]=y,p[A++]=E,p[A++]=w,p[A++]=E,p[A++]=T,p[A++]=w);x[I++]=2*e[O-1],x[I++]=2*e[O-1]+1}S(h);const C=I;S(d);const M=I;S(u);const H=I;S(v);return{vertices:x,triangles:p,numVerticesWithoutSkirts:i,numTrianglesWithoutSkirts:a,leftSkirtIndex:C,rightSkirtIndex:M,bottomSkirtIndex:H,topSkirtIndex:I}}}const $={};let Q;const ee={width:100,height:10};let ne,te=!1;try{const e=new OffscreenCanvas(1,1);e.getContext("2d").fillText("hello",0,0),te=!0}catch(e){te=!1}function re(){if(!Q){const{width:e,height:n}=ee;te?Q=new OffscreenCanvas(e,n):(Q=document.createElement("canvas"),Q.width=e,Q.height=n)}return Q}class oe{constructor(e,n={}){if(!Array.isArray(e))return void console.error("colors is not array");if(e.length<2)return void console.error("colors.length should >1");this.colors=e;let t=1/0,r=-1/0;for(let n=0,o=e.length;n<o;n++){const o=e[n][0];t=Math.min(o,t),r=Math.max(o,r)}this.min=t,this.max=r,this.valueOffset=this.max-this.min,this.options=Object.assign({},ee,n),this.O()}getImageData(){return this.imgData}O(){const e=re(),{width:n,height:t}=this.options;e.width=n,e.height=t;const r=e.getContext("2d");r.clearRect(0,0,e.width,e.height);const o=r.createLinearGradient(0,0,e.width,0),{colors:i,valueOffset:a}=this;for(let e=0,n=i.length;e<n;e++){const[n,t]=i[e],r=(n-this.min)/a;o.addColorStop(r,t)}r.fillStyle=o,r.fillRect(0,0,e.width,e.height),this.imgData=r.getImageData(0,0,e.width,e.height)}getColor(e){e=Math.max(this.min,e);const n=((e=Math.min(e,this.max))-this.min)/this.valueOffset;let t=Math.round(n*this.imgData.width);t=Math.min(t,this.imgData.width-1);const r=4*t;return[this.imgData.data[r],this.imgData.data[r+1],this.imgData.data[r+2],this.imgData.data[r+3]]}}let ie=null,ae=null;const se={},ce={},fe={width:64,height:64,elementsPerHeight:3,heightOffset:-1e3,exaggeration:1,heightScale:.001,elementMultiplier:256,stride:4,skirtHeight:.002,skirtOffset:.01},le={cesium_request_token:{Accept:"application/json,*/*;q=0.01","Accept-Encoding":"gzip, deflate, br"},tianditu:{"Accept-Encoding":"gzip, deflate, br"},cesium:{"Accept-Encoding":"gzip, deflate, br",Accept:"application/vnd.quantized-mesh,application/octet-stream;q=0.9,*/*;q=0.01"},mapbox:{Accept:"image/webp,*/*"}};le["cesium-ion"]=le.cesium;const he=32767;let de=null,ue=null;function ve(e,n){const t=function(e){if(e.length<1e3)return null;const n=new Zlib.Inflate(e);return n?n.decompress():null}(new Uint8Array(e));if(!t)throw new Error((r=new Uint8Array(e),_e.decode(r)));var r;const o=function(e){const n=e,t=fe.width,r=fe.height,o=new Uint8Array(t*r*fe.stride);let i,a,s,c,f;for(let e=0;e<r;e++)for(let l=0;l<t;l++){c=parseInt(149*e/(r-1)),f=parseInt(149*l/(t-1)),a=2*(150*c+f),i=n[a]+256*n[a+1],(i>1e4||i<-2e3)&&(i=0),s=4*(e*t+l);const h=(i+1e3)/fe.heightScale,d=fe.elementMultiplier;o[s]=h/(d*d),o[s+1]=(h-o[s]*d*d)/d,o[s+2]=h-o[s]*d*d-o[s+1]*d,o[s+3]=255}return o}(t),i=function(e,n){const t=n,r=n,o=t+1,i=r+1,a=fe.elementsPerHeight,s=fe.heightOffset,c=fe.heightScale,f=fe.elementMultiplier,l=fe.skirtHeight,h=new Float32Array(o*i);let d=0,u=1/0,v=-1/0;for(let n=0;n<o;n++){const o=n>=r?r-1:n;for(let n=0;n<i;n++){let r=0;const i=o*(4*t)+4*(n>=t?t-1:n);for(let n=0;n<a;n++)r=r*f+e[i+n];r=1*(r*c+s),r-=l,h[d]=r,r<u&&(u=r),r>v&&(v=r),d++}}return{data:h,min:u,max:v}}(o,n-1);return i.width=i.height=n,i}const _e=new TextDecoder("utf-8");function me(e){return e>>1^-(1&e)}const ge=[];function xe(e){let n=0;const t=3*Float64Array.BYTES_PER_ELEMENT,r=3*Uint16Array.BYTES_PER_ELEMENT;let o=Uint16Array.BYTES_PER_ELEMENT;const i=new DataView(e);n+=t;const a=i.getFloat32(n,!0);n+=Float32Array.BYTES_PER_ELEMENT;const s=i.getFloat32(n,!0);n+=Float32Array.BYTES_PER_ELEMENT,n+=t;const c=i.getFloat64(n,!0);n+=Float64Array.BYTES_PER_ELEMENT,n+=t;const f=i.getUint32(n,!0);n+=Uint32Array.BYTES_PER_ELEMENT;const l=new Uint16Array(e,n,3*f);n+=f*r,f>65536&&(o=Uint32Array.BYTES_PER_ELEMENT);!function(e,n,t){const r=e.length;let o=0,i=0,a=0;for(let s=0;s<r;++s)o+=me(e[s]),i+=me(n[s]),e[s]=o,n[s]=i,t&&(a+=me(t[s]),t[s]=a)}(l.subarray(0,f),l.subarray(f,2*f),l.subarray(2*f,3*f)),n%o!=0&&(n+=o-n%o);const h=i.getUint32(n,!0);n+=Uint32Array.BYTES_PER_ELEMENT;const d=f>65536?new Uint32Array(e,n,3*h):new Uint16Array(e,n,3*h);let u=0;const v=d.length;for(let e=0;e<v;++e){const n=d[e];d[e]=u-n,0===n&&++u}const _={minimumHeight:a,maximumHeight:s,quantizedVertices:l,indices:d}.quantizedVertices,m=_.length/3,g=_.subarray(0,m),x=_.subarray(m,2*m),p=_.subarray(2*m,3*m),A=ge;for(let e=0;e<m;++e){const n=g[e],t=x[e],r=n/he,o=t/he,i=(b=a,y=s,(1-(w=p[e]/he))*b+w*y);A[3*e]=r,A[3*e+1]=1-o,A[3*e+2]=i}var b,y,w;return{positions:A,radius:c,min:a,max:s,indices:d}}const pe=[],Ae=[],be=[],ye=[],we=[];class Ee{constructor(e,n,t,r,o){this.p0=[],this.p1=[],this.p2=[],this.normal=[],this.min=[],this.max=[],this.set(e,n,t,r,o)}set(e,n,t,r,o){this.radius=o;let c=3*n,f=3*n+1,l=3*n+2;this.p0[0]=e[c]*o,this.p0[1]=e[f]*o,this.p0[2]=e[l],c=3*t,f=3*t+1,l=3*t+2,this.p1[0]=e[c]*o,this.p1[1]=e[f]*o,this.p1[2]=e[l],c=3*r,f=3*r+1,l=3*r+2,this.p2[0]=e[c]*o,this.p2[1]=e[f]*o,this.p2[2]=e[l],this.min[0]=Math.min(this.p0[0],this.p1[0],this.p2[0]),this.min[1]=Math.min(this.p0[1],this.p1[1],this.p2[1]),this.max[0]=Math.max(this.p0[0],this.p1[0],this.p2[0]),this.max[1]=Math.max(this.p0[1],this.p1[1],this.p2[1]);const h=s(pe,this.p1,this.p0),d=s(Ae,this.p2,this.p1);this.normal=i(this.normal,a(this.normal,h,d))}contains(e,n){if(e<this.min[0]||e>this.max[0]||n<this.min[1]||n>this.max[1])return!1;l(be,this.p0[0],this.p0[1]),l(ye,this.p1[0],this.p1[1]),l(we,this.p2[0],this.p2[1]);const t=Se(be[0],be[1],ye[0],ye[1],we[0],we[1]);return Se(e,n,be[0],be[1],we[0],we[1])+Se(e,n,be[0],be[1],ye[0],ye[1])+Se(e,n,ye[0],ye[1],we[0],we[1])-t<=1e-4}getHeight(e,n){const t=this.normal;return this.p0[2]-((e-this.p0[0])*t[0]+(n-this.p0[1])*t[1])/t[2]}}let Te=null;function Ie(e,n,t){if(Te&&Te.contains(n,t))return Te.getHeight(n,t);for(let r=0;r<e.length;r++)if(e[r].contains(n,t))return Te=e[r],e[r].getHeight(n,t);return 0}const Oe=[];function Se(e,n,t,r,o,i){return.5*Math.abs(e*r+t*i+o*n-e*i-t*n-o*r)}function Ce(e,n,t,r,o,i){"cesium-ion"===t&&(n.Authorization="Bearer "+de),function(e,n,t){const r={method:"GET",referrer:t,headers:n},o=d.getArrayBuffer(e,r),i=o.xhr;return ce[e]=i,o.then((n=>(delete ce[e],n)))}(e,n,origin).then((e=>{if(!e||e.message)i(e?{empty:!0,originalError:e}:{error:{canceled:!0}});else{const n=e.data;let a=null;if("tianditu"===t){const e=ve(n,r);Me(o,e,r,null,!0,i)}else if("cesium-ion"===t||"cesium"===t){a=xe(n);const e=function(e,n){const{positions:t,min:r,max:o,indices:i,radius:a}=e,s=[];let c=0;for(let e=0;e<i.length;e+=3){let n=Oe[c];n?n.set(t,i[e],i[e+1],i[e+2],2*a):n=Oe[c]=new Ee(t,i[e],i[e+1],i[e+2],2*a),c++,s.push(n)}const f=new Float32Array(n*n);c=0;for(let e=0;e<n;e++)for(let t=0;t<n;t++)f[c++]=Ie(s,t/n*a*2,e/n*a*2);return{data:f,min:r,max:o,width:n,height:n}}(a,r);Me(o,e,r,null,!0,i)}else"mapbox"===t&&(a=function(e){const n=new self.Blob([new Uint8Array(e)]);return self.createImageBitmap(n)}(n),a.then((e=>{const n=function(e){const{width:n,height:t}=e;ie||(ie=new OffscreenCanvas(1,1),ae=ie.getContext("2d",{willReadFrequently:!0}));return ie.width=n,ie.height=t,ae.drawImage(e,0,0,n,t),ae.getImageData(0,0,n,t)}(e),t=function(e,n){const{data:t,width:r}=e;let o=1/0,i=-1/0;const a=new Float32Array(n*n),s=Math.round(r/n);for(let e=0;e<n;e++)for(let c=0;c<n;c++){const f=e+c*n;let l=0,h=0;const d=e,u=c;for(let e=0;e<s;e++)for(let n=0;n<s;n++){let o=d*s+e,i=u*s+n;i>r-1&&(i=r-1),o>r-1&&(o=r-1);const a=o+i*r,c=t[4*a],f=t[4*a+1],v=t[4*a+2];0===t[4*a+3]?h+=1:l+=.1*(256*c*256+256*f+v)-1e4}l/=s*s-h||1,l>i&&(i=l),l<o&&(o=l),a[f]=l}return{data:a,width:n,height:n,min:o,max:i}}(n,r);Me(o,t,r,e,!0,i)})))}})).catch((n=>{delete ce[e],i({empty:!0,originalError:n})}))}function Me(e,n,t,r,o,i){const a=function(e,n,t,r){let o=$[t];o||(o=$[t]=new Y(t));const i=o.createTile(n).getMeshWithSkirts(e,!0),{triangles:a,vertices:s,leftSkirtIndex:c,rightSkirtIndex:f,bottomSkirtIndex:l,topSkirtIndex:h}=i;let{numVerticesWithoutSkirts:d,numTrianglesWithoutSkirts:u}=i;d||(d=s.legnth/3,u=a.length/3);const v=s.length/2,_=new Float32Array(3*v),m=new Float32Array(2*v);let g=1/0,x=-1/0;const p=t-1;for(let e=0;e<v;e++){const r=s[2*e],o=s[2*e+1];if(e>=d){const n=r/2*3;let t,o=.001;(e-(e<c/2?d:e<f/2?c/2:e<l/2?f/2:l/2))%3==0?(t=0,o=0):t=_[n+2],_[3*e]=_[n],_[3*e+1]=_[n+1],_[3*e+2]=t,m[2*e]=_[n]/p+o,m[2*e+1]=-_[n+1]/p+o}else _[3*e]=1*r,_[3*e+1]=1*-o,_[3*e+2]=n[o*t+r],m[2*e]=r/p,m[2*e+1]=o/p;const i=_[_.length-1];i<g&&(g=i),i>x&&(x=i)}return{positions:_,texcoords:m,triangles:a,leftSkirtIndex:c,rightSkirtIndex:f,bottomSkirtIndex:l,topSkirtIndex:h,numTrianglesWithoutSkirts:u,numVerticesWithoutSkirts:d,minHeight:g,maxHeight:x,terrainWidth:t}}(e,n.data,t),s=[a.positions.buffer,a.texcoords.buffer,a.triangles.buffer];r&&s.push(r);const c={mesh:a};c.image=r,c.data=n,s.push(n.data.buffer),i(c,s)}function He(e,n){if(!n||!Array.isArray(n)||n.length<2)return;if(!e||!e.image)return null;let{width:t,height:r}=e.image;t*=2,r*=2;try{if(ie||(ie=new OffscreenCanvas(1,1)),!ie)return;const o=ie;o.width=t,o.height=r;const i=o.getContext("2d",{willReadFrequently:!0});!function(e){const n=e.canvas,{width:t,height:r}=n;e.clearRect(0,0,t,r)}(i),i.drawImage(e.image,0,0,t,r);const a=i.getImageData(0,0,t,r);return function(e,n){const t=JSON.stringify(n);se[t]||(se[t]=new oe(n));const r=se[t],o=e.data;for(let e=0,n=o.length;e<n;e+=4){const n=o[e],t=o[e+1],i=o[e+2];let a=0;0!==o[e+3]&&(a=.1*(256*n*256+256*t+i)-1e4,a=Math.max(a,0));const[s,c,f]=r.getColor(a);o[e]=s,o[e+1]=c,o[e+2]=f,o[e+3]=255}}(a,n),new Uint8Array(a.data)}catch(e){console.error(e)}}e.initialize=function(){},e.onmessage=function(e,n){const t=e.data;if("addLayer"===t.command||"removeLayer"===t.command)ne=e.workerId,self.postMessage({type:"<response>",actorId:t.actorId,workerId:ne,params:"ok",callback:e.callback});else if("fetchTerrain"===t.command){const e=(t.params||{}).colors;!function(e,n){const{url:t,origin:r,type:o,accessToken:i,terrainWidth:a,error:s}=e,c=e.headers||le[o];if("tianditu"===o)Ce(t,c,o,a,s,n);else if("cesium-ion"===o){const f=e.cesiumIonTokenURL+i;de?Ce(t,c,o,a,s,n):(ue||(ue=fetch(f,{responseType:"json",method:"GET",referrer:r,headers:{Accept:"application/json,*/*;q=0.01","Accept-Encoding":"gzip, deflate, br"}}).then((e=>e.json())).then((e=>{de=e.accessToken,ue=null}))),ue.then((()=>{Ce(t,c,o,a,s,n)})))}else("cesium"===o||"mapbox"===o)&&Ce(t,c,o,a,s,n)}(t.params,((t,r)=>{const o=He(t,e);o&&(t.colorsTexture=o,(r=r||[]).push(o.buffer)),n(t.error,t,r)}))}else"abortTerrain"===t.command&&(r=t.params.url,ce[r]&&(ce[r].abort(),delete ce[r]));var r}}`;Rs("@maptalks/terrain",Tz),typeof console<"u"&&console.log("@maptalks/gl v0.98.2");var Mz=yl;function yl(r,t){this.x=r,this.y=t}yl.prototype={clone:function(){return new yl(this.x,this.y)},add:function(r){return this.clone()._add(r)},sub:function(r){return this.clone()._sub(r)},multByPoint:function(r){return this.clone()._multByPoint(r)},divByPoint:function(r){return this.clone()._divByPoint(r)},mult:function(r){return this.clone()._mult(r)},div:function(r){return this.clone()._div(r)},rotate:function(r){return this.clone()._rotate(r)},rotateAround:function(r,t){return this.clone()._rotateAround(r,t)},matMult:function(r){return this.clone()._matMult(r)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(r){return this.x===r.x&&this.y===r.y},dist:function(r){return Math.sqrt(this.distSqr(r))},distSqr:function(r){var t=r.x-this.x,e=r.y-this.y;return t*t+e*e},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(r){return Math.atan2(this.y-r.y,this.x-r.x)},angleWith:function(r){return this.angleWithSep(r.x,r.y)},angleWithSep:function(r,t){return Math.atan2(this.x*t-this.y*r,this.x*r+this.y*t)},_matMult:function(r){var t=r[0]*this.x+r[1]*this.y,e=r[2]*this.x+r[3]*this.y;return this.x=t,this.y=e,this},_add:function(r){return this.x+=r.x,this.y+=r.y,this},_sub:function(r){return this.x-=r.x,this.y-=r.y,this},_mult:function(r){return this.x*=r,this.y*=r,this},_div:function(r){return this.x/=r,this.y/=r,this},_multByPoint:function(r){return this.x*=r.x,this.y*=r.y,this},_divByPoint:function(r){return this.x/=r.x,this.y/=r.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var r=this.y;return this.y=this.x,this.x=-r,this},_rotate:function(r){var t=Math.cos(r),e=Math.sin(r),n=t*this.x-e*this.y,i=e*this.x+t*this.y;return this.x=n,this.y=i,this},_rotateAround:function(r,t){var e=Math.cos(r),n=Math.sin(r),i=t.x+e*(this.x-t.x)-n*(this.y-t.y),o=t.y+n*(this.x-t.x)+e*(this.y-t.y);return this.x=i,this.y=o,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},yl.convert=function(r){return r instanceof yl?r:Array.isArray(r)?new yl(r[0],r[1]):r};const sn=Us(Mz);function Oi(r,t,e){e=e||{},this.w=r||64,this.h=t||64,this.autoResize=!!e.autoResize,this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0}Oi.prototype.pack=function(r,t){r=[].concat(r),t=t||{};for(var e=[],n,i,o,s,a=0;a<r.length;a++)if(n=r[a].w||r[a].width,i=r[a].h||r[a].height,o=r[a].id,n&&i){if(s=this.packOne(n,i,o),!s)continue;t.inPlace&&(r[a].x=s.x,r[a].y=s.y,r[a].id=s.id),e.push(s)}return this.shrink(),e},Oi.prototype.packOne=function(r,t,e){var n={freebin:-1,shelf:-1,waste:1/0},i=0,o,s,a,l;if(typeof e=="string"||typeof e=="number"){if(o=this.getBin(e),o)return this.ref(o),o;typeof e=="number"&&(this.maxId=Math.max(e,this.maxId))}else e=++this.maxId;for(l=0;l<this.freebins.length;l++){if(o=this.freebins[l],t===o.maxh&&r===o.maxw)return this.allocFreebin(l,r,t,e);t>o.maxh||r>o.maxw||t<=o.maxh&&r<=o.maxw&&(a=o.maxw*o.maxh-r*t,a<n.waste&&(n.waste=a,n.freebin=l))}for(l=0;l<this.shelves.length;l++)if(s=this.shelves[l],i+=s.h,!(r>s.free)){if(t===s.h)return this.allocShelf(l,r,t,e);t>s.h||t<s.h&&(a=(s.h-t)*r,a<n.waste&&(n.freebin=-1,n.waste=a,n.shelf=l))}if(n.freebin!==-1)return this.allocFreebin(n.freebin,r,t,e);if(n.shelf!==-1)return this.allocShelf(n.shelf,r,t,e);if(t<=this.h-i&&r<=this.w)return s=new hy(i,this.w,t),this.allocShelf(this.shelves.push(s)-1,r,t,e);if(this.autoResize){var h,u,c,f;return h=u=this.h,c=f=this.w,(c<=h||r>c)&&(f=Math.max(r,c)*2),(h<c||t>h)&&(u=Math.max(t,h)*2),this.resize(f,u),this.packOne(r,t,e)}return null},Oi.prototype.allocFreebin=function(r,t,e,n){var i=this.freebins.splice(r,1)[0];return i.id=n,i.w=t,i.h=e,i.refcount=0,this.bins[n]=i,this.ref(i),i},Oi.prototype.allocShelf=function(r,t,e,n){var i=this.shelves[r],o=i.alloc(t,e,n);return this.bins[n]=o,this.ref(o),o},Oi.prototype.shrink=function(){if(this.shelves.length>0){for(var r=0,t=0,e=0;e<this.shelves.length;e++){var n=this.shelves[e];t+=n.h,r=Math.max(n.w-n.free,r)}this.resize(r,t)}},Oi.prototype.getBin=function(r){return this.bins[r]},Oi.prototype.ref=function(r){if(++r.refcount===1){var t=r.h;this.stats[t]=(this.stats[t]|0)+1}return r.refcount},Oi.prototype.unref=function(r){return r.refcount===0?0:(--r.refcount===0&&(this.stats[r.h]--,delete this.bins[r.id],this.freebins.push(r)),r.refcount)},Oi.prototype.clear=function(){this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0},Oi.prototype.resize=function(r,t){this.w=r,this.h=t;for(var e=0;e<this.shelves.length;e++)this.shelves[e].resize(r);return!0};function hy(r,t,e){this.x=0,this.y=r,this.w=this.free=t,this.h=e}hy.prototype.alloc=function(r,t,e){if(r>this.free||t>this.h)return null;var n=this.x;return this.x+=r,this.free-=r,new Sz(e,n,this.y,r,t,r,this.h)},hy.prototype.resize=function(r){return this.free+=r-this.w,this.w=r,!0};function Sz(r,t,e,n,i,o,s){this.id=r,this.x=t,this.y=e,this.w=n,this.h=i,this.maxw=o||n,this.maxh=s||i,this.refcount=0}let vl;const DT={width:100,height:10};function Cz(){if(!vl){const{width:r,height:t}=DT;OffscreenCanvas?vl=new OffscreenCanvas(r,t):(vl=document.createElement("canvas"),vl.width=r,vl.height=t)}return vl}class FT{constructor(t,e={}){if(!Array.isArray(t)){console.error("colors is not array");return}if(t.length<2){console.error("colors.length should >1");return}this.colors=t;let n=1/0,i=-1/0;for(let o=0,s=t.length;o<s;o++){const a=t[o][0];n=Math.min(a,n),i=Math.max(a,i)}this.min=n,this.max=i,this.valueOffset=this.max-this.min,this.options=Object.assign({},DT,e),this._initImgData()}getImageData(){return this.imgData}_initImgData(){const t=Cz(),{width:e,height:n}=this.options;t.width=e,t.height=n;const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);const o=i.createLinearGradient(0,0,t.width,0),{colors:s,valueOffset:a}=this;for(let l=0,h=s.length;l<h;l++){const[u,c]=s[l],f=(u-this.min)/a;o.addColorStop(f,c)}i.fillStyle=o,i.fillRect(0,0,t.width,t.height),this.imgData=i.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t),t=Math.min(t,this.max);const e=(t-this.min)/this.valueOffset;let n=Math.round(e*this.imgData.width);n=Math.min(n,this.imgData.width-1);const i=n*4,o=this.imgData.data[i],s=this.imgData.data[i+1],a=this.imgData.data[i+2],l=this.imgData.data[i+3];return[o,s,a,l]}}var Pz=typeof Map=="function",mu;Pz&&(mu=new Map);function LT(r,t){var e,n,i;if(!Ft(r))e=function(){return r},n=!0,i=!0;else{var o=r.stops&&typeof r.stops[0][0]=="object",s=o||r.property!==void 0,a=o||!s,l=r.type||t||"exponential",h;if(l==="exponential")h=zT;else if(l==="interval")h=kz;else if(l==="categorical")h=Oz;else if(l==="identity")h=Rz;else if(l==="color-interpolate")h=Iz;else throw new Error('Unknown function type "'+l+'"');if(o){var u={},c=[];for(let d=0;d<r.stops.length;d++){var f=r.stops[d];u[f[0].zoom]===void 0&&(u[f[0].zoom]={zoom:f[0].zoom,type:r.type,property:r.property,default:r.default,stops:[]}),u[f[0].zoom].stops.push([f[0].value,f[1]])}for(let d in u)c.push([u[d].zoom,LT(u[d])]);e=function(d,p){const g=zT({stops:c,base:r.base},d)(d,p);return typeof g=="function"?g(d,p):g},n=!1,i=!1}else a?(e=function(d){const p=h(r,d);return typeof p=="function"?p(d):p},n=!0,i=!1):(e=function(d,p){const g=h(r,p?p[r.property]:null);return typeof g=="function"?g(d,p):g},n=!1,i=!0)}return e.isZoomConstant=i,e.isFeatureConstant=n,e}function Ez(r,t,e){return r!==void 0?r:t!==void 0?t:null}function Oz(r,t){for(let e=0;e<r.stops.length;e++)if(t===r.stops[e][0])return r.stops[e][1];return r.default}function kz(r,t){for(var e=0;e<r.stops.length&&!(t<r.stops[e][0]);e++);return r.stops[Math.max(e-1,0)][1]}function zT(r,t){for(var e=r.base!==void 0?r.base:1,n=0;!(n>=r.stops.length);){if(t<=r.stops[n][0])break;n++}return n===0?r.stops[n][1]:n===r.stops.length?r.stops[n-1][1]:NT(t,e,r.stops[n-1][0],r.stops[n][0],r.stops[n-1][1],r.stops[n][1])}const HT={width:100,height:1};function Iz(r,t){const e=r.stops;if(e&&e.length>1){let n;if(mu){const l=JSON.stringify(e);if(!mu.has(l)){const h=new FT(e,HT);mu.set(l,h)}n=mu.get(l)}else n=new FT(e,HT);const[i,o,s,a]=n.getColor(t);return[i/255,o/255,s/255,a/255]}else if(e&&e.length===1)return e[0][1];return null}function Rz(r,t){return Ez(t,r.default)}function NT(r,t,e,n,i,o){return typeof i=="function"?function(){var s=i.apply(void 0,arguments),a=o.apply(void 0,arguments);return NT(r,t,e,n,s,a)}:i.length?Dz(r,t,e,n,i,o):BT(r,t,e,n,i,o)}function BT(r,t,e,n,i,o){var s=n-e,a=r-e,l;return t===1?l=a/s:l=(Math.pow(t,a)-1)/(Math.pow(t,s)-1),i*(1-l)+o*l}function Dz(r,t,e,n,i,o){var s=[];for(let a=0;a<i.length;a++)s[a]=BT(r,t,e,n,i[a],o[a]);return s}function Ft(r){return r&&typeof r=="object"&&(r.stops||r.property&&r.type==="identity")}function le(r){return uy(r,"exponential")}function cn(r){return uy(r,"interval")}function yu(r,t){if(!r)return null;var e=!1;if(Array.isArray(r)){var n=[],i;for(let h=0;h<r.length;h++)i=yu(r[h],t),i?(n.push(i),e=!0):n.push(r[h]);return e?n:r}var o={__fn_types_loaded:!0},s=[],a;for(a in r)r.hasOwnProperty(a)&&s.push(a);const l=function(h){Object.defineProperty(o,h,{get:function(){return this["__fn_"+h]||(this["__fn_"+h]=le(this["_"+h])),this["__fn_"+h].apply(this,t())},set:function(u){this["_"+h]=u},configurable:!0,enumerable:!0})};for(let h=0,u=s.length;h<u;h++)a=s[h],Ft(r[a])?(e=!0,o["_"+a]=r[a],l(a)):o[a]=r[a];return e?o:r}function uy(r,t){if(!Ft(r))return function(){return r};r=JSON.parse(JSON.stringify(r));let e=!0,n=!0;const i=r.stops;if(i){for(let s=0;s<i.length;s++)if(Ft(i[s][1])){const a=uy(i[s][1],t);e=e&&a.isZoomConstant,n=n&&a.isFeatureConstant,i[s]=[i[s][0],a]}}const o=LT(r,t);return o.isZoomConstant=e&&o.isZoomConstant,o.isFeatureConstant=n&&o.isFeatureConstant,o}var jT={exports:{}},Fz={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},VT={exports:{}},Lz=function(t){return!t||typeof t=="string"?!1:t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&t.constructor.name!=="String")},zz=Lz,Hz=Array.prototype.concat,Nz=Array.prototype.slice,GT=VT.exports=function(t){for(var e=[],n=0,i=t.length;n<i;n++){var o=t[n];zz(o)?e=Hz.call(e,Nz.call(o)):e.push(o)}return e};GT.wrap=function(r){return function(){return r(GT(arguments))}};var Bz=VT.exports,vu=Fz,xu=Bz,UT=Object.hasOwnProperty,$T=Object.create(null);for(var cy in vu)UT.call(vu,cy)&&($T[vu[cy]]=cy);var mi=jT.exports={to:{},get:{}};mi.get=function(r){var t=r.substring(0,3).toLowerCase(),e,n;switch(t){case"hsl":e=mi.get.hsl(r),n="hsl";break;case"hwb":e=mi.get.hwb(r),n="hwb";break;default:e=mi.get.rgb(r),n="rgb";break}return e?{model:n,value:e}:null},mi.get.rgb=function(r){if(!r)return null;var t=/^#([a-f0-9]{3,4})$/i,e=/^#([a-f0-9]{6})([a-f0-9]{2})?$/i,n=/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/,i=/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/,o=/^(\w+)$/,s=[0,0,0,1],a,l,h;if(a=r.match(e)){for(h=a[2],a=a[1],l=0;l<3;l++){var u=l*2;s[l]=parseInt(a.slice(u,u+2),16)}h&&(s[3]=parseInt(h,16)/255)}else if(a=r.match(t)){for(a=a[1],h=a[3],l=0;l<3;l++)s[l]=parseInt(a[l]+a[l],16);h&&(s[3]=parseInt(h+h,16)/255)}else if(a=r.match(n)){for(l=0;l<3;l++)s[l]=parseInt(a[l+1],0);a[4]&&(a[5]?s[3]=parseFloat(a[4])*.01:s[3]=parseFloat(a[4]))}else if(a=r.match(i)){for(l=0;l<3;l++)s[l]=Math.round(parseFloat(a[l+1])*2.55);a[4]&&(a[5]?s[3]=parseFloat(a[4])*.01:s[3]=parseFloat(a[4]))}else return(a=r.match(o))?a[1]==="transparent"?[0,0,0,0]:UT.call(vu,a[1])?(s=vu[a[1]],s[3]=1,s):null:null;for(l=0;l<3;l++)s[l]=gs(s[l],0,255);return s[3]=gs(s[3],0,1),s},mi.get.hsl=function(r){if(!r)return null;var t=/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/,e=r.match(t);if(e){var n=parseFloat(e[4]),i=(parseFloat(e[1])%360+360)%360,o=gs(parseFloat(e[2]),0,100),s=gs(parseFloat(e[3]),0,100),a=gs(isNaN(n)?1:n,0,1);return[i,o,s,a]}return null},mi.get.hwb=function(r){if(!r)return null;var t=/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/,e=r.match(t);if(e){var n=parseFloat(e[4]),i=(parseFloat(e[1])%360+360)%360,o=gs(parseFloat(e[2]),0,100),s=gs(parseFloat(e[3]),0,100),a=gs(isNaN(n)?1:n,0,1);return[i,o,s,a]}return null},mi.to.hex=function(){var r=xu(arguments);return"#"+ld(r[0])+ld(r[1])+ld(r[2])+(r[3]<1?ld(Math.round(r[3]*255)):"")},mi.to.rgb=function(){var r=xu(arguments);return r.length<4||r[3]===1?"rgb("+Math.round(r[0])+", "+Math.round(r[1])+", "+Math.round(r[2])+")":"rgba("+Math.round(r[0])+", "+Math.round(r[1])+", "+Math.round(r[2])+", "+r[3]+")"},mi.to.rgb.percent=function(){var r=xu(arguments),t=Math.round(r[0]/255*100),e=Math.round(r[1]/255*100),n=Math.round(r[2]/255*100);return r.length<4||r[3]===1?"rgb("+t+"%, "+e+"%, "+n+"%)":"rgba("+t+"%, "+e+"%, "+n+"%, "+r[3]+")"},mi.to.hsl=function(){var r=xu(arguments);return r.length<4||r[3]===1?"hsl("+r[0]+", "+r[1]+"%, "+r[2]+"%)":"hsla("+r[0]+", "+r[1]+"%, "+r[2]+"%, "+r[3]+")"},mi.to.hwb=function(){var r=xu(arguments),t="";return r.length>=4&&r[3]!==1&&(t=", "+r[3]),"hwb("+r[0]+", "+r[1]+"%, "+r[2]+"%"+t+")"},mi.to.keyword=function(r){return $T[r.slice(0,3)]};function gs(r,t,e){return Math.min(Math.max(t,r),e)}function ld(r){var t=Math.round(r).toString(16).toUpperCase();return t.length<2?"0"+t:t}var jz=jT.exports,WT={exports:{}},Vz={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},na=Vz,ZT={};for(var fy in na)na.hasOwnProperty(fy)&&(ZT[na[fy]]=fy);var ge=WT.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var ni in ge)if(ge.hasOwnProperty(ni)){if(!("channels"in ge[ni]))throw new Error("missing channels property: "+ni);if(!("labels"in ge[ni]))throw new Error("missing channel labels property: "+ni);if(ge[ni].labels.length!==ge[ni].channels)throw new Error("channel and label counts mismatch: "+ni);var Gz=ge[ni].channels,Uz=ge[ni].labels;delete ge[ni].channels,delete ge[ni].labels,Object.defineProperty(ge[ni],"channels",{value:Gz}),Object.defineProperty(ge[ni],"labels",{value:Uz})}ge.rgb.hsl=function(r){var t=r[0]/255,e=r[1]/255,n=r[2]/255,i=Math.min(t,e,n),o=Math.max(t,e,n),s=o-i,a,l,h;return o===i?a=0:t===o?a=(e-n)/s:e===o?a=2+(n-t)/s:n===o&&(a=4+(t-e)/s),a=Math.min(a*60,360),a<0&&(a+=360),h=(i+o)/2,o===i?l=0:h<=.5?l=s/(o+i):l=s/(2-o-i),[a,l*100,h*100]},ge.rgb.hsv=function(r){var t,e,n,i,o,s=r[0]/255,a=r[1]/255,l=r[2]/255,h=Math.max(s,a,l),u=h-Math.min(s,a,l),c=function(f){return(h-f)/6/u+1/2};return u===0?i=o=0:(o=u/h,t=c(s),e=c(a),n=c(l),s===h?i=n-e:a===h?i=1/3+t-n:l===h&&(i=2/3+e-t),i<0?i+=1:i>1&&(i-=1)),[i*360,o*100,h*100]},ge.rgb.hwb=function(r){var t=r[0],e=r[1],n=r[2],i=ge.rgb.hsl(r)[0],o=1/255*Math.min(t,Math.min(e,n));return n=1-1/255*Math.max(t,Math.max(e,n)),[i,o*100,n*100]},ge.rgb.cmyk=function(r){var t=r[0]/255,e=r[1]/255,n=r[2]/255,i,o,s,a;return a=Math.min(1-t,1-e,1-n),i=(1-t-a)/(1-a)||0,o=(1-e-a)/(1-a)||0,s=(1-n-a)/(1-a)||0,[i*100,o*100,s*100,a*100]};function $z(r,t){return Math.pow(r[0]-t[0],2)+Math.pow(r[1]-t[1],2)+Math.pow(r[2]-t[2],2)}ge.rgb.keyword=function(r){var t=ZT[r];if(t)return t;var e=1/0,n;for(var i in na)if(na.hasOwnProperty(i)){var o=na[i],s=$z(r,o);s<e&&(e=s,n=i)}return n},ge.keyword.rgb=function(r){return na[r]},ge.rgb.xyz=function(r){var t=r[0]/255,e=r[1]/255,n=r[2]/255;t=t>.04045?Math.pow((t+.055)/1.055,2.4):t/12.92,e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92,n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92;var i=t*.4124+e*.3576+n*.1805,o=t*.2126+e*.7152+n*.0722,s=t*.0193+e*.1192+n*.9505;return[i*100,o*100,s*100]},ge.rgb.lab=function(r){var t=ge.rgb.xyz(r),e=t[0],n=t[1],i=t[2],o,s,a;return e/=95.047,n/=100,i/=108.883,e=e>.008856?Math.pow(e,1/3):7.787*e+16/116,n=n>.008856?Math.pow(n,1/3):7.787*n+16/116,i=i>.008856?Math.pow(i,1/3):7.787*i+16/116,o=116*n-16,s=500*(e-n),a=200*(n-i),[o,s,a]},ge.hsl.rgb=function(r){var t=r[0]/360,e=r[1]/100,n=r[2]/100,i,o,s,a,l;if(e===0)return l=n*255,[l,l,l];n<.5?o=n*(1+e):o=n+e-n*e,i=2*n-o,a=[0,0,0];for(var h=0;h<3;h++)s=t+1/3*-(h-1),s<0&&s++,s>1&&s--,6*s<1?l=i+(o-i)*6*s:2*s<1?l=o:3*s<2?l=i+(o-i)*(2/3-s)*6:l=i,a[h]=l*255;return a},ge.hsl.hsv=function(r){var t=r[0],e=r[1]/100,n=r[2]/100,i=e,o=Math.max(n,.01),s,a;return n*=2,e*=n<=1?n:2-n,i*=o<=1?o:2-o,a=(n+e)/2,s=n===0?2*i/(o+i):2*e/(n+e),[t,s*100,a*100]},ge.hsv.rgb=function(r){var t=r[0]/60,e=r[1]/100,n=r[2]/100,i=Math.floor(t)%6,o=t-Math.floor(t),s=255*n*(1-e),a=255*n*(1-e*o),l=255*n*(1-e*(1-o));switch(n*=255,i){case 0:return[n,l,s];case 1:return[a,n,s];case 2:return[s,n,l];case 3:return[s,a,n];case 4:return[l,s,n];case 5:return[n,s,a]}},ge.hsv.hsl=function(r){var t=r[0],e=r[1]/100,n=r[2]/100,i=Math.max(n,.01),o,s,a;return a=(2-e)*n,o=(2-e)*i,s=e*i,s/=o<=1?o:2-o,s=s||0,a/=2,[t,s*100,a*100]},ge.hwb.rgb=function(r){var t=r[0]/360,e=r[1]/100,n=r[2]/100,i=e+n,o,s,a,l;i>1&&(e/=i,n/=i),o=Math.floor(6*t),s=1-n,a=6*t-o,o&1&&(a=1-a),l=e+a*(s-e);var h,u,c;switch(o){default:case 6:case 0:h=s,u=l,c=e;break;case 1:h=l,u=s,c=e;break;case 2:h=e,u=s,c=l;break;case 3:h=e,u=l,c=s;break;case 4:h=l,u=e,c=s;break;case 5:h=s,u=e,c=l;break}return[h*255,u*255,c*255]},ge.cmyk.rgb=function(r){var t=r[0]/100,e=r[1]/100,n=r[2]/100,i=r[3]/100,o,s,a;return o=1-Math.min(1,t*(1-i)+i),s=1-Math.min(1,e*(1-i)+i),a=1-Math.min(1,n*(1-i)+i),[o*255,s*255,a*255]},ge.xyz.rgb=function(r){var t=r[0]/100,e=r[1]/100,n=r[2]/100,i,o,s;return i=t*3.2406+e*-1.5372+n*-.4986,o=t*-.9689+e*1.8758+n*.0415,s=t*.0557+e*-.204+n*1.057,i=i>.0031308?1.055*Math.pow(i,1/2.4)-.055:i*12.92,o=o>.0031308?1.055*Math.pow(o,1/2.4)-.055:o*12.92,s=s>.0031308?1.055*Math.pow(s,1/2.4)-.055:s*12.92,i=Math.min(Math.max(0,i),1),o=Math.min(Math.max(0,o),1),s=Math.min(Math.max(0,s),1),[i*255,o*255,s*255]},ge.xyz.lab=function(r){var t=r[0],e=r[1],n=r[2],i,o,s;return t/=95.047,e/=100,n/=108.883,t=t>.008856?Math.pow(t,1/3):7.787*t+16/116,e=e>.008856?Math.pow(e,1/3):7.787*e+16/116,n=n>.008856?Math.pow(n,1/3):7.787*n+16/116,i=116*e-16,o=500*(t-e),s=200*(e-n),[i,o,s]},ge.lab.xyz=function(r){var t=r[0],e=r[1],n=r[2],i,o,s;o=(t+16)/116,i=e/500+o,s=o-n/200;var a=Math.pow(o,3),l=Math.pow(i,3),h=Math.pow(s,3);return o=a>.008856?a:(o-16/116)/7.787,i=l>.008856?l:(i-16/116)/7.787,s=h>.008856?h:(s-16/116)/7.787,i*=95.047,o*=100,s*=108.883,[i,o,s]},ge.lab.lch=function(r){var t=r[0],e=r[1],n=r[2],i,o,s;return i=Math.atan2(n,e),o=i*360/2/Math.PI,o<0&&(o+=360),s=Math.sqrt(e*e+n*n),[t,s,o]},ge.lch.lab=function(r){var t=r[0],e=r[1],n=r[2],i,o,s;return s=n/360*2*Math.PI,i=e*Math.cos(s),o=e*Math.sin(s),[t,i,o]},ge.rgb.ansi16=function(r){var t=r[0],e=r[1],n=r[2],i=1 in arguments?arguments[1]:ge.rgb.hsv(r)[2];if(i=Math.round(i/50),i===0)return 30;var o=30+(Math.round(n/255)<<2|Math.round(e/255)<<1|Math.round(t/255));return i===2&&(o+=60),o},ge.hsv.ansi16=function(r){return ge.rgb.ansi16(ge.hsv.rgb(r),r[2])},ge.rgb.ansi256=function(r){var t=r[0],e=r[1],n=r[2];if(t===e&&e===n)return t<8?16:t>248?231:Math.round((t-8)/247*24)+232;var i=16+36*Math.round(t/255*5)+6*Math.round(e/255*5)+Math.round(n/255*5);return i},ge.ansi16.rgb=function(r){var t=r%10;if(t===0||t===7)return r>50&&(t+=3.5),t=t/10.5*255,[t,t,t];var e=(~~(r>50)+1)*.5,n=(t&1)*e*255,i=(t>>1&1)*e*255,o=(t>>2&1)*e*255;return[n,i,o]},ge.ansi256.rgb=function(r){if(r>=232){var t=(r-232)*10+8;return[t,t,t]}r-=16;var e,n=Math.floor(r/36)/5*255,i=Math.floor((e=r%36)/6)/5*255,o=e%6/5*255;return[n,i,o]},ge.rgb.hex=function(r){var t=((Math.round(r[0])&255)<<16)+((Math.round(r[1])&255)<<8)+(Math.round(r[2])&255),e=t.toString(16).toUpperCase();return"000000".substring(e.length)+e},ge.hex.rgb=function(r){var t=r.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!t)return[0,0,0];var e=t[0];t[0].length===3&&(e=e.split("").map(function(a){return a+a}).join(""));var n=parseInt(e,16),i=n>>16&255,o=n>>8&255,s=n&255;return[i,o,s]},ge.rgb.hcg=function(r){var t=r[0]/255,e=r[1]/255,n=r[2]/255,i=Math.max(Math.max(t,e),n),o=Math.min(Math.min(t,e),n),s=i-o,a,l;return s<1?a=o/(1-s):a=0,s<=0?l=0:i===t?l=(e-n)/s%6:i===e?l=2+(n-t)/s:l=4+(t-e)/s+4,l/=6,l%=1,[l*360,s*100,a*100]},ge.hsl.hcg=function(r){var t=r[1]/100,e=r[2]/100,n=1,i=0;return e<.5?n=2*t*e:n=2*t*(1-e),n<1&&(i=(e-.5*n)/(1-n)),[r[0],n*100,i*100]},ge.hsv.hcg=function(r){var t=r[1]/100,e=r[2]/100,n=t*e,i=0;return n<1&&(i=(e-n)/(1-n)),[r[0],n*100,i*100]},ge.hcg.rgb=function(r){var t=r[0]/360,e=r[1]/100,n=r[2]/100;if(e===0)return[n*255,n*255,n*255];var i=[0,0,0],o=t%1*6,s=o%1,a=1-s,l=0;switch(Math.floor(o)){case 0:i[0]=1,i[1]=s,i[2]=0;break;case 1:i[0]=a,i[1]=1,i[2]=0;break;case 2:i[0]=0,i[1]=1,i[2]=s;break;case 3:i[0]=0,i[1]=a,i[2]=1;break;case 4:i[0]=s,i[1]=0,i[2]=1;break;default:i[0]=1,i[1]=0,i[2]=a}return l=(1-e)*n,[(e*i[0]+l)*255,(e*i[1]+l)*255,(e*i[2]+l)*255]},ge.hcg.hsv=function(r){var t=r[1]/100,e=r[2]/100,n=t+e*(1-t),i=0;return n>0&&(i=t/n),[r[0],i*100,n*100]},ge.hcg.hsl=function(r){var t=r[1]/100,e=r[2]/100,n=e*(1-t)+.5*t,i=0;return n>0&&n<.5?i=t/(2*n):n>=.5&&n<1&&(i=t/(2*(1-n))),[r[0],i*100,n*100]},ge.hcg.hwb=function(r){var t=r[1]/100,e=r[2]/100,n=t+e*(1-t);return[r[0],(n-t)*100,(1-n)*100]},ge.hwb.hcg=function(r){var t=r[1]/100,e=r[2]/100,n=1-e,i=n-t,o=0;return i<1&&(o=(n-i)/(1-i)),[r[0],i*100,o*100]},ge.apple.rgb=function(r){return[r[0]/65535*255,r[1]/65535*255,r[2]/65535*255]},ge.rgb.apple=function(r){return[r[0]/255*65535,r[1]/255*65535,r[2]/255*65535]},ge.gray.rgb=function(r){return[r[0]/100*255,r[0]/100*255,r[0]/100*255]},ge.gray.hsl=ge.gray.hsv=function(r){return[0,0,r[0]]},ge.gray.hwb=function(r){return[0,100,r[0]]},ge.gray.cmyk=function(r){return[0,0,0,r[0]]},ge.gray.lab=function(r){return[r[0],0,0]},ge.gray.hex=function(r){var t=Math.round(r[0]/100*255)&255,e=(t<<16)+(t<<8)+t,n=e.toString(16).toUpperCase();return"000000".substring(n.length)+n},ge.rgb.gray=function(r){var t=(r[0]+r[1]+r[2])/3;return[t/255*100]};var XT=WT.exports,hd=XT;function Wz(){for(var r={},t=Object.keys(hd),e=t.length,n=0;n<e;n++)r[t[n]]={distance:-1,parent:null};return r}function Zz(r){var t=Wz(),e=[r];for(t[r].distance=0;e.length;)for(var n=e.pop(),i=Object.keys(hd[n]),o=i.length,s=0;s<o;s++){var a=i[s],l=t[a];l.distance===-1&&(l.distance=t[n].distance+1,l.parent=n,e.unshift(a))}return t}function Xz(r,t){return function(e){return t(r(e))}}function Yz(r,t){for(var e=[t[r].parent,r],n=hd[t[r].parent][r],i=t[r].parent;t[i].parent;)e.unshift(t[i].parent),n=Xz(hd[t[i].parent][i],n),i=t[i].parent;return n.conversion=e,n}var qz=function(r){for(var t=Zz(r),e={},n=Object.keys(t),i=n.length,o=0;o<i;o++){var s=n[o],a=t[s];a.parent!==null&&(e[s]=Yz(s,t))}return e},dy=XT,Jz=qz,xl={},Kz=Object.keys(dy);function Qz(r){var t=function(e){return e==null?e:(arguments.length>1&&(e=Array.prototype.slice.call(arguments)),r(e))};return"conversion"in r&&(t.conversion=r.conversion),t}function tH(r){var t=function(e){if(e==null)return e;arguments.length>1&&(e=Array.prototype.slice.call(arguments));var n=r(e);if(typeof n=="object")for(var i=n.length,o=0;o<i;o++)n[o]=Math.round(n[o]);return n};return"conversion"in r&&(t.conversion=r.conversion),t}Kz.forEach(function(r){xl[r]={},Object.defineProperty(xl[r],"channels",{value:dy[r].channels}),Object.defineProperty(xl[r],"labels",{value:dy[r].labels});var t=Jz(r),e=Object.keys(t);e.forEach(function(n){var i=t[n];xl[r][n]=tH(i),xl[r][n].raw=Qz(i)})});var eH=xl,_u=jz,yi=eH,py=[].slice,YT=["keyword","gray","hex"],gy={};Object.keys(yi).forEach(function(r){gy[py.call(yi[r].labels).sort().join("")]=r});var ud={};function Sr(r,t){if(!(this instanceof Sr))return new Sr(r,t);if(t&&t in YT&&(t=null),t&&!(t in yi))throw new Error("Unknown model: "+t);var e,n;if(r==null)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(r instanceof Sr)this.model=r.model,this.color=r.color.slice(),this.valpha=r.valpha;else if(typeof r=="string"){var i=_u.get(r);if(i===null)throw new Error("Unable to parse color from string: "+r);this.model=i.model,n=yi[this.model].channels,this.color=i.value.slice(0,n),this.valpha=typeof i.value[n]=="number"?i.value[n]:1}else if(r.length){this.model=t||"rgb",n=yi[this.model].channels;var o=py.call(r,0,n);this.color=my(o,n),this.valpha=typeof r[n]=="number"?r[n]:1}else if(typeof r=="number")r&=16777215,this.model="rgb",this.color=[r>>16&255,r>>8&255,r&255],this.valpha=1;else{this.valpha=1;var s=Object.keys(r);"alpha"in r&&(s.splice(s.indexOf("alpha"),1),this.valpha=typeof r.alpha=="number"?r.alpha:0);var a=s.sort().join("");if(!(a in gy))throw new Error("Unable to parse color from object: "+JSON.stringify(r));this.model=gy[a];var l=yi[this.model].labels,h=[];for(e=0;e<l.length;e++)h.push(r[l[e]]);this.color=my(h)}if(ud[this.model])for(n=yi[this.model].channels,e=0;e<n;e++){var u=ud[this.model][e];u&&(this.color[e]=u(this.color[e]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}Sr.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(r){var t=this.model in _u.to?this:this.rgb();t=t.round(typeof r=="number"?r:1);var e=t.valpha===1?t.color:t.color.concat(this.valpha);return _u.to[t.model](e)},percentString:function(r){var t=this.rgb().round(typeof r=="number"?r:1),e=t.valpha===1?t.color:t.color.concat(this.valpha);return _u.to.rgb.percent(e)},array:function(){return this.valpha===1?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var r={},t=yi[this.model].channels,e=yi[this.model].labels,n=0;n<t;n++)r[e[n]]=this.color[n];return this.valpha!==1&&(r.alpha=this.valpha),r},unitArray:function(){var r=this.rgb().color;return r[0]/=255,r[1]/=255,r[2]/=255,this.valpha!==1&&r.push(this.valpha),r},unitObject:function(){var r=this.rgb().object();return r.r/=255,r.g/=255,r.b/=255,this.valpha!==1&&(r.alpha=this.valpha),r},round:function(r){return r=Math.max(r||0,0),new Sr(this.color.map(rH(r)).concat(this.valpha),this.model)},alpha:function(r){return arguments.length?new Sr(this.color.concat(Math.max(0,Math.min(1,r))),this.model):this.valpha},red:Zn("rgb",0,fr(255)),green:Zn("rgb",1,fr(255)),blue:Zn("rgb",2,fr(255)),hue:Zn(["hsl","hsv","hsl","hwb","hcg"],0,function(r){return(r%360+360)%360}),saturationl:Zn("hsl",1,fr(100)),lightness:Zn("hsl",2,fr(100)),saturationv:Zn("hsv",1,fr(100)),value:Zn("hsv",2,fr(100)),chroma:Zn("hcg",1,fr(100)),gray:Zn("hcg",2,fr(100)),white:Zn("hwb",1,fr(100)),wblack:Zn("hwb",2,fr(100)),cyan:Zn("cmyk",0,fr(100)),magenta:Zn("cmyk",1,fr(100)),yellow:Zn("cmyk",2,fr(100)),black:Zn("cmyk",3,fr(100)),x:Zn("xyz",0,fr(100)),y:Zn("xyz",1,fr(100)),z:Zn("xyz",2,fr(100)),l:Zn("lab",0,fr(100)),a:Zn("lab",1),b:Zn("lab",2),keyword:function(r){return arguments.length?new Sr(r):yi[this.model].keyword(this.color)},hex:function(r){return arguments.length?new Sr(r):_u.to.hex(this.rgb().round().color)},rgbNumber:function(){var r=this.rgb().color;return(r[0]&255)<<16|(r[1]&255)<<8|r[2]&255},luminosity:function(){for(var r=this.rgb().color,t=[],e=0;e<r.length;e++){var n=r[e]/255;t[e]=n<=.03928?n/12.92:Math.pow((n+.055)/1.055,2.4)}return .2126*t[0]+.7152*t[1]+.0722*t[2]},contrast:function(r){var t=this.luminosity(),e=r.luminosity();return t>e?(t+.05)/(e+.05):(e+.05)/(t+.05)},level:function(r){var t=this.contrast(r);return t>=7.1?"AAA":t>=4.5?"AA":""},isDark:function(){var r=this.rgb().color,t=(r[0]*299+r[1]*587+r[2]*114)/1e3;return t<128},isLight:function(){return!this.isDark()},negate:function(){for(var r=this.rgb(),t=0;t<3;t++)r.color[t]=255-r.color[t];return r},lighten:function(r){var t=this.hsl();return t.color[2]+=t.color[2]*r,t},darken:function(r){var t=this.hsl();return t.color[2]-=t.color[2]*r,t},saturate:function(r){var t=this.hsl();return t.color[1]+=t.color[1]*r,t},desaturate:function(r){var t=this.hsl();return t.color[1]-=t.color[1]*r,t},whiten:function(r){var t=this.hwb();return t.color[1]+=t.color[1]*r,t},blacken:function(r){var t=this.hwb();return t.color[2]+=t.color[2]*r,t},grayscale:function(){var r=this.rgb().color,t=r[0]*.3+r[1]*.59+r[2]*.11;return Sr.rgb(t,t,t)},fade:function(r){return this.alpha(this.valpha-this.valpha*r)},opaquer:function(r){return this.alpha(this.valpha+this.valpha*r)},rotate:function(r){var t=this.hsl(),e=t.color[0];return e=(e+r)%360,e=e<0?360+e:e,t.color[0]=e,t},mix:function(r,t){if(!r||!r.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof r);var e=r.rgb(),n=this.rgb(),i=t===void 0?.5:t,o=2*i-1,s=e.alpha()-n.alpha(),a=((o*s===-1?o:(o+s)/(1+o*s))+1)/2,l=1-a;return Sr.rgb(a*e.red()+l*n.red(),a*e.green()+l*n.green(),a*e.blue()+l*n.blue(),e.alpha()*i+n.alpha()*(1-i))}},Object.keys(yi).forEach(function(r){if(YT.indexOf(r)===-1){var t=yi[r].channels;Sr.prototype[r]=function(){if(this.model===r)return new Sr(this);if(arguments.length)return new Sr(arguments,r);var e=typeof arguments[t]=="number"?t:this.valpha;return new Sr(iH(yi[this.model][r].raw(this.color)).concat(e),r)},Sr[r]=function(e){return typeof e=="number"&&(e=my(py.call(arguments),t)),new Sr(e,r)}}});function nH(r,t){return Number(r.toFixed(t))}function rH(r){return function(t){return nH(t,r)}}function Zn(r,t,e){return r=Array.isArray(r)?r:[r],r.forEach(function(n){(ud[n]||(ud[n]=[]))[t]=e}),r=r[0],function(n){var i;return arguments.length?(e&&(n=e(n)),i=this[r](),i.color[t]=n,i):(i=this[r]().color[t],e&&(i=e(i)),i)}}function fr(r){return function(t){return Math.max(0,Math.min(r,t))}}function iH(r){return Array.isArray(r)?r:[r]}function my(r,t){for(var e=0;e<t;e++)typeof r[e]!="number"&&(r[e]=0);return r}var oH=Sr;const Wi=Us(oH);/*!
      Feature Filter by

      (c) mapbox 2016 and maptalks 2018
      www.mapbox.com | www.maptalks.org
      License: MIT, header required.
  */const qT=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function sH(r){return typeof r=="object"&&!!r}function JT(r){return new Function("f",`var p = (f && f.properties || {}); return ${QT(r)}`)}function KT(r){if(r===!0||r===!1)return!0;if(!Array.isArray(r)||r.length===0)return!1;switch(r[0]){case"has":case"!has":return r.length===2&&(typeof r[1]=="string"||r[1].property&&r[1].op);case"in":case"!in":return r.length>=2&&(typeof r[1]=="string"||r[1].property&&r[1].op);case"==":case"!=":case">":case">=":case"<":case"<=":return r.length===3&&(typeof r[1]=="string"||r[1].property&&r[1].op);case"none":case"any":case"all":for(const t of r.slice(1))if(!KT(t)&&typeof t!="boolean")return!1;return!0;case"contains":return!0;default:return!1}}function QT(r){if(!r)return"true";const t=r[0];return r.length<=1?t==="any"?"false":"true":`(${t==="=="?yy(r[1],r[2],"===",!1):t==="!="?yy(r[1],r[2],"!==",!1):t==="<"||t===">"||t==="<="||t===">="?yy(r[1],r[2],t,!0):t==="any"?vy(r.slice(1),"||"):t==="all"?vy(r.slice(1),"&&"):t==="none"?xy(vy(r.slice(1),"||")):t==="in"?eM(r[1],r.slice(2)):t==="!in"?xy(eM(r[1],r.slice(2))):t==="has"?nM(r[1]):t==="!has"?xy(nM(r[1])):t==="contains"?lH(r[1],r[2],r[3]):"true"})`}function aH(r,t,e,n){const i=r.property,o=r.op;let s=cd(i);if(o==="length")s=`((${s}+='').length)`;else return console.error(`not support ${o} op`),"false";return tM(s,i,t,e,n)}function lH(r,t,e){const n=cd(r);return e!==void 0?`(${n} + '').indexOf("${t}") === ${e}`:`(${n} + '').indexOf("${t}") >= 0`}function cd(r){return r[0]==="$"?"f."+r.substring(1):"p["+JSON.stringify(r)+"]"}function yy(r,t,e,n){if(sH(r)&&r.op)return aH(r,t,e,n);const i=cd(r);return tM(i,r,t,e,n)}function tM(r,t,e,n,i){const o=t==="$type"?qT.indexOf(e):JSON.stringify(e);return(i?`typeof ${r}=== typeof ${o}&&`:"")+r+n+o}function vy(r,t){return r.map(QT).join(t)}function eM(r,t){r==="$type"&&(t=t.map(i=>qT.indexOf(i)));const e=JSON.stringify(t.sort(hH)),n=cd(r);return t.length<=200?`${e}.indexOf(${n}) !== -1`:`function(v, a, i, j) {
        while (i <= j) { var m = (i + j) >> 1;
            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;
        }
    return false; }(${n}, ${e},0,${t.length-1})`}function nM(r){return r==="$id"?'"id" in f':`${JSON.stringify(r)} in p`}function xy(r){return`!(${r})`}function hH(r,t){return r<t?-1:r>t?1:0}var rM={exports:{}};(function(r,t){(function(e,n){r.exports=n()})(Vb,function(){function e(s,a,l,h,u){n(s,a,l||0,h||s.length-1,u||o)}function n(s,a,l,h,u){for(;h>l;){if(h-l>600){var c=h-l+1,f=a-l+1,d=Math.log(c),p=.5*Math.exp(2*d/3),g=.5*Math.sqrt(d*p*(c-p)/c)*(f-c/2<0?-1:1),m=Math.max(l,Math.floor(a-f*p/c+g)),y=Math.min(h,Math.floor(a+(c-f)*p/c+g));n(s,a,m,y,u)}var x=s[a],v=l,_=h;for(i(s,l,a),u(s[h],x)>0&&i(s,l,h);v<_;){for(i(s,v,_),v++,_--;u(s[v],x)<0;)v++;for(;u(s[_],x)>0;)_--}u(s[l],x)===0?i(s,l,_):(_++,i(s,_,h)),_<=a&&(l=_+1),a<=_&&(h=_-1)}}function i(s,a,l){var h=s[a];s[a]=s[l],s[l]=h}function o(s,a){return s<a?-1:s>a?1:0}return e})})(rM);var uH=rM.exports;const cH=Us(uH);class fH{constructor(t=[],e=dH){if(this.data=t,this.length=this.data.length,this.compare=e,this.length>0)for(let n=(this.length>>1)-1;n>=0;n--)this._down(n)}push(t){this.data.push(t),this.length++,this._up(this.length-1)}pop(){if(this.length===0)return;const t=this.data[0],e=this.data.pop();return this.length--,this.length>0&&(this.data[0]=e,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:e,compare:n}=this,i=e[t];for(;t>0;){const o=t-1>>1,s=e[o];if(n(i,s)>=0)break;e[t]=s,t=o}e[t]=i}_down(t){const{data:e,compare:n}=this,i=this.length>>1,o=e[t];for(;t<i;){let s=(t<<1)+1,a=e[s];const l=s+1;if(l<this.length&&n(e[l],a)<0&&(s=l,a=e[l]),n(a,o)>=0)break;e[t]=a,t=s}e[t]=o}}function dH(r,t){return r<t?-1:r>t?1:0}var _y={exports:{}};_y.exports=fd,_y.exports.default=fd;function fd(r,t,e){e=e||2;var n=t&&t.length,i=n?t[0]*e:r.length,o=iM(r,0,i,e,!0),s=[];if(!o||o.next===o.prev)return s;var a,l,h,u,c,f,d;if(n&&(o=vH(r,t,o,e)),r.length>80*e){a=h=r[0],l=u=r[1];for(var p=e;p<i;p+=e)c=r[p],f=r[p+1],c<a&&(a=c),f<l&&(l=f),c>h&&(h=c),f>u&&(u=f);d=Math.max(h-a,u-l),d=d!==0?32767/d:0}return bu(o,s,e,a,l,d,0),s}function iM(r,t,e,n,i){var o,s;if(i===Ay(r,t,e,n)>0)for(o=t;o<e;o+=n)s=aM(o,r[o],r[o+1],s);else for(o=e-n;o>=t;o-=n)s=aM(o,r[o],r[o+1],s);return s&&dd(s,s.next)&&(Au(s),s=s.next),s}function ra(r,t){if(!r)return r;t||(t=r);var e=r,n;do if(n=!1,!e.steiner&&(dd(e,e.next)||Hn(e.prev,e,e.next)===0)){if(Au(e),e=t=e.prev,e===e.next)break;n=!0}else e=e.next;while(n||e!==t);return t}function bu(r,t,e,n,i,o,s){if(r){!s&&o&&AH(r,n,i,o);for(var a=r,l,h;r.prev!==r.next;){if(l=r.prev,h=r.next,o?gH(r,n,i,o):pH(r)){t.push(l.i/e|0),t.push(r.i/e|0),t.push(h.i/e|0),Au(r),r=h.next,a=h.next;continue}if(r=h,r===a){s?s===1?(r=mH(ra(r),t,e),bu(r,t,e,n,i,o,2)):s===2&&yH(r,t,e,n,i,o):bu(ra(r),t,e,n,i,o,1);break}}}}function pH(r){var t=r.prev,e=r,n=r.next;if(Hn(t,e,n)>=0)return!1;for(var i=t.x,o=e.x,s=n.x,a=t.y,l=e.y,h=n.y,u=i<o?i<s?i:s:o<s?o:s,c=a<l?a<h?a:h:l<h?l:h,f=i>o?i>s?i:s:o>s?o:s,d=a>l?a>h?a:h:l>h?l:h,p=n.next;p!==t;){if(p.x>=u&&p.x<=f&&p.y>=c&&p.y<=d&&_l(i,a,o,l,s,h,p.x,p.y)&&Hn(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function gH(r,t,e,n){var i=r.prev,o=r,s=r.next;if(Hn(i,o,s)>=0)return!1;for(var a=i.x,l=o.x,h=s.x,u=i.y,c=o.y,f=s.y,d=a<l?a<h?a:h:l<h?l:h,p=u<c?u<f?u:f:c<f?c:f,g=a>l?a>h?a:h:l>h?l:h,m=u>c?u>f?u:f:c>f?c:f,y=by(d,p,t,e,n),x=by(g,m,t,e,n),v=r.prevZ,_=r.nextZ;v&&v.z>=y&&_&&_.z<=x;){if(v.x>=d&&v.x<=g&&v.y>=p&&v.y<=m&&v!==i&&v!==s&&_l(a,u,l,c,h,f,v.x,v.y)&&Hn(v.prev,v,v.next)>=0||(v=v.prevZ,_.x>=d&&_.x<=g&&_.y>=p&&_.y<=m&&_!==i&&_!==s&&_l(a,u,l,c,h,f,_.x,_.y)&&Hn(_.prev,_,_.next)>=0))return!1;_=_.nextZ}for(;v&&v.z>=y;){if(v.x>=d&&v.x<=g&&v.y>=p&&v.y<=m&&v!==i&&v!==s&&_l(a,u,l,c,h,f,v.x,v.y)&&Hn(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;_&&_.z<=x;){if(_.x>=d&&_.x<=g&&_.y>=p&&_.y<=m&&_!==i&&_!==s&&_l(a,u,l,c,h,f,_.x,_.y)&&Hn(_.prev,_,_.next)>=0)return!1;_=_.nextZ}return!0}function mH(r,t,e){var n=r;do{var i=n.prev,o=n.next.next;!dd(i,o)&&oM(i,n,n.next,o)&&wu(i,o)&&wu(o,i)&&(t.push(i.i/e|0),t.push(n.i/e|0),t.push(o.i/e|0),Au(n),Au(n.next),n=r=o),n=n.next}while(n!==r);return ra(n)}function yH(r,t,e,n,i,o){var s=r;do{for(var a=s.next.next;a!==s.prev;){if(s.i!==a.i&&SH(s,a)){var l=sM(s,a);s=ra(s,s.next),l=ra(l,l.next),bu(s,t,e,n,i,o,0),bu(l,t,e,n,i,o,0);return}a=a.next}s=s.next}while(s!==r)}function vH(r,t,e,n){var i=[],o,s,a,l,h;for(o=0,s=t.length;o<s;o++)a=t[o]*n,l=o<s-1?t[o+1]*n:r.length,h=iM(r,a,l,n,!1),h===h.next&&(h.steiner=!0),i.push(MH(h));for(i.sort(xH),o=0;o<i.length;o++)e=_H(i[o],e);return e}function xH(r,t){return r.x-t.x}function _H(r,t){var e=bH(r,t);if(!e)return t;var n=sM(e,r);return ra(n,n.next),ra(e,e.next)}function bH(r,t){var e=t,n=r.x,i=r.y,o=-1/0,s;do{if(i<=e.y&&i>=e.next.y&&e.next.y!==e.y){var a=e.x+(i-e.y)*(e.next.x-e.x)/(e.next.y-e.y);if(a<=n&&a>o&&(o=a,s=e.x<e.next.x?e:e.next,a===n))return s}e=e.next}while(e!==t);if(!s)return null;var l=s,h=s.x,u=s.y,c=1/0,f;e=s;do n>=e.x&&e.x>=h&&n!==e.x&&_l(i<u?n:o,i,h,u,i<u?o:n,i,e.x,e.y)&&(f=Math.abs(i-e.y)/(n-e.x),wu(e,r)&&(f<c||f===c&&(e.x>s.x||e.x===s.x&&wH(s,e)))&&(s=e,c=f)),e=e.next;while(e!==l);return s}function wH(r,t){return Hn(r.prev,r,t.prev)<0&&Hn(t.next,r,r.next)<0}function AH(r,t,e,n){var i=r;do i.z===0&&(i.z=by(i.x,i.y,t,e,n)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next;while(i!==r);i.prevZ.nextZ=null,i.prevZ=null,TH(i)}function TH(r){var t,e,n,i,o,s,a,l,h=1;do{for(e=r,r=null,o=null,s=0;e;){for(s++,n=e,a=0,t=0;t<h&&(a++,n=n.nextZ,!!n);t++);for(l=h;a>0||l>0&&n;)a!==0&&(l===0||!n||e.z<=n.z)?(i=e,e=e.nextZ,a--):(i=n,n=n.nextZ,l--),o?o.nextZ=i:r=i,i.prevZ=o,o=i;e=n}o.nextZ=null,h*=2}while(s>1);return r}function by(r,t,e,n,i){return r=(r-e)*i|0,t=(t-n)*i|0,r=(r|r<<8)&16711935,r=(r|r<<4)&252645135,r=(r|r<<2)&858993459,r=(r|r<<1)&1431655765,t=(t|t<<8)&16711935,t=(t|t<<4)&252645135,t=(t|t<<2)&858993459,t=(t|t<<1)&1431655765,r|t<<1}function MH(r){var t=r,e=r;do(t.x<e.x||t.x===e.x&&t.y<e.y)&&(e=t),t=t.next;while(t!==r);return e}function _l(r,t,e,n,i,o,s,a){return(i-s)*(t-a)>=(r-s)*(o-a)&&(r-s)*(n-a)>=(e-s)*(t-a)&&(e-s)*(o-a)>=(i-s)*(n-a)}function SH(r,t){return r.next.i!==t.i&&r.prev.i!==t.i&&!CH(r,t)&&(wu(r,t)&&wu(t,r)&&PH(r,t)&&(Hn(r.prev,r,t.prev)||Hn(r,t.prev,t))||dd(r,t)&&Hn(r.prev,r,r.next)>0&&Hn(t.prev,t,t.next)>0)}function Hn(r,t,e){return(t.y-r.y)*(e.x-t.x)-(t.x-r.x)*(e.y-t.y)}function dd(r,t){return r.x===t.x&&r.y===t.y}function oM(r,t,e,n){var i=gd(Hn(r,t,e)),o=gd(Hn(r,t,n)),s=gd(Hn(e,n,r)),a=gd(Hn(e,n,t));return!!(i!==o&&s!==a||i===0&&pd(r,e,t)||o===0&&pd(r,n,t)||s===0&&pd(e,r,n)||a===0&&pd(e,t,n))}function pd(r,t,e){return t.x<=Math.max(r.x,e.x)&&t.x>=Math.min(r.x,e.x)&&t.y<=Math.max(r.y,e.y)&&t.y>=Math.min(r.y,e.y)}function gd(r){return r>0?1:r<0?-1:0}function CH(r,t){var e=r;do{if(e.i!==r.i&&e.next.i!==r.i&&e.i!==t.i&&e.next.i!==t.i&&oM(e,e.next,r,t))return!0;e=e.next}while(e!==r);return!1}function wu(r,t){return Hn(r.prev,r,r.next)<0?Hn(r,t,r.next)>=0&&Hn(r,r.prev,t)>=0:Hn(r,t,r.prev)<0||Hn(r,r.next,t)<0}function PH(r,t){var e=r,n=!1,i=(r.x+t.x)/2,o=(r.y+t.y)/2;do e.y>o!=e.next.y>o&&e.next.y!==e.y&&i<(e.next.x-e.x)*(o-e.y)/(e.next.y-e.y)+e.x&&(n=!n),e=e.next;while(e!==r);return n}function sM(r,t){var e=new wy(r.i,r.x,r.y),n=new wy(t.i,t.x,t.y),i=r.next,o=t.prev;return r.next=t,t.prev=r,e.next=i,i.prev=e,n.next=e,e.prev=n,o.next=n,n.prev=o,n}function aM(r,t,e,n){var i=new wy(r,t,e);return n?(i.next=n.next,i.prev=n,n.next.prev=i,n.next=i):(i.prev=i,i.next=i),i}function Au(r){r.next.prev=r.prev,r.prev.next=r.next,r.prevZ&&(r.prevZ.nextZ=r.nextZ),r.nextZ&&(r.nextZ.prevZ=r.prevZ)}function wy(r,t,e){this.i=r,this.x=t,this.y=e,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}fd.deviation=function(r,t,e,n){var i=t&&t.length,o=i?t[0]*e:r.length,s=Math.abs(Ay(r,0,o,e));if(i)for(var a=0,l=t.length;a<l;a++){var h=t[a]*e,u=a<l-1?t[a+1]*e:r.length;s-=Math.abs(Ay(r,h,u,e))}var c=0;for(a=0;a<n.length;a+=3){var f=n[a]*e,d=n[a+1]*e,p=n[a+2]*e;c+=Math.abs((r[f]-r[p])*(r[d+1]-r[f+1])-(r[f]-r[d])*(r[p+1]-r[f+1]))}return s===0&&c===0?0:Math.abs((c-s)/s)};function Ay(r,t,e,n){for(var i=0,o=t,s=e-n;o<e;o+=n)i+=(r[s]-r[o])*(r[o+1]+r[s+1]),s=o;return i}fd.flatten=function(r){for(var t=r[0][0].length,e={vertices:[],holes:[],dimensions:t},n=0,i=0;i<r.length;i++){for(var o=0;o<r[i].length;o++)for(var s=0;s<t;s++)e.vertices.push(r[i][o][s]);i>0&&(n+=r[i-1].length,e.holes.push(n))}return e};var EH=_y.exports;const md=Us(EH);/*!
 * @maptalks/vector-packer v0.96.4
 * LICENSE : UNLICENSED
 * (c) 2016-2024 maptalks.com
 */const OH={Point:1,LineString:2,Polygon:3,MultiPoint:4,MultiLineString:5,MultiPolygon:6};function kH(r,t={}){var e=[];if(r.type==="FeatureCollection")for(var n=0;n<r.features.length;n++)Ty(e,r.features[n],t,n);else Ty(e,r.type==="Feature"?r:{geometry:r},t);return e}function Ty(r,t,e,n){if(t.geometry&&t.geometry.geometry){var i=t.geometry.coordinates,o=t.geometry.type,s=[],a=t.id;if(e.promoteId?a=t.properties[e.promoteId]:e.generateId&&(a=n||0),o==="Point")My(i,s);else if(o==="MultiPoint")for(var l=0;l<i.length;l++)My(i[l],s);else if(o==="LineString")ms([i],s);else if(o==="MultiLineString"){if(e.lineMetrics){for(l=0;l<i.length;l++)lM(i[l],s=[]),r.push(hM(a,"LineString",s,t.properties));return}ms(i,s)}else if(o==="Polygon")ms(i,s);else{if(o!=="MultiPolygon"){if(o==="GeometryCollection"){for(l=0;l<t.geometry.geometries.length;l++)Ty(r,{id:a,geometry:t.geometry.geometries[l],properties:t.properties},e,n);return}return void console.warn(`Input data type(${o}) is not a valid GeoJSON geometry type.`)}for(l=0;l<i.length;l++){var h=[];ms(i[l],h),s.push(h)}}r.push(hM(a,o,s,t.properties))}}function My(r,t){const e=new sn(r[0],r[1]);e.z=100*(r[2]||0),t.push([e])}function lM(r,t){for(let e=0;e<r.length;e++){const n=new sn(r[e][0],r[e][1]);n.z=100*(r[e][2]||0),t.push(n)}}function ms(r,t,e,n){for(var i=0;i<r.length;i++){var o=[];lM(r[i],o),t.push(o)}}function hM(r,t,e,n){return{id:r===void 0?null:r,type:OH[t],geometry:e,properties:n}}/*!
 * Codes from mapbox-gl-js
 * github.com/mapbox/mapbox-gl-js
 * MIT License
 */function Sy(r,{width:t,height:e},n,i){if(i){if(i.length!==t*e*n)throw new RangeError("mismatched image size")}else i=new Uint8Array(t*e*n);return r.width=t,r.height=e,r.data=i,r}function uM(r,{width:t,height:e},n){if(t===r.width&&e===r.height)return;const i=Sy({},{width:t,height:e},n);Cy(r,i,{x:0,y:0},{x:0,y:0},{width:Math.min(r.width,t),height:Math.min(r.height,e)},n),r.width=t,r.height=e,r.data=i.data}function Cy(r,t,e,n,i,o){if(i.width===0||i.height===0)return t;if(i.width>r.width||i.height>r.height||e.x>r.width-i.width||e.y>r.height-i.height)throw new RangeError("out of range source coordinates for image copy");if(i.width>t.width||i.height>t.height||n.x>t.width-i.width||n.y>t.height-i.height)throw new RangeError("out of range destination coordinates for image copy");const s=r.data,a=t.data;if(s===a)return t;for(let l=0;l<i.height;l++){const h=((e.y+l)*r.width+e.x)*o,u=((n.y+l)*t.width+n.x)*o;for(let c=0;c<i.width*o;c++)a[u+c]=s[h+c]}return t}class Tu{constructor(t,e){Sy(this,t,1,e)}resize(t){uM(this,t,1)}clone(){return new Tu({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,e,n,i,o){Cy(t,e,n,i,o,1)}}class Mu{constructor(t,e){Sy(this,t,4,e)}resize(t){uM(this,t,4)}clone(){return new Mu({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,e,n,i,o){Cy(t,e,n,i,o,4)}}function cM(r){let t=0;for(let e,n,i=0,o=r.length,s=o-1;i<o;s=i++)if(e=r[i],n=r[s],e.x!==void 0){if(e.z||n.z)return 1;t+=(n.x-e.x)*(e.y+n.y)}else{if(e[2]||n[2])return 1;t+=(n[0]-e[0])*(e[1]+n[1])}return t}function yd(r,t,e){let n=e;return t&&r&&(n=+r[t]),isNaN(n)&&(n=e||0),100*n}function fM(r,t,e,n,i,o,s){t||t===0||(t=1);const a=yd(r.properties,e,n),l=a*t;let h=(o?100*o:0)||a;return i?h=yd(r.properties,i,o):s&&(h=a-yd(r.properties,s,o)),h*=t,{altitude:l,height:h}}function Zi(r,t){return t<1/0&&(r.x<0||r.x>t||r.y<0||r.y>t)}function bl(r){return r==null}function dM(r,t,e){if(r===e||r===t)return r;const n=e-t;return((r-t)%n+n)%n+t}function pM(r,t){if(!t)return null;const e=new Map;for(let n=0;n<t.length;n++){const i=t[n],o=r[i];let s=e.get(o);s||(s=[],e.set(o,s)),s.push(i)}return e}function vd(r){return!(r&r-1)&&r!==0}/*!
 * Codes from mapbox-gl-js
 * github.com/mapbox/mapbox-gl-js
 * MIT License
 */class IH{constructor(t,e,{pixelRatio:n}){this.paddedRect=t,this.pixelRatio=n||1,this.padding=e}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.pixelRatio,(this.paddedRect.h-2*this.padding)/this.pixelRatio]}}let gM=class{constructor(t){this.glyphMap=t,this.build()}build(){const t=this.glyphMap,e=Object.keys(t).length,n={},i=new Oi(0,0,{autoResize:!0}),o=[],s=e>1?1:0;for(const l in t){const h=t[l],u={x:0,y:0,w:h.data.width+2*s,h:h.data.height+2*s};o.push(u),n[l]=new IH(u,s,h)}if(i.pack(o,{inPlace:!0}),!vd(i.w)||!vd(i.h)){const l=mM(i.w),h=mM(i.h);i.resize(l,h)}const a=new Mu({width:i.w,height:i.h});for(const l in t){const h=t[l],u=n[l].paddedRect;Mu.copy(h.data,a,{x:0,y:0},{x:u.x+s,y:u.y+s},h.data)}this.image=a,this.positions=n}};function mM(r){return Math.pow(2,Math.ceil(Math.log(r)/Math.LN2))}/*!
 * Codes from mapbox-gl-js
 * github.com/mapbox/mapbox-gl-js
 * MIT License
 * TODO 升级为potpack
 */class RH{constructor(t){this.glyphMap=t,this.build()}build(){const t=this.glyphMap,e={},n=new Oi(0,0,{autoResize:!0}),i=[];for(const s in t){const a=t[s],l=e[s]={};for(const h in a){const u=a[+h];if(!u||u.bitmap.width===0||u.bitmap.height===0)continue;const c={x:0,y:0,w:u.bitmap.width+2,h:u.bitmap.height+2};i.push(c),l[h]={rect:c,metrics:u.metrics}}}n.pack(i,{inPlace:!0});const o=new Tu({width:n.w,height:n.h});for(const s in t){const a=t[s];for(const l in a){const h=a[+l];if(!h||h.bitmap.width===0||h.bitmap.height===0)continue;const u=e[s][l].rect;Tu.copy(h.bitmap,o,{x:0,y:0},{x:u.x+1,y:u.y+1},h.bitmap)}}this.image=o,this.positions=e}}function yM(r){return r<65536?Uint16Array:Uint32Array}function Py(r){return(r=Math.abs(r))<128?Int8Array:r<32768?Int16Array:Float32Array}function Ey(r){return r<256?Uint8Array:r<65536?Uint16Array:Float32Array}function vM(r,t){const e=r.getLength?r.getLength():r.length;if(r instanceof t)return r.slice(0,e);const n=new t(e);r=r._origin||r;for(let i=0;i<e;i++)n[i]=r[i]||0;return n}function xM(r){const t=r.type,e=[];if(t===1||t===4)for(let n=0;n<r.geometry.length;n++)My(r.geometry[n],e);else if(t===2)ms(r.geometry,e);else if(t===3)ms(r.geometry,e);else if(t===5)ms(r.geometry,e);else if(t===6)for(let n=0;n<r.geometry.length;n++){const i=[];ms(r.geometry[n],i),e.push(i)}return r.geometry=e,r}function wl(r){for(let t=1;t<arguments.length;t++){const e=arguments[t];for(const n in e)r[n]=e[n]}return r}function tn(r){return r==null}function ys(r){return typeof r=="number"&&!isNaN(r)}function Al(r){return typeof r=="object"&&!!r}function Oy(r){return!tn(r)&&(typeof r=="string"||r.constructor!==null&&r.constructor===String)}function ky(r){return!tn(r)&&(typeof r=="function"||r.constructor!==null&&r.constructor===Function)}const DH=Object.prototype.hasOwnProperty;function Tl(r,t){return DH.call(r,t)}const _M=Math.PI/180;function Su(r){return r&&Ft(r)&&r.property}function bM(r){const{verticalCentimeterToPoint:t,tileRatio:e}=r;return t*e}function FH(r){return r==="centimeter"||r==="cm"?1:r==="millimeter"||r==="mm"?.1:100}const wM={};function ia(r,t){if(!Array.isArray(t)){if(t&&t.r!==void 0&&t.g!==void 0&&t.b!==void 0)return r[0]=255*t.r,r[1]=255*t.g,r[2]=255*t.b,r[3]=t.a!==void 0?255*t.a:255,r;t=wM[t]=wM[t]||Wi(t).unitArray()}for(let e=0;e<t.length;e++)r[e]=255*t[e];return t.length===3&&(r[3]=255),r}const AM={textFill:1,textSize:1,textOpacity:1,textDx:1,textDy:1,markerWidth:1,markerHeight:1,markerOpacity:1,markerDx:1,markerDy:1,lineWidth:1,lineColor:1,lineOpacity:1,polygonFill:1,polygonOpacity:1,polygonPatternFileWidth:1,polygonPatternFileOrigin:1,rotationX:1,rotationY:1,rotationZ:1,scaleX:1,scaleY:1,scaleZ:1,translationX:1,translationY:1,translationZ:1},LH={textName:1,markerTextFitPadding:1,markerTextFit:1,lineGradientProperty:1};var Ml=Object.freeze({__proto__:null,checkIfIdentityZoomDependent:function(r,t,e){if(Array.isArray(e)||(e=Object.values(e)),!e||!e.length||!AM[r])return!1;for(let n=0;n<e.length;n++){const i=e[n]&&(e[n].feature||e[n]);if(!i)continue;const o=i.properties&&i.properties[t];if(o&&Ft(o)&&!le(o).isZoomConstant)return!0}return!1},checkIfZoomFnTypeSymbol:function(r){return!!AM[r]||!!LH[r]},evaluate:function(r,t,e){return ky(r)?r(e!==void 0?e:null,t):r},extend:wl,getAltitudeToLocal:bM,getTubeSizeScale:FH,hasOwn:Tl,isFnTypeSymbol:Su,isFunction:ky,isInteger:function(r){return(0|r)===r},isNil:tn,isNumber:ys,isObject:Al,isString:Oy,join:function(r,t){return r.join?r.join(t||","):Array.prototype.join.call(r,t||",")},normalizeColor:ia,now:function(){return Date.now()},toDegree:function(r){return r/_M},toRadian:function(r){return r*_M}});let xd=class{constructor(t,e,n,i){this.feature=t,this.symbol=e,this.fnTypes=n,this.options=i}getPolygonResource(){let t=this.symbol.polygonPatternFile;const{polygonPatternFileFn:e}=this.fnTypes;return this._getResource(t,e)}getLineResource(){let t=this.symbol.linePatternFile;const{linePatternFileFn:e}=this.fnTypes;return this._getResource(t,e)}_getResource(t,e){return e&&(t=e(this.options.zoom,this.feature.properties)),t}};function TM(r,t,e,n){const i=Math.abs(n)>>15,o=i>>1,s=i%2;let a=n%Math.pow(2,15);const l=t+(o<<14)*Math.sign(t),h=e+(s<<14)*Math.sign(e);return r[0]=l,r[1]=h,a=Math.round(a),r[2]=a===0?n<0?-1:0:a,r}const _d=Math.pow(2,14),zH=Math.pow(2,15);/*!
 * a compact version of mapbox-gl-style-spec
 * based on mapbox-gl-style-spec@13.28.0
 * https://github.com/mapbox/mapbox-gl-js/tree/main/src/style-spec
 * LICENSE : ISC
 */var Cu,bd,Iy=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},MM={exports:{}};function SM(r,...t){for(const e of t)for(const n in e)r[n]=e[n];return r}/*! https://mths.be/punycode v1.3.2 by @mathias */Cu=MM,bd=MM.exports,function(r){var t=bd&&!bd.nodeType&&bd,e=Cu&&!Cu.nodeType&&Cu,n=typeof Iy=="object"&&Iy;n.global!==n&&n.window!==n&&n.self!==n||(r=n);var i,o,s=2147483647,a=36,l=1,h=26,u=38,c=700,f=72,d=128,p="-",g=/^xn--/,m=/[^\x20-\x7E]/,y=/[\x2E\u3002\uFF0E\uFF61]/g,x={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},v=a-l,_=Math.floor,w=String.fromCharCode;function b(I){throw RangeError(x[I])}function A(I,D){for(var z=I.length,L=[];z--;)L[z]=D(I[z]);return L}function T(I,D){var z=I.split("@"),L="";return z.length>1&&(L=z[0]+"@",I=z[1]),L+A((I=I.replace(y,".")).split("."),D).join(".")}function S(I){for(var D,z,L=[],$=0,Z=I.length;$<Z;)(D=I.charCodeAt($++))>=55296&&D<=56319&&$<Z?(64512&(z=I.charCodeAt($++)))==56320?L.push(((1023&D)<<10)+(1023&z)+65536):(L.push(D),$--):L.push(D);return L}function M(I){return A(I,function(D){var z="";return D>65535&&(z+=w((D-=65536)>>>10&1023|55296),D=56320|1023&D),z+=w(D)}).join("")}function E(I,D){return I+22+75*(I<26)-((D!=0)<<5)}function P(I,D,z){var L=0;for(I=z?_(I/c):I>>1,I+=_(I/D);I>v*h>>1;L+=a)I=_(I/v);return _(L+(v+1)*I/(I+u))}function k(I){var D,z,L,$,Z,j,st,lt,rt,Rt,Ht,ee=[],nt=I.length,Dt=0,Vt=d,Ct=f;for((z=I.lastIndexOf(p))<0&&(z=0),L=0;L<z;++L)I.charCodeAt(L)>=128&&b("not-basic"),ee.push(I.charCodeAt(L));for($=z>0?z+1:0;$<nt;){for(Z=Dt,j=1,st=a;$>=nt&&b("invalid-input"),((lt=(Ht=I.charCodeAt($++))-48<10?Ht-22:Ht-65<26?Ht-65:Ht-97<26?Ht-97:a)>=a||lt>_((s-Dt)/j))&&b("overflow"),Dt+=lt*j,!(lt<(rt=st<=Ct?l:st>=Ct+h?h:st-Ct));st+=a)j>_(s/(Rt=a-rt))&&b("overflow"),j*=Rt;Ct=P(Dt-Z,D=ee.length+1,Z==0),_(Dt/D)>s-Vt&&b("overflow"),Vt+=_(Dt/D),Dt%=D,ee.splice(Dt++,0,Vt)}return M(ee)}function O(I){var D,z,L,$,Z,j,st,lt,rt,Rt,Ht,ee,nt,Dt,Vt,Ct=[];for(ee=(I=S(I)).length,D=d,z=0,Z=f,j=0;j<ee;++j)(Ht=I[j])<128&&Ct.push(w(Ht));for(L=$=Ct.length,$&&Ct.push(p);L<ee;){for(st=s,j=0;j<ee;++j)(Ht=I[j])>=D&&Ht<st&&(st=Ht);for(st-D>_((s-z)/(nt=L+1))&&b("overflow"),z+=(st-D)*nt,D=st,j=0;j<ee;++j)if((Ht=I[j])<D&&++z>s&&b("overflow"),Ht==D){for(lt=z,rt=a;!(lt<(Rt=rt<=Z?l:rt>=Z+h?h:rt-Z));rt+=a)Ct.push(w(E(Rt+(Vt=lt-Rt)%(Dt=a-Rt),0))),lt=_(Vt/Dt);Ct.push(w(E(lt,0))),Z=P(z,nt,L==$),z=0,++L}++z,++D}return Ct.join("")}if(i={version:"1.3.2",ucs2:{decode:S,encode:M},decode:k,encode:O,toASCII:function(I){return T(I,function(D){return m.test(D)?"xn--"+O(D):D})},toUnicode:function(I){return T(I,function(D){return g.test(D)?k(D.slice(4).toLowerCase()):D})}},t&&e)if(Cu.exports==t)e.exports=i;else for(o in i)i.hasOwnProperty(o)&&(t[o]=i[o]);else r.punycode=i}(Iy);var uo=class extends Error{constructor(t,e){super(e),this.message=e,this.key=t}},HH=class A3{constructor(t,e=[]){this.parent=t,this.bindings={};for(const[n,i]of e)this.bindings[n]=i}concat(t){return new A3(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(`${t} not found in scope.`)}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}};const wd={kind:"null"},Xt={kind:"number"},We={kind:"string"},Ve={kind:"boolean"},Lo={kind:"color"},Sl={kind:"object"},Ge={kind:"value"},Ad={kind:"collator"},Td={kind:"formatted"},Pu={kind:"resolvedImage"};function ki(r,t){return{kind:"array",itemType:r,N:t}}function Rn(r){if(r.kind==="array"){const t=Rn(r.itemType);return typeof r.N=="number"?`array<${t}, ${r.N}>`:r.itemType.kind==="value"?"array":`array<${t}>`}return r.kind}const NH=[wd,Xt,We,Ve,Lo,Td,Sl,ki(Ge),Pu];function Eu(r,t){if(t.kind==="error")return null;if(r.kind==="array"){if(t.kind==="array"&&(t.N===0&&t.itemType.kind==="value"||!Eu(r.itemType,t.itemType))&&(typeof r.N!="number"||r.N===t.N))return null}else{if(r.kind===t.kind)return null;if(r.kind==="value"){for(const e of NH)if(!Eu(e,t))return null}}return`Expected ${Rn(r)} but found ${Rn(t)} instead.`}function Ry(r,t){return t.some(e=>e.kind===r.kind)}function Ou(r,t){return t.some(e=>e==="null"?r===null:e==="array"?Array.isArray(r):e==="object"?r&&!Array.isArray(r)&&typeof r=="object":e===typeof r)}var CM,PM={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function Md(r){return(r=Math.round(r))<0?0:r>255?255:r}function BH(r){return r<0?0:r>1?1:r}function Dy(r){return Md(r[r.length-1]==="%"?parseFloat(r)/100*255:parseInt(r))}function Sd(r){return BH(r[r.length-1]==="%"?parseFloat(r)/100:parseFloat(r))}function Fy(r,t,e){return e<0?e+=1:e>1&&(e-=1),6*e<1?r+(t-r)*e*6:2*e<1?t:3*e<2?r+(t-r)*(2/3-e)*6:r}try{CM={}.parseCSSColor=function(r){var t,e=r.replace(/ /g,"").toLowerCase();if(e in PM)return PM[e].slice();if(e[0]==="#")return e.length===4?(t=parseInt(e.substr(1),16))>=0&&t<=4095?[(3840&t)>>4|(3840&t)>>8,240&t|(240&t)>>4,15&t|(15&t)<<4,1]:null:e.length===7&&(t=parseInt(e.substr(1),16))>=0&&t<=16777215?[(16711680&t)>>16,(65280&t)>>8,255&t,1]:null;var n=e.indexOf("("),i=e.indexOf(")");if(n!==-1&&i+1===e.length){var o=e.substr(0,n),s=e.substr(n+1,i-(n+1)).split(","),a=1;switch(o){case"rgba":if(s.length!==4)return null;a=Sd(s.pop());case"rgb":return s.length!==3?null:[Dy(s[0]),Dy(s[1]),Dy(s[2]),a];case"hsla":if(s.length!==4)return null;a=Sd(s.pop());case"hsl":if(s.length!==3)return null;var l=(parseFloat(s[0])%360+360)%360/360,h=Sd(s[1]),u=Sd(s[2]),c=u<=.5?u*(h+1):u+h-u*h,f=2*u-c;return[Md(255*Fy(f,c,l+1/3)),Md(255*Fy(f,c,l)),Md(255*Fy(f,c,l-1/3)),a];default:return null}}return null}}catch{}let Xi=class x1{constructor(t,e,n,i=1){this.r=t,this.g=e,this.b=n,this.a=i}static parse(t){if(!t)return;if(t instanceof x1)return t;if(typeof t!="string")return;const e=CM(t);return e?new x1(e[0]/255*e[3],e[1]/255*e[3],e[2]/255*e[3],e[3]):void 0}toString(){const[t,e,n,i]=this.toArray();return`rgba(${Math.round(t)},${Math.round(e)},${Math.round(n)},${i})`}toArray(){const{r:t,g:e,b:n,a:i}=this;return i===0?[0,0,0,0]:[255*t/i,255*e/i,255*n/i,i]}toArray01(){const{r:t,g:e,b:n,a:i}=this;return i===0?[0,0,0,0]:[t/i,e/i,n/i,i]}toArray01PremultipliedAlpha(){const{r:t,g:e,b:n,a:i}=this;return[t,e,n,i]}};Xi.black=new Xi(0,0,0,1),Xi.white=new Xi(1,1,1,1),Xi.transparent=new Xi(0,0,0,0),Xi.red=new Xi(1,0,0,1),Xi.blue=new Xi(0,0,1,1);var Fr=Xi;let Ly=class{constructor(t,e,n){this.sensitivity=t?e?"variant":"case":e?"accent":"base",this.locale=n,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,e){return this.collator.compare(t,e)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}},zy=class{constructor(t,e,n,i,o){this.text=t.normalize?t.normalize():t,this.image=e,this.scale=n,this.fontStack=i,this.textColor=o}},oa=class kp{constructor(t){this.sections=t}static fromString(t){return new kp([new zy(t,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some(t=>t.text.length!==0||t.image&&t.image.name.length!==0)}static factory(t){return t instanceof kp?t:kp.fromString(t)}toString(){return this.sections.length===0?"":this.sections.map(t=>t.text).join("")}serialize(){const t=["format"];for(const e of this.sections){if(e.image){t.push(["image",e.image.name]);continue}t.push(e.text);const n={};e.fontStack&&(n["text-font"]=["literal",e.fontStack.split(",")]),e.scale&&(n["font-scale"]=e.scale),e.textColor&&(n["text-color"]=["rgba"].concat(e.textColor.toArray())),t.push(n)}return t}},sa=class T3{constructor(t){this.name=t.name,this.available=t.available}toString(){return this.name}static fromString(t){return t?new T3({name:t,available:!1}):null}serialize(){return["image",this.name]}};function EM(r,t,e,n){return typeof r=="number"&&r>=0&&r<=255&&typeof t=="number"&&t>=0&&t<=255&&typeof e=="number"&&e>=0&&e<=255?n===void 0||typeof n=="number"&&n>=0&&n<=1?null:`Invalid rgba value [${[r,t,e,n].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof n=="number"?[r,t,e,n]:[r,t,e]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Cd(r){if(r===null||typeof r=="string"||typeof r=="boolean"||typeof r=="number"||r instanceof Fr||r instanceof Ly||r instanceof oa||r instanceof sa)return!0;if(Array.isArray(r)){for(const t of r)if(!Cd(t))return!1;return!0}if(typeof r=="object"){for(const t in r)if(!Cd(r[t]))return!1;return!0}return!1}function dr(r){if(r===null)return wd;if(typeof r=="string")return We;if(typeof r=="boolean")return Ve;if(typeof r=="number")return Xt;if(r instanceof Fr)return Lo;if(r instanceof Ly)return Ad;if(r instanceof oa)return Td;if(r instanceof sa)return Pu;if(Array.isArray(r)){const t=r.length;let e;for(const n of r){const i=dr(n);if(e){if(e===i)continue;e=Ge;break}e=i}return ki(e||Ge,t)}return Sl}function ku(r){const t=typeof r;return r===null?"":t==="string"||t==="number"||t==="boolean"?String(r):r instanceof Fr||r instanceof oa||r instanceof sa?r.toString():JSON.stringify(r)}var Pd=class M3{constructor(t,e){this.type=t,this.value=e}static parse(t,e){if(t.length!==2)return e.error(`'literal' expression requires exactly one argument, but found ${t.length-1} instead.`);if(!Cd(t[1]))return e.error("invalid value");const n=t[1];let i=dr(n);const o=e.expectedType;return i.kind!=="array"||i.N!==0||!o||o.kind!=="array"||typeof o.N=="number"&&o.N!==0||(i=o),new M3(i,n)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof Fr?["rgba"].concat(this.value.toArray()):this.value instanceof oa?this.value.serialize():this.value}},Cr=class{constructor(t){this.name="ExpressionEvaluationError",this.message=t}toJSON(){return this.message}};const Hy={string:We,number:Xt,boolean:Ve,object:Sl};var zo=class S3{constructor(t,e){this.type=t,this.args=e}static parse(t,e){if(t.length<2)return e.error("Expected at least one argument.");let n,i=1;const o=t[0];if(o==="array"){let a,l;if(t.length>2){const h=t[1];if(typeof h!="string"||!(h in Hy)||h==="object")return e.error('The item type argument of "array" must be one of string, number, boolean',1);a=Hy[h],i++}else a=Ge;if(t.length>3){if(t[2]!==null&&(typeof t[2]!="number"||t[2]<0||t[2]!==Math.floor(t[2])))return e.error('The length argument to "array" must be a positive integer literal',2);l=t[2],i++}n=ki(a,l)}else n=Hy[o];const s=[];for(;i<t.length;i++){const a=e.parse(t[i],i,Ge);if(!a)return null;s.push(a)}return new S3(n,s)}evaluate(t){for(let e=0;e<this.args.length;e++){const n=this.args[e].evaluate(t);if(!Eu(this.type,dr(n)))return n;if(e===this.args.length-1)throw new Cr(`Expected value to be of type ${Rn(this.type)}, but found ${Rn(dr(n))} instead.`)}return null}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=this.type,e=[t.kind];if(t.kind==="array"){const n=t.itemType;if(n.kind==="string"||n.kind==="number"||n.kind==="boolean"){e.push(n.kind);const i=t.N;(typeof i=="number"||this.args.length>1)&&e.push(i)}}return e.concat(this.args.map(n=>n.serialize()))}};let OM=class C3{constructor(t){this.type=Td,this.sections=t}static parse(t,e){if(t.length<2)return e.error("Expected at least one argument.");const n=t[1];if(!Array.isArray(n)&&typeof n=="object")return e.error("First argument must be an image or text section.");const i=[];let o=!1;for(let s=1;s<=t.length-1;++s){const a=t[s];if(o&&typeof a=="object"&&!Array.isArray(a)){o=!1;let l=null;if(a["font-scale"]&&(l=e.parse(a["font-scale"],1,Xt),!l))return null;let h=null;if(a["text-font"]&&(h=e.parse(a["text-font"],1,ki(We)),!h))return null;let u=null;if(a["text-color"]&&(u=e.parse(a["text-color"],1,Lo),!u))return null;const c=i[i.length-1];c.scale=l,c.font=h,c.textColor=u}else{const l=e.parse(t[s],1,Ge);if(!l)return null;const h=l.type.kind;if(h!=="string"&&h!=="value"&&h!=="null"&&h!=="resolvedImage")return e.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");o=!0,i.push({content:l,scale:null,font:null,textColor:null})}}return new C3(i)}evaluate(t){return new oa(this.sections.map(e=>{const n=e.content.evaluate(t);return dr(n)===Pu?new zy("",n,null,null,null):new zy(ku(n),null,e.scale?e.scale.evaluate(t):null,e.font?e.font.evaluate(t).join(","):null,e.textColor?e.textColor.evaluate(t):null)}))}eachChild(t){for(const e of this.sections)t(e.content),e.scale&&t(e.scale),e.font&&t(e.font),e.textColor&&t(e.textColor)}outputDefined(){return!1}serialize(){const t=["format"];for(const e of this.sections){t.push(e.content.serialize());const n={};e.scale&&(n["font-scale"]=e.scale.serialize()),e.font&&(n["text-font"]=e.font.serialize()),e.textColor&&(n["text-color"]=e.textColor.serialize()),t.push(n)}return t}},kM=class P3{constructor(t){this.type=Pu,this.input=t}static parse(t,e){if(t.length!==2)return e.error("Expected two arguments.");const n=e.parse(t[1],1,We);return n?new P3(n):e.error("No image name provided.")}evaluate(t){const e=this.input.evaluate(t),n=sa.fromString(e);return n&&t.availableImages&&(n.available=t.availableImages.indexOf(e)>-1),n}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){return["image",this.input.serialize()]}};const jH={"to-boolean":Ve,"to-color":Lo,"to-number":Xt,"to-string":We};var Cl=class E3{constructor(t,e){this.type=t,this.args=e}static parse(t,e){if(t.length<2)return e.error("Expected at least one argument.");const n=t[0];if((n==="to-boolean"||n==="to-string")&&t.length!==2)return e.error("Expected one argument.");const i=jH[n],o=[];for(let s=1;s<t.length;s++){const a=e.parse(t[s],s,Ge);if(!a)return null;o.push(a)}return new E3(i,o)}evaluate(t){if(this.type.kind==="boolean")return!!this.args[0].evaluate(t);if(this.type.kind==="color"){let e,n;for(const i of this.args){if(e=i.evaluate(t),n=null,e instanceof Fr)return e;if(typeof e=="string"){const o=t.parseColor(e);if(o)return o}else if(Array.isArray(e)&&(n=e.length<3||e.length>4?`Invalid rbga value ${JSON.stringify(e)}: expected an array containing either three or four numeric values.`:EM(e[0],e[1],e[2],e[3]),!n))return new Fr(e[0]/255,e[1]/255,e[2]/255,e[3])}throw new Cr(n||`Could not parse color from value '${typeof e=="string"?e:String(JSON.stringify(e))}'`)}if(this.type.kind==="number"){let e=null;for(const n of this.args){if(e=n.evaluate(t),e===null)return 0;const i=Number(e);if(!isNaN(i))return i}throw new Cr(`Could not convert ${JSON.stringify(e)} to number.`)}return this.type.kind==="formatted"?oa.fromString(ku(this.args[0].evaluate(t))):this.type.kind==="resolvedImage"?sa.fromString(ku(this.args[0].evaluate(t))):ku(this.args[0].evaluate(t))}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){if(this.type.kind==="formatted")return new OM([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new kM(this.args[0]).serialize();const t=[`to-${this.type.kind}`];return this.eachChild(e=>{t.push(e.serialize())}),t}};const VH=["Unknown","Point","LineString","Polygon"];var IM=class{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?VH[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const t=this.featureDistanceData.center,e=this.featureDistanceData.scale,{x:n,y:i}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(n*e-t[0])+this.featureDistanceData.bearing[1]*(i*e-t[1])}return 0}parseColor(t){let e=this._parseColorCache[t];return e||(e=this._parseColorCache[t]=Fr.parse(t)),e}},Pl=class hc{constructor(t,e,n,i){this.name=t,this.type=e,this._evaluate=n,this.args=i}evaluate(t){return this._evaluate(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(t=>t.serialize()))}static parse(t,e){const n=t[0],i=hc.definitions[n];if(!i)return e.error(`Unknown expression "${n}". If you wanted a literal array, use ["literal", [...]].`,0);const o=Array.isArray(i)?i[0]:i.type,s=Array.isArray(i)?[[i[1],i[2]]]:i.overloads,a=s.filter(([h])=>!Array.isArray(h)||h.length===t.length-1);let l=null;for(const[h,u]of a){l=new jM(e.registry,e.path,null,e.scope);const c=[];let f=!1;for(let d=1;d<t.length;d++){const p=t[d],g=Array.isArray(h)?h[d-1]:h.type,m=l.parse(p,1+c.length,g);if(!m){f=!0;break}c.push(m)}if(!f)if(Array.isArray(h)&&h.length!==c.length)l.error(`Expected ${h.length} arguments, but found ${c.length} instead.`);else{for(let d=0;d<c.length;d++){const p=Array.isArray(h)?h[d]:h.type,g=c[d];l.concat(d+1).checkSubtype(p,g.type)}if(l.errors.length===0)return new hc(n,o,u,c)}}if(a.length===1)e.errors.push(...l.errors);else{const h=(a.length?a:s).map(([c])=>{return f=c,Array.isArray(f)?`(${f.map(Rn).join(", ")})`:`(${Rn(f.type)}...)`;var f}).join(" | "),u=[];for(let c=1;c<t.length;c++){const f=e.parse(t[c],1+u.length);if(!f)return null;u.push(Rn(f.type))}e.error(`Expected arguments of type ${h}, but found (${u.join(", ")}) instead.`)}return null}static register(t,e){hc.definitions=e;for(const n in e)t[n]=hc}};let RM=class O3{constructor(t,e,n){this.type=Ad,this.locale=n,this.caseSensitive=t,this.diacriticSensitive=e}static parse(t,e){if(t.length!==2)return e.error("Expected one argument.");const n=t[1];if(typeof n!="object"||Array.isArray(n))return e.error("Collator options argument must be an object.");const i=e.parse(n["case-sensitive"]!==void 0&&n["case-sensitive"],1,Ve);if(!i)return null;const o=e.parse(n["diacritic-sensitive"]!==void 0&&n["diacritic-sensitive"],1,Ve);if(!o)return null;let s=null;return n.locale&&(s=e.parse(n.locale,1,We),!s)?null:new O3(i,o,s)}evaluate(t){return new Ly(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}serialize(){const t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]}};const vs=8192;function Ny(r,t){r[0]=Math.min(r[0],t[0]),r[1]=Math.min(r[1],t[1]),r[2]=Math.max(r[2],t[0]),r[3]=Math.max(r[3],t[1])}function Ed(r,t){return!(r[0]<=t[0])&&!(r[2]>=t[2])&&!(r[1]<=t[1])&&!(r[3]>=t[3])}function GH(r,t){const e=(180+r[0])/360,n=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r[1]*Math.PI/360)))/360,i=Math.pow(2,t.z);return[Math.round(e*i*vs),Math.round(n*i*vs)]}function UH(r,t,e){const n=r[0]-t[0],i=r[1]-t[1],o=r[0]-e[0],s=r[1]-e[1];return n*s-o*i==0&&n*o<=0&&i*s<=0}function By(r,t){let e=!1;for(let s=0,a=t.length;s<a;s++){const l=t[s];for(let h=0,u=l.length;h<u-1;h++){if(UH(r,l[h],l[h+1]))return!1;(i=l[h])[1]>(n=r)[1]!=(o=l[h+1])[1]>n[1]&&n[0]<(o[0]-i[0])*(n[1]-i[1])/(o[1]-i[1])+i[0]&&(e=!e)}}var n,i,o;return e}function $H(r,t){for(let e=0;e<t.length;e++)if(By(r,t[e]))return!0;return!1}function DM(r,t,e,n){const i=n[0]-e[0],o=n[1]-e[1],s=(r[0]-e[0])*o-i*(r[1]-e[1]),a=(t[0]-e[0])*o-i*(t[1]-e[1]);return s>0&&a<0||s<0&&a>0}function WH(r,t,e){for(const h of e)for(let u=0;u<h.length-1;++u)if(a=void 0,l=void 0,(a=[(s=h[u+1])[0]-(o=h[u])[0],s[1]-o[1]])[0]*(l=[(i=t)[0]-(n=r)[0],i[1]-n[1]])[1]-a[1]*l[0]!=0&&DM(n,i,o,s)&&DM(o,s,n,i))return!0;var n,i,o,s,a,l;return!1}function FM(r,t){for(let e=0;e<r.length;++e)if(!By(r[e],t))return!1;for(let e=0;e<r.length-1;++e)if(WH(r[e],r[e+1],t))return!1;return!0}function ZH(r,t){for(let e=0;e<t.length;e++)if(FM(r,t[e]))return!0;return!1}function jy(r,t,e){const n=[];for(let i=0;i<r.length;i++){const o=[];for(let s=0;s<r[i].length;s++){const a=GH(r[i][s],e);Ny(t,a),o.push(a)}n.push(o)}return n}function LM(r,t,e){const n=[];for(let i=0;i<r.length;i++){const o=jy(r[i],t,e);n.push(o)}return n}function zM(r,t,e,n){if(r[0]<e[0]||r[0]>e[2]){const i=.5*n;let o=r[0]-e[0]>i?-n:e[0]-r[0]>i?n:0;o===0&&(o=r[0]-e[2]>i?-n:e[2]-r[0]>i?n:0),r[0]+=o}Ny(t,r)}function HM(r,t,e,n){const i=Math.pow(2,n.z)*vs,o=[n.x*vs,n.y*vs],s=[];if(!r)return s;for(const a of r)for(const l of a){const h=[l.x+o[0],l.y+o[1]];zM(h,t,e,i),s.push(h)}return s}function NM(r,t,e,n){const i=Math.pow(2,n.z)*vs,o=[n.x*vs,n.y*vs],s=[];if(!r)return s;for(const l of r){const h=[];for(const u of l){const c=[u.x+o[0],u.y+o[1]];Ny(t,c),h.push(c)}s.push(h)}if(t[2]-t[0]<=i/2){(a=t)[0]=a[1]=1/0,a[2]=a[3]=-1/0;for(const l of s)for(const h of l)zM(h,t,e,i)}var a;return s}var Vy=class Ip{constructor(t,e){this.type=Ve,this.geojson=t,this.geometries=e}static parse(t,e){if(t.length!==2)return e.error(`'within' expression requires exactly one argument, but found ${t.length-1} instead.`);if(Cd(t[1])){const n=t[1];if(n.type==="FeatureCollection")for(let i=0;i<n.features.length;++i){const o=n.features[i].geometry.type;if(o==="Polygon"||o==="MultiPolygon")return new Ip(n,n.features[i].geometry)}else if(n.type==="Feature"){const i=n.geometry.type;if(i==="Polygon"||i==="MultiPolygon")return new Ip(n,n.geometry)}else if(n.type==="Polygon"||n.type==="MultiPolygon")return new Ip(n,n)}return e.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(t.geometry()!=null&&t.canonicalID()!=null){if(t.geometryType()==="Point")return function(e,n){const i=[1/0,1/0,-1/0,-1/0],o=[1/0,1/0,-1/0,-1/0],s=e.canonicalID();if(!s)return!1;if(n.type==="Polygon"){const a=jy(n.coordinates,o,s),l=HM(e.geometry(),i,o,s);if(!Ed(i,o))return!1;for(const h of l)if(!By(h,a))return!1}if(n.type==="MultiPolygon"){const a=LM(n.coordinates,o,s),l=HM(e.geometry(),i,o,s);if(!Ed(i,o))return!1;for(const h of l)if(!$H(h,a))return!1}return!0}(t,this.geometries);if(t.geometryType()==="LineString")return function(e,n){const i=[1/0,1/0,-1/0,-1/0],o=[1/0,1/0,-1/0,-1/0],s=e.canonicalID();if(!s)return!1;if(n.type==="Polygon"){const a=jy(n.coordinates,o,s),l=NM(e.geometry(),i,o,s);if(!Ed(i,o))return!1;for(const h of l)if(!FM(h,a))return!1}if(n.type==="MultiPolygon"){const a=LM(n.coordinates,o,s),l=NM(e.geometry(),i,o,s);if(!Ed(i,o))return!1;for(const h of l)if(!ZH(h,a))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}};function Od(r){if(r instanceof Pl&&(r.name==="get"&&r.args.length===1||r.name==="feature-state"||r.name==="has"&&r.args.length===1||r.name==="properties"||r.name==="geometry-type"||r.name==="id"||/^filter-/.test(r.name))||r instanceof Vy)return!1;let t=!0;return r.eachChild(e=>{t&&!Od(e)&&(t=!1)}),t}function Gy(r){if(r instanceof Pl&&r.name==="feature-state")return!1;let t=!0;return r.eachChild(e=>{t&&!Gy(e)&&(t=!1)}),t}function Uy(r,t){if(r instanceof Pl&&t.indexOf(r.name)>=0)return!1;let e=!0;return r.eachChild(n=>{e&&!Uy(n,t)&&(e=!1)}),e}var BM=class k3{constructor(t,e){this.type=e.type,this.name=t,this.boundExpression=e}static parse(t,e){if(t.length!==2||typeof t[1]!="string")return e.error("'var' expression requires exactly one string literal argument.");const n=t[1];return e.scope.has(n)?new k3(n,e.scope.get(n)):e.error(`Unknown variable "${n}". Make sure "${n}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}},jM=class I3{constructor(t,e=[],n,i=new HH,o=[]){this.registry=t,this.path=e,this.key=e.map(s=>`[${s}]`).join(""),this.scope=i,this.errors=o,this.expectedType=n}parse(t,e,n,i,o={}){return e?this.concat(e,n,i)._parse(t,o):this._parse(t,o)}_parse(t,e){function n(i,o,s){return s==="assert"?new zo(o,[i]):s==="coerce"?new Cl(o,[i]):i}if(t!==null&&typeof t!="string"&&typeof t!="boolean"&&typeof t!="number"||(t=["literal",t]),Array.isArray(t)){if(t.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const i=t[0];if(typeof i!="string")return this.error(`Expression name must be a string, but found ${typeof i} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const o=this.registry[i];if(o){let s=o.parse(t,this);if(!s)return null;if(this.expectedType){const a=this.expectedType,l=s.type;if(a.kind!=="string"&&a.kind!=="number"&&a.kind!=="boolean"&&a.kind!=="object"&&a.kind!=="array"||l.kind!=="value")if(a.kind!=="color"&&a.kind!=="formatted"&&a.kind!=="resolvedImage"||l.kind!=="value"&&l.kind!=="string"){if(this.checkSubtype(a,l))return null}else s=n(s,a,e.typeAnnotation||"coerce");else s=n(s,a,e.typeAnnotation||"assert")}if(!(s instanceof Pd)&&s.type.kind!=="resolvedImage"&&$y(s)){const a=new IM;try{s=new Pd(s.type,s.evaluate(a))}catch(l){return this.error(l.message),null}}return s}return this.error(`Unknown expression "${i}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(t===void 0?"'undefined' value invalid. Use null instead.":typeof t=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof t} instead.`)}concat(t,e,n){const i=typeof t=="number"?this.path.concat(t):this.path,o=n?this.scope.concat(n):this.scope;return new I3(this.registry,i,e||null,o,this.errors)}error(t,...e){const n=`${this.key}${e.map(i=>`[${i}]`).join("")}`;this.errors.push(new uo(n,t))}checkSubtype(t,e){const n=Eu(t,e);return n&&this.error(n),n}};function $y(r){if(r instanceof BM)return $y(r.boundExpression);if(r instanceof Pl&&r.name==="error"||r instanceof RM||r instanceof Vy)return!1;const t=r instanceof Cl||r instanceof zo;let e=!0;return r.eachChild(n=>{e=t?e&&$y(n):e&&n instanceof Pd}),!!e&&Od(r)&&Uy(r,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"])}function kd(r,t){const e=r.length-1;let n,i,o=0,s=e,a=0;for(;o<=s;)if(a=Math.floor((o+s)/2),n=r[a],i=r[a+1],n<=t){if(a===e||t<i)return a;o=a+1}else{if(!(n>t))throw new Cr("Input is not a number.");s=a-1}return 0}var VM=class R3{constructor(t,e,n){this.type=t,this.input=e,this.labels=[],this.outputs=[];for(const[i,o]of n)this.labels.push(i),this.outputs.push(o)}static parse(t,e){if(t.length-1<4)return e.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return e.error("Expected an even number of arguments.");const n=e.parse(t[1],1,Xt);if(!n)return null;const i=[];let o=null;e.expectedType&&e.expectedType.kind!=="value"&&(o=e.expectedType);for(let s=1;s<t.length;s+=2){const a=s===1?-1/0:t[s],l=t[s+1],h=s,u=s+1;if(typeof a!="number")return e.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',h);if(i.length&&i[i.length-1][0]>=a)return e.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',h);const c=e.parse(l,u,o);if(!c)return null;o=o||c.type,i.push([a,c])}return new R3(o,n,i)}evaluate(t){const e=this.labels,n=this.outputs;if(e.length===1)return n[0].evaluate(t);const i=this.input.evaluate(t);if(i<=e[0])return n[0].evaluate(t);const o=e.length;return i>=e[o-1]?n[o-1].evaluate(t):n[kd(e,i)].evaluate(t)}eachChild(t){t(this.input);for(const e of this.outputs)t(e)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){const t=["step",this.input.serialize()];for(let e=0;e<this.labels.length;e++)e>0&&t.push(this.labels[e]),t.push(this.outputs[e].serialize());return t}},XH=GM;function GM(r,t,e,n){this.cx=3*r,this.bx=3*(e-r)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*t,this.by=3*(n-t)-this.cy,this.ay=1-this.cy-this.by,this.p1x=r,this.p1y=t,this.p2x=e,this.p2y=n}function vi(r,t,e){return r*(1-e)+t*e}GM.prototype={sampleCurveX:function(r){return((this.ax*r+this.bx)*r+this.cx)*r},sampleCurveY:function(r){return((this.ay*r+this.by)*r+this.cy)*r},sampleCurveDerivativeX:function(r){return(3*this.ax*r+2*this.bx)*r+this.cx},solveCurveX:function(r,t){if(t===void 0&&(t=1e-6),r<0)return 0;if(r>1)return 1;for(var e=r,n=0;n<8;n++){var i=this.sampleCurveX(e)-r;if(Math.abs(i)<t)return e;var o=this.sampleCurveDerivativeX(e);if(Math.abs(o)<1e-6)break;e-=i/o}var s=0,a=1;for(e=r,n=0;n<20&&(i=this.sampleCurveX(e),!(Math.abs(i-r)<t));n++)r>i?s=e:a=e,e=.5*(a-s)+s;return e},solve:function(r,t){return this.sampleCurveY(this.solveCurveX(r,t))}};var UM=Object.freeze({__proto__:null,number:vi,color:function(r,t,e){return new Fr(vi(r.r,t.r,e),vi(r.g,t.g,e),vi(r.b,t.b,e),vi(r.a,t.a,e))},array:function(r,t,e){return r.map((n,i)=>vi(n,t[i],e))}});const $M=.95047,WM=1,ZM=1.08883,XM=4/29,El=6/29,YM=3*El*El,YH=El*El*El,qH=Math.PI/180,JH=180/Math.PI;function Wy(r){return r>YH?Math.pow(r,1/3):r/YM+XM}function Zy(r){return r>El?r*r*r:YM*(r-XM)}function Xy(r){return 255*(r<=.0031308?12.92*r:1.055*Math.pow(r,1/2.4)-.055)}function Yy(r){return(r/=255)<=.04045?r/12.92:Math.pow((r+.055)/1.055,2.4)}function qM(r){const t=Yy(r.r),e=Yy(r.g),n=Yy(r.b),i=Wy((.4124564*t+.3575761*e+.1804375*n)/$M),o=Wy((.2126729*t+.7151522*e+.072175*n)/WM);return{l:116*o-16,a:500*(i-o),b:200*(o-Wy((.0193339*t+.119192*e+.9503041*n)/ZM)),alpha:r.a}}function JM(r){let t=(r.l+16)/116,e=isNaN(r.a)?t:t+r.a/500,n=isNaN(r.b)?t:t-r.b/200;return t=WM*Zy(t),e=$M*Zy(e),n=ZM*Zy(n),new Fr(Xy(3.2404542*e-1.5371385*t-.4985314*n),Xy(-.969266*e+1.8760108*t+.041556*n),Xy(.0556434*e-.2040259*t+1.0572252*n),r.alpha)}function KH(r,t,e){const n=t-r;return r+e*(n>180||n<-180?n-360*Math.round(n/360):n)}const Iu={forward:qM,reverse:JM,interpolate:function(r,t,e){return{l:vi(r.l,t.l,e),a:vi(r.a,t.a,e),b:vi(r.b,t.b,e),alpha:vi(r.alpha,t.alpha,e)}}},Ru={forward:function(r){const{l:t,a:e,b:n}=qM(r),i=Math.atan2(n,e)*JH;return{h:i<0?i+360:i,c:Math.sqrt(e*e+n*n),l:t,alpha:r.a}},reverse:function(r){const t=r.h*qH,e=r.c;return JM({l:r.l,a:Math.cos(t)*e,b:Math.sin(t)*e,alpha:r.alpha})},interpolate:function(r,t,e){return{h:KH(r.h,t.h,e),c:vi(r.c,t.c,e),l:vi(r.l,t.l,e),alpha:vi(r.alpha,t.alpha,e)}}};var KM=Object.freeze({__proto__:null,lab:Iu,hcl:Ru});let QH=class _1{constructor(t,e,n,i,o){this.type=t,this.operator=e,this.interpolation=n,this.input=i,this.labels=[],this.outputs=[];for(const[s,a]of o)this.labels.push(s),this.outputs.push(a)}static interpolationFactor(t,e,n,i){let o=0;if(t.name==="exponential")o=qy(e,t.base,n,i);else if(t.name==="linear")o=qy(e,1,n,i);else if(t.name==="cubic-bezier"){const s=t.controlPoints;o=new XH(s[0],s[1],s[2],s[3]).solve(qy(e,1,n,i))}return o}static parse(t,e){let[n,i,o,...s]=t;if(!Array.isArray(i)||i.length===0)return e.error("Expected an interpolation type expression.",1);if(i[0]==="linear")i={name:"linear"};else if(i[0]==="exponential"){const h=i[1];if(typeof h!="number")return e.error("Exponential interpolation requires a numeric base.",1,1);i={name:"exponential",base:h}}else{if(i[0]!=="cubic-bezier")return e.error(`Unknown interpolation type ${String(i[0])}`,1,0);{const h=i.slice(1);if(h.length!==4||h.some(u=>typeof u!="number"||u<0||u>1))return e.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);i={name:"cubic-bezier",controlPoints:h}}}if(t.length-1<4)return e.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return e.error("Expected an even number of arguments.");if(o=e.parse(o,2,Xt),!o)return null;const a=[];let l=null;n==="interpolate-hcl"||n==="interpolate-lab"?l=Lo:e.expectedType&&e.expectedType.kind!=="value"&&(l=e.expectedType);for(let h=0;h<s.length;h+=2){const u=s[h],c=s[h+1],f=h+3,d=h+4;if(typeof u!="number")return e.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',f);if(a.length&&a[a.length-1][0]>=u)return e.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',f);const p=e.parse(c,d,l);if(!p)return null;l=l||p.type,a.push([u,p])}return l.kind==="number"||l.kind==="color"||l.kind==="array"&&l.itemType.kind==="number"&&typeof l.N=="number"?new _1(l,n,i,o,a):e.error(`Type ${Rn(l)} is not interpolatable.`)}evaluate(t){const e=this.labels,n=this.outputs;if(e.length===1)return n[0].evaluate(t);const i=this.input.evaluate(t);if(i<=e[0])return n[0].evaluate(t);const o=e.length;if(i>=e[o-1])return n[o-1].evaluate(t);const s=kd(e,i),a=_1.interpolationFactor(this.interpolation,i,e[s],e[s+1]),l=n[s].evaluate(t),h=n[s+1].evaluate(t);return this.operator==="interpolate"?UM[this.type.kind.toLowerCase()](l,h,a):this.operator==="interpolate-hcl"?Ru.reverse(Ru.interpolate(Ru.forward(l),Ru.forward(h),a)):Iu.reverse(Iu.interpolate(Iu.forward(l),Iu.forward(h),a))}eachChild(t){t(this.input);for(const e of this.outputs)t(e)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){let t;t=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const e=[this.operator,t,this.input.serialize()];for(let n=0;n<this.labels.length;n++)e.push(this.labels[n],this.outputs[n].serialize());return e}};function qy(r,t,e,n){const i=n-e,o=r-e;return i===0?0:t===1?o/i:(Math.pow(t,o)-1)/(Math.pow(t,i)-1)}var Ho=QH,QM=class D3{constructor(t,e){this.type=t,this.args=e}static parse(t,e){if(t.length<2)return e.error("Expectected at least one argument.");let n=null;const i=e.expectedType;i&&i.kind!=="value"&&(n=i);const o=[];for(const a of t.slice(1)){const l=e.parse(a,1+o.length,n,void 0,{typeAnnotation:"omit"});if(!l)return null;n=n||l.type,o.push(l)}const s=i&&o.some(a=>Eu(i,a.type));return new D3(s?Ge:n,o)}evaluate(t){let e,n=null,i=0;for(const o of this.args){if(i++,n=o.evaluate(t),n&&n instanceof sa&&!n.available&&(e||(e=n),n=null,i===this.args.length))return e;if(n!==null)break}return n}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=["coalesce"];return this.eachChild(e=>{t.push(e.serialize())}),t}},tS=class F3{constructor(t,e){this.type=e.type,this.bindings=[].concat(t),this.result=e}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const e of this.bindings)t(e[1]);t(this.result)}static parse(t,e){if(t.length<4)return e.error(`Expected at least 3 arguments, but found ${t.length-1} instead.`);const n=[];for(let o=1;o<t.length-1;o+=2){const s=t[o];if(typeof s!="string")return e.error(`Expected string, but found ${typeof s} instead.`,o);if(/[^a-zA-Z0-9_]/.test(s))return e.error("Variable names must contain only alphanumeric characters or '_'.",o);const a=e.parse(t[o+1],o+1);if(!a)return null;n.push([s,a])}const i=e.parse(t[t.length-1],t.length-1,e.expectedType,n);return i?new F3(n,i):null}outputDefined(){return this.result.outputDefined()}serialize(){const t=["let"];for(const[e,n]of this.bindings)t.push(e,n.serialize());return t.push(this.result.serialize()),t}},tN=class L3{constructor(t,e,n){this.type=t,this.index=e,this.input=n}static parse(t,e){if(t.length!==3)return e.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const n=e.parse(t[1],1,Xt),i=e.parse(t[2],2,ki(e.expectedType||Ge));return!n||!i?null:new L3(i.type.itemType,n,i)}evaluate(t){const e=this.index.evaluate(t),n=this.input.evaluate(t);if(e<0)throw new Cr(`Array index out of bounds: ${e} < 0.`);if(e>=n.length)throw new Cr(`Array index out of bounds: ${e} > ${n.length-1}.`);if(e!==Math.floor(e))throw new Cr(`Array index must be an integer, but found ${e} instead.`);return n[e]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}},eN=class z3{constructor(t,e){this.type=Ve,this.needle=t,this.haystack=e}static parse(t,e){if(t.length!==3)return e.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const n=e.parse(t[1],1,Ge),i=e.parse(t[2],2,Ge);return n&&i?Ry(n.type,[Ve,We,Xt,wd,Ge])?new z3(n,i):e.error(`Expected first argument to be of type boolean, string, number or null, but found ${Rn(n.type)} instead`):null}evaluate(t){const e=this.needle.evaluate(t),n=this.haystack.evaluate(t);if(n==null)return!1;if(!Ou(e,["boolean","string","number","null"]))throw new Cr(`Expected first argument to be of type boolean, string, number or null, but found ${Rn(dr(e))} instead.`);if(!Ou(n,["string","array"]))throw new Cr(`Expected second argument to be of type array or string, but found ${Rn(dr(n))} instead.`);return n.indexOf(e)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}},nN=class b1{constructor(t,e,n){this.type=Xt,this.needle=t,this.haystack=e,this.fromIndex=n}static parse(t,e){if(t.length<=2||t.length>=5)return e.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const n=e.parse(t[1],1,Ge),i=e.parse(t[2],2,Ge);if(!n||!i)return null;if(!Ry(n.type,[Ve,We,Xt,wd,Ge]))return e.error(`Expected first argument to be of type boolean, string, number or null, but found ${Rn(n.type)} instead`);if(t.length===4){const o=e.parse(t[3],3,Xt);return o?new b1(n,i,o):null}return new b1(n,i)}evaluate(t){const e=this.needle.evaluate(t),n=this.haystack.evaluate(t);if(!Ou(e,["boolean","string","number","null"]))throw new Cr(`Expected first argument to be of type boolean, string, number or null, but found ${Rn(dr(e))} instead.`);if(!Ou(n,["string","array"]))throw new Cr(`Expected second argument to be of type array or string, but found ${Rn(dr(n))} instead.`);if(this.fromIndex){const i=this.fromIndex.evaluate(t);return n.indexOf(e,i)}return n.indexOf(e)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const t=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}},rN=class H3{constructor(t,e,n,i,o,s){this.inputType=t,this.type=e,this.input=n,this.cases=i,this.outputs=o,this.otherwise=s}static parse(t,e){if(t.length<5)return e.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length%2!=1)return e.error("Expected an even number of arguments.");let n,i;e.expectedType&&e.expectedType.kind!=="value"&&(i=e.expectedType);const o={},s=[];for(let h=2;h<t.length-1;h+=2){let u=t[h];const c=t[h+1];Array.isArray(u)||(u=[u]);const f=e.concat(h);if(u.length===0)return f.error("Expected at least one branch label.");for(const p of u){if(typeof p!="number"&&typeof p!="string")return f.error("Branch labels must be numbers or strings.");if(typeof p=="number"&&Math.abs(p)>Number.MAX_SAFE_INTEGER)return f.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof p=="number"&&Math.floor(p)!==p)return f.error("Numeric branch labels must be integer values.");if(n){if(f.checkSubtype(n,dr(p)))return null}else n=dr(p);if(o[String(p)]!==void 0)return f.error("Branch labels must be unique.");o[String(p)]=s.length}const d=e.parse(c,h,i);if(!d)return null;i=i||d.type,s.push(d)}const a=e.parse(t[1],1,Ge);if(!a)return null;const l=e.parse(t[t.length-1],t.length-1,i);return l?a.type.kind!=="value"&&e.concat(1).checkSubtype(n,a.type)?null:new H3(n,i,a,o,s,l):null}evaluate(t){const e=this.input.evaluate(t);return(dr(e)===this.inputType&&this.outputs[this.cases[e]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every(t=>t.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["match",this.input.serialize()],e=Object.keys(this.cases).sort(),n=[],i={};for(const s of e){const a=i[this.cases[s]];a===void 0?(i[this.cases[s]]=n.length,n.push([this.cases[s],[s]])):n[a][1].push(s)}const o=s=>this.inputType.kind==="number"?Number(s):s;for(const[s,a]of n)t.push(a.length===1?o(a[0]):a.map(o)),t.push(this.outputs[s].serialize());return t.push(this.otherwise.serialize()),t}},iN=class N3{constructor(t,e,n){this.type=t,this.branches=e,this.otherwise=n}static parse(t,e){if(t.length<4)return e.error(`Expected at least 3 arguments, but found only ${t.length-1}.`);if(t.length%2!=0)return e.error("Expected an odd number of arguments.");let n;e.expectedType&&e.expectedType.kind!=="value"&&(n=e.expectedType);const i=[];for(let s=1;s<t.length-1;s+=2){const a=e.parse(t[s],s,Ve);if(!a)return null;const l=e.parse(t[s+1],s+1,n);if(!l)return null;i.push([a,l]),n=n||l.type}const o=e.parse(t[t.length-1],t.length-1,n);return o?new N3(n,i,o):null}evaluate(t){for(const[e,n]of this.branches)if(e.evaluate(t))return n.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[e,n]of this.branches)t(e),t(n);t(this.otherwise)}outputDefined(){return this.branches.every(([t,e])=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["case"];return this.eachChild(e=>{t.push(e.serialize())}),t}},oN=class w1{constructor(t,e,n,i){this.type=t,this.input=e,this.beginIndex=n,this.endIndex=i}static parse(t,e){if(t.length<=2||t.length>=5)return e.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const n=e.parse(t[1],1,Ge),i=e.parse(t[2],2,Xt);if(!n||!i)return null;if(!Ry(n.type,[ki(Ge),We,Ge]))return e.error(`Expected first argument to be of type array or string, but found ${Rn(n.type)} instead`);if(t.length===4){const o=e.parse(t[3],3,Xt);return o?new w1(n.type,n,i,o):null}return new w1(n.type,n,i)}evaluate(t){const e=this.input.evaluate(t),n=this.beginIndex.evaluate(t);if(!Ou(e,["string","array"]))throw new Cr(`Expected first argument to be of type array or string, but found ${Rn(dr(e))} instead.`);if(this.endIndex){const i=this.endIndex.evaluate(t);return e.slice(n,i)}return e.slice(n)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const t=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}};function eS(r,t){return r==="=="||r==="!="?t.kind==="boolean"||t.kind==="string"||t.kind==="number"||t.kind==="null"||t.kind==="value":t.kind==="string"||t.kind==="number"||t.kind==="value"}function nS(r,t,e,n){return n.compare(t,e)===0}function Ol(r,t,e){const n=r!=="=="&&r!=="!=";return class B3{constructor(o,s,a){this.type=Ve,this.lhs=o,this.rhs=s,this.collator=a,this.hasUntypedArgument=o.type.kind==="value"||s.type.kind==="value"}static parse(o,s){if(o.length!==3&&o.length!==4)return s.error("Expected two or three arguments.");const a=o[0];let l=s.parse(o[1],1,Ge);if(!l)return null;if(!eS(a,l.type))return s.concat(1).error(`"${a}" comparisons are not supported for type '${Rn(l.type)}'.`);let h=s.parse(o[2],2,Ge);if(!h)return null;if(!eS(a,h.type))return s.concat(2).error(`"${a}" comparisons are not supported for type '${Rn(h.type)}'.`);if(l.type.kind!==h.type.kind&&l.type.kind!=="value"&&h.type.kind!=="value")return s.error(`Cannot compare types '${Rn(l.type)}' and '${Rn(h.type)}'.`);n&&(l.type.kind==="value"&&h.type.kind!=="value"?l=new zo(h.type,[l]):l.type.kind!=="value"&&h.type.kind==="value"&&(h=new zo(l.type,[h])));let u=null;if(o.length===4){if(l.type.kind!=="string"&&h.type.kind!=="string"&&l.type.kind!=="value"&&h.type.kind!=="value")return s.error("Cannot use collator to compare non-string types.");if(u=s.parse(o[3],3,Ad),!u)return null}return new B3(l,h,u)}evaluate(o){const s=this.lhs.evaluate(o),a=this.rhs.evaluate(o);if(n&&this.hasUntypedArgument){const l=dr(s),h=dr(a);if(l.kind!==h.kind||l.kind!=="string"&&l.kind!=="number")throw new Cr(`Expected arguments for "${r}" to be (string, string) or (number, number), but found (${l.kind}, ${h.kind}) instead.`)}if(this.collator&&!n&&this.hasUntypedArgument){const l=dr(s),h=dr(a);if(l.kind!=="string"||h.kind!=="string")return t(o,s,a)}return this.collator?e(o,s,a,this.collator.evaluate(o)):t(o,s,a)}eachChild(o){o(this.lhs),o(this.rhs),this.collator&&o(this.collator)}outputDefined(){return!0}serialize(){const o=[r];return this.eachChild(s=>{o.push(s.serialize())}),o}}}const sN=Ol("==",function(r,t,e){return t===e},nS),aN=Ol("!=",function(r,t,e){return t!==e},function(r,t,e,n){return!nS(0,t,e,n)}),lN=Ol("<",function(r,t,e){return t<e},function(r,t,e,n){return n.compare(t,e)<0}),hN=Ol(">",function(r,t,e){return t>e},function(r,t,e,n){return n.compare(t,e)>0}),uN=Ol("<=",function(r,t,e){return t<=e},function(r,t,e,n){return n.compare(t,e)<=0}),cN=Ol(">=",function(r,t,e){return t>=e},function(r,t,e,n){return n.compare(t,e)>=0}),rS={"==":sN,"!=":aN,">":hN,"<":lN,">=":cN,"<=":uN,array:zo,at:tN,boolean:zo,case:iN,coalesce:QM,collator:RM,format:OM,image:kM,in:eN,"index-of":nN,interpolate:Ho,"interpolate-hcl":Ho,"interpolate-lab":Ho,length:class V3{constructor(t){this.type=Xt,this.input=t}static parse(t,e){if(t.length!==2)return e.error(`Expected 1 argument, but found ${t.length-1} instead.`);const n=e.parse(t[1],1);return n?n.type.kind!=="array"&&n.type.kind!=="string"&&n.type.kind!=="value"?e.error(`Expected argument of type string or array, but found ${Rn(n.type)} instead.`):new V3(n):null}evaluate(t){const e=this.input.evaluate(t);if(typeof e=="string"||Array.isArray(e))return e.length;throw new Cr(`Expected value to be of type string or array, but found ${Rn(dr(e))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){const t=["length"];return this.eachChild(e=>{t.push(e.serialize())}),t}},let:tS,literal:Pd,match:rN,number:zo,"number-format":class j3{constructor(t,e,n,i,o,s){this.type=We,this.number=t,this.locale=e,this.currency=n,this.unit=i,this.minFractionDigits=o,this.maxFractionDigits=s}static parse(t,e){if(t.length!==3)return e.error("Expected two arguments.");const n=e.parse(t[1],1,Xt);if(!n)return null;const i=t[2];if(typeof i!="object"||Array.isArray(i))return e.error("NumberFormat options argument must be an object.");let o=null;if(i.locale&&(o=e.parse(i.locale,1,We),!o))return null;let s=null;if(i.currency&&(s=e.parse(i.currency,1,We),!s))return null;let a=null;if(i.unit&&(a=e.parse(i.unit,1,We),!a))return null;let l=null;if(i["min-fraction-digits"]&&(l=e.parse(i["min-fraction-digits"],1,Xt),!l))return null;let h=null;return i["max-fraction-digits"]&&(h=e.parse(i["max-fraction-digits"],1,Xt),!h)?null:new j3(n,o,s,a,l,h)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(t):void 0,unit:this.unit?this.unit.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.unit&&t(this.unit),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.unit&&(t.unit=this.unit.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]}},object:zo,slice:oN,step:VM,string:zo,"to-boolean":Cl,"to-color":Cl,"to-number":Cl,"to-string":Cl,var:BM,within:Vy};function iS(r,[t,e,n,i]){t=t.evaluate(r),e=e.evaluate(r),n=n.evaluate(r);const o=i?i.evaluate(r):1,s=EM(t,e,n,o);if(s)throw new Cr(s);return new Fr(t/255*o,e/255*o,n/255*o,o)}function oS(r,t){return r in t}function Jy(r,t){const e=t[r];return e===void 0?null:e}function aa(r){return{type:r}}Pl.register(rS,{error:[{kind:"error"},[We],(r,[t])=>{throw new Cr(t.evaluate(r))}],typeof:[We,[Ge],(r,[t])=>Rn(dr(t.evaluate(r)))],"to-rgba":[ki(Xt,4),[Lo],(r,[t])=>t.evaluate(r).toArray()],rgb:[Lo,[Xt,Xt,Xt],iS],rgba:[Lo,[Xt,Xt,Xt,Xt],iS],has:{type:Ve,overloads:[[[We],(r,[t])=>oS(t.evaluate(r),r.properties())],[[We,Sl],(r,[t,e])=>oS(t.evaluate(r),e.evaluate(r))]]},get:{type:Ge,overloads:[[[We],(r,[t])=>Jy(t.evaluate(r),r.properties())],[[We,Sl],(r,[t,e])=>Jy(t.evaluate(r),e.evaluate(r))]]},"feature-state":[Ge,[We],(r,[t])=>Jy(t.evaluate(r),r.featureState||{})],properties:[Sl,[],r=>r.properties()],"geometry-type":[We,[],r=>r.geometryType()],id:[Ge,[],r=>r.id()],zoom:[Xt,[],r=>r.globals.zoom],pitch:[Xt,[],r=>r.globals.pitch||0],"distance-from-center":[Xt,[],r=>r.distanceFromCenter()],"heatmap-density":[Xt,[],r=>r.globals.heatmapDensity||0],"line-progress":[Xt,[],r=>r.globals.lineProgress||0],"sky-radial-progress":[Xt,[],r=>r.globals.skyRadialProgress||0],accumulated:[Ge,[],r=>r.globals.accumulated===void 0?null:r.globals.accumulated],"+":[Xt,aa(Xt),(r,t)=>{let e=0;for(const n of t)e+=n.evaluate(r);return e}],"*":[Xt,aa(Xt),(r,t)=>{let e=1;for(const n of t)e*=n.evaluate(r);return e}],"-":{type:Xt,overloads:[[[Xt,Xt],(r,[t,e])=>t.evaluate(r)-e.evaluate(r)],[[Xt],(r,[t])=>-t.evaluate(r)]]},"/":[Xt,[Xt,Xt],(r,[t,e])=>t.evaluate(r)/e.evaluate(r)],"%":[Xt,[Xt,Xt],(r,[t,e])=>t.evaluate(r)%e.evaluate(r)],ln2:[Xt,[],()=>Math.LN2],pi:[Xt,[],()=>Math.PI],e:[Xt,[],()=>Math.E],"^":[Xt,[Xt,Xt],(r,[t,e])=>Math.pow(t.evaluate(r),e.evaluate(r))],sqrt:[Xt,[Xt],(r,[t])=>Math.sqrt(t.evaluate(r))],log10:[Xt,[Xt],(r,[t])=>Math.log(t.evaluate(r))/Math.LN10],ln:[Xt,[Xt],(r,[t])=>Math.log(t.evaluate(r))],log2:[Xt,[Xt],(r,[t])=>Math.log(t.evaluate(r))/Math.LN2],sin:[Xt,[Xt],(r,[t])=>Math.sin(t.evaluate(r))],cos:[Xt,[Xt],(r,[t])=>Math.cos(t.evaluate(r))],tan:[Xt,[Xt],(r,[t])=>Math.tan(t.evaluate(r))],asin:[Xt,[Xt],(r,[t])=>Math.asin(t.evaluate(r))],acos:[Xt,[Xt],(r,[t])=>Math.acos(t.evaluate(r))],atan:[Xt,[Xt],(r,[t])=>Math.atan(t.evaluate(r))],min:[Xt,aa(Xt),(r,t)=>Math.min(...t.map(e=>e.evaluate(r)))],max:[Xt,aa(Xt),(r,t)=>Math.max(...t.map(e=>e.evaluate(r)))],abs:[Xt,[Xt],(r,[t])=>Math.abs(t.evaluate(r))],round:[Xt,[Xt],(r,[t])=>{const e=t.evaluate(r);return e<0?-Math.round(-e):Math.round(e)}],floor:[Xt,[Xt],(r,[t])=>Math.floor(t.evaluate(r))],ceil:[Xt,[Xt],(r,[t])=>Math.ceil(t.evaluate(r))],"filter-==":[Ve,[We,Ge],(r,[t,e])=>r.properties()[t.value]===e.value],"filter-id-==":[Ve,[Ge],(r,[t])=>r.id()===t.value],"filter-type-==":[Ve,[We],(r,[t])=>r.geometryType()===t.value],"filter-<":[Ve,[We,Ge],(r,[t,e])=>{const n=r.properties()[t.value],i=e.value;return typeof n==typeof i&&n<i}],"filter-id-<":[Ve,[Ge],(r,[t])=>{const e=r.id(),n=t.value;return typeof e==typeof n&&e<n}],"filter->":[Ve,[We,Ge],(r,[t,e])=>{const n=r.properties()[t.value],i=e.value;return typeof n==typeof i&&n>i}],"filter-id->":[Ve,[Ge],(r,[t])=>{const e=r.id(),n=t.value;return typeof e==typeof n&&e>n}],"filter-<=":[Ve,[We,Ge],(r,[t,e])=>{const n=r.properties()[t.value],i=e.value;return typeof n==typeof i&&n<=i}],"filter-id-<=":[Ve,[Ge],(r,[t])=>{const e=r.id(),n=t.value;return typeof e==typeof n&&e<=n}],"filter->=":[Ve,[We,Ge],(r,[t,e])=>{const n=r.properties()[t.value],i=e.value;return typeof n==typeof i&&n>=i}],"filter-id->=":[Ve,[Ge],(r,[t])=>{const e=r.id(),n=t.value;return typeof e==typeof n&&e>=n}],"filter-has":[Ve,[Ge],(r,[t])=>t.value in r.properties()],"filter-has-id":[Ve,[],r=>r.id()!==null&&r.id()!==void 0],"filter-type-in":[Ve,[ki(We)],(r,[t])=>t.value.indexOf(r.geometryType())>=0],"filter-id-in":[Ve,[ki(Ge)],(r,[t])=>t.value.indexOf(r.id())>=0],"filter-in-small":[Ve,[We,ki(Ge)],(r,[t,e])=>e.value.indexOf(r.properties()[t.value])>=0],"filter-in-large":[Ve,[We,ki(Ge)],(r,[t,e])=>function(n,i,o,s){for(;o<=s;){const a=o+s>>1;if(i[a]===n)return!0;i[a]>n?s=a-1:o=a+1}return!1}(r.properties()[t.value],e.value,0,e.value.length-1)],all:{type:Ve,overloads:[[[Ve,Ve],(r,[t,e])=>t.evaluate(r)&&e.evaluate(r)],[aa(Ve),(r,t)=>{for(const e of t)if(!e.evaluate(r))return!1;return!0}]]},any:{type:Ve,overloads:[[[Ve,Ve],(r,[t,e])=>t.evaluate(r)||e.evaluate(r)],[aa(Ve),(r,t)=>{for(const e of t)if(e.evaluate(r))return!0;return!1}]]},"!":[Ve,[Ve],(r,[t])=>!t.evaluate(r)],"is-supported-script":[Ve,[We],(r,[t])=>{const e=r.globals&&r.globals.isSupportedScript;return!e||e(t.evaluate(r))}],upcase:[We,[We],(r,[t])=>t.evaluate(r).toUpperCase()],downcase:[We,[We],(r,[t])=>t.evaluate(r).toLowerCase()],concat:[We,aa(Ge),(r,t)=>t.map(e=>ku(e.evaluate(r))).join("")],"resolved-locale":[We,[Ad],(r,[t])=>t.evaluate(r).resolvedLocale()]});var sS=rS;function Ky(r){return{result:"success",value:r}}function kl(r){return{result:"error",value:r}}function aS(r){return!!r.expression&&r.expression.interpolated}function Qy(r){return r instanceof Number?"number":r instanceof String?"string":r instanceof Boolean?"boolean":Array.isArray(r)?"array":r===null?"null":typeof r}function lS(r){return typeof r=="object"&&r!==null&&!Array.isArray(r)}function fN(r){return r}function hS(r,t){const e=t.type==="color",n=r.stops&&typeof r.stops[0][0]=="object",i=n||!(n||r.property!==void 0),o=r.type||(aS(t)?"exponential":"interval");if(e&&((r=SM({},r)).stops&&(r.stops=r.stops.map(h=>[h[0],Fr.parse(h[1])])),r.default=Fr.parse(r.default?r.default:t.default)),r.colorSpace&&r.colorSpace!=="rgb"&&!KM[r.colorSpace])throw new Error(`Unknown color space: ${r.colorSpace}`);let s,a,l;if(o==="exponential")s=uS;else if(o==="interval")s=pN;else if(o==="categorical"){s=dN,a=Object.create(null);for(const h of r.stops)a[h[0]]=h[1];l=typeof r.stops[0][0]}else{if(o!=="identity")throw new Error(`Unknown function type "${o}"`);s=gN}if(n){const h={},u=[];for(let d=0;d<r.stops.length;d++){const p=r.stops[d],g=p[0].zoom;h[g]===void 0&&(h[g]={zoom:g,type:r.type,property:r.property,default:r.default,stops:[]},u.push(g)),h[g].stops.push([p[0].value,p[1]])}const c=[];for(const d of u)c.push([h[d].zoom,hS(h[d],t)]);const f={name:"linear"};return{kind:"composite",interpolationType:f,interpolationFactor:Ho.interpolationFactor.bind(void 0,f),zoomStops:c.map(d=>d[0]),evaluate:({zoom:d},p)=>uS({stops:c,base:r.base},t,d).evaluate(d,p)}}if(i){const h=o==="exponential"?{name:"exponential",base:r.base!==void 0?r.base:1}:null;return{kind:"camera",interpolationType:h,interpolationFactor:Ho.interpolationFactor.bind(void 0,h),zoomStops:r.stops.map(u=>u[0]),evaluate:({zoom:u})=>s(r,t,u,a,l)}}return{kind:"source",evaluate(h,u){const c=u&&u.properties?u.properties[r.property]:void 0;return c===void 0?Du(r.default,t.default):s(r,t,c,a,l)}}}function Du(r,t,e){return r!==void 0?r:t!==void 0?t:e!==void 0?e:void 0}function dN(r,t,e,n,i){return Du(typeof e===i?n[e]:void 0,r.default,t.default)}function pN(r,t,e){if(Qy(e)!=="number")return Du(r.default,t.default);const n=r.stops.length;if(n===1||e<=r.stops[0][0])return r.stops[0][1];if(e>=r.stops[n-1][0])return r.stops[n-1][1];const i=kd(r.stops.map(o=>o[0]),e);return r.stops[i][1]}function uS(r,t,e){const n=r.base!==void 0?r.base:1;if(Qy(e)!=="number")return Du(r.default,t.default);const i=r.stops.length;if(i===1||e<=r.stops[0][0])return r.stops[0][1];if(e>=r.stops[i-1][0])return r.stops[i-1][1];const o=kd(r.stops.map(u=>u[0]),e),s=function(u,c,f,d){const p=d-f,g=u-f;return p===0?0:c===1?g/p:(Math.pow(c,g)-1)/(Math.pow(c,p)-1)}(e,n,r.stops[o][0],r.stops[o+1][0]),a=r.stops[o][1],l=r.stops[o+1][1];let h=UM[t.type]||fN;if(r.colorSpace&&r.colorSpace!=="rgb"){const u=KM[r.colorSpace];h=(c,f)=>u.reverse(u.interpolate(u.forward(c),u.forward(f),s))}return typeof a.evaluate=="function"?{evaluate(...u){const c=a.evaluate.apply(void 0,u),f=l.evaluate.apply(void 0,u);if(c!==void 0&&f!==void 0)return h(c,f,s)}}:h(a,l,s)}function gN(r,t,e){return t.type==="color"?e=Fr.parse(e):t.type==="formatted"?e=oa.fromString(e.toString()):t.type==="resolvedImage"?e=sa.fromString(e.toString()):Qy(e)===t.type||t.type==="enum"&&t.values[e]||(e=void 0),Du(e,r.default,t.default)}let cS=class{constructor(t,e){this.expression=t,this._warningHistory={},this._evaluator=new IM,this._defaultValue=e?function(n){return n.type==="color"&&(lS(n.default)||Array.isArray(n.default))?new Fr(0,0,0,0):n.type==="color"?Fr.parse(n.default)||null:n.default===void 0?null:n.default}(e):null,this._enumValues=e&&e.type==="enum"?e.values:null}evaluateWithoutErrorHandling(t,e,n,i,o,s,a,l){return this._evaluator.globals=t,this._evaluator.feature=e,this._evaluator.featureState=n,this._evaluator.canonical=i||null,this._evaluator.availableImages=o||null,this._evaluator.formattedSection=s,this._evaluator.featureTileCoord=a||null,this._evaluator.featureDistanceData=l||null,this.expression.evaluate(this._evaluator)}evaluate(t,e,n,i,o,s,a,l){this._evaluator.globals=t,this._evaluator.feature=e||null,this._evaluator.featureState=n||null,this._evaluator.canonical=i||null,this._evaluator.availableImages=o||null,this._evaluator.formattedSection=s||null,this._evaluator.featureTileCoord=a||null,this._evaluator.featureDistanceData=l||null;try{const h=this.expression.evaluate(this._evaluator);if(h==null||typeof h=="number"&&h!=h)return this._defaultValue;if(this._enumValues&&!(h in this._enumValues))throw new Cr(`Expected value to be one of ${Object.keys(this._enumValues).map(u=>JSON.stringify(u)).join(", ")}, but found ${JSON.stringify(h)} instead.`);return h}catch(h){return this._warningHistory[h.message]||(this._warningHistory[h.message]=!0,typeof console<"u"&&console.warn(h.message)),this._defaultValue}}};function fS(r){return Array.isArray(r)&&r.length>0&&typeof r[0]=="string"&&r[0]in sS}function Id(r,t){const e=new jM(sS,[],t?function(i){const o={color:Lo,string:We,number:Xt,enum:We,boolean:Ve,formatted:Td,resolvedImage:Pu};return i.type==="array"?ki(o[i.value]||Ge,i.length):o[i.type]}(t):void 0),n=e.parse(r,void 0,void 0,void 0,t&&t.type==="string"?{typeAnnotation:"coerce"}:void 0);return n?Ky(new cS(n,t)):kl(e.errors)}let dS=class{constructor(t,e){this.kind=t,this._styleExpression=e,this.isStateDependent=t!=="constant"&&!Gy(e.expression)}evaluateWithoutErrorHandling(t,e,n,i,o,s){return this._styleExpression.evaluateWithoutErrorHandling(t,e,n,i,o,s)}evaluate(t,e,n,i,o,s){return this._styleExpression.evaluate(t,e,n,i,o,s)}},pS=class{constructor(t,e,n,i){this.kind=t,this.zoomStops=n,this._styleExpression=e,this.isStateDependent=t!=="camera"&&!Gy(e.expression),this.interpolationType=i}evaluateWithoutErrorHandling(t,e,n,i,o,s){return this._styleExpression.evaluateWithoutErrorHandling(t,e,n,i,o,s)}evaluate(t,e,n,i,o,s){return this._styleExpression.evaluate(t,e,n,i,o,s)}interpolationFactor(t,e,n){return this.interpolationType?Ho.interpolationFactor(this.interpolationType,t,e,n):0}};function gS(r,t){if((r=Id(r,t)).result==="error")return r;const e=r.value.expression,n=Od(e);if(!n&&!function(a){return a["property-type"]==="data-driven"}(t))return kl([new uo("","data expressions not supported")]);const i=Uy(e,["zoom","pitch","distance-from-center"]);if(!i&&!function(a){return!!a.expression&&a.expression.parameters.indexOf("zoom")>-1}(t))return kl([new uo("","zoom expressions not supported")]);const o=Rd(e);if(!o&&!i)return kl([new uo("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')]);if(o instanceof uo)return kl([o]);if(o instanceof Ho&&!aS(t))return kl([new uo("",'"interpolate" expressions cannot be used with this property')]);if(!o)return Ky(new dS(n?"constant":"source",r.value));const s=o instanceof Ho?o.interpolation:void 0;return Ky(new pS(n?"camera":"composite",r.value,o.labels,s))}let mS=class G3{constructor(t,e){this._parameters=t,this._specification=e,SM(this,hS(this._parameters,this._specification))}static deserialize(t){return new G3(t._parameters,t._specification)}static serialize(t){return{_parameters:t._parameters,_specification:t._specification}}};function Rd(r){let t=null;if(r instanceof tS)t=Rd(r.result);else if(r instanceof QM){for(const e of r.args)if(t=Rd(e),t)break}else(r instanceof VM||r instanceof Ho)&&r.input instanceof Pl&&r.input.name==="zoom"&&(t=r);return t instanceof uo||r.eachChild(e=>{const n=Rd(e);n instanceof uo?t=n:!t&&n?t=new uo("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):t&&n&&t!==n&&(t=new uo("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),t}function tv(r){if(Array.isArray(r))return r.map(tv);if(r instanceof Object&&!(r instanceof Number||r instanceof String||r instanceof Boolean)){const t={};for(const e in r)t[e]=tv(r[e]);return t}return function(t){return t instanceof Number||t instanceof String||t instanceof Boolean?t.valueOf():t}(r)}function mN(r,t="fill"){if(r==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};const e=r;let n=!0;try{n=function(l){if(!Il(l))return l;let h=tv(l);return vS(h),h=yS(h),h}(e)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(e,null,2)}
        `)}const i=Id(n,null);let o=null;if(i.result==="error")throw new Error(i.value.map(l=>`${l.key}: ${l.message}`).join(", "));o=(l,h,u)=>i.value.evaluate(l,h,{},u);let s=null,a=null;if(n!==e){const l=Id(e,null);if(l.result==="error")throw new Error(l.value.map(h=>`${h.key}: ${h.message}`).join(", "));s=(h,u,c,f,d)=>l.value.evaluate(h,u,{},c,void 0,void 0,f,d),a=!Od(l.value.expression)}return{filter:o,dynamicFilter:s||void 0,needGeometry:xS(n),needFeature:!!a}}function yS(r){if(!Array.isArray(r))return r;const t=function(e){if(yN.has(e[0])){for(let n=1;n<e.length;n++)if(Il(e[n]))return!0}return e}(r);return t===!0?t:t.map(e=>yS(e))}function vS(r){let t=!1;const e=[];if(r[0]==="case"){for(let n=1;n<r.length-1;n+=2)t=t||Il(r[n]),e.push(r[n+1]);e.push(r[r.length-1])}else if(r[0]==="match"){t=t||Il(r[1]);for(let n=2;n<r.length-1;n+=2)e.push(r[n+1]);e.push(r[r.length-1])}else if(r[0]==="step"){t=t||Il(r[1]);for(let n=1;n<r.length-1;n+=2)e.push(r[n+1])}t&&(r.length=0,r.push("any",...e));for(let n=1;n<r.length;n++)vS(r[n])}function Il(r){if(!Array.isArray(r))return!1;if(function(t){return t==="pitch"||t==="distance-from-center"}(r[0]))return!0;for(let t=1;t<r.length;t++)if(Il(r[t]))return!0;return!1}const yN=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function xS(r){if(!Array.isArray(r))return!1;if(r[0]==="within")return!0;for(let t=1;t<r.length;t++)if(xS(r[t]))return!0;return!1}const vN={StyleExpression:cS,isExpression:fS,isExpressionFilter:function r(t){if(t===!0||t===!1)return!0;if(!Array.isArray(t)||t.length===0)return!1;switch(t[0]){case"has":return t.length>=2&&t[1]!=="$id"&&t[1]!=="$type";case"in":return t.length>=3&&(typeof t[1]!="string"||Array.isArray(t[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return t.length!==3||Array.isArray(t[1])||Array.isArray(t[2]);case"any":case"all":for(const e of t.slice(1))if(!r(e)&&typeof e!="boolean")return!1;return!0;default:return!0}},createExpression:Id,createPropertyExpression:gS,normalizePropertyExpression:function(r,t){if(lS(r))return new mS(r,t);if(fS(r)){const e=gS(r,t);if(e.result==="error")throw new Error(e.value.map(n=>`${n.key}: ${n.message}`).join(", "));return e.value}{let e=r;return typeof r=="string"&&t.type==="color"&&(e=Fr.parse(r)),{kind:"constant",evaluate:()=>e}}},ZoomConstantExpression:dS,ZoomDependentExpression:pS,StylePropertyFunction:mS},{isExpression:xN,createExpression:_N}=vN,_S={};function bS(r){if(!Array.isArray(r))return bS([r]);const t=[];for(let e=0;e<r.length;e++){let n;n=r[e].filter===!0?function(){return!0}:Fu(r[e].filter),t.push(wl({},r[e],{filter:n}))}return t}function Fu(r){if(r===!0)return function(){return!0};if(r&&r.condition){if(r.type==="any"){const n=r.condition,i=[];for(let o=0;o<n.length;o++)i.push(Fu(n[o]));return(o,s)=>{for(let a=0;a<i.length;a++)if(i[a](o,s))return!0;return!1}}const t=Fu(r.condition);if(tn(r.layer))return t;const e=n=>n.layer===r.layer;return(n,i)=>e(n)&&t(n,i)}if(KT(r))return JT(r);{let t=mN(r);return t=t&&t.filter,(n,i)=>(_S.zoom=i,t&&t(_S,n))}}const wS={type:"number","property-type":"data-driven",expression:{parameters:["zoom","feature"]}};function ev(r,t){wS.type=t||"number";const e=_N(r,wS);if(e.result!=="success")throw new Error(`Invalid maplibre spec expression: ${JSON.stringify(r)} (${e.value})`);return e.value}function nv(r){return xN(r)}const bN={lineWidth:1,lineStrokeWidth:1,lineDx:1,lineDy:1,lineOpacity:1,linePatternAnimSpeed:1,markerWidth:1,markerHeight:1,markerDx:1,markerDy:1,markerSpacing:1,markerOpacity:1,markerRotation:1,textWrapWidth:1,textSpacing:1,textSize:1,textHaloRadius:1,textHaloOpacity:1,textDx:1,textDy:1,textOpacity:1,textRotation:1,polygonOpacity:1};function rv(r){return bN[r]}const wN={markerPlacement:1,markerFile:1,mergeOnProperty:1,markerTextFit:1,markerType:1,markerHorizontalAlignment:1,markerVerticalAlignment:1,markerRotationAlignment:1,markerPitchAlignment:1,markerFillPatternFile:1,markerLinePatternFile:1,textName:1,textPlacement:1,textFaceName:1,textStyle:1,textHorizontalAlignment:1,textVerticalAlignment:1,textRotationAlignment:1,textPitchAlignment:1,lineJoin:1,lineCap:1,linePatternFile:1,polygonPatternFile:1},AN={lineDasharray:1,markerLineDasharray:1,uvScale:1,uvOffset:1};function iv(r){return wN[r]?"string":rv(r)?"number":AN[r]?"array":"color"}var Lu=Object.freeze({__proto__:null,compileFilter:Fu,compileStyle:function(r=[]){return bS(r=r.map(t=>{const e=wl({},t);return e.filter&&e.filter.value&&(e.filter=e.filter.value),e}))},createExpression:ev,getExpressionType:iv,isExpression:nv,isInterpolated:rv});const AS=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope,TS=function(r){return class extends r{pushIn(...t){const e=t.length;for(let n=0;n<e;n++)this[this.currentIndex++]=t[n]}fill(t,e,n){super.fill(t,e,n),n>this.currentIndex&&(this.currentIndex=n)}set(t,e){t>=this.currentIndex&&(this.currentIndex=t+1),this[t]=e}getLength(){return this.currentIndex}setLength(t){this.currentIndex=t,super.length<t&&(super.length=t)}trySetLength(t){t>this.currentIndex&&this.setLength(t)}reset(){this.currentIndex=0}slice(t,e){const n=super.slice(t,e);return n.currentIndex=e-t,n}}},MS=TS(Array),TN={get:function(r,t){return t==="length"?r.getLength():r[t]}};let SS=class extends Array{setLength(t){this.length=t,this.currentIndex=t}trySetLength(t){this.length=t,this.currentIndex=t}getLength(){return this.length}},CS,Ur=class Rp{static createTypedArray(t,e){return vM(t,e)}static getInstance(){return CS}static ensureCapacity(t,e){if(!t.BYTES_PER_ELEMENT||t.length>=e)return t;const n=new t.constructor(e+Math.ceil(.5*e)),i=t.getLength();for(let o=0;o<i;o++)n[o]=t[o];return n.currentIndex=t.currentIndex,n}static getArray(t){let e;if(t){const n=TS(t);e=new n(1048576/n.BYTES_PER_ELEMENT)}else e=new MS;return e.push=(...n)=>{e.pushIn(...n)},e}static getProxyArray(){const t=new MS,e=new Proxy(t,TN);return e.push=(...n)=>{t.pushIn(...n)},e._origin=t,e}constructor(){this._arrays=[],this._index=0,this._proxiedArrays=[],this._proxiedIndex=0,this._typedArrays={}}getProxy(){if(!AS){const e=new SS;return e.currentIndex=0,e}const t=this._proxiedArrays[this._proxiedIndex]=this._proxiedArrays[this._proxiedIndex]||Rp.getProxyArray();return t.reset(),this._proxiedIndex++,t}get(t){if(!AS){const n=new SS;return n.currentIndex=0,n}if(t){const n=t.name;let i=this._typedArrays[n];i||(i=this._typedArrays[n]={arrays:[],index:0});const o=i.index,s=i.arrays[o]=i.arrays[o]||Rp.getArray(t);return s.reset(),i.index++,s}const e=this._arrays[this._index]=this._arrays[this._index]||Rp.getArray();return e.reset(),this._index++,e}reset(){this._index=0,this._proxiedIndex=0;for(const t in this._typedArrays)this._typedArrays[t].index=0}};CS=new Ur;const PS="__fea_idx",Dd=[],ES={},zu={},MN={},SN=[],Rl=Ur.getInstance(),CN=Math.pow(2,17);let la=class U3{static isAtlasLoaded(t,e={}){const{iconAtlas:n}=e;return!!(!t||n&&n.positions[t])}static genFnTypes(t){const e={};for(const n in t)if(nv(t[n])){const i=(n+"_Fn_0").trim(),o=(n+"Fn").trim(),s=iv(n);e[i]=ev(t[n],s),e[o]=(a,l)=>{let h;ES.zoom=a,zu.properties=l;try{h=e[i].evaluateWithoutErrorHandling(ES,zu,MN,null,SN)}catch{return null}return h}}else if(Su(t[n])){const i=(n+"_Fn_0").trim(),o=(n+"Fn").trim();rv(n)?(e[i]=le(t[n]),e[o]=(s,a)=>{const l=e[i](s,a);return Su(l)?le(l)(s,a):l}):(e[i]=cn(t[n]),e[o]=(s,a)=>{const l=e[i](s,a);return Su(l)?cn(l)(s,a):l})}return e}constructor(t,e,n){this.options=n;const i=[];this.symbolDef=e,this.symbol=yu(e,()=>(i[0]=n.zoom,i)),this.styledVectors=[],this.properties={},this._fnTypes=n.fnTypes||U3.genFnTypes(this.symbolDef),Su(this.symbolDef.visible)&&(this._visibleFn=le(this.symbolDef.visible)),n.atlas&&(this.iconAtlas=n.atlas.iconAtlas,this.glyphAtlas=n.atlas.glyphAtlas),this.features=this._check(t)}needAltitudeAttribute(){return this.options.forceAltitudeAttribute||this.maxPosZ>=CN||this.options.positionType===Float32Array}getPositionFormat(){return this.needAltitudeAttribute()?[{type:Int16Array,width:2,name:"aPosition"},{type:Float32Array,width:1,name:"aAltitude"}]:[{type:Float32Array,width:3,name:"aPosition"}]}fillPosition(t,e,n,i){if(e<this._minX&&(this._minX=e),e>this._maxX&&(this._maxX=e),n<this._minY&&(this._minY=n),n>this._maxY&&(this._maxY=n),this.needAltitudeAttribute()){let o=t.aPosition.currentIndex;t.aPosition[o++]=e,t.aPosition[o++]=n,t.aPosition.currentIndex=o,o=t.aAltitude.currentIndex,t.aAltitude[o++]=i,t.aAltitude.currentIndex=o}else{TM(Dd,e,n,i);let o=t.aPosition.currentIndex;t.aPosition[o++]=Dd[0],t.aPosition[o++]=Dd[1],t.aPosition[o++]=Dd[2],t.aPosition.currentIndex=o}}_check(t){if(!t.length)return t;const e=(PS+"").trim();let n,i=0,o=t[i];for(;!o.geometry;)i++,o=t[i];if(Array.isArray(o.geometry)&&o.properties){let a=o.geometry[0];for(;Array.isArray(a);)a=a[0];a instanceof sn&&(n=t)}if(!n)if(n=[],Array.isArray(o.geometry))for(let a=0;a<t.length;a++){const l=wl({},t[a]);n.push(xM(l))}else for(let a=0;a<t.length;a++){const l=t[a],h=kH(l);for(let u=0;u<h.length;u++){const c=h[u];c[e]=l[e],n.push(c)}}if(this.maxPosZ=0,!this.options.forceAltitudeAttribute){const a=this.symbolDef.textPlacement==="line";let l=0,h=!1;const{textPitchAlignmentFn:u}=this._fnTypes;!u&&a&&this.symbolDef.textPitchAlignment==="map"&&(h=!0);for(let c=0;c<n.length;c++){const f=kS(n[c]&&n[c].geometry);if(f>l&&(l=f),a&&!h&&u&&n[c].properties){const d=u(null,n[c].properties);d==="map"&&(h=d)}}this.hasMapPitchAlign=h,this.maxPosZ=l}const s=this.options.order;if(s){const a=[];for(let l=0;l<s.length;l++)s[l]&&a.push(Fu(s[l]));n=n.sort((l,h)=>{const u=a.length;let c=-1,f=-1;for(let d=0;d<u&&(a[d](l)&&(c=d),a[d](h)&&(f=d),!(c>=0&&c<u&&f>=0&&f<u));d++);return c-f})}return n}load(t=1){const e=(PS+"").trim(),n="_debug_info".trim(),i=this._fnTypes,o=this.styledVectors;this.count=0;const s=this.features;if(!s||!s.length)return Promise.resolve(null);const a={},l={},h={zoom:this.options.zoom,isVector3D:!!this.options.center},u=[],c=yu(this.symbolDef,()=>(u[0]=h.zoom,u));let f=0,d=s.length;const p=this.options.debugIndex;try{for(;f<d;f++){const g=s[f];if(!g||!g.geometry||ys(p)&&g[n].index!==p)continue;g.properties||(g.properties={}),g.properties.$layer=g.layer,g.properties.$type=g.type;const m=this.createStyledVector(g,c,i,h,a,l);m&&m.feature.geometry&&(m.featureIdx=g[e]===void 0?f:g[e],this.count++,o.push(m))}}catch(g){return Promise.reject(g)}return this.options.atlas?Promise.resolve(this.pack(t)):this.loadAtlas(a,l).then(()=>this.pack(t))}loadAtlas(t,e){return new Promise((n,i)=>{this.fetchAtlas(t,e,(o,s)=>{if(o)i(o);else{if(s){const{icons:a,glyphs:l}=s;if(a&&Object.keys(a).length){for(const h in a){const u=a[h],{width:c,height:f,data:d}=u.data;u.data=new Mu({width:c,height:f},d)}this.iconAtlas=new gM(a)}if(l&&Object.keys(l).length){for(const h in l){const u=l[h];for(const c in u){const f=u[c],{width:d,height:p,data:g}=f.bitmap;f.bitmap=new Tu({width:d,height:p},g)}}this.glyphAtlas=new RH(l)}}n({glyphAtlas:this.glyphAtlas,iconAtlas:this.iconAtlas})}})})}fetchAtlas(t,e,n){Object.keys(t).length>0||Object.keys(e).length>0?this.options.requestor(t,e,n):n()}pack(t){if(!this.count)return null;if(t==null)throw new Error("layout scale is undefined");const e=this.createDataPack(this.styledVectors,t);if(!e)return null;e.properties=this.properties,this.empty&&(e.empty=!0);const n=e.buffers;delete e.buffers;const i={data:e,buffers:n};if(this.iconAtlas){const o=i.data.iconAtlas=OS(this.iconAtlas);if(o.glyphMap)for(const s in o.glyphMap)n.push(o.glyphMap[s].data.data.buffer);n.push(i.data.iconAtlas.image.data.buffer)}return this.glyphAtlas&&(i.data.glyphAtlas=OS(this.glyphAtlas),n.push(i.data.glyphAtlas.image.data.buffer)),i}createStyledVector(t,e,n,i){return new xd(t,e,n,i)}createDataPack(t,e){if(!t||!t.length)return null;this.maxIndex=0,this.maxPos=0,this._minX=this._minY=1/0,this._maxX=this._maxY=-1/0,this.maxAltitude=0,this.dynamicAttrs={};const n=this.data={};this._arrayPool=Rl,Rl.reset();let i=this.elements=Rl.get();const o=this._dataFormat=this.getFormat(Array.isArray(t[0])?t[0][0].symbol:t[0].symbol),s=this.needAltitudeAttribute()?2:3;for(let _=0;_<o.length;_++)n[o[_].name]=Rl.get(o[_].type);let a=Rl.get(),l=0;const h=Rl.get();let u=0,c=!1,f=!0;const d=new Set;for(let _=0,w=t.length;_<w;_++){if(!t[_].feature.geometry)continue;const b=Array.isArray(t[_])?t[_][0].feature.id:t[_].feature.id;f&&(zu.id!==void 0?d&&(d.has(zu.id)?f=!1:d.add(zu.id)):f=!1),ys(b)&&(Math.abs(b)>u&&(u=Math.abs(b)),b<0&&(c=!0));const A=this.data.aPosition.getLength();if(Array.isArray(t[_]))for(let S=0;S<t[_].length;S++)this._placeVector(t[_][S],e);else this._placeVector(t[_],e);const T=(n.aPosition.getLength()-A)/s;for(let S=0;S<T;S++)a.push(t[_].featureIdx),ys(b)&&h.push(b);l=Math.max(l,t[_].featureIdx)}if(this.countOutOfAngle>0&&console.warn("text anchor along line is ignored as anchor's line angle is bigger than textMaxAngle."),this.hasElements()&&!i.getLength())return null;const p=this.options.center?Float32Array:Ey(l);a=Ur.createTypedArray(a,p),o[0].type=this.options.positionType?this.options.positionType:Py(this.maxPos);const g=this.options.center;if(g&&(g[0]||g[1])){const _=n.aPosition,w=_.getLength();for(let b=0;b<w;b+=s)_[b]-=g[0],_[b+1]-=g[1]}const m=function(_,w){const b={};for(let A=0;A<_.length;A++){const T=_[A],S=T.type,M=T.name;b[M]=S===Array?w[M]:vM(w[M],S)}return b}(o,n);m.aPickingId=a;const y=[];for(const _ in m)y.push(m[_].buffer);const x=yM(this.maxIndex);i=Ur.createTypedArray(i,x),y.push(i.buffer);const v={data:m,isIdUnique:f,is2D:this.maxPosZ===0,indices:this.hasElements()?i:null,positionSize:s,positionBounding:[this._minX,this._minY,this._maxX,this._maxY],buffers:y,symbolIndex:this.symbolDef.index||{index:0},dynamicAttributes:this.dynamicAttrs};if(this._packMarkerPlacement&&(v.markerPlacement=this._packMarkerPlacement),this._packTextPlacement&&(v.textPlacement=this._packTextPlacement),h.getLength()){const _=c?Py(u):Ey(u);v.featureIds=Ur.createTypedArray(h,_),y.push(v.featureIds.buffer)}else v.featureIds=[];return v.pickingIdIndiceMap=pM(a,v.indices),v}_placeVector(t,e){this._visibleFn&&!this._visibleFn(this.options.zoom,t.feature.properties)||this.placeVector(t,e,this.formatWidth)}addElements(t,e,n){this.maxIndex=Math.max(this.maxIndex,t,e,n);let i=this.elements.currentIndex;this.elements[i++]=t,this.elements[i++]=e,this.elements[i++]=n,this.elements.currentIndex=i}hasElements(){return!0}getAltitude(t){const{altitudeProperty:e,defaultAltitude:n,altitudeScale:i}=this.options;let o=yd(t,e,n);return i&&(o*=i),this.maxAltitude=Math.max(this.maxAltitude,Math.abs(o)),o}getIconAtlasMaxValue(){const t=this.iconAtlas.positions;let e=0;for(const n in t)if(Tl(t,n)){const{tl:i,displaySize:o}=t[n],s=Math.max(i[0],i[1],o[0]-1,o[1]-1);s>e&&(e=s)}return e}ensureDataCapacity(t,e){const n=this._dataFormat;for(let i=0;i<n.length;i++){const o=this.data[n[i].name];if(!o)continue;const s=n[i].width*t,a=o.getLength();this.data[n[i].name]=Ur.ensureCapacity(o,a+s*e)}}};function OS(r){let t=r.positions,e=r.image&&r.image.format||"alpha";if(r instanceof gM){t={};for(const i in r.positions){const o=r.positions[i];t[i]={paddedRect:o.paddedRect,pixelRatio:o.pixelRatio,tl:o.tl,br:o.br,displaySize:o.displaySize}}e="rgba"}const n=r.image;return{image:{width:n.width,height:n.height,data:n.data,format:e},glyphMap:r.glyphMap,positions:t}}function kS(r){if(!r)return 0;let t=0;if(Array.isArray(r))for(let e=0;e<r.length;e++)if(Array.isArray(r[e])){const n=kS(r[e]);n>t&&(t=n)}else{const n=Math.abs(r[e].z||0);n>t&&(t=n)}else{const e=Math.abs(r.z||0);e>t&&(t=e)}return t}const Hu="___fn_in_stops";function IS(r,t,e,n){const i="__fn_textSize".trim();let o=r.textSize;if(tn(t.textSize))return[16,16];r[i]&&(o=r[i]);const s=[];if(s[0]=ky(o)?o(n,e):o,Ft(s[0])){const a=s[0].__fn_key=s[0].__fn_key||JSON.stringify(s[0]);r[Hu]||(r[Hu]={}),r[Hu][a]||(r[Hu][a]=le(s[0])),s[0]=(0,r[Hu][a])(n,e)}return s[1]=s[0],s}function Nu(r){const t=r.stops;let e=-1/0;for(let n=0;n<t.length;n++){let i=t[n][1];Al(t[n][1])&&(i=Nu(t[n][1])),i>e&&(e=i)}return e}function RS(r){return r||"Open Sans Regular"}const DS=/\{[\w-]+(?:\|[\w-]+)*\}/g;function ov(r,t){return Oy(r)?r.replace(DS,function(e){if(!t)return"";if((e=e.substring(1,e.length-1)).indexOf("|")>0){const i=e.split("|");for(let o=0;o<i.length;o++){const s=t[i[o]];if(!tn(s))return s}return""}const n=t[e];return tn(n)?"":Array.isArray(n)?n.join():n}):r}var PN=Object.freeze({__proto__:null,getSDFFont:RS,resolveExpVarNames:function r(t,e){if(e.length!==2||e[0]!=="get")for(let n=0;n<e.length;n++)e[n].length===2&&e[n][0]==="get"?t.push(e[n][1]):Array.isArray(e[n])&&r(t,e[n]);else t.push(e[1])},resolveText:ov,resolveVarNames:function(r){return r.match(DS)}});const re={"Latin-1 Supplement":r=>r>=128&&r<=255,Arabic:r=>r>=1536&&r<=1791,"Arabic Supplement":r=>r>=1872&&r<=1919,"Arabic Extended-A":r=>r>=2208&&r<=2303,"Hangul Jamo":r=>r>=4352&&r<=4607,"Unified Canadian Aboriginal Syllabics":r=>r>=5120&&r<=5759,Khmer:r=>r>=6016&&r<=6143,"Unified Canadian Aboriginal Syllabics Extended":r=>r>=6320&&r<=6399,"General Punctuation":r=>r>=8192&&r<=8303,"Letterlike Symbols":r=>r>=8448&&r<=8527,"Number Forms":r=>r>=8528&&r<=8591,"Miscellaneous Technical":r=>r>=8960&&r<=9215,"Control Pictures":r=>r>=9216&&r<=9279,"Optical Character Recognition":r=>r>=9280&&r<=9311,"Enclosed Alphanumerics":r=>r>=9312&&r<=9471,"Geometric Shapes":r=>r>=9632&&r<=9727,"Miscellaneous Symbols":r=>r>=9728&&r<=9983,"Miscellaneous Symbols and Arrows":r=>r>=11008&&r<=11263,"CJK Radicals Supplement":r=>r>=11904&&r<=12031,"Kangxi Radicals":r=>r>=12032&&r<=12255,"Ideographic Description Characters":r=>r>=12272&&r<=12287,"CJK Symbols and Punctuation":r=>r>=12288&&r<=12351,Hiragana:r=>r>=12352&&r<=12447,Katakana:r=>r>=12448&&r<=12543,Bopomofo:r=>r>=12544&&r<=12591,"Hangul Compatibility Jamo":r=>r>=12592&&r<=12687,Kanbun:r=>r>=12688&&r<=12703,"Bopomofo Extended":r=>r>=12704&&r<=12735,"CJK Strokes":r=>r>=12736&&r<=12783,"Katakana Phonetic Extensions":r=>r>=12784&&r<=12799,"Enclosed CJK Letters and Months":r=>r>=12800&&r<=13055,"CJK Compatibility":r=>r>=13056&&r<=13311,"CJK Unified Ideographs Extension A":r=>r>=13312&&r<=19903,"Yijing Hexagram Symbols":r=>r>=19904&&r<=19967,"CJK Unified Ideographs":r=>r>=19968&&r<=40959,"Yi Syllables":r=>r>=40960&&r<=42127,"Yi Radicals":r=>r>=42128&&r<=42191,"Hangul Jamo Extended-A":r=>r>=43360&&r<=43391,"Hangul Syllables":r=>r>=44032&&r<=55215,"Hangul Jamo Extended-B":r=>r>=55216&&r<=55295,"Private Use Area":r=>r>=57344&&r<=63743,"CJK Compatibility Ideographs":r=>r>=63744&&r<=64255,"Arabic Presentation Forms-A":r=>r>=64336&&r<=65023,"Vertical Forms":r=>r>=65040&&r<=65055,"CJK Compatibility Forms":r=>r>=65072&&r<=65103,"Small Form Variants":r=>r>=65104&&r<=65135,"Arabic Presentation Forms-B":r=>r>=65136&&r<=65279,"Halfwidth and Fullwidth Forms":r=>r>=65280&&r<=65519};function EN(r){return!re.Arabic(r)&&!re["Arabic Supplement"](r)&&!re["Arabic Extended-A"](r)&&!re["Arabic Presentation Forms-A"](r)&&!re["Arabic Presentation Forms-B"](r)}function ON(r){return!(r<11904)&&(!!re["Bopomofo Extended"](r)||!!re.Bopomofo(r)||!!re["CJK Compatibility Forms"](r)||!!re["CJK Compatibility Ideographs"](r)||!!re["CJK Compatibility"](r)||!!re["CJK Radicals Supplement"](r)||!!re["CJK Strokes"](r)||!!re["CJK Symbols and Punctuation"](r)||!!re["CJK Unified Ideographs Extension A"](r)||!!re["CJK Unified Ideographs"](r)||!!re["Enclosed CJK Letters and Months"](r)||!!re["Halfwidth and Fullwidth Forms"](r)||!!re.Hiragana(r)||!!re["Ideographic Description Characters"](r)||!!re["Kangxi Radicals"](r)||!!re["Katakana Phonetic Extensions"](r)||!!re.Katakana(r)||!!re["Vertical Forms"](r)||!!re["Yi Radicals"](r)||!!re["Yi Syllables"](r))}function Fd(r){return r===746||r===747||!(r<4352)&&(!!re["Bopomofo Extended"](r)||!!re.Bopomofo(r)||!(!re["CJK Compatibility Forms"](r)||r>=65097&&r<=65103)||!!re["CJK Compatibility Ideographs"](r)||!!re["CJK Compatibility"](r)||!!re["CJK Radicals Supplement"](r)||!!re["CJK Strokes"](r)||!(!re["CJK Symbols and Punctuation"](r)||r>=12296&&r<=12305||r>=12308&&r<=12319||r===12336)||!!re["CJK Unified Ideographs Extension A"](r)||!!re["CJK Unified Ideographs"](r)||!!re["Enclosed CJK Letters and Months"](r)||!!re["Hangul Compatibility Jamo"](r)||!!re["Hangul Jamo Extended-A"](r)||!!re["Hangul Jamo Extended-B"](r)||!!re["Hangul Jamo"](r)||!!re["Hangul Syllables"](r)||!!re.Hiragana(r)||!!re["Ideographic Description Characters"](r)||!!re.Kanbun(r)||!!re["Kangxi Radicals"](r)||!!re["Katakana Phonetic Extensions"](r)||!(!re.Katakana(r)||r===12540)||!(!re["Halfwidth and Fullwidth Forms"](r)||r===65288||r===65289||r===65293||r>=65306&&r<=65310||r===65339||r===65341||r===65343||r>=65371&&r<=65503||r===65507||r>=65512&&r<=65519)||!(!re["Small Form Variants"](r)||r>=65112&&r<=65118||r>=65123&&r<=65126)||!!re["Unified Canadian Aboriginal Syllabics"](r)||!!re["Unified Canadian Aboriginal Syllabics Extended"](r)||!!re["Vertical Forms"](r)||!!re["Yijing Hexagram Symbols"](r)||!!re["Yi Syllables"](r)||!!re["Yi Radicals"](r))}function FS(r){return!(Fd(r)||function(t){return!!(re["Latin-1 Supplement"](t)&&(t===167||t===169||t===174||t===177||t===188||t===189||t===190||t===215||t===247)||re["General Punctuation"](t)&&(t===8214||t===8224||t===8225||t===8240||t===8241||t===8251||t===8252||t===8258||t===8263||t===8264||t===8265||t===8273)||re["Letterlike Symbols"](t)||re["Number Forms"](t)||re["Miscellaneous Technical"](t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||t===9003||t>=9085&&t<=9114||t>=9150&&t<=9165||t===9167||t>=9169&&t<=9179||t>=9186&&t<=9215)||re["Control Pictures"](t)&&t!==9251||re["Optical Character Recognition"](t)||re["Enclosed Alphanumerics"](t)||re["Geometric Shapes"](t)||re["Miscellaneous Symbols"](t)&&!(t>=9754&&t<=9759)||re["Miscellaneous Symbols and Arrows"](t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||re["CJK Symbols and Punctuation"](t)||re.Katakana(t)||re["Private Use Area"](t)||re["CJK Compatibility Forms"](t)||re["Small Form Variants"](t)||re["Halfwidth and Fullwidth Forms"](t)||t===8734||t===8756||t===8757||t>=9984&&t<=10087||t>=10102&&t<=10131||t===65532||t===65533)}(r))}function LS(r){return r>=1424&&r<=2303||re["Arabic Presentation Forms-A"](r)||re["Arabic Presentation Forms-B"](r)}const kN=[[9,9],[32,32],[5760,5760],[8192,8198],[8200,8202],[8287,12288],[6158,6158],[8203,8205]];function IN(r){for(const t of kN)if(r>=t[0]&&r<=t[1])return!0;return!1}const Ld={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂"},zd={horizontal:1,vertical:2,horizontalOnly:3};function zS(r,t,e,n,i,o,s,a,l,h){let u=r.trim();h===zd.vertical&&(u=function(p){let g="";const m=Array.from(p);for(let y=0;y<m.length;y++){const x=m[y+1].codePointAt(0)||null,v=m[y-1].codePointAt(0)||null;g+=x&&FS(x)&&!Ld[m[y+1]]||v&&FS(v)&&!Ld[m[y-1]]||!Ld[m[y]]?m[y]:Ld[m[y]]}return g}(u));const c=[],f={positionedGlyphs:c,text:u,top:a[1],bottom:a[1],left:a[0],right:a[0],writingMode:h};let d;return d=function(p,g){const m=[];let y=0;for(let x=0;x<g.length;x++){const v=g[x];m.push(p.substring(y,v)),y=v}return y<p.length&&m.push(p.substring(y,p.length)),m}(u,function(p,g,m,y){if(!m)return[];if(!p)return[];const x=[],v=function(w,b,A,T){let S=0;for(let E=0;E<w.length;E++){const P=T[w.codePointAt(E)];P&&(S+=P.metrics.advance+b)}const M=Math.max(1,Math.ceil(S/A));return S/M}(p,g,m,y);let _=0;for(let w=0;w<p.length;w++){const b=p.codePointAt(w),A=y[b];A&&(A&&!RN[b]&&(_+=A.metrics.advance+g),w<p.length-1&&(DN[b]||ON(b))&&x.push(NS(w+1,_,v,x,FN(b,p.codePointAt(w+1)),!1)))}return BS(NS(p.length,_,v,x,0,!0))}(u,s,e,t)),function(p,g,m,y,x,v,_,w,b,A){let T=0,S=0,M=0;const E=p.positionedGlyphs,P=.5;for(let D=0;D<m.length;D++){let z=m[D];if(z=z.trim(),!z.length){S-=y;continue}const L=E.length;for(let $=0;$<z.length;$++){const Z=z.codePointAt($),j=g[Z];j&&(Fd(Z)&&_!==zd.horizontal?(Z!==32&&E.push({glyph:Z,x:T,y:0,vertical:!0}),T+=b+w):(Z!==32&&E.push({glyph:Z,x:T,y:S,vertical:!1}),T+=j.metrics.advance+w))}E.length!==L&&(M=Math.max(T-w,M),LN(E,g,L,E.length-1,P)),T=0,S-=y}const{horizontalAlign:k,verticalAlign:O}=jS(x,A);(function(D,z,L,$,Z,j,st){const lt=(z-L)*Z,rt=-(-$*st+.5)*j;if(!(!lt&&!rt))for(let Rt=0;Rt<D.length;Rt++)D[Rt].x+=lt,D[Rt].y+=rt})(E,P,k,O,M,y,m.length);const I=m.length*y;p.top+=-O*I,p.bottom=p.top+I,p.left+=-k*M,p.right=p.left+M}(f,t,d,n,i,0,h,s,l),!!c.length&&f}const RN={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},DN={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function HS(r,t,e,n){const i=Math.pow(r-t,2);return n?r<t?i/2:2*i:i+Math.abs(e)*e}function FN(r,t){let e=0;return r===10&&(e-=1e4),r!==40&&r!==65288||(e+=50),t!==41&&t!==65289||(e+=50),e}function NS(r,t,e,n,i,o){let s=null,a=HS(t,e,i,o);for(let l=0;l<n.length;l++){const h=n[l],u=HS(t-h.x,e,i,o)+h.badness;u<=a&&(s=h,a=u)}return{index:r,x:t,priorBreak:s,badness:a}}function BS(r){return r?BS(r.priorBreak).concat(r.index):[]}function jS(r,t){let e=.5,n=.5;switch(r){case"right":case"top-right":case"bottom-right":e=t?1:0;break;case"left":case"top-left":case"bottom-left":e=t?0:1}switch(r){case"bottom":case"bottom-right":case"bottom-left":n=t?1:0;break;case"top":case"top-right":case"top-left":n=t?0:1}return{horizontalAlign:e,verticalAlign:n}}function LN(r,t,e,n,i){const o=t[r[n].glyph];if(o){const s=(r[n].x+o.metrics.advance)*i;if(!s)return;for(let a=e;a<=n;a++)r[a].x-=s}}function VS(r){if(!function(l){for(const h of l)if(LS(h.charCodeAt(0)))return!0;return!1}(r))return r;const t=[],e=[],n=[];let i=0,o=0,s=1,a=1;for(const l of r){const h=l.codePointAt(0);IN(h)?(n.push(l),i++):(s=LS(h)?-1:1,a!==s?(o=i,e.length&&(a>0&&e.reverse(),t.push(...e)),n.length&&(t.splice(o,0,...n),n.length=0),a=s,e.length=0):n.length&&(e.push(...n),n.length=0),e.push(l),i++)}return n.length&&e.push(...n),e.length&&(a>0&&e.reverse(),t.push(...e)),t.reverse().join("")}const zN=/\{ *([\w_]+) *\}/g;let GS=class{constructor(t,e,n,i,o){this.feature=t,this.symbolDef=e,this.symbol=n,this.options=o,this._thisReplacer=this._replacer.bind(this),this._fnTypes=i}_replacer(t,e){return this.feature.properties[e]||""}getShape(t,e){if(this._shape)return this._shape;const{textHorizontalAlignmentFn:n,textVerticalAlignmentFn:i,markerHorizontalAlignmentFn:o,markerVerticalAlignmentFn:s,textWrapWidthFn:a}=this._fnTypes;let l;const h=this.symbol,u=this.getIconAndGlyph(),c=this.feature.properties;if(u&&u.glyph){const{font:f,text:d}=u.glyph;if(d==="")return null;const p=this.size[0]/24,g=24,m=h.textKeepUpright,y=h.textRotationAlignment==="map"&&h.textPlacement==="line"&&!h.isIconText,x=e.glyphMap[f],v=US(n?n(null,c):h.textHorizontalAlignment,i?i(null,c):h.textVerticalAlignment),_=1.2*g,w=function(S){for(let M=0;M<S.length;M++)if(!EN(S.charAt(M).charCodeAt(0)))return!1;return!0}(d),b=w&&h.textLetterSpacing/p||0,A=[h.textDx/p||0,h.textDy/p||0],T=((a?a(null,c):h.textWrapWidth)||10*g)/p;l={},l.horizontal=zS(d,x,T,_,v,0,b,A,g,zd.horizontal),w&&y&&m&&(l.vertical=zS(d,x,T,_,v,0,b,A,g,zd.vertical))}else if(u&&u.icon){if(!t||!t.positions[u.icon.url])return null;const f=US(o?o(null,c):h.markerHorizontalAlignment,s?s(null,c):h.markerVerticalAlignment);l=function(d,p,g){let{horizontalAlign:m,verticalAlign:y}=jS(p,g);g?m=1-m:y=1-y;const x=-2048*m,v=-2048*y;return{image:d,top:v,bottom:v+2048,left:x,right:x+2048}}(t.positions[u.icon.url],f,this.options.isVector3D),this.size||(this.size=l.image.displaySize)}return this._shape=l,l}getIconAndGlyph(){if(this.iconGlyph)return this.iconGlyph;const{markerFileFn:t,markerTypeFn:e,markerPathFn:n,markerWidthFn:i,markerHeightFn:o,markerFillFn:s,markerFillPatternFileFn:a,markerFillOpacityFn:l,markerTextFitFn:h,markerTextFitPaddingFn:u,markerLineColorFn:c,markerLineWidthFn:f,markerLineOpacityFn:d,markerLineDasharrayFn:p,markerLinePatternFileFn:g,markerPathWidthFn:m,markerPathHeightFn:y,textNameFn:x,textFaceNameFn:v}=this._fnTypes,{zoom:_}=this.options,w={},b=this.symbol,A=this.feature.properties,T=t?t(null,A):b.markerFile,S=e?e(null,A):b.markerType,M=T||S||b.markerPath,E=!tn(this.symbolDef.textName);let P;if(M){P=function(O,I,D,z,L,$){if(tn(I.markerWidth)&&tn(I.markerHeight))return null;const Z="__fn_markerWidth".trim(),j="__fn_markerHeight".trim();let st=I.markerWidth||0,lt=I.markerHeight||0;return Al(st)&&(st.type!=="identity"?st=Nu(st):(st=O.markerWidth,O[Z]&&(st=O[Z](z,D)),Al(st)&&(st=st.type==="identity"?L(z,D):Nu(st)))),Al(lt)&&(lt.type!=="identity"?lt=Nu(lt):(lt=O.markerHeight,O[j]&&(lt=O[j](z,D)),Al(lt)&&(lt=lt.type==="identity"?$(z,D):Nu(lt)))),[st,lt]}(b,this.symbolDef,A,_,i,o)||[0,0];let k=b.markerTextFit;if(h&&(k=h(_,A)),k&&b.text&&k!=="none"){const O=b.text.textSize;let I=b.text.textName;Ft(I)&&(I=le(I)(_,A));const D=ov(I,A);if(D){const z="__fn_textSize".trim(),L="__fn_textSize_0".trim();Ft(O)&&!b.text[z]&&(b.text[L]=le(O),b.text[z]=(Z,j)=>{const st=b.text[L](Z,j);return Ft(st)?le(st)(Z,j):st});const $=IS(b.text,b.text,A,_);if(k!=="width"&&k!=="both"||(P[0]=$[0]*D.length),k!=="height"&&k!=="both"||(P[1]=$[1]),$[0]&&$[1]){let Z=b.markerTextFitPadding||[0,0,0,0];u&&(Z=u(_,A)),P[0]+=Z[1]+Z[3],P[1]+=Z[0]+Z[2]}}else P[0]=P[1]=-1}}if(E&&(P=IS(b,this.symbolDef,A,_)),!P)return w;if(P[0]=Math.ceil(P[0]),P[1]=Math.ceil(P[1]),this.size=P,M&&P[0]>=0&&P[1]>=0){let k;if(S){const O={};if(O.markerType=S,S==="path"&&(O.markerPath=n?n(null,A):b.markerPath,O.markerPathWidth=m?m(null,A):b.markerPathWidth,O.markerPathHeight=y?y(null,A):b.markerPathHeight),i){const I=i(null,A);tn(I)||(O.markerWidth=I)}else b.markerWidth>=0&&(O.markerWidth=b.markerWidth);if(o){const I=o(null,A);tn(I)||(O.markerHeight=I)}else b.markerHeight>=0&&(O.markerHeight=b.markerHeight);if(s){const I=s(null,A);tn(I)||(O.markerFill=I)}else b.markerFill&&(O.markerFill=b.markerFill);if(a){const I=a(null,A);tn(I)||(O.markerFillPatternFile=I)}else b.markerFillPatternFile&&(O.markerFillPatternFile=b.markerFillPatternFile);if(l){const I=l(null,A);tn(I)||(O.markerFillOpacity=I)}else b.markerFillOpacity>=0&&(O.markerFillOpacity=b.markerFillOpacity);if(c){const I=c(null,A);tn(I)||(O.markerLineColor=I)}else b.markerLineColor&&(O.markerLineColor=b.markerLineColor);if(f){const I=f(null,A);tn(I)||(O.markerLineWidth=I)}else b.markerLineWidth>=0&&(O.markerLineWidth=b.markerLineWidth);if(d){const I=d(null,A);tn(I)||(O.markerLineOpacity=I)}else b.markerLineOpacity>=0&&(O.markerLineOpacity=b.markerLineOpacity);if(p){const I=p(null,A);tn(I)||(O.markerLineDasharray=I)}else b.markerLineDasharray&&(O.markerLineDasharray=b.markerLineDasharray);if(g){const I=g(null,A);tn(I)||(O.markerLinePatternFile=I)}else b.markerLinePatternFile&&(O.markerLinePatternFile=b.markerLinePatternFile);k="vector://"+JSON.stringify(O)}else k=T?T.replace(zN,this._thisReplacer):b.markerPath?function(O,I,D){if(!O.markerPath)return null;let z=1;const L=function(rt){const Rt={stroke:{stroke:rt.markerLineColor,"stroke-width":rt.markerLineWidth,"stroke-opacity":rt.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:rt.markerFill,"fill-opacity":rt.markerFillOpacity}};return Rt.stroke["stroke-width"]===0&&(Rt.stroke["stroke-opacity"]=0),Rt}(O);ys(O.markerOpacity)&&(z=O.markerOpacity),ys(O.opacity)&&(z*=O.opacity);const $={};if(L){for(const rt in L.stroke)Tl(L.stroke,rt)&&(tn(L.stroke[rt])||($[rt]=L.stroke[rt]));for(const rt in L.fill)Tl(L.fill,rt)&&(tn(L.fill[rt])||($[rt]=L.fill[rt]))}const Z=Array.isArray(O.markerPath)?O.markerPath:[O.markerPath];let j;const st=[];for(let rt=0;rt<Z.length;rt++)j=Oy(Z[rt])?{path:Z[rt]}:Z[rt],j=wl({},j,$),j.d=j.path,delete j.path,st.push(j);const lt=['<svg version="1.1"','xmlns="http://www.w3.org/2000/svg"'];z<1&&lt.push('opacity="'+z+'"'),O.markerPathWidth&&O.markerPathHeight&&lt.push('viewBox="0 0 '+O.markerPathWidth+" "+O.markerPathHeight+'"'),lt.push('preserveAspectRatio="none"'),I&&lt.push('width="'+I+'"'),D&&lt.push('height="'+D+'"'),lt.push("><defs></defs>");for(let rt=0;rt<st.length;rt++){let Rt="<path ";for(const Ht in st[rt])Tl(st[rt],Ht)&&(Rt+=" "+Ht+'="'+st[rt][Ht]+'"');Rt+="></path>",lt.push(Rt)}return lt.push("</svg>"),"data:image/svg+xml;base64,"+btoa(lt.join(" "))}(b,P[0],P[1]):null;w.icon={url:k,size:P}}if(E){const k=x?x(this.options.zoom,A):b.textName;if(k||k===0){const O=RS(v?v(null,A):b.textFaceName);let I=ov(k,A);I&&I.length&&(I=VS(I),w.glyph={font:O,text:I})}}return this.iconGlyph=w,w}};function US(r,t){t&&t!=="middle"||(t="center"),r&&r!=="middle"||(r="center");let e=t!=="center"?t:"";return e+=r!=="center"?(e.length?"-":"")+r:"",e}/*!
 * From mapbox-gl-js
 * MIT License
 * https://github.com/mapbox/mapbox-gl-js
 */function $S(r,t,e,n,i){const o=[];let s;for(let a=0;a<r.length;a++){const l=r[a];let h,u=!1;for(let c=0;c<l.length-1;c++){let f=l[c],d=l[c+1];f.x<t&&d.x<t||(f.x<t?(s=f,f=new sn(t,f.y+(t-f.x)/(d.x-f.x)*(d.y-f.y))._round(),f.z=s.z+(t-s.x)/(d.x-s.x)*(d.z-s.z),u=!0):d.x<t&&(s=d,d=new sn(t,f.y+(t-f.x)/(d.x-f.x)*(d.y-f.y))._round(),d.z=f.z+(t-f.x)/(s.x-f.x)*(s.z-f.z),u=!0),f.y<e&&d.y<e||(f.y<e?(s=f,f=new sn(f.x+(e-f.y)/(d.y-f.y)*(d.x-f.x),e)._round(),f.z=s.z+(e-s.y)/(d.y-s.y)*(d.z-s.z),u=!0):d.y<e&&(s=d,d=new sn(f.x+(e-f.y)/(d.y-f.y)*(d.x-f.x),e)._round(),d.z=f.z+(e-f.y)/(s.y-f.y)*(s.z-f.z),u=!0),f.x>=n&&d.x>=n||(f.x>=n?(s=f,f=new sn(n,f.y+(n-f.x)/(d.x-f.x)*(d.y-f.y))._round(),f.z=s.z+(n-s.x)/(d.x-s.x)*(d.z-s.z),u=!0):d.x>=n&&(s=d,d=new sn(n,f.y+(n-f.x)/(d.x-f.x)*(d.y-f.y))._round(),d.z=f.z+(n-f.x)/(s.x-f.x)*(s.z-f.z),u=!0),f.y>=i&&d.y>=i||(f.y>=i?(s=f,f=new sn(f.x+(i-f.y)/(d.y-f.y)*(d.x-f.x),i)._round(),f.z=s.z+(i-s.y)/(d.y-s.y)*(d.z-s.z),u=!0):d.y>=i&&(s=d,d=new sn(f.x+(i-f.y)/(d.y-f.y)*(d.x-f.x),i)._round(),d.z=f.z+(i-f.y)/(s.y-f.y)*(s.z-f.z),u=!0),h&&f.equals(h[h.length-1])||(h=[f],o.push(h)),u&&(h.clipped=!0),h.push(d)))))}}return o}let HN=class $3 extends sn{constructor(t,e,n,i){super(t,e),this.angle=n,i!==void 0&&(this.segment=i)}clone(){return new $3(this.x,this.y,this.angle,this.segment)}};/*!
 * From mapbox-gl-js
 * MIT License
 * https://github.com/mapbox/mapbox-gl-js
 */function NN(r,t,e,n,i){if(t.segment===void 0)return!0;let o=t,s=t.segment+1,a=0;for(;a>-e/2;){if(s--,s<0)return!1;a-=r[s].dist(o),o=r[s]}a+=r[s].dist(r[s+1]),s++;const l=[];let h=0;for(;a<e/2;){const u=r[s],c=r[s+1];if(!c)return!1;let f=r[s-1].angleTo(u)-u.angleTo(c);for(f=Math.abs((f+3*Math.PI)%(2*Math.PI)-Math.PI),l.push({distance:a,angleDelta:f}),h+=f;a-l[0].distance>n;)h-=l.shift().angleDelta;if(h>i)return!1;s++,a+=u.dist(c)}return!0}function BN(r,t,e,n,i,o,s,a,l,h,u){const c=function(p,g,m){return p?.6*g*m:0}(n,o,s),f=function(p,g){return Math.max(p?p.right-p.left:0,0)}(n),d=r[0].x===0||r[0].x===l||r[0].y===0||r[0].y===l;return t-f*s<t/4&&(t=f*s+t/4),WS(r,d?t/2*a%t:(f/2+2*o)*s*a%t,t,c,e,f*s,d,!1,l,h,u)}function WS(r,t,e,n,i,o,s,a,l,h,u){let c=0;const f=o/2,d=function(y){let x=0;for(let v=0;v<y.length-1;v++)x+=y[v].dist(y[v+1]);return x}(r);let p=0,g=t-e,m=[];for(let y=0;y<r.length-1;y++){const x=r[y],v=r[y+1],_=x.dist(v),w=v.angleTo(x);for(;g+e<p+_;){g+=e;const b=(g-p)/_,A=sv(x.x,v.x,b),T=sv(x.y,v.y,b),S=sv(x.z||0,v.z||0,b);if(A>=0&&A<l&&T>=0&&T<l&&g-f>=0&&g+f<=d){const M=new HN(A,T,w,y);M.z=S,h&&(M.axis=[x.y-T,A-x.x],M.angleR=S===(x.z||0)?0:Math.atan(.9*(S-(x.z||0))*u/x.dist(M))),M.line=r,M._round(),!n||NN(r,M,o,n,i)?m.push(M):n&&c++}}p+=_}return a||m.length||s||(m=WS(r,p/2,e,n,i,o,s,!0,l,h,u)),m.countOutOfAngle=c,m}function sv(r,t,e){return r*(1-e)+t*e}function ZS(r,t){const e=r.length;if(e<=1)return[r];const n=[];let i,o;for(let s=0;s<e;s++){const a=cM(r[s]);a!==0&&(r[s].area=Math.abs(a),o===void 0&&(o=a<0),o===a<0?(i&&n.push(i),i=[r[s]]):i.push(r[s]))}if(i&&n.push(i),t>1)for(let s=0;s<n.length;s++)n[s].length<=t||(cH(n[s],t,1,n[s].length-1,jN),n[s]=n[s].slice(0,t));return n}function jN(r,t){return t.area-r.area}function VN(r,t,e){const n=t.distSqr(e);if(n===0)return r.distSqr(t);const i=((r.x-t.x)*(e.x-t.x)+(r.y-t.y)*(e.y-t.y))/n;return r.distSqr(i<0?t:i>1?e:e.sub(t)._mult(i)._add(t))}function GN(r,t=1,e=!1){let n=1/0,i=1/0,o=-1/0,s=-1/0;const a=r[0];for(let d=0;d<a.length;d++){const p=a[d];(!d||p.x<n)&&(n=p.x),(!d||p.y<i)&&(i=p.y),(!d||p.x>o)&&(o=p.x),(!d||p.y>s)&&(s=p.y)}const l=Math.min(o-n,s-i);let h=l/2;const u=new fH([],UN);if(l===0)return new sn(n,i);for(let d=n;d<o;d+=l)for(let p=i;p<s;p+=l)u.push(new Dl(d+h,p+h,h,r));let c=function(d){let p=0,g=0,m=0;const y=d[0];for(let x=0,v=y.length,_=v-1;x<v;_=x++){const w=y[x],b=y[_],A=w.x*b.y-b.x*w.y;g+=(w.x+b.x)*A,m+=(w.y+b.y)*A,p+=3*A}return new Dl(g/p,m/p,0,d)}(r),f=u.length;for(;u.length;){const d=u.pop();(d.d>c.d||!c.d)&&(c=d,e&&console.log("found best %d after %d probes",Math.round(1e4*d.d)/1e4,f)),d.max-c.d<=t||(h=d.h/2,u.push(new Dl(d.p.x-h,d.p.y-h,h,r)),u.push(new Dl(d.p.x+h,d.p.y-h,h,r)),u.push(new Dl(d.p.x-h,d.p.y+h,h,r)),u.push(new Dl(d.p.x+h,d.p.y+h,h,r)),f+=4)}return e&&(console.log(`num probes: ${f}`),console.log(`best distance: ${c.d}`)),c.p}function UN(r,t){return t.max-r.max}function Dl(r,t,e,n){this.p=new sn(r,t),this.h=e,this.d=function(i,o){let s=!1,a=1/0;for(let l=0;l<o.length;l++){const h=o[l];for(let u=0,c=h.length,f=c-1;u<c;f=u++){const d=h[u],p=h[f];d.y>i.y!=p.y>i.y&&i.x<(p.x-d.x)*(i.y-d.y)/(p.y-d.y)+d.x&&(s=!s),a=Math.min(a,VN(i,d,p))}}return(s?1:-1)*Math.sqrt(a)}(this.p,n),this.max=this.d+this.h*Math.SQRT2}function $N(r,t,e,n,i,o,s,a,l,h){const{feature:u,size:c,symbol:f}=r,d=c?24:0,p=i*(c?c[0]/d:1);if(s==="line"){const g=[];g.countOutOfAngle=0;let m=u.geometry;o&&(m=$S(u.geometry,0,0,o,o));for(let y=0;y<m.length;y++){const x=BN(m[y],a,e,f.isIconText?null:n&&n.vertical||n&&n.horizontal||n,0,d,f.isIconText?1:p,1,o||1/0,l,h);if(f.textPlacement&&!f.isIconText)for(let v=0;v<x.length;v++)x[v].startIndex=t.length/3;if(g.push.apply(g,x),f.textPlacement&&!f.isIconText)for(let v=0;v<m[y].length;v++)t.push(m[y][v].x,m[y][v].y,m[y][v].z||0);g.countOutOfAngle+=x.countOutOfAngle||0}return g}return WN(u,s,o)}function WN(r,t,e,n,i){const o=[];if(r.type===3){const s=ZS(r.geometry,0);for(let a=0;a<s.length;a++){const l=s[a];if(t==="vertex")for(let h=0;h<l.length;h++){const u=l[h];for(let c=0;c<u.length;c++)Zi(u[c],e)||o.push(u[c])}else if(t==="vertex-first"){const h=l[0];h&&h[0]&&!Zi(h[0],e)&&o.push(h[0])}else if(t==="vertex-last"||t==="vertex-firstlast"){const h=l[0];if(t==="vertex-firstlast"&&h&&h[0]&&!Zi(h[0],e)&&o.push(h[0]),h&&h[h.length-1]&&!Zi(h[h.length-1],e)){const u=h.length-1;o.push(h[u])}}else{const h=GN(l,16);Zi(h,e)||o.push(h)}}}else if(r.type===2)for(let s=0;s<r.geometry.length;s++){const a=r.geometry[s];if(t==="vertex")for(let l=0;l<a.length;l++)Zi(a[l],e)||o.push(a[l]);else if(t==="vertex-last"||t==="vertex-firstlast"){if(t!=="vertex-firstlast"||Zi(a[0],e)||o.push(a[0]),a&&a[a.length-1]&&!Zi(a[a.length-1],e)){const l=a.length-1;o.push(a[l])}}else Zi(a[0],e)||o.push(a[0])}else if(r.type===1)for(let s=0;s<r.geometry.length;s++){const a=r.geometry[s];for(let l=0;l<a.length;l++){const h=a[l];Zi(h,e)||o.push(h)}}return o}function ZN(r,t){const e={},n={},i=[];let o=0;function s(u){i.push(r[u]),o++}function a(u,c,f){const d=n[u];return delete n[u],n[c]=d,i[d].geometry[0].pop(),i[d].geometry[0]=i[d].geometry[0].concat(f[0]),d}function l(u,c,f){const d=e[c];return delete e[c],e[u]=d,i[d].geometry[0].shift(),i[d].geometry[0]=f[0].concat(i[d].geometry[0]),d}function h(u,c,f){const d=f?c[0][c[0].length-1]:c[0][0];return`${u}:${d.x}:${d.y}`}for(let u=0;u<r.length;u++){const c=r[u],f=c.geometry;if(!f)continue;const d=c.properties[t]?c.properties[t].toString():null;if(!d){s(u);continue}const p=h(d,f),g=h(d,f,!0);if(p in n&&g in e&&n[p]!==e[g]){const m=l(p,g,f),y=a(p,g,i[m].geometry);delete e[p],delete n[g],n[h(d,i[y].geometry,!0)]=y,i[m].geometry=null}else p in n?a(p,g,f):g in e?l(p,g,f):(s(u),e[p]=o-1,n[g]=o-1)}return i.filter(u=>u.geometry)}const XS="__index";function YS(r,t,e,n){const i=(XS+"").trim(),o=function(s,a,l,h){const u=(XS+"").trim(),{mergeOnPropertyFn:c}=l;if(!a.mergeOnProperty)return[];if(f=a.mergeOnProperty,!bl(f)&&(typeof f=="string"||f.constructor!==null&&f.constructor===String))return[{features:s,property:a.mergeOnProperty}];var f;const d=[],p={},g=[];for(let m=0;m<s.length;m++){s[m][u]=m;const y=s[m].properties=s[m].properties||{};y.$layer=s[m].layer,y.$type=s[m].type;const x=c?c(h,y):a.mergeOnProperty;bl(x)?g.push(s[m]):(p[x]===void 0&&(p[x]=d.length,d.push({features:[],property:x})),d[p[x]].features.push(s[m]))}return g.length&&d.push({features:g}),d}(r,t,e,n);if(o.length){const s=[];for(let a=0;a<o.length;a++)s.push(o[a].property?ZN(o[a].features,o[a].property):r);if(s.length===1)return s[0];{let a=[];for(let l=0;l<s.length;l++)a=a.concat(s[l]);return a.sort((l,h)=>l[i]-h[i]),a}}return[]}const XN=14;let av=class W3 extends la{static needMerge(t,e,n){if(!t)return!1;let i=t.textPlacement==="line"||t.markerPlacement==="line";return i||(e.textPlacementFn&&(i=e.textPlacementFn(n)==="line"),e.markerPlacementFn&&(i=e.markerPlacementFn(n)==="line")),t.mergeOnProperty&&i}static mergeLineFeatures(t,e,n,i){let o=e.textPlacement,s=e.markerPlacement;return n.textPlacementFn&&(o=n.textPlacementFn(i)),n.markerPlacementFn&&(s=n.markerPlacementFn(i)),o!=="line"&&s!=="line"?t:YS(t,e,n,i)}static splitPointSymbol(t,e=0){const n=[];if(Array.isArray(t)){const s=t;for(let a=0;a<s.length;a++)s[a]&&n.push(...W3.splitPointSymbol(s[a],a));return n}let i=null,o=null;for(const s in t)s.indexOf("marker")===0?(i=i||{},i[s]=t[s]):s.indexOf("text")===0&&(o=o||{},o[s]=t[s]);return i&&(i.isIconText=!0,t.mergeOnProperty&&(i.mergeOnProperty=t.mergeOnProperty),n.push(i)),o&&(i&&(o.textPlacement=i.markerPlacement,o.textSpacing=i.markerSpacing,o.isIconText=!0),t.mergeOnProperty&&(o.mergeOnProperty=t.mergeOnProperty),n.push(o)),t.visible!==void 0&&(i&&(i.visible=t.visible),o&&(o.visible=t.visible)),i&&(i.markerTextFit&&o&&(i.text={},i.text.textName=o.textName,i.text.textSize=o.textSize),i.index={index:e,type:0}),o&&(o.index={index:e,type:1}),n}static isAtlasLoaded(t,e){const{icon:n,glyph:i}=t,{iconAtlas:o,glyphAtlas:s}=e;if(n&&(!o||!o.positions[n.url]))return!1;if(i){if(!s||!s.positions[i.font])return!1;const a=s.positions[i.font],{text:l}=i;for(const h of l)if(!a[h.codePointAt(0)])return!1}return!0}constructor(t,e,n){super(t,e,n),this._textPlacement=e.textPlacement,this._fnTypes.textPlacementFn&&(this._textPlacement=this._fnTypes.textPlacementFn(this.options.zoom))}createStyledVector(t,e,n,i,o,s){const a=new GS(t,this.symbolDef,e,n,i),l=a.getIconAndGlyph();if(l.icon&&!this.options.atlas){const{url:h,size:u}=l.icon;o[h]||(o[h]=l.icon.size),o[h][0]<u[0]&&(o[h][0]=u[0]),o[h][1]<u[1]&&(o[h][1]=u[1])}if(l.glyph&&!this.options.atlas){const{font:h,text:u}=l.glyph,c=s[h]=s[h]||{};for(const f of u)c[f.codePointAt(0)]=1;this._textPlacement==="line"&&(s.options={isCharsCompact:!1})}return this.options.allowEmptyPack||l.icon||l.glyph?a:null}getFormat(t){const e=t.textName!==void 0,n=e?this.getPackSDFFormat(t):this.getPackMarkerFormat();e?n.push(...this._getTextFnTypeFormats()):n.push(...this._getMarkerFnTypeFormats());const{markerOpacityFn:i,textOpacityFn:o,markerPitchAlignmentFn:s,textPitchAlignmentFn:a,markerRotationAlignmentFn:l,textRotationAlignmentFn:h,markerRotationFn:u,textRotationFn:c,markerAllowOverlapFn:f,textAllowOverlapFn:d,markerIgnorePlacementFn:p,textIgnorePlacementFn:g}=this._fnTypes;return(i||o)&&n.push({type:Uint8Array,width:1,name:"aColorOpacity"}),(s||a)&&n.push({type:Uint8Array,width:1,name:"aPitchAlign"}),(l||h)&&n.push({type:Uint8Array,width:1,name:"aRotationAlign"}),(u||c)&&n.push({type:Uint16Array,width:1,name:"aRotation"}),(f||d||p||g)&&n.push({type:Uint8Array,width:1,name:"aOverlap"}),n}_is3DPitchText(){return this.hasMapPitchAlign}_getTextFnTypeFormats(){const{textFillFn:t,textSizeFn:e,textHaloFillFn:n,textHaloRadiusFn:i,textHaloOpacityFn:o,textDxFn:s,textDyFn:a}=this._fnTypes,l=[];return t&&l.push({type:Uint8Array,width:4,name:"aTextFill"}),e&&l.push({type:Uint8Array,width:1,name:"aTextSize"}),n&&l.push({type:Uint8Array,width:4,name:"aTextHaloFill"}),i&&l.push({type:Uint8Array,width:1,name:"aTextHaloRadius"}),o&&l.push({type:Uint8Array,width:1,name:"aTextHaloOpacity"}),s&&l.push({type:Int8Array,width:1,name:"aTextDx"}),a&&l.push({type:Int8Array,width:1,name:"aTextDy"}),l}_getMarkerFnTypeFormats(){const{markerWidthFn:t,markerHeightFn:e,markerDxFn:n,markerDyFn:i}=this._fnTypes,o=[];return t&&o.push({type:this.options.markerWidthType||Uint8Array,width:1,name:"aMarkerWidth"}),e&&o.push({type:this.options.markerHeightType||Uint8Array,width:1,name:"aMarkerHeight"}),n&&o.push({type:Int8Array,width:1,name:"aMarkerDx"}),i&&o.push({type:Int8Array,width:1,name:"aMarkerDy"}),o}createDataPack(){if(!this.iconAtlas&&!this.glyphAtlas){if(!this.options.allowEmptyPack)return null;this.empty=!0}this.countOutOfAngle=0,this.lineVertex=[];const t=super.createDataPack.apply(this,arguments);return t?(t.lineVertex=new Int16Array(this.lineVertex),t.buffers.push(t.lineVertex.buffer),t):null}placeVector(t,e){const n=t.getShape(this.iconAtlas,this.glyphAtlas);if(!this.options.allowEmptyPack&&(!n||!n.image)&&(!n||!n.horizontal&&!n.vertical))return;const i=this._getAnchors(t,n,e);if(this.countOutOfAngle+=i.countOutOfAngle||0,i.length===0)return;const o=this.data,s=this.needAltitudeAttribute()?2:3;let a=this.data.aPosition.getLength()/s;const l=t.symbol,h=t.feature.properties,u=this._textPlacement==="line"&&!l.isIconText,c=l.textName!==void 0,f=c&&u&&function(hn){let we=0;for(let Ze=0;Ze<hn.length;Ze++)if(Fd(hn.charAt(Ze).charCodeAt(0)))we=0;else if(we++,we>=1)return!1;return!0}(t.getIconAndGlyph().glyph.text)?1:0,{textFillFn:d,textSizeFn:p,textHaloFillFn:g,textHaloRadiusFn:m,textHaloOpacityFn:y,textDxFn:x,textDyFn:v,textPitchAlignmentFn:_,textRotationAlignmentFn:w,textRotationFn:b,textAllowOverlapFn:A,textIgnorePlacementFn:T,textOpacityFn:S,markerWidthFn:M,markerHeightFn:E,markerDxFn:P,markerDyFn:k,markerPitchAlignmentFn:O,markerRotationAlignmentFn:I,markerRotationFn:D,markerAllowOverlapFn:z,markerIgnorePlacementFn:L,markerOpacityFn:$}=this._fnTypes;let Z,j,st,lt,rt,Rt,Ht,ee,nt,Dt,Vt,Ct,_e,Ie,Jt,Ne,ce;if(c){const hn=t.getIconAndGlyph().glyph.font;Z=function(we,Ze,yn){const rn=we.positionedGlyphs,vr=[];for(let ii=0;ii<rn.length;ii++){const Jn=rn[ii],Mn=yn[Jn.glyph];if(!Mn)continue;const Dn=Mn.rect;if(!Dn)continue;const Zr=4,Xr=Mn.metrics.advance/2,Vn=Mn.metrics.height/2,Yr=Ze?[Jn.x+Xr,0]:[0,0],Ji=Ze?[0,Jn.y-Vn]:[Jn.x+Xr,Jn.y-Vn],xr=Mn.metrics.left-Zr-Xr+Ji[0],rr=Mn.metrics.top-Zr+Ji[1],Sn=xr+Dn.w,On=rr+Dn.h,Wo=new sn(xr,rr),Zo=new sn(Sn,rr),vo=new sn(xr,On),Hr=new sn(Sn,On);if(Ze&&Jn.vertical){const xo=new sn(-Xr,Xr),oi=-Math.PI/2,Pr=new sn(5,0);Wo._rotateAround(oi,xo)._add(Pr),Zo._rotateAround(oi,xo)._add(Pr),vo._rotateAround(oi,xo)._add(Pr),Hr._rotateAround(oi,xo)._add(Pr)}vr.push({tl:Wo,tr:Zo,bl:vo,br:Hr,tex:Dn,writingMode:we.writingMode,glyphOffset:Yr})}return vr}(n.horizontal,u,this.glyphAtlas.positions[hn]),d&&(j=d(null,h),Ft(j)?(this.dynamicAttrs.aTextFill=1,j=[0,0,0,0]):j=ia([],j)),p&&(st=p(this.options.zoom,h),bl(st)&&(st=XN)),g&&(lt=g(null,h),Ft(lt)?(this.dynamicAttrs.aTextHaloFill=1,lt=[0,0,0,0]):lt=ia([],lt)),m&&(rt=m(null,h)),y&&(Rt=255*y(null,h)),x&&(Ht=x(null,h)||0),v&&(ee=v(null,h)||0),_&&(_e=+(_(null,h)==="map")),w&&(Ie=+(w(null,h)==="map")),b&&(Jt=dM(b(null,h),0,360)*Math.PI/180)}else Z=n?function(hn){const we=hn.image,Ze=hn.top-1/we.pixelRatio,yn=hn.left-1/we.pixelRatio,rn=hn.bottom+1/we.pixelRatio,vr=hn.right+1/we.pixelRatio;let ii,Jn,Mn,Dn;return ii=new sn(yn,Ze),Jn=new sn(vr,Ze),Mn=new sn(vr,rn),Dn=new sn(yn,rn),[{tl:ii,tr:Jn,bl:Dn,br:Mn,tex:{x:we.tl[0],y:we.tl[1],w:we.displaySize[0],h:we.displaySize[1]},writingMode:void 0,glyphOffset:[0,0]}]}(n):function(){const hn=new sn(0,0),we=new sn(0,0),Ze=new sn(0,0);return[{tl:hn,tr:we,bl:new sn(0,0),br:Ze,tex:{x:0,y:0,w:0,h:0},writingMode:void 0,glyphOffset:[0,0]}]}(),M&&(nt=M(null,h)),bl(nt)&&(nt=Z[0].tex.w),E&&(Dt=E(null,h)),bl(Dt)&&(Dt=Z[0].tex.h),P&&(Vt=P(null,h)),k&&(Ct=k(null,h)),O&&(_e=+(O(null,h)==="map")),I&&(Ie=+(I(null,h)==="map")),D&&(Jt=dM(D(null,h),0,360)*Math.PI/180);Ft(st)&&(this.dynamicAttrs.aTextSize=1),Ft(rt)&&(this.dynamicAttrs.aTextHaloRadius=1),Ft(Rt)&&(this.dynamicAttrs.aTextHaloOpacity=1),Ft(Ht)&&(this.dynamicAttrs.aTextDx=1),Ft(ee)&&(this.dynamicAttrs.aTextDy=1),Ft(nt)&&(this.dynamicAttrs.aMarkerWidth=1),Ft(Dt)&&(this.dynamicAttrs.aMarkerHeight=1),Ft(Vt)&&(this.dynamicAttrs.aMarkerDx=1),Ft(Ct)&&(this.dynamicAttrs.aMarkerDy=1),Ft(_e)&&(this.dynamicAttrs.aPitchAlign=1),Ft(Ie)&&(this.dynamicAttrs.aRotationAlign=1),Ft(Jt)&&(this.dynamicAttrs.aRotation=1);const ke=z||A;ke&&(Ne=ke(null,h)||0);const qe=L||T;let Re;qe&&(ce=qe(null,h)||0);const Je=S||$;Je&&(Re=255*Je(this.options.zoom,h));const Le=Z.length;this.ensureDataCapacity(4*Le,i.length);const pn=this.options.EXTENT,{altitudeScale:Tn,altitudeProperty:nr,defaultAltitude:ln}=this.options,{altitude:qn}=fM(t.feature,Tn,nr,ln);for(let hn=0;hn<i.length;hn++){const we=i[hn],Ze=we.z||qn||0;if(pn!==1/0&&Zi(we,pn))continue;const yn=we.x,rn=we.y,vr=Z.length;for(let ii=0;ii<vr;ii++){const Jn=Z[ii],{tl:Mn,tr:Dn,bl:Zr,br:Xr,tex:Vn}=Jn;this._fillPos(o,yn,rn,Ze,10*Mn.x,10*Mn.y,Vn.x,Vn.y+Vn.h),c&&this._fillData(o,u,Le,Jn.glyphOffset,we,f,we.axis,we.angleR),this._fillFnTypeData(o,j,st,lt,rt,Rt,Ht,ee,nt,Dt,Vt,Ct,Re,_e,Ie,Jt,Ne,ce),this._fillPos(o,yn,rn,Ze,10*Dn.x,10*Dn.y,Vn.x+Vn.w,Vn.y+Vn.h),c&&this._fillData(o,u,Le,Jn.glyphOffset,we,f,we.axis,we.angleR),this._fillFnTypeData(o,j,st,lt,rt,Rt,Ht,ee,nt,Dt,Vt,Ct,Re,_e,Ie,Jt,Ne,ce),this._fillPos(o,yn,rn,Ze,10*Zr.x,10*Zr.y,Vn.x,Vn.y),c&&this._fillData(o,u,Le,Jn.glyphOffset,we,f,we.axis,we.angleR),this._fillFnTypeData(o,j,st,lt,rt,Rt,Ht,ee,nt,Dt,Vt,Ct,Re,_e,Ie,Jt,Ne,ce),this._fillPos(o,yn,rn,Ze,10*Xr.x,10*Xr.y,Vn.x+Vn.w,Vn.y),c&&this._fillData(o,u,Le,Jn.glyphOffset,we,f,we.axis,we.angleR),this._fillFnTypeData(o,j,st,lt,rt,Rt,Ht,ee,nt,Dt,Vt,Ct,Re,_e,Ie,Jt,Ne,ce),this.addElements(a,a+1,a+2),this.addElements(a+1,a+2,a+3),a+=4;const Yr=Math.max(Math.abs(yn),Math.abs(rn),Math.abs(Ze));Yr>this.maxPos&&(this.maxPos=Yr)}}}_fillPos(t,e,n,i,o,s,a,l){this.fillPosition(t,e,n,i);let h=t.aShape.currentIndex;t.aShape[h++]=o,t.aShape[h++]=s,t.aShape.currentIndex=h,h=t.aTexCoord.currentIndex,t.aTexCoord[h++]=a,t.aTexCoord[h++]=l,t.aTexCoord.currentIndex=h}_fillData(t,e,n,i,o,s,a,l){let h=t.aCount.currentIndex;if(t.aCount[h++]=n,t.aCount.currentIndex=h,e){h=t.aGlyphOffset.currentIndex,t.aGlyphOffset[h++]=i[0],t.aGlyphOffset[h++]=i[1],t.aGlyphOffset.currentIndex=h,this._is3DPitchText()&&(h=t.aPitchRotation.currentIndex,t.aPitchRotation[h++]=a[0],t.aPitchRotation[h++]=a[1],t.aPitchRotation[h++]=l,t.aPitchRotation.currentIndex=h);const u=o.startIndex;h=t.aSegment.currentIndex,t.aSegment[h++]=o.segment+u,t.aSegment[h++]=u,t.aSegment[h++]=o.line.length,t.aSegment.currentIndex=h,h=t.aVertical.currentIndex,t.aVertical[h++]=s,t.aVertical.currentIndex=h}}_fillFnTypeData(t,e,n,i,o,s,a,l,h,u,c,f,d,p,g,m,y,x){const{textFillFn:v,textSizeFn:_,textHaloFillFn:w,textHaloRadiusFn:b,textHaloOpacityFn:A,textDxFn:T,textDyFn:S,textPitchAlignmentFn:M,textRotationAlignmentFn:E,textRotationFn:P,textAllowOverlapFn:k,textIgnorePlacementFn:O,textOpacityFn:I,markerWidthFn:D,markerHeightFn:z,markerDxFn:L,markerDyFn:$,markerPitchAlignmentFn:Z,markerRotationAlignmentFn:j,markerRotationFn:st,markerAllowOverlapFn:lt,markerIgnorePlacementFn:rt,markerOpacityFn:Rt}=this._fnTypes;if(v){let nt=t.aTextFill.currentIndex;t.aTextFill[nt++]=e[0],t.aTextFill[nt++]=e[1],t.aTextFill[nt++]=e[2],t.aTextFill[nt++]=e[3],t.aTextFill.currentIndex=nt}if(_){let nt=t.aTextSize.currentIndex;t.aTextSize[nt++]=n,t.aTextSize.currentIndex=nt}if(w){let nt=t.aTextHaloFill.currentIndex;t.aTextHaloFill[nt++]=i[0],t.aTextHaloFill[nt++]=i[1],t.aTextHaloFill[nt++]=i[2],t.aTextHaloFill[nt++]=i[3],t.aTextHaloFill.currentIndex=nt}if(b){let nt=t.aTextHaloRadius.currentIndex;t.aTextHaloRadius[nt++]=o,t.aTextHaloRadius.currentIndex=nt}if(A){let nt=t.aTextHaloOpacity.currentIndex;t.aTextHaloOpacity[nt++]=s,t.aTextHaloOpacity.currentIndex=nt}if(T){let nt=t.aTextDx.currentIndex;t.aTextDx[nt++]=a,t.aTextDx.currentIndex=nt}if(S){let nt=t.aTextDy.currentIndex;t.aTextDy[nt++]=l,t.aTextDy.currentIndex=nt}if(D){let nt=t.aMarkerWidth.currentIndex;t.aMarkerWidth[nt++]=h,t.aMarkerWidth.currentIndex=nt}if(z){let nt=t.aMarkerHeight.currentIndex;t.aMarkerHeight[nt++]=u,t.aMarkerHeight.currentIndex=nt}if(L){let nt=t.aMarkerDx.currentIndex;t.aMarkerDx[nt++]=c,t.aMarkerDx.currentIndex=nt}if($){let nt=t.aMarkerDy.currentIndex;t.aMarkerDy[nt++]=f,t.aMarkerDy.currentIndex=nt}if(Rt||I){let nt=t.aColorOpacity.currentIndex;t.aColorOpacity[nt++]=d,t.aColorOpacity.currentIndex=nt}if(M||Z){let nt=t.aPitchAlign.currentIndex;t.aPitchAlign[nt++]=p,t.aPitchAlign.currentIndex=nt}if(j||E){let nt=t.aRotationAlign.currentIndex;t.aRotationAlign[nt++]=g,t.aRotationAlign.currentIndex=nt}if(st||P){let nt=t.aRotation.currentIndex;t.aRotation[nt++]=9362*m,t.aRotation.currentIndex=nt}const Ht=lt||k,ee=rt||O;if(Ht||ee){let nt=t.aOverlap.currentIndex;t.aOverlap[nt++]=(Ht?8:0)+4*y+((ee?2:0)+x),t.aOverlap.currentIndex=nt}o>0&&(this.properties.hasHalo=1)}_getAnchors(t,e,n){const{feature:i,symbol:o}=t,s=this._getPlacement(t,o),a=i.properties,{markerSpacingFn:l,textSpacingFn:h,textMaxAngleFn:u}=this._fnTypes,c=((l?l(null,a):o.markerSpacing)||(h?h(null,a):o.textSpacing)||250)*n;let f=u?u(this.options.zoom,a):o.textMaxAngle;bl(f)&&(f=80),f*=Math.PI/180;const d=this.options.EXTENT,p=this.options.altitudeToTileScale,g=this._is3DPitchText();return $N(t,this.lineVertex,f,e,n,d,s,c,g,p)}_getPlacement(t,e){let n;return n=this._fnTypes.markerPlacementFn?this._fnTypes.markerPlacementFn(this.options.zoom,t.feature.properties):e.markerPlacement||this._textPlacement,this._packMarkerPlacement||!e.markerPlacement&&!e.isIconText||(this._packMarkerPlacement=n),!this._textPlacement||e.isIconText||this._packTextPlacement||(this._packTextPlacement=n),n}getPackSDFFormat(t){if(this._textPlacement!=="line"||t.isIconText)return[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"},{type:Uint8Array,width:1,name:"aCount"}];{const e=[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"},{type:Uint8Array,width:1,name:"aCount"},{type:Int16Array,width:2,name:"aGlyphOffset"},{type:Uint16Array,width:3,name:"aSegment"},{type:Uint8Array,width:1,name:"aVertical"}];return this._is3DPitchText()&&e.push({type:Float32Array,width:3,name:"aPitchRotation"}),e}}getPackMarkerFormat(){return[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"}]}},YN=class Z3{constructor(t){this.x=t.x,this.y=t.y,this.z=t.z||0}clone(){return new Z3(this)}_unit(){return this._div(this.mag()),this}_div(t){return this.x/=t,this.y/=t,this.z/=t,this}_perp(){var t=this.y;return this.y=this.x,this.x=-t,this}mag(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}add(t){return this.clone()._add(t)}sub(t){return this.clone()._sub(t)}_add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}_sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}mult(t){return this.clone()._mult(t)}_mult(t){return this.x*=t,this.y*=t,this.z*=t,this}dist(t){return Math.sqrt(this.distSqr(t))}distSqr(t){var e=t.x-this.x,n=t.y-this.y,i=t.z-this.z;return e*e+n*n+i*i}_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}angleTo(t){return Math.atan2(this.y-t.y,this.x-t.x)}};const lv=63,qN=Math.cos(Math.PI/180*37.5),qS=Math.pow(2,16)/1,hv=new sn,uv=new sn,JN=new sn;let Hd=class extends la{static mergeLineFeatures(t,e,n,i){return YS(t,e,n,i)}constructor(t,e,n){super(t,e,n);let i=!1;const{lineDasharrayFn:o,lineDashColorFn:s}=this._fnTypes;this.hasGradient=this.symbol.lineGradientProperty,o&&(i=function(a,l,h){for(let u=0;u<a.length;u++)if(h(l,a[u].properties))return!0;return!1}(t,this.options.zoom,o),i&&(this.dasharrayFn=o)),this.hasDasharray=cv(this.symbol.lineDasharray)||i,this.hasDasharray&&s&&(this.dashColorFn=s)}createStyledVector(t,e,n,i,o){const s=new xd(t,e,n,i),a=s.getLineResource();return!this.options.atlas&&a&&(o[a]=[0,0]),s}getFormat(){const{lineWidthFn:t,lineStrokeWidthFn:e,lineStrokeColorFn:n,lineColorFn:i,lineOpacityFn:o,lineDxFn:s,lineDyFn:a,linePatternAnimSpeedFn:l,linePatternGapFn:h}=this._fnTypes,u=[...this.getPositionFormat()];if(u.push(this.iconAtlas||this.hasDasharray?{type:Int8Array,width:3,name:"aExtrude"}:{type:Int8Array,width:2,name:"aExtrude"}),u.push({type:this.options.positionType||Uint16Array,width:1,name:"aLinesofar"}),t&&u.push({type:Uint8Array,width:1,name:"aLineWidth"}),e&&u.push({type:Uint8Array,width:1,name:"aLineStrokeWidth"}),i&&u.push({type:Uint8Array,width:4,name:"aColor"}),n&&u.push({type:Uint8Array,width:4,name:"aStrokeColor"}),o&&u.push({type:Uint8Array,width:1,name:"aOpacity"}),this.dasharrayFn&&u.push({type:Uint8Array,width:4,name:"aDasharray"}),this.dashColorFn&&u.push({type:Uint8Array,width:4,name:"aDashColor"}),this.iconAtlas){const c=this.getIconAtlasMaxValue();u.push({type:c>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return(s||a)&&u.push({type:Int8Array,width:2,name:"aLineDxDy"}),(l||h)&&u.push({type:Int8Array,width:2,name:"aLinePattern"}),u}placeVector(t){const{lineJoinFn:e,lineCapFn:n,lineWidthFn:i,lineHeightFn:o,lineStrokeWidthFn:s,lineStrokeColorFn:a,lineColorFn:l,lineOpacityFn:h,lineDxFn:u,lineDyFn:c,linePatternAnimSpeedFn:f,linePatternGapFn:d}=this._fnTypes,p=this.symbol,g=t.feature,m=g.properties;let y=p.lineJoin||"miter",x=p.lineCap||"butt";if(e&&(y=e(this.options.zoom,m)||"miter"),n&&(x=n(this.options.zoom,m)||"butt"),i){let b=i(this.options.zoom,m);Ft(b)&&(this.dynamicAttrs.aLineWidth=1,b=4),tn(b)&&(b=4),this.feaLineWidth=+b}else this.feaLineWidth=+p.lineWidth;if(o){let b=o(this.options.zoom,m);Ft(b)&&(this.dynamicAttrs.aLineHeight=1),tn(b)&&(b=this.feaLineWidth),this.feaLineHeight=+b}else this.feaLineHeight=+p.lineHeight||this.feaLineWidth;if(s){let b=s(this.options.zoom,m);Ft(b)&&(this.dynamicAttrs.aLineStrokeWidth=1,b=0),tn(b)&&(b=0),this.feaLineStrokeWidth=b}else this.feaLineStrokeWidth=p.lineStrokeWidth||0;if(l&&(this.feaColor=l(this.options.zoom,m)||[255,255,255,255],Ft(this.feaColor)?(this.dynamicAttrs.aColor=1,this.feaColor=[0,0,0,0]):this.feaColor=ia([],this.feaColor)),a&&(this.feaStrokeColor=a(this.options.zoom,m)||[0,0,0,255],Ft(this.feaStrokeColor)?(this.dynamicAttrs.aStrokeColor=1,this.feaStrokeColor=[0,0,0,0]):this.feaStrokeColor=ia([],this.feaStrokeColor)),h){let b=h(this.options.zoom,m);Ft(b)&&(this.dynamicAttrs.aOpacity=1,b=1),tn(b)&&(b=1),this.feaOpacity=255*b}if(this.dasharrayFn){let b=this.dasharrayFn(this.options.zoom,m)||[0,0,0,0];if(Ft(b)&&(this.dynamicAttrs.aDasharray=1,b=[0,0,0,0]),b.length<4){const A=b;b.length===1?b=[A[0],A[0],A[0],A[0]]:b.length===2?b=[A[0],A[1],A[0],A[1]]:b.length===3&&(b=[A[0],A[1],A[2],A[2]])}this.feaDash=b}if(this.dashColorFn){let b=(this.dashColorFn?this.dashColorFn(this.options.zoom,m):this.symbol.lineDashColor)||[0,0,0,0];Ft(b)&&(this.dynamicAttrs.aDashColor=1,b=[0,0,0,0]),b=ia([],b),this.feaDashColor=b}if(this.iconAtlas){const b=t.getLineResource(),A=this.iconAtlas.glyphMap[b];if(this.feaTexInfo=this.feaTexInfo||[0,0,0,0],A){const{tl:T,displaySize:S}=this.iconAtlas.positions[b];this.feaTexInfo[0]=T[0]+1,this.feaTexInfo[1]=T[1]+1,this.feaTexInfo[2]=S[0]-3,this.feaTexInfo[3]=S[1]-3}else this.feaTexInfo[0]=this.feaTexInfo[1]=this.feaTexInfo[2]=this.feaTexInfo[3]=0}if(u){let b=u(this.options.zoom,m);Ft(b)&&(this.dynamicAttrs.aLineDxDy=1,b=0),tn(b)&&(b=0),this.feaLineDx=b}if(c){let b=c(this.options.zoom,m);Ft(b)&&(this.dynamicAttrs.aLineDxDy=1,b=0),tn(b)&&(b=0),this.feaLineDy=b}if(f){let b=f(this.options.zoom,m);Ft(b)&&(this.dynamicAttrs.aLinePatternAnimSpeed=1,b=0),tn(b)&&(b=0),b!==0&&(this.properties.hasPatternAnim=1),this.feaPatternAnimSpeed=b}if(d){let b=d(this.options.zoom,m);Ft(b)&&(this.dynamicAttrs.aLinePatternGap=1,b=0),tn(b)&&(b=0),this.feaLinePatternGap=b}const v=this.options.EXTENT;let _=g.geometry;if(v!==1/0){_=[];const b=[];for(let A=0;A<g.geometry.length;A++){b[0]=g.geometry[A];const T=$S(b,-1,-1,v+1,v+1);if(g.type===3&&T.length>1){const S=T[0],M=T[T.length-1];Bu(S[0],M[M.length-1])&&(T[0]=M.concat(S.slice(1)),T.length=T.length-1)}_.push(...T)}}const w=this.needAltitudeAttribute()?2:3;for(let b=0;b<_.length;b++)this.offset=this.data.aPosition.getLength()/w,this._addLine(_[b],g,y,x,2,1.05)}_hasPattern(){return this.iconAtlas&&this.feaTexInfo[2]&&this.feaTexInfo[3]}_addLine(t,e,n,i,o,s){const a=this._hasPattern()||cv(this.feaDash)||cv(this.symbol.lineDasharray),l=this.options.isTube;l&&(t=t.map(_=>new YN(_))),this.overscaling=1;const h=this.options.EXTENT;if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.prevVertex=null,this.symbol.lineGradientProperty&&e.properties&&ys(e.properties.mapbox_clip_start)&&ys(e.properties.mapbox_clip_end)){this.clipStart=+e.properties.mapbox_clip_start,this.clipEnd=+e.properties.mapbox_clip_end;for(let _=0;_<t.length-1;_++)this.totalDistance+=t[_].dist(t[_+1]);this.updateScaledDistance()}const u=e.type===3&&!t.clipped;let c=t.length;for(;c>=2&&Bu(t[c-1],t[c-2]);)c--;let f=0;for(;f<c-1&&Bu(t[f],t[f+1]);)f++;if(c<(u?3:2))return;n==="bevel"&&(o=1.05);const d=this.overscaling<=16?15*h/(512*this.overscaling):0,p={vertexLength:0,primitiveLength:0,currentNormal:null};let g,m,y,x,v;this.e1=this.e2=-1,u&&(g=t[c-2],v=t[f].sub(g)._unit()._perp()),this.ensureDataCapacity(n,c,360,2);for(let _=f;_<c;_++){if(y=_===c-1?u?t[f+1]:void 0:t[_+1],y&&Bu(t[_],y))continue;v&&(x=v),g&&(m=g),g=t[_],y&&g.x===y.x&&g.y===y.y&&(g.x+=1e-4),v=y?y.sub(g)._unit()._perp():x,p.dir=m?g.sub(m)._unit():y.sub(g)._unit(),x=x||v,p.currentNormal=x;let w=x.add(v);w.x===0&&w.y===0||w._unit();const b=x.x*v.x+x.y*v.y,A=w.x*v.x+w.y*v.y,T=A!==0?1/A:1/0,S=2*Math.sqrt(2-2*A),M=A<qN&&m&&y,E=x.x*v.y-x.y*v.x>0;if(!l&&M&&_>f){const O=g.dist(m);if(O>2*d){const I=g.sub(g.sub(m)._mult(d/O)._round());I.z=g.z,this.updateDistance(m,I),this.addCurrentVertex(I,x,0,0,p),m=I}}const P=m&&y;p.middleVertex=P;let k=P?n:u?"butt":i;if(P&&k==="round"&&(T<s?k="miter":T<=2&&(k="fakeround")),k==="miter"&&T>o&&!l&&(k="bevel"),k==="bevel"&&(T>2&&(k="flipbevel"),T<o&&(k="miter")),m&&this.updateDistance(m,g),k==="miter")l?(this.addCurrentVertex(g,x,0,0,p),p.dir=y.sub(g)._unit(),this.addCurrentVertex(g,v,0,0,p)):(w._mult(T),this.addCurrentVertex(g,w,0,0,p),a&&(p.currentNormal=v,this.addCurrentVertex(g,w,0,0,p)));else if(k==="flipbevel"){if(T>100)w=v.mult(-1);else{const O=T*x.add(v).mag()/x.sub(v).mag();w._perp()._mult(O*(E?-1:1))}this.addCurrentVertex(g,w,0,0,p),this.addCurrentVertex(g,w.mult(-1),0,0,p)}else if(k==="bevel"||k==="fakeround"){const O=-Math.sqrt(T*T-1),I=E?O:0,D=E?0:O;if(m&&this.addCurrentVertex(g,x,I,D,p),k==="fakeround"){const z=Math.round(180*S/Math.PI/20);for(let L=1;L<z;L++){let $=L/z;if($!==.5){const j=$-.5;$+=$*j*($-1)*((1.0904+b*(b*(3.55645-1.43519*b)-3.2452))*j*j+(.848013+b*(.215638*b-1.06021)))}const Z=v.sub(x)._mult($)._add(x)._unit()._mult(E?-1:1);this.addHalfVertex(g,Z.x,Z.y,!1,E,0,p)}}y&&(p.currentNormal=v,this.addCurrentVertex(g,v,-I,-D,p))}else if(k==="butt")this.addCurrentVertex(g,w,0,0,p);else if(k==="square"){const O=m?1:-1;this.addCurrentVertex(g,w,O,O,p)}else k==="round"&&(m&&(this.addCurrentVertex(g,x,0,0,p),this.addCurrentVertex(g,x,1,1,p,!0)),y&&(this.addCurrentVertex(g,v,-1,-1,p,!0),this.addCurrentVertex(g,v,0,0,p)));if(!l&&M&&_<c-1){const O=g.dist(y);if(O>2*d){const I=g.add(y.sub(g)._mult(d/O)._round());I.z=g.z,this.updateDistance(g,I),this.addCurrentVertex(I,v,0,0,p),g=I}}}}ensureDataCapacity(t,e,n,i){const o=t==="round"?Math.round(n/20)-1:0;super.ensureDataCapacity((6+o)*i,e)}addCurrentVertex(t,e,n,i,o,s=!1){const a=e.x+e.y*n,l=e.y-e.x*n,h=e.y*i-e.x,u=-e.y-e.x*i;let c=0,f=0;if(o.middleVertex){hv.x=a,hv.y=l,uv.x=h,uv.y=u;const d=o.currentNormal;if(c=QS(d,hv),n===0&&i===0)f=-c;else{const p=JN;p.x=d.x,p.y=d.y,p._mult(-1),f=QS(p,uv)}}this.addHalfVertex(t,a,l,s,!1,n,o,c),this.addHalfVertex(t,h,u,s,!0,-i,o,f),this.prevVertex&&Bu(t,this.prevVertex)||(this.prevVertex=t),this.distance>qS/2&&this.totalDistance===0&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(t,e,n,i,o,s))}addHalfVertex({x:t,y:e,z:n},i,o,s,a,l,h,u){this.fillData(this.data,t,e,n||0,i,o,s,a,1*this.scaledDistance,u);const c=h.vertexLength++;this.e1>=0&&this.e2>=0&&(this.addElements(this.e1,this.e2,c),h.primitiveLength++),a?this.e2=c:this.e1=c}fillData(t,e,n,i,o,s,a,l,h,u){const{lineWidthFn:c,lineStrokeWidthFn:f,lineStrokeColorFn:d,lineColorFn:p,lineOpacityFn:g,lineDxFn:m,lineDyFn:y,linePatternAnimSpeedFn:x,linePatternGapFn:v}=this._fnTypes;this.fillPosition(t,e,n,i);let _=lv*o;_=(Math.sign(_)||1)*((Math.floor(Math.abs(_))>>1<<1)+ +a);let w=lv*s;w=(Math.sign(w)||1)*((Math.floor(Math.abs(w))>>1<<1)+ +l);let b=t.aExtrude.currentIndex;t.aExtrude[b++]=_,t.aExtrude[b++]=w,(this.iconAtlas||this.hasDasharray)&&(t.aExtrude[b++]=lv*u),t.aExtrude.currentIndex=b,b=t.aLinesofar.currentIndex,t.aLinesofar[b++]=h,t.aLinesofar.currentIndex=b,c&&(b=t.aLineWidth.currentIndex,t.aLineWidth[b++]=Math.round(2*this.feaLineWidth),t.aLineWidth.currentIndex=b),f&&(b=t.aLineStrokeWidth.currentIndex,t.aLineStrokeWidth[b++]=Math.round(2*this.feaLineStrokeWidth),t.aLineStrokeWidth.currentIndex=b),p&&(b=t.aColor.currentIndex,t.aColor[b++]=this.feaColor[0],t.aColor[b++]=this.feaColor[1],t.aColor[b++]=this.feaColor[2],t.aColor[b++]=this.feaColor[3],t.aColor.currentIndex=b),d&&(b=t.aStrokeColor.currentIndex,t.aStrokeColor[b++]=this.feaStrokeColor[0],t.aStrokeColor[b++]=this.feaStrokeColor[1],t.aStrokeColor[b++]=this.feaStrokeColor[2],t.aStrokeColor[b++]=this.feaStrokeColor[3],t.aStrokeColor.currentIndex=b),g&&(b=t.aOpacity.currentIndex,t.aOpacity[b++]=this.feaOpacity,t.aOpacity.currentIndex=b),this.dasharrayFn&&(b=t.aDasharray.currentIndex,t.aDasharray[b++]=this.feaDash[0],t.aDasharray[b++]=this.feaDash[1],t.aDasharray[b++]=this.feaDash[2],t.aDasharray[b++]=this.feaDash[3],t.aDasharray.currentIndex=b),this.dashColorFn&&(b=t.aDashColor.currentIndex,t.aDashColor[b++]=this.feaDashColor[0],t.aDashColor[b++]=this.feaDashColor[1],t.aDashColor[b++]=this.feaDashColor[2],t.aDashColor[b++]=this.feaDashColor[3],t.aDashColor.currentIndex=b),this.iconAtlas&&(b=t.aTexInfo.currentIndex,t.aTexInfo[b++]=this.feaTexInfo[0],t.aTexInfo[b++]=this.feaTexInfo[1],t.aTexInfo[b++]=this.feaTexInfo[2],t.aTexInfo[b++]=this.feaTexInfo[3],t.aTexInfo.currentIndex=b),(m||y)&&(b=t.aLineDxDy.currentIndex,t.aLineDxDy[b++]=this.feaLineDx||0,t.aLineDxDy[b++]=this.feaLineDy||0,t.aLineDxDy.currentIndex=b),(x||v)&&(b=t.aLinePattern.currentIndex,t.aLinePattern[b++]=127*(this.feaPatternAnimSpeed||0),t.aLinePattern[b++]=10*(this.feaLinePatternGap||0),t.aLinePattern.currentIndex=b),this.maxPos=Math.max(this.maxPos,Math.abs(e)+1,Math.abs(n)+1)}addElements(t,e,n){super.addElements(this.offset+t,this.offset+e,this.offset+n)}_filterPolygonEdges(t){const e=this.options.EXTENT,n=this.elements;for(let i=0;i<n.length;i+=3)if(e===1/0||!JS(this.data.aPosition,n[i],n[i+1],3,e)&&!JS(this.data.aPosition,n[i+1],n[i+2],3,e)){let o=t.currentIndex;t[o++]=n[i],t[o++]=n[i+1],t[o++]=n[i+2],t.currentIndex=o}}_filterLine(t){if(t.length<=1)return t;const e=[],n=this.options.EXTENT;let i,o=!0;for(i=0;i<t.length-1;i++){const s=KN(t[i],t[i+1],n);s&&o||(e.push(t[i]),o=s)}return o||e.push(t[i]),e}updateDistance(t,e){if(this.options.isTube){const n=t.dist(e),i=bM(this.options)*(e.z-t.z);this.distance+=Math.sqrt(n*n+i*i)}else this.distance+=t.dist(e);this.updateScaledDistance()}updateScaledDistance(){this.scaledDistance=this.totalDistance>0?(this.clipStart+(this.clipEnd-this.clipStart)*this.distance/this.totalDistance)*(qS-1):this.distance}};function KN(r,t,e){return e!==1/0&&(r.x<0&&t.x<0||r.x>e&&t.x>e||r.y<0&&t.y<0||r.y>e&&t.y>e)}function JS(r,t,e,n,i){if(i===1/0)return!1;const o=Math.floor(.5*r[t*n]),s=Math.floor(.5*r[t*n+1]),a=Math.floor(.5*r[e*n]),l=Math.floor(.5*r[e*n+1]);return o===a&&(o<0||o>i)&&s!==l||s===l&&(s<0||s>i)&&o!==a}function cv(r){if(!Array.isArray(r))return!1;for(let t=0;t<r.length;t++)if(r[t])return!0;return!1}const KS=new sn(0,0);function QS(r,t){const e=r.mag(),n=t.mag(),i=r.angleTo(KS),o=t.angleTo(KS);return Math.sign(o-i)*Math.sqrt(n*n-e*e)}function Bu(r,t){return r.equals(t)&&r.z===t.z}/*!
 * from @turf/bboxClip
 * https://github.com/Turfjs/turf
 * MIT LICENSE
 */const Fl=[],fv=[];function tC(r,t){var e,n,i,o,s,a,l;for(n=1;n<=8;n*=2){for(e=[],o=!(eC(i=r[r.length-1],t)&n),s=0;s<r.length;s++){if((l=!(eC(a=r[s],t)&n))!==o){const h=QN(i,a,n,t);e.push(a.x!==void 0?new sn(h[0],h[1]):h)}l&&e.push(a),i=a,o=l}if(!(r=e).length)break}return e}function QN(r,t,e,n){return Fl[0]=r.x===void 0?r[0]:r.x,Fl[1]=r.y===void 0?r[1]:r.y,r=Fl,fv[0]=t.x===void 0?t[0]:t.x,fv[1]=t.y===void 0?t[1]:t.y,t=fv,8&e?[r[0]+(t[0]-r[0])*(n[3]-r[1])/(t[1]-r[1]),n[3]]:4&e?[r[0]+(t[0]-r[0])*(n[1]-r[1])/(t[1]-r[1]),n[1]]:2&e?[n[2],r[1]+(t[1]-r[1])*(n[2]-r[0])/(t[0]-r[0])]:1&e?[n[0],r[1]+(t[1]-r[1])*(n[0]-r[0])/(t[0]-r[0])]:null}function eC(r,t){Fl[0]=r.x===void 0?r[0]:r.x,Fl[1]=r.y===void 0?r[1]:r.y;var e=0;return(r=Fl)[0]<t[0]?e|=1:r[0]>t[2]&&(e|=2),r[1]<t[1]?e|=4:r[1]>t[3]&&(e|=8),e}const t8=[0,0,0,0],dv=-9999999;let nC=class extends la{constructor(...t){super(...t),this.lineElements=[]}createStyledVector(t,e,n,i,o){const s=new xd(t,e,n,i),a=s.getPolygonResource();return!this.options.atlas&&a&&(o[a]=[0,0]),s}getFormat(){const t=[...this.getPositionFormat()],{polygonFillFn:e,polygonOpacityFn:n,uvScaleFn:i,uvOffsetFn:o,polygonPatternUVFn:s}=this._fnTypes;if(this.iconAtlas){const a=this.getIconAtlasMaxValue();t.push({type:a>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return e&&t.push({type:Uint8Array,width:4,name:"aColor"}),n&&t.push({type:Uint8Array,width:1,name:"aOpacity"}),i&&t.push({type:Uint16Array,width:2,name:"aUVScale"}),o&&t.push({type:Uint8Array,width:2,name:"aUVOffset"}),s&&t.push({type:Float32Array,width:2,name:"aTexCoord"}),t}placeVector(t,e){const n=t.feature;this._addPolygon(n.geometry,n,e)}_addPolygon(t,e){let n,i,o,s;const{polygonFillFn:a,polygonOpacityFn:l,uvScaleFn:h,uvOffsetFn:u,uvOffsetInMeterFn:c,polygonPatternUVFn:f}=this._fnTypes,d=e.properties;a&&(n=a(this.options.zoom,d)||Tr([],255,255,255,255),Ft(n)?(this.dynamicAttrs.aColor=1,n=t8):n=ia([],n)),l&&(i=l(this.options.zoom,d),Ft(i)?(this.dynamicAttrs.aOpacity=1,i=255):(tn(i)&&(i=1),i*=255)),h&&(o=h(this.options.zoom,d),Ft(o)?(o=[255,255],this.dynamicAttrs.aUVScale=1):(tn(o)&&(o=[1,1]),o=[255*o[0],255*o[1]])),u&&(c&&c(null,d)?s=[0,0]:(s=u(this.options.zoom,d),Ft(s)?(s=[0,0],this.dynamicAttrs.aUVOffset=1):(tn(s)&&(s=[0,0]),s=[255*s[0],255*s[1]])));const p=!!this.iconAtlas,g=ZS(t,500),m=[0,0],y=[0,0];if(p){const{polygonPatternFileFn:T}=this._fnTypes,S=T?T(null,d):this.symbol.polygonPatternFile;if(this.iconAtlas.glyphMap[S]){const M=this.iconAtlas.positions[S],E=!vd(M.displaySize[0])||!vd(M.displaySize[1]);m[0]=M.tl[0]+(E?1:0),m[1]=M.tl[1]+(E?1:0),y[0]=M.displaySize[0]-1-(E?2:0),y[1]=M.displaySize[1]-1-(E?2:0)}}let x,v=0;f&&(x=f(this.options.zoom,d));const _=this.needAltitudeAttribute()?2:3,w=[-1,-1,e.extent+1,e.extent+1],b=this._flattened=this._flattened||this._arrayPool.getProxy(),A=this._holeIndices=this._holeIndices||this._arrayPool.getProxy();for(let T=0;T<g.length;T++){const S=g[T],M=this.data.aPosition.getLength()/_;b.setLength(0),A.setLength(0);for(let P=0;P<S.length;P++){let k=S[P];if(this.options.EXTENT!==1/0&&this.maxPosZ===0&&(k=tC(k,w)),k.length===0)continue;P!==0&&A.push(b.length/3),this.ensureDataCapacity(k.length);const O=this.data;for(let I=0;I<k.length;I++){const D=k[I].x,z=k[I].y,L=k[I].z||0;if(this.fillPosition(this.data,D,z,L),p){let j=O.aTexInfo.currentIndex;O.aTexInfo[j++]=m[0],O.aTexInfo[j++]=m[1],O.aTexInfo[j++]=y[0],O.aTexInfo[j++]=y[1],O.aTexInfo.currentIndex=j}if(n!==void 0){let j=O.aColor.currentIndex;O.aColor[j++]=n[0],O.aColor[j++]=n[1],O.aColor[j++]=n[2],O.aColor[j++]=n[3],O.aColor.currentIndex=j}if(i!==void 0){let j=O.aOpacity.currentIndex;O.aOpacity[j++]=i,O.aOpacity.currentIndex=j}if(o!==void 0){let j=O.aUVScale.currentIndex;O.aUVScale[j++]=o[0],O.aUVScale[j++]=o[1],O.aUVScale.currentIndex=j}if(s!==void 0){let j=O.aUVOffset.currentIndex;O.aUVOffset[j++]=s[0],O.aUVOffset[j++]=s[1],O.aUVOffset.currentIndex=j}if(f){let j=O.aTexCoord.currentIndex;if(x){const st=tn(x[2*v])?x[0]:x[2*v],lt=tn(x[2*v]+1)?x[1]:x[2*v+1];O.aTexCoord[j++]=st,O.aTexCoord[j++]=lt}else O.aTexCoord[j++]=dv,O.aTexCoord[j++]=dv;O.aTexCoord.currentIndex=j,v++}const $=Math.abs(D),Z=Math.abs(z);$>this.maxPos&&(this.maxPos=$),Z>this.maxPos&&(this.maxPos=Z),b.push(D,z,L)}}let E=md(b,A,3);if(b.length&&!E.length){const P=[];for(let k=0;k<b.length;k+=3)P[k]=b[k],P[k+1]=b[k+2],P[k+2]=b[k+1];if(E=md(P,A,3),!E.length){for(let k=0;k<b.length;k+=3)P[k]=b[k+1],P[k+1]=b[k+2],P[k+2]=b[k];E=md(P,A,3)}}for(let P=0;P<E.length;P+=3)this.addElements(M+E[P],M+E[P+1],M+E[P+2])}}ensureDataCapacity(t){super.ensureDataCapacity(1,t)}},rC=class{constructor(t){this.max=t,this.reset()}reset(){return this.data={},this.order=[],this}clear(){this.reset()}add(t,e){return this.has(t)?(this.order.splice(this.order.indexOf(t),1),this.data[t]=e,this.order.push(t)):(this.data[t]=e,this.order.push(t),this.order.length>this.max&&this.getAndRemove(this.order[0])),this}has(t){return t in this.data}keys(){return this.order}getAndRemove(t){if(!this.has(t))return null;const e=this.data[t];return delete this.data[t],this.order.splice(this.order.indexOf(t),1),e}get(t){return this.has(t)?this.data[t]:null}remove(t){return this.has(t)?(delete this.data[t],this.order.splice(this.order.indexOf(t),1),this):this}setMaxSize(t){for(this.max=t;this.order.length>this.max;)this.getAndRemove(this.order[0]);return this}};/*!
 * based on @mapbox/tiny-sdf
 * https://github.com/mapbox/tiny-sdf
 * @License BSD 2-Clause
 */var ju=1e20;function iC(r,t,e,n,i,o,s){this.fontSize=r||24,this.buffer=t===void 0?3:t,this.cutoff=n||.25,this.fontFamily=i||"sans-serif",this.fontWeight=o||"normal",this.fontStyle=s||"normal",this.radius=e||8;var a=this.size=this.fontSize+2*this.buffer;this.canvas=typeof document>"u"?new OffscreenCanvas(a,a):document.createElement("canvas"),this.canvas.width=this.canvas.height=a,this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),this.ctx.font=this.fontStyle+" "+this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textBaseline="middle",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(a*a),this.gridInner=new Float64Array(a*a),this.f=new Float64Array(a),this.z=new Float64Array(a+1),this.v=new Uint16Array(a),this.middle=Math.round(a/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}function oC(r,t,e,n,i,o){for(var s=0;s<t;s++)sC(r,s,t,e,n,i,o);for(var a=0;a<e;a++)sC(r,a*t,1,t,n,i,o)}function sC(r,t,e,n,i,o,s){var a,l,h,u;for(o[0]=0,s[0]=-ju,s[1]=ju,a=0;a<n;a++)i[a]=r[t+a*e];for(a=1,l=0,h=0;a<n;a++){do h=(i[a]-i[u=o[l]]+a*a-u*u)/(a-u)/2;while(h<=s[l]&&--l>-1);o[++l]=a,s[l]=h,s[l+1]=ju}for(a=0,l=0;a<n;a++){for(;s[l+1]<a;)l++;r[t+a*e]=i[u=o[l]]+(a-u)*(a-u)}}iC.prototype.draw=function(r,t,e){this.ctx.clearRect(0,0,this.size,this.size),this.ctx.textBaseline="top",this.ctx.fillText(r,this.buffer,this.buffer);for(var n=this.ctx.getImageData(0,0,t,e),i=new Uint8ClampedArray(t*e),o=0;o<t*e;o++){var s=n.data[4*o+3]/255;this.gridOuter[o]=s===1?0:s===0?ju:Math.pow(Math.max(0,.5-s),2),this.gridInner[o]=s===1?ju:s===0?0:Math.pow(Math.max(0,s-.5),2)}for(oC(this.gridOuter,t,e,this.f,this.v,this.z),oC(this.gridInner,t,e,this.f,this.v,this.z),o=0;o<t*e;o++){var a=Math.sqrt(this.gridOuter[o])-Math.sqrt(this.gridInner[o]);i[o]=Math.round(255-255*(a/this.radius+this.cutoff))}return i};let aC=0,lC=class{constructor(t,e=15,n,i){this.entries={},this._cachedFont={},this._cache=new rC(2048,function(){}),this._framer=t,this._limit=e,this._isCompactChars=n,this._sdfURL=i}_isValidSDFURL(t){return t&&t.indexOf("{stack}")>=0&&t.indexOf("{range}")>0}getGlyphs(t,e){if(!t||!Object.keys(t).length)return void e(null,{glyphs:null});if(this._isValidSDFURL(this._sdfURL))return void this._requestRemoteSDF(t,e);const n=this.entries,i=t.options;let o=!0;i&&(o=i.isCharsCompact!==!1),o=o||this._isCompactChars;const s=(l,h,u)=>{let c=0,f=0;for(const d in t)if(d!=="options"){n[d]=n[d]||{},h[d]=h[d]||{};for(const p in t[d]){if(f++,f<=l)continue;const g=o&&!Fd(+p),m=d+":"+p+":"+g;let y;if(this._cache.has(m)?y=this._cache.get(m):(y=this._tinySDF(n[d],d,p,g),this._cache.add(m,y),c++),y=e8(y),h[d][p]=y,u.push(y.bitmap.data.buffer),this._framer&&c>this._limit)return void this._framer(a(f,h,u))}}e(null,{glyphs:h,buffers:u})};function a(l,h,u){return()=>{s(l,h,u)}}s(0,{},[])}_requestRemoteSDF(t,e){const n=[];for(const i in t)for(const o of t[i])n.push(this._requestGlyph(i,o));Promise.all(n).then(i=>{e(null,i)})}_requestGlyph(){return Promise.resolve(null)}_tinySDF(t,e,n,i){const o=e;let s=t.tinySDF;const a=i?-1:2;if(!s){let f="400";/bolder/i.test(o)?f="1000":/bold/i.test(o)?f="900":/medium/i.test(o)?f="500":/light/i.test(o)&&(f="200"),s=t.tinySDF=new iC(24,2,8,.25,o,f)}const l=String.fromCodePoint(n),h=s.ctx.measureText(l),u=Math.round(h.width),c=s.draw(l,u+4,28);if(aC<4){const f=typeof document<"u"&&document.getElementById("sdf-debug-"+aC++);f&&(f.width=u+4,f.height=s.canvas.height,f.getContext("2d").drawImage(s.canvas,0,0))}return{charCode:n,bitmap:{width:u+4,height:28,data:c},metrics:{width:u,height:24,left:1,top:-2,advance:u+2+a}}}};function e8(r){const t={width:r.bitmap.width,height:r.bitmap.height,data:new Uint8ClampedArray(r.bitmap.data)};return{charCode:r.charCode,bitmap:t,metrics:wl({},r.metrics)}}let hC=class{constructor(t){this.options=t||{},this._requesting={},this._cache=new rC(256,function(){});const e=document.createElement("canvas");this.ctx=e.getContext("2d",{willReadFrequently:!0})}getIcons(t,e){if(!t||!Object.keys(t).length)return void e(null,{icons:null});const n=Object.keys(t),i={},o=[];let s=0,a=0;const l=this;function h(m,y){i[m]=l._getCache(m,y),i[m]&&i[m]!=="error"?o.push(i[m].data.data.buffer):delete i[m],a++,a===s&&e(null,{icons:i,buffers:o})}function u(m){const y=l._requesting[m.url];for(let x=0;x<y.length;x++)y[x].call(m,m.url,m.size);delete l._requesting[m.url]}function c(){const m=l.ctx;let y,x;try{y=this.width,x=this.height,this.size[0]=y,this.size[1]=x,l._ensureMaxSize(null,this.size),y=this.size[0],x=this.size[1];const v=m.canvas;v.width=y,v.height=x,m.imageSmoothingEnabled=!1,m.drawImage(this,0,0,y,x);const _=m.getImageData(0,0,v.width,v.height).data;l._addCache(this.url,_,v.width,v.height)}catch(v){console.warn(v)}u(this)}function f(m){console.warn(`failed loading icon(${this.index}) at "${this.url}"`),console.warn(m),l.options.iconErrorUrl?this.src=l.options.iconErrorUrl:(l._addCache(this.url),u(this))}const d=this.options.urlModifier;let p,g=!1;for(let m=0;m<n.length;m++){const y=n[m],x=t[y];this._ensureMaxSize(y,x);const v=this._getCache(y,x);if(v&&v!=="error"){i[y]=this._getCache(y,x);continue}if(v==="error")continue;let _,w=y;if(y.indexOf("vector://")===0&&(_=JSON.parse(y.substring(9)),_.markerType==="path"&&(w=Jr.getMarkerPathBase64(_,_.markerWidth,_.markerHeight))),y.indexOf("vector://")===0&&_.markerType!=="path"){p=p||new bn([0,0]);const{markerFill:b,markerLineColor:A}=_;b&&Array.isArray(b)&&(_.markerFill=uC(b)),A&&Array.isArray(A)&&(_.markerLineColor=uC(A)),delete _.markerHorizontalAlignment,delete _.markerVerticalAlignment,delete _.markerDx,delete _.markerDy,delete _.markerPlacement,delete _.markerFile,_.markerWidth=x[0],_.markerHeight=x[1],p.setSymbol(_);const T=p["_getSprite".trim()]();if(T){const S=T.canvas,M=S.width,E=S.height,P=S.getContext("2d").getImageData(0,0,M,E).data;i[y]={data:{data:new Uint8ClampedArray(P),width:M,height:E},url:y},o.push(i[y].data.data.buffer),this._addCache(y,P,M,E)}}else{if(this._requesting[y]){g=!0,s++,this._requesting[y].push(h);continue}this._requesting[y]=[],this._requesting[y].push(h);const b=new Image;b.index=m,b.size=x,b.onload=c,b.onerror=f,b.onabort=f,b.url=y,b.crossOrigin="Anonymous",g=!0,s++,b.src=d&&d(w)||w}}g||e(null,{icons:i,buffers:o})}_hasCache(t,e,n){const i=this._cache.get(t);return i&&i!=="error"&&i.data.width>=e&&i.data.height>=n}_addCache(t,e,n,i){this._hasCache(t,n,i)||this._cache.add(t,e?{data:{data:e,width:n,height:i},url:t}:"error")}_getCache(t,e){if(!this._hasCache(t,e[0],e[1]))return null;const n=this._cache.get(t);return n?n==="error"?n:{data:{data:new Uint8ClampedArray(n.data.data),width:n.data.width,height:n.data.height},url:n.url}:null}_ensureMaxSize(t,e){if(!e[0]||!e[1])return;const n=this.options.maxSize||2048;let[i,o]=e;const s=i/o;if(t){const a=this._cache.get(t);if(a&&a!=="error"){const{width:l,height:h}=a.data;l>i&&(i=l),h>o&&(o=h)}}i>n&&(o=n/s,i=n),o>n&&(i=n*s,o=n),e[0]=Math.floor(i),e[1]=Math.floor(o)}};function uC(r){return r.length===3&&r.push(1),r.reduce((t,e,n)=>t+=n<3?255*e+",":e+")","rgba(")}var Lr=Object.freeze({__proto__:null,calculateSignedArea:cM,clipPolygon:tC,convertGeometry:xM,convertRTLText:VS,generatePickingIndiceIndex:pM,getFeaAltitudeAndHeight:fM,getIndexArrayType:yM,getPosArrayType:Py,getUnsignedArrayType:Ey,packPosition:TM,unpackPosition:function(r,t,e,n){const i=(Math.sign(t)||1)*(Math.abs(t)%_d),o=(Math.sign(e)||1)*(Math.abs(e)%_d),s=Math.floor(Math.abs(t)/_d),a=Math.floor(Math.abs(e)/_d);return r[0]=i,r[1]=o,r[2]=Math.sign(n+1e-5)*(2*s+a)*zH+n,r}});const n8={},r8={},i8=[];var cC=Object.freeze({__proto__:null,loadSymbolFnTypes:function r(t,e){if(!t)return null;var n=!1;if(Array.isArray(t)){var i,o=[];for(let c=0;c<t.length;c++)(i=r(t[c],e))?(o.push(i),n=!0):o.push(t[c]);return n?o:t}var s={__fn_types_loaded:!0};const a=[];for(const c in t)Tl(t,c)&&a.push(c);const l=function(c){Object.defineProperty(s,c,{get:function(){return this["__fn_"+c]||(this["__fn_"+c]=le(this["_"+c])),this["__fn_"+c].apply(this,e())},set:function(f){this["_"+c]=f},configurable:!0,enumerable:!0})},h={},u=function(c,f){Object.defineProperty(s,c,{get:function(){this["__fn_"+c]||(this["__fn_"+c]=ev(this["_"+c],f));const d=e()[0];h.zoom=d;try{return this["__fn_"+c].evaluateWithoutErrorHandling(h,n8,r8,null,i8)}catch{return null}},set:function(d){this["_"+c]=d},configurable:!0,enumerable:!0})};for(let c=0,f=a.length;c<f;c++){const d=a[c];if(Ft(t[d]))n=!0,s["_"+d]=t[d],l(d);else if(nv(t[d])){n=!0;const p=iv(d);s["_"+d]=t[d],u(d,p)}else s[d]=t[d]}return n?s:t}});function o8(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var s8={read:function(r,t,e,n,i){var o,s,a=8*i-n-1,l=(1<<a)-1,h=l>>1,u=-7,c=e?i-1:0,f=e?-1:1,d=r[t+c];for(c+=f,o=d&(1<<-u)-1,d>>=-u,u+=a;u>0;o=256*o+r[t+c],c+=f,u-=8);for(s=o&(1<<-u)-1,o>>=-u,u+=n;u>0;s=256*s+r[t+c],c+=f,u-=8);if(o===0)o=1-h;else{if(o===l)return s?NaN:1/0*(d?-1:1);s+=Math.pow(2,n),o-=h}return(d?-1:1)*s*Math.pow(2,o-n)},write:function(r,t,e,n,i,o){var s,a,l,h=8*o-i-1,u=(1<<h)-1,c=u>>1,f=i===23?Math.pow(2,-24)-Math.pow(2,-77):0,d=n?0:o-1,p=n?1:-1,g=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=u):(s=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-s))<1&&(s--,l*=2),(t+=s+c>=1?f/l:f*Math.pow(2,1-c))*l>=2&&(s++,l/=2),s+c>=u?(a=0,s=u):s+c>=1?(a=(t*l-1)*Math.pow(2,i),s+=c):(a=t*Math.pow(2,c-1)*Math.pow(2,i),s=0));i>=8;r[e+d]=255&a,d+=p,a/=256,i-=8);for(s=s<<i|a,h+=i;h>0;r[e+d]=255&s,d+=p,s/=256,h-=8);r[e+d-p]|=128*g}},a8=fn,Nd=s8;function fn(r){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(r)?r:new Uint8Array(r||0),this.pos=0,this.type=0,this.length=this.buf.length}fn.Varint=0,fn.Fixed64=1,fn.Bytes=2,fn.Fixed32=5;var pv=4294967296,fC=1/pv,dC=typeof TextDecoder>"u"?null:new TextDecoder("utf8");function No(r){return r.type===fn.Bytes?r.readVarint()+r.pos:r.pos+1}function Ll(r,t,e){return e?4294967296*t+(r>>>0):4294967296*(t>>>0)+(r>>>0)}function pC(r,t,e){var n=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));e.realloc(n);for(var i=e.pos-1;i>=r;i--)e.buf[i+n]=e.buf[i]}function l8(r,t){for(var e=0;e<r.length;e++)t.writeVarint(r[e])}function h8(r,t){for(var e=0;e<r.length;e++)t.writeSVarint(r[e])}function u8(r,t){for(var e=0;e<r.length;e++)t.writeFloat(r[e])}function c8(r,t){for(var e=0;e<r.length;e++)t.writeDouble(r[e])}function f8(r,t){for(var e=0;e<r.length;e++)t.writeBoolean(r[e])}function d8(r,t){for(var e=0;e<r.length;e++)t.writeFixed32(r[e])}function p8(r,t){for(var e=0;e<r.length;e++)t.writeSFixed32(r[e])}function g8(r,t){for(var e=0;e<r.length;e++)t.writeFixed64(r[e])}function m8(r,t){for(var e=0;e<r.length;e++)t.writeSFixed64(r[e])}function Bd(r,t){return(r[t]|r[t+1]<<8|r[t+2]<<16)+16777216*r[t+3]}function zl(r,t,e){r[e]=t,r[e+1]=t>>>8,r[e+2]=t>>>16,r[e+3]=t>>>24}function gC(r,t){return(r[t]|r[t+1]<<8|r[t+2]<<16)+(r[t+3]<<24)}fn.prototype={destroy:function(){this.buf=null},readFields:function(r,t,e){for(e=e||this.length;this.pos<e;){var n=this.readVarint(),i=n>>3,o=this.pos;this.type=7&n,r(i,t,this),this.pos===o&&this.skip(n)}return t},readMessage:function(r,t){return this.readFields(r,t,this.readVarint()+this.pos)},readFixed32:function(){var r=Bd(this.buf,this.pos);return this.pos+=4,r},readSFixed32:function(){var r=gC(this.buf,this.pos);return this.pos+=4,r},readFixed64:function(){var r=Bd(this.buf,this.pos)+Bd(this.buf,this.pos+4)*pv;return this.pos+=8,r},readSFixed64:function(){var r=Bd(this.buf,this.pos)+gC(this.buf,this.pos+4)*pv;return this.pos+=8,r},readFloat:function(){var r=Nd.read(this.buf,this.pos,!0,23,4);return this.pos+=4,r},readDouble:function(){var r=Nd.read(this.buf,this.pos,!0,52,8);return this.pos+=8,r},readVarint:function(r){var t,e,n=this.buf;return t=127&(e=n[this.pos++]),e<128?t:(t|=(127&(e=n[this.pos++]))<<7,e<128?t:(t|=(127&(e=n[this.pos++]))<<14,e<128?t:(t|=(127&(e=n[this.pos++]))<<21,e<128?t:function(i,o,s){var a,l,h=s.buf;if(l=h[s.pos++],a=(112&l)>>4,l<128||(l=h[s.pos++],a|=(127&l)<<3,l<128)||(l=h[s.pos++],a|=(127&l)<<10,l<128)||(l=h[s.pos++],a|=(127&l)<<17,l<128)||(l=h[s.pos++],a|=(127&l)<<24,l<128)||(l=h[s.pos++],a|=(1&l)<<31,l<128))return Ll(i,a,o);throw new Error("Expected varint not more than 10 bytes")}(t|=(15&(e=n[this.pos]))<<28,r,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var r=this.readVarint();return r%2==1?(r+1)/-2:r/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var r=this.readVarint()+this.pos,t=this.pos;return this.pos=r,r-t>=12&&dC?function(e,n,i){return dC.decode(e.subarray(n,i))}(this.buf,t,r):function(e,n,i){for(var o="",s=n;s<i;){var a,l,h,u=e[s],c=null,f=u>239?4:u>223?3:u>191?2:1;if(s+f>i)break;f===1?u<128&&(c=u):f===2?(192&(a=e[s+1]))==128&&(c=(31&u)<<6|63&a)<=127&&(c=null):f===3?(l=e[s+2],(192&(a=e[s+1]))==128&&(192&l)==128&&((c=(15&u)<<12|(63&a)<<6|63&l)<=2047||c>=55296&&c<=57343)&&(c=null)):f===4&&(l=e[s+2],h=e[s+3],(192&(a=e[s+1]))==128&&(192&l)==128&&(192&h)==128&&((c=(15&u)<<18|(63&a)<<12|(63&l)<<6|63&h)<=65535||c>=1114112)&&(c=null)),c===null?(c=65533,f=1):c>65535&&(c-=65536,o+=String.fromCharCode(c>>>10&1023|55296),c=56320|1023&c),o+=String.fromCharCode(c),s+=f}return o}(this.buf,t,r)},readBytes:function(){var r=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,r);return this.pos=r,t},readPackedVarint:function(r,t){if(this.type!==fn.Bytes)return r.push(this.readVarint(t));var e=No(this);for(r=r||[];this.pos<e;)r.push(this.readVarint(t));return r},readPackedSVarint:function(r){if(this.type!==fn.Bytes)return r.push(this.readSVarint());var t=No(this);for(r=r||[];this.pos<t;)r.push(this.readSVarint());return r},readPackedBoolean:function(r){if(this.type!==fn.Bytes)return r.push(this.readBoolean());var t=No(this);for(r=r||[];this.pos<t;)r.push(this.readBoolean());return r},readPackedFloat:function(r){if(this.type!==fn.Bytes)return r.push(this.readFloat());var t=No(this);for(r=r||[];this.pos<t;)r.push(this.readFloat());return r},readPackedDouble:function(r){if(this.type!==fn.Bytes)return r.push(this.readDouble());var t=No(this);for(r=r||[];this.pos<t;)r.push(this.readDouble());return r},readPackedFixed32:function(r){if(this.type!==fn.Bytes)return r.push(this.readFixed32());var t=No(this);for(r=r||[];this.pos<t;)r.push(this.readFixed32());return r},readPackedSFixed32:function(r){if(this.type!==fn.Bytes)return r.push(this.readSFixed32());var t=No(this);for(r=r||[];this.pos<t;)r.push(this.readSFixed32());return r},readPackedFixed64:function(r){if(this.type!==fn.Bytes)return r.push(this.readFixed64());var t=No(this);for(r=r||[];this.pos<t;)r.push(this.readFixed64());return r},readPackedSFixed64:function(r){if(this.type!==fn.Bytes)return r.push(this.readSFixed64());var t=No(this);for(r=r||[];this.pos<t;)r.push(this.readSFixed64());return r},skip:function(r){var t=7&r;if(t===fn.Varint)for(;this.buf[this.pos++]>127;);else if(t===fn.Bytes)this.pos=this.readVarint()+this.pos;else if(t===fn.Fixed32)this.pos+=4;else{if(t!==fn.Fixed64)throw new Error("Unimplemented type: "+t);this.pos+=8}},writeTag:function(r,t){this.writeVarint(r<<3|t)},realloc:function(r){for(var t=this.length||16;t<this.pos+r;)t*=2;if(t!==this.length){var e=new Uint8Array(t);e.set(this.buf),this.buf=e,this.length=t}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(r){this.realloc(4),zl(this.buf,r,this.pos),this.pos+=4},writeSFixed32:function(r){this.realloc(4),zl(this.buf,r,this.pos),this.pos+=4},writeFixed64:function(r){this.realloc(8),zl(this.buf,-1&r,this.pos),zl(this.buf,Math.floor(r*fC),this.pos+4),this.pos+=8},writeSFixed64:function(r){this.realloc(8),zl(this.buf,-1&r,this.pos),zl(this.buf,Math.floor(r*fC),this.pos+4),this.pos+=8},writeVarint:function(r){(r=+r||0)>268435455||r<0?function(t,e){var n,i;if(t>=0?(n=t%4294967296|0,i=t/4294967296|0):(i=~(-t/4294967296),4294967295^(n=~(-t%4294967296))?n=n+1|0:(n=0,i=i+1|0)),t>=18446744073709552e3||t<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),function(o,s,a){a.buf[a.pos++]=127&o|128,o>>>=7,a.buf[a.pos++]=127&o|128,o>>>=7,a.buf[a.pos++]=127&o|128,o>>>=7,a.buf[a.pos++]=127&o|128,o>>>=7,a.buf[a.pos]=127&o}(n,0,e),function(o,s){var a=(7&o)<<4;s.buf[s.pos++]|=a|((o>>>=3)?128:0),o&&(s.buf[s.pos++]=127&o|((o>>>=7)?128:0),o&&(s.buf[s.pos++]=127&o|((o>>>=7)?128:0),o&&(s.buf[s.pos++]=127&o|((o>>>=7)?128:0),o&&(s.buf[s.pos++]=127&o|((o>>>=7)?128:0),o&&(s.buf[s.pos++]=127&o)))))}(i,e)}(r,this):(this.realloc(4),this.buf[this.pos++]=127&r|(r>127?128:0),r<=127||(this.buf[this.pos++]=127&(r>>>=7)|(r>127?128:0),r<=127||(this.buf[this.pos++]=127&(r>>>=7)|(r>127?128:0),r<=127||(this.buf[this.pos++]=r>>>7&127))))},writeSVarint:function(r){this.writeVarint(r<0?2*-r-1:2*r)},writeBoolean:function(r){this.writeVarint(!!r)},writeString:function(r){r=String(r),this.realloc(4*r.length),this.pos++;var t=this.pos;this.pos=function(n,i,o){for(var s,a,l=0;l<i.length;l++){if((s=i.charCodeAt(l))>55295&&s<57344){if(!a){s>56319||l+1===i.length?(n[o++]=239,n[o++]=191,n[o++]=189):a=s;continue}if(s<56320){n[o++]=239,n[o++]=191,n[o++]=189,a=s;continue}s=a-55296<<10|s-56320|65536,a=null}else a&&(n[o++]=239,n[o++]=191,n[o++]=189,a=null);s<128?n[o++]=s:(s<2048?n[o++]=s>>6|192:(s<65536?n[o++]=s>>12|224:(n[o++]=s>>18|240,n[o++]=s>>12&63|128),n[o++]=s>>6&63|128),n[o++]=63&s|128)}return o}(this.buf,r,this.pos);var e=this.pos-t;e>=128&&pC(t,e,this),this.pos=t-1,this.writeVarint(e),this.pos+=e},writeFloat:function(r){this.realloc(4),Nd.write(this.buf,r,this.pos,!0,23,4),this.pos+=4},writeDouble:function(r){this.realloc(8),Nd.write(this.buf,r,this.pos,!0,52,8),this.pos+=8},writeBytes:function(r){var t=r.length;this.writeVarint(t),this.realloc(t);for(var e=0;e<t;e++)this.buf[this.pos++]=r[e]},writeRawMessage:function(r,t){this.pos++;var e=this.pos;r(t,this);var n=this.pos-e;n>=128&&pC(e,n,this),this.pos=e-1,this.writeVarint(n),this.pos+=n},writeMessage:function(r,t,e){this.writeTag(r,fn.Bytes),this.writeRawMessage(t,e)},writePackedVarint:function(r,t){t.length&&this.writeMessage(r,l8,t)},writePackedSVarint:function(r,t){t.length&&this.writeMessage(r,h8,t)},writePackedBoolean:function(r,t){t.length&&this.writeMessage(r,f8,t)},writePackedFloat:function(r,t){t.length&&this.writeMessage(r,u8,t)},writePackedDouble:function(r,t){t.length&&this.writeMessage(r,c8,t)},writePackedFixed32:function(r,t){t.length&&this.writeMessage(r,d8,t)},writePackedSFixed32:function(r,t){t.length&&this.writeMessage(r,p8,t)},writePackedFixed64:function(r,t){t.length&&this.writeMessage(r,g8,t)},writePackedSFixed64:function(r,t){t.length&&this.writeMessage(r,m8,t)},writeBytesField:function(r,t){this.writeTag(r,fn.Bytes),this.writeBytes(t)},writeFixed32Field:function(r,t){this.writeTag(r,fn.Fixed32),this.writeFixed32(t)},writeSFixed32Field:function(r,t){this.writeTag(r,fn.Fixed32),this.writeSFixed32(t)},writeFixed64Field:function(r,t){this.writeTag(r,fn.Fixed64),this.writeFixed64(t)},writeSFixed64Field:function(r,t){this.writeTag(r,fn.Fixed64),this.writeSFixed64(t)},writeVarintField:function(r,t){this.writeTag(r,fn.Varint),this.writeVarint(t)},writeSVarintField:function(r,t){this.writeTag(r,fn.Varint),this.writeSVarint(t)},writeStringField:function(r,t){this.writeTag(r,fn.Bytes),this.writeString(t)},writeFloatField:function(r,t){this.writeTag(r,fn.Fixed32),this.writeFloat(t)},writeDoubleField:function(r,t){this.writeTag(r,fn.Fixed64),this.writeDouble(t)},writeBooleanField:function(r,t){this.writeVarintField(r,!!t)}},o8(a8);const mC=23.25,yC={polygonPatternFile:1,markerFile:1,markerPlacement:1,markerSpacing:1,textName:1,textFaceName:1,textPlacement:1,textSpacing:1,lineJoin:1,lineCap:1,linePatternFile:1},vC={visible:1,textHorizontalAlignment:1,textVerticalAlignment:1,textWrapWidth:1,markerHorizontalAlignment:1,markerVerticalAlignment:1},xC={lineDasharray:1,topPolygonFill:1,bottomPolygonFill:1};Object.assign(vC,yC),Object.assign(xC,yC);/*!
* Contains code from jquery.easing
* BSD License
* https://github.com/gdsmith/jquery.easing/
*/var Nn=Math.pow,jd=Math.sqrt,Vu=Math.sin,_C=Math.cos,Gu=Math.PI,Vd=1.70158,Gd=Vd*1.525,bC=Vd+1,wC=2*Gu/3,AC=2*Gu/4.5;function Ud(r){var t=7.5625,e=2.75;return r<1/e?t*r*r:r<2/e?t*(r-=1.5/e)*r+.75:r<2.5/e?t*(r-=2.25/e)*r+.9375:t*(r-=2.625/e)*r+.984375}function y8(r,t){switch(r=r.toLowerCase(),r){case"swing":return v8(t);case"easeinquad":return TC(t);case"easeoutquad":return x8(t);case"easeinoutquad":return _8(t);case"easeincubic":return b8(t);case"easeoutcubic":return w8(t);case"easeinoutcubic":return A8(t);case"easeinquart":return T8(t);case"easeoutquart":return M8(t);case"easeinoutquart":return S8(t);case"easeinquint":return C8(t);case"easeoutquint":return P8(t);case"easeinoutquint":return E8(t);case"easeinsine":return O8(t);case"easeoutsine":return k8(t);case"easeinoutsine":return I8(t);case"easeinexpo":return R8(t);case"easeoutexpo":return D8(t);case"easeinoutexpo":return F8(t);case"easeincirc":return L8(t);case"easeoutcirc":return z8(t);case"easeinoutcirc":return H8(t);case"easeinelastic":return N8(t);case"easeoutelastic":return B8(t);case"easeinoutelastic":return j8(t);case"easeinback":return V8(t);case"easeoutback":return G8(t);case"easeinoutback":return U8(t);case"easeinbounce":return $8(t);case"easeoutbounce":return W8(t);case"easeinoutbounce":return Z8(t)}throw new Error("Unsupported easing function:"+r)}function v8(r){return TC(r)}function TC(r){return r*r}function x8(r){return 1-(1-r)*(1-r)}function _8(r){return r<.5?2*r*r:1-Nn(-2*r+2,2)/2}function b8(r){return r*r*r}function w8(r){return 1-Nn(1-r,3)}function A8(r){return r<.5?4*r*r*r:1-Nn(-2*r+2,3)/2}function T8(r){return r*r*r*r}function M8(r){return 1-Nn(1-r,4)}function S8(r){return r<.5?8*r*r*r*r:1-Nn(-2*r+2,4)/2}function C8(r){return r*r*r*r*r}function P8(r){return 1-Nn(1-r,5)}function E8(r){return r<.5?16*r*r*r*r*r:1-Nn(-2*r+2,5)/2}function O8(r){return 1-_C(r*Gu/2)}function k8(r){return Vu(r*Gu/2)}function I8(r){return-(_C(Gu*r)-1)/2}function R8(r){return r===0?0:Nn(2,10*r-10)}function D8(r){return r===1?1:1-Nn(2,-10*r)}function F8(r){return r===0?0:r===1?1:r<.5?Nn(2,20*r-10)/2:(2-Nn(2,-20*r+10))/2}function L8(r){return 1-jd(1-Nn(r,2))}function z8(r){return jd(1-Nn(r-1,2))}function H8(r){return r<.5?(1-jd(1-Nn(2*r,2)))/2:(jd(1-Nn(-2*r+2,2))+1)/2}function N8(r){return r===0?0:r===1?1:-Nn(2,10*r-10)*Vu((r*10-10.75)*wC)}function B8(r){return r===0?0:r===1?1:Nn(2,-10*r)*Vu((r*10-.75)*wC)+1}function j8(r){return r===0?0:r===1?1:r<.5?-(Nn(2,20*r-10)*Vu((20*r-11.125)*AC))/2:Nn(2,-20*r+10)*Vu((20*r-11.125)*AC)/2+1}function V8(r){return bC*r*r*r-Vd*r*r}function G8(r){return 1+bC*Nn(r-1,3)+Vd*Nn(r-1,2)}function U8(r){return r<.5?Nn(2*r,2)*((Gd+1)*2*r-Gd)/2:(Nn(2*r-2,2)*((Gd+1)*(r*2-2)+Gd)+2)/2}function $8(r){return 1-Ud(1-r)}function W8(r){return Ud(r)}function Z8(r){return r<.5?(1-Ud(1-2*r))/2:(1+Ud(2*r-1))/2}function $d(){}const Bn=$d.prototype;Bn.getType=function(){return Object.getPrototypeOf(this).constructor.type},Bn.isVisible=function(){throw new Error("to be implemented.")},Bn.prepareRender=function(){throw new Error("to be implemented.")},Bn.updateCollision=function(){throw new Error("to be implemented.")},Bn.supportRenderMode=function(){throw new Error("to be implemented.")},Bn.startFrame=function(){throw new Error("to be implemented.")},Bn.endFrame=function(){throw new Error("to be implemented.")},Bn.paintTile=function(){throw new Error("to be implemented.")},Bn.getShadowMeshes=function(){throw new Error("to be implemented.")},Bn.updateSceneConfig=function(){throw new Error("to be implemented.")},Bn.updateDataConfig=function(){throw new Error("to be implemented.")},Bn.updateSymbol=function(){throw new Error("to be implemented.")},Bn.pick=function(){throw new Error("to be implemented.")},Bn.resize=function(){throw new Error("to be implemented.")},Bn.deleteTile=function(){throw new Error("to be implemented.")},Bn.remove=function(){throw new Error("to be implemented.")},Bn.needToRedraw=function(){throw new Error("to be implemented.")},Bn.needToRetireFrames=function(){throw new Error("to be implemented.")},Bn.outline=function(){throw new Error("to be implemented.")},Bn.outlineAll=function(){throw new Error("to be implemented.")},Bn.needPolygonOffset=function(){throw new Error("to be implemented.")},Bn.constructor=$d;const X8=Object.prototype.hasOwnProperty;$d.extend=function(r,t){const e=function(){this.init&&this.init()},n=Object.create(Bn);n.constructor=e,e.prototype=n,e.type=r;for(const i in t)X8.call(t,i)&&(e.prototype[i]=t[i]);return e.registerAt=Y8.bind(e),e};function Y8(r){r.registerPlugin(this)}function q8(r,t,e,n,i){MC(r,t,e||0,n||r.length-1,i||J8)}function MC(r,t,e,n,i){for(;n>e;){if(n-e>600){var o=n-e+1,s=t-e+1,a=Math.log(o),l=.5*Math.exp(2*a/3),h=.5*Math.sqrt(a*l*(o-l)/o)*(s-o/2<0?-1:1),u=Math.max(e,Math.floor(t-s*l/o+h)),c=Math.min(n,Math.floor(t+(o-s)*l/o+h));MC(r,t,u,c,i)}var f=r[t],d=e,p=n;for(Uu(r,e,t),i(r[n],f)>0&&Uu(r,e,n);d<p;){for(Uu(r,d,p),d++,p--;i(r[d],f)<0;)d++;for(;i(r[p],f)>0;)p--}i(r[e],f)===0?Uu(r,e,p):(p++,Uu(r,p,n)),p<=t&&(e=p+1),t<=p&&(n=p-1)}}function Uu(r,t,e){var n=r[t];r[t]=r[e],r[e]=n}function J8(r,t){return r<t?-1:r>t?1:0}class SC{constructor(t=9){this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),this.clear()}all(){return this._all(this.data,[])}search(t){let e=this.data;const n=[];if(!Zd(t,e))return n;const i=this.toBBox,o=[];for(;e;){for(let s=0;s<e.children.length;s++){const a=e.children[s],l=e.leaf?i(a):a;Zd(t,l)&&(e.leaf?n.push(a):mv(t,l)?this._all(a,n):o.push(a))}e=o.pop()}return n}collides(t){let e=this.data;if(!Zd(t,e))return!1;const n=[];for(;e;){for(let i=0;i<e.children.length;i++){const o=e.children[i],s=e.leaf?this.toBBox(o):o;if(Zd(t,s)){if(e.leaf||mv(t,s))return!0;n.push(o)}}e=n.pop()}return!1}load(t){if(!(t&&t.length))return this;if(t.length<this._minEntries){for(let n=0;n<t.length;n++)this.insert(t[n]);return this}let e=this._build(t.slice(),0,t.length-1,0);if(!this.data.children.length)this.data=e;else if(this.data.height===e.height)this._splitRoot(this.data,e);else{if(this.data.height<e.height){const n=this.data;this.data=e,e=n}this._insert(e,this.data.height-e.height-1,!0)}return this}insert(t){return t&&this._insert(t,this.data.height-1),this}clear(){return this.data=Nl([]),this}remove(t,e){if(!t)return this;let n=this.data;const i=this.toBBox(t),o=[],s=[];let a,l,h;for(;n||o.length;){if(n||(n=o.pop(),l=o[o.length-1],a=s.pop(),h=!0),n.leaf){const u=K8(t,n.children,e);if(u!==-1)return n.children.splice(u,1),o.push(n),this._condense(o),this}!h&&!n.leaf&&mv(n,i)?(o.push(n),s.push(a),a=0,l=n,n=n.children[0]):l?(a++,n=l.children[a],h=!1):n=null}return this}toBBox(t){return t}compareMinX(t,e){return t.minX-e.minX}compareMinY(t,e){return t.minY-e.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}_all(t,e){const n=[];for(;t;)t.leaf?e.push(...t.children):n.push(...t.children),t=n.pop();return e}_build(t,e,n,i){const o=n-e+1;let s=this._maxEntries,a;if(o<=s)return a=Nl(t.slice(e,n+1)),Hl(a,this.toBBox),a;i||(i=Math.ceil(Math.log(o)/Math.log(s)),s=Math.ceil(o/Math.pow(s,i-1))),a=Nl([]),a.leaf=!1,a.height=i;const l=Math.ceil(o/s),h=l*Math.ceil(Math.sqrt(s));CC(t,e,n,h,this.compareMinX);for(let u=e;u<=n;u+=h){const c=Math.min(u+h-1,n);CC(t,u,c,l,this.compareMinY);for(let f=u;f<=c;f+=l){const d=Math.min(f+l-1,c);a.children.push(this._build(t,f,d,i-1))}}return Hl(a,this.toBBox),a}_chooseSubtree(t,e,n,i){for(;i.push(e),!(e.leaf||i.length-1===n);){let o=1/0,s=1/0,a;for(let l=0;l<e.children.length;l++){const h=e.children[l],u=gv(h),c=eB(t,h)-u;c<s?(s=c,o=u<o?u:o,a=h):c===s&&u<o&&(o=u,a=h)}e=a||e.children[0]}return e}_insert(t,e,n){const i=n?t:this.toBBox(t),o=[],s=this._chooseSubtree(i,this.data,e,o);for(s.children.push(t),Wu(s,i);e>=0&&o[e].children.length>this._maxEntries;)this._split(o,e),e--;this._adjustParentBBoxes(i,o,e)}_split(t,e){const n=t[e],i=n.children.length,o=this._minEntries;this._chooseSplitAxis(n,o,i);const s=this._chooseSplitIndex(n,o,i),a=Nl(n.children.splice(s,n.children.length-s));a.height=n.height,a.leaf=n.leaf,Hl(n,this.toBBox),Hl(a,this.toBBox),e?t[e-1].children.push(a):this._splitRoot(n,a)}_splitRoot(t,e){this.data=Nl([t,e]),this.data.height=t.height+1,this.data.leaf=!1,Hl(this.data,this.toBBox)}_chooseSplitIndex(t,e,n){let i,o=1/0,s=1/0;for(let a=e;a<=n-e;a++){const l=$u(t,0,a,this.toBBox),h=$u(t,a,n,this.toBBox),u=nB(l,h),c=gv(l)+gv(h);u<o?(o=u,i=a,s=c<s?c:s):u===o&&c<s&&(s=c,i=a)}return i||n-e}_chooseSplitAxis(t,e,n){const i=t.leaf?this.compareMinX:Q8,o=t.leaf?this.compareMinY:tB,s=this._allDistMargin(t,e,n,i),a=this._allDistMargin(t,e,n,o);s<a&&t.children.sort(i)}_allDistMargin(t,e,n,i){t.children.sort(i);const o=this.toBBox,s=$u(t,0,e,o),a=$u(t,n-e,n,o);let l=Wd(s)+Wd(a);for(let h=e;h<n-e;h++){const u=t.children[h];Wu(s,t.leaf?o(u):u),l+=Wd(s)}for(let h=n-e-1;h>=e;h--){const u=t.children[h];Wu(a,t.leaf?o(u):u),l+=Wd(a)}return l}_adjustParentBBoxes(t,e,n){for(let i=n;i>=0;i--)Wu(e[i],t)}_condense(t){for(let e=t.length-1,n;e>=0;e--)t[e].children.length===0?e>0?(n=t[e-1].children,n.splice(n.indexOf(t[e]),1)):this.clear():Hl(t[e],this.toBBox)}}function K8(r,t,e){if(!e)return t.indexOf(r);for(let n=0;n<t.length;n++)if(e(r,t[n]))return n;return-1}function Hl(r,t){$u(r,0,r.children.length,t,r)}function $u(r,t,e,n,i){i||(i=Nl(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let o=t;o<e;o++){const s=r.children[o];Wu(i,r.leaf?n(s):s)}return i}function Wu(r,t){return r.minX=Math.min(r.minX,t.minX),r.minY=Math.min(r.minY,t.minY),r.maxX=Math.max(r.maxX,t.maxX),r.maxY=Math.max(r.maxY,t.maxY),r}function Q8(r,t){return r.minX-t.minX}function tB(r,t){return r.minY-t.minY}function gv(r){return(r.maxX-r.minX)*(r.maxY-r.minY)}function Wd(r){return r.maxX-r.minX+(r.maxY-r.minY)}function eB(r,t){return(Math.max(t.maxX,r.maxX)-Math.min(t.minX,r.minX))*(Math.max(t.maxY,r.maxY)-Math.min(t.minY,r.minY))}function nB(r,t){const e=Math.max(r.minX,t.minX),n=Math.max(r.minY,t.minY),i=Math.min(r.maxX,t.maxX),o=Math.min(r.maxY,t.maxY);return Math.max(0,i-e)*Math.max(0,o-n)}function mv(r,t){return r.minX<=t.minX&&r.minY<=t.minY&&t.maxX<=r.maxX&&t.maxY<=r.maxY}function Zd(r,t){return t.minX<=r.maxX&&t.minY<=r.maxY&&t.maxX>=r.minX&&t.maxY>=r.minY}function Nl(r){return{children:r,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function CC(r,t,e,n,i){const o=[t,e];for(;o.length;){if(e=o.pop(),t=o.pop(),e-t<=n)continue;const s=t+Math.ceil((e-t)/n/2)*n;q8(r,s,t,e,i),o.push(t,s,s,e)}}/*!
 * @maptalks/vt v0.96.4
 * LICENSE : undefined
 * (c) 2016-2024 maptalks.org
 */const Tt="${",yv=`function(t){let n;const e={width:100,height:10};function r(){if(!n){const{width:t,height:r}=e;OffscreenCanvas?n=new OffscreenCanvas(t,r):(n=document.createElement("canvas"),n.width=t,n.height=r)}return n}class i{constructor(t,n={}){if(!Array.isArray(t))return void console.error("colors is not array");if(t.length<2)return void console.error("colors.length should >1");this.colors=t;let r=1/0,i=-1/0;for(let n=0,e=t.length;n<e;n++){const e=t[n][0];r=Math.min(e,r),i=Math.max(e,i)}this.min=r,this.max=i,this.valueOffset=this.max-this.min,this.options=Object.assign({},e,n),this.t()}getImageData(){return this.imgData}t(){const t=r(),{width:n,height:e}=this.options;t.width=n,t.height=e;const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);const s=i.createLinearGradient(0,0,t.width,0),{colors:o,valueOffset:a}=this;for(let t=0,n=o.length;t<n;t++){const[n,e]=o[t],r=(n-this.min)/a;s.addColorStop(r,e)}i.fillStyle=s,i.fillRect(0,0,t.width,t.height),this.imgData=i.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t);const n=((t=Math.min(t,this.max))-this.min)/this.valueOffset;let e=Math.round(n*this.imgData.width);e=Math.min(e,this.imgData.width-1);const r=4*e;return[this.imgData.data[r],this.imgData.data[r+1],this.imgData.data[r+2],this.imgData.data[r+3]]}}var s;function o(t,n){var e,r,i;if(y(t)){var s,h=t.stops&&"object"==typeof t.stops[0][0],d=h||void 0!==t.property,p=h||!d,m=t.type||n||"exponential";if("exponential"===m)s=l;else if("interval"===m)s=u;else if("categorical"===m)s=a;else if("identity"===m)s=f;else{if("color-interpolate"!==m)throw new Error('Unknown function type "'+m+'"');s=c}if(h){var g={},v=[];for(let n=0;n<t.stops.length;n++){var b=t.stops[n];void 0===g[b[0].zoom]&&(g[b[0].zoom]={zoom:b[0].zoom,type:t.type,property:t.property,default:t.default,stops:[]}),g[b[0].zoom].stops.push([b[0].value,b[1]])}for(let t in g)v.push([g[t].zoom,o(g[t])]);e=function(n,e){const r=l({stops:v,base:t.base},n)(n,e);return"function"==typeof r?r(n,e):r},r=!1,i=!1}else p?(e=function(n){const e=s(t,n);return"function"==typeof e?e(n):e},r=!0,i=!1):(e=function(n,e){const r=s(t,e?e[t.property]:null);return"function"==typeof r?r(n,e):r},r=!1,i=!0)}else e=function(){return t},r=!0,i=!0;return e.isZoomConstant=i,e.isFeatureConstant=r,e}function a(t,n){for(let e=0;e<t.stops.length;e++)if(n===t.stops[e][0])return t.stops[e][1];return t.default}function u(t,n){for(var e=0;e<t.stops.length&&!(n<t.stops[e][0]);e++);return t.stops[Math.max(e-1,0)][1]}function l(t,n){for(var e=void 0!==t.base?t.base:1,r=0;!(r>=t.stops.length||n<=t.stops[r][0]);)r++;return 0===r?t.stops[r][1]:r===t.stops.length?t.stops[r-1][1]:d(n,e,t.stops[r-1][0],t.stops[r][0],t.stops[r-1][1],t.stops[r][1])}"function"==typeof Map&&(s=new Map);const h={width:100,height:1};function c(t,n){const e=t.stops;if(e&&e.length>1){let t;if(s){const n=JSON.stringify(e);if(!s.has(n)){const t=new i(e,h);s.set(n,t)}t=s.get(n)}else t=new i(e,h);const[r,o,a,u]=t.getColor(n);return[r/255,o/255,a/255,u/255]}return e&&1===e.length?e[0][1]:null}function f(t,n){return function(t,n,e){return void 0!==t?t:void 0!==n?n:null}(n,t.default)}function d(t,n,e,r,i,s){return"function"==typeof i?function(){var o=i.apply(void 0,arguments),a=s.apply(void 0,arguments);return d(t,n,e,r,o,a)}:i.length?function(t,n,e,r,i,s){var o=[];for(let a=0;a<i.length;a++)o[a]=p(t,n,e,r,i[a],s[a]);return o}(t,n,e,r,i,s):p(t,n,e,r,i,s)}function p(t,n,e,r,i,s){var o,a=r-e,u=t-e;return i*(1-(o=1===n?u/a:(Math.pow(n,u)-1)/(Math.pow(n,a)-1)))+s*o}function y(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type)}function m(t){return b(t,"exponential")}function g(t){return b(t,"interval")}function v(t,n){if(!t)return null;var e=!1;if(Array.isArray(t)){var r,i=[];for(let s=0;s<t.length;s++)(r=v(t[s],n))?(i.push(r),e=!0):i.push(t[s]);return e?i:t}var s,o={__fn_types_loaded:!0},a=[];for(s in t)t.hasOwnProperty(s)&&a.push(s);const u=function(t){Object.defineProperty(o,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=m(this["_"+t])),this["__fn_"+t].apply(this,n())},set:function(n){this["_"+t]=n},configurable:!0,enumerable:!0})};for(let n=0,r=a.length;n<r;n++)y(t[s=a[n]])?(e=!0,o["_"+s]=t[s],u(s)):o[s]=t[s];return e?o:t}function b(t,n){if(!y(t))return function(){return t};let e=!0,r=!0;const i=(t=JSON.parse(JSON.stringify(t))).stops;if(i)for(let t=0;t<i.length;t++)if(y(i[t][1])){const s=b(i[t][1],n);e=e&&s.isZoomConstant,r=r&&s.isFeatureConstant,i[t]=[i[t][0],s]}const s=o(t,n);return s.isZoomConstant=e&&s.isZoomConstant,s.isFeatureConstant=r&&s.isFeatureConstant,s}let w=0;const M="function"==typeof Object.assign;function x(t,...n){if(M)return Object.assign(t,...n),t;for(let e=0;e<n.length;e++){const r=n[e];for(const n in r)t[n]=r[n]}return t}function F(t){return!S(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function k(t){return"number"==typeof t&&!isNaN(t)}function A(t){return!S(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}function P(t){return!Array.isArray(t)&&"object"==typeof t&&!!t}function S(t){return null==t}function _(t){return y(t)&&t.property}const O="function"==typeof fetch&&"function"==typeof AbortController,C={jsonp:function(t,n){const e="_maptalks_jsonp_"+w++;t.match(/\\?/)?t+="&callback="+e:t+="?callback="+e;let r=document.createElement("script");return r.type="text/javascript",r.src=t,window[e]=function(t){n(null,t),document.getElementsByTagName("head")[0].removeChild(r),r=null,delete window[e]},document.getElementsByTagName("head")[0].appendChild(r),this},get:function(t,n,e){if(A(n)){const t=e;e=n,n=t}(n=n||{}).method&&(n.method=n.method.toUpperCase());const r="POST"===n.method;if(O){const r=new AbortController,i=n;i.signal=r.signal,i.referrerPolicy=i.referrerPolicy||"origin",i.method=i.method||"GET";const s=new Request(t,i);return n.returnJSON&&s.headers.set("Accept","application/json"),fetch(s).then((r=>{const i=this.o(r,n.returnJSON,n.responseType);i.message?(i.url=t,e(i)):i.then((t=>{"arraybuffer"===n.responseType?e(null,{data:t,cacheControl:r.headers.get("Cache-Control"),expires:r.headers.get("Expires"),contentType:r.headers.get("Content-Type")}):e(null,t)})).catch((n=>{n.code&&n.code===DOMException.ABORT_ERR||(console.error("Fetch error:",t,n),e(n))}))})).catch((n=>{n.code&&n.code===DOMException.ABORT_ERR||(console.error("Fetch error:",t,n),e(n))})),r}{const i=C.u(e);if(i.open(n.method||"GET",t,!0),n){for(const t in n.headers)i.setRequestHeader(t,n.headers[t]);i.withCredentials="include"===n.credentials,n.responseType&&(i.responseType=n.responseType)}return i.send(r?n.body:null),i}},o:(t,n,e)=>200!==t.status?{status:t.status,statusText:t.statusText,message:\`incorrect http request with status code(${Tt}t.status}): ${Tt}t.statusText}\`}:"arraybuffer"===e?t.arrayBuffer():n?t.json():t.text(),m:function(t,n){return function(){if(4===t.readyState)if(200===t.status)if("arraybuffer"===t.responseType){0===t.response.byteLength?n({status:200,statusText:t.statusText,message:"http status 200 returned without content."}):n(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")})}else n(null,t.responseText);else n({status:t.status,statusText:t.statusText,message:\`incorrect http request with status code(${Tt}t.status}): ${Tt}t.statusText}\`})}},u:function(t){let n;try{n=new XMLHttpRequest}catch(t){try{n=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{n=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}}return n.onreadystatechange=C.m(n,t),n},getArrayBuffer(t,n,e){if(A(n)){const t=e;e=n,n=t}return n||(n={}),n.responseType="arraybuffer",C.get(t,n,e)}};function E(t,n,e,r,i=3){let s=r;const o=e-n>>1;let a,u=e-n;const l=t[n],h=t[n+1],c=t[e],f=t[e+1];for(let r=n+i;r<e;r+=i){const n=I(t[r],t[r+1],l,h,c,f);if(n>s)a=r,s=n;else if(n===s){const t=Math.abs(r-o);t<u&&(a=r,u=t)}}s>r&&(a-n>i&&E(t,n,a,r,i),t[a+2]=s,e-a>i&&E(t,a,e,r,i))}function I(t,n,e,r,i,s){let o=i-e,a=s-r;if(0!==o||0!==a){const u=((t-e)*o+(n-r)*a)/(o*o+a*a);u>1?(e=i,r=s):u>0&&(e+=o*u,r+=a*u)}return o=t-e,a=n-r,o*o+a*a}function $(t,n,e,r,i,s){const o={id:null==t?null:t,type:n,geometry:e,tags:r,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};i&&(o.layer=i);return function(t,n){const e=t.geometry,r=t.type;if("Point"===r||"MultiPoint"===r||"LineString"===r)T(t,e,n);else if("Polygon"===r)T(t,e[0],n);else if("MultiLineString"===r)for(const r of e)T(t,r,n);else if("MultiPolygon"===r)for(const r of e)T(t,r[0],n)}(o,s?4:3),o}function T(t,n,e){for(let r=0;r<n.length;r+=e)t.minX=Math.min(t.minX,n[r]),t.minY=Math.min(t.minY,n[r+1]),t.maxX=Math.max(t.maxX,n[r]),t.maxY=Math.max(t.maxY,n[r+1])}function D(t,n,e,r){if(r.layer=n,"FeatureCollection"===e.type)for(let n=0;n<e.features.length;n++)z(t,e.features[n],r,n);else"Feature"===e.type?z(t,e,r):z(t,{geometry:e},r)}function z(t,n,e,r){if(!n.geometry)return;const i=n.geometry.coordinates,s=n.geometry.type,o=Math.pow(e.tolerance/((1<<e.maxZoom)*e.extent),2);let a=[],u=n.id;if(e.promoteId?u=n.properties[e.promoteId]:e.generateId&&(u=r||0),"Point"===s)j(i,a,e);else if("MultiPoint"===s)for(const t of i)j(t,a,e);else if("LineString"===s)U(i,a,o,!1,e);else if("MultiLineString"===s){if(e.lineMetrics){for(const r of i)a=[],U(r,a,o,!1,e),t.push($(u,"LineString",a,n.properties,e.layer,e.hasAltitude));return}N(i,a,o,!1,e)}else if("Polygon"===s)N(i,a,o,!0,e);else{if("MultiPolygon"!==s){if("GeometryCollection"===s){for(const i of n.geometry.geometries)z(t,{id:u,geometry:i,properties:n.properties},e,r);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const t of i){const n=[];N(t,n,o,!0,e),a.push(n)}}t.push($(u,s,a,n.properties,e.layer,e.hasAltitude))}function j(t,n,e){n.push(L(t[0]),R(t[1],e.projection),0),e.hasAltitude&&(t.length>2?n.push(t[2]):n.push(0))}function U(t,n,e,r,i){let s,o,a=0;for(let e=0;e<t.length;e++){const u=L(t[e][0]),l=R(t[e][1],i.projection);n.push(u,l,0),i.hasAltitude&&(t[e].length>2?n.push(t[e][2]):n.push(0)),e>0&&(a+=r?(s*l-u*o)/2:Math.sqrt(Math.pow(u-s,2)+Math.pow(l-o,2))),s=u,o=l}const u=i.hasAltitude?4:3,l=n.length-u;n[2]=1,E(n,0,l,e,u),n[l+2]=1,n.size=Math.abs(a),n.start=0,n.end=n.size}function N(t,n,e,r,i){for(let s=0;s<t.length;s++){const o=[];U(t[s],o,e,r,i),n.push(o)}}function L(t){return t/360+.5}function R(t,n){if("EPSG:4326"===n)return(90-t)/360;const e=Math.sin(t*Math.PI/180),r=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return r<0?0:r>1?1:r}function V(t,n,e,r,i,s,o,a){if(r/=n,s>=(e/=n)&&o<r)return t;if(o<e||s>=r)return null;const u=[];for(const n of t){const t=n.geometry;let s=n.type;const o=0===i?n.minX:n.minY,l=0===i?n.maxX:n.maxY;if(o>=e&&l<r){u.push(n);continue}if(l<e||o>=r)continue;let h=[];if("Point"===s||"MultiPoint"===s)H(t,h,e,r,i,a.hasAltitude);else if("LineString"===s)q(t,h,e,r,i,!1,a.lineMetrics,a.hasAltitude);else if("MultiLineString"===s)J(t,h,e,r,i,!1,a.hasAltitude);else if("Polygon"===s)J(t,h,e,r,i,!0,a.hasAltitude);else if("MultiPolygon"===s)for(const n of t){const t=[];J(n,t,e,r,i,!0,a.hasAltitude),t.length&&h.push(t)}if(h.length){if(a.lineMetrics&&"LineString"===s){for(const t of h)u.push($(n.id,s,t,n.tags,n.layer,a.hasAltitude));continue}"LineString"!==s&&"MultiLineString"!==s||(1===h.length?(s="LineString",h=h[0]):s="MultiLineString"),"Point"!==s&&"MultiPoint"!==s||(s=3===h.length?"Point":"MultiPoint"),u.push($(n.id,s,h,n.tags,n.layer,a.hasAltitude))}}return u.length?u:null}function H(t,n,e,r,i,s){const o=s?4:3;for(let a=0;a<t.length;a+=o){const o=t[a+i];o>=e&&o<=r&&(W(n,t[a],t[a+1],t[a+2]),s&&n.push(t[a+3]))}}function q(t,n,e,r,i,s,o,a){let u=G(t);const l=0===i?B:X;let h,c,f=t.start;const d=a?4:3,p=s?t.length:t.length-d;for(let y=0;y<p;y+=d){const m=t[y],g=t[y+1],v=t[y+2];let b,w,M,x;s&&y===p-d?(b=t[0],w=t[1]):(b=t[y+d],w=t[y+d+1]),a&&(M=t[y+3],x=s&&y===p-d?t[3]:t[y+d+3]);const F=0===i?m:g,k=0===i?b:w;let A=!1;o&&(h=Math.sqrt(Math.pow(m-b,2)+Math.pow(g-w,2))),F<e?k>e&&(c=l(u,m,g,b,w,e),a&&u.push(Y(M,x,c)),o&&(u.start=f+h*c)):F>r?k<r&&(c=l(u,m,g,b,w,r),a&&u.push(Y(M,x,c)),o&&(u.start=f+h*c)):(W(u,m,g,v),a&&u.push(M)),k<e&&F>=e&&(c=l(u,m,g,b,w,e),a&&u.push(Y(M,x,c)),A=!0),k>r&&F<=r&&(c=l(u,m,g,b,w,r),a&&u.push(Y(M,x,c)),A=!0),!s&&A&&(o&&(u.end=f+h*c),n.push(u),u=G(t)),o&&(f+=h)}let y=t.length-d;if(!s){const n=t[y],s=t[y+1],o=t[y+2],l=0===i?n:s;if(l>=e&&l<=r&&W(u,n,s,o),l>=e&&l<=r&&a){const n=t[y+3];u.push(n)}}y=u.length-d,s&&y>=d&&(u[y]!==u[0]||u[y+1]!==u[1])&&(W(u,u[0],u[1],u[2]),a&&u.push(u[3])),u.length&&n.push(u)}function G(t){const n=[];return n.size=t.size,n.start=t.start,n.end=t.end,n}function J(t,n,e,r,i,s,o){for(const a of t)q(a,n,e,r,i,s,!1,o)}function W(t,n,e,r){t.push(n,e,r)}function B(t,n,e,r,i,s){const o=(s-n)/(r-n);return W(t,s,e+(i-e)*o,1),o}function X(t,n,e,r,i,s){const o=(s-e)/(i-e);return W(t,n+(r-n)*o,s,1),o}function Y(t,n,e){return t+(n-t)*e}function K(t,n,e){const r=[];for(let i=0;i<t.length;i++){const s=t[i],o=s.type;let a;if("Point"===o||"MultiPoint"===o||"LineString"===o)a=Z(s.geometry,n,e);else if("MultiLineString"===o||"Polygon"===o){a=[];for(const t of s.geometry)a.push(Z(t,n,e))}else if("MultiPolygon"===o){a=[];for(const t of s.geometry){const r=[];for(const i of t)r.push(Z(i,n,e));a.push(r)}}r.push($(s.id,o,a,s.tags,s.layer,e))}return r}function Z(t,n,e){const r=[];r.size=t.size,void 0!==t.start&&(r.start=t.start,r.end=t.end);const i=e?4:3;for(let s=0;s<t.length;s+=i)r.push(t[s]+n,t[s+1],t[s+2]),e&&r.push(t[s+3]);return r}function Q(t,n,e){if(t.transformed)return t;const r=1<<t.z,i=t.x,s=t.y,o=e?3:2;for(const a of t.features){const t=a.geometry,u=a.type;if(a.geometry=[],1===u)for(let u=0;u<t.length;u+=o)a.geometry.push(tt(t[u],t[u+1],n,r,i,s)),e&&a.geometry[a.geometry.length-1].push(t[u+2]);else for(let u=0;u<t.length;u++){const l=[];for(let a=0;a<t[u].length;a+=o)l.push(tt(t[u][a],t[u][a+1],n,r,i,s)),e&&l[l.length-1].push(t[u][a+2]);a.geometry.push(l)}}return t.transformed=!0,t}function tt(t,n,e,r,i,s){return[Math.round(e*(t*r-i)),Math.round(e*(n*r-s))]}function nt(t,n,e,r,i){const s=n===i.maxZoom?0:i.tolerance/((1<<n)*i.extent),o={features:[],numPoints:0,numSimplified:0,numFeatures:t.length,source:null,x:e,y:r,z:n,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const n of t)et(o,n,s,i);return o}function et(t,n,e,r){const i=n.geometry,s=n.type,o=[],a=r.hasAltitude?4:3;if(t.minX=Math.min(t.minX,n.minX),t.minY=Math.min(t.minY,n.minY),t.maxX=Math.max(t.maxX,n.maxX),t.maxY=Math.max(t.maxY,n.maxY),"Point"===s||"MultiPoint"===s)for(let n=0;n<i.length;n+=a)o.push(i[n],i[n+1]),r.hasAltitude&&o.push(i[n+3]),t.numPoints++,t.numSimplified++;else if("LineString"===s)it(o,i,t,e,!1,!1,r);else if("MultiLineString"===s||"Polygon"===s)for(let n=0;n<i.length;n++)it(o,i[n],t,e,"Polygon"===s,0===n,r);else if("MultiPolygon"===s)for(let n=0;n<i.length;n++){const s=i[n];for(let n=0;n<s.length;n++)it(o,s[n],t,e,!0,0===n,r)}if(o.length){let e=n.tags||null;if("LineString"===s&&r.lineMetrics){e={};for(const t in n.tags)e[t]=n.tags[t];e.mapbox_clip_start=i.start/i.size,e.mapbox_clip_end=i.end/i.size}const a={geometry:o,type:"Polygon"===s||"MultiPolygon"===s?3:"LineString"===s||"MultiLineString"===s?2:1,tags:e};n.layer&&(a.layer=n.layer),null!==n.id&&(a.id=n.id),t.features.push(a)}}function rt(t,n,e){return 0===t[n+2]&&t[n+3]>0&&e}function it(t,n,e,r,i,s,o){const a=r*r,{hasAltitude:u,disableFilter:l}=o,h=u?4:3;if(!l&&r>0&&n.size<(i?a:r))return void(e.numPoints+=n.length/h);const c=[];for(let t=0;t<n.length;t+=h)(0===r||n[t+2]>a||rt(n,t,u))&&(e.numSimplified++,c.push(n[t],n[t+1]),u&&c.push(n[t+3])),e.numPoints++;i&&function(t,n,e){const r=e?3:2;let i=0;for(let n=0,e=t.length,s=e-r;n<e;s=n,n+=r)i+=(t[n]-t[s])*(t[n+1]+t[s+1]);if(i>0===n){const n=r,i=r-1,s=r-2;for(let o=0,a=t.length;o<a/2;o+=r){const r=t[o],u=t[o+1];let l;e&&(l=t[o+2]),t[o]=t[a-n-o],t[o+1]=t[a-i-o],e&&(t[o+2]=t[a-s-o]),t[a-n-o]=r,t[a-i-o]=u,e&&(t[a-s-o]=l)}}}(c,s,u),t.push(c)}C.getJSON=function(t,n,e){if(A(n)){const t=e;e=n,n=t}const r=function(t,n){const r="string"==typeof n?JSON.parse(n):n||null;e(t,r)};return n&&n.jsonp?C.jsonp(t,r):((n=n||{}).returnJSON=!0,C.get(t,n,r))};const st={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,hasAltitude:!1,disableFilter:!1,debug:0};class ot{constructor(t,n){const e=(n=this.options=function(t,n){for(const e in n)t[e]=n[e];return t}(Object.create(st),n)).debug;if(e&&console.time("preprocess data"),n.maxZoom<0||n.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(n.promoteId&&n.generateId)throw new Error("promoteId and generateId cannot be used together.");let r=function(t,n){const e=[];if(Array.isArray(t)){for(let r=0;r<t.length;r++)D(e,t[r].layer,t[r].data,n);return e}if("FeatureCollection"===t.type)for(let r=0;r<t.features.length;r++)z(e,t.features[r],n,r);else"Feature"===t.type?z(e,t,n):z(e,{geometry:t},n);return e}(t,n);this.tiles={},this.tileCoords=[],e&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",n.indexMaxZoom,n.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),r=function(t,n){const e=n.buffer/n.extent;let r=t;const i=V(t,1,-1-e,e,0,-1,2,n),s=V(t,1,1-e,2+e,0,-1,2,n);return(i||s)&&(r=V(t,1,-e,1+e,0,-1,2,n)||[],i&&(r=K(i,1,n.hasAltitude).concat(r)),s&&(r=r.concat(K(s,-1,n.hasAltitude)))),r}(r,n),r.length&&this.splitTile(r,0,0,0),e&&(r.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(t,n,e,r,i,s,o){const a=[t,n,e,r],u=this.options,l=u.debug;for(;a.length;){r=a.pop(),e=a.pop(),n=a.pop(),t=a.pop();const h=1<<n,c=at(n,e,r);let f=this.tiles[c];if(!f&&(l>1&&console.time("creation"),f=this.tiles[c]=nt(t,n,e,r,u),this.tileCoords.push({z:n,x:e,y:r}),l)){l>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",n,e,r,f.numFeatures,f.numPoints,f.numSimplified),console.timeEnd("creation"));const t=\`z${Tt}n}\`;this.stats[t]=(this.stats[t]||0)+1,this.total++}if(f.source=t,null==i){if(n===u.indexMaxZoom||f.numPoints<=u.indexMaxPoints)continue}else{if(n===u.maxZoom||n===i)continue;if(null!=i){const t=i-n;if(e!==s>>t||r!==o>>t)continue}}if(f.source=null,0===t.length)continue;l>1&&console.time("clipping");const d=.5*u.buffer/u.extent,p=.5-d,y=.5+d,m=1+d;let g=null,v=null,b=null,w=null,M=V(t,h,e-d,e+y,0,f.minX,f.maxX,u),x=V(t,h,e+p,e+m,0,f.minX,f.maxX,u);t=null,M&&(g=V(M,h,r-d,r+y,1,f.minY,f.maxY,u),v=V(M,h,r+p,r+m,1,f.minY,f.maxY,u),M=null),x&&(b=V(x,h,r-d,r+y,1,f.minY,f.maxY,u),w=V(x,h,r+p,r+m,1,f.minY,f.maxY,u),x=null),l>1&&console.timeEnd("clipping"),a.push(g||[],n+1,2*e,2*r),a.push(v||[],n+1,2*e,2*r+1),a.push(b||[],n+1,2*e+1,2*r),a.push(w||[],n+1,2*e+1,2*r+1)}}getTile(t,n,e){t=+t,n=+n,e=+e;const r=this.options,{extent:i,debug:s}=r,{hasAltitude:o,wrapX:a}=r;if(t<0||t>24)return null;if(a){const e=1<<t;n=n+e&e-1}const u=at(t,n,e);if(this.tiles[u])return Q(this.tiles[u],i,o);s>1&&console.log("drilling down to z%d-%d-%d",t,n,e);let l,h=t,c=n,f=e;for(;!l&&h>0;)h--,c>>=1,f>>=1,l=this.tiles[at(h,c,f)];return l&&l.source?(s>1&&(console.log("found parent tile z%d-%d-%d",h,c,f),console.time("drilling down")),this.splitTile(l.source,h,c,f,t,n,e),s>1&&console.timeEnd("drilling down"),this.tiles[u]?Q(this.tiles[u],i,o):null):null}}function at(t,n,e){return 32*((1<<t)*e+n)+t}function ut(t,n,e,r,i,s,o){const a=e&&Array.isArray(e[0]);for(let u=0,l=e.length;u<l;u++){t[n]=(a?e[u][0]:e[u].x)*r,t[n+1]=(a?e[u][1]:e[u].y)*r,o!==Float32Array&&(t[n]=Math.round(t[n]),t[n+1]=Math.round(t[n+1]));let h=i||0;Array.isArray(i)&&(h=i[u]),h=h?Math.round(r*h):0,t[n+2]=h,n+=3,s&&0!==u&&u!==l-1&&(t[n]=t[n-3],t[n+1]=t[n-2],t[n+2]=t[n-1],n+=3)}return t.trySetLength&&t.trySetLength(n),n}function lt(t,n,e,r){const i=t[3*n],s=t[3*n+1],o=t[3*e],a=t[3*e+1];return i===o&&(i<0||i>r)||s===a&&(s<0||s>r)}"undefined"!=typeof undefinedThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof undefined?global:"undefined"!=typeof self&&self;function ht(t){return t&&t.M&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var ct=ft;function ft(t,n){this.x=t,this.y=n}ft.prototype={clone:function(){return new ft(this.x,this.y)},add:function(t){return this.clone().F(t)},sub:function(t){return this.clone().k(t)},multByPoint:function(t){return this.clone().A(t)},divByPoint:function(t){return this.clone().P(t)},mult:function(t){return this.clone().S(t)},div:function(t){return this.clone()._(t)},rotate:function(t){return this.clone().O(t)},rotateAround:function(t,n){return this.clone().C(t,n)},matMult:function(t){return this.clone().I(t)},unit:function(){return this.clone().T()},perp:function(){return this.clone().D()},round:function(){return this.clone().j()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var n=t.x-this.x,e=t.y-this.y;return n*n+e*e},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,n){return Math.atan2(this.x*n-this.y*t,this.x*t+this.y*n)},I:function(t){var n=t[0]*this.x+t[1]*this.y,e=t[2]*this.x+t[3]*this.y;return this.x=n,this.y=e,this},F:function(t){return this.x+=t.x,this.y+=t.y,this},k:function(t){return this.x-=t.x,this.y-=t.y,this},S:function(t){return this.x*=t,this.y*=t,this},_:function(t){return this.x/=t,this.y/=t,this},A:function(t){return this.x*=t.x,this.y*=t.y,this},P:function(t){return this.x/=t.x,this.y/=t.y,this},T:function(){return this._(this.mag()),this},D:function(){var t=this.y;return this.y=this.x,this.x=-t,this},O:function(t){var n=Math.cos(t),e=Math.sin(t),r=n*this.x-e*this.y,i=e*this.x+n*this.y;return this.x=r,this.y=i,this},C:function(t,n){var e=Math.cos(t),r=Math.sin(t),i=n.x+e*(this.x-n.x)-r*(this.y-n.y),s=n.y+r*(this.x-n.x)+e*(this.y-n.y);return this.x=i,this.y=s,this},j:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},ft.convert=function(t){return t instanceof ft?t:Array.isArray(t)?new ft(t[0],t[1]):t};var dt=ht(ct);function pt(t,n,e){e=e||{},this.w=t||64,this.h=n||64,this.autoResize=!!e.autoResize,this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0}function yt(t,n,e){this.x=0,this.y=t,this.w=this.free=n,this.h=e}function mt(t,n,e,r,i,s,o){this.id=t,this.x=n,this.y=e,this.w=r,this.h=i,this.maxw=s||r,this.maxh=o||i,this.refcount=0}pt.prototype.pack=function(t,n){t=[].concat(t),n=n||{};for(var e,r,i,s,o=[],a=0;a<t.length;a++)if(e=t[a].w||t[a].width,r=t[a].h||t[a].height,i=t[a].id,e&&r){if(!(s=this.packOne(e,r,i)))continue;n.inPlace&&(t[a].x=s.x,t[a].y=s.y,t[a].id=s.id),o.push(s)}return this.shrink(),o},pt.prototype.packOne=function(t,n,e){var r,i,s,o,a,u,l,h,c={freebin:-1,shelf:-1,waste:1/0},f=0;if("string"==typeof e||"number"==typeof e){if(r=this.getBin(e))return this.ref(r),r;"number"==typeof e&&(this.maxId=Math.max(e,this.maxId))}else e=++this.maxId;for(o=0;o<this.freebins.length;o++){if(n===(r=this.freebins[o]).maxh&&t===r.maxw)return this.allocFreebin(o,t,n,e);n>r.maxh||t>r.maxw||n<=r.maxh&&t<=r.maxw&&(s=r.maxw*r.maxh-t*n)<c.waste&&(c.waste=s,c.freebin=o)}for(o=0;o<this.shelves.length;o++)if(f+=(i=this.shelves[o]).h,!(t>i.free)){if(n===i.h)return this.allocShelf(o,t,n,e);n>i.h||n<i.h&&(s=(i.h-n)*t)<c.waste&&(c.freebin=-1,c.waste=s,c.shelf=o)}return-1!==c.freebin?this.allocFreebin(c.freebin,t,n,e):-1!==c.shelf?this.allocShelf(c.shelf,t,n,e):n<=this.h-f&&t<=this.w?(i=new yt(f,this.w,n),this.allocShelf(this.shelves.push(i)-1,t,n,e)):this.autoResize?(a=u=this.h,((l=h=this.w)<=a||t>l)&&(h=2*Math.max(t,l)),(a<l||n>a)&&(u=2*Math.max(n,a)),this.resize(h,u),this.packOne(t,n,e)):null},pt.prototype.allocFreebin=function(t,n,e,r){var i=this.freebins.splice(t,1)[0];return i.id=r,i.w=n,i.h=e,i.refcount=0,this.bins[r]=i,this.ref(i),i},pt.prototype.allocShelf=function(t,n,e,r){var i=this.shelves[t].alloc(n,e,r);return this.bins[r]=i,this.ref(i),i},pt.prototype.shrink=function(){if(this.shelves.length>0){for(var t=0,n=0,e=0;e<this.shelves.length;e++){var r=this.shelves[e];n+=r.h,t=Math.max(r.w-r.free,t)}this.resize(t,n)}},pt.prototype.getBin=function(t){return this.bins[t]},pt.prototype.ref=function(t){if(1==++t.refcount){var n=t.h;this.stats[n]=1+(0|this.stats[n])}return t.refcount},pt.prototype.unref=function(t){return 0===t.refcount?0:(0==--t.refcount&&(this.stats[t.h]--,delete this.bins[t.id],this.freebins.push(t)),t.refcount)},pt.prototype.clear=function(){this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0},pt.prototype.resize=function(t,n){this.w=t,this.h=n;for(var e=0;e<this.shelves.length;e++)this.shelves[e].resize(t);return!0},yt.prototype.alloc=function(t,n,e){if(t>this.free||n>this.h)return null;var r=this.x;return this.x+=t,this.free-=t,new mt(e,r,this.y,t,n,t,this.h)},yt.prototype.resize=function(t){return this.free+=t-this.w,this.w=t,!0};var gt={exports:{}},vt={exports:{}},bt=function(t){return!(!t||"string"==typeof t)&&(t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&"String"!==t.constructor.name))},wt=Array.prototype.concat,Mt=Array.prototype.slice,xt=vt.exports=function(t){for(var n=[],e=0,r=t.length;e<r;e++){var i=t[e];bt(i)?n=wt.call(n,Mt.call(i)):n.push(i)}return n};xt.wrap=function(t){return function(){return t(xt(arguments))}};var Ft=vt.exports,kt={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},At=Ft,Pt=Object.hasOwnProperty,St=Object.create(null);for(var _t in kt)Pt.call(kt,_t)&&(St[kt[_t]]=_t);var Ot=gt.exports={to:{},get:{}};function Ct(t,n,e){return Math.min(Math.max(n,t),e)}function Et(t){var n=Math.round(t).toString(16).toUpperCase();return n.length<2?"0"+n:n}Ot.get=function(t){var n,e;switch(t.substring(0,3).toLowerCase()){case"hsl":n=Ot.get.hsl(t),e="hsl";break;case"hwb":n=Ot.get.hwb(t),e="hwb";break;default:n=Ot.get.rgb(t),e="rgb"}return n?{model:e,value:n}:null},Ot.get.rgb=function(t){if(!t)return null;var n,e,r,i=[0,0,0,1];if(n=t.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(r=n[2],n=n[1],e=0;e<3;e++){var s=2*e;i[e]=parseInt(n.slice(s,s+2),16)}r&&(i[3]=parseInt(r,16)/255)}else if(n=t.match(/^#([a-f0-9]{3,4})$/i)){for(r=(n=n[1])[3],e=0;e<3;e++)i[e]=parseInt(n[e]+n[e],16);r&&(i[3]=parseInt(r+r,16)/255)}else if(n=t.match(/^rgba?\\(\\s*([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/)){for(e=0;e<3;e++)i[e]=parseInt(n[e+1],0);n[4]&&(n[5]?i[3]=.01*parseFloat(n[4]):i[3]=parseFloat(n[4]))}else{if(!(n=t.match(/^rgba?\\(\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/)))return(n=t.match(/^(\\w+)$/))?"transparent"===n[1]?[0,0,0,0]:Pt.call(kt,n[1])?((i=kt[n[1]])[3]=1,i):null:null;for(e=0;e<3;e++)i[e]=Math.round(2.55*parseFloat(n[e+1]));n[4]&&(n[5]?i[3]=.01*parseFloat(n[4]):i[3]=parseFloat(n[4]))}for(e=0;e<3;e++)i[e]=Ct(i[e],0,255);return i[3]=Ct(i[3],0,1),i},Ot.get.hsl=function(t){if(!t)return null;var n=t.match(/^hsla?\\(\\s*([+-]?(?:\\d{0,3}\\.)?\\d+)(?:deg)?\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*(?:[,|\\/]\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/);if(n){var e=parseFloat(n[4]);return[(parseFloat(n[1])%360+360)%360,Ct(parseFloat(n[2]),0,100),Ct(parseFloat(n[3]),0,100),Ct(isNaN(e)?1:e,0,1)]}return null},Ot.get.hwb=function(t){if(!t)return null;var n=t.match(/^hwb\\(\\s*([+-]?\\d{0,3}(?:\\.\\d+)?)(?:deg)?\\s*,\\s*([+-]?[\\d\\.]+)%\\s*,\\s*([+-]?[\\d\\.]+)%\\s*(?:,\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/);if(n){var e=parseFloat(n[4]);return[(parseFloat(n[1])%360+360)%360,Ct(parseFloat(n[2]),0,100),Ct(parseFloat(n[3]),0,100),Ct(isNaN(e)?1:e,0,1)]}return null},Ot.to.hex=function(){var t=At(arguments);return"#"+Et(t[0])+Et(t[1])+Et(t[2])+(t[3]<1?Et(Math.round(255*t[3])):"")},Ot.to.rgb=function(){var t=At(arguments);return t.length<4||1===t[3]?"rgb("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+")":"rgba("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+", "+t[3]+")"},Ot.to.rgb.percent=function(){var t=At(arguments),n=Math.round(t[0]/255*100),e=Math.round(t[1]/255*100),r=Math.round(t[2]/255*100);return t.length<4||1===t[3]?"rgb("+n+"%, "+e+"%, "+r+"%)":"rgba("+n+"%, "+e+"%, "+r+"%, "+t[3]+")"},Ot.to.hsl=function(){var t=At(arguments);return t.length<4||1===t[3]?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"},Ot.to.hwb=function(){var t=At(arguments),n="";return t.length>=4&&1!==t[3]&&(n=", "+t[3]),"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+n+")"},Ot.to.keyword=function(t){return St[t.slice(0,3)]};var It=gt.exports,$t={exports:{}},Tt={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},Dt={};for(var zt in Tt)Tt.hasOwnProperty(zt)&&(Dt[Tt[zt]]=zt);var jt=$t.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var Ut in jt)if(jt.hasOwnProperty(Ut)){if(!("channels"in jt[Ut]))throw new Error("missing channels property: "+Ut);if(!("labels"in jt[Ut]))throw new Error("missing channel labels property: "+Ut);if(jt[Ut].labels.length!==jt[Ut].channels)throw new Error("channel and label counts mismatch: "+Ut);var Nt=jt[Ut].channels,Lt=jt[Ut].labels;delete jt[Ut].channels,delete jt[Ut].labels,Object.defineProperty(jt[Ut],"channels",{value:Nt}),Object.defineProperty(jt[Ut],"labels",{value:Lt})}function Rt(t,n){return Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2)+Math.pow(t[2]-n[2],2)}jt.rgb.hsl=function(t){var n,e,r=t[0]/255,i=t[1]/255,s=t[2]/255,o=Math.min(r,i,s),a=Math.max(r,i,s),u=a-o;return a===o?n=0:r===a?n=(i-s)/u:i===a?n=2+(s-r)/u:s===a&&(n=4+(r-i)/u),(n=Math.min(60*n,360))<0&&(n+=360),e=(o+a)/2,[n,100*(a===o?0:e<=.5?u/(a+o):u/(2-a-o)),100*e]},jt.rgb.hsv=function(t){var n,e,r,i,s,o=t[0]/255,a=t[1]/255,u=t[2]/255,l=Math.max(o,a,u),h=l-Math.min(o,a,u),c=function(t){return(l-t)/6/h+.5};return 0===h?i=s=0:(s=h/l,n=c(o),e=c(a),r=c(u),o===l?i=r-e:a===l?i=1/3+n-r:u===l&&(i=2/3+e-n),i<0?i+=1:i>1&&(i-=1)),[360*i,100*s,100*l]},jt.rgb.hwb=function(t){var n=t[0],e=t[1],r=t[2];return[jt.rgb.hsl(t)[0],100*(1/255*Math.min(n,Math.min(e,r))),100*(r=1-1/255*Math.max(n,Math.max(e,r)))]},jt.rgb.cmyk=function(t){var n,e=t[0]/255,r=t[1]/255,i=t[2]/255;return[100*((1-e-(n=Math.min(1-e,1-r,1-i)))/(1-n)||0),100*((1-r-n)/(1-n)||0),100*((1-i-n)/(1-n)||0),100*n]},jt.rgb.keyword=function(t){var n=Dt[t];if(n)return n;var e,r=1/0;for(var i in Tt)if(Tt.hasOwnProperty(i)){var s=Rt(t,Tt[i]);s<r&&(r=s,e=i)}return e},jt.keyword.rgb=function(t){return Tt[t]},jt.rgb.xyz=function(t){var n=t[0]/255,e=t[1]/255,r=t[2]/255;return[100*(.4124*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.3576*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.1805*(r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92)),100*(.2126*n+.7152*e+.0722*r),100*(.0193*n+.1192*e+.9505*r)]},jt.rgb.lab=function(t){var n=jt.rgb.xyz(t),e=n[0],r=n[1],i=n[2];return r/=100,i/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116)-16,500*(e-r),200*(r-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},jt.hsl.rgb=function(t){var n,e,r,i,s,o=t[0]/360,a=t[1]/100,u=t[2]/100;if(0===a)return[s=255*u,s,s];n=2*u-(e=u<.5?u*(1+a):u+a-u*a),i=[0,0,0];for(var l=0;l<3;l++)(r=o+1/3*-(l-1))<0&&r++,r>1&&r--,s=6*r<1?n+6*(e-n)*r:2*r<1?e:3*r<2?n+(e-n)*(2/3-r)*6:n,i[l]=255*s;return i},jt.hsl.hsv=function(t){var n=t[0],e=t[1]/100,r=t[2]/100,i=e,s=Math.max(r,.01);return e*=(r*=2)<=1?r:2-r,i*=s<=1?s:2-s,[n,100*(0===r?2*i/(s+i):2*e/(r+e)),100*((r+e)/2)]},jt.hsv.rgb=function(t){var n=t[0]/60,e=t[1]/100,r=t[2]/100,i=Math.floor(n)%6,s=n-Math.floor(n),o=255*r*(1-e),a=255*r*(1-e*s),u=255*r*(1-e*(1-s));switch(r*=255,i){case 0:return[r,u,o];case 1:return[a,r,o];case 2:return[o,r,u];case 3:return[o,a,r];case 4:return[u,o,r];case 5:return[r,o,a]}},jt.hsv.hsl=function(t){var n,e,r,i=t[0],s=t[1]/100,o=t[2]/100,a=Math.max(o,.01);return r=(2-s)*o,e=s*a,[i,100*(e=(e/=(n=(2-s)*a)<=1?n:2-n)||0),100*(r/=2)]},jt.hwb.rgb=function(t){var n,e,r,i,s,o,a,u=t[0]/360,l=t[1]/100,h=t[2]/100,c=l+h;switch(c>1&&(l/=c,h/=c),r=6*u-(n=Math.floor(6*u)),1&n&&(r=1-r),i=l+r*((e=1-h)-l),n){default:case 6:case 0:s=e,o=i,a=l;break;case 1:s=i,o=e,a=l;break;case 2:s=l,o=e,a=i;break;case 3:s=l,o=i,a=e;break;case 4:s=i,o=l,a=e;break;case 5:s=e,o=l,a=i}return[255*s,255*o,255*a]},jt.cmyk.rgb=function(t){var n=t[0]/100,e=t[1]/100,r=t[2]/100,i=t[3]/100;return[255*(1-Math.min(1,n*(1-i)+i)),255*(1-Math.min(1,e*(1-i)+i)),255*(1-Math.min(1,r*(1-i)+i))]},jt.xyz.rgb=function(t){var n,e,r,i=t[0]/100,s=t[1]/100,o=t[2]/100;return e=-.9689*i+1.8758*s+.0415*o,r=.0557*i+-.204*s+1.057*o,n=(n=3.2406*i+-1.5372*s+-.4986*o)>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,e=e>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r,[255*(n=Math.min(Math.max(0,n),1)),255*(e=Math.min(Math.max(0,e),1)),255*(r=Math.min(Math.max(0,r),1))]},jt.xyz.lab=function(t){var n=t[0],e=t[1],r=t[2];return e/=100,r/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(e=e>.008856?Math.pow(e,1/3):7.787*e+16/116)-16,500*(n-e),200*(e-(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116))]},jt.lab.xyz=function(t){var n,e,r,i=t[0];n=t[1]/500+(e=(i+16)/116),r=e-t[2]/200;var s=Math.pow(e,3),o=Math.pow(n,3),a=Math.pow(r,3);return e=s>.008856?s:(e-16/116)/7.787,n=o>.008856?o:(n-16/116)/7.787,r=a>.008856?a:(r-16/116)/7.787,[n*=95.047,e*=100,r*=108.883]},jt.lab.lch=function(t){var n,e=t[0],r=t[1],i=t[2];return(n=360*Math.atan2(i,r)/2/Math.PI)<0&&(n+=360),[e,Math.sqrt(r*r+i*i),n]},jt.lch.lab=function(t){var n,e=t[0],r=t[1];return n=t[2]/360*2*Math.PI,[e,r*Math.cos(n),r*Math.sin(n)]},jt.rgb.ansi16=function(t){var n=t[0],e=t[1],r=t[2],i=1 in arguments?arguments[1]:jt.rgb.hsv(t)[2];if(0===(i=Math.round(i/50)))return 30;var s=30+(Math.round(r/255)<<2|Math.round(e/255)<<1|Math.round(n/255));return 2===i&&(s+=60),s},jt.hsv.ansi16=function(t){return jt.rgb.ansi16(jt.hsv.rgb(t),t[2])},jt.rgb.ansi256=function(t){var n=t[0],e=t[1],r=t[2];return n===e&&e===r?n<8?16:n>248?231:Math.round((n-8)/247*24)+232:16+36*Math.round(n/255*5)+6*Math.round(e/255*5)+Math.round(r/255*5)},jt.ansi16.rgb=function(t){var n=t%10;if(0===n||7===n)return t>50&&(n+=3.5),[n=n/10.5*255,n,n];var e=.5*(1+~~(t>50));return[(1&n)*e*255,(n>>1&1)*e*255,(n>>2&1)*e*255]},jt.ansi256.rgb=function(t){if(t>=232){var n=10*(t-232)+8;return[n,n,n]}var e;return t-=16,[Math.floor(t/36)/5*255,Math.floor((e=t%36)/6)/5*255,e%6/5*255]},jt.rgb.hex=function(t){var n=(((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2]))).toString(16).toUpperCase();return"000000".substring(n.length)+n},jt.hex.rgb=function(t){var n=t.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!n)return[0,0,0];var e=n[0];3===n[0].length&&(e=e.split("").map((function(t){return t+t})).join(""));var r=parseInt(e,16);return[r>>16&255,r>>8&255,255&r]},jt.rgb.hcg=function(t){var n,e=t[0]/255,r=t[1]/255,i=t[2]/255,s=Math.max(Math.max(e,r),i),o=Math.min(Math.min(e,r),i),a=s-o;return n=a<=0?0:s===e?(r-i)/a%6:s===r?2+(i-e)/a:4+(e-r)/a+4,n/=6,[360*(n%=1),100*a,100*(a<1?o/(1-a):0)]},jt.hsl.hcg=function(t){var n=t[1]/100,e=t[2]/100,r=1,i=0;return(r=e<.5?2*n*e:2*n*(1-e))<1&&(i=(e-.5*r)/(1-r)),[t[0],100*r,100*i]},jt.hsv.hcg=function(t){var n=t[1]/100,e=t[2]/100,r=n*e,i=0;return r<1&&(i=(e-r)/(1-r)),[t[0],100*r,100*i]},jt.hcg.rgb=function(t){var n=t[0]/360,e=t[1]/100,r=t[2]/100;if(0===e)return[255*r,255*r,255*r];var i,s=[0,0,0],o=n%1*6,a=o%1,u=1-a;switch(Math.floor(o)){case 0:s[0]=1,s[1]=a,s[2]=0;break;case 1:s[0]=u,s[1]=1,s[2]=0;break;case 2:s[0]=0,s[1]=1,s[2]=a;break;case 3:s[0]=0,s[1]=u,s[2]=1;break;case 4:s[0]=a,s[1]=0,s[2]=1;break;default:s[0]=1,s[1]=0,s[2]=u}return i=(1-e)*r,[255*(e*s[0]+i),255*(e*s[1]+i),255*(e*s[2]+i)]},jt.hcg.hsv=function(t){var n=t[1]/100,e=n+t[2]/100*(1-n),r=0;return e>0&&(r=n/e),[t[0],100*r,100*e]},jt.hcg.hsl=function(t){var n=t[1]/100,e=t[2]/100*(1-n)+.5*n,r=0;return e>0&&e<.5?r=n/(2*e):e>=.5&&e<1&&(r=n/(2*(1-e))),[t[0],100*r,100*e]},jt.hcg.hwb=function(t){var n=t[1]/100,e=n+t[2]/100*(1-n);return[t[0],100*(e-n),100*(1-e)]},jt.hwb.hcg=function(t){var n=t[1]/100,e=1-t[2]/100,r=e-n,i=0;return r<1&&(i=(e-r)/(1-r)),[t[0],100*r,100*i]},jt.apple.rgb=function(t){return[t[0]/65535*255,t[1]/65535*255,t[2]/65535*255]},jt.rgb.apple=function(t){return[t[0]/255*65535,t[1]/255*65535,t[2]/255*65535]},jt.gray.rgb=function(t){return[t[0]/100*255,t[0]/100*255,t[0]/100*255]},jt.gray.hsl=jt.gray.hsv=function(t){return[0,0,t[0]]},jt.gray.hwb=function(t){return[0,100,t[0]]},jt.gray.cmyk=function(t){return[0,0,0,t[0]]},jt.gray.lab=function(t){return[t[0],0,0]},jt.gray.hex=function(t){var n=255&Math.round(t[0]/100*255),e=((n<<16)+(n<<8)+n).toString(16).toUpperCase();return"000000".substring(e.length)+e},jt.rgb.gray=function(t){return[(t[0]+t[1]+t[2])/3/255*100]};var Vt=$t.exports,Ht=Vt;function qt(t){var n=function(){for(var t={},n=Object.keys(Ht),e=n.length,r=0;r<e;r++)t[n[r]]={distance:-1,parent:null};return t}(),e=[t];for(n[t].distance=0;e.length;)for(var r=e.pop(),i=Object.keys(Ht[r]),s=i.length,o=0;o<s;o++){var a=i[o],u=n[a];-1===u.distance&&(u.distance=n[r].distance+1,u.parent=r,e.unshift(a))}return n}function Gt(t,n){return function(e){return n(t(e))}}function Jt(t,n){for(var e=[n[t].parent,t],r=Ht[n[t].parent][t],i=n[t].parent;n[i].parent;)e.unshift(n[i].parent),r=Gt(Ht[n[i].parent][i],r),i=n[i].parent;return r.conversion=e,r}var Wt=Vt,Bt=function(t){for(var n=qt(t),e={},r=Object.keys(n),i=r.length,s=0;s<i;s++){var o=r[s];null!==n[o].parent&&(e[o]=Jt(o,n))}return e},Xt={};Object.keys(Wt).forEach((function(t){Xt[t]={},Object.defineProperty(Xt[t],"channels",{value:Wt[t].channels}),Object.defineProperty(Xt[t],"labels",{value:Wt[t].labels});var n=Bt(t);Object.keys(n).forEach((function(e){var r=n[e];Xt[t][e]=function(t){var n=function(n){if(null==n)return n;arguments.length>1&&(n=Array.prototype.slice.call(arguments));var e=t(n);if("object"==typeof e)for(var r=e.length,i=0;i<r;i++)e[i]=Math.round(e[i]);return e};return"conversion"in t&&(n.conversion=t.conversion),n}(r),Xt[t][e].raw=function(t){var n=function(n){return null==n?n:(arguments.length>1&&(n=Array.prototype.slice.call(arguments)),t(n))};return"conversion"in t&&(n.conversion=t.conversion),n}(r)}))}));var Yt=It,Kt=Xt,Zt=[].slice,Qt=["keyword","gray","hex"],tn={};Object.keys(Kt).forEach((function(t){tn[Zt.call(Kt[t].labels).sort().join("")]=t}));var nn={};function en(t,n){if(!(this instanceof en))return new en(t,n);if(n&&n in Qt&&(n=null),n&&!(n in Kt))throw new Error("Unknown model: "+n);var e,r;if(null==t)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(t instanceof en)this.model=t.model,this.color=t.color.slice(),this.valpha=t.valpha;else if("string"==typeof t){var i=Yt.get(t);if(null===i)throw new Error("Unable to parse color from string: "+t);this.model=i.model,r=Kt[this.model].channels,this.color=i.value.slice(0,r),this.valpha="number"==typeof i.value[r]?i.value[r]:1}else if(t.length){this.model=n||"rgb",r=Kt[this.model].channels;var s=Zt.call(t,0,r);this.color=on(s,r),this.valpha="number"==typeof t[r]?t[r]:1}else if("number"==typeof t)t&=16777215,this.model="rgb",this.color=[t>>16&255,t>>8&255,255&t],this.valpha=1;else{this.valpha=1;var o=Object.keys(t);"alpha"in t&&(o.splice(o.indexOf("alpha"),1),this.valpha="number"==typeof t.alpha?t.alpha:0);var a=o.sort().join("");if(!(a in tn))throw new Error("Unable to parse color from object: "+JSON.stringify(t));this.model=tn[a];var u=Kt[this.model].labels,l=[];for(e=0;e<u.length;e++)l.push(t[u[e]]);this.color=on(l)}if(nn[this.model])for(r=Kt[this.model].channels,e=0;e<r;e++){var h=nn[this.model][e];h&&(this.color[e]=h(this.color[e]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function rn(t,n,e){return(t=Array.isArray(t)?t:[t]).forEach((function(t){(nn[t]||(nn[t]=[]))[n]=e})),t=t[0],function(r){var i;return arguments.length?(e&&(r=e(r)),(i=this[t]()).color[n]=r,i):(i=this[t]().color[n],e&&(i=e(i)),i)}}function sn(t){return function(n){return Math.max(0,Math.min(t,n))}}function on(t,n){for(var e=0;e<n;e++)"number"!=typeof t[e]&&(t[e]=0);return t}en.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(t){var n=this.model in Yt.to?this:this.rgb(),e=1===(n=n.round("number"==typeof t?t:1)).valpha?n.color:n.color.concat(this.valpha);return Yt.to[n.model](e)},percentString:function(t){var n=this.rgb().round("number"==typeof t?t:1),e=1===n.valpha?n.color:n.color.concat(this.valpha);return Yt.to.rgb.percent(e)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var t={},n=Kt[this.model].channels,e=Kt[this.model].labels,r=0;r<n;r++)t[e[r]]=this.color[r];return 1!==this.valpha&&(t.alpha=this.valpha),t},unitArray:function(){var t=this.rgb().color;return t[0]/=255,t[1]/=255,t[2]/=255,1!==this.valpha&&t.push(this.valpha),t},unitObject:function(){var t=this.rgb().object();return t.r/=255,t.g/=255,t.b/=255,1!==this.valpha&&(t.alpha=this.valpha),t},round:function(t){return t=Math.max(t||0,0),new en(this.color.map(function(t){return function(n){return function(t,n){return Number(t.toFixed(n))}(n,t)}}(t)).concat(this.valpha),this.model)},alpha:function(t){return arguments.length?new en(this.color.concat(Math.max(0,Math.min(1,t))),this.model):this.valpha},red:rn("rgb",0,sn(255)),green:rn("rgb",1,sn(255)),blue:rn("rgb",2,sn(255)),hue:rn(["hsl","hsv","hsl","hwb","hcg"],0,(function(t){return(t%360+360)%360})),saturationl:rn("hsl",1,sn(100)),lightness:rn("hsl",2,sn(100)),saturationv:rn("hsv",1,sn(100)),value:rn("hsv",2,sn(100)),chroma:rn("hcg",1,sn(100)),gray:rn("hcg",2,sn(100)),white:rn("hwb",1,sn(100)),wblack:rn("hwb",2,sn(100)),cyan:rn("cmyk",0,sn(100)),magenta:rn("cmyk",1,sn(100)),yellow:rn("cmyk",2,sn(100)),black:rn("cmyk",3,sn(100)),x:rn("xyz",0,sn(100)),y:rn("xyz",1,sn(100)),z:rn("xyz",2,sn(100)),l:rn("lab",0,sn(100)),a:rn("lab",1),b:rn("lab",2),keyword:function(t){return arguments.length?new en(t):Kt[this.model].keyword(this.color)},hex:function(t){return arguments.length?new en(t):Yt.to.hex(this.rgb().round().color)},rgbNumber:function(){var t=this.rgb().color;return(255&t[0])<<16|(255&t[1])<<8|255&t[2]},luminosity:function(){for(var t=this.rgb().color,n=[],e=0;e<t.length;e++){var r=t[e]/255;n[e]=r<=.03928?r/12.92:Math.pow((r+.055)/1.055,2.4)}return.2126*n[0]+.7152*n[1]+.0722*n[2]},contrast:function(t){var n=this.luminosity(),e=t.luminosity();return n>e?(n+.05)/(e+.05):(e+.05)/(n+.05)},level:function(t){var n=this.contrast(t);return n>=7.1?"AAA":n>=4.5?"AA":""},isDark:function(){var t=this.rgb().color;return(299*t[0]+587*t[1]+114*t[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var t=this.rgb(),n=0;n<3;n++)t.color[n]=255-t.color[n];return t},lighten:function(t){var n=this.hsl();return n.color[2]+=n.color[2]*t,n},darken:function(t){var n=this.hsl();return n.color[2]-=n.color[2]*t,n},saturate:function(t){var n=this.hsl();return n.color[1]+=n.color[1]*t,n},desaturate:function(t){var n=this.hsl();return n.color[1]-=n.color[1]*t,n},whiten:function(t){var n=this.hwb();return n.color[1]+=n.color[1]*t,n},blacken:function(t){var n=this.hwb();return n.color[2]+=n.color[2]*t,n},grayscale:function(){var t=this.rgb().color,n=.3*t[0]+.59*t[1]+.11*t[2];return en.rgb(n,n,n)},fade:function(t){return this.alpha(this.valpha-this.valpha*t)},opaquer:function(t){return this.alpha(this.valpha+this.valpha*t)},rotate:function(t){var n=this.hsl(),e=n.color[0];return e=(e=(e+t)%360)<0?360+e:e,n.color[0]=e,n},mix:function(t,n){if(!t||!t.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof t);var e=t.rgb(),r=this.rgb(),i=void 0===n?.5:n,s=2*i-1,o=e.alpha()-r.alpha(),a=((s*o==-1?s:(s+o)/(1+s*o))+1)/2,u=1-a;return en.rgb(a*e.red()+u*r.red(),a*e.green()+u*r.green(),a*e.blue()+u*r.blue(),e.alpha()*i+r.alpha()*(1-i))}},Object.keys(Kt).forEach((function(t){if(-1===Qt.indexOf(t)){var n=Kt[t].channels;en.prototype[t]=function(){if(this.model===t)return new en(this);if(arguments.length)return new en(arguments,t);var e,r="number"==typeof arguments[n]?n:this.valpha;return new en((e=Kt[this.model][t].raw(this.color),Array.isArray(e)?e:[e]).concat(r),t)},en[t]=function(e){return"number"==typeof e&&(e=on(Zt.call(arguments),n)),new en(e,t)}}}));var an=ht(en);
/*!
        Feature Filter by

        (c) mapbox 2016 and maptalks 2018
        www.mapbox.com | www.maptalks.org
        License: MIT, header required.
    */
const un=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function ln(t){return new Function("f",\`var p = (f && f.properties || {}); return ${Tt}cn(t)}\`)}function hn(t){if(!0===t||!1===t)return!0;if(!Array.isArray(t)||0===t.length)return!1;switch(t[0]){case"has":case"!has":return 2===t.length&&("string"==typeof t[1]||t[1].property&&t[1].op);case"in":case"!in":return t.length>=2&&("string"==typeof t[1]||t[1].property&&t[1].op);case"==":case"!=":case">":case">=":case"<":case"<=":return 3===t.length&&("string"==typeof t[1]||t[1].property&&t[1].op);case"none":case"any":case"all":for(const n of t.slice(1))if(!hn(n)&&"boolean"!=typeof n)return!1;return!0;case"contains":return!0;default:return!1}}function cn(t){if(!t)return"true";const n=t[0];if(t.length<=1)return"any"===n?"false":"true";return\`(${Tt}"=="===n?dn(t[1],t[2],"===",!1):"!="===n?dn(t[1],t[2],"!==",!1):"<"===n||">"===n||"<="===n||">="===n?dn(t[1],t[2],n,!0):"any"===n?yn(t.slice(1),"||"):"all"===n?yn(t.slice(1),"&&"):"none"===n?vn(yn(t.slice(1),"||")):"in"===n?mn(t[1],t.slice(2)):"!in"===n?vn(mn(t[1],t.slice(2))):"has"===n?gn(t[1]):"!has"===n?vn(gn(t[1])):"contains"===n?function(t,n,e){const r=fn(t);return void 0!==e?\`(${Tt}r} + '').indexOf("${Tt}n}") === ${Tt}e}\`:\`(${Tt}r} + '').indexOf("${Tt}n}") >= 0\`}(t[1],t[2],t[3]):"true"})\`}function fn(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function dn(t,n,e,r){if("object"==typeof(i=t)&&i&&t.op)return function(t,n,e,r){const i=t.property,s=t.op;let o=fn(i);return"length"!==s?(console.error(\`not support ${Tt}s} op\`),"false"):(o=\`((${Tt}o}+='').length)\`,pn(o,i,n,e,r))}(t,n,e,r);var i;return pn(fn(t),t,n,e,r)}function pn(t,n,e,r,i){const s="$type"===n?un.indexOf(e):JSON.stringify(e);return(i?\`typeof ${Tt}t}=== typeof ${Tt}s}&&\`:"")+t+r+s}function yn(t,n){return t.map(cn).join(n)}function mn(t,n){"$type"===t&&(n=n.map((t=>un.indexOf(t))));const e=JSON.stringify(n.sort(bn)),r=fn(t);return n.length<=200?\`${Tt}e}.indexOf(${Tt}r}) !== -1\`:\`function(v, a, i, j) {\\n        while (i <= j) { var m = (i + j) >> 1;\\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\\n        }\\n    return false; }(${Tt}r}, ${Tt}e},0,${Tt}n.length-1})\`}function gn(t){return"$id"===t?'"id" in f':\`${Tt}JSON.stringify(t)} in p\`}function vn(t){return\`!(${Tt}t})\`}function bn(t,n){return t<n?-1:t>n?1:0}var wn={exports:{}};wn.exports=function(){function t(t,e,i,s,o){n(t,e,i||0,s||t.length-1,o||r)}function n(t,r,i,s,o){for(;s>i;){if(s-i>600){var a=s-i+1,u=r-i+1,l=Math.log(a),h=.5*Math.exp(2*l/3),c=.5*Math.sqrt(l*h*(a-h)/a)*(u-a/2<0?-1:1);n(t,r,Math.max(i,Math.floor(r-u*h/a+c)),Math.min(s,Math.floor(r+(a-u)*h/a+c)),o)}var f=t[r],d=i,p=s;for(e(t,i,r),o(t[s],f)>0&&e(t,i,s);d<p;){for(e(t,d,p),d++,p--;o(t[d],f)<0;)d++;for(;o(t[p],f)>0;)p--}0===o(t[i],f)?e(t,i,p):e(t,++p,s),p<=r&&(i=p+1),r<=p&&(s=p-1)}}function e(t,n,e){var r=t[n];t[n]=t[e],t[e]=r}function r(t,n){return t<n?-1:t>n?1:0}return t}();var Mn=ht(wn.exports);class xn{constructor(t=[],n=Fn){if(this.data=t,this.length=this.data.length,this.compare=n,this.length>0)for(let t=(this.length>>1)-1;t>=0;t--)this.U(t)}push(t){this.data.push(t),this.length++,this.L(this.length-1)}pop(){if(0===this.length)return;const t=this.data[0],n=this.data.pop();return this.length--,this.length>0&&(this.data[0]=n,this.U(0)),t}peek(){return this.data[0]}L(t){const{data:n,compare:e}=this,r=n[t];for(;t>0;){const i=t-1>>1,s=n[i];if(e(r,s)>=0)break;n[t]=s,t=i}n[t]=r}U(t){const{data:n,compare:e}=this,r=this.length>>1,i=n[t];for(;t<r;){let r=1+(t<<1),s=n[r];const o=r+1;if(o<this.length&&e(n[o],s)<0&&(r=o,s=n[o]),e(s,i)>=0)break;n[t]=s,t=r}n[t]=i}}function Fn(t,n){return t<n?-1:t>n?1:0}var kn="undefined"!=typeof Float32Array?Float32Array:Array;function An(){var t=new kn(3);return kn!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function Pn(t,n,e){var r=new kn(3);return r[0]=t,r[1]=n,r[2]=e,r}function Sn(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t}function _n(t,n,e,r){return t[0]=n,t[1]=e,t[2]=r,t}function On(t,n,e){return t[0]=n[0]+e[0],t[1]=n[1]+e[1],t[2]=n[2]+e[2],t}function Cn(t,n){var e=n[0],r=n[1],i=n[2],s=e*e+r*r+i*i;return s>0&&(s=1/Math.sqrt(s),t[0]=n[0]*s,t[1]=n[1]*s,t[2]=n[2]*s),t}function En(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]}function In(t,n,e){var r=n[0],i=n[1],s=n[2],o=e[0],a=e[1],u=e[2];return t[0]=i*u-s*a,t[1]=s*o-r*u,t[2]=r*a-i*o,t}var $n=function(t,n,e){return t[0]=n[0]-e[0],t[1]=n[1]-e[1],t[2]=n[2]-e[2],t};function Tn(){var t=new kn(4);return kn!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function Dn(t,n){var e=n[0]+n[4]+n[8],r=void 0;if(e>0)r=Math.sqrt(e+1),t[3]=.5*r,r=.5/r,t[0]=(n[5]-n[7])*r,t[1]=(n[6]-n[2])*r,t[2]=(n[1]-n[3])*r;else{var i=0;n[4]>n[0]&&(i=1),n[8]>n[3*i+i]&&(i=2);var s=(i+1)%3,o=(i+2)%3;r=Math.sqrt(n[3*i+i]-n[3*s+s]-n[3*o+o]+1),t[i]=.5*r,r=.5/r,t[3]=(n[3*s+o]-n[3*o+s])*r,t[s]=(n[3*s+i]+n[3*i+s])*r,t[o]=(n[3*o+i]+n[3*i+o])*r}return t}!function(){var t=An()}(),function(){var t,n=(t=new kn(4),kn!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var zn,jn=function(t,n,e){return t[0]=n[0]*e,t[1]=n[1]*e,t[2]=n[2]*e,t[3]=n[3]*e,t},Un=function(t,n){var e=n[0],r=n[1],i=n[2],s=n[3],o=e*e+r*r+i*i+s*s;return o>0&&(o=1/Math.sqrt(o),t[0]=e*o,t[1]=r*o,t[2]=i*o,t[3]=s*o),t};An(),Pn(1,0,0),Pn(0,1,0),Tn(),Tn(),zn=new kn(9),kn!=Float32Array&&(zn[1]=0,zn[2]=0,zn[3]=0,zn[5]=0,zn[6]=0,zn[7]=0),zn[0]=1,zn[4]=1,zn[8]=1;
/*!
     * Contains code from google filament
     * https://github.com/google/filament/
     * License Apache-2.0
     */
const Nn=8,Ln=[],Rn=[],Vn=[],Hn=[];function qn(t,n,e){const r=In(Rn,n,e),i=function(t,n,e,r,i,s,o,a,u,l){return t[0]=n,t[1]=e,t[2]=r,t[3]=i,t[4]=s,t[5]=o,t[6]=a,t[7]=u,t[8]=l,t}(Ln,e[0],e[1],e[2],...r,...n);t=Dn(t,i),t=function(t){return t[3]<0?jn(t,t,-1):t}(t=Un(t,t));const s=1/((1<<2*Nn-1)-1);if(t[3]<s){t[3]=s;const n=Math.sqrt(1-s*s);t[0]*=n,t[1]*=n,t[2]*=n}const o=e[3]>0?In(Vn,e,n):In(Vn,n,e);return En(In(Hn,e,n),o)<0&&jn(t,t,-1),t}const Gn=[];function Jn(t,n,e){const r=e||[];r.setLength&&r.setLength(t.length);const i=Gn;i.length<t.length/3&&(i.length=t.length/3),i.fill(0,0,t.length/3);const s=void 0===n.length?n:n.length;for(let e=0;e<s/3;e++)void 0===n.length?te(t,3*e,3*e+1,3*e+2,r,i):te(t,n[3*e],n[3*e+1],n[3*e+2],r,i);const o=r.getLength?r.getLength():r.length;for(let t=0;t<o;t+=3){const n=i[t/3];0!==n?(r[t]/=n,r[t+1]/=n,r[t+2]/=n):(r[t]=0,r[t+1]=0,r[t+2]=0)}return r}const Wn=[],Bn=[],Xn=[],Yn=[],Kn=[],Zn=[],Qn=[];function te(t,n,e,r,i,s){_n(Yn,t[3*n],t[3*n+1],t[3*n+2]),_n(Kn,t[3*e],t[3*e+1],t[3*e+2]),_n(Zn,t[3*r],t[3*r+1],t[3*r+2]);const o=$n(Wn,Zn,Kn),a=$n(Bn,Yn,Kn),u=In(Xn,o,a);Cn(Qn,u),i[3*n]=i[3*n]||0,i[3*e]=i[3*e]||0,i[3*r]=i[3*r]||0,i[3*n+1]=i[3*n+1]||0,i[3*e+1]=i[3*e+1]||0,i[3*r+1]=i[3*r+1]||0,i[3*n+2]=i[3*n+2]||0,i[3*e+2]=i[3*e+2]||0,i[3*r+2]=i[3*r+2]||0,i[3*n]+=Qn[0],i[3*e]+=Qn[0],i[3*r]+=Qn[0],i[3*n+1]+=Qn[1],i[3*e+1]+=Qn[1],i[3*r+1]+=Qn[1],i[3*n+2]+=Qn[2],i[3*e+2]+=Qn[2],i[3*r+2]+=Qn[2],s[n]+=1,s[e]+=1,s[r]+=1}
/*!
     * Contains code from THREE.JS
     * https://github.com/mrdoob/three.js/
     * License MIT
     *
     * Generate tangents per vertex.
     */function ne(t,n,e){return t[0]=n[e],t[1]=n[e+1],t[2]=n[e+2],t}function ee(t,n,e){return t[0]=n[e],t[1]=n[e+1],t}var re={exports:{}};function ie(t,n,e){e=e||2;var r,i,s,o,a,u,l,h=n&&n.length,c=h?n[0]*e:t.length,f=se(t,0,c,e,!0),d=[];if(!f||f.next===f.prev)return d;if(h&&(f=function(t,n,e,r){var i,s,o,a=[];for(i=0,s=n.length;i<s;i++)(o=se(t,n[i]*r,i<s-1?n[i+1]*r:t.length,r,!1))===o.next&&(o.steiner=!0),a.push(me(o));for(a.sort(fe),i=0;i<a.length;i++)e=de(a[i],e);return e}(t,n,f,e)),t.length>80*e){r=s=t[0],i=o=t[1];for(var p=e;p<c;p+=e)(a=t[p])<r&&(r=a),(u=t[p+1])<i&&(i=u),a>s&&(s=a),u>o&&(o=u);l=0!==(l=Math.max(s-r,o-i))?32767/l:0}return ae(f,d,e,r,i,l,0),d}function se(t,n,e,r,i){var s,o;if(i===Oe(t,n,e,r)>0)for(s=n;s<e;s+=r)o=Pe(s,t[s],t[s+1],o);else for(s=e-r;s>=n;s-=r)o=Pe(s,t[s],t[s+1],o);return o&&we(o,o.next)&&(Se(o),o=o.next),o}function oe(t,n){if(!t)return t;n||(n=t);var e,r=t;do{if(e=!1,r.steiner||!we(r,r.next)&&0!==be(r.prev,r,r.next))r=r.next;else{if(Se(r),(r=n=r.prev)===r.next)break;e=!0}}while(e||r!==n);return n}function ae(t,n,e,r,i,s,o){if(t){!o&&s&&function(t,n,e,r){var i=t;do{0===i.z&&(i.z=ye(i.x,i.y,n,e,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){var n,e,r,i,s,o,a,u,l=1;do{for(e=t,t=null,s=null,o=0;e;){for(o++,r=e,a=0,n=0;n<l&&(a++,r=r.nextZ);n++);for(u=l;a>0||u>0&&r;)0!==a&&(0===u||!r||e.z<=r.z)?(i=e,e=e.nextZ,a--):(i=r,r=r.nextZ,u--),s?s.nextZ=i:t=i,i.prevZ=s,s=i;e=r}s.nextZ=null,l*=2}while(o>1)}(i)}(t,r,i,s);for(var a,u,l=t;t.prev!==t.next;)if(a=t.prev,u=t.next,s?le(t,r,i,s):ue(t))n.push(a.i/e|0),n.push(t.i/e|0),n.push(u.i/e|0),Se(t),t=u.next,l=u.next;else if((t=u)===l){o?1===o?ae(t=he(oe(t),n,e),n,e,r,i,s,2):2===o&&ce(t,n,e,r,i,s):ae(oe(t),n,e,r,i,s,1);break}}}function ue(t){var n=t.prev,e=t,r=t.next;if(be(n,e,r)>=0)return!1;for(var i=n.x,s=e.x,o=r.x,a=n.y,u=e.y,l=r.y,h=i<s?i<o?i:o:s<o?s:o,c=a<u?a<l?a:l:u<l?u:l,f=i>s?i>o?i:o:s>o?s:o,d=a>u?a>l?a:l:u>l?u:l,p=r.next;p!==n;){if(p.x>=h&&p.x<=f&&p.y>=c&&p.y<=d&&ge(i,a,s,u,o,l,p.x,p.y)&&be(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function le(t,n,e,r){var i=t.prev,s=t,o=t.next;if(be(i,s,o)>=0)return!1;for(var a=i.x,u=s.x,l=o.x,h=i.y,c=s.y,f=o.y,d=a<u?a<l?a:l:u<l?u:l,p=h<c?h<f?h:f:c<f?c:f,y=a>u?a>l?a:l:u>l?u:l,m=h>c?h>f?h:f:c>f?c:f,g=ye(d,p,n,e,r),v=ye(y,m,n,e,r),b=t.prevZ,w=t.nextZ;b&&b.z>=g&&w&&w.z<=v;){if(b.x>=d&&b.x<=y&&b.y>=p&&b.y<=m&&b!==i&&b!==o&&ge(a,h,u,c,l,f,b.x,b.y)&&be(b.prev,b,b.next)>=0)return!1;if(b=b.prevZ,w.x>=d&&w.x<=y&&w.y>=p&&w.y<=m&&w!==i&&w!==o&&ge(a,h,u,c,l,f,w.x,w.y)&&be(w.prev,w,w.next)>=0)return!1;w=w.nextZ}for(;b&&b.z>=g;){if(b.x>=d&&b.x<=y&&b.y>=p&&b.y<=m&&b!==i&&b!==o&&ge(a,h,u,c,l,f,b.x,b.y)&&be(b.prev,b,b.next)>=0)return!1;b=b.prevZ}for(;w&&w.z<=v;){if(w.x>=d&&w.x<=y&&w.y>=p&&w.y<=m&&w!==i&&w!==o&&ge(a,h,u,c,l,f,w.x,w.y)&&be(w.prev,w,w.next)>=0)return!1;w=w.nextZ}return!0}function he(t,n,e){var r=t;do{var i=r.prev,s=r.next.next;!we(i,s)&&Me(i,r,r.next,s)&&ke(i,s)&&ke(s,i)&&(n.push(i.i/e|0),n.push(r.i/e|0),n.push(s.i/e|0),Se(r),Se(r.next),r=t=s),r=r.next}while(r!==t);return oe(r)}function ce(t,n,e,r,i,s){var o=t;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&ve(o,a)){var u=Ae(o,a);return o=oe(o,o.next),u=oe(u,u.next),ae(o,n,e,r,i,s,0),void ae(u,n,e,r,i,s,0)}a=a.next}o=o.next}while(o!==t)}function fe(t,n){return t.x-n.x}function de(t,n){var e=function(t,n){var e,r=n,i=t.x,s=t.y,o=-1/0;do{if(s<=r.y&&s>=r.next.y&&r.next.y!==r.y){var a=r.x+(s-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(a<=i&&a>o&&(o=a,e=r.x<r.next.x?r:r.next,a===i))return e}r=r.next}while(r!==n);if(!e)return null;var u,l=e,h=e.x,c=e.y,f=1/0;r=e;do{i>=r.x&&r.x>=h&&i!==r.x&&ge(s<c?i:o,s,h,c,s<c?o:i,s,r.x,r.y)&&(u=Math.abs(s-r.y)/(i-r.x),ke(r,t)&&(u<f||u===f&&(r.x>e.x||r.x===e.x&&pe(e,r)))&&(e=r,f=u)),r=r.next}while(r!==l);return e}(t,n);if(!e)return n;var r=Ae(e,t);return oe(r,r.next),oe(e,e.next)}function pe(t,n){return be(t.prev,t,n.prev)<0&&be(n.next,t,t.next)<0}function ye(t,n,e,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-e)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))|(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-r)*i|0)|n<<8))|n<<4))|n<<2))|n<<1))<<1}function me(t){var n=t,e=t;do{(n.x<e.x||n.x===e.x&&n.y<e.y)&&(e=n),n=n.next}while(n!==t);return e}function ge(t,n,e,r,i,s,o,a){return(i-o)*(n-a)>=(t-o)*(s-a)&&(t-o)*(r-a)>=(e-o)*(n-a)&&(e-o)*(s-a)>=(i-o)*(r-a)}function ve(t,n){return t.next.i!==n.i&&t.prev.i!==n.i&&!function(t,n){var e=t;do{if(e.i!==t.i&&e.next.i!==t.i&&e.i!==n.i&&e.next.i!==n.i&&Me(e,e.next,t,n))return!0;e=e.next}while(e!==t);return!1}(t,n)&&(ke(t,n)&&ke(n,t)&&function(t,n){var e=t,r=!1,i=(t.x+n.x)/2,s=(t.y+n.y)/2;do{e.y>s!=e.next.y>s&&e.next.y!==e.y&&i<(e.next.x-e.x)*(s-e.y)/(e.next.y-e.y)+e.x&&(r=!r),e=e.next}while(e!==t);return r}(t,n)&&(be(t.prev,t,n.prev)||be(t,n.prev,n))||we(t,n)&&be(t.prev,t,t.next)>0&&be(n.prev,n,n.next)>0)}function be(t,n,e){return(n.y-t.y)*(e.x-n.x)-(n.x-t.x)*(e.y-n.y)}function we(t,n){return t.x===n.x&&t.y===n.y}function Me(t,n,e,r){var i=Fe(be(t,n,e)),s=Fe(be(t,n,r)),o=Fe(be(e,r,t)),a=Fe(be(e,r,n));return i!==s&&o!==a||(!(0!==i||!xe(t,e,n))||(!(0!==s||!xe(t,r,n))||(!(0!==o||!xe(e,t,r))||!(0!==a||!xe(e,n,r)))))}function xe(t,n,e){return n.x<=Math.max(t.x,e.x)&&n.x>=Math.min(t.x,e.x)&&n.y<=Math.max(t.y,e.y)&&n.y>=Math.min(t.y,e.y)}function Fe(t){return t>0?1:t<0?-1:0}function ke(t,n){return be(t.prev,t,t.next)<0?be(t,n,t.next)>=0&&be(t,t.prev,n)>=0:be(t,n,t.prev)<0||be(t,t.next,n)<0}function Ae(t,n){var e=new _e(t.i,t.x,t.y),r=new _e(n.i,n.x,n.y),i=t.next,s=n.prev;return t.next=n,n.prev=t,e.next=i,i.prev=e,r.next=e,e.prev=r,s.next=r,r.prev=s,r}function Pe(t,n,e,r){var i=new _e(t,n,e);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function Se(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function _e(t,n,e){this.i=t,this.x=n,this.y=e,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Oe(t,n,e,r){for(var i=0,s=n,o=e-r;s<e;s+=r)i+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return i}re.exports=ie,re.exports.default=ie,ie.deviation=function(t,n,e,r){var i=n&&n.length,s=i?n[0]*e:t.length,o=Math.abs(Oe(t,0,s,e));if(i)for(var a=0,u=n.length;a<u;a++){var l=n[a]*e,h=a<u-1?n[a+1]*e:t.length;o-=Math.abs(Oe(t,l,h,e))}var c=0;for(a=0;a<r.length;a+=3){var f=r[a]*e,d=r[a+1]*e,p=r[a+2]*e;c+=Math.abs((t[f]-t[p])*(t[d+1]-t[f+1])-(t[f]-t[d])*(t[p+1]-t[f+1]))}return 0===o&&0===c?0:Math.abs((c-o)/o)},ie.flatten=function(t){for(var n=t[0][0].length,e={vertices:[],holes:[],dimensions:n},r=0,i=0;i<t.length;i++){for(var s=0;s<t[i].length;s++)for(var o=0;o<n;o++)e.vertices.push(t[i][s][o]);i>0&&(r+=t[i-1].length,e.holes.push(r))}return e};var Ce=ht(re.exports),Ee="undefined"!=typeof Float32Array?Float32Array:Array;function Ie(t,n,e,r){return t[0]=n,t[1]=e,t[2]=r,t}function $e(t,n){var e=n[0],r=n[1],i=n[2],s=e*e+r*r+i*i;return s>0&&(s=1/Math.sqrt(s)),t[0]=n[0]*s,t[1]=n[1]*s,t[2]=n[2]*s,t}function Te(t,n,e){var r=n[0],i=n[1],s=n[2],o=e[0],a=e[1],u=e[2];return t[0]=i*u-s*a,t[1]=s*o-r*u,t[2]=r*a-i*o,t}function De(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t}function ze(t,n,e,r,i){return t[0]=n,t[1]=e,t[2]=r,t[3]=i,t}function je(t,n,e){return t[0]=n[0]/e[0],t[1]=n[1]/e[1],t[2]=n[2]/e[2],t[3]=n[3]/e[3],t}function Ue(t,n,e){return t[0]=n[0]*e,t[1]=n[1]*e,t[2]=n[2]*e,t[3]=n[3]*e,t}function Ne(t,n){return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]&&t[3]===n[3]}function Le(t,n,e){return t[0]=n,t[1]=e,t}function Re(t,n){var e=n[0]-t[0],r=n[1]-t[1];return Math.hypot(e,r)}Math.hypot||(Math.hypot=function(){for(var t=0,n=arguments.length;n--;)t+=arguments[n]*arguments[n];return Math.sqrt(t)}),function(){var t=function(){var t=new Ee(3);return Ee!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}()}(),function(){var t=function(){var t=new Ee(4);return Ee!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}()}();var Ve=function(t){var n=t[0],e=t[1];return Math.hypot(n,e)};!function(){var t=function(){var t=new Ee(2);return Ee!=Float32Array&&(t[0]=0,t[1]=0),t}()}();
/*!
     * @maptalks/vector-packer v0.96.4
     * LICENSE : UNLICENSED
     * (c) 2016-2024 maptalks.com
     */
const He={Point:1,LineString:2,Polygon:3,MultiPoint:4,MultiLineString:5,MultiPolygon:6};function qe(t,n={}){var e=[];if("FeatureCollection"===t.type)for(var r=0;r<t.features.length;r++)Ge(e,t.features[r],n,r);else Ge(e,"Feature"===t.type?t:{geometry:t},n);return e}function Ge(t,n,e,r){if(n.geometry&&n.geometry.geometry){var i=n.geometry.coordinates,s=n.geometry.type,o=[],a=n.id;if(e.promoteId?a=n.properties[e.promoteId]:e.generateId&&(a=r||0),"Point"===s)Je(i,o);else if("MultiPoint"===s)for(var u=0;u<i.length;u++)Je(i[u],o);else if("LineString"===s)Be([i],o);else if("MultiLineString"===s){if(e.lineMetrics){for(u=0;u<i.length;u++)We(i[u],o=[]),t.push(Xe(a,"LineString",o,n.properties));return}Be(i,o)}else if("Polygon"===s)Be(i,o);else{if("MultiPolygon"!==s){if("GeometryCollection"===s){for(u=0;u<n.geometry.geometries.length;u++)Ge(t,{id:a,geometry:n.geometry.geometries[u],properties:n.properties},e,r);return}return void console.warn(\`Input data type(${Tt}s}) is not a valid GeoJSON geometry type.\`)}for(u=0;u<i.length;u++){var l=[];Be(i[u],l),o.push(l)}}t.push(Xe(a,s,o,n.properties))}}function Je(t,n){const e=new dt(t[0],t[1]);e.z=100*(t[2]||0),n.push([e])}function We(t,n){for(let e=0;e<t.length;e++){const r=new dt(t[e][0],t[e][1]);r.z=100*(t[e][2]||0),n.push(r)}}function Be(t,n,e,r){for(var i=0;i<t.length;i++){var s=[];We(t[i],s),n.push(s)}}function Xe(t,n,e,r){return{id:void 0===t?null:t,type:He[n],geometry:e,properties:r}}
/*!
     * Codes from mapbox-gl-js
     * github.com/mapbox/mapbox-gl-js
     * MIT License
     */function Ye(t,{width:n,height:e},r,i){if(i){if(i.length!==n*e*r)throw new RangeError("mismatched image size")}else i=new Uint8Array(n*e*r);return t.width=n,t.height=e,t.data=i,t}function Ke(t,{width:n,height:e},r){if(n===t.width&&e===t.height)return;const i=Ye({},{width:n,height:e},r);Ze(t,i,{x:0,y:0},{x:0,y:0},{width:Math.min(t.width,n),height:Math.min(t.height,e)},r),t.width=n,t.height=e,t.data=i.data}function Ze(t,n,e,r,i,s){if(0===i.width||0===i.height)return n;if(i.width>t.width||i.height>t.height||e.x>t.width-i.width||e.y>t.height-i.height)throw new RangeError("out of range source coordinates for image copy");if(i.width>n.width||i.height>n.height||r.x>n.width-i.width||r.y>n.height-i.height)throw new RangeError("out of range destination coordinates for image copy");const o=t.data,a=n.data;if(o===a)return n;for(let u=0;u<i.height;u++){const l=((e.y+u)*t.width+e.x)*s,h=((r.y+u)*n.width+r.x)*s;for(let t=0;t<i.width*s;t++)a[h+t]=o[l+t]}return n}class Qe{constructor(t,n){Ye(this,t,1,n)}resize(t){Ke(this,t,1)}clone(){return new Qe({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,n,e,r,i){Ze(t,n,e,r,i,1)}}class tr{constructor(t,n){Ye(this,t,4,n)}resize(t){Ke(this,t,4)}clone(){return new tr({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,n,e,r,i){Ze(t,n,e,r,i,4)}}function nr(t){let n=0;for(let e,r,i=0,s=t.length,o=s-1;i<s;o=i++)if(e=t[i],r=t[o],void 0!==e.x){if(e.z||r.z)return 1;n+=(r.x-e.x)*(e.y+r.y)}else{if(e[2]||r[2])return 1;n+=(r[0]-e[0])*(e[1]+r[1])}return n}function er(t,n,e,r,i){const s=t[n*r],o=t[n*r+1],a=t[e*r],u=t[e*r+1];return s===a&&(s<0||s>i)&&o!==u||o===u&&(o<0||o>i)&&s!==a}function rr(t,n,e){let r=e;return n&&t&&(r=+t[n]),isNaN(r)&&(r=e||0),100*r}function ir(t,n,e,r,i,s,o){n||0===n||(n=1);const a=rr(t.properties,e,r),u=a*n;let l=(s?100*s:0)||a;return i?l=rr(t.properties,i,s):o&&(l=a-rr(t.properties,o,s)),l*=n,{altitude:u,height:l}}function sr(t,n){return n<1/0&&(t.x<0||t.x>n||t.y<0||t.y>n)}function or(t){return null==t}function ar(t,n,e){if(t===e||t===n)return t;const r=e-n;return((t-n)%r+r)%r+n}function ur(t,n){if(!n)return null;const e=new Map;for(let r=0;r<n.length;r++){const i=n[r],s=t[i];let o=e.get(s);o||(o=[],e.set(s,o)),o.push(i)}return e}function lr(t){return!(t&t-1)&&0!==t}
/*!
     * Codes from mapbox-gl-js
     * github.com/mapbox/mapbox-gl-js
     * MIT License
     */class hr{constructor(t,n,{pixelRatio:e}){this.paddedRect=t,this.pixelRatio=e||1,this.padding=n}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.pixelRatio,(this.paddedRect.h-2*this.padding)/this.pixelRatio]}}class cr{constructor(t){this.glyphMap=t,this.build()}build(){const t=this.glyphMap,n=Object.keys(t).length,e={},r=new pt(0,0,{autoResize:!0}),i=[],s=n>1?1:0;for(const n in t){const r=t[n],o={x:0,y:0,w:r.data.width+2*s,h:r.data.height+2*s};i.push(o),e[n]=new hr(o,s,r)}if(r.pack(i,{inPlace:!0}),!lr(r.w)||!lr(r.h)){const t=fr(r.w),n=fr(r.h);r.resize(t,n)}const o=new tr({width:r.w,height:r.h});for(const n in t){const r=t[n],i=e[n].paddedRect;tr.copy(r.data,o,{x:0,y:0},{x:i.x+s,y:i.y+s},r.data)}this.image=o,this.positions=e}}function fr(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))}
/*!
     * Codes from mapbox-gl-js
     * github.com/mapbox/mapbox-gl-js
     * MIT License
     * TODO 升级为potpack
     */class dr{constructor(t){this.glyphMap=t,this.build()}build(){const t=this.glyphMap,n={},e=new pt(0,0,{autoResize:!0}),r=[];for(const e in t){const i=t[e],s=n[e]={};for(const t in i){const n=i[+t];if(!n||0===n.bitmap.width||0===n.bitmap.height)continue;const e={x:0,y:0,w:n.bitmap.width+2,h:n.bitmap.height+2};r.push(e),s[t]={rect:e,metrics:n.metrics}}}e.pack(r,{inPlace:!0});const i=new Qe({width:e.w,height:e.h});for(const e in t){const r=t[e];for(const t in r){const s=r[+t];if(!s||0===s.bitmap.width||0===s.bitmap.height)continue;const o=n[e][t].rect;Qe.copy(s.bitmap,i,{x:0,y:0},{x:o.x+1,y:o.y+1},s.bitmap)}}this.image=i,this.positions=n}}function pr(t){return t<65536?Uint16Array:Uint32Array}function yr(t){return(t=Math.abs(t))<128?Int8Array:t<32768?Int16Array:Float32Array}function mr(t){return t<256?Uint8Array:t<65536?Uint16Array:Float32Array}function gr(t,n){const e=t.getLength?t.getLength():t.length;if(t instanceof n)return t.slice(0,e);const r=new n(e);t=t.R||t;for(let n=0;n<e;n++)r[n]=t[n]||0;return r}function vr(t){const n=t.type,e=[];if(1===n||4===n)for(let n=0;n<t.geometry.length;n++)Je(t.geometry[n],e);else if(2===n)Be(t.geometry,e);else if(3===n)Be(t.geometry,e);else if(5===n)Be(t.geometry,e);else if(6===n)for(let n=0;n<t.geometry.length;n++){const r=[];Be(t.geometry[n],r),e.push(r)}return t.geometry=e,t}function br(t){for(let n=1;n<arguments.length;n++){const e=arguments[n];for(const n in e)t[n]=e[n]}return t}function wr(t){return null==t}function Mr(t){return"number"==typeof t&&!isNaN(t)}function xr(t){return"object"==typeof t&&!!t}function Fr(t){return!wr(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function kr(t){return!wr(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}const Ar=Object.prototype.hasOwnProperty;function Pr(t,n){return Ar.call(t,n)}const Sr=Math.PI/180;function _r(t){return t&&y(t)&&t.property}function Or(t){const{verticalCentimeterToPoint:n,tileRatio:e}=t;return n*e}function Cr(t){return"centimeter"===t||"cm"===t?1:"millimeter"===t||"mm"===t?.1:100}const Er={};function Ir(t,n){if(!Array.isArray(n)){if(n&&void 0!==n.r&&void 0!==n.g&&void 0!==n.b)return t[0]=255*n.r,t[1]=255*n.g,t[2]=255*n.b,t[3]=void 0!==n.a?255*n.a:255,t;n=Er[n]=Er[n]||an(n).unitArray()}for(let e=0;e<n.length;e++)t[e]=255*n[e];return 3===n.length&&(t[3]=255),t}const $r={textFill:1,textSize:1,textOpacity:1,textDx:1,textDy:1,markerWidth:1,markerHeight:1,markerOpacity:1,markerDx:1,markerDy:1,lineWidth:1,lineColor:1,lineOpacity:1,polygonFill:1,polygonOpacity:1,polygonPatternFileWidth:1,polygonPatternFileOrigin:1,rotationX:1,rotationY:1,rotationZ:1,scaleX:1,scaleY:1,scaleZ:1,translationX:1,translationY:1,translationZ:1},Tr={textName:1,markerTextFitPadding:1,markerTextFit:1,lineGradientProperty:1};var Dr=Object.freeze({__proto__:null,checkIfIdentityZoomDependent:function(t,n,e){if(Array.isArray(e)||(e=Object.values(e)),!e||!e.length)return!1;if(!$r[t])return!1;for(let t=0;t<e.length;t++){const r=e[t]&&(e[t].feature||e[t]);if(!r)continue;const i=r.properties&&r.properties[n];if(i&&y(i)&&!m(i).isZoomConstant)return!0}return!1},checkIfZoomFnTypeSymbol:function(t){return!!$r[t]||!!Tr[t]},evaluate:function(t,n,e){return kr(t)?t(void 0!==e?e:null,n):t},extend:br,getAltitudeToLocal:Or,getTubeSizeScale:Cr,hasOwn:Pr,isFnTypeSymbol:_r,isFunction:kr,isInteger:function(t){return(0|t)===t},isNil:wr,isNumber:Mr,isObject:xr,isString:Fr,join:function(t,n){return t.join?t.join(n||","):Array.prototype.join.call(t,n||",")},normalizeColor:Ir,now:function(){return Date.now()},toDegree:function(t){return t/Sr},toRadian:function(t){return t*Sr}});class zr{constructor(t,n,e,r){this.feature=t,this.symbol=n,this.fnTypes=e,this.options=r}getPolygonResource(){let t=this.symbol.polygonPatternFile;const{polygonPatternFileFn:n}=this.fnTypes;return this.V(t,n)}getLineResource(){let t=this.symbol.linePatternFile;const{linePatternFileFn:n}=this.fnTypes;return this.V(t,n)}V(t,n){return n&&(t=n(this.options.zoom,this.feature.properties)),t}}function jr(t,n,e,r){const i=Math.abs(r)>>15,s=i>>1,o=i%2;let a=r%Math.pow(2,15);const u=n+(s<<14)*Math.sign(n),l=e+(o<<14)*Math.sign(e);return t[0]=u,t[1]=l,a=Math.round(a),t[2]=0===a?r<0?-1:0:a,t}const Ur=Math.pow(2,14),Nr=Math.pow(2,15);
/*!
     * a compact version of mapbox-gl-style-spec
     * based on mapbox-gl-style-spec@13.28.0
     * https://github.com/mapbox/mapbox-gl-js/tree/main/src/style-spec
     * LICENSE : ISC
     */var Lr,Rr,Vr="undefined"!=typeof undefinedThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof undefined?global:"undefined"!=typeof self?self:{},Hr={exports:{}};function qr(t,...n){for(const e of n)for(const n in e)t[n]=e[n];return t}
/*! https://mths.be/punycode v1.3.2 by @mathias */Lr=Hr,Rr=Hr.exports,function(t){var n=Rr&&!Rr.nodeType&&Rr,e=Lr&&!Lr.nodeType&&Lr,r="object"==typeof Vr&&Vr;r.global!==r&&r.window!==r&&r.self!==r||(t=r);var i,s,o=2147483647,a=36,u=26,l=38,h=700,c=/^xn--/,f=/[^\\x20-\\x7E]/,d=/[\\x2E\\u3002\\uFF0E\\uFF61]/g,p={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},y=a-1,m=Math.floor,g=String.fromCharCode;function v(t){throw RangeError(p[t])}function b(t,n){for(var e=t.length,r=[];e--;)r[e]=n(t[e]);return r}function w(t,n){var e=t.split("@"),r="";return e.length>1&&(r=e[0]+"@",t=e[1]),r+b((t=t.replace(d,".")).split("."),n).join(".")}function M(t){for(var n,e,r=[],i=0,s=t.length;i<s;)(n=t.charCodeAt(i++))>=55296&&n<=56319&&i<s?56320==(64512&(e=t.charCodeAt(i++)))?r.push(((1023&n)<<10)+(1023&e)+65536):(r.push(n),i--):r.push(n);return r}function x(t){return b(t,(function(t){var n="";return t>65535&&(n+=g((t-=65536)>>>10&1023|55296),t=56320|1023&t),n+g(t)})).join("")}function F(t,n){return t+22+75*(t<26)-((0!=n)<<5)}function k(t,n,e){var r=0;for(t=e?m(t/h):t>>1,t+=m(t/n);t>y*u>>1;r+=a)t=m(t/y);return m(r+(y+1)*t/(t+l))}function A(t){var n,e,r,i,s,l,h,c,f,d,p,y=[],g=t.length,b=0,w=128,M=72;for((e=t.lastIndexOf("-"))<0&&(e=0),r=0;r<e;++r)t.charCodeAt(r)>=128&&v("not-basic"),y.push(t.charCodeAt(r));for(i=e>0?e+1:0;i<g;){for(s=b,l=1,h=a;i>=g&&v("invalid-input"),((c=(p=t.charCodeAt(i++))-48<10?p-22:p-65<26?p-65:p-97<26?p-97:a)>=a||c>m((o-b)/l))&&v("overflow"),b+=c*l,!(c<(f=h<=M?1:h>=M+u?u:h-M));h+=a)l>m(o/(d=a-f))&&v("overflow"),l*=d;M=k(b-s,n=y.length+1,0==s),m(b/n)>o-w&&v("overflow"),w+=m(b/n),b%=n,y.splice(b++,0,w)}return x(y)}function P(t){var n,e,r,i,s,l,h,c,f,d,p,y,b,w,x,A=[];for(y=(t=M(t)).length,n=128,e=0,s=72,l=0;l<y;++l)(p=t[l])<128&&A.push(g(p));for(r=i=A.length,i&&A.push("-");r<y;){for(h=o,l=0;l<y;++l)(p=t[l])>=n&&p<h&&(h=p);for(h-n>m((o-e)/(b=r+1))&&v("overflow"),e+=(h-n)*b,n=h,l=0;l<y;++l)if((p=t[l])<n&&++e>o&&v("overflow"),p==n){for(c=e,f=a;!(c<(d=f<=s?1:f>=s+u?u:f-s));f+=a)A.push(g(F(d+(x=c-d)%(w=a-d),0))),c=m(x/w);A.push(g(F(c,0))),s=k(e,b,r==i),e=0,++r}++e,++n}return A.join("")}if(i={version:"1.3.2",ucs2:{decode:M,encode:x},decode:A,encode:P,toASCII:function(t){return w(t,(function(t){return f.test(t)?"xn--"+P(t):t}))},toUnicode:function(t){return w(t,(function(t){return c.test(t)?A(t.slice(4).toLowerCase()):t}))}},n&&e)if(Lr.exports==n)e.exports=i;else for(s in i)i.hasOwnProperty(s)&&(n[s]=i[s]);else t.punycode=i}(Vr);class Gr extends Error{constructor(t,n){super(n),this.message=n,this.key=t}}var Jr=Gr;class Wr{constructor(t,n=[]){this.parent=t,this.bindings={};for(const[t,e]of n)this.bindings[t]=e}concat(t){return new Wr(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(\`${Tt}t} not found in scope.\`)}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}var Br=Wr;const Xr={kind:"null"},Yr={kind:"number"},Kr={kind:"string"},Zr={kind:"boolean"},Qr={kind:"color"},ti={kind:"object"},ni={kind:"value"},ei={kind:"collator"},ri={kind:"formatted"},ii={kind:"resolvedImage"};function si(t,n){return{kind:"array",itemType:t,N:n}}function oi(t){if("array"===t.kind){const n=oi(t.itemType);return"number"==typeof t.N?\`array<${Tt}n}, ${Tt}t.N}>\`:"value"===t.itemType.kind?"array":\`array<${Tt}n}>\`}return t.kind}const ai=[Xr,Yr,Kr,Zr,Qr,ri,ti,si(ni),ii];function ui(t,n){if("error"===n.kind)return null;if("array"===t.kind){if("array"===n.kind&&(0===n.N&&"value"===n.itemType.kind||!ui(t.itemType,n.itemType))&&("number"!=typeof t.N||t.N===n.N))return null}else{if(t.kind===n.kind)return null;if("value"===t.kind)for(const t of ai)if(!ui(t,n))return null}return\`Expected ${Tt}oi(t)} but found ${Tt}oi(n)} instead.\`}function li(t,n){return n.some((n=>n.kind===t.kind))}function hi(t,n){return n.some((n=>"null"===n?null===t:"array"===n?Array.isArray(t):"object"===n?t&&!Array.isArray(t)&&"object"==typeof t:n===typeof t))}var ci,fi={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function di(t){return(t=Math.round(t))<0?0:t>255?255:t}function pi(t){return di("%"===t[t.length-1]?parseFloat(t)/100*255:parseInt(t))}function yi(t){return function(t){return t<0?0:t>1?1:t}("%"===t[t.length-1]?parseFloat(t)/100:parseFloat(t))}function mi(t,n,e){return e<0?e+=1:e>1&&(e-=1),6*e<1?t+(n-t)*e*6:2*e<1?n:3*e<2?t+(n-t)*(2/3-e)*6:t}try{ci={}.parseCSSColor=function(t){var n,e=t.replace(/ /g,"").toLowerCase();if(e in fi)return fi[e].slice();if("#"===e[0])return 4===e.length?(n=parseInt(e.substr(1),16))>=0&&n<=4095?[(3840&n)>>4|(3840&n)>>8,240&n|(240&n)>>4,15&n|(15&n)<<4,1]:null:7===e.length&&(n=parseInt(e.substr(1),16))>=0&&n<=16777215?[(16711680&n)>>16,(65280&n)>>8,255&n,1]:null;var r=e.indexOf("("),i=e.indexOf(")");if(-1!==r&&i+1===e.length){var s=e.substr(0,r),o=e.substr(r+1,i-(r+1)).split(","),a=1;switch(s){case"rgba":if(4!==o.length)return null;a=yi(o.pop());case"rgb":return 3!==o.length?null:[pi(o[0]),pi(o[1]),pi(o[2]),a];case"hsla":if(4!==o.length)return null;a=yi(o.pop());case"hsl":if(3!==o.length)return null;var u=(parseFloat(o[0])%360+360)%360/360,l=yi(o[1]),h=yi(o[2]),c=h<=.5?h*(l+1):h+l-h*l,f=2*h-c;return[di(255*mi(f,c,u+1/3)),di(255*mi(f,c,u)),di(255*mi(f,c,u-1/3)),a];default:return null}}return null}}catch(dt){}class gi{constructor(t,n,e,r=1){this.r=t,this.g=n,this.b=e,this.a=r}static parse(t){if(!t)return;if(t instanceof gi)return t;if("string"!=typeof t)return;const n=ci(t);return n?new gi(n[0]/255*n[3],n[1]/255*n[3],n[2]/255*n[3],n[3]):void 0}toString(){const[t,n,e,r]=this.toArray();return\`rgba(${Tt}Math.round(t)},${Tt}Math.round(n)},${Tt}Math.round(e)},${Tt}r})\`}toArray(){const{r:t,g:n,b:e,a:r}=this;return 0===r?[0,0,0,0]:[255*t/r,255*n/r,255*e/r,r]}toArray01(){const{r:t,g:n,b:e,a:r}=this;return 0===r?[0,0,0,0]:[t/r,n/r,e/r,r]}toArray01PremultipliedAlpha(){const{r:t,g:n,b:e,a:r}=this;return[t,n,e,r]}}gi.black=new gi(0,0,0,1),gi.white=new gi(1,1,1,1),gi.transparent=new gi(0,0,0,0),gi.red=new gi(1,0,0,1),gi.blue=new gi(0,0,1,1);var vi=gi;class bi{constructor(t,n,e){this.sensitivity=t?n?"variant":"case":n?"accent":"base",this.locale=e,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,n){return this.collator.compare(t,n)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class wi{constructor(t,n,e,r,i){this.text=t.normalize?t.normalize():t,this.image=n,this.scale=e,this.fontStack=r,this.textColor=i}}class Mi{constructor(t){this.sections=t}static fromString(t){return new Mi([new wi(t,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((t=>0!==t.text.length||t.image&&0!==t.image.name.length))}static factory(t){return t instanceof Mi?t:Mi.fromString(t)}toString(){return 0===this.sections.length?"":this.sections.map((t=>t.text)).join("")}serialize(){const t=["format"];for(const n of this.sections){if(n.image){t.push(["image",n.image.name]);continue}t.push(n.text);const e={};n.fontStack&&(e["text-font"]=["literal",n.fontStack.split(",")]),n.scale&&(e["font-scale"]=n.scale),n.textColor&&(e["text-color"]=["rgba"].concat(n.textColor.toArray())),t.push(e)}return t}}class xi{constructor(t){this.name=t.name,this.available=t.available}toString(){return this.name}static fromString(t){return t?new xi({name:t,available:!1}):null}serialize(){return["image",this.name]}}function Fi(t,n,e,r){return"number"==typeof t&&t>=0&&t<=255&&"number"==typeof n&&n>=0&&n<=255&&"number"==typeof e&&e>=0&&e<=255?void 0===r||"number"==typeof r&&r>=0&&r<=1?null:\`Invalid rgba value [${Tt}[t,n,e,r].join(", ")}]: 'a' must be between 0 and 1.\`:\`Invalid rgba value [${Tt}("number"==typeof r?[t,n,e,r]:[t,n,e]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.\`}function ki(t){if(null===t)return!0;if("string"==typeof t)return!0;if("boolean"==typeof t)return!0;if("number"==typeof t)return!0;if(t instanceof vi)return!0;if(t instanceof bi)return!0;if(t instanceof Mi)return!0;if(t instanceof xi)return!0;if(Array.isArray(t)){for(const n of t)if(!ki(n))return!1;return!0}if("object"==typeof t){for(const n in t)if(!ki(t[n]))return!1;return!0}return!1}function Ai(t){if(null===t)return Xr;if("string"==typeof t)return Kr;if("boolean"==typeof t)return Zr;if("number"==typeof t)return Yr;if(t instanceof vi)return Qr;if(t instanceof bi)return ei;if(t instanceof Mi)return ri;if(t instanceof xi)return ii;if(Array.isArray(t)){const n=t.length;let e;for(const n of t){const t=Ai(n);if(e){if(e===t)continue;e=ni;break}e=t}return si(e||ni,n)}return ti}function Pi(t){const n=typeof t;return null===t?"":"string"===n||"number"===n||"boolean"===n?String(t):t instanceof vi||t instanceof Mi||t instanceof xi?t.toString():JSON.stringify(t)}class Si{constructor(t,n){this.type=t,this.value=n}static parse(t,n){if(2!==t.length)return n.error(\`'literal' expression requires exactly one argument, but found ${Tt}t.length-1} instead.\`);if(!ki(t[1]))return n.error("invalid value");const e=t[1];let r=Ai(e);const i=n.expectedType;return"array"!==r.kind||0!==r.N||!i||"array"!==i.kind||"number"==typeof i.N&&0!==i.N||(r=i),new Si(r,e)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof vi?["rgba"].concat(this.value.toArray()):this.value instanceof Mi?this.value.serialize():this.value}}var _i=Si,Oi=class{constructor(t){this.name="ExpressionEvaluationError",this.message=t}toJSON(){return this.message}};const Ci={string:Kr,number:Yr,boolean:Zr,object:ti};class Ei{constructor(t,n){this.type=t,this.args=n}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");let e,r=1;const i=t[0];if("array"===i){let i,s;if(t.length>2){const e=t[1];if("string"!=typeof e||!(e in Ci)||"object"===e)return n.error('The item type argument of "array" must be one of string, number, boolean',1);i=Ci[e],r++}else i=ni;if(t.length>3){if(null!==t[2]&&("number"!=typeof t[2]||t[2]<0||t[2]!==Math.floor(t[2])))return n.error('The length argument to "array" must be a positive integer literal',2);s=t[2],r++}e=si(i,s)}else e=Ci[i];const s=[];for(;r<t.length;r++){const e=n.parse(t[r],r,ni);if(!e)return null;s.push(e)}return new Ei(e,s)}evaluate(t){for(let n=0;n<this.args.length;n++){const e=this.args[n].evaluate(t);if(!ui(this.type,Ai(e)))return e;if(n===this.args.length-1)throw new Oi(\`Expected value to be of type ${Tt}oi(this.type)}, but found ${Tt}oi(Ai(e))} instead.\`)}return null}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every((t=>t.outputDefined()))}serialize(){const t=this.type,n=[t.kind];if("array"===t.kind){const e=t.itemType;if("string"===e.kind||"number"===e.kind||"boolean"===e.kind){n.push(e.kind);const r=t.N;("number"==typeof r||this.args.length>1)&&n.push(r)}}return n.concat(this.args.map((t=>t.serialize())))}}var Ii=Ei;class $i{constructor(t){this.type=ri,this.sections=t}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");const e=t[1];if(!Array.isArray(e)&&"object"==typeof e)return n.error("First argument must be an image or text section.");const r=[];let i=!1;for(let e=1;e<=t.length-1;++e){const s=t[e];if(i&&"object"==typeof s&&!Array.isArray(s)){i=!1;let t=null;if(s["font-scale"]&&(t=n.parse(s["font-scale"],1,Yr),!t))return null;let e=null;if(s["text-font"]&&(e=n.parse(s["text-font"],1,si(Kr)),!e))return null;let o=null;if(s["text-color"]&&(o=n.parse(s["text-color"],1,Qr),!o))return null;const a=r[r.length-1];a.scale=t,a.font=e,a.textColor=o}else{const s=n.parse(t[e],1,ni);if(!s)return null;const o=s.type.kind;if("string"!==o&&"value"!==o&&"null"!==o&&"resolvedImage"!==o)return n.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");i=!0,r.push({content:s,scale:null,font:null,textColor:null})}}return new $i(r)}evaluate(t){return new Mi(this.sections.map((n=>{const e=n.content.evaluate(t);return Ai(e)===ii?new wi("",e,null,null,null):new wi(Pi(e),null,n.scale?n.scale.evaluate(t):null,n.font?n.font.evaluate(t).join(","):null,n.textColor?n.textColor.evaluate(t):null)})))}eachChild(t){for(const n of this.sections)t(n.content),n.scale&&t(n.scale),n.font&&t(n.font),n.textColor&&t(n.textColor)}outputDefined(){return!1}serialize(){const t=["format"];for(const n of this.sections){t.push(n.content.serialize());const e={};n.scale&&(e["font-scale"]=n.scale.serialize()),n.font&&(e["text-font"]=n.font.serialize()),n.textColor&&(e["text-color"]=n.textColor.serialize()),t.push(e)}return t}}class Ti{constructor(t){this.type=ii,this.input=t}static parse(t,n){if(2!==t.length)return n.error("Expected two arguments.");const e=n.parse(t[1],1,Kr);return e?new Ti(e):n.error("No image name provided.")}evaluate(t){const n=this.input.evaluate(t),e=xi.fromString(n);return e&&t.availableImages&&(e.available=t.availableImages.indexOf(n)>-1),e}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){return["image",this.input.serialize()]}}const Di={"to-boolean":Zr,"to-color":Qr,"to-number":Yr,"to-string":Kr};class zi{constructor(t,n){this.type=t,this.args=n}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");const e=t[0];if(("to-boolean"===e||"to-string"===e)&&2!==t.length)return n.error("Expected one argument.");const r=Di[e],i=[];for(let e=1;e<t.length;e++){const r=n.parse(t[e],e,ni);if(!r)return null;i.push(r)}return new zi(r,i)}evaluate(t){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(t));if("color"===this.type.kind){let n,e;for(const r of this.args){if(n=r.evaluate(t),e=null,n instanceof vi)return n;if("string"==typeof n){const e=t.parseColor(n);if(e)return e}else if(Array.isArray(n)&&(e=n.length<3||n.length>4?\`Invalid rbga value ${Tt}JSON.stringify(n)}: expected an array containing either three or four numeric values.\`:Fi(n[0],n[1],n[2],n[3]),!e))return new vi(n[0]/255,n[1]/255,n[2]/255,n[3])}throw new Oi(e||\`Could not parse color from value '${Tt}"string"==typeof n?n:String(JSON.stringify(n))}'\`)}if("number"===this.type.kind){let n=null;for(const e of this.args){if(n=e.evaluate(t),null===n)return 0;const r=Number(n);if(!isNaN(r))return r}throw new Oi(\`Could not convert ${Tt}JSON.stringify(n)} to number.\`)}return"formatted"===this.type.kind?Mi.fromString(Pi(this.args[0].evaluate(t))):"resolvedImage"===this.type.kind?xi.fromString(Pi(this.args[0].evaluate(t))):Pi(this.args[0].evaluate(t))}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every((t=>t.outputDefined()))}serialize(){if("formatted"===this.type.kind)return new $i([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new Ti(this.args[0]).serialize();const t=[\`to-${Tt}this.type.kind}\`];return this.eachChild((n=>{t.push(n.serialize())})),t}}var ji=zi;const Ui=["Unknown","Point","LineString","Polygon"];var Ni=class{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this.H={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?Ui[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const t=this.featureDistanceData.center,n=this.featureDistanceData.scale,{x:e,y:r}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(e*n-t[0])+this.featureDistanceData.bearing[1]*(r*n-t[1])}return 0}parseColor(t){let n=this.H[t];return n||(n=this.H[t]=vi.parse(t)),n}};class Li{constructor(t,n,e,r){this.name=t,this.type=n,this.q=e,this.args=r}evaluate(t){return this.q(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((t=>t.serialize())))}static parse(t,n){const e=t[0],r=Li.definitions[e];if(!r)return n.error(\`Unknown expression "${Tt}e}". If you wanted a literal array, use ["literal", [...]].\`,0);const i=Array.isArray(r)?r[0]:r.type,s=Array.isArray(r)?[[r[1],r[2]]]:r.overloads,o=s.filter((([n])=>!Array.isArray(n)||n.length===t.length-1));let a=null;for(const[r,s]of o){a=new ds(n.registry,n.path,null,n.scope);const o=[];let u=!1;for(let n=1;n<t.length;n++){const e=t[n],i=Array.isArray(r)?r[n-1]:r.type,s=a.parse(e,1+o.length,i);if(!s){u=!0;break}o.push(s)}if(!u)if(Array.isArray(r)&&r.length!==o.length)a.error(\`Expected ${Tt}r.length} arguments, but found ${Tt}o.length} instead.\`);else{for(let t=0;t<o.length;t++){const n=Array.isArray(r)?r[t]:r.type,e=o[t];a.concat(t+1).checkSubtype(n,e.type)}if(0===a.errors.length)return new Li(e,i,s,o)}}if(1===o.length)n.errors.push(...a.errors);else{const e=(o.length?o:s).map((([t])=>{return n=t,Array.isArray(n)?\`(${Tt}n.map(oi).join(", ")})\`:\`(${Tt}oi(n.type)}...)\`;var n})).join(" | "),r=[];for(let e=1;e<t.length;e++){const i=n.parse(t[e],1+r.length);if(!i)return null;r.push(oi(i.type))}n.error(\`Expected arguments of type ${Tt}e}, but found (${Tt}r.join(", ")}) instead.\`)}return null}static register(t,n){Li.definitions=n;for(const e in n)t[e]=Li}}var Ri=Li;class Vi{constructor(t,n,e){this.type=ei,this.locale=e,this.caseSensitive=t,this.diacriticSensitive=n}static parse(t,n){if(2!==t.length)return n.error("Expected one argument.");const e=t[1];if("object"!=typeof e||Array.isArray(e))return n.error("Collator options argument must be an object.");const r=n.parse(void 0!==e["case-sensitive"]&&e["case-sensitive"],1,Zr);if(!r)return null;const i=n.parse(void 0!==e["diacritic-sensitive"]&&e["diacritic-sensitive"],1,Zr);if(!i)return null;let s=null;return e.locale&&(s=n.parse(e.locale,1,Kr),!s)?null:new Vi(r,i,s)}evaluate(t){return new bi(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}serialize(){const t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]}}const Hi=8192;function qi(t,n){t[0]=Math.min(t[0],n[0]),t[1]=Math.min(t[1],n[1]),t[2]=Math.max(t[2],n[0]),t[3]=Math.max(t[3],n[1])}function Gi(t,n){return!(t[0]<=n[0]||t[2]>=n[2]||t[1]<=n[1]||t[3]>=n[3])}function Ji(t,n){const e=(180+t[0])/360,r=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t[1]*Math.PI/360)))/360,i=Math.pow(2,n.z);return[Math.round(e*i*Hi),Math.round(r*i*Hi)]}function Wi(t,n,e){const r=t[0]-n[0],i=t[1]-n[1],s=t[0]-e[0],o=t[1]-e[1];return r*o-s*i==0&&r*s<=0&&i*o<=0}function Bi(t,n){let e=!1;for(let o=0,a=n.length;o<a;o++){const a=n[o];for(let n=0,o=a.length;n<o-1;n++){if(Wi(t,a[n],a[n+1]))return!1;(i=a[n])[1]>(r=t)[1]!=(s=a[n+1])[1]>r[1]&&r[0]<(s[0]-i[0])*(r[1]-i[1])/(s[1]-i[1])+i[0]&&(e=!e)}}var r,i,s;return e}function Xi(t,n){for(let e=0;e<n.length;e++)if(Bi(t,n[e]))return!0;return!1}function Yi(t,n,e,r){const i=r[0]-e[0],s=r[1]-e[1],o=(t[0]-e[0])*s-i*(t[1]-e[1]),a=(n[0]-e[0])*s-i*(n[1]-e[1]);return o>0&&a<0||o<0&&a>0}function Ki(t,n,e){for(const l of e)for(let e=0;e<l.length-1;++e)if(void 0,void 0,0!=(a=[(o=l[e+1])[0]-(s=l[e])[0],o[1]-s[1]])[0]*(u=[(i=n)[0]-(r=t)[0],i[1]-r[1]])[1]-a[1]*u[0]&&Yi(r,i,s,o)&&Yi(s,o,r,i))return!0;var r,i,s,o,a,u;return!1}function Zi(t,n){for(let e=0;e<t.length;++e)if(!Bi(t[e],n))return!1;for(let e=0;e<t.length-1;++e)if(Ki(t[e],t[e+1],n))return!1;return!0}function Qi(t,n){for(let e=0;e<n.length;e++)if(Zi(t,n[e]))return!0;return!1}function ts(t,n,e){const r=[];for(let i=0;i<t.length;i++){const s=[];for(let r=0;r<t[i].length;r++){const o=Ji(t[i][r],e);qi(n,o),s.push(o)}r.push(s)}return r}function ns(t,n,e){const r=[];for(let i=0;i<t.length;i++){const s=ts(t[i],n,e);r.push(s)}return r}function es(t,n,e,r){if(t[0]<e[0]||t[0]>e[2]){const n=.5*r;let i=t[0]-e[0]>n?-r:e[0]-t[0]>n?r:0;0===i&&(i=t[0]-e[2]>n?-r:e[2]-t[0]>n?r:0),t[0]+=i}qi(n,t)}function rs(t,n,e,r){const i=Math.pow(2,r.z)*Hi,s=[r.x*Hi,r.y*Hi],o=[];if(!t)return o;for(const r of t)for(const t of r){const r=[t.x+s[0],t.y+s[1]];es(r,n,e,i),o.push(r)}return o}function is(t,n,e,r){const i=Math.pow(2,r.z)*Hi,s=[r.x*Hi,r.y*Hi],o=[];if(!t)return o;for(const e of t){const t=[];for(const r of e){const e=[r.x+s[0],r.y+s[1]];qi(n,e),t.push(e)}o.push(t)}if(n[2]-n[0]<=i/2){(a=n)[0]=a[1]=1/0,a[2]=a[3]=-1/0;for(const t of o)for(const r of t)es(r,n,e,i)}var a;return o}class ss{constructor(t,n){this.type=Zr,this.geojson=t,this.geometries=n}static parse(t,n){if(2!==t.length)return n.error(\`'within' expression requires exactly one argument, but found ${Tt}t.length-1} instead.\`);if(ki(t[1])){const n=t[1];if("FeatureCollection"===n.type)for(let t=0;t<n.features.length;++t){const e=n.features[t].geometry.type;if("Polygon"===e||"MultiPolygon"===e)return new ss(n,n.features[t].geometry)}else if("Feature"===n.type){const t=n.geometry.type;if("Polygon"===t||"MultiPolygon"===t)return new ss(n,n.geometry)}else if("Polygon"===n.type||"MultiPolygon"===n.type)return new ss(n,n)}return n.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(null!=t.geometry()&&null!=t.canonicalID()){if("Point"===t.geometryType())return function(t,n){const e=[1/0,1/0,-1/0,-1/0],r=[1/0,1/0,-1/0,-1/0],i=t.canonicalID();if(!i)return!1;if("Polygon"===n.type){const s=ts(n.coordinates,r,i),o=rs(t.geometry(),e,r,i);if(!Gi(e,r))return!1;for(const t of o)if(!Bi(t,s))return!1}if("MultiPolygon"===n.type){const s=ns(n.coordinates,r,i),o=rs(t.geometry(),e,r,i);if(!Gi(e,r))return!1;for(const t of o)if(!Xi(t,s))return!1}return!0}(t,this.geometries);if("LineString"===t.geometryType())return function(t,n){const e=[1/0,1/0,-1/0,-1/0],r=[1/0,1/0,-1/0,-1/0],i=t.canonicalID();if(!i)return!1;if("Polygon"===n.type){const s=ts(n.coordinates,r,i),o=is(t.geometry(),e,r,i);if(!Gi(e,r))return!1;for(const t of o)if(!Zi(t,s))return!1}if("MultiPolygon"===n.type){const s=ns(n.coordinates,r,i),o=is(t.geometry(),e,r,i);if(!Gi(e,r))return!1;for(const t of o)if(!Qi(t,s))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var os=ss;function as(t){if(t instanceof Ri){if("get"===t.name&&1===t.args.length)return!1;if("feature-state"===t.name)return!1;if("has"===t.name&&1===t.args.length)return!1;if("properties"===t.name||"geometry-type"===t.name||"id"===t.name)return!1;if(/^filter-/.test(t.name))return!1}if(t instanceof os)return!1;let n=!0;return t.eachChild((t=>{n&&!as(t)&&(n=!1)})),n}function us(t){if(t instanceof Ri&&"feature-state"===t.name)return!1;let n=!0;return t.eachChild((t=>{n&&!us(t)&&(n=!1)})),n}function ls(t,n){if(t instanceof Ri&&n.indexOf(t.name)>=0)return!1;let e=!0;return t.eachChild((t=>{e&&!ls(t,n)&&(e=!1)})),e}class hs{constructor(t,n){this.type=n.type,this.name=t,this.boundExpression=n}static parse(t,n){if(2!==t.length||"string"!=typeof t[1])return n.error("'var' expression requires exactly one string literal argument.");const e=t[1];return n.scope.has(e)?new hs(e,n.scope.get(e)):n.error(\`Unknown variable "${Tt}e}". Make sure "${Tt}e}" has been bound in an enclosing "let" expression before using it.\`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}var cs=hs;class fs{constructor(t,n=[],e,r=new Br,i=[]){this.registry=t,this.path=n,this.key=n.map((t=>\`[${Tt}t}]\`)).join(""),this.scope=r,this.errors=i,this.expectedType=e}parse(t,n,e,r,i={}){return n?this.concat(n,e,r).G(t,i):this.G(t,i)}G(t,n){function e(t,n,e){return"assert"===e?new Ii(n,[t]):"coerce"===e?new ji(n,[t]):t}if(null!==t&&"string"!=typeof t&&"boolean"!=typeof t&&"number"!=typeof t||(t=["literal",t]),Array.isArray(t)){if(0===t.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const r=t[0];if("string"!=typeof r)return this.error(\`Expression name must be a string, but found ${Tt}typeof r} instead. If you wanted a literal array, use ["literal", [...]].\`,0),null;const i=this.registry[r];if(i){let r=i.parse(t,this);if(!r)return null;if(this.expectedType){const t=this.expectedType,i=r.type;if("string"!==t.kind&&"number"!==t.kind&&"boolean"!==t.kind&&"object"!==t.kind&&"array"!==t.kind||"value"!==i.kind)if("color"!==t.kind&&"formatted"!==t.kind&&"resolvedImage"!==t.kind||"value"!==i.kind&&"string"!==i.kind){if(this.checkSubtype(t,i))return null}else r=e(r,t,n.typeAnnotation||"coerce");else r=e(r,t,n.typeAnnotation||"assert")}if(!(r instanceof _i)&&"resolvedImage"!==r.type.kind&&ps(r)){const n=new Ni;try{r=new _i(r.type,r.evaluate(n))}catch(t){return this.error(t.message),null}}return r}return this.error(\`Unknown expression "${Tt}r}". If you wanted a literal array, use ["literal", [...]].\`,0)}return this.error(void 0===t?"'undefined' value invalid. Use null instead.":"object"==typeof t?'Bare objects invalid. Use ["literal", {...}] instead.':\`Expected an array, but found ${Tt}typeof t} instead.\`)}concat(t,n,e){const r="number"==typeof t?this.path.concat(t):this.path,i=e?this.scope.concat(e):this.scope;return new fs(this.registry,r,n||null,i,this.errors)}error(t,...n){const e=\`${Tt}this.key}${Tt}n.map((t=>\`[${Tt}t}]\`)).join("")}\`;this.errors.push(new Jr(e,t))}checkSubtype(t,n){const e=ui(t,n);return e&&this.error(e),e}}var ds=fs;function ps(t){if(t instanceof cs)return ps(t.boundExpression);if(t instanceof Ri&&"error"===t.name)return!1;if(t instanceof Vi)return!1;if(t instanceof os)return!1;const n=t instanceof ji||t instanceof Ii;let e=!0;return t.eachChild((t=>{e=n?e&&ps(t):e&&t instanceof _i})),!!e&&as(t)&&ls(t,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"])}function ys(t,n){const e=t.length-1;let r,i,s=0,o=e,a=0;for(;s<=o;)if(a=Math.floor((s+o)/2),r=t[a],i=t[a+1],r<=n){if(a===e||n<i)return a;s=a+1}else{if(!(r>n))throw new Oi("Input is not a number.");o=a-1}return 0}class ms{constructor(t,n,e){this.type=t,this.input=n,this.labels=[],this.outputs=[];for(const[t,n]of e)this.labels.push(t),this.outputs.push(n)}static parse(t,n){if(t.length-1<4)return n.error(\`Expected at least 4 arguments, but found only ${Tt}t.length-1}.\`);if((t.length-1)%2!=0)return n.error("Expected an even number of arguments.");const e=n.parse(t[1],1,Yr);if(!e)return null;const r=[];let i=null;n.expectedType&&"value"!==n.expectedType.kind&&(i=n.expectedType);for(let e=1;e<t.length;e+=2){const s=1===e?-1/0:t[e],o=t[e+1],a=e,u=e+1;if("number"!=typeof s)return n.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',a);if(r.length&&r[r.length-1][0]>=s)return n.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',a);const l=n.parse(o,u,i);if(!l)return null;i=i||l.type,r.push([s,l])}return new ms(i,e,r)}evaluate(t){const n=this.labels,e=this.outputs;if(1===n.length)return e[0].evaluate(t);const r=this.input.evaluate(t);if(r<=n[0])return e[0].evaluate(t);const i=n.length;return r>=n[i-1]?e[i-1].evaluate(t):e[ys(n,r)].evaluate(t)}eachChild(t){t(this.input);for(const n of this.outputs)t(n)}outputDefined(){return this.outputs.every((t=>t.outputDefined()))}serialize(){const t=["step",this.input.serialize()];for(let n=0;n<this.labels.length;n++)n>0&&t.push(this.labels[n]),t.push(this.outputs[n].serialize());return t}}var gs=ms,vs=bs;function bs(t,n,e,r){this.cx=3*t,this.bx=3*(e-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*n,this.by=3*(r-n)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=n,this.p2x=e,this.p2y=r}function ws(t,n,e){return t*(1-e)+n*e}bs.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(t,n){if(void 0===n&&(n=1e-6),t<0)return 0;if(t>1)return 1;for(var e=t,r=0;r<8;r++){var i=this.sampleCurveX(e)-t;if(Math.abs(i)<n)return e;var s=this.sampleCurveDerivativeX(e);if(Math.abs(s)<1e-6)break;e-=i/s}var o=0,a=1;for(e=t,r=0;r<20&&(i=this.sampleCurveX(e),!(Math.abs(i-t)<n));r++)t>i?o=e:a=e,e=.5*(a-o)+o;return e},solve:function(t,n){return this.sampleCurveY(this.solveCurveX(t,n))}};var Ms=Object.freeze({__proto__:null,number:ws,color:function(t,n,e){return new vi(ws(t.r,n.r,e),ws(t.g,n.g,e),ws(t.b,n.b,e),ws(t.a,n.a,e))},array:function(t,n,e){return t.map(((t,r)=>ws(t,n[r],e)))}});const xs=.95047,Fs=1.08883,ks=4/29,As=6/29,Ps=3*As*As,Ss=As*As*As,_s=Math.PI/180,Os=180/Math.PI;function Cs(t){return t>Ss?Math.pow(t,1/3):t/Ps+ks}function Es(t){return t>As?t*t*t:Ps*(t-ks)}function Is(t){return 255*(t<=.0031308?12.92*t:1.055*Math.pow(t,1/2.4)-.055)}function $s(t){return(t/=255)<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)}function Ts(t){const n=$s(t.r),e=$s(t.g),r=$s(t.b),i=Cs((.4124564*n+.3575761*e+.1804375*r)/xs),s=Cs((.2126729*n+.7151522*e+.072175*r)/1);return{l:116*s-16,a:500*(i-s),b:200*(s-Cs((.0193339*n+.119192*e+.9503041*r)/Fs)),alpha:t.a}}function Ds(t){let n=(t.l+16)/116,e=isNaN(t.a)?n:n+t.a/500,r=isNaN(t.b)?n:n-t.b/200;return n=1*Es(n),e=xs*Es(e),r=Fs*Es(r),new vi(Is(3.2404542*e-1.5371385*n-.4985314*r),Is(-.969266*e+1.8760108*n+.041556*r),Is(.0556434*e-.2040259*n+1.0572252*r),t.alpha)}function zs(t,n,e){const r=n-t;return t+e*(r>180||r<-180?r-360*Math.round(r/360):r)}const js={forward:Ts,reverse:Ds,interpolate:function(t,n,e){return{l:ws(t.l,n.l,e),a:ws(t.a,n.a,e),b:ws(t.b,n.b,e),alpha:ws(t.alpha,n.alpha,e)}}},Us={forward:function(t){const{l:n,a:e,b:r}=Ts(t),i=Math.atan2(r,e)*Os;return{h:i<0?i+360:i,c:Math.sqrt(e*e+r*r),l:n,alpha:t.a}},reverse:function(t){const n=t.h*_s,e=t.c;return Ds({l:t.l,a:Math.cos(n)*e,b:Math.sin(n)*e,alpha:t.alpha})},interpolate:function(t,n,e){return{h:zs(t.h,n.h,e),c:ws(t.c,n.c,e),l:ws(t.l,n.l,e),alpha:ws(t.alpha,n.alpha,e)}}};var Ns=Object.freeze({__proto__:null,lab:js,hcl:Us});class Ls{constructor(t,n,e,r,i){this.type=t,this.operator=n,this.interpolation=e,this.input=r,this.labels=[],this.outputs=[];for(const[t,n]of i)this.labels.push(t),this.outputs.push(n)}static interpolationFactor(t,n,e,r){let i=0;if("exponential"===t.name)i=Rs(n,t.base,e,r);else if("linear"===t.name)i=Rs(n,1,e,r);else if("cubic-bezier"===t.name){const s=t.controlPoints;i=new vs(s[0],s[1],s[2],s[3]).solve(Rs(n,1,e,r))}return i}static parse(t,n){let[e,r,i,...s]=t;if(!Array.isArray(r)||0===r.length)return n.error("Expected an interpolation type expression.",1);if("linear"===r[0])r={name:"linear"};else if("exponential"===r[0]){const t=r[1];if("number"!=typeof t)return n.error("Exponential interpolation requires a numeric base.",1,1);r={name:"exponential",base:t}}else{if("cubic-bezier"!==r[0])return n.error(\`Unknown interpolation type ${Tt}String(r[0])}\`,1,0);{const t=r.slice(1);if(4!==t.length||t.some((t=>"number"!=typeof t||t<0||t>1)))return n.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);r={name:"cubic-bezier",controlPoints:t}}}if(t.length-1<4)return n.error(\`Expected at least 4 arguments, but found only ${Tt}t.length-1}.\`);if((t.length-1)%2!=0)return n.error("Expected an even number of arguments.");if(i=n.parse(i,2,Yr),!i)return null;const o=[];let a=null;"interpolate-hcl"===e||"interpolate-lab"===e?a=Qr:n.expectedType&&"value"!==n.expectedType.kind&&(a=n.expectedType);for(let t=0;t<s.length;t+=2){const e=s[t],r=s[t+1],i=t+3,u=t+4;if("number"!=typeof e)return n.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',i);if(o.length&&o[o.length-1][0]>=e)return n.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',i);const l=n.parse(r,u,a);if(!l)return null;a=a||l.type,o.push([e,l])}return"number"===a.kind||"color"===a.kind||"array"===a.kind&&"number"===a.itemType.kind&&"number"==typeof a.N?new Ls(a,e,r,i,o):n.error(\`Type ${Tt}oi(a)} is not interpolatable.\`)}evaluate(t){const n=this.labels,e=this.outputs;if(1===n.length)return e[0].evaluate(t);const r=this.input.evaluate(t);if(r<=n[0])return e[0].evaluate(t);const i=n.length;if(r>=n[i-1])return e[i-1].evaluate(t);const s=ys(n,r),o=Ls.interpolationFactor(this.interpolation,r,n[s],n[s+1]),a=e[s].evaluate(t),u=e[s+1].evaluate(t);return"interpolate"===this.operator?Ms[this.type.kind.toLowerCase()](a,u,o):"interpolate-hcl"===this.operator?Us.reverse(Us.interpolate(Us.forward(a),Us.forward(u),o)):js.reverse(js.interpolate(js.forward(a),js.forward(u),o))}eachChild(t){t(this.input);for(const n of this.outputs)t(n)}outputDefined(){return this.outputs.every((t=>t.outputDefined()))}serialize(){let t;t="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const n=[this.operator,t,this.input.serialize()];for(let t=0;t<this.labels.length;t++)n.push(this.labels[t],this.outputs[t].serialize());return n}}function Rs(t,n,e,r){const i=r-e,s=t-e;return 0===i?0:1===n?s/i:(Math.pow(n,s)-1)/(Math.pow(n,i)-1)}var Vs=Ls;class Hs{constructor(t,n){this.type=t,this.args=n}static parse(t,n){if(t.length<2)return n.error("Expectected at least one argument.");let e=null;const r=n.expectedType;r&&"value"!==r.kind&&(e=r);const i=[];for(const r of t.slice(1)){const t=n.parse(r,1+i.length,e,void 0,{typeAnnotation:"omit"});if(!t)return null;e=e||t.type,i.push(t)}const s=r&&i.some((t=>ui(r,t.type)));return new Hs(s?ni:e,i)}evaluate(t){let n,e=null,r=0;for(const i of this.args){if(r++,e=i.evaluate(t),e&&e instanceof xi&&!e.available&&(n||(n=e),e=null,r===this.args.length))return n;if(null!==e)break}return e}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every((t=>t.outputDefined()))}serialize(){const t=["coalesce"];return this.eachChild((n=>{t.push(n.serialize())})),t}}var qs=Hs;class Gs{constructor(t,n){this.type=n.type,this.bindings=[].concat(t),this.result=n}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const n of this.bindings)t(n[1]);t(this.result)}static parse(t,n){if(t.length<4)return n.error(\`Expected at least 3 arguments, but found ${Tt}t.length-1} instead.\`);const e=[];for(let r=1;r<t.length-1;r+=2){const i=t[r];if("string"!=typeof i)return n.error(\`Expected string, but found ${Tt}typeof i} instead.\`,r);if(/[^a-zA-Z0-9_]/.test(i))return n.error("Variable names must contain only alphanumeric characters or '_'.",r);const s=n.parse(t[r+1],r+1);if(!s)return null;e.push([i,s])}const r=n.parse(t[t.length-1],t.length-1,n.expectedType,e);return r?new Gs(e,r):null}outputDefined(){return this.result.outputDefined()}serialize(){const t=["let"];for(const[n,e]of this.bindings)t.push(n,e.serialize());return t.push(this.result.serialize()),t}}var Js=Gs;class Ws{constructor(t,n,e){this.type=t,this.index=n,this.input=e}static parse(t,n){if(3!==t.length)return n.error(\`Expected 2 arguments, but found ${Tt}t.length-1} instead.\`);const e=n.parse(t[1],1,Yr),r=n.parse(t[2],2,si(n.expectedType||ni));return e&&r?new Ws(r.type.itemType,e,r):null}evaluate(t){const n=this.index.evaluate(t),e=this.input.evaluate(t);if(n<0)throw new Oi(\`Array index out of bounds: ${Tt}n} < 0.\`);if(n>=e.length)throw new Oi(\`Array index out of bounds: ${Tt}n} > ${Tt}e.length-1}.\`);if(n!==Math.floor(n))throw new Oi(\`Array index must be an integer, but found ${Tt}n} instead.\`);return e[n]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}var Bs=Ws;class Xs{constructor(t,n){this.type=Zr,this.needle=t,this.haystack=n}static parse(t,n){if(3!==t.length)return n.error(\`Expected 2 arguments, but found ${Tt}t.length-1} instead.\`);const e=n.parse(t[1],1,ni),r=n.parse(t[2],2,ni);return e&&r?li(e.type,[Zr,Kr,Yr,Xr,ni])?new Xs(e,r):n.error(\`Expected first argument to be of type boolean, string, number or null, but found ${Tt}oi(e.type)} instead\`):null}evaluate(t){const n=this.needle.evaluate(t),e=this.haystack.evaluate(t);if(null==e)return!1;if(!hi(n,["boolean","string","number","null"]))throw new Oi(\`Expected first argument to be of type boolean, string, number or null, but found ${Tt}oi(Ai(n))} instead.\`);if(!hi(e,["string","array"]))throw new Oi(\`Expected second argument to be of type array or string, but found ${Tt}oi(Ai(e))} instead.\`);return e.indexOf(n)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}var Ys=Xs;class Ks{constructor(t,n,e){this.type=Yr,this.needle=t,this.haystack=n,this.fromIndex=e}static parse(t,n){if(t.length<=2||t.length>=5)return n.error(\`Expected 3 or 4 arguments, but found ${Tt}t.length-1} instead.\`);const e=n.parse(t[1],1,ni),r=n.parse(t[2],2,ni);if(!e||!r)return null;if(!li(e.type,[Zr,Kr,Yr,Xr,ni]))return n.error(\`Expected first argument to be of type boolean, string, number or null, but found ${Tt}oi(e.type)} instead\`);if(4===t.length){const i=n.parse(t[3],3,Yr);return i?new Ks(e,r,i):null}return new Ks(e,r)}evaluate(t){const n=this.needle.evaluate(t),e=this.haystack.evaluate(t);if(!hi(n,["boolean","string","number","null"]))throw new Oi(\`Expected first argument to be of type boolean, string, number or null, but found ${Tt}oi(Ai(n))} instead.\`);if(!hi(e,["string","array"]))throw new Oi(\`Expected second argument to be of type array or string, but found ${Tt}oi(Ai(e))} instead.\`);if(this.fromIndex){const r=this.fromIndex.evaluate(t);return e.indexOf(n,r)}return e.indexOf(n)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const t=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}var Zs=Ks;class Qs{constructor(t,n,e,r,i,s){this.inputType=t,this.type=n,this.input=e,this.cases=r,this.outputs=i,this.otherwise=s}static parse(t,n){if(t.length<5)return n.error(\`Expected at least 4 arguments, but found only ${Tt}t.length-1}.\`);if(t.length%2!=1)return n.error("Expected an even number of arguments.");let e,r;n.expectedType&&"value"!==n.expectedType.kind&&(r=n.expectedType);const i={},s=[];for(let o=2;o<t.length-1;o+=2){let a=t[o];const u=t[o+1];Array.isArray(a)||(a=[a]);const l=n.concat(o);if(0===a.length)return l.error("Expected at least one branch label.");for(const t of a){if("number"!=typeof t&&"string"!=typeof t)return l.error("Branch labels must be numbers or strings.");if("number"==typeof t&&Math.abs(t)>Number.MAX_SAFE_INTEGER)return l.error(\`Branch labels must be integers no larger than ${Tt}Number.MAX_SAFE_INTEGER}.\`);if("number"==typeof t&&Math.floor(t)!==t)return l.error("Numeric branch labels must be integer values.");if(e){if(l.checkSubtype(e,Ai(t)))return null}else e=Ai(t);if(void 0!==i[String(t)])return l.error("Branch labels must be unique.");i[String(t)]=s.length}const h=n.parse(u,o,r);if(!h)return null;r=r||h.type,s.push(h)}const o=n.parse(t[1],1,ni);if(!o)return null;const a=n.parse(t[t.length-1],t.length-1,r);return a?"value"!==o.type.kind&&n.concat(1).checkSubtype(e,o.type)?null:new Qs(e,r,o,i,s,a):null}evaluate(t){const n=this.input.evaluate(t);return(Ai(n)===this.inputType&&this.outputs[this.cases[n]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every((t=>t.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const t=["match",this.input.serialize()],n=Object.keys(this.cases).sort(),e=[],r={};for(const t of n){const n=r[this.cases[t]];void 0===n?(r[this.cases[t]]=e.length,e.push([this.cases[t],[t]])):e[n][1].push(t)}const i=t=>"number"===this.inputType.kind?Number(t):t;for(const[n,r]of e)t.push(1===r.length?i(r[0]):r.map(i)),t.push(this.outputs[n].serialize());return t.push(this.otherwise.serialize()),t}}var to=Qs;class no{constructor(t,n,e){this.type=t,this.branches=n,this.otherwise=e}static parse(t,n){if(t.length<4)return n.error(\`Expected at least 3 arguments, but found only ${Tt}t.length-1}.\`);if(t.length%2!=0)return n.error("Expected an odd number of arguments.");let e;n.expectedType&&"value"!==n.expectedType.kind&&(e=n.expectedType);const r=[];for(let i=1;i<t.length-1;i+=2){const s=n.parse(t[i],i,Zr);if(!s)return null;const o=n.parse(t[i+1],i+1,e);if(!o)return null;r.push([s,o]),e=e||o.type}const i=n.parse(t[t.length-1],t.length-1,e);return i?new no(e,r,i):null}evaluate(t){for(const[n,e]of this.branches)if(n.evaluate(t))return e.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[n,e]of this.branches)t(n),t(e);t(this.otherwise)}outputDefined(){return this.branches.every((([t,n])=>n.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const t=["case"];return this.eachChild((n=>{t.push(n.serialize())})),t}}var eo=no;class ro{constructor(t,n,e,r){this.type=t,this.input=n,this.beginIndex=e,this.endIndex=r}static parse(t,n){if(t.length<=2||t.length>=5)return n.error(\`Expected 3 or 4 arguments, but found ${Tt}t.length-1} instead.\`);const e=n.parse(t[1],1,ni),r=n.parse(t[2],2,Yr);if(!e||!r)return null;if(!li(e.type,[si(ni),Kr,ni]))return n.error(\`Expected first argument to be of type array or string, but found ${Tt}oi(e.type)} instead\`);if(4===t.length){const i=n.parse(t[3],3,Yr);return i?new ro(e.type,e,r,i):null}return new ro(e.type,e,r)}evaluate(t){const n=this.input.evaluate(t),e=this.beginIndex.evaluate(t);if(!hi(n,["string","array"]))throw new Oi(\`Expected first argument to be of type array or string, but found ${Tt}oi(Ai(n))} instead.\`);if(this.endIndex){const r=this.endIndex.evaluate(t);return n.slice(e,r)}return n.slice(e)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const t=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}var io=ro;function so(t,n){return"=="===t||"!="===t?"boolean"===n.kind||"string"===n.kind||"number"===n.kind||"null"===n.kind||"value"===n.kind:"string"===n.kind||"number"===n.kind||"value"===n.kind}function oo(t,n,e,r){return 0===r.compare(n,e)}function ao(t,n,e){const r="=="!==t&&"!="!==t;return class i{constructor(t,n,e){this.type=Zr,this.lhs=t,this.rhs=n,this.collator=e,this.hasUntypedArgument="value"===t.type.kind||"value"===n.type.kind}static parse(t,n){if(3!==t.length&&4!==t.length)return n.error("Expected two or three arguments.");const e=t[0];let s=n.parse(t[1],1,ni);if(!s)return null;if(!so(e,s.type))return n.concat(1).error(\`"${Tt}e}" comparisons are not supported for type '${Tt}oi(s.type)}'.\`);let o=n.parse(t[2],2,ni);if(!o)return null;if(!so(e,o.type))return n.concat(2).error(\`"${Tt}e}" comparisons are not supported for type '${Tt}oi(o.type)}'.\`);if(s.type.kind!==o.type.kind&&"value"!==s.type.kind&&"value"!==o.type.kind)return n.error(\`Cannot compare types '${Tt}oi(s.type)}' and '${Tt}oi(o.type)}'.\`);r&&("value"===s.type.kind&&"value"!==o.type.kind?s=new Ii(o.type,[s]):"value"!==s.type.kind&&"value"===o.type.kind&&(o=new Ii(s.type,[o])));let a=null;if(4===t.length){if("string"!==s.type.kind&&"string"!==o.type.kind&&"value"!==s.type.kind&&"value"!==o.type.kind)return n.error("Cannot use collator to compare non-string types.");if(a=n.parse(t[3],3,ei),!a)return null}return new i(s,o,a)}evaluate(i){const s=this.lhs.evaluate(i),o=this.rhs.evaluate(i);if(r&&this.hasUntypedArgument){const n=Ai(s),e=Ai(o);if(n.kind!==e.kind||"string"!==n.kind&&"number"!==n.kind)throw new Oi(\`Expected arguments for "${Tt}t}" to be (string, string) or (number, number), but found (${Tt}n.kind}, ${Tt}e.kind}) instead.\`)}if(this.collator&&!r&&this.hasUntypedArgument){const t=Ai(s),e=Ai(o);if("string"!==t.kind||"string"!==e.kind)return n(i,s,o)}return this.collator?e(i,s,o,this.collator.evaluate(i)):n(i,s,o)}eachChild(t){t(this.lhs),t(this.rhs),this.collator&&t(this.collator)}outputDefined(){return!0}serialize(){const n=[t];return this.eachChild((t=>{n.push(t.serialize())})),n}}}const uo=ao("==",(function(t,n,e){return n===e}),oo),lo=ao("!=",(function(t,n,e){return n!==e}),(function(t,n,e,r){return!oo(0,n,e,r)})),ho=ao("<",(function(t,n,e){return n<e}),(function(t,n,e,r){return r.compare(n,e)<0})),co=ao(">",(function(t,n,e){return n>e}),(function(t,n,e,r){return r.compare(n,e)>0})),fo=ao("<=",(function(t,n,e){return n<=e}),(function(t,n,e,r){return r.compare(n,e)<=0})),po=ao(">=",(function(t,n,e){return n>=e}),(function(t,n,e,r){return r.compare(n,e)>=0}));class yo{constructor(t,n,e,r,i,s){this.type=Kr,this.number=t,this.locale=n,this.currency=e,this.unit=r,this.minFractionDigits=i,this.maxFractionDigits=s}static parse(t,n){if(3!==t.length)return n.error("Expected two arguments.");const e=n.parse(t[1],1,Yr);if(!e)return null;const r=t[2];if("object"!=typeof r||Array.isArray(r))return n.error("NumberFormat options argument must be an object.");let i=null;if(r.locale&&(i=n.parse(r.locale,1,Kr),!i))return null;let s=null;if(r.currency&&(s=n.parse(r.currency,1,Kr),!s))return null;let o=null;if(r.unit&&(o=n.parse(r.unit,1,Kr),!o))return null;let a=null;if(r["min-fraction-digits"]&&(a=n.parse(r["min-fraction-digits"],1,Yr),!a))return null;let u=null;return r["max-fraction-digits"]&&(u=n.parse(r["max-fraction-digits"],1,Yr),!u)?null:new yo(e,i,s,o,a,u)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(t):void 0,unit:this.unit?this.unit.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.unit&&t(this.unit),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.unit&&(t.unit=this.unit.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]}}class mo{constructor(t){this.type=Yr,this.input=t}static parse(t,n){if(2!==t.length)return n.error(\`Expected 1 argument, but found ${Tt}t.length-1} instead.\`);const e=n.parse(t[1],1);return e?"array"!==e.type.kind&&"string"!==e.type.kind&&"value"!==e.type.kind?n.error(\`Expected argument of type string or array, but found ${Tt}oi(e.type)} instead.\`):new mo(e):null}evaluate(t){const n=this.input.evaluate(t);if("string"==typeof n)return n.length;if(Array.isArray(n))return n.length;throw new Oi(\`Expected value to be of type string or array, but found ${Tt}oi(Ai(n))} instead.\`)}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){const t=["length"];return this.eachChild((n=>{t.push(n.serialize())})),t}}const go={"==":uo,"!=":lo,">":co,"<":ho,">=":po,"<=":fo,array:Ii,at:Bs,boolean:Ii,case:eo,coalesce:qs,collator:Vi,format:$i,image:Ti,in:Ys,"index-of":Zs,interpolate:Vs,"interpolate-hcl":Vs,"interpolate-lab":Vs,length:mo,let:Js,literal:_i,match:to,number:Ii,"number-format":yo,object:Ii,slice:io,step:gs,string:Ii,"to-boolean":ji,"to-color":ji,"to-number":ji,"to-string":ji,var:cs,within:os};function vo(t,[n,e,r,i]){n=n.evaluate(t),e=e.evaluate(t),r=r.evaluate(t);const s=i?i.evaluate(t):1,o=Fi(n,e,r,s);if(o)throw new Oi(o);return new vi(n/255*s,e/255*s,r/255*s,s)}function bo(t,n){return t in n}function wo(t,n){const e=n[t];return void 0===e?null:e}function Mo(t){return{type:t}}Ri.register(go,{error:[{kind:"error"},[Kr],(t,[n])=>{throw new Oi(n.evaluate(t))}],typeof:[Kr,[ni],(t,[n])=>oi(Ai(n.evaluate(t)))],"to-rgba":[si(Yr,4),[Qr],(t,[n])=>n.evaluate(t).toArray()],rgb:[Qr,[Yr,Yr,Yr],vo],rgba:[Qr,[Yr,Yr,Yr,Yr],vo],has:{type:Zr,overloads:[[[Kr],(t,[n])=>bo(n.evaluate(t),t.properties())],[[Kr,ti],(t,[n,e])=>bo(n.evaluate(t),e.evaluate(t))]]},get:{type:ni,overloads:[[[Kr],(t,[n])=>wo(n.evaluate(t),t.properties())],[[Kr,ti],(t,[n,e])=>wo(n.evaluate(t),e.evaluate(t))]]},"feature-state":[ni,[Kr],(t,[n])=>wo(n.evaluate(t),t.featureState||{})],properties:[ti,[],t=>t.properties()],"geometry-type":[Kr,[],t=>t.geometryType()],id:[ni,[],t=>t.id()],zoom:[Yr,[],t=>t.globals.zoom],pitch:[Yr,[],t=>t.globals.pitch||0],"distance-from-center":[Yr,[],t=>t.distanceFromCenter()],"heatmap-density":[Yr,[],t=>t.globals.heatmapDensity||0],"line-progress":[Yr,[],t=>t.globals.lineProgress||0],"sky-radial-progress":[Yr,[],t=>t.globals.skyRadialProgress||0],accumulated:[ni,[],t=>void 0===t.globals.accumulated?null:t.globals.accumulated],"+":[Yr,Mo(Yr),(t,n)=>{let e=0;for(const r of n)e+=r.evaluate(t);return e}],"*":[Yr,Mo(Yr),(t,n)=>{let e=1;for(const r of n)e*=r.evaluate(t);return e}],"-":{type:Yr,overloads:[[[Yr,Yr],(t,[n,e])=>n.evaluate(t)-e.evaluate(t)],[[Yr],(t,[n])=>-n.evaluate(t)]]},"/":[Yr,[Yr,Yr],(t,[n,e])=>n.evaluate(t)/e.evaluate(t)],"%":[Yr,[Yr,Yr],(t,[n,e])=>n.evaluate(t)%e.evaluate(t)],ln2:[Yr,[],()=>Math.LN2],pi:[Yr,[],()=>Math.PI],e:[Yr,[],()=>Math.E],"^":[Yr,[Yr,Yr],(t,[n,e])=>Math.pow(n.evaluate(t),e.evaluate(t))],sqrt:[Yr,[Yr],(t,[n])=>Math.sqrt(n.evaluate(t))],log10:[Yr,[Yr],(t,[n])=>Math.log(n.evaluate(t))/Math.LN10],ln:[Yr,[Yr],(t,[n])=>Math.log(n.evaluate(t))],log2:[Yr,[Yr],(t,[n])=>Math.log(n.evaluate(t))/Math.LN2],sin:[Yr,[Yr],(t,[n])=>Math.sin(n.evaluate(t))],cos:[Yr,[Yr],(t,[n])=>Math.cos(n.evaluate(t))],tan:[Yr,[Yr],(t,[n])=>Math.tan(n.evaluate(t))],asin:[Yr,[Yr],(t,[n])=>Math.asin(n.evaluate(t))],acos:[Yr,[Yr],(t,[n])=>Math.acos(n.evaluate(t))],atan:[Yr,[Yr],(t,[n])=>Math.atan(n.evaluate(t))],min:[Yr,Mo(Yr),(t,n)=>Math.min(...n.map((n=>n.evaluate(t))))],max:[Yr,Mo(Yr),(t,n)=>Math.max(...n.map((n=>n.evaluate(t))))],abs:[Yr,[Yr],(t,[n])=>Math.abs(n.evaluate(t))],round:[Yr,[Yr],(t,[n])=>{const e=n.evaluate(t);return e<0?-Math.round(-e):Math.round(e)}],floor:[Yr,[Yr],(t,[n])=>Math.floor(n.evaluate(t))],ceil:[Yr,[Yr],(t,[n])=>Math.ceil(n.evaluate(t))],"filter-==":[Zr,[Kr,ni],(t,[n,e])=>t.properties()[n.value]===e.value],"filter-id-==":[Zr,[ni],(t,[n])=>t.id()===n.value],"filter-type-==":[Zr,[Kr],(t,[n])=>t.geometryType()===n.value],"filter-<":[Zr,[Kr,ni],(t,[n,e])=>{const r=t.properties()[n.value],i=e.value;return typeof r==typeof i&&r<i}],"filter-id-<":[Zr,[ni],(t,[n])=>{const e=t.id(),r=n.value;return typeof e==typeof r&&e<r}],"filter->":[Zr,[Kr,ni],(t,[n,e])=>{const r=t.properties()[n.value],i=e.value;return typeof r==typeof i&&r>i}],"filter-id->":[Zr,[ni],(t,[n])=>{const e=t.id(),r=n.value;return typeof e==typeof r&&e>r}],"filter-<=":[Zr,[Kr,ni],(t,[n,e])=>{const r=t.properties()[n.value],i=e.value;return typeof r==typeof i&&r<=i}],"filter-id-<=":[Zr,[ni],(t,[n])=>{const e=t.id(),r=n.value;return typeof e==typeof r&&e<=r}],"filter->=":[Zr,[Kr,ni],(t,[n,e])=>{const r=t.properties()[n.value],i=e.value;return typeof r==typeof i&&r>=i}],"filter-id->=":[Zr,[ni],(t,[n])=>{const e=t.id(),r=n.value;return typeof e==typeof r&&e>=r}],"filter-has":[Zr,[ni],(t,[n])=>n.value in t.properties()],"filter-has-id":[Zr,[],t=>null!==t.id()&&void 0!==t.id()],"filter-type-in":[Zr,[si(Kr)],(t,[n])=>n.value.indexOf(t.geometryType())>=0],"filter-id-in":[Zr,[si(ni)],(t,[n])=>n.value.indexOf(t.id())>=0],"filter-in-small":[Zr,[Kr,si(ni)],(t,[n,e])=>e.value.indexOf(t.properties()[n.value])>=0],"filter-in-large":[Zr,[Kr,si(ni)],(t,[n,e])=>function(t,n,e,r){for(;e<=r;){const i=e+r>>1;if(n[i]===t)return!0;n[i]>t?r=i-1:e=i+1}return!1}(t.properties()[n.value],e.value,0,e.value.length-1)],all:{type:Zr,overloads:[[[Zr,Zr],(t,[n,e])=>n.evaluate(t)&&e.evaluate(t)],[Mo(Zr),(t,n)=>{for(const e of n)if(!e.evaluate(t))return!1;return!0}]]},any:{type:Zr,overloads:[[[Zr,Zr],(t,[n,e])=>n.evaluate(t)||e.evaluate(t)],[Mo(Zr),(t,n)=>{for(const e of n)if(e.evaluate(t))return!0;return!1}]]},"!":[Zr,[Zr],(t,[n])=>!n.evaluate(t)],"is-supported-script":[Zr,[Kr],(t,[n])=>{const e=t.globals&&t.globals.isSupportedScript;return!e||e(n.evaluate(t))}],upcase:[Kr,[Kr],(t,[n])=>n.evaluate(t).toUpperCase()],downcase:[Kr,[Kr],(t,[n])=>n.evaluate(t).toLowerCase()],concat:[Kr,Mo(ni),(t,n)=>n.map((n=>Pi(n.evaluate(t)))).join("")],"resolved-locale":[Kr,[ei],(t,[n])=>n.evaluate(t).resolvedLocale()]});var xo=go;function Fo(t){return{result:"success",value:t}}function ko(t){return{result:"error",value:t}}function Ao(t){return!!t.expression&&t.expression.interpolated}function Po(t){return t instanceof Number?"number":t instanceof String?"string":t instanceof Boolean?"boolean":Array.isArray(t)?"array":null===t?"null":typeof t}function So(t){return"object"==typeof t&&null!==t&&!Array.isArray(t)}function _o(t){return t}function Oo(t,n){const e="color"===n.type,r=t.stops&&"object"==typeof t.stops[0][0],i=r||!(r||void 0!==t.property),s=t.type||(Ao(n)?"exponential":"interval");if(e&&((t=qr({},t)).stops&&(t.stops=t.stops.map((t=>[t[0],vi.parse(t[1])]))),t.default=vi.parse(t.default?t.default:n.default)),t.colorSpace&&"rgb"!==t.colorSpace&&!Ns[t.colorSpace])throw new Error(\`Unknown color space: ${Tt}t.colorSpace}\`);let o,a,u;if("exponential"===s)o=$o;else if("interval"===s)o=Io;else if("categorical"===s){o=Eo,a=Object.create(null);for(const n of t.stops)a[n[0]]=n[1];u=typeof t.stops[0][0]}else{if("identity"!==s)throw new Error(\`Unknown function type "${Tt}s}"\`);o=To}if(r){const e={},r=[];for(let n=0;n<t.stops.length;n++){const i=t.stops[n],s=i[0].zoom;void 0===e[s]&&(e[s]={zoom:s,type:t.type,property:t.property,default:t.default,stops:[]},r.push(s)),e[s].stops.push([i[0].value,i[1]])}const i=[];for(const t of r)i.push([e[t].zoom,Oo(e[t],n)]);const s={name:"linear"};return{kind:"composite",interpolationType:s,interpolationFactor:Vs.interpolationFactor.bind(void 0,s),zoomStops:i.map((t=>t[0])),evaluate:({zoom:e},r)=>$o({stops:i,base:t.base},n,e).evaluate(e,r)}}if(i){const e="exponential"===s?{name:"exponential",base:void 0!==t.base?t.base:1}:null;return{kind:"camera",interpolationType:e,interpolationFactor:Vs.interpolationFactor.bind(void 0,e),zoomStops:t.stops.map((t=>t[0])),evaluate:({zoom:e})=>o(t,n,e,a,u)}}return{kind:"source",evaluate(e,r){const i=r&&r.properties?r.properties[t.property]:void 0;return void 0===i?Co(t.default,n.default):o(t,n,i,a,u)}}}function Co(t,n,e){return void 0!==t?t:void 0!==n?n:void 0!==e?e:void 0}function Eo(t,n,e,r,i){return Co(typeof e===i?r[e]:void 0,t.default,n.default)}function Io(t,n,e){if("number"!==Po(e))return Co(t.default,n.default);const r=t.stops.length;if(1===r)return t.stops[0][1];if(e<=t.stops[0][0])return t.stops[0][1];if(e>=t.stops[r-1][0])return t.stops[r-1][1];const i=ys(t.stops.map((t=>t[0])),e);return t.stops[i][1]}function $o(t,n,e){const r=void 0!==t.base?t.base:1;if("number"!==Po(e))return Co(t.default,n.default);const i=t.stops.length;if(1===i)return t.stops[0][1];if(e<=t.stops[0][0])return t.stops[0][1];if(e>=t.stops[i-1][0])return t.stops[i-1][1];const s=ys(t.stops.map((t=>t[0])),e),o=function(t,n,e,r){const i=r-e,s=t-e;return 0===i?0:1===n?s/i:(Math.pow(n,s)-1)/(Math.pow(n,i)-1)}(e,r,t.stops[s][0],t.stops[s+1][0]),a=t.stops[s][1],u=t.stops[s+1][1];let l=Ms[n.type]||_o;if(t.colorSpace&&"rgb"!==t.colorSpace){const n=Ns[t.colorSpace];l=(t,e)=>n.reverse(n.interpolate(n.forward(t),n.forward(e),o))}return"function"==typeof a.evaluate?{evaluate(...t){const n=a.evaluate.apply(void 0,t),e=u.evaluate.apply(void 0,t);if(void 0!==n&&void 0!==e)return l(n,e,o)}}:l(a,u,o)}function To(t,n,e){return"color"===n.type?e=vi.parse(e):"formatted"===n.type?e=Mi.fromString(e.toString()):"resolvedImage"===n.type?e=xi.fromString(e.toString()):Po(e)===n.type||"enum"===n.type&&n.values[e]||(e=void 0),Co(e,t.default,n.default)}class Do{constructor(t,n){this.expression=t,this.J={},this.W=new Ni,this.B=n?function(t){return"color"===t.type&&(So(t.default)||Array.isArray(t.default))?new vi(0,0,0,0):"color"===t.type?vi.parse(t.default)||null:void 0===t.default?null:t.default}(n):null,this.X=n&&"enum"===n.type?n.values:null}evaluateWithoutErrorHandling(t,n,e,r,i,s,o,a){return this.W.globals=t,this.W.feature=n,this.W.featureState=e,this.W.canonical=r||null,this.W.availableImages=i||null,this.W.formattedSection=s,this.W.featureTileCoord=o||null,this.W.featureDistanceData=a||null,this.expression.evaluate(this.W)}evaluate(t,n,e,r,i,s,o,a){this.W.globals=t,this.W.feature=n||null,this.W.featureState=e||null,this.W.canonical=r||null,this.W.availableImages=i||null,this.W.formattedSection=s||null,this.W.featureTileCoord=o||null,this.W.featureDistanceData=a||null;try{const t=this.expression.evaluate(this.W);if(null==t||"number"==typeof t&&t!=t)return this.B;if(this.X&&!(t in this.X))throw new Oi(\`Expected value to be one of ${Tt}Object.keys(this.X).map((t=>JSON.stringify(t))).join(", ")}, but found ${Tt}JSON.stringify(t)} instead.\`);return t}catch(t){return this.J[t.message]||(this.J[t.message]=!0,"undefined"!=typeof console&&console.warn(t.message)),this.B}}}function zo(t){return Array.isArray(t)&&t.length>0&&"string"==typeof t[0]&&t[0]in xo}function jo(t,n){const e=new ds(xo,[],n?function(t){const n={color:Qr,string:Kr,number:Yr,enum:Kr,boolean:Zr,formatted:ri,resolvedImage:ii};return"array"===t.type?si(n[t.value]||ni,t.length):n[t.type]}(n):void 0),r=e.parse(t,void 0,void 0,void 0,n&&"string"===n.type?{typeAnnotation:"coerce"}:void 0);return r?Fo(new Do(r,n)):ko(e.errors)}class Uo{constructor(t,n){this.kind=t,this.Y=n,this.isStateDependent="constant"!==t&&!us(n.expression)}evaluateWithoutErrorHandling(t,n,e,r,i,s){return this.Y.evaluateWithoutErrorHandling(t,n,e,r,i,s)}evaluate(t,n,e,r,i,s){return this.Y.evaluate(t,n,e,r,i,s)}}class No{constructor(t,n,e,r){this.kind=t,this.zoomStops=e,this.Y=n,this.isStateDependent="camera"!==t&&!us(n.expression),this.interpolationType=r}evaluateWithoutErrorHandling(t,n,e,r,i,s){return this.Y.evaluateWithoutErrorHandling(t,n,e,r,i,s)}evaluate(t,n,e,r,i,s){return this.Y.evaluate(t,n,e,r,i,s)}interpolationFactor(t,n,e){return this.interpolationType?Vs.interpolationFactor(this.interpolationType,t,n,e):0}}function Lo(t,n){if("error"===(t=jo(t,n)).result)return t;const e=t.value.expression,r=as(e);if(!r&&!function(t){return"data-driven"===t["property-type"]}(n))return ko([new Jr("","data expressions not supported")]);const i=ls(e,["zoom","pitch","distance-from-center"]);if(!i&&!function(t){return!!t.expression&&t.expression.parameters.indexOf("zoom")>-1}(n))return ko([new Jr("","zoom expressions not supported")]);const s=Vo(e);if(!s&&!i)return ko([new Jr("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')]);if(s instanceof Jr)return ko([s]);if(s instanceof Vs&&!Ao(n))return ko([new Jr("",'"interpolate" expressions cannot be used with this property')]);if(!s)return Fo(new Uo(r?"constant":"source",t.value));const o=s instanceof Vs?s.interpolation:void 0;return Fo(new No(r?"camera":"composite",t.value,s.labels,o))}class Ro{constructor(t,n){this.K=t,this.Z=n,qr(this,Oo(this.K,this.Z))}static deserialize(t){return new Ro(t.K,t.Z)}static serialize(t){return{K:t.K,Z:t.Z}}}function Vo(t){let n=null;if(t instanceof Js)n=Vo(t.result);else if(t instanceof qs){for(const e of t.args)if(n=Vo(e),n)break}else(t instanceof gs||t instanceof Vs)&&t.input instanceof Ri&&"zoom"===t.input.name&&(n=t);return n instanceof Jr||t.eachChild((t=>{const e=Vo(t);e instanceof Jr?n=e:!n&&e?n=new Jr("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):n&&e&&n!==e&&(n=new Jr("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),n}function Ho(t){if(Array.isArray(t))return t.map(Ho);if(t instanceof Object&&!(t instanceof Number||t instanceof String||t instanceof Boolean)){const n={};for(const e in t)n[e]=Ho(t[e]);return n}return function(t){return t instanceof Number||t instanceof String||t instanceof Boolean?t.valueOf():t}(t)}function qo(t,n="fill"){if(null==t)return{filter:()=>!0,needGeometry:!1,needFeature:!1};const e=t;let r=!0;try{r=function(t){if(!Wo(t))return t;let n=Ho(t);return Jo(n),n=Go(n),n}(e)}catch(t){console.warn(\`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\\nand paste the contents of this message in the report.\\nThank you!\\nFilter Expression:\\n${Tt}JSON.stringify(e,null,2)}\\n        \`)}const i=jo(r,null);let s=null;if("error"===i.result)throw new Error(i.value.map((t=>\`${Tt}t.key}: ${Tt}t.message}\`)).join(", "));s=(t,n,e)=>i.value.evaluate(t,n,{},e);let o=null,a=null;if(r!==e){const t=jo(e,null);if("error"===t.result)throw new Error(t.value.map((t=>\`${Tt}t.key}: ${Tt}t.message}\`)).join(", "));o=(n,e,r,i,s)=>t.value.evaluate(n,e,{},r,void 0,void 0,i,s),a=!as(t.value.expression)}return{filter:s,dynamicFilter:o||void 0,needGeometry:Xo(r),needFeature:!!a}}function Go(t){if(!Array.isArray(t))return t;const n=function(t){if(Bo.has(t[0]))for(let n=1;n<t.length;n++)if(Wo(t[n]))return!0;return t}(t);return!0===n?n:n.map((t=>Go(t)))}function Jo(t){let n=!1;const e=[];if("case"===t[0]){for(let r=1;r<t.length-1;r+=2)n=n||Wo(t[r]),e.push(t[r+1]);e.push(t[t.length-1])}else if("match"===t[0]){n=n||Wo(t[1]);for(let n=2;n<t.length-1;n+=2)e.push(t[n+1]);e.push(t[t.length-1])}else if("step"===t[0]){n=n||Wo(t[1]);for(let n=1;n<t.length-1;n+=2)e.push(t[n+1])}n&&(t.length=0,t.push("any",...e));for(let n=1;n<t.length;n++)Jo(t[n])}function Wo(t){if(!Array.isArray(t))return!1;if(function(t){return"pitch"===t||"distance-from-center"===t}(t[0]))return!0;for(let n=1;n<t.length;n++)if(Wo(t[n]))return!0;return!1}const Bo=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Xo(t){if(!Array.isArray(t))return!1;if("within"===t[0])return!0;for(let n=1;n<t.length;n++)if(Xo(t[n]))return!0;return!1}const Yo={StyleExpression:Do,isExpression:zo,isExpressionFilter:function t(n){if(!0===n||!1===n)return!0;if(!Array.isArray(n)||0===n.length)return!1;switch(n[0]){case"has":return n.length>=2&&"$id"!==n[1]&&"$type"!==n[1];case"in":return n.length>=3&&("string"!=typeof n[1]||Array.isArray(n[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==n.length||Array.isArray(n[1])||Array.isArray(n[2]);case"any":case"all":for(const e of n.slice(1))if(!t(e)&&"boolean"!=typeof e)return!1;return!0;default:return!0}},createExpression:jo,createPropertyExpression:Lo,normalizePropertyExpression:function(t,n){if(So(t))return new Ro(t,n);if(zo(t)){const e=Lo(t,n);if("error"===e.result)throw new Error(e.value.map((t=>\`${Tt}t.key}: ${Tt}t.message}\`)).join(", "));return e.value}{let e=t;return"string"==typeof t&&"color"===n.type&&(e=vi.parse(t)),{kind:"constant",evaluate:()=>e}}},ZoomConstantExpression:Uo,ZoomDependentExpression:No,StylePropertyFunction:Ro},{isExpression:Ko,createExpression:Zo}=Yo,Qo={};function ta(t){if(!Array.isArray(t))return ta([t]);const n=[];for(let e=0;e<t.length;e++){let r;r=!0===t[e].filter?function(){return!0}:na(t[e].filter),n.push(br({},t[e],{filter:r}))}return n}function na(t){if(!0===t)return function(){return!0};if(t&&t.condition){if("any"===t.type){const n=t.condition,e=[];for(let t=0;t<n.length;t++)e.push(na(n[t]));return(t,n)=>{for(let r=0;r<e.length;r++)if(e[r](t,n))return!0;return!1}}const n=na(t.condition);if(wr(t.layer))return n;const e=n=>n.layer===t.layer;return(t,r)=>e(t)&&n(t,r)}if(hn(t))return ln(t);{let n=qo(t);n=n&&n.filter;const e=(t,e)=>(Qo.zoom=e,n&&n(Qo,t));return e}}const ea={type:"number","property-type":"data-driven",expression:{parameters:["zoom","feature"]}};function ra(t,n){ea.type=n||"number";const e=Zo(t,ea);if("success"!==e.result)throw new Error(\`Invalid maplibre spec expression: ${Tt}JSON.stringify(t)} (${Tt}e.value})\`);return e.value}function ia(t){return Ko(t)}const sa={lineWidth:1,lineStrokeWidth:1,lineDx:1,lineDy:1,lineOpacity:1,linePatternAnimSpeed:1,markerWidth:1,markerHeight:1,markerDx:1,markerDy:1,markerSpacing:1,markerOpacity:1,markerRotation:1,textWrapWidth:1,textSpacing:1,textSize:1,textHaloRadius:1,textHaloOpacity:1,textDx:1,textDy:1,textOpacity:1,textRotation:1,polygonOpacity:1};function oa(t){return sa[t]}const aa={markerPlacement:1,markerFile:1,mergeOnProperty:1,markerTextFit:1,markerType:1,markerHorizontalAlignment:1,markerVerticalAlignment:1,markerRotationAlignment:1,markerPitchAlignment:1,markerFillPatternFile:1,markerLinePatternFile:1,textName:1,textPlacement:1,textFaceName:1,textStyle:1,textHorizontalAlignment:1,textVerticalAlignment:1,textRotationAlignment:1,textPitchAlignment:1,lineJoin:1,lineCap:1,linePatternFile:1,polygonPatternFile:1},ua={lineDasharray:1,markerLineDasharray:1,uvScale:1,uvOffset:1};function la(t){return aa[t]?"string":oa(t)?"number":ua[t]?"array":"color"}var ha=Object.freeze({__proto__:null,compileFilter:na,compileStyle:function(t=[]){return ta(t=t.map((t=>{const n=br({},t);return n.filter&&n.filter.value&&(n.filter=n.filter.value),n})))},createExpression:ra,getExpressionType:la,isExpression:ia,isInterpolated:oa});const ca="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,fa=function(t){return class extends t{pushIn(...t){const n=t.length;for(let e=0;e<n;e++)this[this.currentIndex++]=t[e]}fill(t,n,e){super.fill(t,n,e),e>this.currentIndex&&(this.currentIndex=e)}set(t,n){t>=this.currentIndex&&(this.currentIndex=t+1),this[t]=n}getLength(){return this.currentIndex}setLength(t){this.currentIndex=t,super.length<t&&(super.length=t)}trySetLength(t){t>this.currentIndex&&this.setLength(t)}reset(){this.currentIndex=0}slice(t,n){const e=super.slice(t,n);return e.currentIndex=n-t,e}}},da=fa(Array),pa={get:function(t,n){return"length"===n?t.getLength():t[n]}};class ya extends Array{setLength(t){this.length=t,this.currentIndex=t}trySetLength(t){this.length=t,this.currentIndex=t}getLength(){return this.length}}let ma;class ga{static createTypedArray(t,n){return gr(t,n)}static getInstance(){return ma}static ensureCapacity(t,n){if(!t.BYTES_PER_ELEMENT)return t;if(t.length>=n)return t;const e=new t.constructor(n+Math.ceil(.5*n)),r=t.getLength();for(let n=0;n<r;n++)e[n]=t[n];return e.currentIndex=t.currentIndex,e}static getArray(t){let n;if(t){const e=fa(t);n=new e(1048576/e.BYTES_PER_ELEMENT)}else n=new da;return n.push=(...t)=>{n.pushIn(...t)},n}static getProxyArray(){const t=new da,n=new Proxy(t,pa);return n.push=(...n)=>{t.pushIn(...n)},n.R=t,n}constructor(){this.tt=[],this.nt=0,this.et=[],this.rt=0,this.it={}}getProxy(){if(!ca){const t=new ya;return t.currentIndex=0,t}const t=this.et[this.rt]=this.et[this.rt]||ga.getProxyArray();return t.reset(),this.rt++,t}get(t){if(!ca){const t=new ya;return t.currentIndex=0,t}if(t){const n=t.name;let e=this.it[n];e||(e=this.it[n]={arrays:[],index:0});const r=e.index,i=e.arrays[r]=e.arrays[r]||ga.getArray(t);return i.reset(),e.index++,i}const n=this.tt[this.nt]=this.tt[this.nt]||ga.getArray();return n.reset(),this.nt++,n}reset(){this.nt=0,this.rt=0;for(const t in this.it)this.it[t].index=0}}ma=new ga;const va="__fea_idx",ba=[],wa={},Ma={},xa={},Fa=[],ka=ga.getInstance(),Aa=Math.pow(2,17);class Pa{static isAtlasLoaded(t,n={}){const{iconAtlas:e}=n;return!!(!t||e&&e.positions[t])}static genFnTypes(t){const n={};for(const e in t)if(ia(t[e])){const r=(e+"_Fn_0").trim(),i=(e+"Fn").trim(),s=la(e);n[r]=ra(t[e],s),n[i]=(t,e)=>{let i;wa.zoom=t,Ma.properties=e;try{i=n[r].evaluateWithoutErrorHandling(wa,Ma,xa,null,Fa)}catch(t){return null}return i}}else if(_r(t[e])){const r=(e+"_Fn_0").trim(),i=(e+"Fn").trim();oa(e)?(n[r]=m(t[e]),n[i]=(t,e)=>{const i=n[r](t,e);return _r(i)?m(i)(t,e):i}):(n[r]=g(t[e]),n[i]=(t,e)=>{const i=n[r](t,e);return _r(i)?g(i)(t,e):i})}return n}constructor(t,n,e){this.options=e;const r=[];this.symbolDef=n,this.symbol=v(n,(()=>(r[0]=e.zoom,r))),this.styledVectors=[],this.properties={},this.st=e.fnTypes||Pa.genFnTypes(this.symbolDef),_r(this.symbolDef.visible)&&(this.ot=m(this.symbolDef.visible)),e.atlas&&(this.iconAtlas=e.atlas.iconAtlas,this.glyphAtlas=e.atlas.glyphAtlas),this.features=this.ut(t)}needAltitudeAttribute(){return this.options.forceAltitudeAttribute||this.maxPosZ>=Aa||this.options.positionType===Float32Array}getPositionFormat(){return this.needAltitudeAttribute()?[{type:Int16Array,width:2,name:"aPosition"},{type:Float32Array,width:1,name:"aAltitude"}]:[{type:Float32Array,width:3,name:"aPosition"}]}fillPosition(t,n,e,r){if(n<this.lt&&(this.lt=n),n>this.ht&&(this.ht=n),e<this.ct&&(this.ct=e),e>this.ft&&(this.ft=e),this.needAltitudeAttribute()){let i=t.aPosition.currentIndex;t.aPosition[i++]=n,t.aPosition[i++]=e,t.aPosition.currentIndex=i,i=t.aAltitude.currentIndex,t.aAltitude[i++]=r,t.aAltitude.currentIndex=i}else{jr(ba,n,e,r);let i=t.aPosition.currentIndex;t.aPosition[i++]=ba[0],t.aPosition[i++]=ba[1],t.aPosition[i++]=ba[2],t.aPosition.currentIndex=i}}ut(t){if(!t.length)return t;const n=(va+"").trim();let e,r=0,i=t[r];for(;!i.geometry;)r++,i=t[r];if(Array.isArray(i.geometry)&&i.properties){let n=i.geometry[0];for(;Array.isArray(n);)n=n[0];n instanceof dt&&(e=t)}if(!e)if(e=[],Array.isArray(i.geometry))for(let n=0;n<t.length;n++){const r=br({},t[n]);e.push(vr(r))}else for(let r=0;r<t.length;r++){const i=t[r],s=qe(i);for(let t=0;t<s.length;t++){const r=s[t];r[n]=i[n],e.push(r)}}if(this.maxPosZ=0,!this.options.forceAltitudeAttribute){const t="line"===this.symbolDef.textPlacement;let n=0,r=!1;const{textPitchAlignmentFn:i}=this.st;!i&&t&&"map"===this.symbolDef.textPitchAlignment&&(r=!0);for(let s=0;s<e.length;s++){const o=_a(e[s]&&e[s].geometry);if(o>n&&(n=o),t&&!r&&i&&e[s].properties){const t=i(null,e[s].properties);"map"===t&&(r=t)}}this.hasMapPitchAlign=r,this.maxPosZ=n}const s=this.options.order;if(s){const t=[];for(let n=0;n<s.length;n++)s[n]&&t.push(na(s[n]));e=e.sort(((n,e)=>{const r=t.length;let i=-1,s=-1;for(let o=0;o<r&&(t[o](n)&&(i=o),t[o](e)&&(s=o),!(i>=0&&i<r&&s>=0&&s<r));o++);return i-s}))}return e}load(t=1){const n=(va+"").trim(),e="_debug_info".trim(),r=this.st,i=this.styledVectors;this.count=0;const s=this.features;if(!s||!s.length)return Promise.resolve(null);const o={},a={},u={zoom:this.options.zoom,isVector3D:!!this.options.center},l=[],h=v(this.symbolDef,(()=>(l[0]=u.zoom,l)));let c=0,f=s.length;const d=this.options.debugIndex;try{for(;c<f;c++){const t=s[c];if(!t||!t.geometry)continue;if(Mr(d)&&t[e].index!==d)continue;t.properties||(t.properties={}),t.properties.$layer=t.layer,t.properties.$type=t.type;const l=this.createStyledVector(t,h,r,u,o,a);l&&l.feature.geometry&&(l.featureIdx=void 0===t[n]?c:t[n],this.count++,i.push(l))}}catch(t){return Promise.reject(t)}return this.options.atlas?Promise.resolve(this.pack(t)):this.loadAtlas(o,a).then((()=>this.pack(t)))}loadAtlas(t,n){return new Promise(((e,r)=>{this.fetchAtlas(t,n,((t,n)=>{if(t)r(t);else{if(n){const{icons:t,glyphs:e}=n;if(t&&Object.keys(t).length){for(const n in t){const e=t[n],{width:r,height:i,data:s}=e.data;e.data=new tr({width:r,height:i},s)}this.iconAtlas=new cr(t)}if(e&&Object.keys(e).length){for(const t in e){const n=e[t];for(const t in n){const e=n[t],{width:r,height:i,data:s}=e.bitmap;e.bitmap=new Qe({width:r,height:i},s)}}this.glyphAtlas=new dr(e)}}e({glyphAtlas:this.glyphAtlas,iconAtlas:this.iconAtlas})}}))}))}fetchAtlas(t,n,e){Object.keys(t).length>0||Object.keys(n).length>0?this.options.requestor(t,n,e):e()}pack(t){if(!this.count)return null;if(null==t)throw new Error("layout scale is undefined");const n=this.createDataPack(this.styledVectors,t);if(!n)return null;n.properties=this.properties,this.empty&&(n.empty=!0);const e=n.buffers;delete n.buffers;const r={data:n,buffers:e};if(this.iconAtlas){const t=r.data.iconAtlas=Sa(this.iconAtlas);if(t.glyphMap)for(const n in t.glyphMap)e.push(t.glyphMap[n].data.data.buffer);e.push(r.data.iconAtlas.image.data.buffer)}return this.glyphAtlas&&(r.data.glyphAtlas=Sa(this.glyphAtlas),e.push(r.data.glyphAtlas.image.data.buffer)),r}createStyledVector(t,n,e,r){return new zr(t,n,e,r)}createDataPack(t,n){if(!t||!t.length)return null;this.maxIndex=0,this.maxPos=0,this.lt=this.ct=1/0,this.ht=this.ft=-1/0,this.maxAltitude=0,this.dynamicAttrs={};const e=this.data={};this.dt=ka,ka.reset();let r=this.elements=ka.get();const i=this.yt=this.getFormat(Array.isArray(t[0])?t[0][0].symbol:t[0].symbol),s=this.needAltitudeAttribute()?2:3;for(let t=0;t<i.length;t++)e[i[t].name]=ka.get(i[t].type);let o=ka.get(),a=0;const u=ka.get();let l=0,h=!1,c=!0;const f=new Set;for(let r=0,i=t.length;r<i;r++){if(!t[r].feature.geometry)continue;const i=Array.isArray(t[r])?t[r][0].feature.id:t[r].feature.id;c&&(void 0!==Ma.id?f&&(f.has(Ma.id)?c=!1:f.add(Ma.id)):c=!1),Mr(i)&&(Math.abs(i)>l&&(l=Math.abs(i)),i<0&&(h=!0));const d=this.data.aPosition.getLength();if(Array.isArray(t[r]))for(let e=0;e<t[r].length;e++)this.gt(t[r][e],n);else this.gt(t[r],n);const p=(e.aPosition.getLength()-d)/s;for(let n=0;n<p;n++)o.push(t[r].featureIdx),Mr(i)&&u.push(i);a=Math.max(a,t[r].featureIdx)}if(this.countOutOfAngle>0&&console.warn("text anchor along line is ignored as anchor's line angle is bigger than textMaxAngle."),this.hasElements()&&!r.getLength())return null;const d=this.options.center?Float32Array:mr(a);o=ga.createTypedArray(o,d),i[0].type=this.options.positionType?this.options.positionType:yr(this.maxPos);const p=this.options.center;if(p&&(p[0]||p[1])){const t=e.aPosition,n=t.getLength();for(let e=0;e<n;e+=s)t[e]-=p[0],t[e+1]-=p[1]}const y=function(t,n){const e={};for(let r=0;r<t.length;r++){const i=t[r],s=i.type,o=i.name;e[o]=s===Array?n[o]:gr(n[o],s)}return e}(i,e);y.aPickingId=o;const m=[];for(const t in y)m.push(y[t].buffer);const g=pr(this.maxIndex);r=ga.createTypedArray(r,g),m.push(r.buffer);const v={data:y,isIdUnique:c,is2D:0===this.maxPosZ,indices:this.hasElements()?r:null,positionSize:s,positionBounding:[this.lt,this.ct,this.ht,this.ft],buffers:m,symbolIndex:this.symbolDef.index||{index:0},dynamicAttributes:this.dynamicAttrs};if(this.vt&&(v.markerPlacement=this.vt),this.bt&&(v.textPlacement=this.bt),u.getLength()){const t=h?yr(l):mr(l);v.featureIds=ga.createTypedArray(u,t),m.push(v.featureIds.buffer)}else v.featureIds=[];return v.pickingIdIndiceMap=ur(o,v.indices),v}gt(t,n){this.ot&&!this.ot(this.options.zoom,t.feature.properties)||this.placeVector(t,n,this.formatWidth)}addElements(t,n,e){this.maxIndex=Math.max(this.maxIndex,t,n,e);let r=this.elements.currentIndex;this.elements[r++]=t,this.elements[r++]=n,this.elements[r++]=e,this.elements.currentIndex=r}hasElements(){return!0}getAltitude(t){const{altitudeProperty:n,defaultAltitude:e,altitudeScale:r}=this.options;let i=rr(t,n,e);return r&&(i*=r),this.maxAltitude=Math.max(this.maxAltitude,Math.abs(i)),i}getIconAtlasMaxValue(){const t=this.iconAtlas.positions;let n=0;for(const e in t)if(Pr(t,e)){const{tl:r,displaySize:i}=t[e],s=Math.max(r[0],r[1],i[0]-1,i[1]-1);s>n&&(n=s)}return n}ensureDataCapacity(t,n){const e=this.yt;for(let r=0;r<e.length;r++){const i=this.data[e[r].name];if(!i)continue;const s=e[r].width*t,o=i.getLength();this.data[e[r].name]=ga.ensureCapacity(i,o+s*n)}}}function Sa(t){let n=t.positions,e=t.image&&t.image.format||"alpha";if(t instanceof cr){n={};for(const e in t.positions){const r=t.positions[e];n[e]={paddedRect:r.paddedRect,pixelRatio:r.pixelRatio,tl:r.tl,br:r.br,displaySize:r.displaySize}}e="rgba"}const r=t.image;return{image:{width:r.width,height:r.height,data:r.data,format:e},glyphMap:t.glyphMap,positions:n}}function _a(t){if(!t)return 0;let n=0;if(Array.isArray(t))for(let e=0;e<t.length;e++)if(Array.isArray(t[e])){const r=_a(t[e]);r>n&&(n=r)}else{const r=Math.abs(t[e].z||0);r>n&&(n=r)}else{const e=Math.abs(t.z||0);e>n&&(n=e)}return n}const Oa="___fn_in_stops";function Ca(t,n,e,r){const i="__fn_textSize".trim();let s=t.textSize;if(wr(n.textSize))return[16,16];t[i]&&(s=t[i]);const o=[];if(o[0]=kr(s)?s(r,e):s,y(o[0])){const n=o[0].wt=o[0].wt||JSON.stringify(o[0]);t[Oa]||(t[Oa]={}),t[Oa][n]||(t[Oa][n]=m(o[0])),o[0]=(0,t[Oa][n])(r,e)}return o[1]=o[0],o}function Ea(t){const n=t.stops;let e=-1/0;for(let t=0;t<n.length;t++){let r=n[t][1];xr(n[t][1])&&(r=Ea(n[t][1])),r>e&&(e=r)}return e}function Ia(t){return t||"Open Sans Regular"}const $a=/\\{[\\w-]+(?:\\|[\\w-]+)*\\}/g;function Ta(t,n){return Fr(t)?t.replace($a,(function(t){if(!n)return"";if((t=t.substring(1,t.length-1)).indexOf("|")>0){const e=t.split("|");for(let t=0;t<e.length;t++){const r=n[e[t]];if(!wr(r))return r}return""}const e=n[t];return wr(e)?"":Array.isArray(e)?e.join():e})):t}var Da=Object.freeze({__proto__:null,getSDFFont:Ia,resolveExpVarNames:function t(n,e){if(2!==e.length||"get"!==e[0])for(let r=0;r<e.length;r++)2===e[r].length&&"get"===e[r][0]?n.push(e[r][1]):Array.isArray(e[r])&&t(n,e[r]);else n.push(e[1])},resolveText:Ta,resolveVarNames:function(t){return t.match($a)}});const za={"Latin-1 Supplement":t=>t>=128&&t<=255,Arabic:t=>t>=1536&&t<=1791,"Arabic Supplement":t=>t>=1872&&t<=1919,"Arabic Extended-A":t=>t>=2208&&t<=2303,"Hangul Jamo":t=>t>=4352&&t<=4607,"Unified Canadian Aboriginal Syllabics":t=>t>=5120&&t<=5759,Khmer:t=>t>=6016&&t<=6143,"Unified Canadian Aboriginal Syllabics Extended":t=>t>=6320&&t<=6399,"General Punctuation":t=>t>=8192&&t<=8303,"Letterlike Symbols":t=>t>=8448&&t<=8527,"Number Forms":t=>t>=8528&&t<=8591,"Miscellaneous Technical":t=>t>=8960&&t<=9215,"Control Pictures":t=>t>=9216&&t<=9279,"Optical Character Recognition":t=>t>=9280&&t<=9311,"Enclosed Alphanumerics":t=>t>=9312&&t<=9471,"Geometric Shapes":t=>t>=9632&&t<=9727,"Miscellaneous Symbols":t=>t>=9728&&t<=9983,"Miscellaneous Symbols and Arrows":t=>t>=11008&&t<=11263,"CJK Radicals Supplement":t=>t>=11904&&t<=12031,"Kangxi Radicals":t=>t>=12032&&t<=12255,"Ideographic Description Characters":t=>t>=12272&&t<=12287,"CJK Symbols and Punctuation":t=>t>=12288&&t<=12351,Hiragana:t=>t>=12352&&t<=12447,Katakana:t=>t>=12448&&t<=12543,Bopomofo:t=>t>=12544&&t<=12591,"Hangul Compatibility Jamo":t=>t>=12592&&t<=12687,Kanbun:t=>t>=12688&&t<=12703,"Bopomofo Extended":t=>t>=12704&&t<=12735,"CJK Strokes":t=>t>=12736&&t<=12783,"Katakana Phonetic Extensions":t=>t>=12784&&t<=12799,"Enclosed CJK Letters and Months":t=>t>=12800&&t<=13055,"CJK Compatibility":t=>t>=13056&&t<=13311,"CJK Unified Ideographs Extension A":t=>t>=13312&&t<=19903,"Yijing Hexagram Symbols":t=>t>=19904&&t<=19967,"CJK Unified Ideographs":t=>t>=19968&&t<=40959,"Yi Syllables":t=>t>=40960&&t<=42127,"Yi Radicals":t=>t>=42128&&t<=42191,"Hangul Jamo Extended-A":t=>t>=43360&&t<=43391,"Hangul Syllables":t=>t>=44032&&t<=55215,"Hangul Jamo Extended-B":t=>t>=55216&&t<=55295,"Private Use Area":t=>t>=57344&&t<=63743,"CJK Compatibility Ideographs":t=>t>=63744&&t<=64255,"Arabic Presentation Forms-A":t=>t>=64336&&t<=65023,"Vertical Forms":t=>t>=65040&&t<=65055,"CJK Compatibility Forms":t=>t>=65072&&t<=65103,"Small Form Variants":t=>t>=65104&&t<=65135,"Arabic Presentation Forms-B":t=>t>=65136&&t<=65279,"Halfwidth and Fullwidth Forms":t=>t>=65280&&t<=65519};function ja(t){return!(za.Arabic(t)||za["Arabic Supplement"](t)||za["Arabic Extended-A"](t)||za["Arabic Presentation Forms-A"](t)||za["Arabic Presentation Forms-B"](t))}function Ua(t){return!!(!(t<11904)&&(za["Bopomofo Extended"](t)||za.Bopomofo(t)||za["CJK Compatibility Forms"](t)||za["CJK Compatibility Ideographs"](t)||za["CJK Compatibility"](t)||za["CJK Radicals Supplement"](t)||za["CJK Strokes"](t)||za["CJK Symbols and Punctuation"](t)||za["CJK Unified Ideographs Extension A"](t)||za["CJK Unified Ideographs"](t)||za["Enclosed CJK Letters and Months"](t)||za["Halfwidth and Fullwidth Forms"](t)||za.Hiragana(t)||za["Ideographic Description Characters"](t)||za["Kangxi Radicals"](t)||za["Katakana Phonetic Extensions"](t)||za.Katakana(t)||za["Vertical Forms"](t)||za["Yi Radicals"](t)||za["Yi Syllables"](t)))}function Na(t){return!!(746===t||747===t||!(t<4352)&&(za["Bopomofo Extended"](t)||za.Bopomofo(t)||za["CJK Compatibility Forms"](t)&&!(t>=65097&&t<=65103)||za["CJK Compatibility Ideographs"](t)||za["CJK Compatibility"](t)||za["CJK Radicals Supplement"](t)||za["CJK Strokes"](t)||!(!za["CJK Symbols and Punctuation"](t)||t>=12296&&t<=12305||t>=12308&&t<=12319||12336===t)||za["CJK Unified Ideographs Extension A"](t)||za["CJK Unified Ideographs"](t)||za["Enclosed CJK Letters and Months"](t)||za["Hangul Compatibility Jamo"](t)||za["Hangul Jamo Extended-A"](t)||za["Hangul Jamo Extended-B"](t)||za["Hangul Jamo"](t)||za["Hangul Syllables"](t)||za.Hiragana(t)||za["Ideographic Description Characters"](t)||za.Kanbun(t)||za["Kangxi Radicals"](t)||za["Katakana Phonetic Extensions"](t)||za.Katakana(t)&&12540!==t||!(!za["Halfwidth and Fullwidth Forms"](t)||65288===t||65289===t||65293===t||t>=65306&&t<=65310||65339===t||65341===t||65343===t||t>=65371&&t<=65503||65507===t||t>=65512&&t<=65519)||!(!za["Small Form Variants"](t)||t>=65112&&t<=65118||t>=65123&&t<=65126)||za["Unified Canadian Aboriginal Syllabics"](t)||za["Unified Canadian Aboriginal Syllabics Extended"](t)||za["Vertical Forms"](t)||za["Yijing Hexagram Symbols"](t)||za["Yi Syllables"](t)||za["Yi Radicals"](t)))}function La(t){return!(Na(t)||function(t){return!!(za["Latin-1 Supplement"](t)&&(167===t||169===t||174===t||177===t||188===t||189===t||190===t||215===t||247===t)||za["General Punctuation"](t)&&(8214===t||8224===t||8225===t||8240===t||8241===t||8251===t||8252===t||8258===t||8263===t||8264===t||8265===t||8273===t)||za["Letterlike Symbols"](t)||za["Number Forms"](t)||za["Miscellaneous Technical"](t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||9003===t||t>=9085&&t<=9114||t>=9150&&t<=9165||9167===t||t>=9169&&t<=9179||t>=9186&&t<=9215)||za["Control Pictures"](t)&&9251!==t||za["Optical Character Recognition"](t)||za["Enclosed Alphanumerics"](t)||za["Geometric Shapes"](t)||za["Miscellaneous Symbols"](t)&&!(t>=9754&&t<=9759)||za["Miscellaneous Symbols and Arrows"](t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||za["CJK Symbols and Punctuation"](t)||za.Katakana(t)||za["Private Use Area"](t)||za["CJK Compatibility Forms"](t)||za["Small Form Variants"](t)||za["Halfwidth and Fullwidth Forms"](t)||8734===t||8756===t||8757===t||t>=9984&&t<=10087||t>=10102&&t<=10131||65532===t||65533===t)}(t))}function Ra(t){return t>=1424&&t<=2303||za["Arabic Presentation Forms-A"](t)||za["Arabic Presentation Forms-B"](t)}const Va=[[9,9],[32,32],[5760,5760],[8192,8198],[8200,8202],[8287,12288],[6158,6158],[8203,8205]];function Ha(t){for(const n of Va)if(t>=n[0]&&t<=n[1])return!0;return!1}const qa={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\\\":"＼","]":"﹈","^":"＾",Mt:"︳","\`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂"},Ga=1,Ja=2;function Wa(t,n,e,r,i,s,o,a,u,l){let h=t.trim();l===Ja&&(h=function(t){let n="";const e=Array.from(t);for(let t=0;t<e.length;t++){const r=e[t+1].codePointAt(0)||null,i=e[t-1].codePointAt(0)||null;n+=r&&La(r)&&!qa[e[t+1]]||i&&La(i)&&!qa[e[t-1]]||!qa[e[t]]?e[t]:qa[e[t]]}return n}(h));const c=[],f={positionedGlyphs:c,text:h,top:a[1],bottom:a[1],left:a[0],right:a[0],writingMode:l};let d;return d=function(t,n){const e=[];let r=0;for(let i=0;i<n.length;i++){const s=n[i];e.push(t.substring(r,s)),r=s}return r<t.length&&e.push(t.substring(r,t.length)),e}(h,function(t,n,e,r){if(!e)return[];if(!t)return[];const i=[],s=function(t,n,e,r){let i=0;for(let e=0;e<t.length;e++){const s=r[t.codePointAt(e)];s&&(i+=s.metrics.advance+n)}return i/Math.max(1,Math.ceil(i/e))}(t,n,e,r);let o=0;for(let e=0;e<t.length;e++){const a=t.codePointAt(e),u=r[a];u&&(u&&!Ba[a]&&(o+=u.metrics.advance+n),e<t.length-1&&(Xa[a]||Ua(a))&&i.push(Za(e+1,o,s,i,Ka(a,t.codePointAt(e+1)),!1)))}return Qa(Za(t.length,o,s,i,0,!0))}(h,o,e,n)),function(t,n,e,r,i,s,o,a,u,l){let h=0,c=0,f=0;const d=t.positionedGlyphs;for(let t=0;t<e.length;t++){let i=e[t];if(i=i.trim(),!i.length){c-=r;continue}const s=d.length;for(let t=0;t<i.length;t++){const e=i.codePointAt(t),r=n[e];r&&(Na(e)&&o!==Ga?(32!==e&&d.push({glyph:e,x:h,y:0,vertical:!0}),h+=u+a):(32!==e&&d.push({glyph:e,x:h,y:c,vertical:!1}),h+=r.metrics.advance+a))}d.length!==s&&(f=Math.max(h-a,f),nu(d,n,s,d.length-1,.5)),h=0,c-=r}const{horizontalAlign:p,verticalAlign:y}=tu(i,void 0);!function(t,n,e,r,i,s,o){const a=(.5-e)*i,u=-(-r*o+.5)*s;if(a||u)for(let n=0;n<t.length;n++)t[n].x+=a,t[n].y+=u}(d,0,p,y,f,r,e.length);const m=e.length*r;t.top+=-y*m,t.bottom=t.top+m,t.left+=-p*f,t.right=t.left+f}(f,n,d,r,i,0,l,o,u),!!c.length&&f}const Ba={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Xa={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Ya(t,n,e,r){const i=Math.pow(t-n,2);return r?t<n?i/2:2*i:i+Math.abs(e)*e}function Ka(t,n){let e=0;return 10===t&&(e-=1e4),40!==t&&65288!==t||(e+=50),41!==n&&65289!==n||(e+=50),e}function Za(t,n,e,r,i,s){let o=null,a=Ya(n,e,i,s);for(let t=0;t<r.length;t++){const u=r[t],l=Ya(n-u.x,e,i,s)+u.badness;l<=a&&(o=u,a=l)}return{index:t,x:n,priorBreak:o,badness:a}}function Qa(t){return t?Qa(t.priorBreak).concat(t.index):[]}function tu(t,n){let e=.5,r=.5;switch(t){case"right":case"top-right":case"bottom-right":e=n?1:0;break;case"left":case"top-left":case"bottom-left":e=n?0:1}switch(t){case"bottom":case"bottom-right":case"bottom-left":r=n?1:0;break;case"top":case"top-right":case"top-left":r=n?0:1}return{horizontalAlign:e,verticalAlign:r}}function nu(t,n,e,r,i){const s=n[t[r].glyph];if(s){const n=(t[r].x+s.metrics.advance)*i;if(!n)return;for(let i=e;i<=r;i++)t[i].x-=n}}function eu(t){if(!function(t){for(const n of t)if(Ra(n.charCodeAt(0)))return!0;return!1}(t))return t;const n=[],e=[],r=[];let i=0,s=0,o=1,a=1;for(const u of t){const t=u.codePointAt(0);Ha(t)?(r.push(u),i++):(o=Ra(t)?-1:1,a!==o?(s=i,e.length&&(a>0&&e.reverse(),n.push(...e)),r.length&&(n.splice(s,0,...r),r.length=0),a=o,e.length=0):r.length&&(e.push(...r),r.length=0),e.push(u),i++)}return r.length&&e.push(...r),e.length&&(a>0&&e.reverse(),n.push(...e)),n.reverse().join("")}const ru=/\\{ *([\\w_]+) *\\}/g;class iu{constructor(t,n,e,r,i){this.feature=t,this.symbolDef=n,this.symbol=e,this.options=i,this.xt=this.Ft.bind(this),this.st=r}Ft(t,n){return this.feature.properties[n]||""}getShape(t,n){if(this.kt)return this.kt;const{textHorizontalAlignmentFn:e,textVerticalAlignmentFn:r,markerHorizontalAlignmentFn:i,markerVerticalAlignmentFn:s,textWrapWidthFn:o}=this.st;let a;const u=this.symbol,l=this.getIconAndGlyph(),h=this.feature.properties;if(l&&l.glyph){const{font:t,text:i}=l.glyph;if(""===i)return null;const s=this.size[0]/24,c=24,f=u.textKeepUpright,d="map"===u.textRotationAlignment&&"line"===u.textPlacement&&!u.isIconText,p=n.glyphMap[t],y=su(e?e(null,h):u.textHorizontalAlignment,r?r(null,h):u.textVerticalAlignment),m=1.2*c,g=function(t){for(let n=0;n<t.length;n++)if(!ja(t.charAt(n).charCodeAt(0)))return!1;return!0}(i),v=g&&u.textLetterSpacing/s||0,b=[u.textDx/s||0,u.textDy/s||0],w=((o?o(null,h):u.textWrapWidth)||10*c)/s;a={},a.horizontal=Wa(i,p,w,m,y,0,v,b,c,Ga),g&&d&&f&&(a.vertical=Wa(i,p,w,m,y,0,v,b,c,Ja))}else if(l&&l.icon){if(!t||!t.positions[l.icon.url])return null;const n=su(i?i(null,h):u.markerHorizontalAlignment,s?s(null,h):u.markerVerticalAlignment);a=function(t,n,e){let{horizontalAlign:r,verticalAlign:i}=tu(n,e);e?r=1-r:i=1-i;const s=-2048*r,o=-2048*i;return{image:t,top:o,bottom:o+2048,left:s,right:s+2048}}(t.positions[l.icon.url],n,this.options.isVector3D),this.size||(this.size=a.image.displaySize)}return this.kt=a,a}getIconAndGlyph(){if(this.iconGlyph)return this.iconGlyph;const{markerFileFn:t,markerTypeFn:n,markerPathFn:e,markerWidthFn:r,markerHeightFn:i,markerFillFn:s,markerFillPatternFileFn:o,markerFillOpacityFn:a,markerTextFitFn:u,markerTextFitPaddingFn:l,markerLineColorFn:h,markerLineWidthFn:c,markerLineOpacityFn:f,markerLineDasharrayFn:d,markerLinePatternFileFn:p,markerPathWidthFn:g,markerPathHeightFn:v,textNameFn:b,textFaceNameFn:w}=this.st,{zoom:M}=this.options,x={},F=this.symbol,k=this.feature.properties,A=t?t(null,k):F.markerFile,P=n?n(null,k):F.markerType,S=A||P||F.markerPath,_=!wr(this.symbolDef.textName);let O;if(S){O=function(t,n,e,r,i,s){if(wr(n.markerWidth)&&wr(n.markerHeight))return null;const o="__fn_markerWidth".trim(),a="__fn_markerHeight".trim();let u=n.markerWidth||0,l=n.markerHeight||0;return xr(u)&&("identity"!==u.type?u=Ea(u):(u=t.markerWidth,t[o]&&(u=t[o](r,e)),xr(u)&&(u="identity"===u.type?i(r,e):Ea(u)))),xr(l)&&("identity"!==l.type?l=Ea(l):(l=t.markerHeight,t[a]&&(l=t[a](r,e)),xr(l)&&(l="identity"===l.type?s(r,e):Ea(l)))),[u,l]}(F,this.symbolDef,k,M,r,i)||[0,0];let t=F.markerTextFit;if(u&&(t=u(M,k)),t&&F.text&&"none"!==t){const n=F.text.textSize;let e=F.text.textName;y(e)&&(e=m(e)(M,k));const r=Ta(e,k);if(r){const e="__fn_textSize".trim(),i="__fn_textSize_0".trim();y(n)&&!F.text[e]&&(F.text[i]=m(n),F.text[e]=(t,n)=>{const e=F.text[i](t,n);return y(e)?m(e)(t,n):e});const s=Ca(F.text,F.text,k,M);if("width"!==t&&"both"!==t||(O[0]=s[0]*r.length),"height"!==t&&"both"!==t||(O[1]=s[1]),s[0]&&s[1]){let t=F.markerTextFitPadding||[0,0,0,0];l&&(t=l(M,k)),O[0]+=t[1]+t[3],O[1]+=t[0]+t[2]}}else O[0]=O[1]=-1}}if(_&&(O=Ca(F,this.symbolDef,k,M)),!O)return x;if(O[0]=Math.ceil(O[0]),O[1]=Math.ceil(O[1]),this.size=O,S&&O[0]>=0&&O[1]>=0){let t;if(P){const n={};if(n.markerType=P,"path"===P&&(n.markerPath=e?e(null,k):F.markerPath,n.markerPathWidth=g?g(null,k):F.markerPathWidth,n.markerPathHeight=v?v(null,k):F.markerPathHeight),r){const t=r(null,k);wr(t)||(n.markerWidth=t)}else F.markerWidth>=0&&(n.markerWidth=F.markerWidth);if(i){const t=i(null,k);wr(t)||(n.markerHeight=t)}else F.markerHeight>=0&&(n.markerHeight=F.markerHeight);if(s){const t=s(null,k);wr(t)||(n.markerFill=t)}else F.markerFill&&(n.markerFill=F.markerFill);if(o){const t=o(null,k);wr(t)||(n.markerFillPatternFile=t)}else F.markerFillPatternFile&&(n.markerFillPatternFile=F.markerFillPatternFile);if(a){const t=a(null,k);wr(t)||(n.markerFillOpacity=t)}else F.markerFillOpacity>=0&&(n.markerFillOpacity=F.markerFillOpacity);if(h){const t=h(null,k);wr(t)||(n.markerLineColor=t)}else F.markerLineColor&&(n.markerLineColor=F.markerLineColor);if(c){const t=c(null,k);wr(t)||(n.markerLineWidth=t)}else F.markerLineWidth>=0&&(n.markerLineWidth=F.markerLineWidth);if(f){const t=f(null,k);wr(t)||(n.markerLineOpacity=t)}else F.markerLineOpacity>=0&&(n.markerLineOpacity=F.markerLineOpacity);if(d){const t=d(null,k);wr(t)||(n.markerLineDasharray=t)}else F.markerLineDasharray&&(n.markerLineDasharray=F.markerLineDasharray);if(p){const t=p(null,k);wr(t)||(n.markerLinePatternFile=t)}else F.markerLinePatternFile&&(n.markerLinePatternFile=F.markerLinePatternFile);t="vector://"+JSON.stringify(n)}else t=A?A.replace(ru,this.xt):F.markerPath?function(t,n,e){if(!t.markerPath)return null;let r=1;const i=function(t){const n={stroke:{stroke:t.markerLineColor,"stroke-width":t.markerLineWidth,"stroke-opacity":t.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:t.markerFill,"fill-opacity":t.markerFillOpacity}};return 0===n.stroke["stroke-width"]&&(n.stroke["stroke-opacity"]=0),n}(t);Mr(t.markerOpacity)&&(r=t.markerOpacity),Mr(t.opacity)&&(r*=t.opacity);const s={};if(i){for(const t in i.stroke)Pr(i.stroke,t)&&(wr(i.stroke[t])||(s[t]=i.stroke[t]));for(const t in i.fill)Pr(i.fill,t)&&(wr(i.fill[t])||(s[t]=i.fill[t]))}const o=Array.isArray(t.markerPath)?t.markerPath:[t.markerPath];let a;const u=[];for(let t=0;t<o.length;t++)a=Fr(o[t])?{path:o[t]}:o[t],a=br({},a,s),a.d=a.path,delete a.path,u.push(a);const l=['<svg version="1.1"','xmlns="http://www.w3.org/2000/svg"'];r<1&&l.push('opacity="'+r+'"'),t.markerPathWidth&&t.markerPathHeight&&l.push('viewBox="0 0 '+t.markerPathWidth+" "+t.markerPathHeight+'"'),l.push('preserveAspectRatio="none"'),n&&l.push('width="'+n+'"'),e&&l.push('height="'+e+'"'),l.push("><defs></defs>");for(let t=0;t<u.length;t++){let n="<path ";for(const e in u[t])Pr(u[t],e)&&(n+=" "+e+'="'+u[t][e]+'"');n+="></path>",l.push(n)}return l.push("</svg>"),"data:image/svg+xml;base64,"+btoa(l.join(" "))}(F,O[0],O[1]):null;x.icon={url:t,size:O}}if(_){const t=b?b(this.options.zoom,k):F.textName;if(t||0===t){const n=Ia(w?w(null,k):F.textFaceName);let e=Ta(t,k);e&&e.length&&(e=eu(e),x.glyph={font:n,text:e})}}return this.iconGlyph=x,x}}function su(t,n){n&&"middle"!==n||(n="center"),t&&"middle"!==t||(t="center");let e="center"!==n?n:"";return e+="center"!==t?(e.length?"-":"")+t:"",e
/*!
     * From mapbox-gl-js
     * MIT License
     * https://github.com/mapbox/mapbox-gl-js
     */}function ou(t,n,e,r,i){const s=[];let o;for(let a=0;a<t.length;a++){const u=t[a];let l,h=!1;for(let t=0;t<u.length-1;t++){let a=u[t],c=u[t+1];a.x<n&&c.x<n||(a.x<n?(o=a,a=new dt(n,a.y+(n-a.x)/(c.x-a.x)*(c.y-a.y)).j(),a.z=o.z+(n-o.x)/(c.x-o.x)*(c.z-o.z),h=!0):c.x<n&&(o=c,c=new dt(n,a.y+(n-a.x)/(c.x-a.x)*(c.y-a.y)).j(),c.z=a.z+(n-a.x)/(o.x-a.x)*(o.z-a.z),h=!0),a.y<e&&c.y<e||(a.y<e?(o=a,a=new dt(a.x+(e-a.y)/(c.y-a.y)*(c.x-a.x),e).j(),a.z=o.z+(e-o.y)/(c.y-o.y)*(c.z-o.z),h=!0):c.y<e&&(o=c,c=new dt(a.x+(e-a.y)/(c.y-a.y)*(c.x-a.x),e).j(),c.z=a.z+(e-a.y)/(o.y-a.y)*(o.z-a.z),h=!0),a.x>=r&&c.x>=r||(a.x>=r?(o=a,a=new dt(r,a.y+(r-a.x)/(c.x-a.x)*(c.y-a.y)).j(),a.z=o.z+(r-o.x)/(c.x-o.x)*(c.z-o.z),h=!0):c.x>=r&&(o=c,c=new dt(r,a.y+(r-a.x)/(c.x-a.x)*(c.y-a.y)).j(),c.z=a.z+(r-a.x)/(o.x-a.x)*(o.z-a.z),h=!0),a.y>=i&&c.y>=i||(a.y>=i?(o=a,a=new dt(a.x+(i-a.y)/(c.y-a.y)*(c.x-a.x),i).j(),a.z=o.z+(i-o.y)/(c.y-o.y)*(c.z-o.z),h=!0):c.y>=i&&(o=c,c=new dt(a.x+(i-a.y)/(c.y-a.y)*(c.x-a.x),i).j(),c.z=a.z+(i-a.y)/(o.y-a.y)*(o.z-a.z),h=!0),l&&a.equals(l[l.length-1])||(l=[a],s.push(l)),h&&(l.clipped=!0),l.push(c)))))}}return s}class au extends dt{constructor(t,n,e,r){super(t,n),this.angle=e,void 0!==r&&(this.segment=r)}clone(){return new au(this.x,this.y,this.angle,this.segment)}}
/*!
     * From mapbox-gl-js
     * MIT License
     * https://github.com/mapbox/mapbox-gl-js
     */function uu(t,n,e,r,i){if(void 0===n.segment)return!0;let s=n,o=n.segment+1,a=0;for(;a>-e/2;){if(o--,o<0)return!1;a-=t[o].dist(s),s=t[o]}a+=t[o].dist(t[o+1]),o++;const u=[];let l=0;for(;a<e/2;){const n=t[o],e=t[o+1];if(!e)return!1;let s=t[o-1].angleTo(n)-n.angleTo(e);for(s=Math.abs((s+3*Math.PI)%(2*Math.PI)-Math.PI),u.push({distance:a,angleDelta:s}),l+=s;a-u[0].distance>r;)l-=u.shift().angleDelta;if(l>i)return!1;o++,a+=n.dist(e)}return!0}function lu(t,n,e,r,i,s,o,a,u,l,h){const c=function(t,n,e){return t?.6*n*e:0}(r,s,o),f=function(t,n){return Math.max(t?t.right-t.left:0,0)}(r),d=0===t[0].x||t[0].x===u||0===t[0].y||t[0].y===u;return n-f*o<n/4&&(n=f*o+n/4),hu(t,d?n/2*a%n:(f/2+2*s)*o*a%n,n,c,e,f*o,d,!1,u,l,h)}function hu(t,n,e,r,i,s,o,a,u,l,h){let c=0;const f=s/2,d=function(t){let n=0;for(let e=0;e<t.length-1;e++)n+=t[e].dist(t[e+1]);return n}(t);let p=0,y=n-e,m=[];for(let n=0;n<t.length-1;n++){const o=t[n],a=t[n+1],g=o.dist(a),v=a.angleTo(o);for(;y+e<p+g;){y+=e;const b=(y-p)/g,w=cu(o.x,a.x,b),M=cu(o.y,a.y,b),x=cu(o.z||0,a.z||0,b);if(w>=0&&w<u&&M>=0&&M<u&&y-f>=0&&y+f<=d){const e=new au(w,M,v,n);e.z=x,l&&(e.axis=[o.y-M,w-o.x],e.angleR=x===(o.z||0)?0:Math.atan(.9*(x-(o.z||0))*h/o.dist(e))),e.line=t,e.j(),!r||uu(t,e,s,r,i)?m.push(e):r&&c++}}p+=g}return a||m.length||o||(m=hu(t,p/2,e,r,i,s,o,!0,u,l,h)),m.countOutOfAngle=c,m}function cu(t,n,e){return t*(1-e)+n*e}function fu(t,n){const e=t.length;if(e<=1)return[t];const r=[];let i,s;for(let n=0;n<e;n++){const e=nr(t[n]);0!==e&&(t[n].area=Math.abs(e),void 0===s&&(s=e<0),s===e<0?(i&&r.push(i),i=[t[n]]):i.push(t[n]))}if(i&&r.push(i),n>1)for(let t=0;t<r.length;t++)r[t].length<=n||(Mn(r[t],n,1,r[t].length-1,du),r[t]=r[t].slice(0,n));return r}function du(t,n){return n.area-t.area}function pu(t,n,e){const r=n.distSqr(e);if(0===r)return t.distSqr(n);const i=((t.x-n.x)*(e.x-n.x)+(t.y-n.y)*(e.y-n.y))/r;return t.distSqr(i<0?n:i>1?e:e.sub(n).S(i).F(n))}function yu(t,n=1,e=!1){let r=1/0,i=1/0,s=-1/0,o=-1/0;const a=t[0];for(let t=0;t<a.length;t++){const n=a[t];(!t||n.x<r)&&(r=n.x),(!t||n.y<i)&&(i=n.y),(!t||n.x>s)&&(s=n.x),(!t||n.y>o)&&(o=n.y)}const u=Math.min(s-r,o-i);let l=u/2;const h=new xn([],mu);if(0===u)return new dt(r,i);for(let n=r;n<s;n+=u)for(let e=i;e<o;e+=u)h.push(new gu(n+l,e+l,l,t));let c=function(t){let n=0,e=0,r=0;const i=t[0];for(let t=0,s=i.length,o=s-1;t<s;o=t++){const s=i[t],a=i[o],u=s.x*a.y-a.x*s.y;e+=(s.x+a.x)*u,r+=(s.y+a.y)*u,n+=3*u}return new gu(e/n,r/n,0,t)}(t),f=h.length;for(;h.length;){const r=h.pop();(r.d>c.d||!c.d)&&(c=r,e&&console.log("found best %d after %d probes",Math.round(1e4*r.d)/1e4,f)),r.max-c.d<=n||(l=r.h/2,h.push(new gu(r.p.x-l,r.p.y-l,l,t)),h.push(new gu(r.p.x+l,r.p.y-l,l,t)),h.push(new gu(r.p.x-l,r.p.y+l,l,t)),h.push(new gu(r.p.x+l,r.p.y+l,l,t)),f+=4)}return e&&(console.log(\`num probes: ${Tt}f}\`),console.log(\`best distance: ${Tt}c.d}\`)),c.p}function mu(t,n){return n.max-t.max}function gu(t,n,e,r){this.p=new dt(t,n),this.h=e,this.d=function(t,n){let e=!1,r=1/0;for(let i=0;i<n.length;i++){const s=n[i];for(let n=0,i=s.length,o=i-1;n<i;o=n++){const i=s[n],a=s[o];i.y>t.y!=a.y>t.y&&t.x<(a.x-i.x)*(t.y-i.y)/(a.y-i.y)+i.x&&(e=!e),r=Math.min(r,pu(t,i,a))}}return(e?1:-1)*Math.sqrt(r)}(this.p,r),this.max=this.d+this.h*Math.SQRT2}function vu(t,n,e,r,i,s,o,a,u,l){const{feature:h,size:c,symbol:f}=t,d=c?24:0,p=i*(c?c[0]/d:1);if("line"===o){const t=[];t.countOutOfAngle=0;let i=h.geometry;s&&(i=ou(h.geometry,0,0,s,s));for(let o=0;o<i.length;o++){const h=lu(i[o],a,e,f.isIconText?null:r&&r.vertical||r&&r.horizontal||r,0,d,f.isIconText?1:p,1,s||1/0,u,l);if(f.textPlacement&&!f.isIconText)for(let t=0;t<h.length;t++)h[t].startIndex=n.length/3;if(t.push.apply(t,h),f.textPlacement&&!f.isIconText)for(let t=0;t<i[o].length;t++)n.push(i[o][t].x,i[o][t].y,i[o][t].z||0);t.countOutOfAngle+=h.countOutOfAngle||0}return t}return bu(h,o,s)}function bu(t,n,e,r,i){const s=[];if(3===t.type){const o=fu(t.geometry,0);for(let t=0;t<o.length;t++){const a=o[t];if("vertex"===n)for(let t=0;t<a.length;t++){const n=a[t];for(let o=0;o<n.length;o++)sr(n[o],e)||(s.push(n[o]),r&&(0===o?wu(n[o],n[o],n[t+1],i):wu(n[o],n[o-1],n[o],i)))}else if("vertex-first"===n){const t=a[0];t&&t[0]&&!sr(t[0],e)&&(s.push(t[0]),r&&wu(t[0],t[0],t[1],i))}else if("vertex-last"===n||"vertex-firstlast"===n){const t=a[0];if("vertex-firstlast"===n&&t&&t[0]&&!sr(t[0],e)&&(s.push(t[0]),r&&wu(t[0],t[0],t[1],i)),t&&t[t.length-1]&&!sr(t[t.length-1],e)){const n=t.length-1;s.push(t[n]),r&&wu(t[n],t[n-1],t[n],i)}}else{const t=yu(a,16);sr(t,e)||s.push(t)}}}else if(2===t.type)for(let o=0;o<t.geometry.length;o++){const a=t.geometry[o];if("vertex"===n)for(let t=0;t<a.length;t++)sr(a[t],e)||(s.push(a[t]),r&&(0===t?wu(a[t],a[t],a[t+1],i):wu(a[t],a[t-1],a[t],i)));else if("vertex-last"===n||"vertex-firstlast"===n){if("vertex-firstlast"!==n||sr(a[0],e)||(s.push(a[0]),r&&wu(a[0],a[0],a[1],i)),a&&a[a.length-1]&&!sr(a[a.length-1],e)){const t=a.length-1;s.push(a[t]),r&&wu(a[t],a[t-1],a[t],i)}}else sr(a[0],e)||(s.push(a[0]),r&&wu(a[0],a[0],a[1],i))}else if(1===t.type)for(let n=0;n<t.geometry.length;n++){const i=t.geometry[n];for(let t=0;t<i.length;t++){const n=i[t];sr(n,e)||(r&&(n.xRotation=0,n.yRotation=0,n.zRotation=0),s.push(n))}}return s}function wu(t,n,e,r){if(t.xRotation||t.yRotation||t.zRotation)return t;const i=e.x-n.x,s=n.y-e.y,o=(e.z-n.z)*r,a=Math.atan2(s,i);t.zRotation=a;const u=Math.atan2(o,Math.sqrt(i*i+s*s));return t.xyRotation=u,t}function Mu(t,n){const e={},r={},i=[];let s=0;function o(n){i.push(t[n]),s++}function a(t,n,e){const s=r[t];return delete r[t],r[n]=s,i[s].geometry[0].pop(),i[s].geometry[0]=i[s].geometry[0].concat(e[0]),s}function u(t,n,r){const s=e[n];return delete e[n],e[t]=s,i[s].geometry[0].shift(),i[s].geometry[0]=r[0].concat(i[s].geometry[0]),s}function l(t,n,e){const r=e?n[0][n[0].length-1]:n[0][0];return\`${Tt}t}:${Tt}r.x}:${Tt}r.y}\`}for(let h=0;h<t.length;h++){const c=t[h],f=c.geometry;if(!f)continue;const d=c.properties[n]?c.properties[n].toString():null;if(!d){o(h);continue}const p=l(d,f),y=l(d,f,!0);if(p in r&&y in e&&r[p]!==e[y]){const t=u(p,y,f),n=a(p,y,i[t].geometry);delete e[p],delete r[y],r[l(d,i[n].geometry,!0)]=n,i[t].geometry=null}else p in r?a(p,y,f):y in e?u(p,y,f):(o(h),e[p]=s-1,r[y]=s-1)}return i.filter((t=>t.geometry))}const xu="__index";function Fu(t,n,e,r){const i=(xu+"").trim(),s=function(t,n,e,r){const i=(xu+"").trim(),{mergeOnPropertyFn:s}=e;if(!n.mergeOnProperty)return[];if(!or(o=n.mergeOnProperty)&&("string"==typeof o||null!==o.constructor&&o.constructor===String))return[{features:t,property:n.mergeOnProperty}];var o;const a=[],u={},l=[];for(let e=0;e<t.length;e++){t[e][i]=e;const o=t[e].properties=t[e].properties||{};o.$layer=t[e].layer,o.$type=t[e].type;const h=s?s(r,o):n.mergeOnProperty;or(h)?l.push(t[e]):(void 0===u[h]&&(u[h]=a.length,a.push({features:[],property:h})),a[u[h]].features.push(t[e]))}return l.length&&a.push({features:l}),a}(t,n,e,r);if(s.length){const n=[];for(let e=0;e<s.length;e++)n.push(s[e].property?Mu(s[e].features,s[e].property):t);if(1===n.length)return n[0];{let t=[];for(let e=0;e<n.length;e++)t=t.concat(n[e]);return t.sort(((t,n)=>t[i]-n[i])),t}}return[]}class ku extends Pa{static needMerge(t,n,e){if(!t)return!1;let r="line"===t.textPlacement||"line"===t.markerPlacement;return r||(n.textPlacementFn&&(r="line"===n.textPlacementFn(e)),n.markerPlacementFn&&(r="line"===n.markerPlacementFn(e))),t.mergeOnProperty&&r}static mergeLineFeatures(t,n,e,r){let i=n.textPlacement,s=n.markerPlacement;return e.textPlacementFn&&(i=e.textPlacementFn(r)),e.markerPlacementFn&&(s=e.markerPlacementFn(r)),"line"!==i&&"line"!==s?t:Fu(t,n,e,r)}static splitPointSymbol(t,n=0){const e=[];if(Array.isArray(t)){const n=t;for(let t=0;t<n.length;t++)n[t]&&e.push(...ku.splitPointSymbol(n[t],t));return e}let r=null,i=null;for(const n in t)0===n.indexOf("marker")?(r=r||{},r[n]=t[n]):0===n.indexOf("text")&&(i=i||{},i[n]=t[n]);return r&&(r.isIconText=!0,t.mergeOnProperty&&(r.mergeOnProperty=t.mergeOnProperty),e.push(r)),i&&(r&&(i.textPlacement=r.markerPlacement,i.textSpacing=r.markerSpacing,i.isIconText=!0),t.mergeOnProperty&&(i.mergeOnProperty=t.mergeOnProperty),e.push(i)),void 0!==t.visible&&(r&&(r.visible=t.visible),i&&(i.visible=t.visible)),r&&(r.markerTextFit&&i&&(r.text={},r.text.textName=i.textName,r.text.textSize=i.textSize),r.index={index:n,type:0}),i&&(i.index={index:n,type:1}),e}static isAtlasLoaded(t,n){const{icon:e,glyph:r}=t,{iconAtlas:i,glyphAtlas:s}=n;if(e&&(!i||!i.positions[e.url]))return!1;if(r){if(!s||!s.positions[r.font])return!1;const t=s.positions[r.font],{text:n}=r;for(const e of n)if(!t[e.codePointAt(0)])return!1}return!0}constructor(t,n,e){super(t,n,e),this.At=n.textPlacement,this.st.textPlacementFn&&(this.At=this.st.textPlacementFn(this.options.zoom))}createStyledVector(t,n,e,r,i,s){const o=new iu(t,this.symbolDef,n,e,r),a=o.getIconAndGlyph();if(a.icon&&!this.options.atlas){const{url:t,size:n}=a.icon;i[t]||(i[t]=a.icon.size),i[t][0]<n[0]&&(i[t][0]=n[0]),i[t][1]<n[1]&&(i[t][1]=n[1])}if(a.glyph&&!this.options.atlas){const{font:t,text:n}=a.glyph,e=s[t]=s[t]||{};for(const t of n)e[t.codePointAt(0)]=1;"line"===this.At&&(s.options={isCharsCompact:!1})}return this.options.allowEmptyPack||a.icon||a.glyph?o:null}getFormat(t){const n=void 0!==t.textName,e=n?this.getPackSDFFormat(t):this.getPackMarkerFormat();n?e.push(...this.Pt()):e.push(...this.St());const{markerOpacityFn:r,textOpacityFn:i,markerPitchAlignmentFn:s,textPitchAlignmentFn:o,markerRotationAlignmentFn:a,textRotationAlignmentFn:u,markerRotationFn:l,textRotationFn:h,markerAllowOverlapFn:c,textAllowOverlapFn:f,markerIgnorePlacementFn:d,textIgnorePlacementFn:p}=this.st;return(r||i)&&e.push({type:Uint8Array,width:1,name:"aColorOpacity"}),(s||o)&&e.push({type:Uint8Array,width:1,name:"aPitchAlign"}),(a||u)&&e.push({type:Uint8Array,width:1,name:"aRotationAlign"}),(l||h)&&e.push({type:Uint16Array,width:1,name:"aRotation"}),(c||f||d||p)&&e.push({type:Uint8Array,width:1,name:"aOverlap"}),e}_t(){return this.hasMapPitchAlign}Pt(){const{textFillFn:t,textSizeFn:n,textHaloFillFn:e,textHaloRadiusFn:r,textHaloOpacityFn:i,textDxFn:s,textDyFn:o}=this.st,a=[];return t&&a.push({type:Uint8Array,width:4,name:"aTextFill"}),n&&a.push({type:Uint8Array,width:1,name:"aTextSize"}),e&&a.push({type:Uint8Array,width:4,name:"aTextHaloFill"}),r&&a.push({type:Uint8Array,width:1,name:"aTextHaloRadius"}),i&&a.push({type:Uint8Array,width:1,name:"aTextHaloOpacity"}),s&&a.push({type:Int8Array,width:1,name:"aTextDx"}),o&&a.push({type:Int8Array,width:1,name:"aTextDy"}),a}St(){const{markerWidthFn:t,markerHeightFn:n,markerDxFn:e,markerDyFn:r}=this.st,i=[];return t&&i.push({type:this.options.markerWidthType||Uint8Array,width:1,name:"aMarkerWidth"}),n&&i.push({type:this.options.markerHeightType||Uint8Array,width:1,name:"aMarkerHeight"}),e&&i.push({type:Int8Array,width:1,name:"aMarkerDx"}),r&&i.push({type:Int8Array,width:1,name:"aMarkerDy"}),i}createDataPack(){if(!this.iconAtlas&&!this.glyphAtlas){if(!this.options.allowEmptyPack)return null;this.empty=!0}this.countOutOfAngle=0,this.lineVertex=[];const t=super.createDataPack.apply(this,arguments);return t?(t.lineVertex=new Int16Array(this.lineVertex),t.buffers.push(t.lineVertex.buffer),t):null}placeVector(t,n){const e=t.getShape(this.iconAtlas,this.glyphAtlas);if(!(this.options.allowEmptyPack||e&&e.image||e&&(e.horizontal||e.vertical)))return;const r=this.Ot(t,e,n);if(this.countOutOfAngle+=r.countOutOfAngle||0,0===r.length)return;const i=this.data,s=this.needAltitudeAttribute()?2:3;let o=this.data.aPosition.getLength()/s;const a=t.symbol,u=t.feature.properties,l="line"===this.At&&!a.isIconText,h=void 0!==a.textName,c=h&&l&&function(t){let n=0;for(let e=0;e<t.length;e++)if(Na(t.charAt(e).charCodeAt(0)))n=0;else if(n++,n>=1)return!1;return!0}(t.getIconAndGlyph().glyph.text)?1:0,{textFillFn:f,textSizeFn:d,textHaloFillFn:p,textHaloRadiusFn:m,textHaloOpacityFn:g,textDxFn:v,textDyFn:b,textPitchAlignmentFn:w,textRotationAlignmentFn:M,textRotationFn:x,textAllowOverlapFn:F,textIgnorePlacementFn:k,textOpacityFn:A,markerWidthFn:P,markerHeightFn:S,markerDxFn:_,markerDyFn:O,markerPitchAlignmentFn:C,markerRotationAlignmentFn:E,markerRotationFn:I,markerAllowOverlapFn:$,markerIgnorePlacementFn:T,markerOpacityFn:D}=this.st;let z,j,U,N,L,R,V,H,q,G,J,W,B,X,Y,K,Z;if(h){const n=t.getIconAndGlyph().glyph.font;z=function(t,n,e){const r=t.positionedGlyphs,i=[];for(let s=0;s<r.length;s++){const o=r[s],a=e[o.glyph];if(!a)continue;const u=a.rect;if(!u)continue;const l=4,h=a.metrics.advance/2,c=a.metrics.height/2,f=n?[o.x+h,0]:[0,0],d=n?[0,o.y-c]:[o.x+h,o.y-c],p=a.metrics.left-l-h+d[0],y=a.metrics.top-l+d[1],m=p+u.w,g=y+u.h,v=new dt(p,y),b=new dt(m,y),w=new dt(p,g),M=new dt(m,g);if(n&&o.vertical){const t=new dt(-h,h),n=-Math.PI/2,e=new dt(5,0);v.C(n,t).F(e),b.C(n,t).F(e),w.C(n,t).F(e),M.C(n,t).F(e)}i.push({tl:v,tr:b,bl:w,br:M,tex:u,writingMode:t.writingMode,glyphOffset:f})}return i}(e.horizontal,l,this.glyphAtlas.positions[n]),f&&(j=f(null,u),y(j)?(this.dynamicAttrs.aTextFill=1,j=[0,0,0,0]):j=Ir([],j)),d&&(U=d(this.options.zoom,u),or(U)&&(U=14)),p&&(N=p(null,u),y(N)?(this.dynamicAttrs.aTextHaloFill=1,N=[0,0,0,0]):N=Ir([],N)),m&&(L=m(null,u)),g&&(R=255*g(null,u)),v&&(V=v(null,u)||0),b&&(H=b(null,u)||0),w&&(B=+("map"===w(null,u))),M&&(X=+("map"===M(null,u))),x&&(Y=ar(x(null,u),0,360)*Math.PI/180)}else z=e?function(t){const n=t.image,e=t.top-1/n.pixelRatio,r=t.left-1/n.pixelRatio,i=t.bottom+1/n.pixelRatio,s=t.right+1/n.pixelRatio;let o,a,u,l;return o=new dt(r,e),a=new dt(s,e),u=new dt(s,i),l=new dt(r,i),[{tl:o,tr:a,bl:l,br:u,tex:{x:n.tl[0],y:n.tl[1],w:n.displaySize[0],h:n.displaySize[1]},writingMode:void 0,glyphOffset:[0,0]}]}(e):function(){const t=new dt(0,0),n=new dt(0,0),e=new dt(0,0);return[{tl:t,tr:n,bl:new dt(0,0),br:e,tex:{x:0,y:0,w:0,h:0},writingMode:void 0,glyphOffset:[0,0]}]}(),P&&(q=P(null,u)),or(q)&&(q=z[0].tex.w),S&&(G=S(null,u)),or(G)&&(G=z[0].tex.h),_&&(J=_(null,u)),O&&(W=O(null,u)),C&&(B=+("map"===C(null,u))),E&&(X=+("map"===E(null,u))),I&&(Y=ar(I(null,u),0,360)*Math.PI/180);y(U)&&(this.dynamicAttrs.aTextSize=1),y(L)&&(this.dynamicAttrs.aTextHaloRadius=1),y(R)&&(this.dynamicAttrs.aTextHaloOpacity=1),y(V)&&(this.dynamicAttrs.aTextDx=1),y(H)&&(this.dynamicAttrs.aTextDy=1),y(q)&&(this.dynamicAttrs.aMarkerWidth=1),y(G)&&(this.dynamicAttrs.aMarkerHeight=1),y(J)&&(this.dynamicAttrs.aMarkerDx=1),y(W)&&(this.dynamicAttrs.aMarkerDy=1),y(B)&&(this.dynamicAttrs.aPitchAlign=1),y(X)&&(this.dynamicAttrs.aRotationAlign=1),y(Y)&&(this.dynamicAttrs.aRotation=1);const Q=$||F;Q&&(K=Q(null,u)||0);const tt=T||k;let nt;tt&&(Z=tt(null,u)||0);const et=A||D;et&&(nt=255*et(this.options.zoom,u));const rt=z.length;this.ensureDataCapacity(4*rt,r.length);const it=this.options.EXTENT,{altitudeScale:st,altitudeProperty:ot,defaultAltitude:at}=this.options,{altitude:ut}=ir(t.feature,st,ot,at);for(let t=0;t<r.length;t++){const n=r[t],e=n.z||ut||0;if(it!==1/0&&sr(n,it))continue;const s=n.x,a=n.y,u=z.length;for(let t=0;t<u;t++){const r=z[t],{tl:u,tr:f,bl:d,br:p,tex:y}=r;this.Ct(i,s,a,e,10*u.x,10*u.y,y.x,y.y+y.h),h&&this.Et(i,l,rt,r.glyphOffset,n,c,n.axis,n.angleR),this.It(i,j,U,N,L,R,V,H,q,G,J,W,nt,B,X,Y,K,Z),this.Ct(i,s,a,e,10*f.x,10*f.y,y.x+y.w,y.y+y.h),h&&this.Et(i,l,rt,r.glyphOffset,n,c,n.axis,n.angleR),this.It(i,j,U,N,L,R,V,H,q,G,J,W,nt,B,X,Y,K,Z),this.Ct(i,s,a,e,10*d.x,10*d.y,y.x,y.y),h&&this.Et(i,l,rt,r.glyphOffset,n,c,n.axis,n.angleR),this.It(i,j,U,N,L,R,V,H,q,G,J,W,nt,B,X,Y,K,Z),this.Ct(i,s,a,e,10*p.x,10*p.y,y.x+y.w,y.y),h&&this.Et(i,l,rt,r.glyphOffset,n,c,n.axis,n.angleR),this.It(i,j,U,N,L,R,V,H,q,G,J,W,nt,B,X,Y,K,Z),this.addElements(o,o+1,o+2),this.addElements(o+1,o+2,o+3),o+=4;const m=Math.max(Math.abs(s),Math.abs(a),Math.abs(e));m>this.maxPos&&(this.maxPos=m)}}}Ct(t,n,e,r,i,s,o,a){this.fillPosition(t,n,e,r);let u=t.aShape.currentIndex;t.aShape[u++]=i,t.aShape[u++]=s,t.aShape.currentIndex=u,u=t.aTexCoord.currentIndex,t.aTexCoord[u++]=o,t.aTexCoord[u++]=a,t.aTexCoord.currentIndex=u}Et(t,n,e,r,i,s,o,a){let u=t.aCount.currentIndex;if(t.aCount[u++]=e,t.aCount.currentIndex=u,n){u=t.aGlyphOffset.currentIndex,t.aGlyphOffset[u++]=r[0],t.aGlyphOffset[u++]=r[1],t.aGlyphOffset.currentIndex=u,this._t()&&(u=t.aPitchRotation.currentIndex,t.aPitchRotation[u++]=o[0],t.aPitchRotation[u++]=o[1],t.aPitchRotation[u++]=a,t.aPitchRotation.currentIndex=u);const n=i.startIndex;u=t.aSegment.currentIndex,t.aSegment[u++]=i.segment+n,t.aSegment[u++]=n,t.aSegment[u++]=i.line.length,t.aSegment.currentIndex=u,u=t.aVertical.currentIndex,t.aVertical[u++]=s,t.aVertical.currentIndex=u}}It(t,n,e,r,i,s,o,a,u,l,h,c,f,d,p,y,m,g){const{textFillFn:v,textSizeFn:b,textHaloFillFn:w,textHaloRadiusFn:M,textHaloOpacityFn:x,textDxFn:F,textDyFn:k,textPitchAlignmentFn:A,textRotationAlignmentFn:P,textRotationFn:S,textAllowOverlapFn:_,textIgnorePlacementFn:O,textOpacityFn:C,markerWidthFn:E,markerHeightFn:I,markerDxFn:$,markerDyFn:T,markerPitchAlignmentFn:D,markerRotationAlignmentFn:z,markerRotationFn:j,markerAllowOverlapFn:U,markerIgnorePlacementFn:N,markerOpacityFn:L}=this.st;if(v){let e=t.aTextFill.currentIndex;t.aTextFill[e++]=n[0],t.aTextFill[e++]=n[1],t.aTextFill[e++]=n[2],t.aTextFill[e++]=n[3],t.aTextFill.currentIndex=e}if(b){let n=t.aTextSize.currentIndex;t.aTextSize[n++]=e,t.aTextSize.currentIndex=n}if(w){let n=t.aTextHaloFill.currentIndex;t.aTextHaloFill[n++]=r[0],t.aTextHaloFill[n++]=r[1],t.aTextHaloFill[n++]=r[2],t.aTextHaloFill[n++]=r[3],t.aTextHaloFill.currentIndex=n}if(M){let n=t.aTextHaloRadius.currentIndex;t.aTextHaloRadius[n++]=i,t.aTextHaloRadius.currentIndex=n}if(x){let n=t.aTextHaloOpacity.currentIndex;t.aTextHaloOpacity[n++]=s,t.aTextHaloOpacity.currentIndex=n}if(F){let n=t.aTextDx.currentIndex;t.aTextDx[n++]=o,t.aTextDx.currentIndex=n}if(k){let n=t.aTextDy.currentIndex;t.aTextDy[n++]=a,t.aTextDy.currentIndex=n}if(E){let n=t.aMarkerWidth.currentIndex;t.aMarkerWidth[n++]=u,t.aMarkerWidth.currentIndex=n}if(I){let n=t.aMarkerHeight.currentIndex;t.aMarkerHeight[n++]=l,t.aMarkerHeight.currentIndex=n}if($){let n=t.aMarkerDx.currentIndex;t.aMarkerDx[n++]=h,t.aMarkerDx.currentIndex=n}if(T){let n=t.aMarkerDy.currentIndex;t.aMarkerDy[n++]=c,t.aMarkerDy.currentIndex=n}if(L||C){let n=t.aColorOpacity.currentIndex;t.aColorOpacity[n++]=f,t.aColorOpacity.currentIndex=n}if(A||D){let n=t.aPitchAlign.currentIndex;t.aPitchAlign[n++]=d,t.aPitchAlign.currentIndex=n}if(z||P){let n=t.aRotationAlign.currentIndex;t.aRotationAlign[n++]=p,t.aRotationAlign.currentIndex=n}if(j||S){let n=t.aRotation.currentIndex;t.aRotation[n++]=9362*y,t.aRotation.currentIndex=n}const R=U||_,V=N||O;if(R||V){let n=t.aOverlap.currentIndex;t.aOverlap[n++]=(R?8:0)+4*m+((V?2:0)+g),t.aOverlap.currentIndex=n}i>0&&(this.properties.hasHalo=1)}Ot(t,n,e){const{feature:r,symbol:i}=t,s=this.$t(t,i),o=r.properties,{markerSpacingFn:a,textSpacingFn:u,textMaxAngleFn:l}=this.st,h=((a?a(null,o):i.markerSpacing)||(u?u(null,o):i.textSpacing)||250)*e;let c=l?l(this.options.zoom,o):i.textMaxAngle;or(c)&&(c=80),c*=Math.PI/180;const f=this.options.EXTENT,d=this.options.altitudeToTileScale,p=this._t();return vu(t,this.lineVertex,c,n,e,f,s,h,p,d)}$t(t,n){let e;return e=this.st.markerPlacementFn?this.st.markerPlacementFn(this.options.zoom,t.feature.properties):n.markerPlacement||this.At,this.vt||!n.markerPlacement&&!n.isIconText||(this.vt=e),!this.At||n.isIconText||this.bt||(this.bt=e),e}getPackSDFFormat(t){if("line"!==this.At||t.isIconText)return[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"},{type:Uint8Array,width:1,name:"aCount"}];{const t=[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"},{type:Uint8Array,width:1,name:"aCount"},{type:Int16Array,width:2,name:"aGlyphOffset"},{type:Uint16Array,width:3,name:"aSegment"},{type:Uint8Array,width:1,name:"aVertical"}];return this._t()&&t.push({type:Float32Array,width:3,name:"aPitchRotation"}),t}}getPackMarkerFormat(){return[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"}]}}class Au{constructor(t){this.x=t.x,this.y=t.y,this.z=t.z||0}clone(){return new Au(this)}T(){return this._(this.mag()),this}_(t){return this.x/=t,this.y/=t,this.z/=t,this}D(){var t=this.y;return this.y=this.x,this.x=-t,this}mag(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}add(t){return this.clone().F(t)}sub(t){return this.clone().k(t)}F(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}k(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}mult(t){return this.clone().S(t)}S(t){return this.x*=t,this.y*=t,this.z*=t,this}dist(t){return Math.sqrt(this.distSqr(t))}distSqr(t){var n=t.x-this.x,e=t.y-this.y,r=t.z-this.z;return n*n+e*e+r*r}j(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}angleTo(t){return Math.atan2(this.y-t.y,this.x-t.x)}}const Pu=63,Su=Math.cos(Math.PI/180*37.5),_u=Math.pow(2,16)/1,Ou=new dt,Cu=new dt,Eu=new dt;class Iu extends Pa{static mergeLineFeatures(t,n,e,r){return Fu(t,n,e,r)}constructor(t,n,e){super(t,n,e);let r=!1;const{lineDasharrayFn:i,lineDashColorFn:s}=this.st;this.hasGradient=this.symbol.lineGradientProperty,i&&(r=function(t,n,e){for(let r=0;r<t.length;r++)if(e(n,t[r].properties))return!0;return!1}(t,this.options.zoom,i),r&&(this.dasharrayFn=i)),this.hasDasharray=Du(this.symbol.lineDasharray)||r,this.hasDasharray&&s&&(this.dashColorFn=s)}createStyledVector(t,n,e,r,i){const s=new zr(t,n,e,r),o=s.getLineResource();return!this.options.atlas&&o&&(i[o]=[0,0]),s}getFormat(){const{lineWidthFn:t,lineStrokeWidthFn:n,lineStrokeColorFn:e,lineColorFn:r,lineOpacityFn:i,lineDxFn:s,lineDyFn:o,linePatternAnimSpeedFn:a,linePatternGapFn:u}=this.st,l=[...this.getPositionFormat()];if(l.push(this.iconAtlas||this.hasDasharray?{type:Int8Array,width:3,name:"aExtrude"}:{type:Int8Array,width:2,name:"aExtrude"}),l.push({type:this.options.positionType||Uint16Array,width:1,name:"aLinesofar"}),t&&l.push({type:Uint8Array,width:1,name:"aLineWidth"}),n&&l.push({type:Uint8Array,width:1,name:"aLineStrokeWidth"}),r&&l.push({type:Uint8Array,width:4,name:"aColor"}),e&&l.push({type:Uint8Array,width:4,name:"aStrokeColor"}),i&&l.push({type:Uint8Array,width:1,name:"aOpacity"}),this.dasharrayFn&&l.push({type:Uint8Array,width:4,name:"aDasharray"}),this.dashColorFn&&l.push({type:Uint8Array,width:4,name:"aDashColor"}),this.iconAtlas){const t=this.getIconAtlasMaxValue();l.push({type:t>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return(s||o)&&l.push({type:Int8Array,width:2,name:"aLineDxDy"}),(a||u)&&l.push({type:Int8Array,width:2,name:"aLinePattern"}),l}placeVector(t){const{lineJoinFn:n,lineCapFn:e,lineWidthFn:r,lineHeightFn:i,lineStrokeWidthFn:s,lineStrokeColorFn:o,lineColorFn:a,lineOpacityFn:u,lineDxFn:l,lineDyFn:h,linePatternAnimSpeedFn:c,linePatternGapFn:f}=this.st,d=this.symbol,p=t.feature,m=p.properties;let g=d.lineJoin||"miter",v=d.lineCap||"butt";if(n&&(g=n(this.options.zoom,m)||"miter"),e&&(v=e(this.options.zoom,m)||"butt"),r){let t=r(this.options.zoom,m);y(t)&&(this.dynamicAttrs.aLineWidth=1,t=4),wr(t)&&(t=4),this.feaLineWidth=+t}else this.feaLineWidth=+d.lineWidth;if(i){let t=i(this.options.zoom,m);y(t)&&(this.dynamicAttrs.aLineHeight=1),wr(t)&&(t=this.feaLineWidth),this.feaLineHeight=+t}else this.feaLineHeight=+d.lineHeight||this.feaLineWidth;if(s){let t=s(this.options.zoom,m);y(t)&&(this.dynamicAttrs.aLineStrokeWidth=1,t=0),wr(t)&&(t=0),this.feaLineStrokeWidth=t}else this.feaLineStrokeWidth=d.lineStrokeWidth||0;if(a&&(this.feaColor=a(this.options.zoom,m)||[255,255,255,255],y(this.feaColor)?(this.dynamicAttrs.aColor=1,this.feaColor=[0,0,0,0]):this.feaColor=Ir([],this.feaColor)),o&&(this.feaStrokeColor=o(this.options.zoom,m)||[0,0,0,255],y(this.feaStrokeColor)?(this.dynamicAttrs.aStrokeColor=1,this.feaStrokeColor=[0,0,0,0]):this.feaStrokeColor=Ir([],this.feaStrokeColor)),u){let t=u(this.options.zoom,m);y(t)&&(this.dynamicAttrs.aOpacity=1,t=1),wr(t)&&(t=1),this.feaOpacity=255*t}if(this.dasharrayFn){let t=this.dasharrayFn(this.options.zoom,m)||[0,0,0,0];if(y(t)&&(this.dynamicAttrs.aDasharray=1,t=[0,0,0,0]),t.length<4){const n=t;1===t.length?t=[n[0],n[0],n[0],n[0]]:2===t.length?t=[n[0],n[1],n[0],n[1]]:3===t.length&&(t=[n[0],n[1],n[2],n[2]])}this.feaDash=t}if(this.dashColorFn){let t=(this.dashColorFn?this.dashColorFn(this.options.zoom,m):this.symbol.lineDashColor)||[0,0,0,0];y(t)&&(this.dynamicAttrs.aDashColor=1,t=[0,0,0,0]),t=Ir([],t),this.feaDashColor=t}if(this.iconAtlas){const n=t.getLineResource(),e=this.iconAtlas.glyphMap[n];if(this.feaTexInfo=this.feaTexInfo||[0,0,0,0],e){const{tl:t,displaySize:e}=this.iconAtlas.positions[n];this.feaTexInfo[0]=t[0]+1,this.feaTexInfo[1]=t[1]+1,this.feaTexInfo[2]=e[0]-3,this.feaTexInfo[3]=e[1]-3}else this.feaTexInfo[0]=this.feaTexInfo[1]=this.feaTexInfo[2]=this.feaTexInfo[3]=0}if(l){let t=l(this.options.zoom,m);y(t)&&(this.dynamicAttrs.aLineDxDy=1,t=0),wr(t)&&(t=0),this.feaLineDx=t}if(h){let t=h(this.options.zoom,m);y(t)&&(this.dynamicAttrs.aLineDxDy=1,t=0),wr(t)&&(t=0),this.feaLineDy=t}if(c){let t=c(this.options.zoom,m);y(t)&&(this.dynamicAttrs.aLinePatternAnimSpeed=1,t=0),wr(t)&&(t=0),0!==t&&(this.properties.hasPatternAnim=1),this.feaPatternAnimSpeed=t}if(f){let t=f(this.options.zoom,m);y(t)&&(this.dynamicAttrs.aLinePatternGap=1,t=0),wr(t)&&(t=0),this.feaLinePatternGap=t}const b=this.options.EXTENT;let w=p.geometry;if(b!==1/0){w=[];const t=[];for(let n=0;n<p.geometry.length;n++){t[0]=p.geometry[n];const e=ou(t,-1,-1,b+1,b+1);if(3===p.type&&e.length>1){const t=e[0],n=e[e.length-1];Uu(t[0],n[n.length-1])&&(e[0]=n.concat(t.slice(1)),e.length=e.length-1)}w.push(...e)}}const M=this.needAltitudeAttribute()?2:3;for(let t=0;t<w.length;t++)this.offset=this.data.aPosition.getLength()/M,this.Tt(w[t],p,g,v,2,1.05)}Dt(){return this.iconAtlas&&this.feaTexInfo[2]&&this.feaTexInfo[3]}Tt(t,n,e,r,i,s){const o=this.Dt()||Du(this.feaDash)||Du(this.symbol.lineDasharray),a=this.options.isTube;a&&(t=t.map((t=>new Au(t)))),this.overscaling=1;const u=this.options.EXTENT;if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.prevVertex=null,this.symbol.lineGradientProperty&&n.properties&&Mr(n.properties.mapbox_clip_start)&&Mr(n.properties.mapbox_clip_end)){this.clipStart=+n.properties.mapbox_clip_start,this.clipEnd=+n.properties.mapbox_clip_end;for(let n=0;n<t.length-1;n++)this.totalDistance+=t[n].dist(t[n+1]);this.updateScaledDistance()}const l=3===n.type&&!t.clipped;let h=t.length;for(;h>=2&&Uu(t[h-1],t[h-2]);)h--;let c=0;for(;c<h-1&&Uu(t[c],t[c+1]);)c++;if(h<(l?3:2))return;"bevel"===e&&(i=1.05);const f=this.overscaling<=16?15*u/(512*this.overscaling):0,d={vertexLength:0,primitiveLength:0,currentNormal:null};let p,y,m,g,v;this.e1=this.e2=-1,l&&(p=t[h-2],v=t[c].sub(p).T().D()),this.ensureDataCapacity(e,h,360,2);for(let n=c;n<h;n++){if(m=n===h-1?l?t[c+1]:void 0:t[n+1],m&&Uu(t[n],m))continue;v&&(g=v),p&&(y=p),p=t[n],m&&p.x===m.x&&p.y===m.y&&(p.x+=1e-4),v=m?m.sub(p).T().D():g,d.dir=y?p.sub(y).T():m.sub(p).T(),g=g||v,d.currentNormal=g;let u=g.add(v);0===u.x&&0===u.y||u.T();const b=g.x*v.x+g.y*v.y,w=u.x*v.x+u.y*v.y,M=0!==w?1/w:1/0,x=2*Math.sqrt(2-2*w),F=w<Su&&y&&m,k=g.x*v.y-g.y*v.x>0;if(!a&&F&&n>c){const t=p.dist(y);if(t>2*f){const n=p.sub(p.sub(y).S(f/t).j());n.z=p.z,this.updateDistance(y,n),this.addCurrentVertex(n,g,0,0,d),y=n}}const A=y&&m;d.middleVertex=A;let P=A?e:l?"butt":r;if(A&&"round"===P&&(M<s?P="miter":M<=2&&(P="fakeround")),"miter"===P&&M>i&&!a&&(P="bevel"),"bevel"===P&&(M>2&&(P="flipbevel"),M<i&&(P="miter")),y&&this.updateDistance(y,p),"miter"===P)a?(this.addCurrentVertex(p,g,0,0,d),d.dir=m.sub(p).T(),this.addCurrentVertex(p,v,0,0,d)):(u.S(M),this.addCurrentVertex(p,u,0,0,d),o&&(d.currentNormal=v,this.addCurrentVertex(p,u,0,0,d)));else if("flipbevel"===P){if(M>100)u=v.mult(-1);else{const t=M*g.add(v).mag()/g.sub(v).mag();u.D().S(t*(k?-1:1))}this.addCurrentVertex(p,u,0,0,d),this.addCurrentVertex(p,u.mult(-1),0,0,d)}else if("bevel"===P||"fakeround"===P){const t=-Math.sqrt(M*M-1),n=k?t:0,e=k?0:t;if(y&&this.addCurrentVertex(p,g,n,e,d),"fakeround"===P){const t=Math.round(180*x/Math.PI/20);for(let n=1;n<t;n++){let e=n/t;if(.5!==e){const t=e-.5;e+=e*t*(e-1)*((1.0904+b*(b*(3.55645-1.43519*b)-3.2452))*t*t+(.848013+b*(.215638*b-1.06021)))}const r=v.sub(g).S(e).F(g).T().S(k?-1:1);this.addHalfVertex(p,r.x,r.y,!1,k,0,d)}}m&&(d.currentNormal=v,this.addCurrentVertex(p,v,-n,-e,d))}else if("butt"===P)this.addCurrentVertex(p,u,0,0,d);else if("square"===P){const t=y?1:-1;this.addCurrentVertex(p,u,t,t,d)}else"round"===P&&(y&&(this.addCurrentVertex(p,g,0,0,d),this.addCurrentVertex(p,g,1,1,d,!0)),m&&(this.addCurrentVertex(p,v,-1,-1,d,!0),this.addCurrentVertex(p,v,0,0,d)));if(!a&&F&&n<h-1){const t=p.dist(m);if(t>2*f){const n=p.add(m.sub(p).S(f/t).j());n.z=p.z,this.updateDistance(p,n),this.addCurrentVertex(n,v,0,0,d),p=n}}}}ensureDataCapacity(t,n,e,r){const i="round"===t?Math.round(e/20)-1:0;super.ensureDataCapacity((6+i)*r,n)}addCurrentVertex(t,n,e,r,i,s=!1){const o=n.x+n.y*e,a=n.y-n.x*e,u=n.y*r-n.x,l=-n.y-n.x*r;let h=0,c=0;if(i.middleVertex){Ou.x=o,Ou.y=a,Cu.x=u,Cu.y=l;const t=i.currentNormal;if(h=ju(t,Ou),0===e&&0===r)c=-h;else{const n=Eu;n.x=t.x,n.y=t.y,n.S(-1),c=ju(n,Cu)}}this.addHalfVertex(t,o,a,s,!1,e,i,h),this.addHalfVertex(t,u,l,s,!0,-r,i,c),this.prevVertex&&Uu(t,this.prevVertex)||(this.prevVertex=t),this.distance>_u/2&&0===this.totalDistance&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(t,n,e,r,i,s))}addHalfVertex({x:t,y:n,z:e},r,i,s,o,a,u,l){this.fillData(this.data,t,n,e||0,r,i,s,o,1*this.scaledDistance,l);const h=u.vertexLength++;this.e1>=0&&this.e2>=0&&(this.addElements(this.e1,this.e2,h),u.primitiveLength++),o?this.e2=h:this.e1=h}fillData(t,n,e,r,i,s,o,a,u,l){const{lineWidthFn:h,lineStrokeWidthFn:c,lineStrokeColorFn:f,lineColorFn:d,lineOpacityFn:p,lineDxFn:y,lineDyFn:m,linePatternAnimSpeedFn:g,linePatternGapFn:v}=this.st;this.fillPosition(t,n,e,r);let b=Pu*i;b=(Math.sign(b)||1)*((Math.floor(Math.abs(b))>>1<<1)+ +o);let w=Pu*s;w=(Math.sign(w)||1)*((Math.floor(Math.abs(w))>>1<<1)+ +a);let M=t.aExtrude.currentIndex;t.aExtrude[M++]=b,t.aExtrude[M++]=w,(this.iconAtlas||this.hasDasharray)&&(t.aExtrude[M++]=Pu*l),t.aExtrude.currentIndex=M,M=t.aLinesofar.currentIndex,t.aLinesofar[M++]=u,t.aLinesofar.currentIndex=M,h&&(M=t.aLineWidth.currentIndex,t.aLineWidth[M++]=Math.round(2*this.feaLineWidth),t.aLineWidth.currentIndex=M),c&&(M=t.aLineStrokeWidth.currentIndex,t.aLineStrokeWidth[M++]=Math.round(2*this.feaLineStrokeWidth),t.aLineStrokeWidth.currentIndex=M),d&&(M=t.aColor.currentIndex,t.aColor[M++]=this.feaColor[0],t.aColor[M++]=this.feaColor[1],t.aColor[M++]=this.feaColor[2],t.aColor[M++]=this.feaColor[3],t.aColor.currentIndex=M),f&&(M=t.aStrokeColor.currentIndex,t.aStrokeColor[M++]=this.feaStrokeColor[0],t.aStrokeColor[M++]=this.feaStrokeColor[1],t.aStrokeColor[M++]=this.feaStrokeColor[2],t.aStrokeColor[M++]=this.feaStrokeColor[3],t.aStrokeColor.currentIndex=M),p&&(M=t.aOpacity.currentIndex,t.aOpacity[M++]=this.feaOpacity,t.aOpacity.currentIndex=M),this.dasharrayFn&&(M=t.aDasharray.currentIndex,t.aDasharray[M++]=this.feaDash[0],t.aDasharray[M++]=this.feaDash[1],t.aDasharray[M++]=this.feaDash[2],t.aDasharray[M++]=this.feaDash[3],t.aDasharray.currentIndex=M),this.dashColorFn&&(M=t.aDashColor.currentIndex,t.aDashColor[M++]=this.feaDashColor[0],t.aDashColor[M++]=this.feaDashColor[1],t.aDashColor[M++]=this.feaDashColor[2],t.aDashColor[M++]=this.feaDashColor[3],t.aDashColor.currentIndex=M),this.iconAtlas&&(M=t.aTexInfo.currentIndex,t.aTexInfo[M++]=this.feaTexInfo[0],t.aTexInfo[M++]=this.feaTexInfo[1],t.aTexInfo[M++]=this.feaTexInfo[2],t.aTexInfo[M++]=this.feaTexInfo[3],t.aTexInfo.currentIndex=M),(y||m)&&(M=t.aLineDxDy.currentIndex,t.aLineDxDy[M++]=this.feaLineDx||0,t.aLineDxDy[M++]=this.feaLineDy||0,t.aLineDxDy.currentIndex=M),(g||v)&&(M=t.aLinePattern.currentIndex,t.aLinePattern[M++]=127*(this.feaPatternAnimSpeed||0),t.aLinePattern[M++]=10*(this.feaLinePatternGap||0),t.aLinePattern.currentIndex=M),this.maxPos=Math.max(this.maxPos,Math.abs(n)+1,Math.abs(e)+1)}addElements(t,n,e){super.addElements(this.offset+t,this.offset+n,this.offset+e)}zt(t){const n=this.options.EXTENT,e=this.elements;for(let r=0;r<e.length;r+=3)if(n===1/0||!Tu(this.data.aPosition,e[r],e[r+1],3,n)&&!Tu(this.data.aPosition,e[r+1],e[r+2],3,n)){let n=t.currentIndex;t[n++]=e[r],t[n++]=e[r+1],t[n++]=e[r+2],t.currentIndex=n}}jt(t){if(t.length<=1)return t;const n=[],e=this.options.EXTENT;let r,i=!0;for(r=0;r<t.length-1;r++){const s=$u(t[r],t[r+1],e);s&&i||(n.push(t[r]),i=s)}return i||n.push(t[r]),n}updateDistance(t,n){if(this.options.isTube){const e=t.dist(n),r=Or(this.options)*(n.z-t.z);this.distance+=Math.sqrt(e*e+r*r)}else this.distance+=t.dist(n);this.updateScaledDistance()}updateScaledDistance(){this.scaledDistance=this.totalDistance>0?(this.clipStart+(this.clipEnd-this.clipStart)*this.distance/this.totalDistance)*(_u-1):this.distance}}function $u(t,n,e){return e!==1/0&&(t.x<0&&n.x<0||t.x>e&&n.x>e||t.y<0&&n.y<0||t.y>e&&n.y>e)}function Tu(t,n,e,r,i){if(i===1/0)return!1;const s=Math.floor(.5*t[n*r]),o=Math.floor(.5*t[n*r+1]),a=Math.floor(.5*t[e*r]),u=Math.floor(.5*t[e*r+1]);return s===a&&(s<0||s>i)&&o!==u||o===u&&(o<0||o>i)&&s!==a}function Du(t){if(!Array.isArray(t))return!1;for(let n=0;n<t.length;n++)if(t[n])return!0;return!1}const zu=new dt(0,0);function ju(t,n){const e=t.mag(),r=n.mag(),i=t.angleTo(zu),s=n.angleTo(zu);return Math.sign(s-i)*Math.sqrt(r*r-e*e)}function Uu(t,n){return t.equals(n)&&t.z===n.z}class Nu extends Iu{constructor(t,n,e){super(t,n,e),this.Ut=e.altitudeProperty}getFormat(){const{lineColorFn:t,lineWidthFn:n}=this.st,e=[{type:this.maxPosZ>=Math.pow(2,15)?Float32Array:Int16Array,width:3,name:"aPosition"},{type:Uint16Array,width:1,name:"aLinesofar"},{type:Uint8Array,width:1,name:"aUp"},{type:Int16Array,width:3,name:"aExtrudedPosition"},{type:Int8Array,width:2,name:"aExtrude"}];return t&&e.push({type:Uint8Array,width:4,name:"aColor"}),n&&e.push({type:Uint8Array,width:1,name:"aLineWidth"}),this.Ut&&e.push({type:Float32Array,width:1,name:"aLineHeight"}),e}placeVector(t){const n=t.feature;if(this.Ut){const{altitudeScale:t,altitudeProperty:e,defaultAltitude:r,heightProperty:i,defaultHeight:s,minHeightProperty:o}=this.options,{altitude:a,height:u}=ir(n,t,e,r,i,s,o);this.feaAltitude=a,this.feaMinHeight=(a-u)/a*32767,a>this.maxAltitude&&(this.maxAltitude=a)}return super.placeVector(t)}needAltitudeAttribute(){return!1}Tt(t,n,e,r,i,s){const o=this.data.aPosition.getLength()/3;super.Tt(t,n,e,r,i,s);const a=this.data.aPosition.getLength()/3,u=this.data.aPosition.getLength()/3-this.offset;if(3!==n.type&&u>0&&!1!==this.options.side){const t=!1!==this.options.top?1:0,n=t+4;let e=this.data.aPosition.getLength()/3;for(const t in this.data){const n=this.data[t],r=n.getLength()/e;let i=n.currentIndex;for(let t=0;t<r;t++)n[i++]=n[o*r+3*r+t];n.currentIndex=i}e=this.data.aPosition.getLength()/3;for(const t in this.data){const r=this.data[t],i=r.getLength()/e;let s=r.currentIndex;for(let t=0;t<i;t++)r[s++]=r[o*i+i*n+t];r.currentIndex=s}e=this.data.aPosition.getLength()/3;for(const t in this.data){const r=this.data[t],i=r.getLength()/e;let s=r.currentIndex;for(let t=0;t<i;t++)r[s++]=r[o*i+i*(n+3)+t];r.currentIndex=s}super.addElements(t+1,u+1,u),super.addElements(u,u+1,u+2);const r=this.data.aPosition.getLength()/3-this.offset;e=this.data.aPosition.getLength()/3;for(const t in this.data){const n=this.data[t],r=n.getLength()/e;let i=n.currentIndex;for(let t=0;t<r;t++)n[i++]=n[a*r-r+t];n.currentIndex=i}e=this.data.aPosition.getLength()/3;for(const t in this.data){const r=this.data[t],i=r.getLength()/e;let s=r.currentIndex;for(let t=0;t<i;t++)r[s++]=r[a*i-n*i-i+t];r.currentIndex=s}e=this.data.aPosition.getLength()/3;for(const t in this.data){const r=this.data[t],i=r.getLength()/e;let s=r.currentIndex;for(let t=0;t<i;t++)r[s++]=r[a*i-n*i-3*i+t];r.currentIndex=s}super.addElements(r,u-3,r+1),super.addElements(u-3,r+2,r+1)}}fillData(t,n,e,r,i,s,o,a,u){const l=!1!==this.options.top,h=!1!==this.options.side,c=this.feaLineWidth||this.symbol.lineWidth/2*(this.options.EXTENT/this.options.tileSize),f=Pu*i,d=Pu*s,p=c*i+n,y=c*s+e;this.Nt(t,n,e,i,s,o,a,u,p,y,f,d),h&&(l&&this.Nt(t,n,e,i,s,o,a,u,p,y,f,d),this.Nt(t,n,e,i,s,o,a,u,p,y,f,d),this.Lt(t,n,e,i,s,o,a,u,p,y,f,d),this.Lt(t,n,e,i,s,o,a,u,p,y,f,d)),this.maxPos=Math.max(this.maxPos,Math.abs(n),Math.abs(e))}Nt(t,n,e,r,i,s,o,a,u,l,h,c){const{lineColorFn:f,lineWidthFn:d}=this.st;let p=t.aPosition.currentIndex;t.aPosition[p++]=n,t.aPosition[p++]=e,t.aPosition[p++]=32767,t.aPosition.currentIndex=p,p=t.aLinesofar.currentIndex,t.aLinesofar[p++]=a,t.aLinesofar.currentIndex=p,p=t.aUp.currentIndex,t.aUp[p++]=+o,t.aUp.currentIndex=p,p=t.aExtrudedPosition.currentIndex,t.aExtrudedPosition[p++]=u,t.aExtrudedPosition[p++]=l,t.aExtrudedPosition[p++]=1,t.aExtrudedPosition.currentIndex=p,p=t.aExtrude.currentIndex,t.aExtrude[p++]=h,t.aExtrude[p++]=c,t.aExtrude.push(h,c),f&&(p=t.aColor.currentIndex,t.aColor[p++]=this.feaColor[0],t.aColor[p++]=this.feaColor[1],t.aColor[p++]=this.feaColor[2],t.aColor[p++]=this.feaColor[3],t.aColor.currentIndex=p),d&&(p=t.aLineWidth.currentIndex,t.aLineWidth[p++]=Math.round(2*this.feaLineWidth),t.aLineWidth.currentIndex=p),this.Ut&&(p=t.aLineHeight.currentIndex,t.aLineHeight[p++]=this.feaAltitude,t.aLineHeight.currentIndex=p)}Lt(t,n,e,r,i,s,o,a,u,l,h,c){const{lineColorFn:f,lineWidthFn:d}=this.st;let p=t.aPosition.currentIndex;t.aPosition[p++]=n,t.aPosition[p++]=e,t.aPosition[p++]=this.feaMinHeight||0,t.aPosition.currentIndex=p,p=t.aLinesofar.currentIndex,t.aLinesofar[p++]=a,t.aLinesofar.currentIndex=p,p=t.aUp.currentIndex,t.aUp[p++]=+o,t.aUp.currentIndex=p,p=t.aExtrudedPosition.currentIndex,t.aExtrudedPosition[p++]=u,t.aExtrudedPosition[p++]=l,t.aExtrudedPosition[p++]=1,t.aExtrudedPosition.currentIndex=p,p=t.aExtrude.currentIndex,t.aExtrude[p++]=h,t.aExtrude[p++]=c,t.aExtrude.push(h,c),f&&(p=t.aColor.currentIndex,t.aColor[p++]=this.feaColor[0],t.aColor[p++]=this.feaColor[1],t.aColor[p++]=this.feaColor[2],t.aColor[p++]=this.feaColor[3],t.aColor.currentIndex=p),d&&(p=t.aLineWidth.currentIndex,t.aLineWidth[p++]=Math.round(2*this.feaLineWidth),t.aLineWidth.currentIndex=p),this.Ut&&(p=t.aLineHeight.currentIndex,t.aLineHeight[p++]=this.feaAltitude,t.aLineHeight.currentIndex=p)}addElements(t,n,e){const r=!1!==this.options.top,i=!1!==this.options.side,s=(r?1:0)+(i?4:0);if(t*=s,n*=s,this.data.aUp[this.offset+(e*=s)+4]){if(r&&super.addElements(n,t,e),i){const t=r?1:0;super.addElements(n+t,e+t,e+t+2),super.addElements(n+t+1,e+t+1+2,n+t+1+2)}}else if(r&&super.addElements(t,e,n),i){const n=r?1:0;super.addElements(t+n,t+n+2,e+n),super.addElements(t+n+1+2,e+n+1+2,e+n+1)}}createDataPack(t,n){this.maxAltitude=0;const e=super.createDataPack(t,n);if(!e)return e;const{data:r,indices:i}=e;this.getFormat().reduce(((t,n)=>(t[n.name]={size:n.width},t)),{}).aPickingId={size:1};const{aExtrudedPosition:s,aPosition:o,aLinesofar:a,aUp:u,aExtrude:l,aColor:h,aLineHeight:c,aLineWidth:f}=r,d={},p=Jn(s,i);let y,m=!0;for(let t=0;t<p.length;t++)p[t]=-p[t],p[t]%1!=0&&(m=!1);if(!1!==this.options.top&&this.symbol.material&&function(t){for(const n in t)if(n.indexOf("Texture")>=0&&t[n])return!0;return!1}(this.symbol.material)&&(y=function(t,n,e){const r=[];for(let i=0;i<t.length;i+=3){const t=n[i/3];r.push(t/256,e[i/3]?1:0)}return r}(s,a,u)),d.aPosition=o,y&&(d.aTexCoord0=new Float32Array(y)),d.aNormal=m?new Int8Array(p):new Float32Array(p),d.aPickingId=r.aPickingId,d.aExtrude=l,h&&(d.aColor=h),f&&(d.aLineWidth=f),c){const t=yr(this.maxAltitude);d.aLineHeight=new t(c)}const g=[];for(const t in d)g.push(d[t].buffer);return e.data=d,e.buffers=g,e}}const Lu=Math.pow(2,16)/1;class Ru extends Pa{getFormat(){return[...this.getPositionFormat()]}placeVector(t){const n=t.feature,e=3===n.type,r=n.geometry,i=this.elements;e&&(this.elements=this.dt.get());const s=this.needAltitudeAttribute()?2:3;for(let t=0;t<r.length;t++)this.offset=this.data.aPosition.getLength()/s,this.Tt(r[t],n),e&&(this.zt(i),this.elements=this.dt.get());e&&(this.elements=i)}Tt(t,n){const e=3===n.type;let r=t.length;for(;r>=2&&t[r-1].equals(t[r-2]);)r--;let i,s,o,a=0;for(;a<r-1&&t[a].equals(t[a+1]);)a++;if(!(r<(e?3:2))){this.distance=0,this.vertexLength=0,this.primitiveLength=0,this.e1=this.e2=this.e3=-1,e&&(i=t[r-2]);for(let n=a;n<r;n++)o=e&&n===r-1?t[a+1]:t[n+1],o&&t[n].equals(o)||(i&&(s=i),i=t[n],s&&(this.distance+=i.dist(s)),this.addCurrentVertex(i,this.distance))}}addCurrentVertex(t,n){const e=this.vertexLength++;this.addLineVertex(this.data,t,n),e>=1&&this.addElements(e-1,e),n>Lu&&(this.distance=0,this.addCurrentVertex(t,this.distance))}addLineVertex(t,n){this.fillPosition(t,n.x,n.y,n.z||0),this.maxPos=Math.max(this.maxPos,Math.abs(n.x),Math.abs(n.y))}addElements(t,n){this.maxIndex=Math.max(this.maxIndex,this.offset+t,this.offset+n);let e=this.elements.currentIndex;this.elements[e++]=this.offset+t,this.elements[e++]=this.offset+n,this.elements.currentIndex=e}zt(t){const n=this.options.EXTENT,e=this.elements,r=e.getLength();for(let i=0;i<r;i+=2)if(!er(this.data.aPosition,e[i],e[i+1],3,n)){let n=t.currentIndex;t[n++]=e[i],t[n++]=e[i+1],t.currentIndex=n}}}const Vu=45*Math.PI/100;class Hu extends Pa{getFormat(){const{markerFillFn:t}=this.st;let n;return n="line"===this.symbol.markerRotationAlignment?[...this.getPositionFormat(),{type:Float32Array,width:1,name:"aXYRotation"},{type:Float32Array,width:1,name:"aZRotation"}]:[...this.getPositionFormat()],t&&n.push({type:Uint8Array,width:4,name:"aColor"}),n}placeVector(t){const n=t.feature.properties,{markerFillFn:e}=this.st;let r;e&&(r=e(this.options.zoom,n)||[255,255,255,255],y(r)?(this.dynamicAttrs.aColor=1,r=[0,0,0,0]):r=Ir([],r));const i=this.data,s="line"===this.symbol.markerRotationAlignment,o=this.Ot(t,this.symbol.markerSpacing||250,this.symbol.markerPlacement||"point",s);for(let t=0;t<o.length;t++){const n=o[t];if(this.fillPosition(this.data,n.x,n.y,n.z),s){let t=i.aXYRotation.currentIndex;i.aXYRotation[t++]=n.xyRotation||0,i.aXYRotation.currentIndex=t,t=i.aZRotation.currentIndex,i.aZRotation[t++]=n.zRotation||0,i.aZRotation.currentIndex=t}if(r){let t=i.aColor.currentIndex;i.aColor[t++]=r[0],i.aColor[t++]=r[1],i.aColor[t++]=r[2],i.aColor[t++]=r[3],i.aColor.currentIndex=t}const e=Math.max(Math.abs(n.x),Math.abs(n.y));e>this.maxPos&&(this.maxPos=e)}}Ot(t,n,e,r){const i=t.feature,s=this.options.EXTENT;if("line"===e){const t=[];let e=i.geometry;s&&(e=ou(i.geometry,0,0,s,s));for(let r=0;r<e.length;r++){const i=lu(e[r],n,Vu,null,0,24,1,1,s||1/0);t.push.apply(t,i)}return t}return bu(i,e,s,r,this.options.altitudeToTileScale)}hasElements(){return!1}}
/*!
     * from @turf/bboxClip
     * https://github.com/Turfjs/turf
     * MIT LICENSE
     */const qu=[],Gu=[];function Ju(t,n){var e,r,i,s,o,a,u;for(r=1;r<=8;r*=2){for(e=[],s=!(Bu(i=t[t.length-1],n)&r),o=0;o<t.length;o++){if((u=!(Bu(a=t[o],n)&r))!==s){const t=Wu(i,a,r,n);e.push(void 0!==a.x?new dt(t[0],t[1]):t)}u&&e.push(a),i=a,s=u}if(!(t=e).length)break}return e}function Wu(t,n,e,r){return qu[0]=void 0===t.x?t[0]:t.x,qu[1]=void 0===t.y?t[1]:t.y,t=qu,Gu[0]=void 0===n.x?n[0]:n.x,Gu[1]=void 0===n.y?n[1]:n.y,n=Gu,8&e?[t[0]+(n[0]-t[0])*(r[3]-t[1])/(n[1]-t[1]),r[3]]:4&e?[t[0]+(n[0]-t[0])*(r[1]-t[1])/(n[1]-t[1]),r[1]]:2&e?[r[2],t[1]+(n[1]-t[1])*(r[2]-t[0])/(n[0]-t[0])]:1&e?[r[0],t[1]+(n[1]-t[1])*(r[0]-t[0])/(n[0]-t[0])]:null}function Bu(t,n){qu[0]=void 0===t.x?t[0]:t.x,qu[1]=void 0===t.y?t[1]:t.y;var e=0;return(t=qu)[0]<n[0]?e|=1:t[0]>n[2]&&(e|=2),t[1]<n[1]?e|=4:t[1]>n[3]&&(e|=8),e}const Xu=[0,0,0,0],Yu=-9999999;class Ku extends Pa{constructor(...t){super(...t),this.lineElements=[]}createStyledVector(t,n,e,r,i){const s=new zr(t,n,e,r),o=s.getPolygonResource();return!this.options.atlas&&o&&(i[o]=[0,0]),s}getFormat(){const t=[...this.getPositionFormat()],{polygonFillFn:n,polygonOpacityFn:e,uvScaleFn:r,uvOffsetFn:i,polygonPatternUVFn:s}=this.st;if(this.iconAtlas){const n=this.getIconAtlasMaxValue();t.push({type:n>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return n&&t.push({type:Uint8Array,width:4,name:"aColor"}),e&&t.push({type:Uint8Array,width:1,name:"aOpacity"}),r&&t.push({type:Uint16Array,width:2,name:"aUVScale"}),i&&t.push({type:Uint8Array,width:2,name:"aUVOffset"}),s&&t.push({type:Float32Array,width:2,name:"aTexCoord"}),t}placeVector(t,n){const e=t.feature;this.Rt(e.geometry,e,n)}Rt(t,n){let e,r,i,s;const{polygonFillFn:o,polygonOpacityFn:a,uvScaleFn:u,uvOffsetFn:l,uvOffsetInMeterFn:h,polygonPatternUVFn:c}=this.st,f=n.properties;o&&(e=o(this.options.zoom,f)||ze([],255,255,255,255),y(e)?(this.dynamicAttrs.aColor=1,e=Xu):e=Ir([],e)),a&&(r=a(this.options.zoom,f),y(r)?(this.dynamicAttrs.aOpacity=1,r=255):(wr(r)&&(r=1),r*=255)),u&&(i=u(this.options.zoom,f),y(i)?(i=[255,255],this.dynamicAttrs.aUVScale=1):(wr(i)&&(i=[1,1]),i=[255*i[0],255*i[1]])),l&&(h&&h(null,f)?s=[0,0]:(s=l(this.options.zoom,f),y(s)?(s=[0,0],this.dynamicAttrs.aUVOffset=1):(wr(s)&&(s=[0,0]),s=[255*s[0],255*s[1]])));const d=!!this.iconAtlas,p=fu(t,500),m=[0,0],g=[0,0];if(d){const{polygonPatternFileFn:t}=this.st,n=t?t(null,f):this.symbol.polygonPatternFile;if(this.iconAtlas.glyphMap[n]){const t=this.iconAtlas.positions[n],e=!lr(t.displaySize[0])||!lr(t.displaySize[1]);m[0]=t.tl[0]+(e?1:0),m[1]=t.tl[1]+(e?1:0),g[0]=t.displaySize[0]-1-(e?2:0),g[1]=t.displaySize[1]-1-(e?2:0)}}let v,b=0;c&&(v=c(this.options.zoom,f));const w=this.needAltitudeAttribute()?2:3,M=[-1,-1,n.extent+1,n.extent+1],x=this.Vt=this.Vt||this.dt.getProxy(),F=this.Ht=this.Ht||this.dt.getProxy();for(let t=0;t<p.length;t++){const n=p[t],o=this.data.aPosition.getLength()/w;x.setLength(0),F.setLength(0);for(let t=0;t<n.length;t++){let o=n[t];if(this.options.EXTENT!==1/0&&0===this.maxPosZ&&(o=Ju(o,M)),0===o.length)continue;0!==t&&F.push(x.length/3),this.ensureDataCapacity(o.length);const a=this.data;for(let t=0;t<o.length;t++){const n=o[t].x,u=o[t].y,l=o[t].z||0;if(this.fillPosition(this.data,n,u,l),d){let t=a.aTexInfo.currentIndex;a.aTexInfo[t++]=m[0],a.aTexInfo[t++]=m[1],a.aTexInfo[t++]=g[0],a.aTexInfo[t++]=g[1],a.aTexInfo.currentIndex=t}if(void 0!==e){let t=a.aColor.currentIndex;a.aColor[t++]=e[0],a.aColor[t++]=e[1],a.aColor[t++]=e[2],a.aColor[t++]=e[3],a.aColor.currentIndex=t}if(void 0!==r){let t=a.aOpacity.currentIndex;a.aOpacity[t++]=r,a.aOpacity.currentIndex=t}if(void 0!==i){let t=a.aUVScale.currentIndex;a.aUVScale[t++]=i[0],a.aUVScale[t++]=i[1],a.aUVScale.currentIndex=t}if(void 0!==s){let t=a.aUVOffset.currentIndex;a.aUVOffset[t++]=s[0],a.aUVOffset[t++]=s[1],a.aUVOffset.currentIndex=t}if(c){let t=a.aTexCoord.currentIndex;if(v){const n=wr(v[2*b])?v[0]:v[2*b],e=wr(v[2*b]+1)?v[1]:v[2*b+1];a.aTexCoord[t++]=n,a.aTexCoord[t++]=e}else a.aTexCoord[t++]=Yu,a.aTexCoord[t++]=Yu;a.aTexCoord.currentIndex=t,b++}const h=Math.abs(n),f=Math.abs(u);h>this.maxPos&&(this.maxPos=h),f>this.maxPos&&(this.maxPos=f),x.push(n,u,l)}}let a=Ce(x,F,3);if(x.length&&!a.length){const t=[];for(let n=0;n<x.length;n+=3)t[n]=x[n],t[n+1]=x[n+2],t[n+2]=x[n+1];if(a=Ce(t,F,3),!a.length){for(let n=0;n<x.length;n+=3)t[n]=x[n+1],t[n+1]=x[n+2],t[n+2]=x[n];a=Ce(t,F,3)}}for(let t=0;t<a.length;t+=3)this.addElements(o+a[t],o+a[t+1],o+a[t+2])}}ensureDataCapacity(t){super.ensureDataCapacity(1,t)}}const Zu=[{type:Int16Array,width:3,name:"aPosition"}];class Qu extends Pa{getFormat(){return Zu}placeVector(t,n){const e=this.Ot(t,n);if(0===e.length)return;const r=this.data,i=this.getAltitude(t.feature.properties);let s=r.aPosition.getLength()/Zu[0].width;for(let t=0;t<e.length;t++){const n=e[t];r.aPosition.push(2*n.x+0,2*n.y+0,i),r.aPosition.push(2*n.x+1,2*n.y+0,i),r.aPosition.push(2*n.x+1,2*n.y+1,i),r.aPosition.push(2*n.x+0,2*n.y+1,i),this.addElements(s,s+1,s+2),this.addElements(s,s+2,s+3),s+=4;const o=Math.max(Math.abs(2*n.x+1),Math.abs(2*n.y+1));o>this.maxPos&&(this.maxPos=o)}}Ot(t,n){const{feature:e,symbol:r}=t,i=this.$t(t,r),s=e.properties,{markerSpacingFn:o}=this.st,a=((o?o(null,s):r.markerSpacing)||250)*n;return vu(t,null,null,n,this.options.EXTENT,i,a)}$t(t,n){return this.st.markerPlacementFn?this.st.markerPlacementFn(this.options.zoom,t.feature.properties):n.markerPlacement}}class tl extends Iu{constructor(t,n,e){(n=br({},n)).lineJoin="miter",n.lineCap="butt",super(t,n,e),this.options.radialSegments%2==1&&this.options.radialSegments--}getFormat(){const{lineWidthFn:t,lineColorFn:n,lineOpacityFn:e,linePatternAnimSpeedFn:r,linePatternGapFn:i}=this.st,s=[...this.getPositionFormat(),{type:Int8Array,width:4,name:"aTubeNormal"},{type:this.options.positionType||Uint16Array,width:1,name:"aLinesofar"}];if(this.iconAtlas){s.push({type:Int8Array,width:1,name:"aNormalDistance"});const t=this.getIconAtlasMaxValue();s.push({type:t>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return t&&s.push({type:Uint16Array,width:1,name:"aLineWidth"}),n&&s.push({type:Uint8Array,width:4,name:"aColor"}),e&&s.push({type:Uint8Array,width:1,name:"aOpacity"}),r&&s.push({type:Int8Array,width:1,name:"aLinePatternAnimSpeed"}),i&&s.push({type:Int8Array,width:1,name:"aLinePatternGap"}),s}ensureDataCapacity(t,n,e,r){return super.ensureDataCapacity(t,n,e,r*(this.options.radialSegments/2))}addHalfVertex(t,n,e,r,i,s,o,a){const{x:u,y:l,z:h}=t,c=1*this.scaledDistance,f=this.options.radialSegments/2,{x:d,y:p,z:y}=o.dir,m=function(t,n,e,r,i,s,o,a){Ie(nl,e,r,i),Ie(el,s,o,0),Te(rl,nl,el),$e(el,el),$e(rl,rl),il[n]||(il[n]=[]);const u=il[n];for(var l=0;l<n;l++){const t=Math.PI*l/n,e=1-Math.abs(t-0)/(Math.PI/2);u[l]=u[l]||[],sl(el,rl,u[l],1,t,e*(a?-1:1))}return u}(0,f,d,p,y,n,e,i);this.prevVertex&&this.fillTubeElements(i),this.fillData(this.data,u,l,h||0,m,i,c,a)}fillTubeElements(t){const n=this.options.radialSegments/2,e=this.needAltitudeAttribute()?2:3,r=this.data.aPosition.getLength()/e;for(let e=0;e<n;e++){const i=e+r-2*n;let s,o;e===n-1&&t?(s=e+r-2*n+1,o=e+r-2*n-2*n+1):(s=e+r+1,o=e+r+1-2*n),super.addElements(e+r-this.offset,s-this.offset,i-this.offset),super.addElements(i-this.offset,s-this.offset,o-this.offset)}}fillData(t,n,e,r,i,s,o,a){const{lineWidthFn:u,lineColorFn:l,lineOpacityFn:h,linePatternAnimSpeedFn:c,linePatternGapFn:f}=this.st,d=i.length;for(let s=0;s<d;s++){this.fillPosition(t,n,e,r),Ue(i[s],i[s],Pu);let d=t.aTubeNormal.currentIndex;for(let n=0;n<i[s].length;n++)t.aTubeNormal[d++]=i[s][n];if(t.aTubeNormal.currentIndex=d,d=t.aLinesofar.currentIndex,t.aLinesofar[d++]=o,t.aLinesofar.currentIndex=d,this.iconAtlas&&(d=t.aNormalDistance.currentIndex,t.aNormalDistance[d++]=Pu*a,t.aNormalDistance.currentIndex=d,d=t.aTexInfo.currentIndex,t.aTexInfo[d++]=this.feaTexInfo[0],t.aTexInfo[d++]=this.feaTexInfo[1],t.aTexInfo[d++]=this.feaTexInfo[2],t.aTexInfo[d++]=this.feaTexInfo[3],t.aTexInfo.currentIndex=d),u){const n=Cr(this.options.metric);let e=this.feaLineWidth*n;isNaN(e)&&(e=0),d=t.aLineWidth.currentIndex,t.aLineWidth[d++]=Math.round(e),t.aLineWidth.currentIndex=d}l&&(d=t.aColor.currentIndex,t.aColor[d++]=this.feaColor[0],t.aColor[d++]=this.feaColor[1],t.aColor[d++]=this.feaColor[2],t.aColor[d++]=this.feaColor[3],t.aColor.currentIndex=d),h&&(d=t.aOpacity.currentIndex,t.aOpacity[d++]=this.feaOpacity,t.aOpacity.currentIndex=d),c&&(d=t.aLinePatternAnimSpeed.currentIndex,t.aLinePatternAnimSpeed[d++]=127*(this.feaPatternAnimSpeed||0),t.aLinePatternAnimSpeed.currentIndex=d),f&&(d=t.aLinePatternGap.currentIndex,t.aLinePatternGap[d++]=10*(this.feaLinePatternGap||0),t.aLinePatternGap.currentIndex=d)}this.maxPos=Math.max(this.maxPos,Math.abs(n)+1,Math.abs(e)+1)}createDataPack(t,n){const e=super.createDataPack(t,n);return e&&(e.is2D=!1),e}}const nl=[],el=[],rl=[],il={};function sl(t,n,e,r,i,s){return ze(e,r*(Math.cos(i)*t[0]+Math.sin(i)*n[0]),r*(Math.cos(i)*t[1]+Math.sin(i)*n[1]),r*(Math.cos(i)*t[2]+Math.sin(i)*n[2]),s),e}class ol extends tl{addHalfVertex(t,n,e,r,i,s,o,a){const{x:u,y:l,z:h}=t,c=1*this.scaledDistance,{x:f,y:d,z:p}=o.dir,y=function(t,n,e,r,i,s,o,a){Ie(ul,e,r,i),Ie(ll,s,o,0),Te(hl,ul,ll),$e(ll,ll),$e(hl,hl),Le(al,t,n);const u=Ve(al)/t,l=Math.atan(n/t);let h=Math.PI/2+(Math.PI/2-l);return cl[0]||(cl[0]=[]),sl(ll,hl,cl[0],u,h,a?1:-1),h+=2*l,cl[1]||(cl[1]=[]),sl(ll,hl,cl[1],u,h,a?1:-1),cl}(this.feaLineWidth,this.feaLineHeight,f,d,p,n,e,i);this.prevVertex&&this.fillTubeElements(i),this.fillData(this.data,u,l,h||0,y,i,c,a)}ensureDataCapacity(t,n,e,r){return super.ensureDataCapacity(t,n,e,2*r)}}const al=[],ul=[],ll=[],hl=[],cl=[];class fl{constructor(t){this.max=t,this.reset()}reset(){return this.data={},this.order=[],this}clear(){this.reset()}add(t,n){return this.has(t)?(this.order.splice(this.order.indexOf(t),1),this.data[t]=n,this.order.push(t)):(this.data[t]=n,this.order.push(t),this.order.length>this.max&&this.getAndRemove(this.order[0])),this}has(t){return t in this.data}keys(){return this.order}getAndRemove(t){if(!this.has(t))return null;const n=this.data[t];return delete this.data[t],this.order.splice(this.order.indexOf(t),1),n}get(t){return this.has(t)?this.data[t]:null}remove(t){return this.has(t)?(delete this.data[t],this.order.splice(this.order.indexOf(t),1),this):this}setMaxSize(t){for(this.max=t;this.order.length>this.max;)this.getAndRemove(this.order[0]);return this}}
/*!
     * based on @mapbox/tiny-sdf
     * https://github.com/mapbox/tiny-sdf
     * @License BSD 2-Clause
     */var dl=1e20;function pl(t,n,e,r,i,s,o){this.fontSize=t||24,this.buffer=void 0===n?3:n,this.cutoff=r||.25,this.fontFamily=i||"sans-serif",this.fontWeight=s||"normal",this.fontStyle=o||"normal",this.radius=e||8;var a=this.size=this.fontSize+2*this.buffer;this.canvas="undefined"==typeof document?new OffscreenCanvas(a,a):document.createElement("canvas"),this.canvas.width=this.canvas.height=a,this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),this.ctx.font=this.fontStyle+" "+this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textBaseline="middle",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(a*a),this.gridInner=new Float64Array(a*a),this.f=new Float64Array(a),this.z=new Float64Array(a+1),this.v=new Uint16Array(a),this.middle=Math.round(a/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}function yl(t,n,e,r,i,s){for(var o=0;o<n;o++)ml(t,o,n,e,r,i,s);for(var a=0;a<e;a++)ml(t,a*n,1,n,r,i,s)}function ml(t,n,e,r,i,s,o){var a,u,l,h;for(s[0]=0,o[0]=-dl,o[1]=dl,a=0;a<r;a++)i[a]=t[n+a*e];for(a=1,u=0,l=0;a<r;a++){do{l=(i[a]-i[h=s[u]]+a*a-h*h)/(a-h)/2}while(l<=o[u]&&--u>-1);s[++u]=a,o[u]=l,o[u+1]=dl}for(a=0,u=0;a<r;a++){for(;o[u+1]<a;)u++;t[n+a*e]=i[h=s[u]]+(a-h)*(a-h)}}pl.prototype.draw=function(t,n,e){this.ctx.clearRect(0,0,this.size,this.size),this.ctx.textBaseline="top",this.ctx.fillText(t,this.buffer,this.buffer);for(var r=this.ctx.getImageData(0,0,n,e),i=new Uint8ClampedArray(n*e),s=0;s<n*e;s++){var o=r.data[4*s+3]/255;this.gridOuter[s]=1===o?0:0===o?dl:Math.pow(Math.max(0,.5-o),2),this.gridInner[s]=1===o?dl:0===o?0:Math.pow(Math.max(0,o-.5),2)}for(yl(this.gridOuter,n,e,this.f,this.v,this.z),yl(this.gridInner,n,e,this.f,this.v,this.z),s=0;s<n*e;s++){var a=Math.sqrt(this.gridOuter[s])-Math.sqrt(this.gridInner[s]);i[s]=Math.round(255-255*(a/this.radius+this.cutoff))}return i};let gl=0;class vl{constructor(t,n=15,e,r){this.entries={},this.qt={},this.Gt=new fl(2048,(function(){})),this.Jt=t,this.Wt=n,this.Bt=e,this.Xt=r}Yt(t){return t&&t.indexOf("{stack}")>=0&&t.indexOf("{range}")>0}getGlyphs(t,n){if(!t||!Object.keys(t).length)return void n(null,{glyphs:null});if(this.Yt(this.Xt))return void this.Kt(t,n);const e=this.entries,r=t.options;let i=!0;r&&(i=!1!==r.isCharsCompact),i=i||this.Bt;const s=(r,s,a)=>{let u=0,l=0;for(const n in t)if("options"!==n){e[n]=e[n]||{},s[n]=s[n]||{};for(const h in t[n]){if(l++,l<=r)continue;const t=i&&!Na(+h),c=n+":"+h+":"+t;let f;if(this.Gt.has(c)?f=this.Gt.get(c):(f=this.Zt(e[n],n,h,t),this.Gt.add(c,f),u++),f=bl(f),s[n][h]=f,a.push(f.bitmap.data.buffer),this.Jt&&u>this.Wt)return void this.Jt(o(l,s,a))}}n(null,{glyphs:s,buffers:a})};function o(t,n,e){return()=>{s(t,n,e)}}s(0,{},[])}Kt(t,n){const e=[];for(const n in t)for(const r of t[n])e.push(this.Qt(n,r));Promise.all(e).then((t=>{n(null,t)}))}Qt(){return Promise.resolve(null)}Zt(t,n,e,r){const i=n;let s=t.tinySDF;const o=r?-1:2;if(!s){let n="400";/bolder/i.test(i)?n="1000":/bold/i.test(i)?n="900":/medium/i.test(i)?n="500":/light/i.test(i)&&(n="200"),s=t.tinySDF=new pl(24,2,8,.25,i,n)}const a=String.fromCodePoint(e),u=s.ctx.measureText(a),l=Math.round(u.width),h=s.draw(a,l+4,28);if(gl<4){const t="undefined"!=typeof document&&document.getElementById("sdf-debug-"+gl++);t&&(t.width=l+4,t.height=s.canvas.height,t.getContext("2d").drawImage(s.canvas,0,0))}return{charCode:e,bitmap:{width:l+4,height:28,data:h},metrics:{width:l,height:24,left:1,top:-2,advance:l+2+o}}}}function bl(t){const n={width:t.bitmap.width,height:t.bitmap.height,data:new Uint8ClampedArray(t.bitmap.data)};return{charCode:t.charCode,bitmap:n,metrics:br({},t.metrics)}}var wl=Object.freeze({__proto__:null,calculateSignedArea:nr,clipPolygon:Ju,convertGeometry:vr,convertRTLText:eu,generatePickingIndiceIndex:ur,getFeaAltitudeAndHeight:ir,getIndexArrayType:pr,getPosArrayType:yr,getUnsignedArrayType:mr,packPosition:jr,unpackPosition:function(t,n,e,r){const i=(Math.sign(n)||1)*(Math.abs(n)%Ur),s=(Math.sign(e)||1)*(Math.abs(e)%Ur),o=Math.floor(Math.abs(n)/Ur),a=Math.floor(Math.abs(e)/Ur);return t[0]=i,t[1]=s,t[2]=Math.sign(r+1e-5)*(2*o+a)*Nr+r,t}});var Ml={
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
read:function(t,n,e,r,i){var s,o,a=8*i-r-1,u=(1<<a)-1,l=u>>1,h=-7,c=e?i-1:0,f=e?-1:1,d=t[n+c];for(c+=f,s=d&(1<<-h)-1,d>>=-h,h+=a;h>0;s=256*s+t[n+c],c+=f,h-=8);for(o=s&(1<<-h)-1,s>>=-h,h+=r;h>0;o=256*o+t[n+c],c+=f,h-=8);if(0===s)s=1-l;else{if(s===u)return o?NaN:1/0*(d?-1:1);o+=Math.pow(2,r),s-=l}return(d?-1:1)*o*Math.pow(2,s-r)},write:function(t,n,e,r,i,s){var o,a,u,l=8*s-i-1,h=(1<<l)-1,c=h>>1,f=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,d=r?0:s-1,p=r?1:-1,y=n<0||0===n&&1/n<0?1:0;for(n=Math.abs(n),isNaN(n)||n===1/0?(a=isNaN(n)?1:0,o=h):(o=Math.floor(Math.log(n)/Math.LN2),n*(u=Math.pow(2,-o))<1&&(o--,u*=2),(n+=o+c>=1?f/u:f*Math.pow(2,1-c))*u>=2&&(o++,u/=2),o+c>=h?(a=0,o=h):o+c>=1?(a=(n*u-1)*Math.pow(2,i),o+=c):(a=n*Math.pow(2,c-1)*Math.pow(2,i),o=0));i>=8;t[e+d]=255&a,d+=p,a/=256,i-=8);for(o=o<<i|a,l+=i;l>0;t[e+d]=255&o,d+=p,o/=256,l-=8);t[e+d-p]|=128*y}},xl=kl,Fl=Ml;function kl(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}kl.Varint=0,kl.Fixed64=1,kl.Bytes=2,kl.Fixed32=5;var Al=4294967296,Pl=1/Al,Sl="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function _l(t){return t.type===kl.Bytes?t.readVarint()+t.pos:t.pos+1}function Ol(t,n,e){return e?4294967296*n+(t>>>0):4294967296*(n>>>0)+(t>>>0)}function Cl(t,n,e){var r=n<=16383?1:n<=2097151?2:n<=268435455?3:Math.floor(Math.log(n)/(7*Math.LN2));e.realloc(r);for(var i=e.pos-1;i>=t;i--)e.buf[i+r]=e.buf[i]}function El(t,n){for(var e=0;e<t.length;e++)n.writeVarint(t[e])}function Il(t,n){for(var e=0;e<t.length;e++)n.writeSVarint(t[e])}function $l(t,n){for(var e=0;e<t.length;e++)n.writeFloat(t[e])}function Tl(t,n){for(var e=0;e<t.length;e++)n.writeDouble(t[e])}function Dl(t,n){for(var e=0;e<t.length;e++)n.writeBoolean(t[e])}function zl(t,n){for(var e=0;e<t.length;e++)n.writeFixed32(t[e])}function jl(t,n){for(var e=0;e<t.length;e++)n.writeSFixed32(t[e])}function Ul(t,n){for(var e=0;e<t.length;e++)n.writeFixed64(t[e])}function Nl(t,n){for(var e=0;e<t.length;e++)n.writeSFixed64(t[e])}function Ll(t,n){return(t[n]|t[n+1]<<8|t[n+2]<<16)+16777216*t[n+3]}function Rl(t,n,e){t[e]=n,t[e+1]=n>>>8,t[e+2]=n>>>16,t[e+3]=n>>>24}function Vl(t,n){return(t[n]|t[n+1]<<8|t[n+2]<<16)+(t[n+3]<<24)}kl.prototype={destroy:function(){this.buf=null},readFields:function(t,n,e){for(e=e||this.length;this.pos<e;){var r=this.readVarint(),i=r>>3,s=this.pos;this.type=7&r,t(i,n,this),this.pos===s&&this.skip(r)}return n},readMessage:function(t,n){return this.readFields(t,n,this.readVarint()+this.pos)},readFixed32:function(){var t=Ll(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=Vl(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=Ll(this.buf,this.pos)+Ll(this.buf,this.pos+4)*Al;return this.pos+=8,t},readSFixed64:function(){var t=Ll(this.buf,this.pos)+Vl(this.buf,this.pos+4)*Al;return this.pos+=8,t},readFloat:function(){var t=Fl.read(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=Fl.read(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var n,e,r=this.buf;return n=127&(e=r[this.pos++]),e<128?n:(n|=(127&(e=r[this.pos++]))<<7,e<128?n:(n|=(127&(e=r[this.pos++]))<<14,e<128?n:(n|=(127&(e=r[this.pos++]))<<21,e<128?n:function(t,n,e){var r,i,s=e.buf;if(r=(112&(i=s[e.pos++]))>>4,i<128)return Ol(t,r,n);if(r|=(127&(i=s[e.pos++]))<<3,i<128)return Ol(t,r,n);if(r|=(127&(i=s[e.pos++]))<<10,i<128)return Ol(t,r,n);if(r|=(127&(i=s[e.pos++]))<<17,i<128)return Ol(t,r,n);if(r|=(127&(i=s[e.pos++]))<<24,i<128)return Ol(t,r,n);if(r|=(1&(i=s[e.pos++]))<<31,i<128)return Ol(t,r,n);throw new Error("Expected varint not more than 10 bytes")}(n|=(15&(e=r[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var t=this.readVarint()+this.pos,n=this.pos;return this.pos=t,t-n>=12&&Sl?function(t,n,e){return Sl.decode(t.subarray(n,e))}(this.buf,n,t):function(t,n,e){for(var r="",i=n;i<e;){var s,o,a,u=t[i],l=null,h=u>239?4:u>223?3:u>191?2:1;if(i+h>e)break;1===h?u<128&&(l=u):2===h?128==(192&(s=t[i+1]))&&(l=(31&u)<<6|63&s)<=127&&(l=null):3===h?(o=t[i+2],128==(192&(s=t[i+1]))&&128==(192&o)&&((l=(15&u)<<12|(63&s)<<6|63&o)<=2047||l>=55296&&l<=57343)&&(l=null)):4===h&&(o=t[i+2],a=t[i+3],128==(192&(s=t[i+1]))&&128==(192&o)&&128==(192&a)&&((l=(15&u)<<18|(63&s)<<12|(63&o)<<6|63&a)<=65535||l>=1114112)&&(l=null)),null===l?(l=65533,h=1):l>65535&&(l-=65536,r+=String.fromCharCode(l>>>10&1023|55296),l=56320|1023&l),r+=String.fromCharCode(l),i+=h}return r}(this.buf,n,t)},readBytes:function(){var t=this.readVarint()+this.pos,n=this.buf.subarray(this.pos,t);return this.pos=t,n},readPackedVarint:function(t,n){if(this.type!==kl.Bytes)return t.push(this.readVarint(n));var e=_l(this);for(t=t||[];this.pos<e;)t.push(this.readVarint(n));return t},readPackedSVarint:function(t){if(this.type!==kl.Bytes)return t.push(this.readSVarint());var n=_l(this);for(t=t||[];this.pos<n;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==kl.Bytes)return t.push(this.readBoolean());var n=_l(this);for(t=t||[];this.pos<n;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==kl.Bytes)return t.push(this.readFloat());var n=_l(this);for(t=t||[];this.pos<n;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==kl.Bytes)return t.push(this.readDouble());var n=_l(this);for(t=t||[];this.pos<n;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==kl.Bytes)return t.push(this.readFixed32());var n=_l(this);for(t=t||[];this.pos<n;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==kl.Bytes)return t.push(this.readSFixed32());var n=_l(this);for(t=t||[];this.pos<n;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==kl.Bytes)return t.push(this.readFixed64());var n=_l(this);for(t=t||[];this.pos<n;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==kl.Bytes)return t.push(this.readSFixed64());var n=_l(this);for(t=t||[];this.pos<n;)t.push(this.readSFixed64());return t},skip:function(t){var n=7&t;if(n===kl.Varint)for(;this.buf[this.pos++]>127;);else if(n===kl.Bytes)this.pos=this.readVarint()+this.pos;else if(n===kl.Fixed32)this.pos+=4;else{if(n!==kl.Fixed64)throw new Error("Unimplemented type: "+n);this.pos+=8}},writeTag:function(t,n){this.writeVarint(t<<3|n)},realloc:function(t){for(var n=this.length||16;n<this.pos+t;)n*=2;if(n!==this.length){var e=new Uint8Array(n);e.set(this.buf),this.buf=e,this.length=n}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),Rl(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),Rl(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),Rl(this.buf,-1&t,this.pos),Rl(this.buf,Math.floor(t*Pl),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),Rl(this.buf,-1&t,this.pos),Rl(this.buf,Math.floor(t*Pl),this.pos+4),this.pos+=8},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(t,n){var e,r;if(t>=0?(e=t%4294967296|0,r=t/4294967296|0):(r=~(-t/4294967296),4294967295^(e=~(-t%4294967296))?e=e+1|0:(e=0,r=r+1|0)),t>=0x10000000000000000||t<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");n.realloc(10),function(t,n,e){e.buf[e.pos++]=127&t|128,t>>>=7,e.buf[e.pos++]=127&t|128,t>>>=7,e.buf[e.pos++]=127&t|128,t>>>=7,e.buf[e.pos++]=127&t|128,t>>>=7,e.buf[e.pos]=127&t}(e,0,n),function(t,n){var e=(7&t)<<4;n.buf[n.pos++]|=e|((t>>>=3)?128:0),t&&(n.buf[n.pos++]=127&t|((t>>>=7)?128:0),t&&(n.buf[n.pos++]=127&t|((t>>>=7)?128:0),t&&(n.buf[n.pos++]=127&t|((t>>>=7)?128:0),t&&(n.buf[n.pos++]=127&t|((t>>>=7)?128:0),t&&(n.buf[n.pos++]=127&t)))))}(r,n)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t)},writeBoolean:function(t){this.writeVarint(Boolean(t))},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var n=this.pos;this.pos=function(t,n,e){for(var r,i,s=0;s<n.length;s++){if((r=n.charCodeAt(s))>55295&&r<57344){if(!i){r>56319||s+1===n.length?(t[e++]=239,t[e++]=191,t[e++]=189):i=r;continue}if(r<56320){t[e++]=239,t[e++]=191,t[e++]=189,i=r;continue}r=i-55296<<10|r-56320|65536,i=null}else i&&(t[e++]=239,t[e++]=191,t[e++]=189,i=null);r<128?t[e++]=r:(r<2048?t[e++]=r>>6|192:(r<65536?t[e++]=r>>12|224:(t[e++]=r>>18|240,t[e++]=r>>12&63|128),t[e++]=r>>6&63|128),t[e++]=63&r|128)}return e}(this.buf,t,this.pos);var e=this.pos-n;e>=128&&Cl(n,e,this),this.pos=n-1,this.writeVarint(e),this.pos+=e},writeFloat:function(t){this.realloc(4),Fl.write(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),Fl.write(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var n=t.length;this.writeVarint(n),this.realloc(n);for(var e=0;e<n;e++)this.buf[this.pos++]=t[e]},writeRawMessage:function(t,n){this.pos++;var e=this.pos;t(n,this);var r=this.pos-e;r>=128&&Cl(e,r,this),this.pos=e-1,this.writeVarint(r),this.pos+=r},writeMessage:function(t,n,e){this.writeTag(t,kl.Bytes),this.writeRawMessage(n,e)},writePackedVarint:function(t,n){n.length&&this.writeMessage(t,El,n)},writePackedSVarint:function(t,n){n.length&&this.writeMessage(t,Il,n)},writePackedBoolean:function(t,n){n.length&&this.writeMessage(t,Dl,n)},writePackedFloat:function(t,n){n.length&&this.writeMessage(t,$l,n)},writePackedDouble:function(t,n){n.length&&this.writeMessage(t,Tl,n)},writePackedFixed32:function(t,n){n.length&&this.writeMessage(t,zl,n)},writePackedSFixed32:function(t,n){n.length&&this.writeMessage(t,jl,n)},writePackedFixed64:function(t,n){n.length&&this.writeMessage(t,Ul,n)},writePackedSFixed64:function(t,n){n.length&&this.writeMessage(t,Nl,n)},writeBytesField:function(t,n){this.writeTag(t,kl.Bytes),this.writeBytes(n)},writeFixed32Field:function(t,n){this.writeTag(t,kl.Fixed32),this.writeFixed32(n)},writeSFixed32Field:function(t,n){this.writeTag(t,kl.Fixed32),this.writeSFixed32(n)},writeFixed64Field:function(t,n){this.writeTag(t,kl.Fixed64),this.writeFixed64(n)},writeSFixed64Field:function(t,n){this.writeTag(t,kl.Fixed64),this.writeSFixed64(n)},writeVarintField:function(t,n){this.writeTag(t,kl.Varint),this.writeVarint(n)},writeSVarintField:function(t,n){this.writeTag(t,kl.Varint),this.writeSVarint(n)},writeStringField:function(t,n){this.writeTag(t,kl.Bytes),this.writeString(n)},writeFloatField:function(t,n){this.writeTag(t,kl.Fixed32),this.writeFloat(n)},writeDoubleField:function(t,n){this.writeTag(t,kl.Fixed64),this.writeDouble(n)},writeBooleanField:function(t,n){this.writeVarintField(t,Boolean(n))}};var Hl=function(t){return t&&t.M&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}(xl);const ql={polygonPatternFile:1,markerFile:1,markerPlacement:1,markerSpacing:1,textName:1,textFaceName:1,textPlacement:1,textSpacing:1,lineJoin:1,lineCap:1,linePatternFile:1};Object.assign({visible:1,textHorizontalAlignment:1,textVerticalAlignment:1,textWrapWidth:1,markerHorizontalAlignment:1,markerVerticalAlignment:1},ql),Object.assign({lineDasharray:1,topPolygonFill:1,bottomPolygonFill:1},ql);const Gl=Math.PI/180,Jl=6378137*Math.PI/180,Wl=85.0511287798;function Bl(t,n,e){if("EPSG:3857"===e)return function(t,n){const e=Wl,r=n[0],i=Math.max(Math.min(e,n[1]),-e);let s;s=0===i?0:Math.log(Math.tan((90+i)*Gl/2))/Gl;return t[0]=r*Jl,t[1]=s*Jl,t}(t,n);if("EPSG:4326"===e||"EPSG:4490"===e||"identity"===e)return Xl(t,n);if("baidu"===e)return Xl(t,n);throw new Error("unsupported projection:"+e)}function Xl(t,n){return t[0]=n[0],t[1]=n[1],t}function Yl(t,n,e,r,i,s,o,a,u,l,h,c,f,d,p){0===t?function(t,n,e,r,i,s,o,a,u,l){const h=1/(100*s[0]),c=1/(100*s[1]),f=l&&l[0]||0,d=l&&l[1]||0,p=[0,0];for(let i=t;i<n;i+=3){const t=i/3*2,n=r[i]-f,s=r[i+1]-d;e[t]=p[0]+n/o*h/a,e[t+1]=p[1]-s/o*c/u}}(n,e,r,i,0,o,a,u,l,p):1===t&&function(t,n,e,r,i,s,o,a,u,l,h){if(!t)return;let c,f,d,p;0===t[4]?(c=t[0],f=t[1],d=t[2],p=t[3]):(c=t[1],f=t[2],d=t[3],p=t[0]);const y=Re(c,f),m=Re(f,d),g=[],v=[],b=[];for(let t=n;t<e;t+=3){const n=t/3*2;Le(g,(s.x/u+i[t]/o)*a,s.y/u*a+(h?i[t+1]:-i[t+1])/o*a),"EPSG:4326"!==l&&"EPSG:4490"!==l||Bl(g,g,"EPSG:3857"),Kl(v,g,c,f),Kl(b,g,p,c),r[n]=Re(c,v)/y,r[n+1]=Re(c,b)/m}}(h,n,e,r,i,s,a,c,f,d,!!p)}function Kl(t,n,e,r){const i=e[0]-r[0],s=e[1]-r[1];let o=(n[0]-e[0])*(e[0]-r[0])+(n[1]-e[1])*(e[1]-r[1]);return o/=i*i+s*s,t[0]=e[0]+o*i,t[1]=e[1]+o*s,t}function Zl(t,n,e,r,i){const s=3*n[e-1],o=3*n[e-1]+1,a=t[s],u=t[o];return l=r,h=i,c=a,f=u,Math.sqrt((c-l)*(c-l)+(f-h)*(f-h));var l,h,c,f}const Ql="__fea_idx";new Float32Array([-1e12])[0];const th="maptalks_ombb";function nh(t,n,e,r,i,s,o,a,u,l,h,c,f,d,p,y,m){const g=n.getLength(),v=i/3;for(let e=2,r=g;e<r;e+=3)t[i+e-2]=n[e-2],t[i+e-1]=n[e-1],t[i+e-0]=n[e]-o;i+=g;for(let e=2,r=g;e<r;e+=3)t[i+e-2]=n[e-2],t[i+e-1]=n[e-1],t[i+e-0]=n[e]-a;i+=g,t.trySetLength(i+g),t.copyWithin(i,i-2*g,i-g),i+=g,t.trySetLength(i+g),t.copyWithin(i,i-2*g,i-g),i+=g,(e=e||[]).push(g/3);const b=e.getLength();for(let n=0;n<b;n++){eh(v+(e[n-1]||0),v+e[n],t,g/3,u,r,l,h,c,f,s,d,p,y,m)}return i}function eh(t,n,e,r,i,s,o,a,u,l,h,c,f,d,p){const y=s.getLength();let m,g;for(let o=t,a=n;o<a-1;o++)if(m=o,g=o+1,i===1/0||!lt(e,m,g,i))if((o-t)%2==1&&(m+=2*r,g+=2*r),p){let t=s.currentIndex;s[t++]=m+r,s[t++]=g,s[t++]=m,s[t++]=g+r,s[t++]=g,s[t++]=m+r,s.currentIndex=t}else{let t=s.currentIndex;s[t++]=m+r,s[t++]=m,s[t++]=g,s[t++]=g,s[t++]=g+r,s[t++]=m+r,s.currentIndex=t}o&&function(t,n,e,r,i,s,o,a,u,l,h,c){let f,d=0,p=0,y=0,m=0;const g=c?[1,3,4]:[2,3,4];for(let c=s.getLength()-1;c>=o;c--){const o=s[c],v=3*o+1,b=3*o+2,w=i[3*o],M=i[v],x=i[b];d||p||(d=Math.max(i[b],i[3*s[c-3]+2]),p=Math.min(i[b],i[3*s[c-3]+2]),f=d-p);let F=y;const k=c%6;0===t?(5===k&&(m=Zl(i,s,c,w,M)),F=k===g[0]||k===g[1]||k===g[2]?y:y+m):1===t&&(k===g[0]||k===g[1]||k===g[2]?F=0:5===k?(m=Zl(i,s,c,w,M),F=m):F=m);const A=F/l*(1/(100*h))/a;let P;P=1===n?x===d?1:0:"bottom"===e?x===d?f/100/u:0:x===d?0:-f/100/u,r[2*o]=A,r[2*o+1]=P,0===k&&(y+=m)}}(a,u,l,h,e,s,y,c[0],c[1],f,d,p)}function rh(t){const n=[t[0]];let e=t[0];for(let r=1;r<t.length;r++)Array.isArray(t[r])?t[r][0]===e[0]&&t[r][1]===e[1]&&t[r][2]===e[2]||n.push(t[r]):t[r].x===e.x&&t[r].y===e.y&&t[r].z===e.z||n.push(t[r]),e=t[r];return n}const ih=ga.getInstance();function sh(t,n,e,r,i,s,o,a,u,l,h,c,f,d,p,v){void 0===n.top&&(n.top=!0),void 0===n.side&&(n.side=!0),ih.reset();const{altitudeScale:b,altitudeProperty:w,defaultAltitude:M,heightProperty:x,minHeightProperty:F,defaultHeight:A,tangent:P,uv:S,topUVMode:O,sideUVMode:C,sideVerticalUVMode:E,top:I,side:$,textureYOrigin:T,topThickness:D}=n,z=function(t,n,{altitudeScale:e,altitudeProperty:r,defaultAltitude:i,heightProperty:s,minHeightProperty:o,defaultHeight:a},{center:u,side:l,top:h,topThickness:c,uvOrigin:f,uv:d,uvSize:p,topUVMode:y,sideUVMode:m,sideVerticalUVMode:g,textureYOrigin:v,tileRatio:b,centimeterToPoint:w,verticalCentimeterToPoint:M,positionType:x,res:F,glScale:A,projectionCode:P},S,_){let O=n/t[0].extent;n===1/0&&(O=1);const C=n===1/0,E=_.get(),I=_.get(),$=_.get(),T=_.getProxy(),D=_.get(),z=_.get(),j=_.get(),U=!!d,N=!!h,L=!!l,R=U?_.get():null;function V(t,e,r,i,s,o){let a=e;if(N){const i=Ce(T,r,3);if(0===i.length)return e;let l=T.getLength(),h=D.currentIndex;for(let t=0;t<l;t++)D[h++]=T[t];if(D.currentIndex=h,e+=T.getLength(),o)for(let n=2,e=i.length;n<e;n+=3)i[n]+=t/3,i[n-1]+=t/3,i[n-2]+=t/3;else{let n;for(let e=2,r=i.length;e<r;e+=3)n=i[e-1],i[e-1]=i[e]+t/3,i[e]=n+t/3,i[e-2]+=t/3}l=i.length,h=z.currentIndex;for(let t=0;t<l;t++)z[h++]=i[t];z.currentIndex=h,U&&Yl(y||0,t,e,R,D,f,w,b,p[0],p[1],s,F,A,P,u),c>0&&!L&&(e=nh(D,T,r,z,e,R,0,c,n,U,m||0,g||0,v,p,b,M,o)),j.setLength(e/3),j.fill(1,a/3,e/3)}if(L){N&&(c=0),a=e,e=nh(D,T,r,z,e,R,c,i,n,U,m||0,g||0,v,p,b,M,o),j.setLength(e/3);const t=T.getLength()/3;j.fill(1,a/3,a/3+t),j.fill(0,a/3+t,a/3+2*t),j.fill(1,a/3+2*t,a/3+3*t),j.fill(0,a/3+3*t,e/3)}return e}let H=0,q=0;const G=[-1,-1,n+1,n+1];let J=0,W=t.length;k(S)&&(J=S,W=S+1);let B=0,X=!1;const Y=_.getProxy();for(;J<W;J++){const u=t[J],l=u.id;k(l)&&(Math.abs(l)>B&&(B=Math.abs(l)),l<0&&(X=!0));const h=u.geometry,c=u.properties[th];let f=Array.isArray(c&&c[0]&&c[0][0])?c[0]:c;const{altitude:d,height:p}=wl.getFeaAltitudeAndHeight(u,e,r,i,s,a,o);H=Math.max(Math.abs(d),H);const y=D.getLength();let m=0,g=q;Y.setLength(0),T.setLength(0);const v=wl.calculateSignedArea(h[0])<0;for(let t=0,e=h.length;t<e;t++){let r=h[t];v&&(r=r.reverse()),r=rh(r);const i=wl.calculateSignedArea(r)<0;if(!i&&t>0&&(m++,f=c&&c[m],q=V(g,q,Y,p*O,f,C),T.setLength(0),Y.setLength(0),g=q),n!==1/0&&(r=wl.clipPolygon(r,G)),!r.length){t===e-1&&(q=V(g,q,Y,p*O,f,C));continue}const s=r.length;if(Array.isArray(r[0])?r[0][0]===r[s-1][0]&&r[0][1]===r[s-1][1]||r.push([r[0][0],r[0][1]]):r[0].x===r[s-1].x&&r[0].y===r[s-1].y||r.push(r[0]),i){let t=Y.currentIndex;Y[t++]=T.getLength()/3,Y.currentIndex=t}ut(T,T.getLength(),r,O,d,!1,x),t===e-1&&(q=V(g,q,Y,p*O,f,C))}const b=D.getLength()-y,w=(Ql+"").trim();for(let t=0;t<b/3;t++){let t=I.currentIndex;I[t++]=void 0===u[w]?J:u[w],I.currentIndex=t,t=E.currentIndex,E[t++]=J,E.currentIndex=t,k(l)&&(t=$.currentIndex,$[t++]=l,$.currentIndex=t)}}const K=wl.getUnsignedArrayType(I.getLength()?I[I.getLength()-1]:0),Z={maxAltitude:H,vertices:D,verticeTypes:j,indices:z,pickingIds:ga.createTypedArray(I,K),featureIndexes:E};if($.getLength()){const t=X?wl.getPosArrayType(B):wl.getUnsignedArrayType(B);Z.featureIds=ga.createTypedArray($,t)}else Z.featureIds=[];return R&&(R.setLength(D.getLength()/3*2),Z.uvs=R),Z}(t,e,{altitudeScale:b,altitudeProperty:w,defaultAltitude:M||0,heightProperty:x,minHeightProperty:F,defaultHeight:A||0},{center:v,top:I,side:$,topThickness:10*D||0,uv:S||P,uvSize:[i,i],uvOrigin:r,topUVMode:O,sideUVMode:C,sideVerticalUVMode:E,textureYOrigin:T,tileRatio:a,centimeterToPoint:u,verticalCentimeterToPoint:l,positionType:p,res:s,glScale:o,projectionCode:f},d,ih),j=[],U=z.vertices.getLength()/3,N=wl.getIndexArrayType(U),L=ga.createTypedArray(z.indices,N);delete z.indices,j.push(L.buffer,z.pickingIds.buffer);const R=wl.getPosArrayType(Math.max(512,z.maxAltitude));z.vertices=ga.createTypedArray(z.vertices,R);const V=P?ih.getProxy():new Float32Array(3*U);V.setLength&&V.setLength(3*U);const H=Jn(z.vertices,L,V);let q=!0;const G=H.getLength?H.getLength():H.length;for(let t=0;t<G;t++){H[t]=-H[t];const n=H[t]%1;1-Math.abs(n)>1e-6?q=!1:0!==n&&(H[t]=Math.round(H[t]))}if(z.normals=H,P){let t=ih.get();t.setLength(4*U),t=function(t,n,e,r,i){const s=(t.getLength?t.getLength():t.length)/3,o=i||new Array(4*s),a=[],u=[];for(let t=0;t<s;t++)a[t]=[0,0,0],u[t]=[0,0,0];const l=[0,0,0],h=[0,0,0],c=[0,0,0],f=[0,0],d=[0,0],p=[0,0],y=[0,0,0],m=[0,0,0];function g(n,r,i){ne(l,t,3*n),ne(h,t,3*r),ne(c,t,3*i),ee(f,e,2*n),ee(d,e,2*r),ee(p,e,2*i);const s=h[0]-l[0],o=c[0]-l[0],g=h[1]-l[1],v=c[1]-l[1],b=h[2]-l[2],w=c[2]-l[2],M=d[0]-f[0],x=p[0]-f[0],F=d[1]-f[1],k=p[1]-f[1],A=1/(M*k-x*F);_n(y,(k*s-F*o)*A,(k*g-F*v)*A,(k*b-F*w)*A),_n(m,(M*o-x*s)*A,(M*v-x*g)*A,(M*w-x*b)*A),On(a[n],a[n],y),On(a[r],a[r],y),On(a[i],a[i],y),On(u[n],u[n],m),On(u[r],u[r],m),On(u[i],u[i],m)}for(let t=0,n=r.length;t<n;t+=3)g(r[t+0],r[t+1],r[t+2]);const v=[],b=[],w=[],M=[];let x,F,k;function A(t){ne(w,n,3*t),Sn(M,w),F=a[t],Sn(v,F),$n(v,v,function(t,n,e){return t[0]=n[0]*e,t[1]=n[1]*e,t[2]=n[2]*e,t}(w,w,En(w,F))),Cn(v,v),In(b,M,F),k=En(b,u[t]),x=k<0?-1:1,o[4*t]=v[0],o[4*t+1]=v[1],o[4*t+2]=v[2],o[4*t+3]=x}for(let t=0,n=r.length;t<n;t+=3)A(r[t+0]),A(r[t+1]),A(r[t+2]);return o}(z.vertices,z.normals,z.uvs,L,t),t=function(t,n){const e=n.getLength(),r=new Float32Array(e),i=[],s=[],o=[];for(let a=0;a<e;a+=4){const e=a/4*3;Ie(s,t[e]||0,t[e+1]||0,t[e+2]||0),ze(i,n[a]||0,n[a+1]||0,n[a+2]||0,n[a+3]||0),qn(o,s,i),De(r.subarray(a,a+4),o)}return r}(z.normals,t),z.tangents=t,j.push(t.buffer),delete z.normals}if(z.normals&&(q&&(z.normals=ga.createTypedArray(z.normals,Int8Array)),j.push(z.normals.buffer)),z.uvs){const t=z.uvs;z.uvs=ga.createTypedArray(t,Float32Array),j.push(z.uvs.buffer)}const J=function(t,n,e,r){const i={},s={},o=r.getLength();if(_(n.polygonFill)){let a=g(n.polygonFill);const u=new Uint8Array(4*o);u.fill(255);for(let n=0;n<o;n++){const s=t[r[n]],o=s.properties||{};o.$layer=s.layer,o.$type=s.type;let l=a(e,o);y(l)&&(i.aColor=1,a=g(l),l=a(e,o)),delete o.$layer,delete o.$type,Dr.normalizeColor(oh,l),u[4*n]=oh[0],u[4*n+1]=oh[1],u[4*n+2]=oh[2],u[4*n+3]=oh[3]}s.aColor=u}if(_(n.polygonOpacity)){let a=m(n.polygonOpacity);const u=new Uint8Array(o);u.fill(255);for(let n=0;n<o;n++){const s=t[r[n]],o=s.properties||{};o.$layer=s.layer,o.$type=s.type;let l=a(e,o);y(l)&&(i.aOpacity=1,a=g(l),l=a(e,o)),delete o.$layer,delete o.$type,u[n]=255*l}s.aOpacity=u}return s.dynamicAttributes=i,s}(t,h,c,z.featureIndexes),W=function(t,n,e,r,i){const s=[[],[]],o=_(r.topPolygonFill),a=_(r.bottomPolygonFill),u=[255,255,255,255],l=n.getLength();if(o||a){let h=o&&g(r.topPolygonFill),c=a&&g(r.bottomPolygonFill),f=null,d=null,p=null,m=null;for(let r=0;r<l;r++){if(1===t[r]&&!o||0===t[r]&&!a)continue;const l=1===t[r];if(l&&n[r]===f){t[r]=p;continue}if(!l&&n[r]===d){t[r]=m;continue}const v=e[n[r]],b=v.properties||{};b.$layer=v.layer,b.$type=v.type;let w=l?h:c,M=w(i,b);y(M)&&(w=g(M),M=w(i,b)),delete b.$layer,delete b.$type,Dr.normalizeColor(oh,M),je(oh,oh,u);let x=ah(s,oh);x<0&&(x=s.length,s.push(De([],oh))),t[r]=x,l?(f=n[r],p=x):(d=n[r],m=x)}}return s.slice(2)}(z.verticeTypes,z.featureIndexes,t,h,c),B={data:{data:{aVertexColorType:W.length<=252?ga.createTypedArray(z.verticeTypes,Uint8Array):ga.createTypedArray(z.verticeTypes,Uint16Array),aPosition:z.vertices,aNormal:z.normals,aTexCoord0:z.uvs,aTangent:z.tangents,aPickingId:z.pickingIds},indices:L,properties:{maxAltitude:z.maxAltitude},dynamicAttributes:J.dynamicAttributes,vertexColors:W},buffers:j};return z.featureIds.length?(B.data.featureIds=z.featureIds,j.push(B.data.featureIds.buffer)):B.data.featureIds=[],J.aColor&&(B.data.data.aColor=J.aColor,B.buffers.push(J.aColor.buffer)),J.aOpacity&&(B.data.data.aOpacity=J.aOpacity,B.buffers.push(J.aOpacity.buffer)),B.buffers.push(B.data.data.aPosition.buffer),B.data.pickingIdIndiceMap=wl.generatePickingIndiceIndex(B.data.data.aPickingId,B.data.indices),B}const oh=[];function ah(t,n){for(let e=0;e<t.length;e++)if(Ne(n,t[e]))return e;return-1}function uh(t,n,e,r,{altitudeScale:i,altitudeProperty:s,defaultAltitude:o,heightProperty:a,minHeightProperty:u,defaultHeight:l,bottom:h}){const c=h,f=n/t[0].extent,d=2*function(t,n){let e=0;for(let n=0,r=t.length;n<r;n++){const r=t[n];if(k(r.geometry[0][0]))e+=3*r.geometry.length;else for(let t=0,n=r.geometry.length;t<n;t++){let n=3*r.geometry[t].length;3===r.type&&(n-=3),e+=n}}return e}(t)+3*t.length*2,p=[],m=new Int16Array(d),g=new Uint8Array(m.length/3*4);y(e)&&(e=ha.compileFilter(e));const v=[];function b(t,e,r){const i=e-t,s=m.subarray(t,e),o=m.subarray(e,e+i);o.set(s);for(let t=2,n=o.length;t<n;t+=3)o[t]=s[t]-r;const a=t/3,u=i/3;let l,h;for(let t=a,e=u+a;t<e;t++)t<e-1?(l=t,h=t+1):(l=t,h=a),lt(m,l,h,n)||(v.push(l,h),c&&v.push(l+u,h+u),lh(m,l,n)||v.push(l,l+u));return e+i}let w=0,M=0;const x=(Ql+"").trim(),F=[];for(let n=0,h=t.length;n<h;n++){const h=t[n],c=h.geometry;if(e){let t;t="function"==typeof e?e(h&&h.properties):e,Dr.normalizeColor(F,t)}else Ie(F,255,255,255);const d=w/3*4,{altitude:y,height:k}=wl.getFeaAltitudeAndHeight(h,i,s,o,a,l,u);M=Math.max(Math.abs(y),M);let A=w;for(let t=0,n=c.length;t<n;t++){let n=c[t];const e=n.length;n[0][0]===n[e-1][0]&&n[0][1]===n[e-1][1]&&(n=n.slice(0,e-1)),w=ut(m,A,n,f,y),w=b(A,w,k*f),A=w}const P=A/3*4;for(let t=d;t<P;t+=4)g[t]=F[0],g[t+1]=F[1],g[t+2]=F[2],g[t+3]=255*(r||1);const S=v.length-p.length;for(let t=0;t<S;t++)p.push(h[x])}const A=v.reduce(((t,n)=>Math.max(t,n)),0),P=new(wl.getIndexArrayType(A))(v),S=wl.getUnsignedArrayType(t.length);return{aPosition:new(wl.getPosArrayType(Math.max(512,M)))(m),indices:P,aPickingId:new S(p),aColor:g}}function lh(t,n,e){const r=t[3*n],i=t[3*n+1];return r<0||r>e||i<0||i>e}function hh(t,n,e,r){const i=uh(t,n,e.lineColor,e.lineOpacity,r),s=[i.aPosition.buffer,i.indices.buffer,i.aPickingId.buffer],o=i.indices;return delete i.indices,{data:{data:i,indices:o},buffers:s}}let ch=!1;try{const t=new OffscreenCanvas(1,1);t.getContext("2d").fillText("hello",0,0),ch=!0}catch(t){ch=!1}var fh=ch;const dh="__original_properties",ph="__fn-type_properties";class yh{constructor(t,n,e,r,i){this.id=t,this.options=n,this.upload=e,this.tn(n.style),this.requests={},this.Gt=r,this.nn=1,this.loadings=i}updateStyle(t,n){this.options.style=t,this.nn=t.styleCounter,this.tn(t),n()}updateOptions(t,n){this.options=x(this.options,t),n()}loadTile(t,n){const e=this.loadings,r=t.tileInfo.url,i=this.options.debugTile;if(i){const{x:e,y:r,z:s}=t.tileInfo;let o=!1;for(let t=0;t<i.length;t++)if(e===i[t].x&&r===i[t].y&&s===i[t].z){o=!0;break}if(!o)return void n()}if(e[r])return void e[r].push({context:t,callback:n,ref:this});e[r]=[{context:t,callback:n,ref:this}];const s=this.options.featureIdProperty;this.requests[r]=this.getTileFeatures(t,((n,i,o,a)=>{const u=e[r];if(delete e[r],this.checkIfCanceled(r))return delete this.requests[r],void this.en(u,null,{canceled:!0});if(delete this.requests[r],(this.options.debug||s)&&i)for(let n=0;n<i.length;n++)if(this.options.debug&&(i[n]._debug_info={index:n,id:i[n].id,tileId:t.tileInfo.id}),s){const t=P(s)?s[i[n].layer]:s,e=i[n].properties;i[n].id=e&&e[t]||null}if(n)this.en(u,n);else if(i&&i.length){if(u)for(let t=0;t<u.length;t++)this.rn.call(u[t].ref,u[t].context,u[t].callback,r,o,i,a)}else this.en(u)}))}rn(t,n,e,r,i,s){this.sn(r,i,t).then((e=>{e.canceled?n(null,{canceled:!0}):(e.data.styleCounter=t.styleCounter,s&&x(e.data,s),n(null,e.data,e.buffers))})).catch((t=>{n(t)}))}abortTile(t,n){delete this.requests[t],this.an(t),n()}an(t){const n=this.loadings[t];if(n)for(let t=0;t<n.length;t++)n[t].callback(null,{canceled:!0});delete this.loadings[t]}en(t,n,e){if(t)for(let r=0;r<t.length;r++)t[r].callback(n,e)}checkIfCanceled(t){return!this.requests[t]}onRemove(){this.loadings={},delete this.Gt,this.requests={}}fetchIconGlyphs(t,n,e){if(this.options.workerGlyph&&fh){const r=[];if(t&&Object.keys(t).length){const n=new Promise((n=>{this.upload("fetchIconGlyphs",{icons:t},null,((t,e)=>{n({err:t,iconData:e})}))}));r.push(n)}if(n&&Object.keys(n).length){const t=new Promise((t=>{this.un||(this.un=new vl),this.un.getGlyphs(n,((n,e)=>{t({err:n,glyphData:e})}))}));r.push(t)}Promise.all(r).then((t=>{const n={icons:null,glyphs:null};for(let r=0;r<t.length;r++){if(t[r].err)return void e(t[r].err);t[r].iconData?n.icons=t[r].iconData.icons:t[r].glyphData&&(n.glyphs=t[r].glyphData.glyphs)}return n})).then((t=>{e(null,t)}))}else this.upload("fetchIconGlyphs",{icons:t,glyphs:n},null,e)}sn(t,n,e){if(!n.length)return Promise.resolve({data:null,buffers:[]});const{glScale:r,tileInfo:i}=e,s=!this.options.style.style.length&&!this.options.style.featureStyle.length;let o=this.pluginConfig.slice(0);s&&(o=this.hn(t)),this.featurePlugins&&function(t){for(let n=1;n<arguments.length;n++){const e=arguments[n];if(e)for(let n=0,r=e.length;n<r;n++)t.push(e[n])}t.length}(o,this.featurePlugins);const a={};for(let t=0;t<o.length;t++)xh(n,e.tileInfo.z,o[t],a);const u=[],l=[];for(let t=0;t<n.length;t++){const e=n[t],r=a[t];if(r){l.fill(null);let t=0;for(const n in r){let i=0;const s=r[n].values();for(const t of s){let r=l[i];r||(r=Ph(e),l[i]=r),r.properties[n]=t,i++}i>t&&(t=i)}for(let n=0;n<t;n++)u.push(l[n])}else u.push(e)}const h=(n=u)[0].extent,c=i.z,f={x:i.extent2d.xmin*r,y:i.extent2d.ymax*r},d=[],p=[],y=[],m=this.options,g=[],v={},b=[Promise.resolve(e.styleCounter)];let w=0,M=-1;const F=[];let k=!1;for(let t=0;t<o.length;t++){M++;const r=o[t];r.type!==w&&(M=0,w=r.type);const a=0===r.type?d:p;if(r.symbol&&!1===r.symbol.visible){a[M]=null;continue}Oh(r.symbol,F,t),k=k||F[t]&&F[t].size>0;const{tileFeatures:u,tileFeaIndexes:l}=this.cn(c,r.type,r.filter,n,v,t);if(!u.length){a[M]=null;continue}const m=l[l.length-1],A=wl.getIndexArrayType(m);a[M]={styledFeatures:new A(l)},y.push({idx:t,typeIdx:M}),g.push(a[M].styledFeatures.buffer);const P=x({},e,{extent:h,zoom:c,tilePoint:f});if(this.options.debugTile){const t=this.options.debugTile;for(let n=0;n<t.length;n++){const{x:e,y:r,z:s}=t[n];if(i.x===e&&i.y===r&&i.z===s){P.debugIndex=t[n].index;break}}}let S=this.dn(u,r,P);s&&(S=S.then((t=>{if(!t)return null;if(t.data)t.data.layer=u[0].layer;else if(Array.isArray(t))for(let n=0;n<t.length;n++)t[n]&&t[n].data&&(t[n].data.layer=u[0].layer);return t}))),b.push(S)}return Promise.all(b).then((([e,...r])=>{if(e!==this.nn)return{canceled:!0};function i(t,n){if(void 0===t.data.ref&&(t.data.type=o[y[n].idx].renderPlugin.dataConfig.type,t.data.filter=o[y[n].idx].filter.def,t.buffers&&t.buffers.length))for(let n=0;n<t.buffers.length;n++)g.push(t.buffers[n])}for(let t=0;t<r.length;t++){if(!r[t])continue;const n=r[t],e=0===o[y[t].idx].type?d:p;if(Array.isArray(n)){const r=[];for(let e=0;e<n.length;e++)n[e]&&(i(n[e],t),(void 0===n[e].data.ref||n[n[e].data.ref])&&r.push(n[e].data));r.length&&(e[y[t].typeIdx].data=r)}else i(n,t),e[y[t].typeIdx].data=n.data}const s={},a=t;if(m.features||m.schema||k){let t,e=!1;for(let r=0,i=n.length;r<i;r++)if(t=n[r],a[t.layer].properties||(a[t.layer].properties=vh(t.properties)),t&&(m.features||k&&v[r]))if("id"===m.features)s[r]=t.id;else{m.pickingGeometry||delete t.geometry,delete t.extent,delete t.properties.$layer,delete t.properties.$type,delete t.__index;const n=t.originalFeature;if(n){const n=t.properties,e=x({},t.originalFeature);delete n[dh],e.customProps=x({},n),t=e}const i=x({},t);if(k&&v[r]&&(!m.features||"transient"===m.features)){const i=v[r];for(let r=0;r<i.length;r++){const i=F[r];i&&i.forEach((r=>{const i=n?n.properties:t.properties;i[ph]||(i[ph]=new Set),i[ph].add(r),e=!0}))}}s[r]=i}if(e)for(const t in s){const n=s[t],e=n.properties[ph];if(e){delete n.properties[ph],"transient"===m.features&&(n.fnTypeProps=x({},n.properties));for(const t in n.properties)e.has(t)||("transient"===m.features?delete n.fnTypeProps[t]:delete n.properties[t])}}}return{data:{styleCounter:e,schema:a,data:d,featureData:p,extent:h,features:s},buffers:g}})).catch((t=>{console.error(t)}))}dn(t,n,e){let r=t;const i=n.renderPlugin.dataConfig,s=n.symbol,o=this.options.tileSize,{extent:a,glScale:u,zScale:l,zoom:h,tilePoint:c,centimeterToPoint:f,verticalCentimeterToPoint:d}=e,p=a/o,y=i.type,m=e.debugIndex;let g=x({},i,{EXTENT:a,zoom:h,debugIndex:m,features:this.options.features});if("3d-extrusion"===y){bh(s)&&(i.uv=1);const t=this.options.projectionCode,n=s.material&&s.material.textureWidth||23.25;return Promise.all([Promise.resolve(sh(r,i,a,c,n,e.tileInfo.res,u,a/this.options.tileSize,f,d,s,h,t,m))])}if("3d-wireframe"===y)return Promise.all([Promise.resolve(hh(r,a,s,i))]);if("point"===y){g=x(g,{requestor:this.fetchIconGlyphs.bind(this),altitudeToTileScale:l*a/this.options.tileSize/u});const t=ku.splitPointSymbol(s),n=Pa.genFnTypes(t[0]);return ku.needMerge(t[0],n,h)&&(r=ku.mergeLineFeatures(r,t[0],n,h)),Promise.all(t.map(((t,e)=>(0===e?g.fnTypes=n:delete g.fnTypes,new ku(r,t,g).load(p)))))}if("native-point"===y){const t=l*a/this.options.tileSize/u;return g.altitudeToTileScale=t,wh(r,s,g,Hu,a/o)}if("line"===y)return g=x(g,{requestor:this.fetchIconGlyphs.bind(this),tileRatio:p}),wh(r,s,g,Iu,1,!0);if("native-line"===y)return wh(r,s,g,Ru,1,!0);if("fill"===y)return g=x(g,{requestor:this.fetchIconGlyphs.bind(this)}),wh(r,s,g,Ku);if("line-extrusion"===y){delete s.lineGradientProperty,s.lineJoin="miter",s.lineCap="butt";const t=bh(s);if(t&&(i.uv=1),g=x(g,{tileSize:o,zScale:l,glScale:u}),s.mergeOnProperty){const t=Pa.genFnTypes(s);r=Iu.mergeLineFeatures(r,s,t,g.zoom)}if(t){const t=[];if(!1!==i.top){const n=x({},g);n.side=!1,t.push(new Nu(r,s,n))}return!1!==i.side&&(g.side=!0,g.top=!1,t.push(new Nu(r,s,g))),Promise.all(t.map((t=>t.load())))}return Promise.all([new Nu(r,s,g).load()])}if("circle"===y)return wh(r,s,g,Qu);if("round-tube"===y||"square-tube"===y){const t="round-tube"===y?tl:ol;return g=x(g,{requestor:this.fetchIconGlyphs.bind(this),radialSegments:"round-tube"===y?i.radialSegments||8:4,centimeterToPoint:f,verticalCentimeterToPoint:d,tileRatio:p,isTube:!0}),wh(r,s,g,t)}return Promise.resolve([])}cn(t,n,e,r,i,s){const o=(Ql+"").trim(),a=[],u=[],l=r.length;for(let h=0;h<l;h++)if((1===n||void 0===r[h].id||!this.styledFeatures[r[h].id])&&((!e.def||"default"===e.def)&&!i[h]||!0===e.def||e.def&&(void 0!==e.def.condition||Array.isArray(e.def))&&e(r[h],t))){const t=r[h];if(void 0===t[o]&&(t[o]=h),i[h]||(i[h]=[]),i[h].push(s),u.push(t),a.push(h),1===n)break}return{tileFeatures:u,tileFeaIndexes:a}}tn(t){const{style:n,featureStyle:e}=t,r={};e.forEach((t=>{Array.isArray(t.id)?(t.id.forEach((t=>{r[t]=1})),t.filter=["in","$id",...t.id]):(r[t.id]=1,t.filter=["==","$id",t.id])}));const i=ha.compileStyle(n);for(let t=0;t<n.length;t++)i[t].filter&&(i[t].filter.def=n[t].filter?n[t].filter.value||n[t].filter:void 0),i[t].type=0;const s=[],o=ha.compileStyle(e);for(let t=0;t<e.length;t++)o[t].type=1,o[t].filter.def=e[t].filter?e[t].filter.value||e[t].filter:void 0,o[t].renderPlugin&&s.push(o[t]);this.pluginConfig=i,this.featurePlugins=s,this.styledFeatures=r}hn(t){let n=this.pn;this.pn||(n=this.pn={});const e=["","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon"],r=[];for(const i in t){const s=i;if(!n[i]){const r=[];for(let n=0;n<t[i].types.length;n++){const o=t[i].types[n],a=["all",["==","$layer",s],["==","$type",e[o]]],u={filter:ln(a),renderPlugin:mh(o),symbol:gh(o)};u.filter.def=a,u.type=0,r.push(u)}n[s]=r}r.push(...n[s])}return r}}function mh(t){switch(t){case 1:return{type:"native-point",dataConfig:{type:"native-point",only2D:!0}};case 2:return{type:"native-line",dataConfig:{type:"native-line",only2D:!0}};case 3:return{type:"fill",dataConfig:{type:"fill",only2D:!0}}}return null}function gh(t){switch(t){case 1:return{markerFill:"#f00",markerSize:10};case 2:return{lineColor:"#fff"};case 3:return{polygonFill:"#00f",polygonOpacity:.4}}return null}function vh(t){if(Array.isArray(t)||!P(t))return{};const n={};for(const e in t){const r=t[e];F(r)?n[e]="string":k(r)?n[e]="number":!0===r||!1===r?n[e]="boolean":Array.isArray(r)?n[e]="array":n[e]="object"}return n}function bh(t){if(!t)return 0;let n=0;for(const e in t){if(("normalTexture"===e||"bumpTexture"===e)&&t[e])return 2;if(e.indexOf("Texture")>0&&t[e])n=1;else if(P(t[e])){const r=bh(t[e]);if(2===r)return r;1===r&&(n=1)}}return n}function wh(t,n,e,r,i,s){const o={},a=Array.isArray(n)?n:[n];let u=-1;for(let t=0;t<a.length;t++)o[t]=Mh(a[t]),!o[t]&&a[t]&&-1===u&&(u=t);const l=[];for(let n=0;n<a.length;n++){if(!a[n])continue;a[n].index={index:n};let h=t;if(s&&a[n].mergeOnProperty){const r=Pa.genFnTypes(a[n]);h=Iu.mergeLineFeatures(t,a[0],r,e.zoom)}o[n]||n===u?l.push(new r(h,a[n],e).load(i)):l.push({data:{ref:u,symbolIndex:{index:n}}})}return Promise.all(l)}function Mh(t){if(!t)return 0;for(const n in t)if(_(t[n]))return 1;return 0}function xh(t,n,e,r){const i=e.customProperties;if(!i)return t;if(i)for(let t=0;t<i.length;t++)i[t].fn=ha.compileFilter(i[t].filter);for(let e=0;e<i.length;e++)for(let s=0,o=t.length;s<o;s++)if(i[e].fn(t[s],n))for(const t in i[e].properties){const n=i[e].properties[t];S(n)||(r[s]||(r[s]={}),r[s][t]||(r[s][t]=new Set),r[s][t].add(n))}}const Fh={get:(t,n)=>n in t?t[n]:t.originalFeature[n],has:(t,n)=>n in t||n in t.originalFeature},kh={get:function(t,n){return n in t?t[n]:t[dh][n]},has:(t,n)=>n in t||n in t[dh]},Ah={};function Ph(t){const n={};n.originalFeature=t;const e=new Proxy(n,Fh);return e.properties=new Proxy({},kh),e.properties[dh]=t.properties||Ah,e}function Sh(t,n,e){t[n]||(t[n]=new Set),t[n].add(e)}const _h=[];function Oh(t,n,e){if(!t)return _h;for(const r in t){if(!t[r]||!Dr.checkIfZoomFnTypeSymbol(r))continue;if(_(t[r]))Sh(n,e,t[r].property);else{if("lineGradientProperty"===r){Sh(n,e,t[r]);continue}if("textName"===r)if(F(t[r])){const i=Da.resolveVarNames(t[r]);if(i)for(let t=0;t<i.length;t++)Sh(n,e,i[t])}else if(ha.isExpression(t[r])){const i=[];Da.resolveExpVarNames(i,t[r]);for(let t=0;t<i.length;t++)Sh(n,e,i[t])}}const i=t[r].stops;if(i&&i.length)for(let t=0;t<i.length;t++)_(i[t][1])&&Sh(n,t,i[t][1].property)}return n[e]}function Ch(t,n){Eh(t.geometry,n)}function Eh(t,n){if(t)switch(t.type){case"Point":Ih(t.coordinates,n);break;case"MultiPoint":case"LineString":$h(t.coordinates,n);break;case"MultiLineString":!function(t,n){for(let e=0,r=t.length;e<r;e++)$h(t[e],n)}(t.coordinates,n);break;case"Polygon":Th(t.coordinates,n);break;case"MultiPolygon":!function(t,n){for(let e=0,r=t.length;e<r;e++)Th(t[e],n)}(t.coordinates,n);break;case"GeometryCollection":const e=t.geometries.length;for(let r=0;r<e;r++)Eh(t.geometries[r],n)}}function Ih(t,n){n[0]=Math.min(n[0],t[0]),n[1]=Math.min(n[1],t[1]),n[2]=Math.max(n[2],t[0]),n[3]=Math.max(n[3],t[1])}function $h(t,n){for(let e=0,r=t.length;e<r;e++)Ih(t[e],n)}function Th(t,n){t.length&&$h(t[0],n)}function Dh(t,n,e,r,i){zh(t,n,e||0,r||t.length-1,i||Uh)}function zh(t,n,e,r,i){for(;r>e;){if(r-e>600){var s=r-e+1,o=n-e+1,a=Math.log(s),u=.5*Math.exp(2*a/3),l=.5*Math.sqrt(a*u*(s-u)/s)*(o-s/2<0?-1:1);zh(t,n,Math.max(e,Math.floor(n-o*u/s+l)),Math.min(r,Math.floor(n+(s-o)*u/s+l)),i)}var h=t[n],c=e,f=r;for(jh(t,e,n),i(t[r],h)>0&&jh(t,e,r);c<f;){for(jh(t,c,f),c++,f--;i(t[c],h)<0;)c++;for(;i(t[f],h)>0;)f--}0===i(t[e],h)?jh(t,e,f):jh(t,++f,r),f<=n&&(e=f+1),n<=f&&(r=f-1)}}function jh(t,n,e){var r=t[n];t[n]=t[e],t[e]=r}function Uh(t,n){return t<n?-1:t>n?1:0}class Nh{constructor(t=9){this.yn=Math.max(4,t),this.mn=Math.max(2,Math.ceil(.4*this.yn)),this.clear()}all(){return this.gn(this.data,[])}search(t){let n=this.data;const e=[];if(!Kh(t,n))return e;const r=this.toBBox,i=[];for(;n;){for(let s=0;s<n.children.length;s++){const o=n.children[s],a=n.leaf?r(o):o;Kh(t,a)&&(n.leaf?e.push(o):Yh(t,a)?this.gn(o,e):i.push(o))}n=i.pop()}return e}collides(t){let n=this.data;if(!Kh(t,n))return!1;const e=[];for(;n;){for(let r=0;r<n.children.length;r++){const i=n.children[r],s=n.leaf?this.toBBox(i):i;if(Kh(t,s)){if(n.leaf||Yh(t,s))return!0;e.push(i)}}n=e.pop()}return!1}load(t){if(!t||!t.length)return this;if(t.length<this.mn){for(let n=0;n<t.length;n++)this.insert(t[n]);return this}let n=this.vn(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===n.height)this.bn(this.data,n);else{if(this.data.height<n.height){const t=this.data;this.data=n,n=t}this.wn(n,this.data.height-n.height-1,!0)}else this.data=n;return this}insert(t){return t&&this.wn(t,this.data.height-1),this}clear(){return this.data=Zh([]),this}remove(t,n){if(!t)return this;let e=this.data;const r=this.toBBox(t),i=[],s=[];let o,a,u;for(;e||i.length;){if(e||(e=i.pop(),a=i[i.length-1],o=s.pop(),u=!0),e.leaf){const r=Lh(t,e.children,n);if(-1!==r)return e.children.splice(r,1),i.push(e),this.Mn(i),this}u||e.leaf||!Yh(e,r)?a?(o++,e=a.children[o],u=!1):e=null:(i.push(e),s.push(o),o=0,a=e,e=e.children[0])}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}gn(t,n){const e=[];for(;t;)t.leaf?n.push(...t.children):e.push(...t.children),t=e.pop();return n}vn(t,n,e,r){const i=e-n+1;let s,o=this.yn;if(i<=o)return s=Zh(t.slice(n,e+1)),Rh(s,this.toBBox),s;r||(r=Math.ceil(Math.log(i)/Math.log(o)),o=Math.ceil(i/Math.pow(o,r-1))),s=Zh([]),s.leaf=!1,s.height=r;const a=Math.ceil(i/o),u=a*Math.ceil(Math.sqrt(o));Qh(t,n,e,u,this.compareMinX);for(let i=n;i<=e;i+=u){const n=Math.min(i+u-1,e);Qh(t,i,n,a,this.compareMinY);for(let e=i;e<=n;e+=a){const i=Math.min(e+a-1,n);s.children.push(this.vn(t,e,i,r-1))}}return Rh(s,this.toBBox),s}xn(t,n,e,r){for(;r.push(n),!n.leaf&&r.length-1!==e;){let e,r=1/0,i=1/0;for(let s=0;s<n.children.length;s++){const o=n.children[s],a=Jh(o),u=Bh(t,o)-a;u<i?(i=u,r=a<r?a:r,e=o):u===i&&a<r&&(r=a,e=o)}n=e||n.children[0]}return n}wn(t,n,e){const r=e?t:this.toBBox(t),i=[],s=this.xn(r,this.data,n,i);for(s.children.push(t),Hh(s,r);n>=0&&i[n].children.length>this.yn;)this.Fn(i,n),n--;this.kn(r,i,n)}Fn(t,n){const e=t[n],r=e.children.length,i=this.mn;this.An(e,i,r);const s=this.Pn(e,i,r),o=Zh(e.children.splice(s,e.children.length-s));o.height=e.height,o.leaf=e.leaf,Rh(e,this.toBBox),Rh(o,this.toBBox),n?t[n-1].children.push(o):this.bn(e,o)}bn(t,n){this.data=Zh([t,n]),this.data.height=t.height+1,this.data.leaf=!1,Rh(this.data,this.toBBox)}Pn(t,n,e){let r,i=1/0,s=1/0;for(let o=n;o<=e-n;o++){const n=Vh(t,0,o,this.toBBox),a=Vh(t,o,e,this.toBBox),u=Xh(n,a),l=Jh(n)+Jh(a);u<i?(i=u,r=o,s=l<s?l:s):u===i&&l<s&&(s=l,r=o)}return r||e-n}An(t,n,e){const r=t.leaf?this.compareMinX:qh,i=t.leaf?this.compareMinY:Gh;this.Sn(t,n,e,r)<this.Sn(t,n,e,i)&&t.children.sort(r)}Sn(t,n,e,r){t.children.sort(r);const i=this.toBBox,s=Vh(t,0,n,i),o=Vh(t,e-n,e,i);let a=Wh(s)+Wh(o);for(let r=n;r<e-n;r++){const n=t.children[r];Hh(s,t.leaf?i(n):n),a+=Wh(s)}for(let r=e-n-1;r>=n;r--){const n=t.children[r];Hh(o,t.leaf?i(n):n),a+=Wh(o)}return a}kn(t,n,e){for(let r=e;r>=0;r--)Hh(n[r],t)}Mn(t){for(let n,e=t.length-1;e>=0;e--)0===t[e].children.length?e>0?(n=t[e-1].children,n.splice(n.indexOf(t[e]),1)):this.clear():Rh(t[e],this.toBBox)}}function Lh(t,n,e){if(!e)return n.indexOf(t);for(let r=0;r<n.length;r++)if(e(t,n[r]))return r;return-1}function Rh(t,n){Vh(t,0,t.children.length,n,t)}function Vh(t,n,e,r,i){i||(i=Zh(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let s=n;s<e;s++){const n=t.children[s];Hh(i,t.leaf?r(n):n)}return i}function Hh(t,n){return t.minX=Math.min(t.minX,n.minX),t.minY=Math.min(t.minY,n.minY),t.maxX=Math.max(t.maxX,n.maxX),t.maxY=Math.max(t.maxY,n.maxY),t}function qh(t,n){return t.minX-n.minX}function Gh(t,n){return t.minY-n.minY}function Jh(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function Wh(t){return t.maxX-t.minX+(t.maxY-t.minY)}function Bh(t,n){return(Math.max(n.maxX,t.maxX)-Math.min(n.minX,t.minX))*(Math.max(n.maxY,t.maxY)-Math.min(n.minY,t.minY))}function Xh(t,n){const e=Math.max(t.minX,n.minX),r=Math.max(t.minY,n.minY),i=Math.min(t.maxX,n.maxX),s=Math.min(t.maxY,n.maxY);return Math.max(0,i-e)*Math.max(0,s-r)}function Yh(t,n){return t.minX<=n.minX&&t.minY<=n.minY&&n.maxX<=t.maxX&&n.maxY<=t.maxY}function Kh(t,n){return n.minX<=t.maxX&&n.minY<=t.maxY&&n.maxX>=t.minX&&n.maxY>=t.minY}function Zh(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function Qh(t,n,e,r,i){const s=[n,e];for(;s.length;){if((e=s.pop())-(n=s.pop())<=r)continue;const o=n+Math.ceil((e-n)/r/2)*r;Dh(t,o,n,e,i),s.push(n,o,o,e)}}var tc={exports:{}},nc=function(t,n,e,r){var i=t[0],s=t[1],o=!1;void 0===e&&(e=0),void 0===r&&(r=n.length);for(var a=(r-e)/2,u=0,l=a-1;u<a;l=u++){var h=n[e+2*u+0],c=n[e+2*u+1],f=n[e+2*l+0],d=n[e+2*l+1];c>s!=d>s&&i<(f-h)*(s-c)/(d-c)+h&&(o=!o)}return o},ec=function(t,n,e,r){var i=t[0],s=t[1],o=!1;void 0===e&&(e=0),void 0===r&&(r=n.length);for(var a=r-e,u=0,l=a-1;u<a;l=u++){var h=n[u+e][0],c=n[u+e][1],f=n[l+e][0],d=n[l+e][1];c>s!=d>s&&i<(f-h)*(s-c)/(d-c)+h&&(o=!o)}return o};tc.exports=function(t,n,e,r){return n.length>0&&Array.isArray(n[0])?ec(t,n,e,r):nc(t,n,e,r)};var rc=tc.exports.nested=ec;tc.exports.flat=nc;const ic=11102230246251565e-32,sc=134217729,oc=(3+8*ic)*ic;function ac(t,n,e,r,i){let s,o,a,u,l=n[0],h=r[0],c=0,f=0;h>l==h>-l?(s=l,l=n[++c]):(s=h,h=r[++f]);let d=0;if(c<t&&f<e)for(h>l==h>-l?(o=l+s,a=s-(o-l),l=n[++c]):(o=h+s,a=s-(o-h),h=r[++f]),s=o,0!==a&&(i[d++]=a);c<t&&f<e;)h>l==h>-l?(o=s+l,u=o-s,a=s-(o-u)+(l-u),l=n[++c]):(o=s+h,u=o-s,a=s-(o-u)+(h-u),h=r[++f]),s=o,0!==a&&(i[d++]=a);for(;c<t;)o=s+l,u=o-s,a=s-(o-u)+(l-u),l=n[++c],s=o,0!==a&&(i[d++]=a);for(;f<e;)o=s+h,u=o-s,a=s-(o-u)+(h-u),h=r[++f],s=o,0!==a&&(i[d++]=a);return 0===s&&0!==d||(i[d++]=s),d}function uc(t){return new Float64Array(t)}const lc=33306690738754716e-32,hc=22204460492503146e-32,cc=11093356479670487e-47,fc=uc(4),dc=uc(8),pc=uc(12),yc=uc(16),mc=uc(4);function gc(t,n,e,r,i,s){const o=(n-s)*(e-i),a=(t-i)*(r-s),u=o-a;if(0===o||0===a||o>0!=a>0)return u;const l=Math.abs(o+a);return Math.abs(u)>=lc*l?u:-function(t,n,e,r,i,s,o){let a,u,l,h,c,f,d,p,y,m,g,v,b,w,M,x,F,k;const A=t-i,P=e-i,S=n-s,_=r-s;w=A*_,f=sc*A,d=f-(f-A),p=A-d,f=sc*_,y=f-(f-_),m=_-y,M=p*m-(w-d*y-p*y-d*m),x=S*P,f=sc*S,d=f-(f-S),p=S-d,f=sc*P,y=f-(f-P),m=P-y,F=p*m-(x-d*y-p*y-d*m),g=M-F,c=M-g,fc[0]=M-(g+c)+(c-F),v=w+g,c=v-w,b=w-(v-c)+(g-c),g=b-x,c=b-g,fc[1]=b-(g+c)+(c-x),k=v+g,c=k-v,fc[2]=v-(k-c)+(g-c),fc[3]=k;let O=function(t,n){let e=n[0];for(let r=1;r<t;r++)e+=n[r];return e}(4,fc),C=hc*o;if(O>=C||-O>=C)return O;if(c=t-A,a=t-(A+c)+(c-i),c=e-P,l=e-(P+c)+(c-i),c=n-S,u=n-(S+c)+(c-s),c=r-_,h=r-(_+c)+(c-s),0===a&&0===u&&0===l&&0===h)return O;if(C=cc*o+oc*Math.abs(O),O+=A*h+_*a-(S*l+P*u),O>=C||-O>=C)return O;w=a*_,f=sc*a,d=f-(f-a),p=a-d,f=sc*_,y=f-(f-_),m=_-y,M=p*m-(w-d*y-p*y-d*m),x=u*P,f=sc*u,d=f-(f-u),p=u-d,f=sc*P,y=f-(f-P),m=P-y,F=p*m-(x-d*y-p*y-d*m),g=M-F,c=M-g,mc[0]=M-(g+c)+(c-F),v=w+g,c=v-w,b=w-(v-c)+(g-c),g=b-x,c=b-g,mc[1]=b-(g+c)+(c-x),k=v+g,c=k-v,mc[2]=v-(k-c)+(g-c),mc[3]=k;const E=ac(4,fc,4,mc,dc);w=A*h,f=sc*A,d=f-(f-A),p=A-d,f=sc*h,y=f-(f-h),m=h-y,M=p*m-(w-d*y-p*y-d*m),x=S*l,f=sc*S,d=f-(f-S),p=S-d,f=sc*l,y=f-(f-l),m=l-y,F=p*m-(x-d*y-p*y-d*m),g=M-F,c=M-g,mc[0]=M-(g+c)+(c-F),v=w+g,c=v-w,b=w-(v-c)+(g-c),g=b-x,c=b-g,mc[1]=b-(g+c)+(c-x),k=v+g,c=k-v,mc[2]=v-(k-c)+(g-c),mc[3]=k;const I=ac(E,dc,4,mc,pc);w=a*h,f=sc*a,d=f-(f-a),p=a-d,f=sc*h,y=f-(f-h),m=h-y,M=p*m-(w-d*y-p*y-d*m),x=u*l,f=sc*u,d=f-(f-u),p=u-d,f=sc*l,y=f-(f-l),m=l-y,F=p*m-(x-d*y-p*y-d*m),g=M-F,c=M-g,mc[0]=M-(g+c)+(c-F),v=w+g,c=v-w,b=w-(v-c)+(g-c),g=b-x,c=b-g,mc[1]=b-(g+c)+(c-x),k=v+g,c=k-v,mc[2]=v-(k-c)+(g-c),mc[3]=k;const $=ac(I,pc,4,mc,yc);return yc[$-1]}(t,n,e,r,i,s,l)}function vc(t,n,e){n=Math.max(0,void 0===n?2:n),e=e||0;var r=function(t){for(var n=t[0],e=t[0],r=t[0],i=t[0],s=0;s<t.length;s++){var o=t[s];o[0]<n[0]&&(n=o),o[0]>r[0]&&(r=o),o[1]<e[1]&&(e=o),o[1]>i[1]&&(i=o)}var a=[n,e,r,i],u=a.slice();for(s=0;s<t.length;s++)rc(t[s],a)||u.push(t[s]);return function(t){t.sort(Cc);for(var n=[],e=0;e<t.length;e++){for(;n.length>=2&&kc(n[n.length-2],n[n.length-1],t[e])<=0;)n.pop();n.push(t[e])}for(var r=[],i=t.length-1;i>=0;i--){for(;r.length>=2&&kc(r[r.length-2],r[r.length-1],t[i])<=0;)r.pop();r.push(t[i])}return r.pop(),n.pop(),n.concat(r)}(u)}(t),i=new Nh(16);i.toBBox=function(t){return{minX:t[0],minY:t[1],maxX:t[0],maxY:t[1]}},i.compareMinX=function(t,n){return t[0]-n[0]},i.compareMinY=function(t,n){return t[1]-n[1]},i.load(t);for(var s,o=[],a=0;a<r.length;a++){var u=r[a];i.remove(u),s=Pc(u,s),o.push(s)}var l=new Nh(16);for(a=0;a<o.length;a++)l.insert(Ac(o[a]));for(var h=n*n,c=e*e;o.length;){var f=o.shift(),d=f.p,p=f.next.p,y=Sc(d,p);if(!(y<c)){var m=y/h;(u=bc(i,f.prev.p,d,p,f.next.next.p,m,l))&&Math.min(Sc(u,d),Sc(u,p))<=m&&(o.push(f),o.push(Pc(u,f)),i.remove(u),l.remove(f),l.insert(Ac(f)),l.insert(Ac(f.next)))}}f=s;var g=[];do{g.push(f.p),f=f.next}while(f!==s);return g.push(f.p),g}function bc(t,n,e,r,i,s,o){for(var a=new xn([],wc),u=t.data;u;){for(var l=0;l<u.children.length;l++){var h=u.children[l],c=u.leaf?_c(h,e,r):Mc(e,r,h);c>s||a.push({node:h,dist:c})}for(;a.length&&!a.peek().node.children;){var f=a.pop(),d=f.node,p=_c(d,n,e),y=_c(d,r,i);if(f.dist<p&&f.dist<y&&Fc(e,d,o)&&Fc(r,d,o))return d}(u=a.pop())&&(u=u.node)}return null}function wc(t,n){return t.dist-n.dist}function Mc(t,n,e){if(xc(t,e)||xc(n,e))return 0;var r=Oc(t[0],t[1],n[0],n[1],e.minX,e.minY,e.maxX,e.minY);if(0===r)return 0;var i=Oc(t[0],t[1],n[0],n[1],e.minX,e.minY,e.minX,e.maxY);if(0===i)return 0;var s=Oc(t[0],t[1],n[0],n[1],e.maxX,e.minY,e.maxX,e.maxY);if(0===s)return 0;var o=Oc(t[0],t[1],n[0],n[1],e.minX,e.maxY,e.maxX,e.maxY);return 0===o?0:Math.min(r,i,s,o)}function xc(t,n){return t[0]>=n.minX&&t[0]<=n.maxX&&t[1]>=n.minY&&t[1]<=n.maxY}function Fc(t,n,e){for(var r,i,s,o,a=Math.min(t[0],n[0]),u=Math.min(t[1],n[1]),l=Math.max(t[0],n[0]),h=Math.max(t[1],n[1]),c=e.search({minX:a,minY:u,maxX:l,maxY:h}),f=0;f<c.length;f++)if(r=c[f].p,i=c[f].next.p,s=t,r!==(o=n)&&i!==s&&kc(r,i,s)>0!=kc(r,i,o)>0&&kc(s,o,r)>0!=kc(s,o,i)>0)return!1;return!0}function kc(t,n,e){return gc(t[0],t[1],n[0],n[1],e[0],e[1])}function Ac(t){var n=t.p,e=t.next.p;return t.minX=Math.min(n[0],e[0]),t.minY=Math.min(n[1],e[1]),t.maxX=Math.max(n[0],e[0]),t.maxY=Math.max(n[1],e[1]),t}function Pc(t,n){var e={p:t,prev:null,next:null,minX:0,minY:0,maxX:0,maxY:0};return n?(e.next=n.next,e.prev=n,n.next.prev=e,n.next=e):(e.prev=e,e.next=e),e}function Sc(t,n){var e=t[0]-n[0],r=t[1]-n[1];return e*e+r*r}function _c(t,n,e){var r=n[0],i=n[1],s=e[0]-r,o=e[1]-i;if(0!==s||0!==o){var a=((t[0]-r)*s+(t[1]-i)*o)/(s*s+o*o);a>1?(r=e[0],i=e[1]):a>0&&(r+=s*a,i+=o*a)}return(s=t[0]-r)*s+(o=t[1]-i)*o}function Oc(t,n,e,r,i,s,o,a){var u,l,h,c,f=e-t,d=r-n,p=o-i,y=a-s,m=t-i,g=n-s,v=f*f+d*d,b=f*p+d*y,w=p*p+y*y,M=f*m+d*g,x=p*m+y*g,F=v*w-b*b,k=F,A=F;0===F?(l=0,k=1,c=x,A=w):(c=v*x-b*M,(l=b*x-w*M)<0?(l=0,c=x,A=w):l>k&&(l=k,c=x+b,A=w)),c<0?(c=0,-M<0?l=0:-M>v?l=k:(l=-M,k=v)):c>A&&(c=A,-M+b<0?l=0:-M+b>v?l=k:(l=-M+b,k=v));var P=(1-(h=0===c?0:c/A))*i+h*o-((1-(u=0===l?0:l/k))*t+u*e),S=(1-h)*s+h*a-((1-u)*n+u*r);return P*P+S*S}function Cc(t,n){return t[0]===n[0]?t[1]-n[1]:t[0]-n[0]}class Ec{constructor(t,n){this.x=t,this.y=n}clone(){return new Ec(this.x,this.y)}normalize(){const t=this.length();this.x/=t,this.y/=t}negate(){this.x=-this.x,this.y=-this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}diff(t){return new Ec(this.x-t.x,this.y-t.y)}distance(t){const n=this.x-t.x,e=this.y-t.y;return Math.sqrt(n*n+e*e)}dot(t){return this.x*t.x+this.y*t.y}equals(t){return this.x===t.x&&this.y===t.y}orthogonal(){return new Ec(this.y,-this.x)}}function Ic(t,n,e,r){const i=n.x*r.y-n.y*r.x,s=e.x-t.x,o=e.y-t.y,a=(s*r.y-o*r.x)/i;return new Ec(t.x+a*n.x,t.y+a*n.y)}const $c=[],Tc=[];function Dc(t){if(k(t[0]&&t[0].x)){const n=[];let e=0;for(let r=0;r<t.length;r++)Tc[e]?(Tc[e][0]=t[r].x,Tc[e][1]=t[r].y):Tc[e]=[t[r].x,t[r].y],n.push(Tc[e]),e++;t=n}try{const n=vc(t,1/0);let e=[1/0,1/0],r=[-1/0,-1/0];for(let t=0;t<n.length;t++)n[t][0]<e[0]&&(e[0]=n[t][0]),n[t][0]>r[0]&&(r[0]=n[t][0]),n[t][1]<e[1]&&(e[1]=n[t][1]),n[t][1]>r[1]&&(r[1]=n[t][1]);const i=[];let s=[],o=0;for(let t=0;t<n.length;t++)t===n.length-1&&n[t][0]===n[0][0]&&n[t][1]===n[0][1]||(Bl(i,n[t],"EPSG:3857"),$c[o]?($c[o].x=i[0],$c[o].y=i[1]):$c[o]=new Ec(i[0],i[1]),s.push($c[o]),o++);wl.calculateSignedArea(s)<0&&(s=s.reverse());const a=function(t){let n,e=Number.MAX_VALUE;const r=function(t,r,i,s,o,a,u,l){var h=Ic(t,r,o,a),c=Ic(i,s,o,a),f=Ic(u,l,t,r),d=Ic(u,l,i,s),p=h.distance(c)*h.distance(f);0!==p&&p<e&&(n=[h,f,d,c],e=p)};var i=[];for(let n=0;n<t.length;n++)i.push(t[(n+1)%t.length].diff(t[n])),i[n].normalize();var s,o,a,u,l=new Ec(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),h=new Ec(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let n=0;n<t.length;n++){var c=t[n];c.x<l.x&&(l.x=c.x,s=n),c.x>h.x&&(h.x=c.x,o=n),c.y<l.y&&(l.y=c.y,u=n),c.y>h.y&&(h.y=c.y,a=n)}var f=new Ec(0,-1),d=new Ec(0,1),p=new Ec(-1,0),y=new Ec(1,0);for(let n=0;n<t.length;n++){var m=[Math.acos(f.dot(i[s])),Math.acos(d.dot(i[o])),Math.acos(p.dot(i[a])),Math.acos(y.dot(i[u]))];switch(m.indexOf(Math.min.apply(Math,m))){case 0:(d=(f=i[s].clone()).clone()).negate(),(y=(p=f.orthogonal()).clone()).negate(),s=(s+1)%t.length;break;case 1:(f=(d=i[o].clone()).clone()).negate(),(y=(p=f.orthogonal()).clone()).negate(),o=(o+1)%t.length;break;case 2:(y=(p=i[a].clone()).clone()).negate(),(d=(f=y.orthogonal()).clone()).negate(),a=(a+1)%t.length;break;case 3:(p=(y=i[u].clone()).clone()).negate(),(d=(f=y.orthogonal()).clone()).negate(),u=(u+1)%t.length}r(t[s],f,t[o],d,t[a],p,t[u],y)}return n}(s);if(!a||4!==a.length)return null;const u=a[0].distance(a[1]),l=a[1].distance(a[2]),h=a.map((t=>[t.x,t.y]));return h.push(+(l>u)),h}catch(t){return null}}const zc=[];function jc(t,n){const e=Array.isArray(t&&t[0]&&t[0][0]);for(let r=0;r<t.length;r++)e?t[r]=jc(t[r]):(Bl(zc,t[r],n),t[r][0]=zc[0],t[r][1]=zc[1]);return t}class Uc extends yh{constructor(t,n,e,r,i,s){super(t,n,e,r,i),(n=n||{}).extent||(n.extent=8192),this.setData(n.data,s)}setData(t,n){if(delete this.index,function(t){if(!t)return!0;if(Array.isArray(t)&&!t.length)return!0;if(t.features&&!t.features.length)return!0;return!1}(t))return this.empty=!0,void n();const e={maxZoom:24,tolerance:this.options.simplifyTolerance,extent:this.options.extent,buffer:k(this.options.tileBuffer)?this.options.tileBuffer:64,hasAltitude:!!this.options.hasAltitude,debug:0,lineMetrics:!0,indexMaxZoom:5,indexMaxPoints:1e5,disableFilter:!0};if(this.options.projection&&(e.projection=this.options.projection,"EPSG:4490"===e.projection&&(e.projection="EPSG:4326")),F(t)&&"{"!=t.substring(0,1)||t.url){const r=t.url?t.url:t;C.getJSON(r,t.url?t:{},((t,i)=>{if(t&&(console.error("Failed to fetch geojson:"+r),n(t)),!i)return void n(null,{extent:null,idMap:{}});let s=i;if(this.options.convertFn){s=new Function("data",this.options.convertFn+"\\nreturn convert(data)")(s)}const o=Array.isArray(s)?s:s.features;this._n(o);const{sample1000:a,idMap:u}=this.On(o);this.Cn(a,u,s,e,n)}))}else{"string"==typeof t&&(t=JSON.parse(t));const r=Array.isArray(t)?t:t.features,i=r&&r.length;this._n(r);let s=r;if(r&&i>1e3){s=[];for(let t=0;t<i;t++)Nc(r[t],s,t,i)}this.Cn(s,null,t,e,n)}}_n(t){if(this.options.generateOMBB&&t)for(let n=0;n<t.length;n++){const e=t[n];if(e&&e.geometry&&e.geometry.coordinates)if("Polygon"===e.geometry.type){const t=e.geometry.coordinates[0];if(!t)continue;const n=Dc(t,t.length);e.properties=e.properties||{},e.properties[th]=n}else if("MultiPolygon"===e.geometry.type){const t=e.geometry.coordinates;for(let n=0;n<t.length;n++){if(!t[n])continue;const r=t[n][0];if(!r)continue;const i=Dc(r,r.length);e.properties=e.properties||{},e.properties[th]=e.properties[th]||[],e.properties[th][n]=i}}}}Cn(t,n,e,r,i){try{const s=t&&t.length?function(t){let n=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];switch(t.type){case"FeatureCollection":const e=t.features.length;for(let r=0;r<e;r++)Ch(t.features[r],n);break;case"Feature":Ch(t,n);break;default:Eh(t,n)}return n}({type:"FeatureCollection",features:t}):null;this.index=function(t,n){return new ot(t,n)}(e,this.options.geojsonvt||r),i(null,{extent:s,idMap:n})}catch(t){console.warn(t),i({error:t.message})}}On(t){const n=[],e={};let r=0;const i=this.options.featureIdProperty;if(t){const s=t.length;t.forEach(((t,o)=>{!function(t,s,o){if(t&&("Feature"!==t.type||t.geometry)){if(k(t.id)||(t.id=r++),i){let n=i;P(i)&&(n=i[t.layer||"0"]),t.id=t.properties[n]}e[t.id]=x({},t),t.geometry?(e[t.id].geometry=x({},t.geometry),e[t.id].geometry.coordinates=null):t.coordinates&&(e[t.id].coordinates=null),Nc(t,n,s,o)}}(t,o,s)}))}return{sample1000:n,idMap:e}}getTileFeatures(t,n){const e=t.tileInfo,r=[];if(!this.index)return this.empty?(setTimeout((function(){n(null,r,[])}),1),1):(setTimeout((function(){n({loading:!0})}),1),1);const i=this.index.getTile(e.z,e.x,e.y);if(!i||0===i.features.length)return setTimeout((function(){n(null,r,[])}),1),1;const s=[];for(let t=0,n=i.features.length;t<n;t++){const n=i.features[t];let e=n.layer;void 0===e&&(e="0"),s[e]={types:{}};s[e].types[n.type]=1,n.tags=n.tags||{},n.geometry.converted||(wl.convertGeometry(n),n.geometry.converted=1),r.push({type:n.type,layer:e,id:n.id,geometry:n.geometry,properties:n.tags,extent:this.options.extent})}for(const t in s)s[t].types=Object.keys(s[t].types).map((t=>+t));return setTimeout((function(){n(null,r,s)}),1),1}onRemove(){super.onRemove(),delete this.index}}function Nc(t,n,e,r){const i=Math.floor(r/998);(0===e||e===r-1||(0===i||e%i==0)&&n.length<999)&&n.push(t)}var Lc=ct,Rc=Vc;function Vc(t,n,e,r,i){this.properties={},this.extent=e,this.type=0,this.En=t,this.In=-1,this.$n=r,this.Tn=i,t.readFields(Hc,this,n)}function Hc(t,n,e){1==t?n.id=e.readVarint():2==t?function(t,n){var e=t.readVarint()+t.pos;for(;t.pos<e;){var r=n.$n[t.readVarint()],i=n.Tn[t.readVarint()];n.properties[r]=i}}(e,n):3==t?n.type=e.readVarint():4==t&&(n.In=e.pos)}function qc(t){for(var n,e,r=0,i=0,s=t.length,o=s-1;i<s;o=i++)n=t[i],r+=((e=t[o]).x-n.x)*(n.y+e.y);return r}Vc.types=["Unknown","Point","LineString","Polygon"],Vc.prototype.loadGeometry=function(){var t=this.En;t.pos=this.In;for(var n,e=t.readVarint()+t.pos,r=1,i=0,s=0,o=0,a=[];t.pos<e;){if(i<=0){var u=t.readVarint();r=7&u,i=u>>3}if(i--,1===r||2===r)s+=t.readSVarint(),o+=t.readSVarint(),1===r&&(n&&a.push(n),n=[]),n.push(new Lc(s,o));else{if(7!==r)throw new Error("unknown command "+r);n&&n.push(n[0].clone())}}return n&&a.push(n),a},Vc.prototype.bbox=function(){var t=this.En;t.pos=this.In;for(var n=t.readVarint()+t.pos,e=1,r=0,i=0,s=0,o=1/0,a=-1/0,u=1/0,l=-1/0;t.pos<n;){if(r<=0){var h=t.readVarint();e=7&h,r=h>>3}if(r--,1===e||2===e)(i+=t.readSVarint())<o&&(o=i),i>a&&(a=i),(s+=t.readSVarint())<u&&(u=s),s>l&&(l=s);else if(7!==e)throw new Error("unknown command "+e)}return[o,u,a,l]},Vc.prototype.toGeoJSON=function(t,n,e){var r,i,s=this.extent*Math.pow(2,e),o=this.extent*t,a=this.extent*n,u=this.loadGeometry(),l=Vc.types[this.type];function h(t){for(var n=0;n<t.length;n++){var e=t[n],r=180-360*(e.y+a)/s;t[n]=[360*(e.x+o)/s-180,360/Math.PI*Math.atan(Math.exp(r*Math.PI/180))-90]}}switch(this.type){case 1:var c=[];for(r=0;r<u.length;r++)c[r]=u[r][0];h(u=c);break;case 2:for(r=0;r<u.length;r++)h(u[r]);break;case 3:for(u=function(t){var n=t.length;if(n<=1)return[t];for(var e,r,i=[],s=0;s<n;s++){var o=qc(t[s]);0!==o&&(void 0===r&&(r=o<0),r===o<0?(e&&i.push(e),e=[t[s]]):e.push(t[s]))}e&&i.push(e);return i}(u),r=0;r<u.length;r++)for(i=0;i<u[r].length;i++)h(u[r][i])}1===u.length?u=u[0]:l="Multi"+l;var f={type:"Feature",geometry:{type:l,coordinates:u},properties:this.properties};return"id"in this&&(f.id=this.id),f};var Gc=Rc,Jc=Wc;function Wc(t,n){this.version=1,this.name=null,this.extent=4096,this.length=0,this.En=t,this.$n=[],this.Tn=[],this.Dn=[],t.readFields(Bc,this,n),this.length=this.Dn.length}function Bc(t,n,e){15===t?n.version=e.readVarint():1===t?n.name=e.readString():5===t?n.extent=e.readVarint():2===t?n.Dn.push(e.pos):3===t?n.$n.push(e.readString()):4===t&&n.Tn.push(function(t){var n=null,e=t.readVarint()+t.pos;for(;t.pos<e;){var r=t.readVarint()>>3;n=1===r?t.readString():2===r?t.readFloat():3===r?t.readDouble():4===r?t.readVarint64():5===r?t.readVarint():6===r?t.readSVarint():7===r?t.readBoolean():null}return n}(e))}Wc.prototype.feature=function(t){if(t<0||t>=this.Dn.length)throw new Error("feature index out of bounds");this.En.pos=this.Dn[t];var n=this.En.readVarint()+this.En.pos;return new Gc(this.En,n,this.extent,this.$n,this.Tn)};var Xc=Jc;function Yc(t,n,e){if(3===t){var r=new Xc(e,e.readVarint()+e.pos);r.length&&(n[r.name]=r)}}var Kc=function(t,n){this.layers=t.readFields(Yc,{},n)};class Zc extends yh{constructor(t,n,e,r,i,s){super(t,n,e,r,i),n=n||{},s()}getTileFeatures(t,n){const e=t.tileInfo.url,r=t.fetchOptions||{};if(this.Gt.has(e)){const{err:t,data:r}=this.Gt.get(e);return setTimeout((()=>{this.zn(e,t,r,n)}),1)}return r.referrer=t.referrer,C.getArrayBuffer(e,r,((t,r)=>{this.Gt&&(t?t.loading||this.Gt.add(e,{err:t,data:r&&r.data}):r&&r.data&&this.Gt.add(e,{err:null,data:r.data}),this.zn(e,t,r&&r.data,n))}))}zn(t,n,e,r){if(n)return void r(n);let i;try{i=new Kc(new Hl(e))}catch(n){return void r(n.message,[],[])}const s=[];if(!i.layers)return void r(null,s,[]);const o={};let a;for(const t in i.layers)if(u=i.layers,l=t,Object.prototype.hasOwnProperty.call(u,l)){o[t]={types:{}};const e=o[t].types;for(let r=0,o=i.layers[t].length;r<o;r++)try{a=i.layers[t].feature(r),e[a.type]=1;const n={type:a.type,layer:t,geometry:a.loadGeometry(),properties:a.properties,extent:a.extent};void 0!==a.id&&(n.id=a.id);let o=n.properties[th];o&&(F(o)&&(o=JSON.parse(o)),n.properties[th]=jc(o,"EPSG:3857")),s.push(n)}catch(n){console.warn("error when load vt geometry:",n)}}var u,l;for(const t in o)o[t].types=Object.keys(o[t].types).map((t=>+t));r(null,s,o,{byteLength:e.byteLength})}abortTile(t,n){const e=this.requests[t];delete this.requests[t],e&&e.abort&&e.abort(),this.an(t),n()}onRemove(){super.onRemove();for(const t in this.requests){const n=this.requests[t];n&&n.abort&&n.abort()}this.requests={}}}let Qc=0;const tf=new fl(128);class nf{constructor(t){this.jn={},this.Un={},this.workerId=t}addLayer({actorId:t,mapId:n,layerId:e,params:r},i){if(this.Nn(n,e))return;const s=this.Ln(n,e),o=r.type,a=r.options,u=this.send.bind(this,t);this.jn[s]="GeoJSONVectorTileLayer"===o?new Uc(e,a,u,tf,{},i):new Zc(e,a,u,tf,{},i)}removeLayer({mapId:t,layerId:n},e){const r=this.Nn(t,n),i=this.Ln(t,n);delete this.jn[i],r&&r.onRemove(e)}loadTile({mapId:t,layerId:n,params:e},r){const i=this.Nn(t,n);i&&i.loadTile(e,r)}abortTile({mapId:t,layerId:n,params:e},r){const i=this.Nn(t,n);i&&i.abortTile&&i.abortTile(e.url,r)}removeTile({mapId:t,layerId:n,params:e},r){const i=this.Nn(t,n);i&&i.removeTile(e,r)}updateStyle({mapId:t,layerId:n,params:e},r){const i=this.Nn(t,n);i&&i.updateStyle(e,r)}updateOptions({mapId:t,layerId:n,params:e},r){const i=this.Nn(t,n);i&&i.updateOptions(e,r)}setData({mapId:t,layerId:n,params:e},r){const i=this.Nn(t,n);i&&i.setData(e.data,r)}receive(t){const n=t.callback,e=this.Un[n];delete this.Un[n],e&&t.error?e(new Error(t.error)):e&&e(null,t.data)}send(t,n,e,r,i){const s=i?\`${Tt}t}-${Tt}Qc++}\`:null;i&&(this.Un[s]=i),postMessage({type:"<request>",workerId:this.workerId,actorId:t,command:n,params:e,callback:String(s)},r||[])}Ln(t,n){return\`${Tt}t}-${Tt}n}\`}Nn(t,n){const e=this.Ln(t,n);return this.jn[e]}Rn(){tf.reset()}}t.initialize=function(){},t.onmessage=function(t,n){const e=t.data;if(this.dispatcher||(this.dispatcher=new nf(t.workerId)),"<response>"===t.type)this.dispatcher.workerId===t.workerId&&this.dispatcher.receive(t);else{const r=e.command;this.dispatcher[r]({actorId:t.actorId,mapId:e.mapId,layerId:e.layerId,params:e.params},((t,e,i)=>{t&&404!==t.status&&204!==t.status&&!t.loading&&console.error(r,t),n(t,e,i)}))}}}`;let rB=0;function PC(){return rB++}const iB=typeof Object.assign=="function";function Oe(r,...t){if(iB)return Object.assign(r,...t),r;for(let e=0;e<t.length;e++){const n=t[e];for(const i in n)r[i]=n[i]}return r}function Bo(r){return!er(r)&&(typeof r=="string"||r.constructor!==null&&r.constructor===String)}function Bl(r){return typeof r=="number"&&!isNaN(r)}function vv(r){return!er(r)&&(typeof r=="function"||r.constructor!==null&&r.constructor===Function)}function Zu(r){return!Array.isArray(r)&&typeof r=="object"&&!!r}function er(r){return r==null}function ha(r){for(let t=1;t<arguments.length;t++){const e=arguments[t];if(e)for(let n=0,i=e.length;n<i;n++)r.push(e[n])}return r.length}function Xd(r){return Ft(r)&&r.property}function jl(r,t){return Object.prototype.hasOwnProperty.call(r,t)}function Vl(r,t){let e;if(t.altitudeToPoint){e=t.altitudeToPoint(100,r);const n=t.options.heightFactor;n&&n!==1&&(e/=n)}else e=t.distanceToPointAtRes(100,0,r).x;return e/100/100}function EC(r,t,e){for(let n=0;n<r.length;n++){const i=r[n],o=Oe({},i),{renderPlugin:s}=i,a=Oe({},s);a.sceneConfig&&!Object.keys(a.sceneConfig).length&&delete a.sceneConfig;let l=-1;for(let h=e.length-1;h>=0;h--)if(su(a,e[h])){l=h;break}l<0&&(l=e.length,e.push(a)),o.renderPlugin=l,t.push(o)}}const oB=typeof fetch=="function"&&typeof AbortController=="function",xs={jsonp:function(r,t){const e="_maptalks_jsonp_"+PC();r.match(/\?/)?r+="&callback="+e:r+="?callback="+e;let n=document.createElement("script");return n.type="text/javascript",n.src=r,window[e]=function(i){t(null,i),document.getElementsByTagName("head")[0].removeChild(n),n=null,delete window[e]},document.getElementsByTagName("head")[0].appendChild(n),this},get:function(r,t,e){if(vv(t)){const i=e;e=t,t=i}(t=t||{}).method&&(t.method=t.method.toUpperCase());const n=t.method==="POST";if(oB){const i=new AbortController,o=t;o.signal=i.signal,o.referrerPolicy=o.referrerPolicy||"origin",o.method=o.method||"GET";const s=new Request(r,o);return t.returnJSON&&s.headers.set("Accept","application/json"),fetch(s).then(a=>{const l=this.t(a,t.returnJSON,t.responseType);l.message?(l.url=r,e(l)):l.then(h=>{t.responseType==="arraybuffer"?e(null,{data:h,cacheControl:a.headers.get("Cache-Control"),expires:a.headers.get("Expires"),contentType:a.headers.get("Content-Type")}):e(null,h)}).catch(h=>{h.code&&h.code===DOMException.ABORT_ERR||(console.error("Fetch error:",r,h),e(h))})}).catch(a=>{a.code&&a.code===DOMException.ABORT_ERR||(console.error("Fetch error:",r,a),e(a))}),i}{const i=xs.i(e);if(i.open(t.method||"GET",r,!0),t){for(const o in t.headers)i.setRequestHeader(o,t.headers[o]);i.withCredentials=t.credentials==="include",t.responseType&&(i.responseType=t.responseType)}return i.send(n?t.body:null),i}},t:(r,t,e)=>r.status!==200?{status:r.status,statusText:r.statusText,message:`incorrect http request with status code(${r.status}): ${r.statusText}`}:e==="arraybuffer"?r.arrayBuffer():t?r.json():r.text(),o:function(r,t){return function(){r.readyState===4&&(r.status===200?r.responseType==="arraybuffer"?r.response.byteLength===0?t({status:200,statusText:r.statusText,message:"http status 200 returned without content."}):t(null,{data:r.response,cacheControl:r.getResponseHeader("Cache-Control"),expires:r.getResponseHeader("Expires"),contentType:r.getResponseHeader("Content-Type")}):t(null,r.responseText):t({status:r.status,statusText:r.statusText,message:`incorrect http request with status code(${r.status}): ${r.statusText}`}))}},i:function(r){let t;try{t=new XMLHttpRequest}catch{try{t=new ActiveXObject("Msxml2.XMLHTTP")}catch{try{t=new ActiveXObject("Microsoft.XMLHTTP")}catch{}}}return t.onreadystatechange=xs.o(t,r),t},getArrayBuffer(r,t,e){if(vv(t)){const n=e;e=t,t=n}return t||(t={}),t.responseType="arraybuffer",xs.get(r,t,e)},getJSON:function(r,t,e){if(vv(t)){const i=e;e=t,t=i}const n=function(i,o){const s=typeof o=="string"?JSON.parse(o):o||null;e(i,s)};return t&&t.jsonp?xs.jsonp(r,n):((t=t||{}).returnJSON=!0,xs.get(r,t,n))}},sB=["GeoJSONVectorTileLayer"];class aB extends jb.Actor{constructor(t,e){super(t);const n=e.getMap().id;this.l=e,this.h=n,this.u="vt_"+PC();const i=e.getJSONType();this.m=sB.indexOf(i)>=0,this.v={},this.A=new hC({iconErrorUrl:e.options.iconErrorUrl,maxSize:e.options.maxIconSize,urlModifier:s=>{const a=e.getURLModifier();return a&&a(s)||s}});const o=!e.getRenderer().isEnableWorkAround("win-intel-gpu-crash");this._=new lC(s=>{e.getMap().getRenderer().callInNextFrame(s)},e.options.glyphSdfLimitPerFrame,o)}initialize(t){t(null)}addLayer(t){const e=this.l,n=e.getWorkerOptions()||{},i=this.u,o=e.getJSONType(),s={mapId:this.h,layerId:i,command:"addLayer",params:{type:o,options:n}};this.m?(this.v[i]===void 0&&(this.v[i]=this.getDedicatedWorker()),this.send(s,null,t,this.v[i])):this.broadcast(s,null,t)}abortTile(t,e){const n=this.u,i={mapId:this.h,layerId:n,command:"abortTile",params:{url:t}};this.m?(this.v[n]===void 0&&(this.v[n]=this.getDedicatedWorker()),this.send(i,null,e,this.v[n])):this.broadcast(i,null,e)}removeLayer(t){const e=this.u,n={mapId:this.h,layerId:e,command:"removeLayer"};this.m?(this.v[e]!==void 0&&this.send(n,null,t,this.v[e]),delete this.v[e]):this.broadcast(n,null,t)}updateStyle(t,e){const n=this.u,i={mapId:this.h,layerId:n,command:"updateStyle",params:t};this.m?this.v[n]!==void 0&&this.send(i,null,e,this.v[n]):this.broadcast(i,null,e)}updateOptions(t,e){const n=this.u,i={mapId:this.h,layerId:n,command:"updateOptions",params:t};this.m?this.v[n]!==void 0&&this.send(i,null,e,this.v[n]):this.broadcast(i,null,e)}loadTile(t,e){const n=Oe({},t);n.tileInfo=function(h){const u={};for(const c in h)h[c]!==void 0&&h[c]!==null&&(h[c].toJSON?u[c]=h[c].toJSON():u[c]=h[c]);return u}(t.tileInfo);const i=this.u,o={mapId:this.h,layerId:i,command:"loadTile",params:n},{x:s,y:a}=t.tileInfo,l=(s+a)%this.workers.length;this.send(o,null,e,this.v[i]===void 0?this.workers[l].id:this.v[i])}remove(){super.remove(),this.v={}}fetchIconGlyphs({icons:t,glyphs:e},n){this._.getGlyphs(e,(i,o)=>{if(i)throw i;const s=o.buffers||[];this.A.getIcons(t,(a,l)=>{if(a)throw a;l.buffers&&l.buffers.length&&s.push(...l.buffers),n(null,{icons:l.icons,glyphs:o.glyphs},s)})})}setData(t,e){const n=this.u,i={mapId:this.h,layerId:n,command:"setData",params:{data:t}};this.send(i,null,e,this.v[n])}S(t){return t.id}}const lB={},OC={collision:!0,fading:!1,fadingDuration:224,fadeInDelay:600,fadeOutDelay:100,uniquePlacement:!1,depthFunc:"always"};class hB{constructor(t,e,n){this.M=t,this.T=e,this.P=n||[0,1,0]}draw(t,e,n,i,o){if(this.k||this.I(),!this.O){this.O=this.M.buffer(kC(i));const l=i/n;this.C=this.M.buffer(IC(i,l))}if(i!==this.F){const l=i/n;this.O(kC(i)),this.C(IC(i,l))}this.F=i;let s=this.D;if(!s){const l=this.T.getDevicePixelRatio()>1?2:1;s=this.D=document.createElement("canvas"),s.width=512*l,s.height=64*l;const h=s.getContext("2d");h.font="36px monospace",h.scale(l,l),this.L=this.M.texture({width:s.width,height:s.height,data:s})}const a=s.getContext("2d");a.clearRect(0,0,s.width,s.height),a.fillStyle=`rgba(${this.P.map(l=>255*l).join()})`,a.fillText(t,20,36),this.L({width:s.width,height:s.height,data:s}),this.k({transform:e,data:this.O,texData:this.R,debugLine:1,primitive:"lines",framebuffer:o||null,image:this.L,count:8}),this.k({transform:e,data:this.C,texData:this.R,debugLine:0,primitive:"triangle strip",framebuffer:o||null,image:this.L,count:4})}delete(){this.L&&(this.L.destroy(),delete this.L),this.R&&(this.R.destroy(),delete this.R),this.O&&(this.O.destroy(),this.C.destroy(),delete this.O,delete this.C),this.k&&(this.k.destroy(),delete this.k)}I(){this.R=this.M.buffer(new Uint8Array([0,0,0,1,1,0,1,1,0,0,0,1,1,0,1,1])),this.k=this.M({vert:`
                attribute vec2 aPosition;
                attribute vec2 aTexCoord;
                uniform mat4 transform;

                varying vec2 vTexCoord;
                void main()
                {
                    gl_Position = transform * vec4(aPosition, 0.0, 1.0);
                    vTexCoord = aTexCoord;
                }
            `,frag:`
                precision mediump float;
                uniform sampler2D uImage;
                uniform vec3 uColor;
                uniform float uOpacity;
                uniform float uDebugLine;

                varying vec2 vTexCoord;

                void main()
                {
                    if (uDebugLine == 1.) {
                        gl_FragColor = vec4(uColor, 1.0) * uOpacity;
                    } else {
                        gl_FragColor = texture2D(uImage, vTexCoord) * uOpacity;
                    }
                    gl_FragColor *= gl_FragColor.a;
                }
            `,attributes:{aPosition:this.M.prop("data"),aTexCoord:this.M.prop("texData")},uniforms:{transform:this.M.prop("transform"),uColor:this.P,uOpacity:1,uDebugLine:this.M.prop("debugLine"),uImage:this.M.prop("image")},count:this.M.prop("count"),primitive:this.M.prop("primitive"),depth:{enable:!1,mask:!1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"},stencil:{enable:!1},viewport:{x:0,y:0,width:()=>this.T.getRenderer().canvas.width,height:()=>this.T.getRenderer().canvas.height},framebuffer:this.M.prop("framebuffer")})}}function kC(r){return new Uint16Array([0,0,0,r,0,r,r,r,r,r,r,0,r,0,0,0])}function IC(r,t){return new Uint16Array([0,r-64*t,0,r,512*t,r-64*t,512*t,r])}const RC=new Uint8Array([0,0,0,1,1,0,1,0,0,1,1,1]),DC=[];class uB{constructor(t,e,n){this.M=t,(this.H=new ar({aPosition:RC},null,RC.length/2,{positionSize:2})).generateBuffers(t),this.N=new ur,this.V=[],this.j=0,this.U=e,this.T=n,this.I(t)}start(){this.j=0,this.N.clear()}add(t,e,n){const i=this.G(n);i.setUniform("ref",t),ie(DC,e,e,1);const o=i.localTransform;Ws(o,DC),qR(o,n,o),i.setLocalTransform(o),this.N.addMesh(i)}render(t){this.W.render(this.Y,{projViewMatrix:this.T.projViewMatrix},this.N,t)}G(){const t=this.j++;return this.V[t]||(this.V[t]=new nn(this.H)),this.V[t]}I(t){const e=this.U,n={viewport:{x:0,y:0,width:()=>e.width,height:()=>e.height},stencil:{enable:!0,mask:255,func:{cmp:"always",ref:(i,o)=>o.ref,mask:255},op:{fail:"replace",zfail:"replace",zpass:"replace"}},depth:{enable:!0,func:"always",mask:!1},colorMask:[!1,!1,!1,!1]};this.Y=new Ye({vert:`
#define SHADER_NAME TILE_STENCIL_VERT
attribute vec2 aPosition;
uniform mat4 projViewModelMatrix;

void main()
{
    gl_Position = projViewModelMatrix * vec4(aPosition, 0.0, 1.0);
}
`,frag:`
#define SHADER_NAME TILE_STENCIL_FRAG
void main()
{
    gl_FragColor = vec4(1.0, 0.0, 0.0, 0.1);
}
`,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(i,o){const s=[];return qt(s,o.projViewMatrix,o.modelMatrix),s}}],extraCommandProps:n}),this.W=new un(t)}remove(){this.H.dispose();for(let t=0;t<this.V.length;t++)this.V[t].dispose();this.V.length=0,this.Y.dispose()}}const Yd="__fea_idx",ua=-999999,Gl=new Float32Array([-1e12])[0],qd="maptalks_ombb",cB=(Yd+"").trim();function FC(r,t,e,n,i,o){const s={};if(function(a){if(!a)return!1;for(const l in a)if(a[l]!==void 0&&a[l]!==null)return!0;return!1}(r))for(let a=0,l=(t||r).length;a<l;a++){let h=t?r[t[a]]:r[a];i.options.features==="id"&&i.getFeature&&(h=i.getFeature(h),h.layer=e),i instanceof En&&(h=pB(h,o)),s[t?t[a]:h[cB]]={feature:h,symbol:n}}return s}const ca="__original_properties",jo="__external_properties",fB={get:function(r,t){return t in r?r[t]:r[ca][t]||r[jo]&&r[jo][t]},has:function(r,t){return t in r||t in r[ca]||r[jo]&&t in r[jo]}},dB={};function pB(r,t){const e=r.properties;if(e&&e[ca])return r;t&&(r=Oe({},r)),r.customProps=r.customProps||{};const n=r.customProps;return n.$layer=r.layer,n.$type=r.type,n[ca]=e||dB,r.properties=new Proxy(n,fB),r}function jn(r){for(let t=1;t<arguments.length;t++){const e=arguments[t];for(const n in e)r[n]=e[n]}return r}function Jd(r,t,e){return Math.min(e,Math.max(t,r))}function LC(r,t,e){if(r===e||r===t)return r;const n=e-t;return((r-t)%n+n)%n+t}function wn(r){return r==null}function xv(r){return JSON.parse(JSON.stringify(r))}function ue(r,t,e,n,i,o){t in r||Object.defineProperty(r,t,{enumerable:!0,get:function(){const s=wn(e[n])||Ft(e[n])?i:e[n];return o?o(s):s}})}const Kd=[];function fa(r){for(let t=0;t<r.length;t++)Kd[t]=r[t],Kd[t]*=255;return r.length===3&&(Kd[3]=255),Kd}function xi(r,t=4){return gB.bind(this,r,t)}function gB(r,t,e){if(Array.isArray(e))return e.length===3&&t===4&&e.push(1),e;if(r&&r[e])return r[e];if(e.r!==void 0&&e.g!==void 0&&e.b!==void 0&&e.a!==void 0)return[e.r,e.g,e.b,e.a];const n=Wi(e).unitArray();return n.length===3&&t===4&&n.push(1),r&&(r[e]=n),n}function Xu(r,t,e,n){if(r.fill)r.fill(t,e,n);else for(let i=e;i<n;i++)r[i]=t}function _v(r){return typeof r=="number"&&!isNaN(r)}function Yu(r){return r&&(r.markerFile||r.markerType)&&r.textName!==void 0}function Qd(r,t){return Object.prototype.hasOwnProperty.call(r,t)}function tp(r,t){if(t){let e=r[r.length-1];const n=[e];for(let i=r.length-2;i>=0;i--)r[i]!==e&&(n.push(r[i]),e=r[i]);return n}{let e=r[r[0]];const n=[e];for(let i=1;i<r.length;i++)r[i]!==e&&(n.push(r[i]),e=r[i]);return n}}const mB=new at(0,0);function co(r,t,e,n,i){const o=r.distanceToPointAtRes(t,t,n,e,mB);return i?o.y:o.x}const bv=[],wv=[0,0,0,0],ep=new W(0,0),zC={color:wv,depth:1,stencil:0},da=r=>r.isTerrainSkin(),Av=r=>r.isTerrainVector();class np extends So.TileLayerCanvasRenderer{supportRenderMode(){return!0}constructor(t){super(t),this.ready=!1,this.B=1,this.X={},this.$={},this.q={}}getTileLevelValue(t,e){if(this.isBackTile(t.id)){const n=t.z,i=5;return n-e>=0?e+i-n:i+(e-n)}return 0}getWorkerConnection(){return this.K}getStyleCounter(){return this.B}setStyle(){if(this.J&&this.J.update(),this.K){this.B++,this.Z();const t=this.layer.tt();t.styleCounter=this.B,this.et=!0,this.K.updateStyle(t,e=>{if(this.et=!1,e)throw new Error(e);this.nt=!0,this.it(),this.setToRedraw(),this.layer.fire("refreshstyle")})}else this.it()}Z(){if(this.rt)for(const e in this.rt){const n=this.rt[e];n&&this.deleteTile(n)}this.rt=this.tilesInView;const t=this.tileCache;for(const e in this.rt){const n=this.rt[e];n&&n.info&&t.getAndRemove(n.info.id)}t.reset(),this.tilesInView={},this.tilesLoading={},this.X={},this._parentTiles=[],this._childTiles=[],this._tileZoom=void 0}updateOptions(t){this.K&&this.K.updateOptions(this.layer.getWorkerOptions(),e=>{if(e)throw new Error(e);t&&(t.features||t.pickingGeometry||t.altitudeProperty)&&(this.clear(),this.st(),this.it()),this.setToRedraw()})}updateSceneConfig(t,e,n){const i=t===0?this.ot():this.lt();if(!i||!i[e])return;this.nt=!0;const o=this.layer.tt(),s=this.layer.ht(t,o);i[e].config=s[e].renderPlugin,i[e].updateSceneConfig({sceneConfig:n}),this.setToRedraw()}updateDataConfig(t,e,n,i){const o=t===0?this.ot():this.lt();o&&o[e]&&(this.nt=!0,o[e].updateDataConfig(n,i)?this.setStyle():this.setToRedraw())}updateSymbol(t,e,n){const i=t===0?this.ot():this.lt();if(!i||!i[e])return!1;const o=this.layer.tt(),s=this.layer.ht(t,o),a=i[e];a.style=s[e];const l=a.updateSymbol(n,s[e].symbol);return!l&&HC(n)&&this.setStyle(),this.setToRedraw(),l}needToRedraw(){const t=super.needToRedraw();if(!t){const e=this.ut();for(let n=0;n<e.length;n++)if(e[n]&&e[n].needToRedraw())return!0}return t}needRetireFrames(){if(this.nt)return!0;const t=this.ut();for(let e=0;e<t.length;e++)if(t[e]&&t[e].needToRetireFrames())return!0;return!1}isAnimating(){const t=this.getMap().getRenderer(),e=t.getFrameTimestamp&&t.getFrameTimestamp()||t._frameTimestamp;if(this.ct&&(this.ft=e,delete this.ct),this.ft===e)return!0;const n=this.ut();for(let i=0;i<n.length;i++)if(n[i]&&n[i].isAnimating())return!0;return!1}needToRefreshTerrainTileOnZooming(){const t=this.ut();for(let e=0;e<t.length;e++)if(t[e]&&t[e].needToRefreshTerrainTileOnZooming())return!0;return!1}dt(){return!!(this.canvas&&this.canvas.gl&&this.canvas.gl.wrap)}createContext(){const t=this.canvas.gl&&this.canvas.gl.wrap;if(t)this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl;else{const{gl:e,regl:n,attributes:i}=this.yt(this.canvas);this.gl=e,this.regl=n,this.glOptions=i}if(t&&(this.canvas.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height)),this.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height),this.gt=new hB(this.regl,this.getMap()),this.xt(),this.J=new ed(this.regl,this.layer),!this.consumeTile){const e=this.getMap().VERSION;throw new Error(`Incompatible version of maptalks: ${e}, upgrade maptalks >= v1.0.0-rc.14`)}}yt(t){const e=this.layer,n=e.options.glOptions||{alpha:!0,depth:!0,antialias:this.layer.options.antialias};n.preserveDrawingBuffer=!0,n.stencil=!0;const i=this.vt(t,n);return{gl:i,attributes:n,regl:Xh({gl:i,attributes:n,extensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives"],optionalExtensions:e.options.glExtensions||["OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_draw_buffers","EXT_shader_texture_lod","EXT_frag_depth"]})}}xt(){this.K||(this.K=new aB("@maptalks/vt",this.layer)),this.K.addLayer((t,e)=>{this.layer&&(this.ready=!0,this.layer.onWorkerReady(t,e),this.layer.fire("workerready"),this.setToRedraw())})}clearCanvas(){super.clearCanvas(),this.regl&&(this.glOptions.depth?this.regl.clear({color:wv,depth:1,stencil:0}):this.regl.clear({color:wv,stencil:0}))}isDrawable(){return!0}checkResources(){return bv}_drawTiles(t,e,n,i,o){if(super._drawTiles(t,e,n,i,o),this.rt)if(Object.keys(this.rt).length)for(const s in this.rt){const a=this.rt[s];a&&a.info&&a.info.id&&!this.tileCache.has(a.info.id)&&this._drawTile(a.info,a.image,o)}else this.bt(),delete this.rt}bt(){const t=this.B,e=[],n=[];for(const i in this.$)+i!==t&&(e.push(i),this.ot(i).forEach(o=>{o.remove()}));for(const i in this.q)+i!==t&&(n.push(i),this.lt(i).forEach(o=>{o.remove()}));for(let i=0;i<e.length;i++)delete this.$[e[i]];for(let i=0;i<n.length;i++)delete this.q[n[i]]}draw(t,e){this.At!==t&&(this.nt=!1,this.wt());const n=this.layer;if(this.prepareCanvas(),!this.ready||!n.ready)return;let i=this.$[this.B];i||(this.it(),this.wt(),i=this.ot());const o=this.lt();n.isDefaultRender()||i.length||o.length?(n.options.collision&&n.clearCollisionIndex(),this._t=t,this.St=this.Mt(this.getMap().getGLRes()),this.Tt=e||{},this.Pt(t),super.draw(t),this.At!==t&&this.kt(t),this.It(t),this.At=t):this.completeRender()}wt(){this.ut().forEach((t,e)=>{t&&(t.renderIndex=e)})}kt(){const t=this.ut();this.Ot=this.Ot||[];let e=0;for(let n=t.length-1;n>=0;n--){const i=t[n];i.isVisible()&&i.hasMesh()&&(this.Ot[n]=e,i.needPolygonOffset()&&e++)}this.J.isEnable()&&e++,this.Ct=e}getFrameTimestamp(){return this._t}drawOnInteracting(t,e,n){this.draw(e,n)}drawOutline(t){(this.Ft||this.Et)&&(this.Et?this.paintOutlineAll(t):this.Ft.forEach(e=>{this[e[0]](t,...e[1])}))}getAnalysisMeshes(){return this.getShadowMeshes()}getShadowMeshes(){const t=[];return this.Dt().forEach(e=>{if(!e||!this.Lt(e))return;const n=e.getShadowMeshes();if(Array.isArray(n))for(let i=0;i<n.length;i++)t.push(n[i])}),t}isForeground(t){return!(!this.zt||!this.zt[t.properties.tile.id])}Rt(t){const e=this.layer;let n=e._getTileZoom(this.getMap().getZoom());const i=e.getMinZoom(),o=e.getMaxZoom();return n=Jr.clamp(n,i,o),n-t.properties.tile.z}isTileNearCamera(t){return this.Rt(t)<=1}isBackTile(t){return!(!this.Ht||!this.Ht[t])}loadTileQueue(t){this.et||super.loadTileQueue(t)}loadTile(t){const{url:e}=t,n=this.X[e];if(n)n.keys[t.id]||(n.tiles.push(t),n.keys[t.id]=1);else{const i=this.getMap(),o=ep.set(t.extent2d.xmin,t.extent2d.ymax),s=i.pointAtResToCoord(new W(o),t.res),a=[co(i,1,s,t.res)/100,co(i,1,s,t.res,1)/100],l=this.getCentimeterToPoint(t.z),h=this.getTileGLScale(t.z);this.X[e]={keys:{},tiles:[t]},this.X[e].keys[t.id]=1;const u=this.layer.options.fetchOptions,c=window&&window.location.href;this.K.loadTile({tileInfo:{res:t.res,x:t.x,y:t.y,z:t.z,url:t.url,id:t.id,extent2d:t.extent2d},glScale:h,zScale:this.St,centimeterToPoint:a,verticalCentimeterToPoint:l,fetchOptions:u,styleCounter:this.B,referrer:c},this.Nt.bind(this,e))}return{}}getTileGLScale(t){const e=this.getMap();return this.layer.getSpatialReference().getResolution(t)/e.getGLRes()}getCentimeterToPoint(t){const e=this.getMap();return Vl(this.layer.getSpatialReference().getResolution(t),e)}getRenderedFeatures(){const t=[],e=this.tileCache.keys();for(let n=0;n<e.length;n++){const i=this.tileCache.get(e[n]);if(!i||!i.info||!i.image)continue;const{info:o,image:s}=i,a=_B(s);t.push({tile:{id:o.id,x:o.x,y:o.y,z:o.z,url:o.url},current:!!this.tilesInView[o.id],features:a})}return t}Nt(t,e,n){if(this.setToRedraw(),!this.X[t]||n&&n.canceled)return;const i=this.layer,o=i.isDefaultRender(),{tiles:s}=this.X[t];if(delete this.X[t],e){if(e.status&&(e.status===404||e.status===204))for(let f=0;f<s.length;f++){const d=s[f];this.onTileError(lB,d)}return}if(!n){for(let f=0;f<s.length;f++){const d=s[f];this.consumeTile({Vt:!0},d)}return}if(n.styleCounter!==this.B)return;let a=!1;const l=n.features,h=[];for(let f=0;f<n.data.length;f++){const d=n.data[f];if(!d||!d.data||!d.styledFeatures.length)continue;const{isUpdated:p,layer:g}=this.jt(0,f,d,l,h);h.push(g),p&&(a=p)}for(let f=0;f<n.featureData.length;f++){const d=n.featureData[f];d&&d.data&&d.styledFeatures.length&&this.jt(1,f,d,l)}a&&i.Ut();const u=s[0].z,c=this.layer.getDataSchema(u);if(this.Gt(c,n.schema),delete n.features,o&&n.data.length!==h.length){const f=n.data;n.data=[];for(let d=0;d<f.length;d++)f[d]&&f[d].features&&n.data.push(f[d])}n.layers=h;for(let f=0;f<s.length;f++){const d=s[f];if(f===0&&i.options.debugTileData){const{x:g,y:m,z:y}=d;console.log("tile",{layerId:i.getId(),x:g,y:m,z:y,layers:vB(Object.values(l))})}const p=f===0?n:yB(n);for(let g=0;g<p.data.length;g++){if(!p.data[g])continue;const m=p.data[g].features;for(const y in m)m[y].tile=d}d.extent=p&&p.extent,p.features=Object.values(l),p.styleCounter=n.styleCounter,this.onTileLoad(p,d)}this.layer.fire("datareceived",{url:t})}jt(t,e,n,i){const{style:o,isUpdated:s}=this.Wt(t,e,n.data),a=this.layer,l=a.isDefaultRender(),h=o.symbol,u=FC(i,n.styledFeatures,e,h,a,!(!a.getData||!a.getData()));delete n.styledFeatures,n.features=u;let c=n.data;return Array.isArray(c)&&(c=c[0]),{isUpdated:s,layer:l?{layer:c.layer,type:c.type}:null}}Gt(t,e){for(const n in e){t[n]||(t[n]={types:e[n].types,properties:{}});const i=e[n].properties,o=t[n].properties;for(const s in i)(!o[s]||o[s]&&i[s]!=="object"&&o[s]==="object")&&(o[s]=i[s])}}Wt(t,e,n){Array.isArray(n)&&(n=n[0]);const i=this.layer;let o,s=!1;if(i.isDefaultRender()&&t===0){let a=this.Yt;a||(a=this.Yt={});const l=n.layer,h=n.type;a[l]||(a[l]=[]);const u=("plugin_"+h).trim();a[l][u]?o=a[l][u]:(o=this.Bt(h),o.filter=n.filter,a[l].push(o),a[l][u]=o,s=!0)}else{const a=i.tt(),l=i.ht(t,a),h=this.ot();if(o=l[e],!o.renderPlugin){s=!0;const{plugin:u,symbol:c,renderPlugin:f}=this.Bt(n.type);h[e]=u,o.symbol=c,o.renderPlugin=f}}return{style:o,isUpdated:s}}ut(t){const e=t&&t.style;let n=this.ot(e)||[];this.layer.isDefaultRender()&&this.Yt&&(n=[],t?t.layers&&t.layers.forEach(o=>{if(!o)return;const s=("plugin_"+o.type).trim();n.push(this.Yt[o.layer][s].plugin)}):Object.keys(this.Yt).forEach(o=>{for(let s=0;s<this.Yt[o].length;s++)n.push(this.Yt[o][s].plugin)}));const i=this.lt(e);return i&&i.length&&(n=n.slice(),ha(n,i)),n}Dt(){if(this.layer.isDefaultRender()&&this.Yt){const e=[];return Object.keys(this.Yt).forEach(n=>{for(let i=0;i<this.Yt[n].length;i++)e.push(this.Yt[n][i].plugin)}),e}const t=[];for(const e in this.$)t.push(...this.$[e]);for(const e in this.q)t.push(...this.q[e]);return t}ot(t){return er(t)&&(t=this.B),this.$[t]||bv}lt(t){return er(t)&&(t=this.B),this.q[t]||bv}Pt(t,e){const n=!!this.Xt,i=this.layer.isDefaultRender()&&this.Yt,o=this.Tt;this.Dt().forEach((s,a)=>{if(!s||e&&!e(s)||!this.Lt(a))return;const l=this.regl,h=this.gl,u=i?s.defaultSymbol:s.style&&s.style.symbol,c={regl:l,layer:this.layer,symbol:u,gl:h,isRenderingTerrain:n,sceneConfig:s.config?s.config.sceneConfig:null,dataConfig:s.config?s.config.dataConfig:null,pluginIndex:a,timestamp:t};o&&Oe(c,o),s.startFrame(c)})}It(t){const e=this.Tt,n=e.renderMode,i=e&&e.renderTarget&&e.renderTarget.fbo,o=this.getMap().cameraPosition,s=this.Dt(),a=!!this.Xt,l=!e.timestamp||e.isFinalRender;this.layer.options.collision&&!e.isPostProcess?s.forEach(c=>{if(!this.Lt(c)||!c.hasMesh()||n&&n!=="default"&&!c.supportRenderMode(n)||a&&!Av(c))return;const f=this.$t(c,0,o,t);c.prepareRender(f),c.updateCollision(f)}):s.forEach(c=>{if(!this.Lt(c)||!c.hasMesh()||n&&n!=="default"&&!c.supportRenderMode(n)||a&&!Av(c))return;const f=this.$t(c,0,o,t);c.prepareRender(f)});const h=this.At!==e.timestamp;let u=!1;if(h&&!a){const c=this.layer.getPolygonOffset()+this.layer.getPolygonOffsetCount(),f=this.$t(null,c,o,t);f.offsetFactor=c,f.offsetUnits=c,this.J.paint(f)}s.forEach((c,f)=>{if(!this.qt(c)||n&&n!=="default"&&!c.supportRenderMode(n)||a&&!Av(c))return;this.regl.clear({stencil:255,framebuffer:i});const d=this.Ot[f]||0,p=this.$t(c,d,o,t);c.painter&&c.painter.isEnableTileStencil(p)&&this.Kt(i,c.painter);const g=c.endFrame(p);g&&g.redraw&&this.setToRedraw(),u=!0}),u&&this.layer.fire("canvasisdirty"),l&&this.Jt()}getPolygonOffsetCount(){return this.Ct||0}Jt(){if(this.layer.options.debug){const t=this.Tt,e=[],n=this.getMap().projViewMatrix;for(const i in this.tilesInView){const o=this.tilesInView[i].info,s=this.tilesInView[i].image;if(s.Vt)continue;const a=o.transform,l=s.extent,h=t&&t.renderTarget;if(a&&l){const u=this.getDebugInfo(o.id),c=qt(e,n,a),f=this.layer.getTileSize().width;this.gt.draw(u,c,f,l,h&&h.fbo)}}}}qt(t){if(!t)return!0;const e=this.Tt,n=this.Lt(t),i=e&&e.states&&e.states.includesChanged,o=this.Zt(t.painter.scene.getMeshes());return!n||!i&&!o?0:o?2:1}$t(t,e,n,i){const o=!!this.Xt,s=o&&t&&da(t),a=this.regl,l=this.gl,h={regl:a,layer:this.layer,gl:l,isRenderingTerrain:o,isRenderingTerrainSkin:s,sceneConfig:t&&t.config.sceneConfig,pluginIndex:t&&t.renderIndex,polygonOffsetIndex:e,cameraPosition:n,timestamp:i},u=this.Tt;return u&&Oe(h,u),h}Zt(t){if(!t)return!1;const e=this.Tt&&this.Tt.sceneFilter;return e?t.filter(n=>e(n)||n.properties.hlBloomMesh&&e(n.properties.hlBloomMesh)).length>0:t.length>0}Kt(t,e){const n=e.isUniqueStencilRefPerTile(),i=this.getCurrentTileZoom();let o=this.Qt;o||(o=this.Qt=new uB(this.regl,this.canvas,this.getMap())),o.start();const{tiles:s}=this.te;let{parentTiles:a,childTiles:l}=this.te,h=1;l=l.sort(Tv);for(let c=0;c<l.length;c++){const f=n?h:this.getTileLevelValue(l[c].info,i);this.ee(l[c].info,f),h++}a=a.sort(Tv);for(let c=0;c<a.length;c++){const f=n?h:this.getTileLevelValue(a[c].info,i);this.ee(a[c].info,f),h++}const u=s.sort(Tv);for(let c=u.length-1;c>=0;c--){const f=n?h:this.getTileLevelValue(u[c].info,i);this.ee(u[c].info,f),h++}o.render(t)}ee(t,e){const n=ep.set(t.extent2d.xmin,t.extent2d.ymax),i=t.transform=t.transform||this.calculateTileMatrix(n,t.z,t.extent);t.stencilRef=e,this.Qt.add(e,t.extent,i)}onDrawTileStart(t){super.onDrawTileStart(t);const{tiles:e,childTiles:n,parentTiles:i}=t;this.zt={},this.Ht={};for(let o=0;o<e.length;o++)this.zt[e[o].info.id]=1;for(let o=0;o<n.length;o++)this.Ht[n[o].info.id]=1;for(let o=0;o<i.length;o++)this.Ht[i[o].info.id]=1;this.te=t}isEnableTileStencil(){if(this.layer.options.altitude)return!1;const t=this.ut();for(let e=0;e<t.length;e++)if(t[e]&&t[e].painter&&!t[e].painter.isOnly2D())return!1;return!0}setTerrainHelper(t){this.Xt=t}getTerrainHelper(){return this.Xt}drawTileOnTerrain(...t){np.prototype.drawTile.call(this,...t)}createTerrainTexture(t){const e=this.layer.getTileSize().width,n=2*e,i=2*e,o=t.texture({min:"linear",mag:"linear",type:"uint8",width:n,height:i});this.ne||(this.ne=t.renderbuffer({width:n,height:i,format:"depth24 stencil8"}));const s={width:n,height:i,colors:[o],colorFormat:"rgba",ignoreStatusCheck:!0};s.depthStencil=this.ne;const a=t.framebuffer(s);return a.colorTex=o,a}deleteTerrainTexture(t){t.destroy(),t.colorTex&&(t.colorTex.destroy(),delete t.colorTex)}renderTerrainSkin(t,e,n){const i=this.At,o=this.Tt,s=this.layer.getTileSize().width;this.Pt(i);for(let a=0;a<n.length;a++){const l=n[a].texture;this.Tt={renderTarget:{fbo:l}},zC.framebuffer=l,t.clear(zC),this.Tt.viewport=xB(s),this.ie(n[a].tile,l)}this.re(n),this.Tt=o}ie(t){const{info:e,image:n}=t;this.drawTile(e,n,da)}re(t){const e=this.Dt(),n=this.getMap().cameraPosition,i=this.At||0;this.layer.options.collision?e.forEach(o=>{if(!this.Lt(o)||!o.hasMesh()||!da(o)||!this.layer.options.awareOfTerrain)return;const s=this.$t(o,0,n,i);s.isRenderingTerrainSkin=!0,o.prepareRender(s),o.updateCollision(s)}):e.forEach(o=>{if(!this.Lt(o)||!o.hasMesh()||!da(o)||!this.layer.options.awareOfTerrain)return;const s=this.$t(o,0,n,i);s.isRenderingTerrainSkin=!0,o.prepareRender(s)}),e.forEach((o,s)=>{if(!this.qt(o)||!da(o))return;for(let h=0;h<t.length;h++){const u=t[h].texture;this.regl.clear({stencil:255,framebuffer:u})}const a=this.Ot[s]||0,l=this.$t(o,a,[0,0,0],this.At);l.isRenderingTerrainSkin=!0,o.endFrame(l)})}drawTile(t,e,n){if(!e.cache)return;const i=!!this.Xt,o=e.cache,s=ep.set(t.extent2d.xmin,t.extent2d.ymax),a=t.transform=t.transform||this.calculateTileMatrix(s,t.z,t.extent),l=t.tileTranslationMatrix=t.tileTranslationMatrix||this.calculateTileTranslationMatrix(s,t.z),h=t.terrainTransform=t.terrainTransform||this.calculateTerrainTileMatrix(s,t.z,t.extent),u=this.Tt,c=[];ha(c,e.data),ha(c,e.featureData),this.ut(e).forEach((f,d)=>{if(!f||n&&!n(f)||!c[d]||!o[d])return;const p=i&&da(f),g=this.regl,m=this.gl,y={regl:g,layer:this.layer,gl:m,sceneConfig:f.config.sceneConfig,pluginIndex:d,tileCache:o[d],tileData:c[d],tileTransform:p?h:a,tileVectorTransform:a,tileTranslationMatrix:l,tileExtent:e.extent,timestamp:this._t,tileInfo:t,tileZoom:this._tileZoom,bloom:this.Tt&&this.Tt.bloom,isRenderingTerrain:i,isRenderingTerrainSkin:p};p&&u&&u.renderTarget&&(y.renderTarget=u.renderTarget);const x=f.paintTile(y);!this.nt&&(x.retire||x.redraw)&&f.supportRenderMode("taa")&&(this.nt=!0),x.redraw&&this.setToRedraw()}),e&&e.style===this.B&&this.se(t),this.setCanvasUpdated()}oe(t,e){if(!e.loadTime||e.Vt)return;let n=e.cache;n||(n=e.cache={});const i=!!this.Xt,o=ep.set(t.extent2d.xmin,t.extent2d.ymax),s=t.transform=t.transform||this.calculateTileMatrix(o,t.z,e.extent),a=t.tileTranslationMatrix=t.tileTranslationMatrix||this.calculateTileTranslationMatrix(o,t.z),l=t.terrainTransform=t.terrainTransform||this.calculateTerrainTileMatrix(o,t.z,t.extent),h=[];ha(h,e.data),ha(h,e.featureData),this.ut(e).forEach((u,c)=>{if(!u||!h[c])return;const f=i&&da(u),d=this.regl,p=this.gl;n[c]||(n[c]={});const g={regl:d,layer:this.layer,gl:p,sceneConfig:u.config.sceneConfig,pluginIndex:c,tileCache:n[c],tileData:h[c],tileTransform:f?l:s,tileVectorTransform:s,isRenderingTerrain:i,isRenderingTerrainSkin:f,tileTranslationMatrix:a,tileExtent:e.extent,timestamp:this._t,tileInfo:t,tileZoom:this._tileZoom},m=u.createTile(g);n[c].geometry&&(e.data[c]=1),!this.nt&&m.retire&&u.supportRenderMode("taa")&&(this.nt=!0)})}checkTileInQueue(t){return t.styleCounter===this.B}pick(t,e,n){const i=[];return this.layer.isVisible()&&this.ut().forEach(o=>{if(!o||!this.Lt(o))return;const s=o.pick(t,e,n.tolerance);s&&(s.type=o.getType(),i.push(s))}),i}deleteTile(t){if(t){if(t.image&&!t.image.Vt){const e=t.image&&t.image.style,n=this.ot(e);n&&n.forEach((i,o)=>{i&&i.deleteTile({pluginIndex:o,regl:this.regl,layer:this.layer,gl:this.gl,tileCache:t.image.cache?t.image.cache[o]:{},tileInfo:t.info,tileData:t.image})}),t.image.cache={}}t.info&&(delete t.info.completeTerrainQuery,delete t.info.terrainQueryStatus),super.deleteTile(t)}}abortTileLoading(t,e){e&&e.url&&(this.K&&this.K.abortTile(e.url),delete this.X[e.url]),super.abortTileLoading(t,e)}resizeCanvas(t){super.resizeCanvas(t);const e=this.canvas;e&&(!this.pickingFBO||this.pickingFBO.width===e.width&&this.pickingFBO.height===e.height||(this.pickingFBO.resize(e.width,e.height),this.ut().forEach(n=>{n&&n.resize(e.width,e.height)})))}onRemove(){this.Qt&&this.Qt.remove(),this.K&&(this.K.removeLayer(t=>{if(t)throw t}),this.K.remove(),delete this.K),this.pickingFBO&&(this.canvas.pickingFBO||this.pickingFBO.destroy(),delete this.pickingFBO),this.gt&&(this.gt.delete(),delete this.gt),this.ne&&(this.ne.destroy(),delete this.ne),this.J&&(this.J.dispose(),delete this.J),super.onRemove&&super.onRemove(),this.st()}st(){this.Dt().forEach(t=>{t.remove()}),this.plugins={}}hitDetect(t){if(!this.gl||!this.layer.options.hitDetect)return!1;const e=this.gl,n=new Uint8Array(4),i=this.canvas.height;return e.readPixels(t.x,i-t.y,1,1,e.RGBA,e.UNSIGNED_BYTE,n),n[3]>0}it(){const{style:t,featureStyle:e}=this.layer.tt(),n=t.map((s,a)=>{const l=s.renderPlugin;if(!l)return null;if(!l.type)throw new Error("invalid plugin type for style at "+a);const h=this.ae(l);return h.styleCounter=this.B,h.style=s,h}),i=[];e.forEach((s,a)=>{const l=s.renderPlugin;if(!l)return null;if(!l.type)throw new Error("invalid plugin type for features at "+a);const h=this.ae(l);return h.style=s,h.styleCounter=this.B,i.push(h),h});const o=this.B;return this.$[o]=n,this.q[o]=i,this.layer.fire("pluginsinited"),(this.le&&this.le.size||this.layer.le)&&(this.layer.le&&this.layer.he(),this.getMap().getRenderer().callInNextFrame(()=>{this.ut().forEach(s=>{s.highlight(this.le)})})),n}ae(t){const e=this.layer.constructor.getPlugins()[t.type];if(!e)throw new Error(`Plugin for (${t.type}) is not loaded.`);const n=new e;return n.config=t,n.config.sceneConfig||(n.config.sceneConfig={}),n}vt(t,e){const n=["webgl","experimental-webgl"];let i=null;for(let o=0;o<n.length;++o){try{i=t.getContext(n[o],e)}catch{}if(i)break}return i}Mt(t){return Vl(t,this.getMap())}debugFBO(t,e){const n=document.getElementById(t),i=e.width,o=e.height;n.width=i,n.height=o;const s=n.getContext("2d"),a=this.regl.read({framebuffer:e}),l=o/2|0,h=4*i;for(let f=0;f<a.length;f++)a[f]*=255;const u=new Uint8Array(4*i);for(let f=0;f<l;++f){const d=f*h,p=(o-f-1)*h;u.set(a.subarray(d,d+h)),a.copyWithin(d,p,p+h),a.set(u,p)}const c=new ImageData(i,o);c.data.set(a),s.putImageData(c,0,0)}Bt(t){let e;switch(t){case"native-line":e={type:"native-line",dataConfig:{type:"native-line",only2D:!0}};break;case"native-point":e={type:"native-point",dataConfig:{type:"native-point",only2D:!0}};break;case"fill":e={type:"fill",dataConfig:{type:"fill",only2D:!0},sceneConfig:{antialias:!0}};break;default:e=null}const n=function(o){switch(o){case"native-point":return{markerFill:"#f00",markerSize:6,markerOpacity:.5};case"native-line":return{lineColor:"#bbb",lineOpacity:.5};case"fill":return{polygonFill:"#76a6f0",polygonOpacity:.8}}return null}(t),i=this.ae(e);return i.defaultSymbol=n,{plugin:i,symbol:n,renderPlugin:e}}Lt(){return!0}isEnableWorkAround(t){return t==="win-intel-gpu-crash"&&this.layer.options.workarounds["win-intel-gpu-crash"]&&function(e){const n=e.getExtension("WEBGL_debug_renderer_info");if(n&&typeof navigator<"u"){const i=e.getParameter(n.UNMASKED_RENDERER_WEBGL),o=navigator.platform==="Win32"||navigator.platform==="Win64";if(i&&i.toLowerCase().indexOf("intel")>=0&&o)return!0}return!1}(this.gl)}getZScale(){return this.St}outline(t,e){e&&(Array.isArray(e)||(e=[e]),this.Ft||(this.Ft=[]),this.Ft.push(["paintOutline",[t,e]]),this.setToRedraw())}outlineFeatures(t){t&&(Array.isArray(t)||(t=[t]),this.Ft||(this.Ft=[]),this.Ft.push(["paintOutline",[null,t]]),this.setToRedraw())}outlineBatch(t){this.Ft||(this.Ft=[]),this.Ft.push(["paintBatchOutline",[t]]),this.setToRedraw()}outlineAll(){this.Et=!0,this.setToRedraw()}paintOutlineAll(t){const e=this.ut();for(let n=0;n<e.length;n++)e[n].outlineAll(t)}paintOutline(t,e,n){if(!er(e)){const o=e,s=this.ut();return!s[o]||s[o].painter&&!s[o].painter.isVisible()?void 0:void s[o].outline(t,n)}const i=this.ut();for(let o=0;o<n.length;o++){const s=n[o];for(let a=0;a<i.length;a++)i[a].style&&i[a].style.id===s&&i[a].outline(t,[s])}}paintBatchOutline(t,e){const n=this.ut();!n[e]||n[e].painter&&!n[e].painter.isVisible()||n[e].outlineAll(t)}cancelOutline(){delete this.Ft,delete this.Et,this.setToRedraw()}setZIndex(){return this.setToRedraw(),this.nt=!0,super.setZIndex.apply(this,arguments)}consumeTile(t,e){if(this.se(e),super.consumeTile(t,e),this.layer.options.features==="transient"&&t.data){for(let n=0;n<t.data.length;n++){if(!t.data[n])continue;const i=t.data[n].features;if(i)for(const o in i){const s=i[o]&&i[o].feature;s&&(s.fnTypeProps?s.customProps[ca]=s.fnTypeProps:i[o]=null)}}this.layer.fire("_transientfeature",{tileImage:t})}t&&t.features&&(t.features=[]),this.oe(e,t)}onTileError(t,e){this.se(e),super.onTileError(t,e)}se(t){const{id:e}=t;if(this.rt&&this.rt[e]){const n=this.rt[e];this.deleteTile(n),delete this.rt[e]}}highlight(t){if(this.le||(this.le=new Map),Array.isArray(t))for(let e=0;e<t.length;e++)er(t[e].name)&&!er(t[e].id)&&(t[e]=Oe({},t[e]),t[e].name=t[e].id),this.le.set(t[e].name,t[e]);else er(t.name)&&!er(t.id)&&((t=Oe({},t)).name=t.id),this.le.set(t.name,t);this.ut().forEach(e=>{e.highlight(this.le)}),this.ct=!0}cancelHighlight(t){if(this.le){if(Array.isArray(t))for(let e=0;e<t.length;e++)this.le.delete(t[e]);else this.le.delete(t);this.ut().forEach(e=>{e.highlight(this.le)}),this.ct=!0}}cancelAllHighlight(){this.le&&(delete this.le,this.ut().forEach(t=>{t.cancelAllHighlight()}),this.ct=!0)}ue(){const t=this.layer.options.opacity;return this.dt()?er(t)?1:t:1}}function yB(r){let t;Array.isArray(r.data)?(t=[],ha(t,r.data)):(t={},Oe(t,r.data));const e=Oe({},r);return e.data=t,e}function Tv(r,t){return t.info.z-r.info.z}function vB(r){const t={};for(let e=0;e<r.length;e++){const n=r[e].layer||"default";t[n]||(t[n]=[]),t[n].push(r[e])}return t}function HC(r){if(Array.isArray(r)){const t=r;for(let e=0;e<t.length;e++)if(HC(t[e]))return!0}for(const t in r)if(Ft(r[t])||Lu.isExpression(r[t]))return!0;return!1}function xB(r){return{x:0,y:0,width:2*r,height:2*r}}function _B(r){if(!r.cache)return[];for(const t in r.cache){const e=r.cache[t];if(e.geometry)for(let n=0;n<e.geometry.length;n++){const i=e.geometry[n]&&e.geometry[n].geometry;if(i&&i.properties&&i.properties.features){const o=i.properties.features.empty;delete i.properties.features.empty;const s=Object.values(i.properties.features);return o!==void 0&&(i.properties.features.empty=o),s}}}return[]}np.include({calculateTileMatrix:function(){const r=new Array(3),t=new Array(3),e=new Array(3);return function(n,i,o){const s=this.getTileGLScale(i),a=n,l=this.layer.getTileSize().width,h=mn([]);return so(h,h,ie(r,s,s,this.St)),oo(h,h,ie(t,a.x,a.y,0)),so(h,h,ie(e,l/o,-l/o,1)),h}}(),calculateTerrainTileMatrix:function(){const r=new Array(3);return function(t,e,n){const i=mn([]),o=n/2;return so(i,i,ie(r,1/o,-1/o,0)),oo(i,i,ie(r,-o,-o,0)),i}}(),calculateTileTranslationMatrix:function(){const r=new Array(3);return function(t,e){const n=this.getTileGLScale(e),i=t,o=mn([]);return oo(o,o,ie(r,i.x*n,i.y*n,0)),o}}()});const rp=new W(0,0),NC=new at(0,0),Ul=[null,0],bB=[];class dn extends En{static loadFrom(t,e){return fetch(t,e||{}).then(n=>n.json()).then(n=>dn.fromJSON(n))}constructor(t,e){super(t,e),this.ce={},this.VERSION=dn.VERSION;const n=e&&e.style;this.setStyle(n)}setURLModifier(t){this.fe=t;const e=this.getRenderer();return e&&e.updateOptions(),this}getURLModifier(){return this.fe}onAdd(){const t=this.getMap();this.de();const e=this.getSpatialReference().toJSON().projection,n=t.getSpatialReference().toJSON().projection;if((e&&e.toLowerCase())!==(n&&n.toLowerCase()))throw new Error(`VectorTileLayer's projection(${e}) must be the same with map(${n}).`)}setFeatureState(t,e){if(er(t.id))throw new Error("missing id in first parameter of setFeatureState.");this.pe||(this.pe={});const n=t.layer||"0";let i=this.pe[n];return this.pe[n]||(i=this.pe[n]=new Map),i.set(t.id,e),this.me(),this}removeFeatureState(t,e){if(er(t.id))throw new Error("missing id in first parameter of removeFeatureState.");if(!this.pe)return this;const n=t.layer||"0",i=this.pe[n];if(!i)return this;if(e){const o=i.get(t.id);if(Zu(e))for(const s in e)delete o[s];else delete o[e];i.set(t.id,o)}else i.delete(t.id);return this.me(),this}getFeatureState(t){if(er(t.id))throw new Error("missing id in first parameter of getFeatureState.");if(!this.pe)return null;const e=t.layer||"0";return this.pe[e].get(t.id)}me(){const t=this.getRenderer();if(!t)return;const e=t.getFrameTimestamp();this.ye=e}ge(){return this.ye}xe(t){return this.ye&&this.ye!==t}de(){const t=this.options,e=this.getMap().getProjection(),n=e.code==="EPSG:4326"||e.code==="EPSG:4490",i=e.code==="EPSG:3857";t.spatialReference||this.getTileSize().width===512&&(i?t.spatialReference="preset-vt-3857":n&&(t.spatialReference="preset-vt-4326")),t.tileSystem||(t.tms?i?t.tileSystem=[1,1,-6378137*Math.PI,-6378137*Math.PI]:n&&(t.tileSystem=[1,1,-180,-90]):n&&(t.tileSystem=[1,-1,-180,90]))}onWorkerReady(){}onConfig(t){const e=this.getRenderer();e&&e.updateOptions(t)}getWorkerOptions(){return{debug:this.options.debug,debugTile:this.options.debugTile,altitudeProperty:this.options.altitudeProperty,tileSize:this.getTileSize().width,style:this.isDefaultRender()?{style:[],featureStyle:[]}:this.tt(),features:this.options.debugTileData||this.options.features,schema:this.options.schema,pickingGeometry:this.options.pickingGeometry,projectionCode:this.getSpatialReference().getProjection().code,workerGlyph:this.options.workerGlyph&&!this.getURLModifier(),featureIdProperty:this.options.featureIdProperty}}setStyle(t){if(t&&(Bo(t)||t.url)){const e=t,n=e.lastIndexOf("/"),i=n<0?".":e.substring(0,n);return this.ready=!1,xs.getJSON(t.url?t.url:t,t.url?t:{},(o,s)=>{if(o)throw this.setStyle([]),o;let a;s.style?(a=s,a.$root||(a.$root=i)):a={$root:i,style:s},this.options.style=e,this.ve(a)}),this}return this.options.style=t,this.ve(t),this}be(t,e,n,i){const o=i/this.getTileSize().width;return t.set(n.x+e.x/o,n.y-e.y/o)}queryTilePointTerrain(t,e,n,i,o){const s=this.getRenderer(),a=s&&s.getTerrainHelper();if(!s||!a)return Ul[0]=null,Ul[1]=0,Ul;const l=this.be(rp,t,n,i);return e&&a.queryTileTerrainByPointAtRes?a.queryTileTerrainByPointAtRes(l,o,e.id,e,bB):(Ul[0]=null,Ul[1]=0,Ul)}queryTerrainTiles(t){const e=this.getRenderer(),n=e&&e.getTerrainHelper();return e&&n?n.getTerrainTiles(t):null}ve(t){if(t&&t.$root){let i=t.$root;i&&i[i.length-1]==="/"&&(i=i.substring(0,i.length-1)),this.Ae=function(o){return o==="{$root}"?i:null}}this.ready=!0,t=t||[],Array.isArray(t)?t={style:t}:t.renderPlugin&&(t={style:[t]}),t=function(i){if(!i.plugins)return i;const{plugins:o,styles:s}=i;let{style:a,featureStyle:l}=s;a=a||[],l=l||[];const h=new Array(a.length);for(let f=0;f<a.length;f++)h[f]=Oe({},a[f]),h[f].renderPlugin=o[a[f].renderPlugin];const u=new Array(l.length);for(let f=0;f<l.length;f++)u[f]=Oe({},l[f]),u[f].renderPlugin=o[l[f].renderPlugin];const c={style:h,featureStyle:u};return i.$root&&(c.$root=i.$root),c}(t=JSON.parse(JSON.stringify(t))),this.we=t.featureStyle||[],this._e=function(i){if(!i||!Array.isArray(i))return[];const o=[];for(let s=0;s<i.length;s++){const a=i[s].style;if(a&&Array.isArray(a)&&a.length)for(let l=0;l<a.length;l++){const h=Oe({},i[s],a[l]);a[l].Se=o.length,delete h.style,o.push(h)}else o.push(Oe({},i[s]))}return o}(t.featureStyle),this.Me=t.style||[];const e=t.background||{};this.Te={enable:e.enable||!1,color:wB(e.color)||[0,0,0,0],opacity:AB(e.opacity,1),patternFile:e.patternFile,depthRange:e.depthRange},this.validateStyle(),this.Ae&&this.Pe(),this.Ut();const n=this.getRenderer();n&&n.setStyle(),this.fire("setstyle",{style:this.getStyle(),computedStyle:this.getComputedStyle()})}getPolygonOffsetCount(){const t=this.getRenderer();return t?t.getPolygonOffsetCount():0}getPolygonOffset(){return this.ke||0}setPolygonOffset(t,e){return this.ke=t,this.Ie=e,this}getTotalPolygonOffset(){return this.Ie}Oe(t){if(!t||!t.length)return;const e=this._getTileConfig();let n;for(let i=0,o=t.length;i<o;i++){const{feature:s,tile:a}=t[i],l=s.geometry;if(!s||!a||!l||l.type)continue;const{x:h,y:u,res:c,extent:f}=a;h===void 0&&u===void 0&&c===void 0||(n=e.getTilePointNW(h,u,c));const d=s.type,p=this.Ce(d,l,n,f,c);s.geometry=p}}getRenderedFeatures(){const t=this.getRenderer();if(!t)return[];const e=t.getRenderedFeatures()||[];for(let n=0,i=e.length;n<i;n++){const o=e[n];if(!o)continue;const s=o.features||[];this.Oe(s)}return e}getRenderedFeaturesAsync(t={}){return new Promise((e,n)=>{const i=this.getRenderer();if(i)if(Jx){const o=i.getRenderedFeatures()||[],s=[];o.forEach(c=>{const f=c.features||[];f.length&&ha(s,f)});const a=(t=Object.assign({},{countPerTime:1e4},t)).countPerTime,l=Math.ceil(s.length/a);let h=1;const u=()=>{const c=(h-1)*a,f=h*a,d=s.slice(c,f);this.Oe(d),h++};Jx.runTaskAsync({count:l,run:u}).then(()=>{e(o)})}else e(this.getRenderedFeatures());else e([])})}outlineAll(){const t=this.getRenderer();return t?(t.outlineAll(),this):this}outline(t,e){const n=this.getRenderer();return n?(n.outline(t,e),this):this}outlineBatch(t){const e=this.getRenderer();return e?(e.outlineBatch(t),this):this}outlineFeatures(t){const e=this.getRenderer();return e?(e.outlineFeatures(t),this):this}cancelOutline(){const t=this.getRenderer();return t?(t.cancelOutline(),this):this}highlight(t){this.Fe(t);const e=this.getRenderer();return e?(e.highlight(t),this):(this.le||(this.le=[]),this.le.push(t),this)}Fe(t){if(Array.isArray(t))for(let e=0;e<t.length;e++)this.Fe(t[e]);else{if(t.filter){if(!this.options.features)throw new Error("options.features must be turned on to support filter in highlight");if(!t.name)throw new Error("A name is required for highlight with filter")}if(er(t.filter)&&er(t.id))throw new Error("id or filter must be provided for highlight")}}he(){if(this.le){for(let t=0;t<this.le.length;t++)this.highlight(this.le[t]);delete this.le}}cancelHighlight(t){const e=this.getRenderer();return e?(e.cancelHighlight(t),this):this}cancelAllHighlight(){const t=this.getRenderer();return t?(t.cancelAllHighlight(),this):this}Pe(){Jr.convertStylePath(this.Me,this.Ae),Jr.convertStylePath(this._e,this.Ae)}updateSceneConfig(t,e){return Bo(t)&&(t=this.Ee(t)),this.De(0,t,e)}updateFeatureSceneConfig(t,e,n){return this.De(1,t,n,e)}De(t,e,n,i){const o=this.ht(t);if(!o)return this;let s,a=e;if(o[e].renderPlugin.sceneConfig||(o[e].renderPlugin.sceneConfig={}),Oe(o[e].renderPlugin.sceneConfig,n),i!==void 0){$l(this.we,e,i),a=this.we[e].style[i].Se;const h=o[a].renderPlugin;h.sceneConfig||(h.sceneConfig={}),s=h.sceneConfig}else qu(o,e),s=o[e].renderPlugin.sceneConfig;if(Oe(s,n),Array.isArray(this.options.style)){const h=this.options.style[e].renderPlugin;h.sceneConfig||(h.sceneConfig={}),Oe(h.sceneConfig,n)}else{const h=this.ht(t,this.options.style);let u;i!==void 0?($l(h,e,i),u=h[e].style[i].renderPlugin):(qu(h,e),u=h[e].renderPlugin),u.sceneConfig||(u.sceneConfig={}),Oe(u.sceneConfig,n)}const l=this.getRenderer();return l&&l.updateSceneConfig(t,a,n),t===0?this.fire("updatesceneconfig",{index:e,sceneConfig:n}):t===1&&this.fire("updatefeaturesceneconfig",{index:e,styleIdx:i,sceneConfig:n}),this}updateDataConfig(t,e){return Bo(t)&&(t=this.Ee(t)),this.Le(0,t,e)}updateFeatureDataConfig(t,e,n){return this.Le(1,t,n,e)}Le(t,e,n,i){const o=this.ht(t);if(!o)return this;let s,a=e;i!==void 0?($l(this.we,e,i),a=this.we[e].style[i].Se,s=o[a].renderPlugin.dataConfig):(qu(o,e),s=o[e].renderPlugin.dataConfig);const l=Oe({},s);if(Oe(s,n),Array.isArray(this.options.style))Oe(this.options.style[e].renderPlugin.dataConfig,n);else{const u=this.ht(t,this.options.style);let c;i!==void 0?($l(u,e,i),c=u[e].style[i].renderPlugin):(qu(u,e),c=u[e].renderPlugin),c.dataConfig||(c.dataConfig={}),Oe(c.dataConfig,n)}const h=this.getRenderer();return h&&h.updateDataConfig(t,a,n,l),t===0?this.fire("updatedataconfig",{index:e,dataConfig:n}):t===1&&this.fire("updatefeaturedataconfig",{index:e,styleIdx:i,dataConfig:n}),this}updateSymbol(t,e){return Bo(t)&&(t=this.Ee(t)),this.ze(0,t,e)}updateFeatureSymbol(t,e,n){return this.ze(1,t,n,e)}ze(t,e,n,i){const o=this.ht(t);if(!o)return this;let s=e;i!==void 0&&($l(this.we,e,i),s=this.we[e].style[i].Se);const a=o[s];if(!a)throw new Error(`No style defined at ${e}`);const l=this,h=this.Ae;function u(p,g,m){if(!p)return!1;h&&(p=JSON.parse(JSON.stringify(p)),Jr.parseSymbolPath(p,h));const y=Object.keys(p);let x=!1;for(let w=0;w<y.length;w++){const b=y[w];if(BC(g[b])||BC(p[b])){x=!0;break}}for(const w in p)jl(p,w)&&(!Jr.isObject(p[w])||Array.isArray(p[w])||Ft(p[w])?g[w]=p[w]:(g[w]||(g[w]={}),Oe(g[w],p[w])));let v=l.options.style;if(Bo(v))return x;Array.isArray(v)||(v=l.ht(t,l.options.style));const _=JSON.parse(JSON.stringify(g));return i!==void 0?($l(v,e,i),m===void 0?v[e].style[i].symbol=_:v[e].style[i].symbol[m]=_):(qu(v,e),m===void 0?v[e].symbol=_:v[e].symbol[m]=_),x}const c=this.getRenderer();if(!c)return u(),this.Ut(),this;let f=!1;const d=a.symbol;if(Array.isArray(n))for(let p=0;p<n.length;p++){const g=u(n[p],d[p],p);g&&(f=g)}else u(n,d);return this.Ut(),f?c.setStyle():(f=c.updateSymbol(t,s,n),f&&c.setStyle()),t===0?this.fire("updatesymbol",{index:e,symbol:n}):t===1&&this.fire("updatefeaturesymbol",{index:e,featureStyleIndex:i,symbol:n}),this}ht(t,e){return e?t===0?e.style:e.featureStyle:t===0?this.Me:this._e}isDefaultRender(){return!!this.Re&&this.options.defaultRendering}validateStyle(){this.Re=!1;let t=this.Me;this.options.style||(this.Re=!0,t=this.Me=[]),Array.isArray(t)||(t=this.Me=[t]);for(let e=0;e<t.length;e++){let n=t[e].filter;if(n&&n.value&&(n=n.value),n||console.warn(`render plugin at ${e} doesn't define filter, its filter will be set to 'default' by default.`),n!==void 0&&n!=="default"&&n!==!0&&!Array.isArray(n)&&n.condition===void 0)throw new Error(`Invalid filter at ${e} : ${JSON.stringify(n)}`)}}getStyle(){return this.options.style?JSON.parse(JSON.stringify(this.options.style)):null}Ee(t){const e=this.Me;if(!e)return-1;for(let n=0;n<e.length;n++)if(e[n].name===t)return n;throw new Error(`No style defined with name: ${t}`)}getGroundConfig(){this.He||(this.He={enable:!0,renderPlugin:{type:"fill",sceneConfig:{}},symbol:{polygonFill:[0,0,0,0],polygonOpacity:1}});const t=this.tt().background||{};return this.He.enable=t.enable,this.He.symbol.polygonFill=t.color,this.He.symbol.polygonOpacity=t.opacity,this.He.symbol.polygonPatternFile=t.patternFile,this.He.renderPlugin.sceneConfig.depthRange=t.depthRange,this.He}getComputedStyle(){return JSON.parse(JSON.stringify(this.tt()))}tt(){return{background:this.Te,style:this.Me||[],featureStyle:this._e||[]}}identify(t,e={}){const n=this.getMap(),i=this.getRenderer();if(!n||!i)return[];const o=n.coordToContainerPoint(new at(t));return this.identifyAtPoint(o,e)}identifyAtPoint(t,e={}){const n=this.getMap(),i=this.getRenderer();if(!n||!i)return[];const o=n.getDevicePixelRatio();let s=i.pick(t.x*o,t.y*o,e);return this.options.features&&this.options.features!=="id"&&(s=this.Ne(s)),e&&e.filter?s.filter(a=>e.filter(a)):s}Ne(t){if(!this.getRenderer())return t;const e=this._getTileConfig(),n=this.getSpatialReference();for(let i=0;i<t.length;i++){let o=t[i];if(!o||!o.data)continue;const{tile:s}=o.data,{x:a,y:l,z:h,extent:u}=s,c=n.getResolution(h),f=e.getTilePointNW(a,l,c),d=o.data.feature&&o.data.feature.geometry;if(d){o.data=Oe({},o.data),o.data.feature=Oe({},o.data.feature);const p=o.data.feature.type;o.data.feature.type="Feature",o.data.feature.geometry=this.Ce(p,d,f,u,c)}}return t}Ce(t,e,n,i,o){if(e.type&&e.coordinates)return e;let s,a;if(t===1)e.length<=1?(s="Point",a=this.Ve(e,n,i,o)||[]):(s="MultiPoint",a=this.Ve(e,n,i,o));else if(t===2)e.length<=1?(s="LineString",a=this.Ve(e,n,i,o)||[]):(s="MultiLineString",a=this.Ve(e,n,i,o));else if(t===3){let l;a=[];let h=0;for(let u=0;u<e.length;u++)Lr.calculateSignedArea(e[u])>0&&(h++,l&&l.length&&a.push(l),l=[]),l.push(this.Ve(e[u],n,i,o));l.length&&a.push(l),h<=1?(s="Polygon",a=a[0]):s="MultiPolygon"}return{type:s,coordinates:a}}Ve(t,e,n,i){const o=n/this.getTileSize().width,s=this.getMap(),a=h=>{const u=[];Zu(h)&&(h=[h]);for(let c=0,f=h.length;c<f;c++){const d=h[c];rp.x=e.x+d.x/o,rp.y=e.y-d.y/o,s.pointAtResToCoord(rp,i,NC),u.push(NC.toArray())}return h.length===1?u[0]:u};if(Zu(t))return a(t);const l=t.length;if(l===1)return a(t[0]);{let h=[];for(let u=0;u<l;u++)h.push(a(t[u]));return h}}getDataSchema(t){return this.ce||(this.ce={}),er(t)||this.ce[t]||(this.ce[t]={}),er(t)?this.ce:this.ce[t]}onRemove(){super.onRemove()}static fromJSON(t){return t&&t.type==="VectorTileLayer"?new dn(t.id,t.options):null}Ut(){}static registerPlugin(t){dn.plugins||(dn.plugins={}),dn.plugins[t.type]=t}static getPlugins(){return dn.plugins||{}}static compressStyleJSON(t){return Array.isArray(t)&&t.length?function(e){Array.isArray(e)&&(e={style:e,featureStyle:[]});const n=[],i=[],o=[];EC(e.style,n,o),EC(e.featureStyle,i,o);const s={plugins:o,styles:{style:n,featureStyle:i}};return e.$root&&(s.$root=e.$root),s}(t):t}}function BC(r){return!(!r||!r.properties)}function wB(r){return r?(Array.isArray(r)||(r=Wi(r).unitArray()),r.length===3&&r.push(1),r):null}function AB(r,t){return r??t}function $l(r,t,e){if(!r[t]||!r[t].style||!r[t].style[e])throw new Error(`No plugin defined at feature style of ${t} - ${e}`)}function qu(r,t){if(!r[t])throw new Error(`No plugin defined at style of ${t}`)}dn.prototype._getTileZoom=function(r){return r=Math.floor(r),En.prototype._getTileZoom.call(this,r)},dn.registerJSONType("VectorTileLayer"),dn.mergeOptions({urlTemplate:null,renderer:"gl",altitudeProperty:"altitude",forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,tileSize:[512,512],features:!1,schema:!1,cascadeTiles:!0,collision:!0,collisionBuffserSize:0,picking:!0,pickingPoint:!0,pickingGeometry:!1,glyphSdfLimitPerFrame:15,tileLimitPerFrame:1,loadingLimitOnInteracting:5,loadingLimit:0,antialias:!1,iconErrorUrl:null,collisionFrameLimit:1.5,defaultRendering:!0,textGamma:1,maxIconSize:254,workarounds:{"win-intel-gpu-crash":!1},pyramidMode:1,styleScale:1,enableAltitude:!0,fadeAnimation:!1,debugTileData:!1,fetchOptions:null,awareOfTerrain:!0,altitudeQueryTimeLimitPerFrame:3,workerGlyph:!0,featureIdProperty:null,currentTilesFirst:!0}),dn.registerRenderer("gl",np),dn.registerRenderer("canvas",null);const jC={projection:"EPSG:4326",fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){const r=[];for(let t=0;t<22;t++)r[t]=45/(128*Math.pow(2,t));return r}()};eo.registerPreset("preset-vt-4326",jC),eo.registerPreset("preset-4326-512",jC);const TB=new kn(1,1);class Xn extends pm{static registerPainter(t,e){Xn.painters||(Xn.painters={}),Xn.painters[t]=e}static get3DPainterClass(t){return Xn.painters[t]}setURLModifier(t){return this.fe=t,this}getURLModifier(){return this.fe}getEvents(){let t;return t=super.getEvents?super.getEvents():{},t.spatialreferencechange=this.je,t}onConfig(t){if(super.onConfig(t),t.enableBloom!==void 0){const e=this.getRenderer();e&&e.updateBloom(t.enableBloom)}}updateSymbol(t,e){if(!this.options.style)throw new Error("can't call update symbol when style is not set");const n=Array.isArray(this.options.style)?this.options.style:this.options.style.style;if(!n[t])throw new Error(`invalid style at ${t}`);return Oe(n[t].symbol,e),this.setStyle(this.options.style),this}getPolygonOffsetCount(){return this.isEmpty()||this.options.altitude?0:1}getPolygonOffset(){return this.options.altitude?0:this.ke||0}setPolygonOffset(t,e){return this.ke=t,this.Ie=e,this}getTotalPolygonOffset(){return this.Ie}identify(t,e={}){const n=this.getMap(),i=this.getRenderer();if(!n||!i)return[];const o=n.coordToContainerPoint(new at(t));return this.identifyAtPoint(o,e)}identifyAtPoint(t,e={}){const n=this.getMap(),i=this.getRenderer();if(!n||!i)return[];const o=this.getMap().getDevicePixelRatio(),s=i.pick(t.x*o,t.y*o,e);return e&&e.filter?s.filter(a=>e.filter(a)):s}getComputedStyle(){return{style:this.getStyle()||[]}}outlineAll(){const t=this.getRenderer();return t?(t.outlineAll(),this):this}outline(t){if(!Array.isArray(t)||!t.length)return this;const e=this.getRenderer();return e?(e.outline(t),this):this}cancelOutline(){const t=this.getRenderer();return t?(t.cancelOutline(),this):this}toJSON(){const t={type:this.getJSONType(),id:this.getId(),options:this.config(),geometries:[]},e=this.getGeometries();for(let n=0,i=e.length;n<i;n++){const o=e[n].toJSON();t.geometries.push(o)}return t}getTileSize(){return TB}je(){const t=this.getRenderer();t&&t.je()}}Xn.mergeOptions({picking:!0,pickingPoint:!0,renderer:"gl",collision:!1,collisionBufferSize:0,textGamma:1,geometryEvents:!0,styleScale:1,forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,meshRenderOrder:0,enableBloom:!1,enableAltitude:!0,workarounds:{"win-intel-gpu-crash":!0}});const Mv={redraw:!1,retire:!1},MB=[];let VC=1;function $r(r,t){return $d.extend(r,{init:function(){this.Ue={}},isVisible(){return this.painter&&this.painter.isVisible()},supportRenderMode:function(n){return this.painter.supportRenderMode(n)},hasMesh(){return this.painter&&this.painter.hasMesh()},startFrame:function(n){const i=n.layer,o=n.regl,s=n.sceneConfig,a=n.dataConfig,l=n.symbol;let h=this.painter;if(!h){const c=n.pluginIndex;h=this.painter=new t(o,i,l,s,c,a)}this.Ue||(this.Ue={});const u=s.excludes;this.Ge?u!==this.Ge&&(this.We=u?JT(u):null,this.Ge=u):u&&(this.Ge=u),h.startFrame(n),this.Ye={}},updateCollision:function(n){const i=this.painter;return i&&i.isVisible()?i.updateCollision(n):null},prepareRender:function(n){const i=this.painter;return i&&i.isVisible()?i.prepareRender(n):null},endFrame:function(n){const i=this.painter;return i&&i.isVisible()?i.render(n):null},getShadowMeshes(){const n=this.painter;return n&&n.getShadowMeshes&&n.getShadowMeshes()||MB},createTile:function(n){const{tileCache:i,tileData:o}=n;let s=!1;const a=this.painter;if(!a)return{retire:s};const l=this.Be(n);let h=i.geometry;if(!h){const c=o.features,f=o.data;if(!f||!f.length)return{retire:s};const d=f;if(this.painter.colorSymbol&&!function(p){if(!p)return!0;for(const g in p)return!1;return!0}(c))for(let p=0;p<f.length;p++){const g=this.Xe(c,f[p].data.aPickingId,f[p].indices,f[p].data.aPosition,f[p].positionSize);f[p].data.aColor=g}h=i.geometry=a.createGeometries(d,c);for(let p=0;p<h.length;p++)h[p]&&h[p].geometry&&(s=!0,h[p].geometry.properties.features=c,this.$e(h[p].geometry,n))}let u=this.G(l);if(!u){const{meshes:c,retire:f}=this.qe(h,n);s||(s=f),u=c}return{retire:s}},qe(n,i){const{tileInfo:o,tileExtent:s,tileTransform:a,tileTranslationMatrix:l,tileVectorTransform:h,tileZoom:u,sceneConfig:c}=i;let f=!1;const d=this.painter,p=[o.extent2d.xmin,o.extent2d.ymax],g=d.createMeshes(n,a,{tileExtent:s,tilePoint:p,tileZoom:u,tileTranslationMatrix:l,tileVectorTransform:h},i);if(g.length){for(let y=0;y<g.length;y++)g[y]&&(f=!0,this.Ke(g[y],a,i.timestamp,VC++,d.isEnableTileStencil()));c.animation&&(g.Je=i.timestamp);const m=this.Be(i);this.Ue[m]=g}return{meshes:g,retire:f}},paintTile:function(n){const{tileCache:i,tileInfo:o,tileZoom:s,sceneConfig:a}=n,l=this.painter;if(!l)return Mv;let h=i.geometry;if(!h)return Mv;let u=!1;const c=this.Be(n);let f=this.G(c);if(!f){const{meshes:g,retire:m}=this.qe(h,n);u||(u=m),f=g}if(!f.length)return Mv;const d=l.getTileLevelValue(o,s);f.forEach(g=>{g.properties.tile=o,g.properties.level=d});let p=!1;if(!this.Ye[c]){let g=null,m=a.animation;if(m){const y=n.sceneConfig.animationDuration||800,x=(n.timestamp-f.Je)/y,v=f[0].properties.createTime;f.Je-v<y&&x<1&&(m!==!0&&m!==1||(m="linear"),g=m==="linear"?x:y8(m,x),p=!0)}l.addMesh(f,g,n),this.Ye[c]=1}return{redraw:p,retire:u}},Ke:function(n,i,o,s,a){if(n.properties.tileTransform=i,n.properties.createTime=o,n.properties.meshKey=s,n.needUpdateShadow=!0,a){const l=n.defines||{};l.ENABLE_TILE_STENCIL=1,n.setDefines(l)}"stencilRef"in n.uniforms||Object.defineProperty(n.uniforms,"stencilRef",{enumerable:!0,get:function(){return n.properties.tile&&n.properties.tile.stencilRef!==void 0?n.properties.tile.stencilRef:n.properties.level}})},$e:function(n,i){const{layer:o,tileInfo:s}=i,a=o.getMap(),l=(o.getSpatialReference?o.getSpatialReference():a.getSpatialReference()).getResolution(s.z),h=i.tileExtent/o.getTileSize().width;n.properties.tileResolution=l,n.properties.tileRatio=h,n.properties.z=s.z,n.properties.tileExtent=i.tileExtent},updateSceneConfig:function(n){const i=this.painter;i&&i.updateSceneConfig(n.sceneConfig)},updateDataConfig:function(n,i){const o=this.painter;return!o||o.updateDataConfig(n,i)},updateSymbol:function(n,i){const o=this.painter;if(!o)return!1;if(o.shouldDeleteMeshOnUpdateSymbol(n)){if(this.Ue)for(const s in this.Ue)o.deleteMesh(this.Ue[s],!0);delete this.Ue,delete this.Ye}return o.updateSymbol(n,i)},pick:function(n,i,o){return this.painter&&this.painter.pick?this.painter.pick(n,i,o):null},deleteTile:function(n){if(!this.Ue)return;const i=this.Be(n),o=this.Ue[i];o&&this.painter&&this.painter.deleteMesh(o),delete this.Ue[i],this.Ye&&delete this.Ye[i]},remove:function(){const n=this.painter;if(n&&this.Ue){for(const i in this.Ue)n.deleteMesh(this.Ue[i]);n.delete(),delete this.painter}delete this.Ue,delete this.Ye},resize:function(n,i){const o=this.painter;o&&o.resize(n,i)},needToRedraw:function(){return!!this.painter&&this.painter.needToRedraw()},needToRetireFrames:function(){return!!this.painter&&this.painter.needToRetireFrames()},isAnimating(){return!!this.painter&&this.painter.isAnimating()},needToRefreshTerrainTileOnZooming:function(){return!!this.painter&&this.painter.needToRefreshTerrainTileOnZooming()},isTerrainSkin:function(){return!!this.painter&&this.painter.isTerrainSkin()},isTerrainVector:function(){return!!this.painter&&this.painter.isTerrainVector()},Xe:function(n,i,o,s,a=3){if(!s||!n||!i.length)return null;const l=new Uint8Array(s.length/a*4);let h,u;const c=this.painter.colorSymbol,f={};let d;for(let p=0,g=i.length;p<g;p++){const m=i[p];if(h=n[m].symbol,u=f[m],!u)if(c){let y;y=typeof c=="function"?c(n[m].feature&&n[m].feature.properties):c,y=Wi(y),u=f[m]=y.array()}else u=f[m]=[255,255,255];d=4*p,l[d]=u[0],l[d+1]=u[1],l[d+2]=u[2],l[d+3]=255*(h[this.painter.opacitySymbol]||1)}return l},Be:function(n){const i=n.tileInfo;return i.meshKey||(i.meshKey=VC++),i.meshKey},G:function(n){return this.Ue[n]},Ze(n,i){if(Array.isArray(n))n.forEach((o,s)=>{const{features:a}=o.properties;this.Qe(o,i[s],a)});else{const{features:o}=n.properties;this.Qe(n,Array.isArray(i)?i[0]:i,o)}},Qe(n,i,o){const s=i.featureIndexes||i.data.featureIndexes;if(s)if(this.We){const a=i.indices;let l=null,h=!1;const u=[];for(let c=0;c<a.length;c++){const f=o[s[a[c]]];l!==null&&l===a[c]||(h=this.We(f.feature),l=a[c]),h||u.push(a[c])}n.setElements(new i.indices.constructor(u))}else n.setElements(i.indices)},outline(n,i){const o=this.painter;o&&o.outline(n,i)},outlineAll(n){const i=this.painter;i&&i.outlineAll(n)},needPolygonOffset(){const n=this.painter;return n&&n.needPolygonOffset()},highlight(n){const i=this.painter,o=this.style.name,s=this.renderIndex;if(n){const a=[];if(n.forEach((l,h)=>{l.plugin!==void 0&&l.plugin!==null&&(Array.isArray(l.plugin)?l.plugin.length&&l.plugin.indexOf(o)<0&&l.plugin.indexOf(s)<0&&a.push(h):l.plugin!==o&&l.plugin!==s&&a.push(h))}),a.length){const l=new Map(n);for(let h=0;h<a.length;h++)l.delete(a[h]);n=l}}return i&&i.highlight(n)},cancelAllHighlight(){const n=this.painter;return n&&n.cancelAllHighlight()}})}function Wl(r){return!r||(r.empty!==void 0||(r.empty=function(t){for(const e in t)return!1;return!0}(r)),r.empty)}const An="_fn_type_",Sv="__current_fn_types";function Vo(r,t,e){if(!Wl(r.properties.features))for(let n=0;n<e.length;n++){const{symbolName:i}=e[n];(r[Sv]=r[Sv]||{})[i]=t[i],GC(r,t,e[n])}}function GC(r,t,e){const n=function(l){const h=l.properties;let u=h.aPickingId;return u||(u=h.aPickingId=new l.data.aPickingId.constructor(l.data.aPickingId)),u}(r),{attrName:i,symbolName:o,related:s}=e;let a=r.data[i];return a?fo(t[o])||function(l,h){if(!Array.isArray(l))return!1;for(let u=0;u<l.length;u++)if(fo(h[l[u]]))return!0;return!1}(s,t)?(fo(t[o])&&UC(r,t,e),a):(r.deleteData(i),Cv(r,i),null):fo(t[o])?(a=r.data[i]=new e.type(e.width*n.length),function(l,h,u,c){const{attrName:f}=c,d=(An+f+"Index").trim();UC(h,u,c);const p=h.properties[d];Pv(h,p,c)}(a,r,t,e),a):null}function UC(r,t,e){const{attrName:n,symbolName:i}=e,o=r.properties,s=(An+n+"Index").trim(),a=(An+n).trim();if(o[s]&&o[a])return;const l=function(p){if(!p)return PB;const g=[];for(let m=0;m<p.length;m++)Ft(p[m][1])&&!le(p[m][1]).isZoomConstant&&g.push(p[m][0]);return g}(t[i].stops),h=t[i].type==="identity"&&Ml.checkIfIdentityZoomDependent(i,t[i].property,o.features);if(!h&&!l.length)return void Cv(r,n);const{features:u,aPickingId:c}=o,f=function(p,g,m,y,x){const v=[];let _=0,w=g[0];for(let b=1,A=g.length;b<A;b++)!p[w]||g[b]===w&&b!==A-1||((x||CB(p[w].feature,m,y))&&v.push(_,b===A-1?A:b),w=g[b],_=b);return v}(u,c,t[i].property,l,h);if(!f.length)return void Cv(r,n);const d=r.data[n];o[s]=f,o[a]=d.BYTES_PER_ELEMENT?new d.constructor(d):new e.type(d.length)}function Cv(r,t){const e=r.properties,n=(An+t+"Index").trim(),i=(An+t).trim();delete e[n],delete e[i]}function $C(r,t,e,n,i){if(!n)return;const o=n.geometry;if(!o||Wl(o.properties.features))return;const s=n.geometry.properties.layer;for(let a=0;a<e.length;a++){const l=e[a],h=l.attrName;if(!(SB(o,t,l)||s.xe&&s.xe(n.geometry.tn))){const{aPickingId:f}=o.properties;if(!f||o.en===i)continue;const d=(An+h+"Index").trim(),p=o.properties[d];if(!p)continue;Pv(o,p,l);continue}const u=GC(o,t,l),c=l.define;if(u){const f=(An+h+"Index").trim();if(Pv(o,o.properties[f],l),s.ge&&(o.tn=s.ge()),c){const d=n.defines;d[c]=1,n.setDefines(d)}o.generateBuffers(r)}else if(c){const f=n.defines;f[c]&&(delete f[c],n.setDefines(f))}}o.en=i}function SB(r,t,e){const n=t[e.symbolName],i=r[Sv];return!su(n,i[e.symbolName])&&(i[e.symbolName]=n,!0)}function CB(r,t,e){for(let n=0;n<e.length;n++)if(t[0]==="$"&&r[t.substring(1)]===e[n]||r.properties[t]===e[n])return!0;return!1}const PB=[];function Pv(r,t,e){const{attrName:n,evaluate:i}=e,{aPickingId:o,features:s}=r.properties;let a;if(t){const l=(An+n).trim();a=r.properties[l];const h=a.length/o.length,u=t.length;for(let c=0;c<u;c+=2){const f=t[c],d=t[c+1];let p=s[o[f]];p&&p.feature&&WC(a,p,i,f,d,h,r)}}else{if(a=r.data[n],function(c){return Array.isArray(c)||c.constructor===Float32Array||c.constructor===Float64Array||c.constructor===Uint8Array||c.constructor===Int8Array||c.constructor===Uint16Array||c.constructor===Int16Array||c.constructor===Uint32Array||c.constructor===Int32Array||c.constructor===Uint8ClampedArray}(a))a.dirty=!0;else{const c=(An+n).trim();a=r.properties[c],a||(a=r.properties[c]=new e.type(e.width*o.length),a.dirty=!0)}const l=a.length/o.length,h=o.length;let u=0;for(let c=0;c<h;c++){if(o[c]===o[u]&&c<h-1)continue;let f=s[o[u]];f&&f.feature&&(WC(a,f,i,u,c===h-1?h:c,l,r),u=c)}}a.dirty&&(r.updateData(n,a),a.dirty=!1)}const Ev={};function WC(r,t,e,n,i,o,s){const a=(t=t.feature).properties||{};a.$layer===void 0&&(t.properties||(t.properties=a),a.$layer=t.layer,a.$type=t.type);const l=s.properties.layer;if(l.getFeatureState&&(Ev.layer=t.layer,Ev.id=t.id,t[jo]&&(t[jo]=null),!wn(t.id))){const u=l.getFeatureState(Ev);t.properties[jo]=u}const h=e(a,s,r,n*o);if(Array.isArray(h)){let u=!1;for(let c=0;c<o;c++)if(r[n*o+c]!==h[c]){u=!0;break}if(u){for(let c=n*o;c<i*o;c+=o)r.set(h,c);r.dirty=!0}}else r[n]!==h&&(Xu(r,h,n,i),r.dirty=!0)}function fo(r){return Ml.isFnTypeSymbol(r)}function EB(r){return r&&r.nn&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var OB=Zl;function Zl(r,t){this.x=r,this.y=t}Zl.prototype={clone:function(){return new Zl(this.x,this.y)},add:function(r){return this.clone().rn(r)},sub:function(r){return this.clone().sn(r)},multByPoint:function(r){return this.clone().an(r)},divByPoint:function(r){return this.clone().ln(r)},mult:function(r){return this.clone().hn(r)},div:function(r){return this.clone().un(r)},rotate:function(r){return this.clone().cn(r)},rotateAround:function(r,t){return this.clone().dn(r,t)},matMult:function(r){return this.clone().pn(r)},unit:function(){return this.clone().mn()},perp:function(){return this.clone().yn()},round:function(){return this.clone().gn()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(r){return this.x===r.x&&this.y===r.y},dist:function(r){return Math.sqrt(this.distSqr(r))},distSqr:function(r){var t=r.x-this.x,e=r.y-this.y;return t*t+e*e},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(r){return Math.atan2(this.y-r.y,this.x-r.x)},angleWith:function(r){return this.angleWithSep(r.x,r.y)},angleWithSep:function(r,t){return Math.atan2(this.x*t-this.y*r,this.x*r+this.y*t)},pn:function(r){var t=r[0]*this.x+r[1]*this.y,e=r[2]*this.x+r[3]*this.y;return this.x=t,this.y=e,this},rn:function(r){return this.x+=r.x,this.y+=r.y,this},sn:function(r){return this.x-=r.x,this.y-=r.y,this},hn:function(r){return this.x*=r,this.y*=r,this},un:function(r){return this.x/=r,this.y/=r,this},an:function(r){return this.x*=r.x,this.y*=r.y,this},ln:function(r){return this.x/=r.x,this.y/=r.y,this},mn:function(){return this.un(this.mag()),this},yn:function(){var r=this.y;return this.y=this.x,this.x=-r,this},cn:function(r){var t=Math.cos(r),e=Math.sin(r),n=t*this.x-e*this.y,i=e*this.x+t*this.y;return this.x=n,this.y=i,this},dn:function(r,t){var e=Math.cos(r),n=Math.sin(r),i=t.x+e*(this.x-t.x)-n*(this.y-t.y),o=t.y+n*(this.x-t.x)+e*(this.y-t.y);return this.x=i,this.y=o,this},gn:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},Zl.convert=function(r){return r instanceof Zl?r:Array.isArray(r)?new Zl(r[0],r[1]):r};var ip=EB(OB);const ri=[];function po(r,t,e,n,i){return Tr(ri,t[0],t[1],t[2],1),ss(ri,ri,e),r[2]=ri[3],Jh(ri,ri,1/ri[3]),r[0]=(ri[0]+1)*n/2,r[1]=(1-ri[1])*i/2,r}const kB=[],IB=[],RB=[],DB=[-99999,-99999],ZC=new W(0,0),FB=[];function Ov(r,t,e,n,i,o,s,a){const{res:l,extent:h,extent2d:u}=e.properties.tile,{xmin:c,ymax:f}=u,d=c+n.x*i,p=f-n.y*i;let g=null;if(a){for(let v=0;v<a.length;v++)if(XC(a[v],d,p,l)){g=a[v];break}}if(!g)return DB;const m=ZC.set(c,f),y=o.queryTilePointTerrain(n,g,m,h,l),x=y[0]===null?Gl:y[0];if(x){let v=ie(FB,n.x,n.y,0);return v[2]+=100*x,v=po(r,v,s,t.width,t.height),v}return r[0]=n.x,r[1]=n.y,r}function XC(r,t,e,n){const i=ZC.set(t,e)._multi(n/r.res);return r.extent2d.contains(i)}const{loginIBLResOnCanvas:LB,logoutIBLResOnCanvas:zB,getIBLResOnCanvas:HB}=Qn.PBRUtils,Ju="__gl_textures",YC=[],NB=new W(0,0),qC=new W(0,0),JC=new Float32Array(1),KC=[],BB=r=>r.properties.level===0,jB=r=>r.properties.level>0;class kv{static getBloomSymbol(){return["bloom"]}constructor(t,e,n,i,o,s){this.xn=!0,this.regl=t,this.layer=e,this.canvas=t._gl.canvas,this.sceneConfig=i||{},this.dataConfig=s||{},this.pluginIndex=o,this.scene=new ur,this.pickingFBO=e.getRenderer().pickingFBO,this.level0Filter=BB,this.levelNFilter=jB,this.loginTextureCache(),this.symbolDef=Array.isArray(n)?n.map(a=>xv(a)):[xv(n)],this.vn(),this.pickingViewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},this.sortByCommandKey=VB.bind(this),this.colorCache={},this.bn=this.symbolDef.map(a=>!(!a||a.visible!==!1))}hasMesh(){const t=this.scene&&this.scene.getMeshes();return this.isVisible()&&t&&!!t.length}getMap(){return this.layer?this.layer.getMap():null}getTileLevelValue(t,e){const n=this.layer.getRenderer();return n.getTileLevelValue&&n.getTileLevelValue(t,e)||0}getAnalysisMeshes(){return this.getShadowMeshes?this.getShadowMeshes():KC}isVisible(){const{minZoom:t,maxZoom:e}=this.sceneConfig,n=this.getMap().getZoom();if(!wn(t)&&n<t||!wn(e)&&n>e)return!1;const i=this.An;if(i.length){for(let s=0;s<i.length;s++)if(i[s]&&!i[s].isFeatureConstant)return!0}const o=this.getSymbols();for(let s=0;s<o.length;s++){const a=o[s].visible;if(a!==!1&&a!==0)return!0}return!1}isMeshVisible(t){const e=t&&t.properties&&t.properties.symbolIndex;if(!e)return!1;const n=this.An,i=e.index;let o;if(n[i]){if(!n[i].isFeatureConstant)return!0;o=n[i](this.getMap().getZoom())}else o=this.getSymbol(e).visible;return o!==!1&&o!==0}isAnimating(){return!1}needToRedraw(){return this.isAnimating()||this.wn}needToRetireFrames(){return this.nt}needToRefreshTerrainTileOnZooming(){return!0}isTerrainSkin(){return this.layer.options.awareOfTerrain}isTerrainVector(){return!1}isShadowIncludeChanged(t){const e=t&&t.isRenderingTerrain&&this.isTerrainSkin();return t&&t.states&&t.states.includesChanged.shadow||e&&this._n}fillIncludes(t,e,n){if(delete this._n,n&&n.isRenderingTerrain&&this.isTerrainSkin())return;const i=n&&n.includes;if(i){let o="";for(const s in i)i[s]&&(o+=s,n[s].uniformDeclares&&e.push(...n[s].uniformDeclares),n[s].defines&&jn(t,n[s].defines));this._n=o}}setIncludeUniformValues(t,e){if(e&&e.isRenderingTerrain&&this.isTerrainSkin())return;const n=e&&e.includes;if(n)for(const i in n)n[i]&&e[i].renderUniforms&&jn(t,e[i].renderUniforms)}createGeometries(t,e){if(!t.length)return KC;const n=[];for(let i=0;i<t.length;i++)if(t[i])if(t[i].ref!==void 0)n[t[i].ref]?n.push({geometry:n[t[i].ref].geometry,symbolIndex:t[i].symbolIndex,ref:t[i].ref}):n.push(null);else{t[i]&&!t[i].is2D&&(this.xn=!1);const o=this.createGeometry(t[i],e,i);if(o&&o.geometry){const s=o.geometry.properties,{pickingIdMap:a,idPickingMap:l,hasFeaIds:h}=this.Sn(t[i]);h&&(s.feaIdPickingMap=a,s.feaPickingIdMap=l),s.symbolIndex=o.symbolIndex,s.features=e,s.is2D=t[i].is2D,s.layer=this.layer,s.positionBounding=t[i].positionBounding,this.postCreateGeometry(o,n)}n.push(o)}return n}isOnly2D(){return this.xn}postCreateGeometry(){}Sn(t){if(!t)return{};if(Array.isArray(t)&&!(t=t[0]))return{};const e=t.featureIds,n={},i={},o=e&&e.length;if(o)for(let s=0;s<e.length;s++){const a=t.data.aPickingId[s];n[a]===void 0&&(n[a]=e[s],i[e[s]]||(i[e[s]]=[]),i[e[s]].push(t.data.aPickingId[s]))}return{hasFeaIds:o,idPickingMap:n,pickingIdMap:i}}createGeometry(){throw new Error("not implemented")}createMeshes(t,e,n,i){const o=this.layer.options.awareOfTerrain,s=[];for(let a=0;a<t.length;a++){if(!t[a])continue;if(o&&i&&i.isRenderingTerrain&&this.isTerrainVector()){const h=t[a],u=h&&h.geometry;this.Mn(u,u.data,u.properties,u.positionSize||u.desc.positionSize,i)}let l=this.createMesh(t[a],e,n,i||{});Array.isArray(l)?(l=l.filter(h=>!!h),s.push(...l)):l&&s.push(l)}return s}createMesh(){throw new Error("not implemented")}getAltitudeOffsetMatrix(){const t=100*(this.dataConfig.altitudeOffset||0),e=mn([]);return ie(YC,0,0,t),oo(e,e,YC),e}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex).bloom}forbiddenTerrainUpscale(){return!0}addMesh(t,e,n){if(n.isRenderingTerrain&&this.isTerrainSkin()&&this.forbiddenTerrainUpscale()){const l=this.getMap().getResolution();if(n.tileInfo.res/l>3)return}const i=n.isRenderingTerrain&&this.isTerrainVector(),o=this.getRenderFBO(n);t=t.filter(l=>this.isMeshVisible(l)),i&&(t=t.filter(l=>l.geometry&&l.geometry.data.aTerrainAltitude));const s=this.sceneConfig.castShadow===void 0||!!this.sceneConfig.castShadow,a=!(!n||!n.bloom);t.forEach(l=>{const h=this.isBloom(l)&&a;l.bloom=h,l.castShadow=s;let u=!1;const c=l.defines||{};if(!!c.HAS_BLOOM!==h&&(u=!0,h?c.HAS_BLOOM=1:delete c.HAS_BLOOM),i){if(l.geometry.data.aTerrainAltitude){const f=l.geometry;this.Mn(f,f.data,f.properties,f.desc.positionSize,n)}l.geometry.data.aTerrainAltitude&&!c.HAS_TERRAIN_ALTITUDE&&(c.HAS_TERRAIN_ALTITUDE=1,u=!0)}else c.HAS_TERRAIN_ALTITUDE&&(delete c.HAS_TERRAIN_ALTITUDE,u=!0);u&&l.setDefines(c),o?l.setUniform("targetFramebuffer",o):l.uniforms.targetFramebuffer&&(l.uniforms.targetFramebuffer=null),this.Tn(l)}),this.scene.addMesh(t)}updateCollision(){}render(t){return this.pluginIndex=t.pluginIndex,this.polygonOffsetIndex=t.polygonOffsetIndex,this.paint(t),{redraw:this.wn,drawCount:this.Pn}}prepareRender(t){if(this.At===t.timestamp||!this.createFnTypeConfig)return;const e=this.scene.getMeshes();if(!e||!e.length)return;const n=t&&t.sceneFilter,i=this.getMap().getZoom();for(let o=0;o<e.length;o++){if(!e[o]||!e[o].geometry||n&&!n(e[o]))continue;const{symbolIndex:s}=e[o].properties,a=this.getSymbolDef(s);if(!a)continue;this.At=t.timestamp;const l=this.getFnTypeConfig(s);$C(this.regl,a,l,e[o],i)}}paint(t){const e=this.layer.getMap();if(!e)return{redraw:!1};this.kn=t;const n=this.getUniformValues(e,t);return this.callShader(n,t),{redraw:this.wn}}setToRedraw(t){t&&(this.nt=t),this.wn=!0}callShader(t,e){this.callCurrentTileShader(t,e),this.callBackgroundTileShader(t,e)}callCurrentTileShader(t,e){this.shader&&(this.shader.filter=e&&e.sceneFilter?[this.level0Filter,e.sceneFilter]:this.level0Filter),this.callRenderer(this.shader,t,e)}callBackgroundTileShader(t,e){this.shader&&(this.shader.filter=e&&e.sceneFilter?[this.levelNFilter,e.sceneFilter]:this.levelNFilter),this.scene.getMeshes().sort(GB),this.callRenderer(this.shader,t,e)}callRenderer(t,e,n){const i=this.scene.getMeshes(),o=[];i.forEach(s=>{s.properties.hlBloomMesh&&n&&n.bloom&&o.push(s.properties.hlBloomMesh),o.push(s)}),this.In(e),this.scene.setMeshes(o),this.Pn+=this.renderer.render(t,e,this.scene,this.getRenderFBO(n)),this.scene.setMeshes(i)}In(t){const e=this.layer.options.altitude||0,n=this.layer.getRenderer();t.layerOpacity=n.ue(),t.minAltitude=e}getRenderFBO(t){return t&&t.renderTarget&&t.renderTarget.fbo}needPolygonOffset(){return!1}getPolygonOffset(){const t=this.layer;return{factor:()=>t.getPolygonOffset()+(this.polygonOffsetIndex||0),units:()=>t.getPolygonOffset()+(this.polygonOffsetIndex||0)}}getBlendFunc(){return{src:()=>this.sceneConfig.blendSrc||"one",dst:()=>this.sceneConfig.blendDst||"one minus src alpha"}}pick(t,e,n=3){if(!this.layer.options.picking||this.sceneConfig.picking===!1||!this.pickingFBO||!this.picking)return null;const i=this.getMap(),o=this.getUniformValues(i);this.In(o);for(let s=0;s<this.picking.length;s++){const a=this.picking[s];a.render(this.scene.getMeshes(),o,!0);let l={};a.getRenderedMeshes().length&&(l=a.pick(t,e,n,o,{viewMatrix:i.viewMatrix,projMatrix:i.projMatrix,returnPoint:this.layer.options.pickingPoint&&this.sceneConfig.pickingPoint!==!1,logDepthBufFC:2/(Math.log(i.cameraFar+1)/Math.LN2)}));const{meshId:h,pickingId:u,point:c}=l,f=(h===0||h)&&a.getMeshAt(h);if(!f||!f.geometry)continue;let d=f.geometry.properties;return d.features||(d=f.properties),c&&c.length&&(c[0]=Math.round(1e5*c[0])/1e5,c[1]=Math.round(1e5*c[1])/1e5,c[2]=Math.round(1e5*c[2])/1e5),{data:this.On(d&&d.features&&d.features[u]),point:c,coordinate:l.coordinate,plugin:this.pluginIndex}}return null}On(t){const e=t&&t.feature;if(!e||!e.customProps)return t;const n=jn({},t);return n.feature=jn({},t.feature),delete n.feature.customProps,n.feature.properties=jn({},e.properties,e.properties[ca],e.properties[jo]),delete n.feature.properties[jo],delete n.feature.properties[ca],delete n.feature.properties.$layer,delete n.feature.properties.$type,n}updateSceneConfig(){}updateDataConfig(t){return jn(this.dataConfig,t),!0}deleteMesh(t,e){if(t)if(this.scene.removeMesh(t),Array.isArray(t))for(let n=0;n<t.length;n++){if(!t[n].isValid())continue;const i=t[n].geometry;!e&&i&&i.dispose(),t[n].material&&t[n].material.dispose(),t[n].dispose(),sy.deleteHighlightBloomMesh(t[n])}else{if(!t.isValid())return;!e&&t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose(),t.dispose(),sy.deleteHighlightBloomMesh(t)}}startFrame(t){this.Cn||(this.init(t),this.Cn=!0),this.At!==t.timestamp&&(this.wn=!1,this.nt=!1,this.Pn=0),this.scene.clear()}resize(){}delete(){if(this.scene.clear(),this.shader&&this.shader.dispose(),this.picking){for(let t=0;t<this.picking.length;t++)this.picking[t].dispose();delete this.picking}if(this.Fn){for(let t=0;t<this.Fn.length;t++)this.Fn[t].dispose();delete this.Fn}delete this.En,this.logoutTextureCache()}updateSymbol(t,e){Array.isArray(t)||(t=[t],e=[e]);let n=!1;for(let i=0;i<t.length;i++)if(t[i]){const o=this.Dn(i,t[i],e[i]);o&&(n=o)}return delete this.Ln,this.setToRedraw(!1),n}zn(t,e){for(const n in e)if(Qd(e,n)&&(Ml.isFnTypeSymbol(e[n])&&!this.layer.options.features&&(!t[n]||t[n].property!==e[n].property)||vC[n]&&!su(e[n],t[n])))return!0;return!1}Dn(t,e,n){if(!this.Rn)return!1;const i=this.zn(this.symbolDef[t]||{},n);if(this.bn[t]&&n.visible!==!1)return this.bn[t]=!1,!0;this.symbolDef[t]=xv(n);const o=this.Rn[t];for(const h in o)delete o[h];const s=this.getMap(),a=[],l=cC.loadSymbolFnTypes(this.symbolDef[t],()=>(a[0]=s.getZoom(),a));for(const h in l){const u=Object.getOwnPropertyDescriptor(l,h);u.get?Object.defineProperty(o,h,{get:u.get,set:u.set,configurable:!0,enumerable:!0}):o[h]=l[h]}return Ft(n.visible)&&(this.An[t]=le(n.visible)),i}getSymbolDef(t){return this.symbolDef[t.index]}getSymbols(){return this.Rn}getSymbol(t){const e=t.index;return this.Rn[e]}vn(){const t=this.getMap(),e=[],n=()=>(e[0]=t.getZoom(),e);this.Rn=[],this.An=[];for(let i=0;i<this.symbolDef.length;i++)this.Rn[i]=cC.loadSymbolFnTypes(jn({},this.symbolDef[i]),n),this.symbolDef[i]&&Ft(this.symbolDef[i].visible)&&(this.An[i]=le(this.symbolDef[i].visible))}getFnTypeConfig(t){this.Ln||(this.Ln=[]);const e=t.index;if(!this.Ln[e]){const n=this.getSymbolDef(t),i=this.getMap();this.Ln[e]=this.createFnTypeConfig(i,n)}return this.Ln[e]}Hn(){delete this.Ln}loginTextureCache(){const t=(Ju+"").trim(),e=this.getMap();e[t]||(e[t]={count:0}),e[t].count++}logoutTextureCache(){const t=(Ju+"").trim(),e=this.getMap(),n=this.Nn;if(n)for(const i in n)Qd(n,i)&&e[t][i]&&(e[t][i].count--,e[t][i].count<=0&&delete e[t][i]);e[t].count--,e[t].count<=0&&(e[t]={})}getCachedTexture(t){const e=(Ju+"").trim(),n=this.getMap()[e][t];return n?n.data:null}addCachedTexture(t,e){const n=(Ju+"").trim(),i=this.getMap();let o=i[n][t];o?o.data=e:o=i[n][t]={data:e,count:0},this.Nn||(this.Nn={}),o.data.then||this.Nn[t]||(o.count++,this.Nn[t]=1)}disposeCachedTexture(t){let e;if(e=typeof t=="string"?t:t.url,!this.Nn||!this.Nn[e])return;const n=(Ju+"").trim();delete this.Nn[e];const i=this.getMap();i[n][e]&&(i[n][e].count--,i[n][e].count<=0&&delete i[n][e])}shouldDeleteMeshOnUpdateSymbol(){return!1}isEnableTileStencil(){return!0}isUniqueStencilRefPerTile(){return this.isOnly2D()}supportRenderMode(t){return t==="taa"||t==="fxaa"}outline(t,e){const n={};for(let i=0;i<e.length;i++)wn(e[i])||n[e[i]]||(this.Vn(t,e[i]),n[e[i]]=1)}Vn(t,e){if(!this.picking)return;if(this.jn||(this.jn=new ur),!this.Fn&&(this.Un(),!this.Fn))return void console.warn(`Plugin at ${this.pluginIndex} doesn't support outline.`);const n=this.getUniformValues(this.getMap(),this.kn);this.In(n);const i=this.Gn(e);if(i.length)for(let o=0;o<i.length;o++){const s=i[o].geometry.properties.feaIdPickingMap;if(s){const a=s[e];if(a){const l={};this.jn.setMeshes(i[o]);for(let h=0;h<a.length;h++){const u=a[h];if(!l[u]){l[u]=1,n.highlightPickingId=u;for(let c=0;c<this.Fn.length;c++)this.renderer.render(this.Fn[c],n,this.jn,t)}}}}}}Gn(t){const e=[],n=this.scene.getMeshes();for(let i=0;i<n.length;i++){const o=n[i],s=o.geometry.properties.feaIdPickingMap;s&&s[t]!==void 0&&e.push(o)}return e}outlineAll(t){if(!this.picking)return;if(!this.Fn&&(this.Un(),!this.Fn))return void console.warn(`Plugin at ${this.pluginIndex} doesn't support outline.`);const e=this.getUniformValues(this.getMap(),this.kn);this.In(e),e.highlightPickingId=-1;for(let n=0;n<this.Fn.length;n++)this.renderer.render(this.Fn[n],e,this.scene,t)}Un(){if(!this.picking)return;const t=this.layer.getRenderer().canvas;this.Fn=[];for(let e=0;e<this.picking.length;e++){const n=this.picking[e].getPickingVert(),i={ENABLE_PICKING:1,HAS_PICKING_ID:1},o=this.picking[e].getUniformDeclares().slice(0);o.uPickingId!==void 0&&(i.HAS_PICKING_ID=2),this.Fn[e]=new Ye({vert:n,frag:`precision highp float;
uniform float highlightPickingId;
varying float vPickingId;
void main() {
  if(highlightPickingId < .0 || floor(highlightPickingId + .5) == floor(vPickingId + .5)) {
    gl_FragColor = vec4(1.);
  } else {
    discard;
  }
}`,uniforms:o,defines:i,extraCommandProps:{viewport:{x:0,y:0,width:()=>t.width,height:()=>t.height},depth:{enable:!0,mask:!1,func:"always"},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}}),this.Fn[e].filter=this.picking[e].filter}}hasIBL(){const t=this.getMap().getLightManager();return!!(t&&t.getAmbientResource())}updateIBLDefines(t){const e=t.shaderDefines;let n=!1;this.hasIBL()?e[["HAS_IBL_LIGHTING"]]||(e.HAS_IBL_LIGHTING=1,n=!0):e[["HAS_IBL_LIGHTING"]]&&(delete e.HAS_IBL_LIGHTING,n=!0),n&&(t.shaderDefines=e)}getIBLRes(){const t=this.layer.getRenderer().canvas;return HB(t)}createIBLTextures(){const t=this.layer.getRenderer().canvas;LB(t,this.regl,this.getMap()),this.setToRedraw(!0),this.layer.fire("iblupdated")}disposeIBLTextures(){const t=this.layer.getRenderer().canvas;zB(t,this.getMap())}evaluateInFnTypeConfig(t,e,n,i,o){let s=this.Wn;s||(s=this.Wn={});const a=function(h){let u=0;const c=h&&h.length||0;if(!c)return u;let f;for(let d=0;d<c;d++)f=h.codePointAt(d),u=(u<<5)-u+f,u|=0;return u}(JSON.stringify(t));let l=s[a];return l||(l=s[a]=o?cn(t):le(t)),l(n.getZoom(),i)}highlight(t){this.le=t,this.Yn=this.layer.getRenderer().getFrameTimestamp(),this.setToRedraw(!0)}cancelAllHighlight(){this.le=null,this.Yn=this.layer.getRenderer().getFrameTimestamp(),this.setToRedraw(!0)}Bn(t,e){const{featureIds:n,pickingIdIndiceMap:i}=e;t.properties.aFeaIds=n,t.properties.pickingIdIndiceMap=i}Tn(t){if(t&&t.properties.isHalo)return;const{pickingIdIndiceMap:e}=t.geometry.properties,n=this.le?function(i,o,s){const{aPickingId:a,feaIdPickingMap:l,features:h}=i.geometry.properties,u=new Map,c=s.keys();for(const f of c){const d=s.get(f);if(d)if(wn(d.id)){if(d.filter&&a){let p=null;for(let g=0;g<a.length;g++){a[g]!==p&&(p=a[g]);const m=h[p];d.filter(m&&m.feature,o)&&u.set(p,d)}}}else{const p=l[d.id];if(!p||!p.length)continue;for(let g=0;g<p.length;g++)u.set(p[g],d)}}return u}(t,this.layer,this.le):null;sy.highlightMesh(this.regl,t,n,this.Yn,e)}Mn(t,e,n,i,o){let s=n.aAnchor;if(!s){const{aPosition:l}=e;s=n.aAnchor=l.slice(0)}let a=n.aTerrainAltitude;a||(a=n.aTerrainAltitude=new Float32Array(s.length/i),a.fill(Gl)),this.Xn(a,s,o.tileInfo,0,a.length-1),e.aTerrainAltitude?a.dirty&&this.$n(t,a):e.aTerrainAltitude=a,a.dirty=!1}$n(t,e){t&&t.updateData&&t.updateData("aTerrainAltitude",e)}Xn(t,e,n,i,o){const{res:s,extent:a,extent2d:l,id:h}=n,u=this.pluginIndex,c=h+"-"+u;if(n.completeTerrainQuery||(n.completeTerrainQuery=[]),n.completeTerrainQuery[u])return;if(!n.completeTerrainQuery[u]&&this.En&&this.En.has(c)){const P=this.En.getAndRemove(c);return this.En.add(c,P),t.set(P.altitudeData),n.terrainTileInfos=P.terrainTileInfos,t.dirty=!0,void(n.completeTerrainQuery[u]=!0)}const f=this.layer,d=f.getMap(),p=f.getRenderer(),g=p&&p.getTerrainHelper();let m=n.terrainTileInfos;m||(m=n.terrainTileInfos=this.layer.queryTerrainTiles(n)),n.terrainQueryStatus||(n.terrainQueryStatus=[]);let y=!1,x=[];for(let P=0;P<n.terrainTileInfos.length;P++)if(x[P]=+g.isTerrainTileLoaded(n.terrainTileInfos[P].id),x[P]&&n.terrainQueryStatus[u]&&!n.terrainQueryStatus[u][P]){y=!0;break}if(!y&&n.terrainQueryStatus[u])return;const v=f.constructor;if(d.isInteracting()){const P=p.getFrameTimestamp();v.altitudeQueryFrameTimestamp!==P&&(v.altitudeQueryFrameTimestamp=P,v.altitudeQueryFrameTime=0);const k=f.options.altitudeQueryTimeLimitPerFrame;if(v.altitudeQueryFrameTime>k)return}const _=performance.now();n.terrainQueryStatus[u]=x;const{xmin:w,ymax:b}=l,A=NB.set(w,b),T=this.layer.getTileSize().width/n.extent,S=e.length/t.length;let M=t.queryResult;M||(M=t.queryResult=new Map);let E=!0;for(let P=i;P<=o;P++){let k=e[P*S];k<0?k=0:k>a&&(k=a);let O=e[P*S+1];O<0?O=0:O>a&&(O=a);const I=k+O*a;let D,z,L=M.get(I);if(L||L===0)t[P]!==L&&(t[P]=L,t.dirty=!0);else{for(let $=0;$<m.length;$++)if(XC(m[$],w+T*k,b-T*O,s)){D=m[$];break}D&&(g.getRenderer().isTileCached(D.id)||t[P]===Gl)&&(qC.set(k,O),z=this.layer.queryTilePointTerrain(qC,D,A,a,s)),L=t[P],z&&(L=z[0]===null?Gl:z[0],JC[0]=L,L=JC[0]),t[P]!==L&&(t[P]=L,t.dirty=!0),z&&z[1]?M.set(I,L):E=!1}}v.altitudeQueryFrameTime=(v.altitudeQueryFrameTime||0)+(performance.now()-_),n.completeTerrainQuery[u]=E,E&&(this.En||(this.En=new Ag(4*this.layer.options.maxCacheSize)),this.En.add(c,{altitudeData:t,terrainTileInfos:m}))}}function VB(r,t){const e=r&&r.getCommandKey(this.regl)||"",n=t&&t.getCommandKey(this.regl)||"";return e.localeCompare(n)}function GB(r,t){return r.properties.level-t.properties.level}class _s extends kv{createGeometry(t,e){if(!t.data)return{geometry:null,symbolIndex:t.symbolIndex};t.iconAtlas&&t.iconAtlas.image&&(t.iconAtlas.image.dataType=t.type,t.iconAtlas.image.type="icon"),t.glyphAtlas&&t.glyphAtlas.image&&(t.glyphAtlas.image.type="glyph");const n=jn({},t.data),i={primitive:this.getPrimitive(),positionSize:t.positionSize};n.aAltitude&&(i.altitudeAttribute="aAltitude");const o=new ar(n,t.indices,0,i);return o.properties={features:e},t.iconAtlas&&(o.properties.iconAtlas=t.iconAtlas.image,o.properties.iconPositions=t.iconAtlas.positions),t.glyphAtlas&&(o.properties.glyphAtlas=t.glyphAtlas.image),Wl(e)||(o.properties.aFeaIds=t.featureIds,this.Bn(o,t)),t.markerPlacement&&(o.properties.markerPlacement=t.markerPlacement),t.textPlacement&&(o.properties.textPlacement=t.textPlacement),jn(o.properties,t.properties),{geometry:o,symbolIndex:t.symbolIndex}}getRayCastData(t,e){const{features:n,aFeaIds:i}=t.geometry.properties;return!n||!i?null:n[i[e]]}getPrimitive(){return"triangles"}getRenderFBO(t){return t&&t.renderTarget&&t.renderTarget.fbo}supportRenderMode(t){return t==="noAa"}drawDebugAtlas(t){if(document.getElementById("MAPTALKS_ICON_DEBUG")){const e=document.getElementById("MAPTALKS_ICON_DEBUG");let n;if(e.width=t.width,e.height=t.height,e.style.width=t.width+"px",e.style.height=t.height+"px",t.format==="alpha"){n=new Uint8ClampedArray(4*t.data.length);for(let o=0;o<t.data.length;o++)n[4*o+3]=t.data[o]}else n=new Uint8ClampedArray(t.data);const i=e.getContext("2d");i.imageSmoothingEnabled=!1,i.putImageData(new ImageData(n,t.width,t.height),0,0)}}}var QC=`#include <gl2_vert>
#ifdef HAS_ALTITUDE
attribute vec2 aPosition;
attribute float aAltitude;
#else
attribute vec3 aPosition;
#endif
uniform mat4 projViewModelMatrix;
#include <fbo_picking_vert>
#include <vt_position_vert>
void main() {
  vec3 c = unpackVTPosition();
  gl_Position = projViewModelMatrix * vec4(c, 1.);
  fbo_picking_setData(gl_Position.w, true);
}`;function Ku(r,t,e,n){if(n){const s=c0.resizeToPowerOfTwo(t.data,t.width,t.height);t.data=s}const i=t,o={width:i.width,height:i.height,data:i.data,format:i.format,mag:"linear",min:n?"linear mipmap linear":"linear",flipY:e,premultiplyAlpha:!0};if(t.type==="icon"){const s=t.dataType!=="point"?"repeat":"clamp";o.wrapS=s,o.wrapT=s}return r.texture(o)}const Iv=[0,0],Rv=[];function tP(r){if(!r.properties.iconPositions)return Iv;let t,e=0;for(const s in r.properties.iconPositions)if(t=s,e++,e>1)return Iv;if(!t)return Iv;const n=r.properties.iconPositions[t],i=n.displaySize[0],o=n.displaySize[1];return Rv[0]=i,Rv[1]=o,Rv}const UB=mn([]),Yi={polygonFill:[1,1,1,1],polygonOpacity:1,uvScale:[1,1],uvOffset:[0,0],patternWidth:[0,0],patternOffset:[0,0]},$B=[],Qu=new at(0,0),Xl=new at(0,0),eP=new at(0,0),nP=[];class op extends _s{static getBloomSymbol(){return["polygonBloom"]}prepareSymbol(t){const e=t.polygonFill;Array.isArray(e)&&(e.length===3&&e.push(1),t.polygonFill=e.map(n=>255*n))}supportRenderMode(t){return this.sceneConfig.antialias||this.sceneConfig.antialias===void 0?t==="fxaa"||t==="fxaaBeforeTaa":super.supportRenderMode(t)}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex)[op.getBloomSymbol()[0]]}forbiddenTerrainUpscale(){return!0}needPolygonOffset(){return!0}getAnalysisMeshes(){return this.isVisible()?this.scene.getMeshes().filter(t=>t.properties.level===0):$B}createMesh(t,e,n){const i=this.getMap(),{tilePoint:o}=n,{geometry:s,symbolIndex:a,ref:l}=t,h=this.layer instanceof En,u=this.layer.getTileSize().width,c=s.properties.tileExtent/u,f=s.properties.tileResolution,d=i.pointAtResToCoord(Qu.set(o[0],o[1]),f),p={tileExtent:s.properties.tileExtent,tileRatio:c},g=this.getSymbol(a),m=this.getSymbolDef(a);if(Ft(m.polygonPatternFileOrigin)&&this.qn(m,t,h?[0,0]:o,f),(Ft(m.polygonPatternFileWidth)||Ft(m.polygonPatternFileWidth))&&this.Kn(m,t,h?c:1,d,f),m.uvOffsetInMeter&&Ft(m.uvOffset)&&this.Jn(m,t,d,f),ue(p,"polygonFill",g,"polygonFill",Yi.polygonFill,xi(this.colorCache)),ue(p,"polygonOpacity",g,"polygonOpacity",Yi.polygonOpacity),ue(p,"uvScale",g,"uvScale",Yi.uvScale),l===void 0){const b=this.getFnTypeConfig(a);Vo(s,m,b),s.generateBuffers(this.regl)}const y=s.properties.iconAtlas,x=2048;if(y&&s.data.aTexInfo){const b=[];Object.defineProperty(p,"uvOrigin",{enumerable:!0,get:()=>{const S=p.tileScale;if(s.data.aPatternOrigin)return b[0]=o[0]*S%x,b[1]=o[1]*S%x,b;const M=g.polygonPatternFileOrigin;return M?(Qu.set(M[0],M[1]),i.coordToPointAtRes(Qu,f,Xl),Pe(b,o[0]-Xl.x,o[1]-Xl.y)):(b[0]=o[0]*S%x,b[1]=o[1]*S%x,b)}});const A=[];Object.defineProperty(p,"patternWidth",{enumerable:!0,get:()=>{if(s.data.aPatternWidth)return Yi.patternWidth;const S=m.polygonPatternFileWidth,M=m.polygonPatternFileHeight;if(!S&&!M)return Yi.patternWidth;const[E,P]=this.Zn(nP,S,M,h?c:1,d,f);return Pe(A,E,P)}}),Object.defineProperty(p,"uvOffset",{enumerable:!0,get:()=>s.data.aPatternOffset||m.uvOffsetInMeter?Yi.uvOffset:g.uvOffset||Yi.uvOffset});const T=[];Object.defineProperty(p,"patternOffset",{enumerable:!0,get:()=>{if(s.data.aPatternOffset||!m.uvOffsetInMeter)return Yi.uvOffset;const S=m.uvOffset;if(!S)return Yi.uvOffset;const M=co(i,S[0],d,f),E=co(i,S[1],d,f);return Pe(T,M,E)}}),Object.defineProperty(p,"tileScale",{enumerable:!0,get:function(){const S=m.polygonPatternFileWidth,M=m.polygonPatternFileHeight;return S||M?1:s.properties.tileResolution/i.getResolution()}}),p.polygonPatternFile=Ku(this.regl,y,!1,!1),p.atlasSize=[y.width,y.height],this.drawDebugAtlas(y)}const v=new Gr(p,Yi),_=new nn(s,v,{castShadow:!1,picking:!0}),w={};return y&&s.data.aTexInfo&&(w.HAS_PATTERN=1),y&&s.data.aTexCoord&&(w.HAS_TEX_COORD=1,w.INVALID_TEX_COORD=dv+".0"),s.data.aAltitude&&(w.HAS_ALTITUDE=1),s.data.aColor&&(w.HAS_COLOR=1),s.data.aOpacity&&(w.HAS_OPACITY=1),s.data.aUVScale&&(w.HAS_UV_SCALE=1),s.data.aUVOffset&&(w.HAS_UV_OFFSET=1),s.data.aPatternOrigin&&(w.HAS_PATTERN_ORIGIN=1),s.data.aPatternWidth&&(w.HAS_PATTERN_WIDTH=1),s.data.aPatternOffset&&(w.HAS_PATTERN_OFFSET=1),h&&(w.IS_VT=1),_.setDefines(w),_.setLocalTransform(e),_.properties.symbolIndex=a,_}Kn(t,e,n,i,o){if(!(e=e&&e.geometry))return;const s=e.properties.features;if(Wl(s))return;const a=t.polygonPatternFileWidth,l=t.polygonPatternFileHeight,h=le(t.polygonPatternFileOrigin);let u,c;Ft(a)&&(u=le(a)),Ft(l)&&(c=le(l));const{aPickingId:f,aPatternOrigin:d}=e.data,p=f.length,g=new Float32Array(2*p);let m,y,x;for(let v=0,_=f.length;v<_;v++){let w,b;if(f[v]===m){g[2*v]=y,g[2*v+1]=x;continue}const A=s[f[v]];if(w=u?u(null,A.feature.properties):a,b=c?c(null,A.feature.properties):l,m=f[v],w||b){let T=i;if(d){const E=h(null,A.feature.properties);E&&(T=eP.set(E[0],E[1]))}const[S,M]=this.Zn(nP,w,b,n,T,o);y=g[2*v]=S,x=g[2*v+1]=M}else y=g[2*v]=0,x=g[2*v+1]=0}e.data.aPatternWidth=g}Jn(t,e,n,i){if(!(e=e&&e.geometry))return;const o=e.properties.features;if(Wl(o))return;const s=this.getMap();let a=Ft(t.uvOffsetInMeter)&&cn(t.uvOffsetInMeter);const l=le(t.uvOffset),h=le(t.polygonPatternFileOrigin),{aPickingId:u,aPatternOrigin:c}=e.data,f=u.length,d=new Float32Array(2*f);let p,g,m;for(let y=0,x=u.length;y<x;y++){if(u[y]===p){d[2*y]=g,d[2*y+1]=m;continue}const v=o[u[y]],_=l(null,v.feature.properties);let w=!0;if(a&&(w=a(null,v.feature.properties)),p=u[y],_&&w){let b=n;if(c){const S=h(null,v.feature.properties);S&&(b=eP.set(S[0],S[1]))}const A=co(s,_[0],b,i),T=co(s,_[0],b,i);g=d[2*y]=A,m=d[2*y+1]=T}else g=d[2*y]=0,m=d[2*y+1]=0}e.data.aPatternOffset=d}qn(t,e,n,i){if(!(e=e&&e.geometry))return;const o=e.properties.features;if(Wl(o))return;const s=this.getMap(),a=le(t.polygonPatternFileOrigin),l=e.data.aPickingId,h=l.length,u=new Float32Array(2*h);let c,f,d;for(let p=0,g=l.length;p<g;p++){if(l[p]===c){u[2*p]=f,u[2*p+1]=d;continue}c=l[p];const m=a(null,o[c].feature.properties);m?(Qu.set(m[0],m[1]),s.coordToPointAtRes(Qu,i,Xl),f=u[2*p]=Xl.x,d=u[2*p+1]=Xl.y):(f=u[2*p]=n[0],d=u[2*p+1]=n[1])}e.data.aPatternOrigin=u}createFnTypeConfig(t,e){const n=cn(e.polygonFill),i=le(e.polygonOpacity),o=le(e.uvScale),s=le(e.uvOffset),a=new Uint8Array(1),l=new Uint16Array(2),h=new Uint8Array(2);return[{attrName:"aColor",symbolName:"polygonFill",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(u,c)=>{let f=n(t.getZoom(),u);return Ft(f)&&(f=this.evaluateInFnTypeConfig(f,c,t,u,!0)),Array.isArray(f)||(f=this.colorCache[f]=this.colorCache[f]||Wi(f).unitArray()),f=fa(f),f}},{attrName:"aOpacity",symbolName:"polygonOpacity",type:Uint8Array,width:1,define:"HAS_OPACITY",evaluate:(u,c)=>{let f=i(t.getZoom(),u);return Ft(f)&&(f=this.evaluateInFnTypeConfig(f,c,t,u)),a[0]=255*f,a[0]}},{attrName:"aUVScale",symbolName:"uvScale",type:Uint16Array,width:2,define:"HAS_UV_SCALE",evaluate:u=>{const c=o(t.getZoom(),u);return l[0]=255*c[0],l[1]=255*c[1],l}},{attrName:"aUVOffset",symbolName:"uvOffset",type:Uint8Array,width:2,define:"HAS_UV_OFFSET",evaluate:u=>{const c=s(t.getZoom(),u);return h[0]=255*c[0],h[1]=255*c[1],h}}]}paint(t){this.isShadowIncludeChanged(t)&&(this.shader.dispose(),this.Qn(t)),super.paint(t)}isEnableTileStencil(t){const e=this.layer.getJSONType()==="VectorTileLayer",n=this.layer instanceof En;return!(t&&t.isRenderingTerrain&&this.isTerrainSkin())&&(e||n&&this.isOnly2D())}init(t){const e=this.regl,n=this.canvas,i={x:(s,a)=>a.viewport?a.viewport.x:0,y:(s,a)=>a.viewport?a.viewport.y:0,width:(s,a)=>a.viewport?a.viewport.width:n?n.width:1,height:(s,a)=>a.viewport?a.viewport.height:n?n.height:1};this.renderer=new un(e);const o={viewport:i,stencil:{enable:()=>this.isEnableTileStencil(t),func:{cmp:()=>this.isOnly2D()?"=":"<=",ref:(s,a)=>a.stencilRef},op:{fail:"keep",zfail:"keep",zpass:()=>{const s=this.layer.getJSONType()==="VectorTileLayer",a=this.isOnly2D();return s&&a?"zero":"replace"}}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],mask:(s,a)=>{if(!wn(this.sceneConfig.depthMask))return!!this.sceneConfig.depthMask;if(a.hasSSRGround)return!0;if(a.meshConfig.transparent)return!1;const l=a.polygonOpacity;return!(_v(l)&&l<1)},func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}};if(this.Qn(t,o),this.pickingFBO){const s=[];this.picking=[new Pi(this.renderer,{vert:QC,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(a,l){return qt(s,l.projViewMatrix,l.modelMatrix),s}}],extraCommandProps:o},this.pickingFBO,this.getMap())]}}Qn(t,e){const n=[],i=[{name:"projViewModelMatrix",type:"function",fn:function(s,a){return qt(n,a.projViewMatrix,a.modelMatrix),n}}],o={};this.fillIncludes(o,i,t),this.shader=new Ye({vert:`#define SHADER_NAME FILL
#ifdef HAS_ALTITUDE
attribute vec2 aPosition;
attribute float aAltitude;
#else
attribute vec3 aPosition;
#endif
#ifdef HAS_COLOR
attribute vec4 aColor;
varying vec4 vColor;
#endif
#ifdef HAS_OPACITY
attribute float aOpacity;
varying float vOpacity;
#endif
uniform mat4 projViewModelMatrix;
#ifndef IS_VT
uniform mat4 modelMatrix;
#endif
#ifdef HAS_PATTERN
#ifdef HAS_TEX_COORD
attribute vec2 aTexCoord;
#endif
attribute vec4 aTexInfo;
uniform vec2 patternWidth;
uniform vec2 patternOffset;
uniform vec2 uvOrigin;
uniform vec2 uvScale;
#ifdef IS_VT
uniform float tileRatio;
uniform float tileScale;
#else
uniform float glScale;
#endif
#ifdef HAS_UV_SCALE
attribute vec2 aUVScale;
varying vec2 vUVScale;
#endif
#ifdef HAS_UV_OFFSET
attribute vec2 aUVOffset;
varying vec2 vUVOffset;
#endif
#ifdef HAS_PATTERN_WIDTH
attribute vec2 aPatternWidth;
#endif
#ifdef HAS_PATTERN_ORIGIN
attribute vec2 aPatternOrigin;
#endif
#ifdef HAS_PATTERN_OFFSET
attribute vec2 aPatternOffset;
#endif
varying vec2 vTexCoord;
varying vec4 vTexInfo;
vec2 c(vec2 d, vec2 e) {
  
#ifdef IS_VT
float f = d.x / e.x;
  float h = d.y / e.y;
  return vec2(f, h);
#else
float i = glScale;
#ifdef HAS_PATTERN_WIDTH
float j = sign(length(aPatternWidth));
  i = mix(glScale, 1., j);
#endif
vec2 k = uvOrigin;
#ifdef HAS_PATTERN_ORIGIN
k = aPatternOrigin;
#endif
#ifdef HAS_PATTERN_OFFSET
vec2 l = aPatternOffset;
#else
vec2 l = patternOffset;
#endif
k += l;
  float f = (d.x - k.x) * i / e.x;
  float h = (d.y - k.y) * i / e.y;
  return vec2(f, -h);
#endif
}
vec2 m(vec4 n, vec2 o) {
  
#ifdef IS_VT
#ifdef HAS_PATTERN_OFFSET
vec2 l = aPatternOffset;
#else
vec2 l = patternOffset;
#endif
vec2 k = uvOrigin + l;
#ifdef HAS_PATTERN_ORIGIN
k = k - aPatternOrigin * tileScale;
#endif
float j = sign(length(patternWidth));
  vec2 A = mix(o, patternWidth, j);
#ifdef HAS_PATTERN_WIDTH
A = aPatternWidth;
#endif
vec2 B = k * vec2(1., -1.) / A;
  return mod(B, 1.) + c(n.xy * tileScale / tileRatio, A);
#else
vec2 A = o;
#ifdef HAS_PATTERN_WIDTH
float j = sign(length(aPatternWidth));
  A = mix(o, aPatternWidth, j);
#endif
vec4 C = modelMatrix * n;
  return c(C.xy, A);
#endif
}
#endif
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
#include <vsm_shadow_vert>
#endif
#include <vt_position_vert>
#include <highlight_vert>
void main() {
  vec3 D = unpackVTPosition();
  vec4 n = vec4(D, 1.);
  gl_Position = projViewModelMatrix * n;
#ifdef HAS_PATTERN
vec2 o = aTexInfo.zw + 1.;
  vTexInfo = vec4(aTexInfo.xy, o);
#ifdef HAS_TEX_COORD
if(aTexCoord.x == INVALID_TEX_COORD) {
    vTexCoord = m(n, o);
  } else {
    vTexCoord = aTexCoord;
  }
#else
vTexCoord = m(n, o);
#endif
#ifdef HAS_UV_SCALE
vUVScale = aUVScale / 255.;
#endif
#ifdef HAS_UV_OFFSET
vUVOffset = aUVOffset / 255.;
#endif
#endif
#ifdef HAS_COLOR
vColor = aColor / 255.;
#endif
highlight_setVarying();
#ifdef HAS_OPACITY
vOpacity = aOpacity / 255.;
#endif
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
shadow_computeShadowPars(n);
#endif
}`,frag:`#define SHADER_NAME FILL
precision mediump float;
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
#include <vsm_shadow_frag>
#endif
#ifdef HAS_PATTERN
#ifdef HAS_UV_SCALE
varying vec2 vUVScale;
#else
uniform highp vec2 uvScale;
#endif
#ifdef HAS_UV_OFFSET
varying vec2 vUVOffset;
#else
uniform vec2 uvOffset;
#endif
#endif
#ifdef HAS_PATTERN
uniform sampler2D polygonPatternFile;
uniform vec2 atlasSize;
varying vec2 vTexCoord;
varying vec4 vTexInfo;
vec2 c() {
  
#ifdef HAS_UV_SCALE
vec2 d = vUVScale;
#else
vec2 d = uvScale;
#endif
#ifdef HAS_UV_OFFSET
vec2 e = vUVOffset;
#else
vec2 e = uvOffset;
#endif
vec2 f = mod(vTexCoord * d + e, 1.);
  vec2 h = vTexInfo.xy;
  vec2 i = vTexInfo.zw;
  return (h + f * i) / atlasSize;
}
#endif
#ifdef HAS_COLOR
varying vec4 vColor;
#else
uniform vec4 polygonFill;
#endif
#include <highlight_frag>
#ifdef HAS_OPACITY
varying float vOpacity;
#else
uniform lowp float polygonOpacity;
#endif
uniform float layerOpacity;
uniform float tileExtent;
void main() {
  
#ifdef HAS_COLOR
vec4 j = vColor;
#else
vec4 j = polygonFill;
#endif
#ifdef HAS_PATTERN
if(vTexInfo.z * vTexInfo.w > 1.) {
    vec2 f = c();
    j = texture2D(polygonPatternFile, f);
  }
#endif
#ifdef HAS_OPACITY
gl_FragColor = j * vOpacity;
#else
gl_FragColor = j * polygonOpacity;
#endif
gl_FragColor *= layerOpacity;
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
float k = shadow_computeShadow();
  gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, k);
#endif
gl_FragColor = highlight_blendColor(gl_FragColor);
}`,uniforms:i,defines:o,extraCommandProps:e})}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin,i={projViewMatrix:n?UB:t.projViewMatrix,glScale:e&&e.isRenderingTerrainSkin?1:1/t.getGLScale(),viewport:n&&e&&e.viewport,hasSSRGround:e&&e.hasSSRGround};return this.setIncludeUniformValues(i,e),i}Zn(t,e,n,i,o,s){let a,l;const h=this.getMap();return e&&(a=co(h,e,o,s)),n&&(l=co(h,n,o,s,1)),a=a||l,l=l||a,t[0]=a,t[1]=l,t}}var Dv=`#define SHADER_NAME LINE
#define AA_CLIP_LIMIT 2.0
#define AA_LINE_WIDTH 16.0
#define DEVICE_PIXEL_RATIO 1.0
#define ANTIALIASING 1.0 / DEVICE_PIXEL_RATIO / 2.0
#define EXTRUDE_SCALE 63.0
#define EXTRUDE_MOD 64.0
#define MAX_LINE_DISTANCE 65535.0
#ifdef PICKING_MODE
#include <gl2_vert>
#endif
#ifdef HAS_ALTITUDE
attribute vec2 aPosition;
attribute float aAltitude;
#else
attribute vec3 aPosition;
#endif
#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY)
attribute vec3 aExtrude;
#else
attribute vec2 aExtrude;
#endif
#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT) || defined(HAS_TRAIL)
attribute float aLinesofar;
varying highp float vLinesofar;
#endif
uniform float cameraToCenterDistance;
#if defined(HAS_STROKE_WIDTH)
attribute float aLineStrokeWidth;
#else
uniform float lineStrokeWidth;
#endif
uniform mat4 positionMatrix;
uniform mat4 projViewModelMatrix;
uniform mat4 modelMatrix;
uniform float tileResolution;
uniform float resolution;
uniform float tileRatio;
uniform float isRenderingTerrain;
#if defined(HAS_LINE_DX) || defined(HAS_LINE_DY)
attribute vec2 aLineDxDy;
#endif
#ifndef HAS_LINE_DX
uniform float lineDx;
#endif
#ifndef HAS_LINE_DY
uniform float lineDy;
#endif
uniform vec2 canvasSize;
uniform float layerScale;
varying vec2 vNormal;
varying vec2 vWidth;
varying float vGammaScale;
#ifndef ENABLE_TILE_STENCIL
varying vec2 vPosition;
#endif
#ifdef USE_LINE_OFFSET
attribute vec2 aExtrudeOffset;
#endif
#ifdef HAS_LINE_WIDTH
attribute float aLineWidth;
#else
uniform float lineWidth;
#endif
#ifndef PICKING_MODE
#ifndef HAS_GRADIENT
#ifdef HAS_COLOR
attribute vec4 aColor;
varying vec4 vColor;
#endif
#ifdef HAS_PATTERN
#if defined(HAS_PATTERN_ANIM) || defined(HAS_PATTERN_GAP)
attribute vec2 aLinePattern;
#endif
#ifdef HAS_PATTERN_ANIM
varying float vLinePatternAnimSpeed;
#endif
#ifdef HAS_PATTERN_GAP
varying float vLinePatternGap;
#endif
attribute vec4 aTexInfo;
varying vec4 vTexInfo;
#endif
#ifdef HAS_DASHARRAY
#ifdef HAS_DASHARRAY_ATTR
attribute vec4 aDasharray;
varying vec4 vDasharray;
#endif
#ifdef HAS_DASHARRAY_COLOR
attribute vec4 aDashColor;
varying vec4 vDashColor;
#endif
#endif
#endif
#ifdef HAS_STROKE_COLOR
attribute vec4 aStrokeColor;
varying vec4 vStrokeColor;
#endif
#ifdef HAS_OPACITY
attribute float aOpacity;
varying float vOpacity;
#endif
#ifdef HAS_GRADIENT
attribute float aGradIndex;
varying float vGradIndex;
#endif
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
#include <vsm_shadow_vert>
#endif
#include <highlight_vert>
#else
#include <fbo_picking_vert>
#endif
varying vec3 vVertex;
#include <vt_position_vert>
void main() {
  vec3 c = unpackVTPosition();
  float d = mod(abs(aExtrude.x), 2.);
  float e = mod(abs(aExtrude.y), 2.);
  vNormal = vec2(d, e * 2. - 1.);
  vec4 f = vec4(c, 1.);
  vec4 h = projViewModelMatrix * positionMatrix * f;
  if(isRenderingTerrain == 1.) {
    vVertex = (positionMatrix * f).xyz;
  } else {
    vVertex = (modelMatrix * positionMatrix * f).xyz;
  }
#ifdef HAS_STROKE_WIDTH
float i = aLineStrokeWidth / 2. * layerScale;
#else
float i = lineStrokeWidth;
#endif
#ifdef HAS_LINE_WIDTH
float j = aLineWidth / 2. * layerScale;
#else
float j = lineWidth * layerScale;
#endif
float k = j / 2. + i;
  float l = sign(i) * j / 2.;
  float m = l + sign(l) * ANTIALIASING;
  float n = k + sign(k) * ANTIALIASING;
#ifdef USE_LINE_OFFSET
vec2 o = lineOffset * (vNormal.y * (aExtrude.xy - aExtrudeOffset) + aExtrudeOffset);
  vec2 u = (n * aExtrude.xy + o) / EXTRUDE_SCALE;
#else
vec2 v = aExtrude.xy / EXTRUDE_SCALE;
  vec2 u = n * v;
#endif
float A = tileResolution / resolution;
  vec4 B = vec4(c + vec3(u, .0) * tileRatio / A, 1.);
  gl_Position = projViewModelMatrix * positionMatrix * B;
  if(isRenderingTerrain == .0) {
    float C = min(AA_CLIP_LIMIT / canvasSize.x, AA_CLIP_LIMIT / canvasSize.y);
    float D = distance(gl_Position.xy / gl_Position.w, h.xy / h.w) - C;
    if(D * j < .0) {
      float E = -D / C;
      float F = E * E * E * E * AA_LINE_WIDTH;
      u += F * v;
      n += F / 6.;
      B = vec4(c + vec3(u, .0) * tileRatio / A, 1.);
      gl_Position = projViewModelMatrix * positionMatrix * B;
    }
  }
#ifdef HAS_LINE_DX
float G = aLineDxDy[0];
#else
float G = lineDx;
#endif
#ifdef HAS_LINE_DY
float H = aLineDxDy[1];
#else
float H = lineDy;
#endif
float I = gl_Position.w;
  gl_Position.xy += vec2(G, H) * 2. / canvasSize * I;
#ifndef PICKING_MODE
vWidth = vec2(n, m);
  if(isRenderingTerrain == 1.) {
    vGammaScale = 1.;
  } else {
    vGammaScale = I / cameraToCenterDistance;
  }
#ifndef ENABLE_TILE_STENCIL
vPosition = c.xy;
#ifdef USE_LINE_OFFSET
vPosition += tileRatio * o / EXTRUDE_SCALE;
#endif
#endif
#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT)
#ifdef HAS_GRADIENT
vLinesofar = aLinesofar / MAX_LINE_DISTANCE;
  vGradIndex = aGradIndex;
#else
float J = aLinesofar - k * aExtrude.z / EXTRUDE_SCALE / A * tileRatio;
  vLinesofar = J / tileRatio * A;
#endif
#endif
#ifndef HAS_GRADIENT
#ifdef HAS_COLOR
vColor = aColor;
#endif
#ifdef HAS_DASHARRAY
#ifdef HAS_DASHARRAY_ATTR
vDasharray = aDasharray;
#endif
#ifdef HAS_DASHARRAY_COLOR
vDashColor = aDashColor / 255.;
#endif
#endif
#ifdef HAS_PATTERN
vTexInfo = vec4(aTexInfo.xy, aTexInfo.zw + 1.);
#ifdef HAS_PATTERN_ANIM
vLinePatternAnimSpeed = aLinePattern[0] / 127.;
#endif
#ifdef HAS_PATTERN_GAP
vLinePatternGap = aLinePattern[1] / 10.0;
#endif
#endif
#endif
#ifdef HAS_STROKE_COLOR
vStrokeColor = aStrokeColor;
#endif
#ifdef HAS_OPACITY
vOpacity = aOpacity / 255.;
#endif
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
shadow_computeShadowPars(B);
#endif
highlight_setVarying();
#else
fbo_picking_setData(I, true);
#endif
}`;const WB=mn([]),ZB=[];class tc extends _s{static getBloomSymbol(){return["lineBloom"]}isUniqueStencilRefPerTile(){return!1}prepareSymbol(t){const e=t.lineColor;Array.isArray(e)&&(e.length===3&&e.push(1),t.lineColor=e.map(o=>255*o));const n=t.lineStrokeColor;Array.isArray(n)&&(n.length===3&&n.push(1),t.lineStrokeColor=n.map(o=>255*o));const i=t.lineDashColor;Array.isArray(i)&&(i.length===3&&i.push(1),t.lineDashColor=i.map(o=>255*o))}isAnimating(){if(this.ti)return!0;const t=this.getSymbols(),e=this.sceneConfig.trailAnimation;if(e&&e.enable)return!0;for(let n=0;n<t.length;n++)if(t[n].linePatternFile&&t[n].linePatternAnimSpeed)return!0;return!1}needToRedraw(){return!!super.needToRedraw()||!!this.isAnimating()}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex)[tc.getBloomSymbol()[0]]}needPolygonOffset(){return!0}createMesh(t,e){if(!t.geometry)return null;const{geometry:n,symbolIndex:i,ref:o}=t,s=this.getSymbolDef(i);o===void 0&&Vo(n,s,this.getFnTypeConfig(i));const a=this.getSymbol(i),l={tileResolution:n.properties.tileResolution,tileRatio:n.properties.tileRatio,tileExtent:n.properties.tileExtent};this.setLineUniforms(a,l),ue(l,"lineColor",a,"lineColor","#fff",xi(this.colorCache)),ue(l,"linePatterGapColor",a,"linePatterGapColor",[0,0,0,0],xi(this.colorCache)),ue(l,"lineStrokeColor",a,"lineStrokeColor",[0,0,0,0],xi(this.colorCache)),ue(l,"lineDasharray",a,"lineDasharray",[0,0,0,0],p=>{let g;if(p&&p.length){const m=p;p.length===1?g=[m[0],m[0],m[0],m[0]]:p.length===2?g=[m[0],m[1],m[0],m[1]]:p.length===3?g=[m[0],m[1],m[2],m[2]]:p.length===4?g=p:p.length>4&&(g=p.slice(0,4))}return g||[0,0,0,0]}),ue(l,"lineDashColor",a,"lineDashColor",[0,0,0,0],xi(this.colorCache));const h=n.properties.iconAtlas,u=this.layer instanceof En;h&&(l.linePatternFile=Ku(this.regl,h,!1,!1),l.atlasSize=h?[h.width,h.height]:[0,0],l.flipY=u?-1:1,this.drawDebugAtlas(h)),o===void 0&&n.generateBuffers(this.regl);const c=new Gr(l),f=new nn(n,c,{castShadow:!1,picking:!0});f.setLocalTransform(e),f.positionMatrix=this.getAltitudeOffsetMatrix();const d={};return h&&(d.HAS_PATTERN=1),f.properties.symbolIndex=i,this.ei(f,d),n.data.aColor&&(d.HAS_COLOR=1),n.data.aStrokeColor&&(d.HAS_STROKE_COLOR=1),this.setMeshDefines(d,n,s),n.data.aAltitude&&(d.HAS_ALTITUDE=1),f.setDefines(d),f}addMesh(...t){delete this.ti;const e=t[0];Array.isArray(e)?e.forEach(n=>{this.ni(n)}):this.ni(e),super.addMesh(...t)}ni(t){if(!t.geometry.aLineWidth&&t.material.get("lineWidth")<=0||!t.geometry.aOpacity&&t.material.get("lineOpacity")<=0)return;const e=t.defines;this.ei(t,e),t.setDefines(e),t.geometry.properties.hasPatternAnim&&(this.ti=1)}ei(t,e){const n=t.geometry,i=this.getSymbol(t.properties.symbolIndex);n.data.aDasharray||Array.isArray(i.lineDasharray)&&i.lineDasharray.reduce((o,s)=>o+s,0)>0?(e.HAS_DASHARRAY=1,n.data.aDasharray&&(e.HAS_DASHARRAY_ATTR=1),n.data.aDashColor&&(e.HAS_DASHARRAY_COLOR=1)):e.HAS_DASHARRAY&&delete e.HAS_DASHARRAY}setLineUniforms(t,e){ue(e,"lineWidth",t,"lineWidth",2),ue(e,"lineOpacity",t,"lineOpacity",1),ue(e,"lineStrokeWidth",t,"lineStrokeWidth",0),ue(e,"lineBlur",t,"lineBlur",.7),ue(e,"lineOffset",t,"lineOffset",0),ue(e,"lineDx",t,"lineDx",0),ue(e,"lineDy",t,"lineDy",0),ue(e,"linePatternAnimSpeed",t,"linePatternAnimSpeed",0),ue(e,"linePatternGap",t,"linePatternGap",0)}setMeshDefines(t,e,n){e.data.aOpacity&&(t.HAS_OPACITY=1),e.data.aLineWidth&&(t.HAS_LINE_WIDTH=1),e.data.aLineStrokeWidth&&(t.HAS_STROKE_WIDTH=1),fo(n.lineDx)&&(t.HAS_LINE_DX=1),fo(n.lineDy)&&(t.HAS_LINE_DY=1),fo(n.linePatternAnimSpeed)&&(t.HAS_PATTERN_ANIM=1),fo(n.linePatternGap)&&(t.HAS_PATTERN_GAP=1)}paint(t){this.isShadowIncludeChanged(t)&&(this.shader.dispose(),this.createShader(t)),super.paint(t)}createFnTypeConfig(t,e){const n=cn(e.lineColor),i=cn(e.aLinePatternAnimSpeed),o=cn(e.aLinePatternGap),s=this.createShapeFnTypeConfigs(t,e),a=new Int8Array(2);return[{attrName:"aColor",symbolName:"lineColor",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(l,h)=>{let u=n(t.getZoom(),l);return Ft(u)&&(u=this.evaluateInFnTypeConfig(u,h,t,l,!0)),Array.isArray(u)||(u=this.colorCache[u]=this.colorCache[u]||Wi(u).unitArray()),u=fa(u),u}},{attrName:"aLinePattern",symbolName:"linePatternAnimSpeed",type:Int8Array,width:2,related:["linePatternGap"],define:"HAS_LINE_PATTERN",evaluate:(l,h,u,c)=>{let f=i(t.getZoom(),l);return wn(f)&&(f=0),f!==0&&(h.properties.hasPatternAnim=1),a[0]=f/127,a[1]=u[c+1],a}},{attrName:"aLinePattern",symbolName:"linePatternGap",type:Int8Array,width:2,related:["linePatternAnimSpeed"],define:"HAS_LINE_PATTERN",evaluate:(l,h,u,c)=>{let f=o(t.getZoom(),l);return wn(f)&&(f=0),a[1]=10*f,a[0]=u[c],a}}].concat(s)}createShapeFnTypeConfigs(t,e){const n=le(e.lineWidth),i=le(e.lineOpacity),o=le(e.lineStrokeWidth),s=le(e.lineDx),a=le(e.lineDy),l=new Uint16Array(1),h=new Int8Array(1);return[{attrName:"aLineWidth",symbolName:"lineWidth",type:Uint8Array,width:1,define:"HAS_LINE_WIDTH",evaluate:(u,c)=>{let f=n(t.getZoom(),u);return Ft(f)&&(f=this.evaluateInFnTypeConfig(f,c,t,u)),l[0]=Math.round(2*f),l[0]}},{attrName:"aLineStrokeWidth",symbolName:"lineStrokeWidth",type:Uint8Array,width:1,define:"HAS_STROKE_WIDTH",evaluate:u=>{const c=o(t.getZoom(),u);return l[0]=Math.round(2*c),l[0]}},{attrName:"aLineDxDy",symbolName:"lineDx",type:Int8Array,width:2,define:"HAS_LINE_DX",evaluate:u=>{const c=s(t.getZoom(),u);return h[0]=c,h[0]}},{attrName:"aLineDxDy",symbolName:"lineDy",type:Int8Array,width:2,define:"HAS_LINE_DY",evaluate:u=>{const c=a(t.getZoom(),u);return h[0]=c,h[0]}},{attrName:"aOpacity",symbolName:"lineOpacity",type:Uint8Array,width:1,define:"HAS_OPACITY",evaluate:(u,c)=>{let f=i(t.getZoom(),u);return Ft(f)&&(f=this.evaluateInFnTypeConfig(f,c,t,u)),l[0]=255*f,l[0]}}]}updateSceneConfig(t){t.trailAnimation&&this.createShader(this.ii)}init(t){const e=this.regl;this.renderer=new un(e),this.createShader(t),this.pickingFBO&&(this.picking=[new Pi(this.renderer,{vert:`#define PICKING_MODE 1
`+Dv,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(n,i){const o=[];return qt(o,i.projViewMatrix,i.modelMatrix),o}}],extraCommandProps:this.getExtraCommandProps()},this.pickingFBO,this.getMap())])}createShader(t){this.ii=t;const e=[],n={};this.fillIncludes(n,e,t),this.sceneConfig.trailAnimation&&this.sceneConfig.trailAnimation.enable&&(n.HAS_TRAIL=1);const i=[];e.push({name:"projViewModelMatrix",type:"function",fn:function(o,s){return qt(i,s.projViewMatrix,s.modelMatrix),i}}),this.shader=new Ye({vert:Dv,frag:`#define SHADER_NAME LINE
#define DEVICE_PIXEL_RATIO 1.0
precision highp float;
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
#include <vsm_shadow_frag>
#endif
uniform lowp float blendSrcIsOne;
uniform lowp float lineBlur;
uniform float isRenderingTerrain;
#ifdef HAS_COLOR
varying vec4 vColor;
#else
uniform lowp vec4 lineColor;
#endif
#include <highlight_frag>
#ifdef HAS_STROKE_COLOR
varying vec4 vStrokeColor;
#else
uniform lowp vec4 lineStrokeColor;
#endif
#ifdef HAS_OPACITY
varying float vOpacity;
#else
uniform lowp float lineOpacity;
#endif
uniform float layerOpacity;
#ifdef HAS_PATTERN
uniform sampler2D linePatternFile;
uniform vec2 atlasSize;
uniform float flipY;
#ifdef HAS_PATTERN_ANIM
varying float vLinePatternAnimSpeed;
#else
uniform float linePatternAnimSpeed;
#endif
#ifdef HAS_PATTERN_GAP
varying float vLinePatternGap;
#else
uniform float linePatternGap;
#endif
uniform vec4 linePatterGapColor;
varying vec4 vTexInfo;
vec2 c(vec2 d) {
  vec2 e = mod(d, 1.);
  vec2 f = vTexInfo.xy;
  vec2 h = vTexInfo.zw;
  return (f + e * h) / atlasSize;
}
#endif
varying vec2 vNormal;
varying vec2 vWidth;
varying float vGammaScale;
#ifndef ENABLE_TILE_STENCIL
varying vec2 vPosition;
#endif
uniform float tileExtent;
#ifdef HAS_DASHARRAY
#ifdef HAS_DASHARRAY_ATTR
varying vec4 vDasharray;
#else
uniform vec4 lineDasharray;
#endif
#ifdef HAS_DASHARRAY_COLOR
varying vec4 vDashColor;
#else
uniform vec4 lineDashColor;
#endif
#endif
#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT) || defined(HAS_TRAIL)
varying highp float vLinesofar;
#endif
#ifdef HAS_TRAIL
uniform float trailSpeed;
uniform float trailLength;
uniform float trailCircle;
#endif
#if defined(HAS_TRAIL) || defined(HAS_PATTERN)
uniform float currentTime;
#endif
float i(float j, float k) {
  float l = k / 2.;
  float m = abs(j - l);
  float n = (.1 + 1. / DEVICE_PIXEL_RATIO) * vGammaScale;
  return clamp(min(m + n, l - m) / n, .0, 1.);
}
varying vec3 vVertex;
uniform vec3 cameraPosition;
uniform float cameraToCenterDistance;
void main() {
  
#ifndef ENABLE_TILE_STENCIL
float o = sign(tileExtent - min(tileExtent, abs(vPosition.x))) * sign(1. + sign(vPosition.x)) * sign(tileExtent - min(tileExtent, abs(vPosition.y))) * sign(1. + sign(vPosition.y));
  if(o == .0) {
    discard;
  }
#endif
#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT) || defined(HAS_TRAIL)
float u = vLinesofar;
#endif
float v = length(vNormal) * vWidth.s;
#ifdef HAS_PATTERN
vec2 h = vTexInfo.zw;
  float A = sign(h.x * h.y);
  float B = mix(lineBlur, .0, A);
#else
float B = lineBlur;
#endif
float n = (B + 1. / DEVICE_PIXEL_RATIO) * vGammaScale;
  float C = clamp(min(v - (vWidth.t - n), vWidth.s - v) / n, .0, 1.);
#ifdef HAS_COLOR
vec4 D = vColor / 255.;
#else
vec4 D = lineColor;
#endif
#ifdef HAS_PATTERN
if(A == 1.) {
    
#ifdef HAS_PATTERN_GAP
float E = vLinePatternGap;
#else
float E = linePatternGap;
#endif
#ifdef HAS_PATTERN_ANIM
float F = vLinePatternAnimSpeed;
#else
float F = linePatternAnimSpeed;
#endif
float G = h.x * vWidth.s * 2. / h.y;
    float H = G * (1. + E);
    u += mod(currentTime * -F * .2, H);
    float I = mod(u / H, 1.);
    float J = mod((flipY * vNormal.y + 1.) / 2., 1.);
    vec4 K = texture2D(linePatternFile, c(vec2(I * (1. + E), J)));
    float L = clamp(sign(1. / (1. + E) - I) + .000001, .0, 1.);
    K = mix(linePatterGapColor, K, L);
    D *= K;
  }
#endif
#ifdef HAS_DASHARRAY
#ifdef HAS_DASHARRAY_ATTR
vec4 M = vDasharray;
#else
vec4 M = lineDasharray;
#endif
#ifdef HAS_DASHARRAY_COLOR
vec4 N = vDashColor;
#else
vec4 N = lineDashColor;
#endif
float k = M[0] + M[1] + M[2] + M[3];
  float j = mod(u, k);
  float O = max(sign(M[0] - j), .0);
  float P = j - M[0] - M[1];
  float Q = max(sign(P), .0) * max(sign(M[2] - P), .0);
  float R = O + Q;
  float S = i(j, M[0]);
  float T = i(P, M[2]);
  float U = S * O + T * Q;
  D = D * (1. - U) + N * U;
#endif
#ifdef HAS_STROKE_COLOR
vec4 V = vStrokeColor / 255.;
#else
vec4 V = lineStrokeColor;
#endif
V = mix(D, V, sign(vWidth.t));
  D = V * C + max(sign(vWidth.t - v), .0) * D * (1. - C);
#ifdef HAS_TRAIL
float W = mod(u - currentTime * trailSpeed * .1, trailCircle);
  float X = W < trailLength ? mix(.0, 1., W / trailLength) : .0;
  D *= X;
#endif
#ifdef HAS_OPACITY
float Y = vOpacity;
#else
float Y = lineOpacity;
#endif
gl_FragColor = D * Y * layerOpacity;
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
float Z = shadow_computeShadow();
  gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, Z);
#endif
float ba;
  if(isRenderingTerrain == 1.) {
    ba = 1.;
  } else {
    ba = clamp(cameraToCenterDistance * 1.5 / distance(vVertex, cameraPosition), .0, 1.);
  }
  gl_FragColor *= ba;
  gl_FragColor = highlight_blendColor(gl_FragColor);
}`,uniforms:e,defines:n,extraCommandProps:this.getExtraCommandProps(t)})}isEnableTileStencil(t){return!(t&&t.isRenderingTerrain&&this.isTerrainSkin())}getExtraCommandProps(t){const e=this.canvas;return{viewport:{x:(n,i)=>i.viewport?i.viewport.x:0,y:(n,i)=>i.viewport?i.viewport.y:0,width:(n,i)=>i.viewport?i.viewport.width:e?e.width:1,height:(n,i)=>i.viewport?i.viewport.height:e?e.height:1},stencil:{enable:()=>this.isEnableTileStencil(t),mask:255,func:{cmp:()=>"<=",ref:(n,i)=>i.stencilRef},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],mask:this.sceneConfig.depthMask||!1,func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin,i=this.layer.getTileSize().width,o=n?WB:t.projViewMatrix,s=t.viewMatrix,a=t.cameraToCenterDistance,l=t.getResolution(),h=Pe(ZB,t.width,t.height);n&&Pe(h,i,i);const u=this.getBlendFunc().src(),c=this.sceneConfig.trailAnimation||{},f={layerScale:this.layer.options.styleScale||1,projViewMatrix:o,viewMatrix:s,cameraToCenterDistance:a,resolution:l,canvasSize:h,trailSpeed:c.speed||1,trailLength:c.trailLength||500,trailCircle:c.trailCircle||1e3,currentTime:this.layer.getRenderer().getFrameTimestamp()||0,blendSrcIsOne:+!(u!==1&&u!=="one"),cameraPosition:t.cameraPosition,viewport:n&&e&&e.viewport,isRenderingTerrain:+!!n};return this.setIncludeUniformValues(f,e),f}}class rP extends tc{postCreateGeometry(t){const{symbolIndex:e,geometry:n}=t,{features:i}=n.properties,o=this.getSymbol(e).lineGradientProperty,s=n.data.aPickingId,a=new Uint8Array(s.length),l=[];let h=s[0];const u=i[h].feature.properties;l.push(u&&u[o]||0);for(let c=1;c<s.length;c++)s[c]!==h&&(h=s[c],l.push(u&&u[o]||0)),a[c]=l.length-1;n.data.aGradIndex=a,n.properties.gradients=l}createMesh(t,e){const{geometry:n,symbolIndex:i,ref:o}=t,s=this.getSymbolDef(i);o===void 0&&Vo(n,s,this.getFnTypeConfig(i));const a={tileResolution:n.properties.tileResolution,tileRatio:n.properties.tileRatio,tileExtent:n.properties.tileExtent},l=this.getSymbol(i);this.setLineUniforms(l,a);const h=n.properties.gradients;let u=2*h.length;iP(u)||(u=oP(u));const c=this.regl.texture({width:256,height:u,data:XB(h),format:"rgba",mag:"linear",min:"linear",flipY:!1});a.lineGradientTexture=c,a.lineGradientTextureHeight=c.height,o===void 0&&n.generateBuffers(this.regl);const f=new Gr(a),d=new nn(n,f,{castShadow:!1,picking:!0});d.setLocalTransform(e);const p={HAS_GRADIENT:1};return n.data.aAltitude&&(p.HAS_ALTITUDE=1),this.setMeshDefines(p,n,s),d.setDefines(p),d.properties.symbolIndex=i,d}createFnTypeConfig(t,e){return this.createShapeFnTypeConfigs(t,e)}createShader(t){this.ii=t;const e=[],n={};this.fillIncludes(n,e,t),this.sceneConfig.trailAnimation&&this.sceneConfig.trailAnimation.enable&&(n.HAS_TRAIL=1);const i=[];e.push({name:"projViewModelMatrix",type:"function",fn:function(o,s){return qt(i,s.projViewMatrix,s.modelMatrix),i}}),this.shader=new Ye({vert:Dv,frag:`#define SHADER_NAME LINE_GRADIENT
#define DEVICE_PIXEL_RATIO 1.0
#define MAX_LINE_COUNT 128.0
precision mediump float;
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
#include <vsm_shadow_frag>
#endif
#ifdef HAS_OPACITY
varying float vOpacity;
#else
uniform lowp float lineOpacity;
#endif
uniform float layerOpacity;
uniform lowp float lineBlur;
uniform float lineGradientTextureHeight;
uniform float tileExtent;
uniform sampler2D lineGradientTexture;
varying vec2 vNormal;
varying vec2 vWidth;
varying float vGammaScale;
varying highp float vLinesofar;
varying float vGradIndex;
#ifndef ENABLE_TILE_STENCIL
varying vec2 vPosition;
#endif
#ifdef HAS_TRAIL
uniform float trailSpeed;
uniform float trailLength;
uniform float trailCircle;
uniform float currentTime;
#endif
#include <highlight_frag>
void main() {
  
#ifndef ENABLE_TILE_STENCIL
float c = sign(tileExtent - min(tileExtent, abs(vPosition.x))) * sign(1. + sign(vPosition.x)) * sign(tileExtent - min(tileExtent, abs(vPosition.y))) * sign(1. + sign(vPosition.y));
  if(c == .0) {
    discard;
  }
#endif
float d = length(vNormal) * vWidth.s;
  float e = (lineBlur + 1. / DEVICE_PIXEL_RATIO) * vGammaScale;
  float f = clamp(min(d - (vWidth.t - e), vWidth.s - d) / e, .0, 1.);
  float h = vLinesofar;
  vec4 i = texture2D(lineGradientTexture, vec2(h, (vGradIndex * 2. + .5) / lineGradientTextureHeight)) * f;
  i *= max(sign(MAX_LINE_COUNT - vGradIndex), .0);
#ifdef HAS_TRAIL
float j = mod(h - currentTime * trailSpeed * .1, trailCircle);
  float k = j < trailLength ? mix(.0, 1., j / trailLength) : .0;
  i *= k;
#endif
#ifdef HAS_OPACITY
float l = vOpacity;
#else
float l = lineOpacity;
#endif
gl_FragColor = i * l * layerOpacity;
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
float m = shadow_computeShadow();
  gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, m);
#endif
gl_FragColor = highlight_blendColor(gl_FragColor);
}`,uniforms:e,defines:n,extraCommandProps:this.getExtraCommandProps()})}}function XB(r){r.length>128&&(console.warn("Line count in a tile exceeds maximum limit (128) for line-gradient render plugin."),r=r.slice(0,128));const t=document.createElement("canvas"),e=t.getContext("2d");t.width=256,t.height=2*r.length,iP(t.height)||(t.height=oP(2*r.length));for(let n=0;n<r.length;n++){const i=r[n],o=e.createLinearGradient(0,0,256,0);for(let a=0;a<i.length;a+=2)o.addColorStop(+i[a],i[a+1]);e.fillStyle=o;const s=n%256;e.fillRect(0,2*s,256,2*s+2)}return e.canvas}function iP(r){return!(r&r-1)&&r!==0}function oP(r){return Math.pow(2,Math.ceil(Math.log(r)/Math.LN2))}class sp{constructor(t){this.V=t||[],this.properties={}}set meshes(t){this.V=t}get meshes(){return this.V}}const Yl=224,YB=600,ap=100,qB=new Uint8Array(1),ql=[],JB={collides:0,boxes:[]},sP=[],Jl=[];class aP extends _s{createGeometry(...t){const e=super.createGeometry(...t);if(!e||!e.geometry)return e;const{geometry:n}=e,i=t[0];n.properties.collideIds=i.featureIds&&i.featureIds.length&&i.isIdUnique?i.featureIds:i.data.aPickingId;const o=this.layer instanceof En;return n.properties.uniqueCollideIds=tp(n.properties.collideIds,!o),e}supportRenderMode(t){const e=this.sceneConfig.renderToPointRenderTarget;return e||e===void 0?t==="point":t==="fxaa"||t==="fxaaAfterTaa"}addMesh(t,e,n){if(t&&!this.isEnableCollision()){let i=t;Array.isArray(i)||(sP[0]=t,i=sP);for(let o=0;o<i.length;o++){const s=i[o].defines;delete s.ENABLE_COLLISION,i[o].setDefines(s);const{elements:a,visElemts:l}=i[o].geometry.properties;l&&l.count!==void 0&&l.count!==a.length&&(i[o].geometry.setElements(a),l.count=a.length)}}return super.addMesh(t,e,n)}startMeshCollision(t){const{meshKey:e}=t.properties,{renderer:n}=this.ri,i=n.isForeground(t instanceof sp?t.meshes[0]:t);if(t.properties.isForeground=i,t instanceof sp&&t.meshes.length)for(let o=0;o<t.meshes.length;o++)t.meshes[o].properties.isForeground=i;this.si=performance.now(),this.oi=this.ai(),this.li=this.hi(e)}endMeshCollision(t){const e=this.ui.tags[t];if(this.oi&&e&&this.li){const n=this.getMap();this.ci||(this.ci=new at(0,0),this.fi=new at(0,0)),e.anchor0=n.containerPointToCoord(this.di,this.ci),e.anchor1=n.containerPointToCoord(this.pi,this.fi),e.anchor0.z=n.getZoom(),e.anchor0.width=n.width,e.anchor0.height=n.height,e.anchor0.pitch=n.getPitch()}this.getMap().collisionFrameTime+=performance.now()-this.si}hi(t){const e=this.getMap(),n=e.getZoom(),i=e.getPitch(),[o,s]=this.mi(t);return!o||!s||o.z!==n||o.width!==e.width||o.height!==e.height||o.pitch!==i||o.distanceTo(this.di)>3||s.distanceTo(this.pi)>3}yi(){const t=this.getMap();this.gi={},this.di=new W(t.width/3,t.height/2),this.pi=new W(2*t.width/3,t.height/2),delete this.oi,this.ui||(this.ui={tags:{}}),this.ri={layer:this.layer,renderer:this.layer.getRenderer(),frameTimestamp:this.layer.getRenderer().getFrameTimestamp(),map:this.getMap(),zoom:t.getZoom(),collisionTags:this.ui.tags,isEnableUniquePlacement:this.isEnableUniquePlacement()}}xi(){}vi(t,e){const n=this.ui;return n.tags[t]&&n.tags[t][e]}bi(t,e,n){const i=this.ui;i.tags[t]=i.tags[t]||[],i.tags[t][e]=n}ai(){const t=this.getMap();if(!t.isInteracting())return!0;const e=this.layer.options.collisionFrameLimit;return t.collisionFrameTime<=e}mi(t){const e="__meshAnchorKey".trim(),n=this.ui.tags[t];if(n&&n.anchor0){const{anchor0:i,anchor1:o}=n,s=i[e]=i[e]||i.x+","+i.y,a=o[e]=o[e]||o.x+","+o.y;let l=this.gi[s],h=this.gi[a];if(!l||!h){const u=this.getMap();l=this.gi[s]=u.coordToContainerPoint(i),h=this.gi[a]=u.coordToContainerPoint(o)}return l.z=i.z,ql[0]=l,ql[1]=h,l.width=i.width,l.height=i.height,ql}return ql[0]=ql[1]=null,ql}updateBoxCollisionFading(t,e,n,i,o){const{layer:s,renderer:a,zoom:l,collisionTags:h,isEnableUniquePlacement:u}=this.ri,{meshKey:c,isForeground:f}=e.properties;if(u&&this.Ai(c,o))return!1;const d=n.length;let p=h[c]&&h[c][o];const g=p,m=this.wi&&p;if(!(m&&p.collides!==0)&&t){const _=m&&p.collides===0;if(this.oi||_)if((this.li||p&&p.z!==l)&&(p=null),p){if(p.boxes&&p.boxes.length){const{boxes:w,isAllowOverlap:b}=p;let A=0;if(!b){let T=0;for(let S=0;S<w.length;S++)if(!A){const M=this.isCollides(w[S]);if(M===-1)T++;else if(M===1){A=1;break}}T===w.length&&(A=-1)}p.collides=A}}else{p=g||{collides:0,boxes:[]},p.boxes.length=0,p.z=l;let w=0;for(let b=0;b<d;b++){const{mesh:A,allElements:T,boxCount:S,start:M,end:E}=n[b],P=this._i(A,T,S,M,E,i,o);P.isAllowOverlap&&(p.isAllowOverlap=1),w===0&&(w=P.collides),P.boxes&&p.boxes.push(...P.boxes)}p.collides=w,this.bi(c,o,p)}}let y=t&&p&&p.collides===0,x=1,v=!1;if(this.sceneConfig.fading){const _=this.Si(e);if(this.Mi)_[o]=y?1:-1;else if(f&&delete e.Ti,x=this.Pi(f,y,_,o),f?(x>0&&(y=!0),v=this.isBoxFading(e,o),v&&this.setToRedraw()):y||(this.ki(_,o),x=0),y){const w=e.Ti;if(w&&x===1&&_[o]>0){let{fadeOutDelay:b,fadingDuration:A}=this.sceneConfig;wn(A)&&(A=Yl),wn(b)&&(b=ap);const T=Jd(1-(a.getFrameTimestamp()-w-b)/A,0,1);x*=T,T>0&&this.setToRedraw()}}}if(p&&s.options.debugCollision&&this.addCollisionDebugBox(p.boxes,p.collides?0:1),y||v){const{mesh:_,start:w}=n[0],b=this.getSymbol(_.properties.symbolIndex);!this.Ii(b,_,w)&&p&&p.boxes&&this.Oi(p.boxes,_)}if(y){const _=qB[0]=255*x;for(let w=0;w<d;w++){const{mesh:b,allElements:A,start:T,end:S,boxIndex:M}=n[w];this.setCollisionOpacity(b,A,_,T,S,M)}}return y&&x>0}isMeshIterable(){return!0}setCollisionOpacity(t,e,n,i,o){const s=e[i],a=e[o-1];this.Ci(t,n,s,a)}Ci(t,e,n,i){const{aOpacity:o}=t.geometry.properties;if(!o)return;const s=n;if(o[s]!==e){const a=i;for(let l=s;l<=a;l++)o[l]=e;o.dirty=!0}}isBoxFading(t,e){const{frameTimestamp:n}=this.ri;let i=this.sceneConfig.fadingDuration;return wn(i)&&(i=Yl),n-Math.abs(this.Si(t)[e])<i}_i(t,e,n,i,o,s,a){const l=this.getSymbol(t.properties.symbolIndex),h=this.Ii(l,t,e[i]),u=this.Fi(l,t,e[i]);if(!this.isEnableCollision()||h&&u)return JB;const c=this.isBoxCollides(t,e,n,i,o,s,a);return u&&(c.collides=0,c.isAllowOverlap=1),c}Ii(t,e,n){if(!this.isEnableCollision())return!0;const i=e.geometry.properties.aOverlap;if(!i)return+t[this.propIgnorePlacement]==1;const o=i[n],s=o%8;return o<2?+t[this.propIgnorePlacement]==1:s%2}Fi(t,e,n){if(!this.isEnableCollision())return!0;const i=e.geometry.properties.aOverlap;if(!i)return+t[this.propAllowOverlap]==1;const o=i[n],s=o>>2;return o<2?+t[this.propAllowOverlap]==1:s%2}Oi(t){if(Array.isArray(t[0]))for(let e=0;e<t.length;e++)this.insertCollisionBox(t[e]);else this.insertCollisionBox(t)}Pi(t,e,n,i){let{fadingDuration:o,fadeInDelay:s,fadeOutDelay:a}=this.sceneConfig;wn(o)&&(o=Yl),wn(s)&&(s=YB),wn(a)&&(a=ap);const{frameTimestamp:l}=this.ri;let h=n[i],u=e?1:0;if(!h)return e&&t&&(n[i]=l+s),0;if(l<Math.abs(h)&&(!e&&h>0||e&&h<0)){const c=l-o;n[i]=h=e?c:-c}return l-Math.abs(h)<o?u=h>0?(l-h)/o:1-(l+h)/o:e?(h<0&&(n[i]=h=l+s),u=(l-h)/o):(h>0&&(n[i]=h=-(l+a)),u=1-(l+h)/o),(u<0||u>1)&&(u=Jd(u,0,1)),u}Si(t){this.Ei||(this.Ei={});const{meshKey:e}=t.properties;if(!this.Ei[e]){const{frameTimestamp:n}=this.ri;this.Ei[e]={timestamp:n}}return this.Ei[e]}Di(t){if(!this.Li)return void(this.Li=t);const e=this.scene.getMeshes();if(e&&e.length){for(let n=0;n<e.length;n++){const i=this.Si(e[n]);i.timestamp<this.Li?delete e[n]._fading_timestamps:i.timestamp=t}this.Li=t}}ki(t,e){if(!t)return;const{frameTimestamp:n}=this.ri;let{fadingDuration:i}=this.sceneConfig;wn(i)&&(i=Yl),t[e]=-(n-i-1)}deleteMesh(t,e){if(t){if(Array.isArray(t))for(let n=0;n<t.length;n++){const i=t[n].properties.meshKey;this.ui&&delete this.ui.tags[i],this.Ei&&delete this.Ei[i]}else{const n=t.properties.meshKey;this.ui&&delete this.ui.tags[n],this.Ei&&delete this.Ei[n]}super.deleteMesh(t,e)}}delete(t){this.zi&&(this.zi.geometry.dispose(),this.Ri.dispose(),this.zi.dispose(),delete this.zi,delete this.Ri,delete this.Hi),delete this.ui,super.delete(t)}isCollides(t){const e=this.layer,n=e.getMap(),i=n.getDevicePixelRatio();if(Jh(Jl,t,1/i),n.isOffscreen(Jl))return-1;const o=e.getCollisionIndex(),s=this.sceneConfig.collisionBufferSize||e.options.collisionBufferSize||0;return s&&(t=Lv(Jl,t,s)),+o.collides(t)}insertCollisionBox(t){const e=this.layer,n=e.getCollisionIndex(),i=this.sceneConfig.collisionBufferSize||e.options.collisionBufferSize||0;let o=t;i&&(o=t.Ni=t.Ni||[],t=Lv(o,t,i)),n.insertBox(o)}addCollisionDebugBox(t,e){if(t&&t.length)if(Array.isArray(t[0]))for(let n=0;n<t.length;n++){const i=t[n];this.Vi(i,e)}else this.Vi(t,e)}Vi(t,e){if(!t)return;const n=this.ji=this.ji||{aPosition:[],aVisible:[],indices:[]},i=this.sceneConfig.collisionBufferSize||this.layer.options.collisionBufferSize||0;i&&(t=Lv(Jl,t,i));const o=this.getMap(),s=o.getDevicePixelRatio();if(Jh(Jl,t,1/s),o.isOffscreen(Jl))return;const a=n.aPosition.length/2;n.aPosition.push(t[0],t[1],t[2],t[1],t[2],t[3],t[0],t[3]),n.aVisible.push(e,e,e,e),n.indices.push(a,a+1,a+1,a+2,a+2,a+3,a+3,a)}updateCollision(t){super.updateCollision(t),this.yi(),this.Ui(),this.Gi&&this.Gi.length&&(this.Wi(),this.Gi&&(this.setToRedraw(),this.scene.addMesh(this.Gi))),(this.getMap().isZooming()||this.Gi&&this.Gi.length)&&(this.Yi(),this.Bi(this.scene.getMeshes()))}paint(t){const e=super.paint(t);return this.Xi(t),this.oi===!1&&this.setToRedraw(),e}shouldIgnoreBackground(){return!this.getMap().isZooming()&&!this.Gi}Ui(){const t=this.getMap(),e=t.isZooming();if(!e&&this.wi){const n=this.layer.getRenderer();this.Gi=this.scene.getMeshes().filter(i=>!n.isForeground(i)&&!i.properties.isLinePlacement)}else e&&!this.wi&&(this.$i=t.getResolution());if(e)this.qi&&(clearTimeout(this.qi),delete this.Mi,delete this.qi),this.Mi=this.$i&&t.getResolution()>this.$i;else if(this.wi&&!this.qi){let{fadeOutDelay:n,fadingDuration:i}=this.sceneConfig;wn(n)&&(n=ap),wn(i)&&(i=Yl),this.qi=setTimeout(()=>{delete this.Mi,delete this.qi},n+i+1)}this.wi=e}Xi(t){if(!this.ji||!this.layer.options.debugCollision)return;this.Hi||this.Ki();const{aPosition:e,aVisible:n,indices:i}=this.ji;if(!this.zi){const s=new ar({aPosition:[],aVisible:[]},[],0,{positionSize:2,primitive:"lines"});this.zi=new nn(s),this.Ji=new ur,this.Ji.addMesh(this.zi)}const o=this.zi.geometry;o.updateData("aPosition",new Float32Array(e)),o.updateData("aVisible",new Uint8Array(n)),o.setElements(i),this.Hi.render(this.Ri,{size:[this.canvas.width,this.canvas.height]},this.Ji,this.getRenderFBO(t)),delete this.ji}Ki(){const t=this.regl;this.Hi=new un(t);const e=this.canvas,n={x:0,y:0,width:()=>e?e.width:1,height:()=>e?e.height:1};this.Ri=new Ye({vert:`attribute vec2 aPosition;
attribute float aVisible;
uniform vec2 size;
varying vec4 vColor;
void main() {
  vec2 c = (aPosition / size - .5) * 2. * vec2(1., -1.);
  gl_Position = vec4(c, .0, 1.);
  vColor = mix(vec4(1., .0, .0, 1.5) * .5, vec4(.0, 1., .0, 1.) * .4, aVisible);
}`,frag:`precision mediump float;
varying vec4 vColor;
void main() {
  gl_FragColor = vec4(vColor.rgb, .5);
}`,uniforms:["size"],extraCommandProps:{viewport:n,depth:{enable:!1},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}})}Wi(){let{fadeOutDelay:t,fadingDuration:e}=this.sceneConfig;wn(t)&&(t=ap),wn(e)&&(e=Yl);const n=this.layer.getRenderer(),i=n.getCurrentTileZoom(),o=n.getFrameTimestamp(),s=[];for(let a=0;a<this.Gi.length;a++){const l=this.Gi[a],h=l.properties.tile;!l.Ti&&n.isBackTile(h.id)&&(l.Ti=o);const u=h.z-i>0?2*(h.z-i)-1:2*(i-h.z);l.properties.level=u,n.isForeground(l)||l.Ti&&o-l.Ti>t+e?delete l.Ti:s.push(l)}delete this.Gi,s.length&&(this.Gi=s)}isEnableCollision(){return this.layer.options.collision&&!!this.sceneConfig.collision}isEnableUniquePlacement(){return this.isEnableCollision()&&this.sceneConfig.uniquePlacement}isMeshUniquePlaced(t){return this.isMeshIterable(t)}Yi(){if(!this.isEnableUniquePlacement())return;const t=this.scene.getMeshes(),e=(n,i,o,s)=>{const{start:a,end:l}=i[0],h=n.geometry.properties,u=h.elements;let c=h.uniquePlacements;if(c||(c=h.uniquePlacements=[]),c[s]===void 0){const f=this.getUniqueEntryKey(n,u[a],s);c[s]=f?{key:f,index:s,start:u[a],end:u[l-1]}:null}};for(let n=0;n<t.length;n++){const i=t[n];this.isMeshUniquePlaced(i)&&this.forEachBox(i,e)}}Bi(t){if(!this.isEnableUniquePlacement())return;const e=this.getMap().getZoom();let n=!this.Zi||this.Qi!==e;if(!n){for(let s=0;s<t.length;s++)if(!this.Zi[t[s].properties.meshKey]){n=!0;break}}if(!n)return;this.Qi=e,this.tr={},this.Zi={},t=t.sort(QB);const i=this.getMap().getGLScale(),o={};for(let s=0;s<t.length;s++){const a=t[s];if(!a.geometry)continue;const{meshKey:l}=a.properties;this.Zi[l]=1;const{uniquePlacements:h}=a.geometry.properties;if(h)for(let u=0;u<h.length;u++){if(!h[u])continue;const{key:c,index:f}=h[u],d=this.Si(a),p=KB(c,i),g=o[p];if(g){const m=g.length,y=g[m-3].properties.meshKey,x=g[m-2],v=g[m-1];this.tr[y]=this.tr[y]||{},this.tr[y][v]=1,this.er(d,f,x,v),g.push(a,d,f)}else o[p]=[a,d,f]}}for(const s in o){const a=o[s];if(a.length<=6)continue;const l=a.length,h=a[l-2][a[l-1]];if(a[1][a[2]]!==h)for(let u=0;u<l-6;u+=3)a[u+1][a[u+2]]=h}}er(t,e,n,i){if(n[i]!==void 0)if(t[e]===void 0)t[e]=n[i];else{let o=t[e];Math.abs(n[i])>Math.abs(o)?t[e]=n[i]:n[i]=t[e]}else t[e]!==void 0&&(n[i]=t[e])}Ai(t,e){return this.tr&&this.tr[t]&&this.tr[t][e]}nr(t,e){const{symbolIndex:n}=t.properties,i=n.type||0;let o=t.properties._collidesBoxes;o||(o=t.properties._collidesBoxes=[]);let s=o[n.index];s||(s=t.properties._collidesBoxes=[]),s[i]||(s[i]=[]),s=s[i];const a=e/6;if(!s[a]){const l=[];s[a]={boxes:l,collision:{boxes:l}}}return s[a]}ir(t){let e=this.rr;if(e||(e=this.rr=[]),!e[t]){e[t]=[];for(let n=0;n<t;n++)e[t][n]={}}return e[t]}sr(t){return!t||!t.geometry?!0:!t.geometry.properties.glyphAtlas||!t.material.get("isHalo")||t.geometry.data.aTextHaloRadius&&t.geometry.properties.hasHalo?!1:t.geometry.data.aTextHaloRadius&&!t.geometry.properties.hasHalo?!0:!this.getSymbol(t.geometry.properties.symbolIndex).textHaloRadius}}const Fv=10;function KB(r,t){return Math.round(r[0]/t/Fv)*Math.round(r[1]/t/Fv)*(r[2]?Math.round(r[2]/Fv):1)+"-"+r[3]}function QB(r,t){const e=t.properties.level-r.properties.level;return e===0?r.properties.meshKey-t.properties.meshKey:e}function Lv(r,t,e){return r[0]=t[0]-e,r[1]=t[1]-e,r[2]=t[2]+e,r[3]=t[3]+e,r}var lP=`#include <gl2_vert>
#define SHADER_NAME MARKER
#define RAD 0.0174532925
#ifdef HAS_ALTITUDE
attribute vec2 aPosition;
attribute float aAltitude;
#else
attribute vec3 aPosition;
#endif
attribute vec2 aShape;
attribute vec2 aTexCoord;
#ifdef ENABLE_COLLISION
attribute float aOpacity;
#endif
#ifdef HAS_OPACITY
attribute float aColorOpacity;
#endif
#ifdef HAS_MARKER_WIDTH
attribute float aMarkerWidth;
#else
uniform float markerWidth;
#endif
#ifdef HAS_MARKER_HEIGHT
attribute float aMarkerHeight;
#else
uniform float markerHeight;
#endif
#ifdef HAS_MARKER_DX
attribute float aMarkerDx;
#else
uniform float markerDx;
#endif
#ifdef HAS_MARKER_DY
attribute float aMarkerDy;
#else
uniform float markerDy;
#endif
#if defined(HAS_PITCH_ALIGN)
attribute float aPitchAlign;
#else
uniform float pitchWithMap;
#endif
#if defined(HAS_ROTATION_ALIGN)
attribute float aRotationAlign;
#else
uniform float rotateWithMap;
#endif
uniform float flipY;
#ifdef HAS_ROTATION
attribute float aRotation;
#else
uniform float markerRotation;
#endif
#ifdef HAS_PAD_OFFSET
attribute float aPadOffsetX;
attribute float aPadOffsetY;
#endif
uniform float cameraToCenterDistance;
uniform mat4 positionMatrix;
uniform mat4 projViewModelMatrix;
uniform float markerPerspectiveRatio;
uniform vec2 iconSize;
uniform vec2 texSize;
uniform vec2 canvasSize;
uniform float mapPitch;
uniform float mapRotation;
uniform float zoomScale;
uniform float tileRatio;
uniform float layerScale;
uniform float isRenderingTerrain;
#include <vt_position_vert>
#ifndef PICKING_MODE
varying vec2 vTexCoord;
varying float vOpacity;
#include <highlight_vert>
#else
#include <fbo_picking_vert>
#endif
void main() {
  vec3 c = unpackVTPosition();
#ifdef HAS_MARKER_WIDTH
float d = aMarkerWidth;
#else
float d = markerWidth;
#endif
#ifdef HAS_MARKER_HEIGHT
float e = aMarkerHeight;
#else
float e = markerHeight;
#endif
#ifdef HAS_MARKER_DX
float f = aMarkerDx;
#else
float f = markerDx;
#endif
#ifdef HAS_MARKER_DY
float h = aMarkerDy;
#else
float h = markerDy;
#endif
#if defined(HAS_PITCH_ALIGN)
float i = aPitchAlign;
#else
float i = pitchWithMap;
#endif
#if defined(HAS_ROTATION_ALIGN)
float j = aRotationAlign;
#else
float j = rotateWithMap;
#endif
gl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);
  float k = gl_Position.w;
  float l;
  if(isRenderingTerrain == 1. && i == 1.) {
    l = 1.;
  } else {
    float m = (1. - cameraToCenterDistance / k) * markerPerspectiveRatio;
    l = clamp(.5 + .5 * (1. - m), .0, 4.);
  }
#ifdef HAS_ROTATION
float n = -aRotation / 9362. - mapRotation * j;
#else
float n = -markerRotation - mapRotation * j;
#endif
if(i == 1.) {
    n += mapRotation;
  }
  float o = sin(n);
  float u = cos(n);
  mat2 v = mat2(u, -1. * o, o, u);
  vec2 A = (aShape / 10.0);
  if(i == 1. && flipY == .0) {
    A *= vec2(1., -1.);
  }
#ifdef HAS_PAD_OFFSET
A = (A / iconSize * vec2(d, e) + vec2(aPadOffsetX - 1., aPadOffsetY)) * layerScale;
#else
A = A / iconSize * vec2(d, e) * layerScale;
#endif
A = v * A;
  if(i == .0) {
    vec2 B = A * 2. / canvasSize;
    gl_Position.xy += B * l * k;
  } else {
    float C;
    if(isRenderingTerrain == 1.) {
      C = 1.;
    } else {
      C = k / cameraToCenterDistance;
    }
    vec2 B = A;
    gl_Position = projViewModelMatrix * positionMatrix * vec4(c + vec3(B, .0) * tileRatio / zoomScale * C * l, 1.);
  }
  gl_Position.xy += vec2(f, -h) * 2. / canvasSize * k;
#ifndef PICKING_MODE
vTexCoord = aTexCoord / texSize;
#ifdef ENABLE_COLLISION
vOpacity = aOpacity / 255.;
#else
vOpacity = 1.;
#endif
#ifdef HAS_OPACITY
vOpacity *= aColorOpacity / 255.;
#endif
highlight_setVarying();
#else
#ifdef ENABLE_COLLISION
bool D = aOpacity == 255.;
#else
bool D = true;
#endif
fbo_picking_setData(gl_Position.w, D);
#endif
}`;const lp=[],hp=[],up=[],cp=[],Kl=[],Ql=[];function zv(r,t,e,n,i,o,s,a,l,h,u,c,f,d){const{tileRatio:p,tileResolution:g}=l,m=p/(g/h.getResolution())*(u/h.cameraToCenterDistance)*c;fi(e,e,m),fi(n,n,m),fi(i,i,m),fi(o,o,m),ie(lp,e[0],e[1],f?e[2]/d:0),ie(hp,n[0],n[1],f?n[2]/d:0),ie(up,i[0],i[1],f?i[2]/d:0),ie(cp,o[0],o[1],f?o[2]/d:0),os(lp,lp,t),os(hp,hp,t),os(up,up,t),os(cp,cp,t),po(e,lp,s,h.width,h.height),po(n,hp,s,h.width,h.height),po(i,up,s,h.width,h.height),po(o,cp,s,h.width,h.height),Pe(Kl,Math.min(e[0],n[0],i[0],o[0]),Math.min(e[1],n[1],i[1],o[1])),Pe(Ql,Math.max(e[0],n[0],i[0],o[0]),Math.max(e[1],n[1],i[1],o[1])),Tr(r,Kl[0]+a[0],Kl[1]+a[1],Ql[0]+a[0],Ql[1]+a[1])}function Hv(r,t,e,n,i,o,s,a){a!==1&&(fi(e,e,a),fi(n,n,a),fi(i,i,a),fi(o,o,a)),Pe(Kl,Math.min(e[0],n[0],i[0],o[0]),Math.min(e[1],n[1],i[1],o[1])),Pe(Ql,Math.max(e[0],n[0],i[0],o[0]),Math.max(e[1],n[1],i[1],o[1])),Tr(r,t[0]+Kl[0]+s[0],t[1]+Kl[1]-s[1],t[0]+Ql[0]+s[0],t[1]+Ql[1]-s[1])}function Nv(r,t,e,n,i){t-=e*n,i===1&&(t+=e);const o=Math.sin(t),s=Math.cos(t);return HR(r,s,-o,o,s)}const fp=2048,dp=24,Bv=.01,tj=[],ej=[],nj=[],rj=[],ij=[],oj=[],sj=[],aj=[],bs=[1,-1],lj=[1,1];function hj(r,t,e,n,i){const o=t.material.uniforms,s=i.cameraToCenterDistance,a=t.geometry.properties,l=this.getSymbol(a.symbolIndex),h=t.geometry.desc.positionSize,u=a.aAnchor,c=ie(tj,u[e*h],u[e*h+1],h===2?0:u[e*h+2]),{aTerrainAltitude:f}=a;if(f){const Rt=100*f[2*e];Rt&&(c[2]+=Rt)}let d=po(ej,c,n,i.width,i.height);const p=d[2];let g=1;o.markerPerspectiveRatio&&(g=Jd(.5+.5*(1-(1-s/p)*o.markerPerspectiveRatio),0,4));const{aShape:m,aMarkerDx:y,aMarkerDy:x,aMarkerWidth:v,aMarkerHeight:_,aPitchAlign:w,aRotationAlign:b,aRotation:A}=a,T=y?y[e]:l.markerDx,S=x?x[e]:l.markerDy,M=w?w[e]:o.pitchWithMap,E=b?b[e]:o.rotateWithMap,P=Pe(aj,T||0,-(S||0));let k=Pe(rj,m[2*e]/10,m[2*e+1]/10),O=Pe(ij,m[2*e+2]/10,m[2*e+3]/10),I=Pe(oj,m[2*e+4]/10,m[2*e+5]/10),D=Pe(sj,m[2*e+6]/10,m[2*e+7]/10);o.flipY===0&&M===1&&(hr(k,k,bs),hr(O,O,bs),hr(I,I,bs),hr(D,D,bs));const[z,L]=tP(t.geometry);let $=v?v[e]:l.markerWidth;wn($)&&($=z||15);let Z=_?_[e]:l.markerHeight;wn(Z)&&(Z=L||15);const j=Pe(lj,$/fp,Z/fp);yf(k,k,j),yf(O,O,j),yf(I,I,j),yf(D,D,j);const st=-(A?A[e]/9362:-(l.markerRotation||0)*Math.PI/180),lt=i.getBearing()*Math.PI/180;if(lt*E||st){const Rt=Nv(nj,st,lt,E,M);k=Ui(k,k,Rt),O=Ui(O,O,Rt),I=Ui(I,I,Rt),D=Ui(D,D,Rt)}M===1?zv(r,c,k,O,I,D,n,P,o,i,p,g):(hr(k,k,bs),hr(O,O,bs),hr(I,I,bs),hr(D,D,bs),Hv(r,d,k,O,I,D,P,g));const rt=this.getMap().getDevicePixelRatio();return rt!==1&&(r[0]*=rt,r[1]*=rt,r[2]*=rt,r[3]*=rt),r}const pp=1,uj=[],jv=[],Vv=[],Gv=[],Uv=[],cj=[],ws=[1,-1];function $v(r,t,e,n,i,o,s,a,l){const h=n.material.uniforms,u=l.cameraToCenterDistance,c=n.geometry.properties,f=this.getSymbol(c.symbolIndex),d=f.textPlacement==="line"&&!Yu(f),p=dp,g=e[2];let m=1;h.textPerspectiveRatio&&(m=Jd(.5+.5*(1-(1-u/g)*h.textPerspectiveRatio),0,4));const{aTextDx:y,aTextDy:x,aPitchAlign:v,aRotationAlign:_,aRotation:w}=n.geometry.properties,b=y?y[s]:f.textDx,A=x?x[s]:f.textDy,T=v?v[s]:h.pitchWithMap,S=_?_[s]:h.rotateWithMap,M=Pe(cj,b||0,-(A||0));if(d){const{aOffset:P,aShape:k}=c,O=P.length!==k.length;let I,D,z,L;if(O?(I=ie(jv,P[3*s]/10,P[3*s+1]/10,P[3*s+2]/10),D=ie(Vv,P[3*s+3]/10,P[3*s+4]/10,P[3*s+5]/10),z=ie(Gv,P[3*s+6]/10,P[3*s+7]/10,P[3*s+8]/10),L=ie(Uv,P[3*s+9]/10,P[3*s+10]/10,P[3*s+11]/10)):(I=Pe(jv,P[2*s]/10,P[2*s+1]/10),D=Pe(Vv,P[2*s+2]/10,P[2*s+3]/10),z=Pe(Gv,P[2*s+4]/10,P[2*s+5]/10),L=Pe(Uv,P[2*s+6]/10,P[2*s+7]/10)),T===1){const $=Vl(l.getResolution(),l);zv(r,t,I,D,z,L,a,M,h,l,g,m,O,$)}else hr(I,I,ws),hr(D,D,ws),hr(z,z,ws),hr(L,L,ws),Hv(r,e,I,D,z,L,M,m)}else{const{aShape:P}=c;let k=Pe(jv,P[2*s]/10,-P[2*s+1]/10),O=Pe(Vv,P[2*s+2]/10,-P[2*s+3]/10),I=Pe(Gv,P[2*s+4]/10,-P[2*s+5]/10),D=Pe(Uv,P[2*s+6]/10,-P[2*s+7]/10);h.flipY===0&&T===1&&(hr(k,k,ws),hr(O,O,ws),hr(I,I,ws),hr(D,D,ws));const z=w?w[s]/9362:(f.textRotation||0)*Math.PI/180,L=d?0:l.getBearing()*Math.PI/180;if(z||L){const Z=Nv(uj,z,L,S,T);k=Ui(k,k,Z),O=Ui(O,O,Z),I=Ui(I,I,Z),D=Ui(D,D,Z)}const $=i/p;fi(k,k,$),fi(O,O,$),fi(I,I,$),fi(D,D,$),T===1?zv(r,t,k,O,I,D,a,M,h,l,g,m):Hv(r,e,k,O,I,D,M,m)}o=o||0,r[0]-=o+pp,r[1]-=o+pp,r[2]+=o+pp,r[3]+=o+pp;const E=this.getMap().getDevicePixelRatio();return E!==1&&(r[0]*=E,r[1]*=E,r[2]*=E,r[3]*=E),r}function hP(r,t,e){const n=t.geometry.desc.positionSize,{aAnchor:i,aAltitude:o,aTerrainAltitude:s}=t.geometry.properties,a=e*n;if(o?ie(r,i[a],i[a+1],o[e]):n===3?Lr.unpackPosition(r,i[a],i[a+1],i[a+2]):ie(r,i[a],i[a+1],0),s){const l=100*s[2*e];l&&(r[2]+=l)}return r}const yr={textFill:[0,0,0,1],textOpacity:1,textPitchAlignment:0,textRotationAlignment:0,textHaloRadius:0,textHaloFill:[1,1,1,1],textHaloBlur:0,textHaloOpacity:1,textPerspectiveRatio:0,textSize:14,textDx:0,textDy:0,textRotation:0};function uP(r,t,e,n,i,o,s,a,l){const h=[];if(t.isDisposed()||t.data.aPosition.length===0)return h;const u=t.properties.glyphAtlas;if(!u||n.textSize===0||n.textOpacity===0)return h;if(Vo(t,n,o),!t.properties.aCount){fj.call(this,t,s||l,a);const{aTextSize:m,aTextDx:y,aTextDy:x,aPitchAlign:v,aRotationAlign:_,aRotation:w,aOverlap:b,aAltitude:A}=t.data;if(m){const T=(An+"aTextSize").trim();t.properties.aTextSize=t.properties[T]||new m.constructor(m)}if(y){const T=(An+"aTextDx").trim();t.properties.aTextDx=t.properties[T]||new y.constructor(y)}if(x){const T=(An+"aTextDy").trim();t.properties.aTextDy=t.properties[T]||new x.constructor(x)}if(v){const T=(An+"aPitchAlign").trim();t.properties.aPitchAlign=t.properties[T]||new v.constructor(v)}if(_){const T=(An+"aRotationAlign").trim();t.properties.aRotationAlign=t.properties[T]||new _.constructor(_)}if(w){const T=(An+"aRotation").trim();t.properties.aRotation=t.properties[T]||new w.constructor(w)}if(b){const T=(An+"aOverlap").trim();t.properties.aOverlap=t.properties[T]||new b.constructor(b)}if(A){const T=(An+"aAltitude").trim();t.properties.aAltitude=t.properties[T]||new A.constructor(A)}}const c=Ku(r,u,!1),f={flipY:0,tileResolution:t.properties.tileResolution,tileRatio:t.properties.tileRatio,texture:c,texSize:[u.width,u.height]};cP(t,f,i);let d=!1;i.textOpacity<1&&(d=!0),t.properties.memorySize=t.getMemorySize(),t.generateBuffers(r,{excludeElementsInVAO:!0});const p=new Gr(f,yr),g=new nn(t,p,{disableVAO:!0,transparent:d,castShadow:!1,picking:!0});if(g.setLocalTransform(e),g.setUniform("alphaTest",Bv),f.isHalo&&(g.properties.isHalo=!0),s&&g.setDefines({ENABLE_COLLISION:1}),h.push(g),f.isHalo){const m={flipY:0,tileResolution:t.properties.tileResolution,tileRatio:t.properties.tileRatio,texture:c,texSize:[u.width,u.height],isHalo:0};cP(t,m,i);const y=new Gr(m,yr),x=new nn(t,y,{disableVAO:!0,transparent:d,castShadow:!1,picking:!0});x.setUniform("alphaTest",Bv),x.properties.haloMesh=g,Object.defineProperty(x.properties,"textSize",{enumerable:!0,get:function(){return m.textSize}}),s&&x.setDefines({ENABLE_COLLISION:1}),x.setLocalTransform(e),h.push(x)}return h.forEach(m=>{const y=m.defines||{};t.data.aTextFill&&(y.HAS_TEXT_FILL=1),t.data.aTextSize&&(y.HAS_TEXT_SIZE=1),t.data.aColorOpacity&&(y.HAS_OPACITY=1),t.data.aTextHaloFill&&m.material.uniforms.isHalo&&(y.HAS_TEXT_HALO_FILL=1),t.data.aTextHaloRadius&&m.material.uniforms.isHalo&&(y.HAS_TEXT_HALO_RADIUS=1),t.data.aTextHaloOpacity&&m.material.uniforms.isHalo&&(y.HAS_TEXT_HALO_OPACITY=1),t.data.aTextDx&&(y.HAS_TEXT_DX=1),t.data.aTextDy&&(y.HAS_TEXT_DY=1),t.data.aPitchAlign&&(y.HAS_PITCH_ALIGN=1),t.data.aRotationAlign&&(y.HAS_ROTATION_ALIGN=1),t.data.aRotation&&(y.HAS_ROTATION=1),t.data.aAltitude&&(y.HAS_ALTITUDE=1),t.properties.aOffset&&t.properties.aShape&&t.properties.aOffset.length!==t.properties.aShape.length&&(y.HAS_OFFSET_Z=1),m.setDefines(y),m.properties.symbolIndex=t.properties.symbolIndex}),h}function fj(r,t,e){const n=this.getSymbol(r.properties.symbolIndex),i=r.properties.textPlacement==="line"&&!Yu(n),{aPosition:o,aShape:s}=r.data,a=o.length/r.desc.positionSize;if(r.properties.aPickingId=r.data.aPickingId,r.properties.aCount=r.data.aCount,delete r.data.aCount,(t||i)&&(r.properties.aAnchor=o,r.properties.aShape=s),r.properties.visElemts||(r.properties.elements=r.elements,r.properties.visElemts=new r.elements.constructor(r.elements.length)),i){const{aVertical:l,aSegment:h,aGlyphOffset:u,aPitchRotation:c}=r.data,f=!!c;r.properties.aGlyphOffset=u,r.properties.aPitchRotation=c,r.properties.aSegment=h,r.properties.aVertical=l,delete r.data.aSegment,delete r.data.aVertical,delete r.data.aGlyphOffset,delete r.data.aPitchRotation;const d=s.length/2*(f?3:2);r.data.aOffset={usage:"dynamic",data:new Int16Array(d)},r.properties.aOffset=new Int16Array(d)}if(t){r.data.aOpacity={usage:"dynamic",data:new Uint8Array(a)},r.properties.aOpacity=new Uint8Array(a),e&&(r.properties.aOpacity.fill(255,0),r.data.aOpacity.data.fill(255,0));const{aTextHaloRadius:l}=r.data;if(l&&!r.properties.aTextHaloRadius){const h=(An+"aTextHaloRadius").trim();r.properties.aTextHaloRadius=r.properties[h]||new l.constructor(l)}}}function cP(r,t,e){t.isHalo===void 0&&(t.isHalo=1),ue(t,"textOpacity",e,"textOpacity",yr.textOpacity),ue(t,"textFill",e,"textFill",yr.textFill,xi()),ue(t,"textHaloFill",e,"textHaloFill",yr.textHaloFill,xi()),ue(t,"textHaloBlur",e,"textHaloBlur",yr.textHaloBlur),ue(t,"textHaloRadius",e,"textHaloRadius",yr.textHaloRadius),ue(t,"textHaloOpacity",e,"textHaloOpacity",yr.textHaloOpacity),ue(t,"textPerspectiveRatio",e,"textPerspectiveRatio",yr.textPerspectiveRatio,n=>r.properties.textPlacement==="line"?1:n),ue(t,"rotateWithMap",e,"textRotationAlignment",yr.textRotationAlignment,n=>+(n==="map")),ue(t,"pitchWithMap",e,"textPitchAlignment",yr.textPitchAlignment,n=>+(n==="map")),ue(t,"textSize",e,"textSize",yr.textSize),ue(t,"textDx",e,"textDx",yr.textDx),ue(t,"textDy",e,"textDy",yr.textDy),ue(t,"textRotation",e,"textRotation",yr.textRotation,n=>n*Math.PI/180)}function fP(r,t){const e=[];return{uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(n,i){return qt(e,i.projViewMatrix,i.modelMatrix)}},{name:"zoomScale",type:"function",fn:function(n,i){return i.tileResolution/i.resolution}}],extraCommandProps:{viewport:{x:0,y:0,width:()=>r?r.width:1,height:()=>r?r.height:1},stencil:{enable:!0,mask:255,func:{cmp:"<=",ref:(n,i)=>i.stencilRef,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"},depth:{enable:!0,range:t.depthRange||[0,1],func:t.depthFunc||"always",mask:!1},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}}function dP(r,t){const e=le(t.textFill),n=le(t.textSize),i=le(t.textHaloFill),o=le(t.textHaloRadius),s=le(t.textHaloOpacity),a=le(t.textDx),l=le(t.textDy),h=le(t.textOpacity),u=cn(t.textPitchAlignment),c=cn(t.textRotationAlignment),f=le(t.textRotation),d=cn(t.textAllowOverlapFn),p=cn(t.textIgnorePlacement),g={},m=new Int16Array(1),y=new Uint16Array(1);return[{attrName:"aTextFill",symbolName:"textFill",define:"HAS_TEXT_FILL",type:Uint8Array,width:4,evaluate:(x,v)=>{let _=e(r.getZoom(),x);return Ft(_)&&(_=this.evaluateInFnTypeConfig(_,v,r,x,!0)),Array.isArray(_)||(_=g[_]=g[_]||Wi(_).unitArray()),_=fa(_),_}},{attrName:"aTextSize",symbolName:"textSize",define:"HAS_TEXT_SIZE",type:Uint8Array,width:1,evaluate:(x,v)=>{let _=n(r.getZoom(),x)||yr.textSize;return Ft(_)&&(_=this.evaluateInFnTypeConfig(_,v,r,x)),m[0]=_,m[0]}},{attrName:"aTextHaloFill",symbolName:"textHaloFill",define:"HAS_TEXT_HALO_FILL",type:Uint8Array,width:4,evaluate:x=>{let v=i(r.getZoom(),x);return Array.isArray(v)||(v=g[v]=g[v]||Wi(v).unitArray()),v=fa(v),v}},{attrName:"aTextHaloRadius",symbolName:"textHaloRadius",define:"HAS_TEXT_HALO_RADIUS",type:Uint8Array,width:1,evaluate:x=>{const v=o(r.getZoom(),x);return m[0]=v,m[0]}},{attrName:"aTextHaloOpacity",symbolName:"textHaloOpacity",define:"HAS_TEXT_HALO_OPACITY",type:Uint8Array,width:1,evaluate:x=>{const v=s(r.getZoom(),x);return m[0]=v,m[0]}},{attrName:"aTextDx",symbolName:"textDx",define:"HAS_TEXT_DX",type:Uint8Array,width:1,evaluate:(x,v)=>{let _=a(r.getZoom(),x);return Ft(_)&&(_=this.evaluateInFnTypeConfig(_,v,r,x)),m[0]=_,m[0]}},{attrName:"aTextDy",symbolName:"textDy",define:"HAS_TEXT_DY",type:Uint8Array,width:1,evaluate:(x,v)=>{let _=l(r.getZoom(),x);return Ft(_)&&(_=this.evaluateInFnTypeConfig(_,v,r,x)),m[0]=_,m[0]}},{attrName:"aColorOpacity",symbolName:"textOpacity",define:"HAS_OPACITY",type:Uint8Array,width:1,evaluate:(x,v)=>{let _=h(r.getZoom(),x);return Ft(_)&&(_=this.evaluateInFnTypeConfig(_,v,r,x)),m[0]=255*_,m[0]}},{attrName:"aPitchAlign",symbolName:"textPitchAlignment",type:Uint8Array,width:1,define:"HAS_PITCH_ALIGN",evaluate:x=>+(u(r.getZoom(),x)==="map")},{attrName:"aRotationAlign",symbolName:"textRotationAlignment",type:Uint8Array,width:1,define:"HAS_ROTATION_ALIGN",evaluate:x=>+(c(r.getZoom(),x)==="map")},{attrName:"aRotation",symbolName:"textRotation",type:Uint16Array,width:1,define:"HAS_ROTATION",evaluate:x=>{const v=LC(f(r.getZoom(),x),0,360)*Math.PI/180;return y[0]=9362*v,y[0]}},{attrName:"aOverlap",symbolName:"textAllowOverlap",type:Uint8Array,width:1,evaluate:x=>{let v=d(r.getZoom(),x)||0,_=(p?p(r.getZoom(),x):t.textIgnorePlacement)||0;return v=1<<3+4*v,_=(p?2:0)+_,v+_}},{attrName:"aOverlap",symbolName:"textIgnorePlacement",type:Uint8Array,width:1,evaluate:x=>{let v=(d?d(r.getZoom(),x):t.textAllowOverlap)||0,_=p(r.getZoom(),x)||0;return v=(d?8:0)+4*v,_=1<<1+_,v+_}}]}const dj=[],pj=[],gj=[],ec=[];function Wv(r,t,e,n,i,o,s){r=r===1?1:0;const a=this.getMap(),l=t.geometry.properties,h=this.getSymbol(l.symbolIndex),u=l.textPlacement==="line"&&!Yu(h),{aTextSize:c,aTextHaloRadius:f,aShape:d}=l;let p=c?c[e[i]]:t.properties.textSize;p==null&&(p=yr.textSize);const g=f?f[e[i]]:t.properties.textHaloRadius,m=hP(gj,t,e[i]),{aProjectedAnchor:y}=t.geometry.properties;let x=ec;const v=3*e[i];y&&y[v]!==ua?(ec[0]=y[v],ec[1]=y[v+1],ec[2]=y[v+2]):x=po(ec,m,s,a.width,a.height);const _=n,{boxes:w,collision:b}=this.nr(t,i);let A=0;if(u||t.material.uniforms.rotateWithMap===1||h.textRotation){let T=0;for(let S=i;S<i+6*_;S+=6){const M=w[A]=w[A]||[];A++;const E=$v.call(this,M,m,x,t,p,g,e[S],s,a);if(!r){const P=this.isCollides(E);P===1?r=1:P===-1&&T++}}T===_&&(r=-1)}else{let T=e[i],S=d[2*T+1];for(let M=i;M<o;M+=6){const E=d[2*e[M]+1];if(S!==E||M===o-6){const P=e[M===o-6?M:M-6],k=$v.call(this,dj,m,x,t,p,g,T,s,a),O=$v.call(this,pj,m,x,t,p,g,P,s,a),I=w[A]=w[A]||[];A++,I[0]=Math.min(k[0],O[0]),I[1]=Math.min(k[1],O[1]),I[2]=Math.max(k[2],O[2]),I[3]=Math.max(k[3],O[3]),T=e[M],S=E,!r&&this.isCollides(I)&&(r=1)}}}return b.collides=r,b}function pP(r,t){const e=function(n,i){const{aPickingId:o,features:s}=n.geometry.properties,a=o[i],l=s&&s[a]&&s[a].feature;return l&&l.label}(r,t);return e?function(n,i,o){if(!o)return null;const s=n.localTransform,a=hP(mj,n,i);Tr(Zv,a[0],a[1],a[2],1);const l=ss(Zv,Zv,s);let h=0;for(const u of o)h+=u.codePointAt(0);return[Math.floor(l[0]),Math.floor(l[1]),Math.floor(l[2]),h]}(r,t,e):null}const mj=[],Zv=[];var gp=`#define SHADER_NAME TEXT_VERT
#define RAD 0.0174532925
#ifdef HAS_ALTITUDE
attribute vec2 aPosition;
attribute float aAltitude;
#else
attribute vec3 aPosition;
#endif
attribute vec2 aShape;
attribute vec2 aTexCoord;
#ifdef ENABLE_COLLISION
attribute float aOpacity;
#endif
#ifdef HAS_OPACITY
attribute float aColorOpacity;
#endif
#ifdef HAS_TEXT_SIZE
attribute float aTextSize;
#else
uniform float textSize;
#endif
#ifdef HAS_TEXT_DX
attribute float aTextDx;
#else
uniform float textDx;
#endif
#ifdef HAS_TEXT_DY
attribute float aTextDy;
#else
uniform float textDy;
#endif
#if defined(HAS_PITCH_ALIGN)
attribute float aPitchAlign;
#else
uniform float pitchWithMap;
#endif
#if defined(HAS_ROTATION_ALIGN)
attribute float aRotationAlign;
#else
uniform float rotateWithMap;
#endif
uniform float flipY;
#if defined(HAS_ROTATION)
attribute float aRotation;
#else
uniform float textRotation;
#endif
uniform float cameraToCenterDistance;
uniform mat4 positionMatrix;
uniform mat4 projViewModelMatrix;
uniform float textPerspectiveRatio;
uniform vec2 texSize;
uniform vec2 canvasSize;
uniform float glyphSize;
uniform float mapPitch;
uniform float mapRotation;
uniform float zoomScale;
uniform float tileRatio;
uniform float layerScale;
uniform float isRenderingTerrain;
#ifndef PICKING_MODE
varying vec2 vTexCoord;
varying float vGammaScale;
varying float vSize;
varying float vOpacity;
#ifdef HAS_TEXT_FILL
attribute vec4 aTextFill;
varying vec4 vTextFill;
#endif
#ifdef HAS_TEXT_HALO_FILL
attribute vec4 aTextHaloFill;
varying vec4 vTextHaloFill;
#endif
#ifdef HAS_TEXT_HALO_RADIUS
attribute float aTextHaloRadius;
varying float vTextHaloRadius;
#endif
#ifdef HAS_TEXT_HALO_OPACITY
attribute float aTextHaloOpacity;
varying float vTextHaloOpacity;
#endif
#include <highlight_vert>
#else
#include <fbo_picking_vert>
#endif
#include <vt_position_vert>
void main() {
  vec3 c = unpackVTPosition();
#ifdef HAS_TEXT_SIZE
float d = aTextSize * layerScale;
#else
float d = textSize * layerScale;
#endif
#ifdef HAS_TEXT_DX
float e = aTextDx;
#else
float e = textDx;
#endif
#ifdef HAS_TEXT_DY
float f = aTextDy;
#else
float f = textDy;
#endif
#if defined(HAS_PITCH_ALIGN)
float h = aPitchAlign;
#else
float h = pitchWithMap;
#endif
#if defined(HAS_ROTATION_ALIGN)
float i = aRotationAlign;
#else
float i = rotateWithMap;
#endif
vec2 j = aShape / 10.0;
  if(h == 1. && flipY == .0) {
    j = j * vec2(1., -1.);
  }
  vec2 k = aTexCoord;
  gl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);
  float l = gl_Position.w;
  float m;
  if(isRenderingTerrain == 1. && h == 1.) {
    m = 1.;
  } else {
    float n = (1. - cameraToCenterDistance / l) * textPerspectiveRatio;
    m = clamp(.5 + .5 * (1. - n), .0, 4.);
  }
#ifdef HAS_ROTATION
float o = -aRotation / 9362. - mapRotation * i;
#else
float o = -textRotation - mapRotation * i;
#endif
if(h == 1.) {
    
#ifdef REVERSE_MAP_ROTATION_ON_PITCH
o += mapRotation;
#else
o -= mapRotation;
#endif
  }
  float u = sin(o);
  float v = cos(o);
  mat2 A = mat2(v, -1. * u, u, v);
  j = A * (j / glyphSize * d);
  float B;
  if(isRenderingTerrain == 1.) {
    B = 1.;
  } else {
    B = l / cameraToCenterDistance;
  }
  if(h == .0) {
    vec2 C = j * 2. / canvasSize;
    gl_Position.xy += C * m * l;
  } else {
    float D;
    if(isRenderingTerrain == 1.) {
      D = tileRatio / zoomScale;
    } else {
      D = tileRatio / zoomScale * B * m;
    }
    vec2 C = j;
    gl_Position = projViewModelMatrix * positionMatrix * vec4(c + vec3(C, .0) * D, 1.);
  }
  gl_Position.xy += vec2(e, -f) * 2. / canvasSize * l;
#ifndef PICKING_MODE
if(h == .0) {
    vGammaScale = mix(1., B, textPerspectiveRatio);
  } else {
    vGammaScale = B + mapPitch / 4.;
  }
  vTexCoord = k / texSize;
  vGammaScale = clamp(vGammaScale, .0, 1.);
  vSize = d;
#ifdef ENABLE_COLLISION
vOpacity = aOpacity / 255.;
#else
vOpacity = 1.;
#endif
#ifdef HAS_OPACITY
vOpacity *= aColorOpacity / 255.;
#endif
#ifdef HAS_TEXT_FILL
vTextFill = aTextFill / 255.;
#endif
#ifdef HAS_TEXT_HALO_FILL
vTextHaloFill = aTextHaloFill / 255.;
#endif
#ifdef HAS_TEXT_HALO_RADIUS
vTextHaloRadius = aTextHaloRadius;
#endif
#ifdef HAS_TEXT_HALO_OPACITY
vTextHaloOpacity = aTextHaloOpacity;
#endif
highlight_setVarying();
#else
#ifdef ENABLE_COLLISION
bool E = aOpacity == 255.;
#else
bool E = true;
#endif
fbo_picking_setData(gl_Position.w, E);
#endif
}`,Xv=`#define SHADER_NAME TEXT_FRAG
#define HAS_HIGHLIGHT_COLOR_POINT 1
#define SDF_PX 8.0
#define DEVICE_PIXEL_RATIO 1.0
#define EDGE_GAMMA 0.105 / DEVICE_PIXEL_RATIO
precision mediump float;
uniform sampler2D texture;
uniform float textOpacity;
uniform highp float gammaScale;
uniform int isHalo;
uniform highp float textHaloBlur;
uniform float alphaTest;
#ifdef HAS_TEXT_HALO_OPACITY
varying float vTextHaloOpacity;
#else
uniform float textHaloOpacity;
#endif
uniform float layerOpacity;
varying vec2 vTexCoord;
varying float vSize;
varying float vGammaScale;
varying float vOpacity;
#ifdef HAS_TEXT_FILL
varying vec4 vTextFill;
#else
uniform vec4 textFill;
#endif
#ifdef HAS_TEXT_HALO_FILL
varying vec4 vTextHaloFill;
#else
uniform vec4 textHaloFill;
#endif
#ifdef HAS_TEXT_HALO_RADIUS
varying float vTextHaloRadius;
#else
uniform highp float textHaloRadius;
#endif
#include <highlight_frag>
void main() {
  
#ifdef HAS_TEXT_FILL
vec4 c = vTextFill;
#else
vec4 c = textFill;
#endif
float d = vSize / 24.;
  lowp vec4 e = c;
  highp float f = EDGE_GAMMA / (d * gammaScale);
  lowp float h = 185. / 256.;
  if(isHalo == 1) {
    
#ifdef HAS_TEXT_HALO_FILL
vec4 i = vTextHaloFill;
#else
vec4 i = textHaloFill;
#endif
#ifdef HAS_TEXT_HALO_RADIUS
float j = vTextHaloRadius;
#else
float j = textHaloRadius;
#endif
e = i;
    f = (textHaloBlur * 1.19 / SDF_PX + EDGE_GAMMA) / (d * gammaScale);
    h = (6. - j / d) / SDF_PX;
#ifdef HAS_TEXT_HALO_OPACITY
float k = vTextHaloOpacity / 255.;
#else
float k = textHaloOpacity;
#endif
e *= k * 1.25;
  }
  float l = texture2D(texture, vTexCoord).a;
  highp float m = f * vGammaScale * .7;
  float n = clamp(smoothstep(h - m, h + m, l), .0, 1.);
  gl_FragColor = e * (n * textOpacity * vOpacity * layerOpacity);
  if(gl_FragColor.a < alphaTest) {
    discard;
  }
  gl_FragColor = highlight_blendColor(gl_FragColor);
}`;const lr=6,qi=4,th=new Uint16Array(1),mp=new Int8Array(1);function yj(r,t,e){Vo(r,t,e),function(n){const{aMarkerWidth:i,aMarkerHeight:o,aMarkerDx:s,aMarkerDy:a,aPitchAlign:l,aRotationAlign:h,aRotation:u,aOverlap:c}=n.data;if(i){const f=(An+"aMarkerWidth").trim();n.properties.aMarkerWidth=n.properties[f]||new i.constructor(i)}if(o){const f=(An+"aMarkerHeight").trim();n.properties.aMarkerHeight=n.properties[f]||new o.constructor(o)}if(s){const f=(An+"aMarkerDx").trim();n.properties.aMarkerDx=n.properties[f]||new s.constructor(s)}if(a){const f=(An+"aMarkerDy").trim();n.properties.aMarkerDy=n.properties[f]||new a.constructor(a)}if(l){const f=(An+"aPitchAlign").trim();n.properties.aPitchAlign=n.properties[f]||new l.constructor(l)}if(h){const f=(An+"aRotationAlign").trim();n.properties.aRotationAlign=n.properties[f]||new h.constructor(h)}if(u){const f=(An+"aRotation").trim();n.properties.aRotation=n.properties[f]||new u.constructor(u)}if(c){const f=(An+"aOverlap").trim();n.properties.aOverlap=n.properties[f]||new c.constructor(c)}}(r)}function vj(r,t){const e=le(t.markerWidth),n=le(t.markerHeight),i=le(t.markerDx),o=le(t.markerDy),s=le(t.markerOpacity),a=le(t.markerTextFit),l=cn(t.markerPitchAlignment),h=cn(t.markerRotationAlignment),u=le(t.markerRotation),c=cn(t.markerAllowOverlapFn),f=cn(t.markerIgnorePlacement),d=new Int16Array(1),p=new Uint16Array(1);return[{attrName:"aMarkerWidth",symbolName:"markerWidth",type:Uint16Array,width:1,define:"HAS_MARKER_WIDTH",evaluate:(g,m,y,x)=>{const v=y[x],_=t.markerTextFit,w=a?a(r.getZoom(),g):_;if(w==="both"||w==="width")return v;let b=e(r.getZoom(),g);return Ft(b)&&(b=this.evaluateInFnTypeConfig(b,m,r,g)),d[0]=b,d[0]}},{attrName:"aMarkerHeight",symbolName:"markerHeight",type:Uint16Array,width:1,define:"HAS_MARKER_HEIGHT",evaluate:(g,m,y,x)=>{const v=y[x],_=t.markerTextFit,w=a?a(r.getZoom(),g):_;if(w==="both"||w==="height")return v;let b=n(r.getZoom(),g);return Ft(b)&&(b=this.evaluateInFnTypeConfig(b,m,r,g)),d[0]=b,d[0]}},{attrName:"aMarkerDx",symbolName:"markerDx",type:Uint8Array,width:1,define:"HAS_MARKER_DX",evaluate:(g,m)=>{let y=i(r.getZoom(),g);return Ft(y)&&(y=this.evaluateInFnTypeConfig(y,m,r,g)),d[0]=y,d[0]}},{attrName:"aMarkerDy",symbolName:"markerDy",type:Uint8Array,width:1,define:"HAS_MARKER_DY",evaluate:(g,m)=>{let y=o(r.getZoom(),g);return Ft(y)&&(y=this.evaluateInFnTypeConfig(y,m,r,g)),d[0]=y,d[0]}},{attrName:"aColorOpacity",symbolName:"markerOpacity",type:Uint8Array,width:1,define:"HAS_OPACITY",evaluate:(g,m)=>{let y=s(r.getZoom(),g);return Ft(y)&&(y=this.evaluateInFnTypeConfig(y,m,r,g)),d[0]=255*y,d[0]}},{attrName:"aPitchAlign",symbolName:"markerPitchAlignment",type:Uint8Array,width:1,define:"HAS_PITCH_ALIGN",evaluate:g=>+(l(r.getZoom(),g)==="map")},{attrName:"aRotationAlign",symbolName:"markerRotationAlignment",type:Uint8Array,width:1,define:"HAS_ROTATION_ALIGN",evaluate:g=>+(h(r.getZoom(),g)==="map")},{attrName:"aRotation",symbolName:"markerRotation",type:Uint16Array,width:1,define:"HAS_ROTATION",evaluate:g=>{const m=LC(u(r.getZoom(),g),0,360)*Math.PI/180;return p[0]=9362*m,p[0]}},{attrName:"aOverlap",symbolName:"markerAllowOverlap",type:Uint8Array,width:1,evaluate:g=>{let m=c(r.getZoom(),g)||0,y=(f?f(r.getZoom(),g):t.markerIgnorePlacement)||0;return m=1<<3+4*m,y=(f?2:0)+y,m+y}},{attrName:"aOverlap",symbolName:"markerIgnorePlacement",type:Uint8Array,width:1,evaluate:g=>{let m=(c?c(r.getZoom(),g):t.markerAllowOverlap)||0,y=f(r.getZoom(),g)||0;return m=(c?8:0)+4*m,y=2+y,m+y}}]}function xj(r,t,e,n){if(!e||!n||n==="none")return;const i=function(o,s,a){let l=o.properties.textFitFn;Ft(a)&&(l=o.properties.textFitFn=cn(a));const h=a!=="none",u=[],c=o.getElements(),f=o.data.aPickingId;let d,p,g;s&&(d=s.getElements(),p=s.data.aPickingId,g=s.data.aCount);const m=o.properties.features;let y;if(s){let b=d[0];y={pickingId:p[b],start:0,end:g[b]*lr}}let x=!1,v=!1,_=0;const w=new Set;for(let b=0;b<c.length;b+=lr){const A=f[c[b]];if(!x&&y)for(;y.pickingId<A&&y.end<d.length;){const E=y.end,P=d[E];y.start=E,y.end=E+g[P]*lr,y.pickingId=p[P]}if(!x&&y&&y.pickingId<A&&(x=!0,!h)){if(!v)return[];for(let E=b;E<c.length;E+=lr)u[_++]=[-1,-1];return u}const T=m[A]&&m[A].feature,S=T&&T.properties||{},M=l?l(null,S):a;if(y&&A===y.pickingId){u[_++]=[y.start,y.end];const E=y.end,P=d[E];y.start=E,y.end=E+g[P]*lr,y.pickingId=p[P],v=!0}else if(M&&M!=="none")for(let E=b;E<b+lr;E++)w.add(E);else u[_++]=[-1,-1]}if(w.size)if(w.size===c.length)o.setElements([]);else{const b=[];for(let A=0;A<c.length;A++)w.has(A)||b.push(c[A]);o.setElements(new c.constructor(b))}return v?u:[]}(t,e,n);if(t.getElements().length&&i.length&&(t.properties.labelIndex=i,i.length&&n&&n!=="none"&&e)){const o=function(s,a){const l=[],h=s.properties.labelIndex,{aShape:u}=a.data;let c=!1;for(let f=0;f<h.length;f++){const[d,p]=h[f];if(d===-1)l.push(0,0,0,0);else{c=!0;let g=1/0,m=1/0,y=-1/0,x=-1/0;const v=a.elements;for(let _=d;_<p;_++){const w=v[_],b=u[2*w],A=u[2*w+1];b<g&&(g=b),b>y&&(y=b),A<m&&(m=A),A>x&&(x=A)}l.push(g,m,y,x)}}return c?l:[]}(t,e);o.length&&(t.properties.labelShape=o,_j.call(this,r,t,e))}}function _j(r,t){const e=this.getSymbolDef(t.properties.symbolIndex),n=e.markerTextFit,i=t.properties;let o=n==="both"||n==="width",s=n==="both"||n==="height";if(Ft(e.markerTextFit)){let d=t.properties.textFitFn;d||(d=t.properties.textFitFn=le(e.markerTextFit));const{features:p}=t.properties,g=t.properties.elements||t.elements,{aPickingId:m}=t.data,y=[],x=[];let v=!0;for(let _=0;_<g.length;_+=lr){const w=p[m[g[_]]],b=(w&&w.feature||{}).properties||{};let A=d(null,b);Ft(A)&&(A=(b.textFitFn=b.textFitFn||le(A))(null,b)),A==="both"?(y.push(_/lr),x.push(_/lr)):A==="width"?(v=!1,y.push(_/lr)):A==="height"&&(v=!1,x.push(_/lr))}v?(i.fitIcons=y,o=!0,s=!0):(y.length&&(i.fitWidthIcons=y,o=!0),x.length&&(i.fitHeightIcons=x,s=!0))}i.aPickingId||(i.aPickingId=new t.data.aPickingId.constructor(t.data.aPickingId));const{aMarkerWidth:a,aMarkerHeight:l,aPickingId:h}=i,u=h.length;if(o)if(a){const d=t.data.aMarkerWidth;t.data.aMarkerWidth=new Uint16Array(d),i.aMarkerWidth=new Uint16Array(d);const p=(An+"aMarkerWidth").trim();i[p]&&(i[p]=i.aMarkerWidth)}else{const d=this.getSymbol(t.properties.symbolIndex).markerWidth||0;i.aMarkerWidth=new Uint16Array(u),i.aMarkerWidth.fill(d),d&&(i.aMarkerWidth.dirty=!0),t.data.aMarkerWidth=new Uint16Array(u)}if(s)if(l){const d=t.data.aMarkerHeight;t.data.aMarkerHeight=new Uint16Array(d),i.aMarkerHeight=new Uint16Array(d);const p=(An+"aMarkerHeight").trim();i[p]&&(i[p]=i.aMarkerHeight)}else{const d=this.getSymbol(t.properties.symbolIndex).markerHeight||0;i.aMarkerHeight=new Uint16Array(u),i.aMarkerHeight.fill(d),d&&(i.aMarkerHeight.dirty=!0),t.data.aMarkerHeight=new Uint16Array(u)}const c=this.getSymbolDef(t.properties.textGeo.properties.symbolIndex),f=le(c.textSize);mP.call(this,r,t),(!Ft(c.textSize)||f.isZoomConstant&&f.isFeatureConstant)&&(i.isFitConstant=!0)}const gP=[0,0,0,0];function mP(r,t){const e=t.properties.textGeo;if(!e)return;const n=e.properties,i=t.properties;if(i.isFitConstant||!i.labelShape||!i.labelShape.length)return;const o=this.getSymbolDef(t.properties.symbolIndex),s=this.getSymbolDef(e.properties.symbolIndex).textSize;let a;Ft(s)&&(a=n.ar?n.ar:n.ar=le(s));const l=o.markerTextFitPadding||gP;let h;Ft(l)&&(h=i.lr?i.lr:i.lr=cn(l));const u=r.getZoom(),{fitIcons:c,fitWidthIcons:f,fitHeightIcons:d}=i,{aMarkerWidth:p,aMarkerHeight:g,labelShape:m}=i,y=i.elements||t.elements,{features:x,aPickingId:v}=i,_=(A,T,S,M)=>{const E=m[4*T],P=m[4*T+1],k=m[4*T+2],O=m[4*T+3];if(!(E||P||k||O))return;const I=v[A],D=x[I]&&x[I].feature,z=D&&D.properties||{};let L=a?a(u,z):s;Ft(L)&&(L=(z.textSizeFn=z.textSizeFn||le(L))(u,z)),L/=dp;let $,Z,j=h&&h(u,z)||l;if(Ft(j)&&(j=(z.fitPaddingFn=z.fitPaddingFn||cn(j))(u,z)),j=j||gP,j[0]===j[2]&&j[1]===j[3]||($=i.aPadOffsetX,Z=i.aPadOffsetY,$||($=i.aPadOffsetX=new Int8Array(p.length),Z=i.aPadOffsetY=new Int8Array(p.length))),p&&S){const st=Math.abs((k-E)/10*L)+(j[1]+j[3]||0);if(th[0]=st,p[A]!==th[0]&&(Xu(p,th[0],A,A+qi),p.dirty=!0),$){const lt=(j[1]+j[3])/2-j[3];mp[0]=lt,$[A]!==mp[0]&&(Xu($,lt,A,A+qi),$.dirty=!0)}}if(g&&M){const st=Math.abs((O-P)/10*L)+(j[0]+j[2]||0);if(th[0]=st,g[A]!==th[0]&&(Xu(g,th[0],A,A+qi),g.dirty=!0),Z){const lt=j[0]-(j[0]+j[2])/2;mp[0]=lt,Z[A]!==mp[0]&&(Xu(Z,lt,A,A+qi),Z.dirty=!0)}}};if(c||f||d){if(c)for(let A=0;A<c.length;A++){const T=c[A];_(y[T*lr],T,!0,!0)}else if(f||d){if(f)for(let A=0;A<f.length;A++){const T=f[A];_(y[T*lr],T,!0,!1)}if(d)for(let A=0;A<d.length;A++){const T=d[A];_(y[T*lr],T,!1,!0)}}}else for(let A=0;A<y.length;A+=lr){const T=A/lr;_(y[A],T,!0,!0)}const{aPadOffsetX:w,aPadOffsetY:b}=i;w&&(t.data.aPadOffsetX=w,t.data.aPadOffsetY=b)}const bj=function(r){const t=this.layer.getRenderer();return!this.sr(r)&&t.isForeground(r)&&!!r.geometry.properties.iconAtlas&&!r.geometry.properties.isEmpty},wj=function(r){const t=this.layer.getRenderer();return!(this.sr(r)||t.isForeground(r)||!r.geometry.properties.iconAtlas||r.geometry.properties.isEmpty)},Aj=function(r){const t=this.layer.getRenderer();return!this.sr(r)&&t.isForeground(r)&&!!r.geometry.properties.glyphAtlas},Tj=function(r){const t=this.layer.getRenderer();return!this.sr(r)&&!t.isForeground(r)&&!!r.geometry.properties.glyphAtlas},Mj=[],yP={collides:-1},Sj=[fp,fp],Cj=mn([]),Pj=[];class vP extends aP{static getBloomSymbol(){return["markerBloom","textBloom"]}constructor(t,e,n,i,o,s){super(t,e,n,i,o,s),this.propAllowOverlap="markerAllowOverlap",this.propIgnorePlacement="markerIgnorePlacement",this.Ln={},this.isLabelCollides=Wv.bind(this),this.hr=bj.bind(this),this.ur=wj.bind(this),this.cr=Aj.bind(this),this.dr=Tj.bind(this),this.pr=[]}needToRefreshTerrainTileOnZooming(){for(let t=0;t<this.symbolDef.length;t++){const e=this.symbolDef[t].markerPitchAlignment;if(e==="map"||Ft(e)||Lu.isExpression(e))return!0}return!1}isTerrainVector(){return this.layer.options.awareOfTerrain&&!this.needToRefreshTerrainTileOnZooming()}isTerrainSkin(){return super.isTerrainSkin()&&this.needToRefreshTerrainTileOnZooming()}setTextShaderDefines(t){this.mr=t}createFnTypeConfig(t,e){return{icon:vj.call(this,t,e),text:dP.call(this,t,e)}}startFrame(...t){return this.pr.length=0,super.startFrame(...t)}createGeometry(t,e){return t&&t.empty&&(t.data={aPosition:new Uint8Array(t.data.aPosition),aPickingId:t.data.aPickingId}),super.createGeometry(t,e)}postCreateGeometry(t,e){const{geometry:n,symbolIndex:i}=t,o=this.getSymbolDef(i),s=this.getFnTypeConfig(i);if(this.yr(n))n.properties.iconAtlas?this.drawDebugAtlas(n.properties.iconAtlas):n.properties.isEmpty=!0,yj(n,o,s.icon);else if(this.gr(n)&&Yu(o)){const a=e[e.length-1];if(a){const{geometry:l,symbolIndex:h}=a;if(l&&h.index===i.index){const u=this.getMap(),c=o.markerTextFit;l.properties.textGeo=n,xj.call(this,u,l,n,c)}}}}prepareCollideIndex(t){const{collideIds:e,elements:n,aCount:i}=t.properties;if(!e)return;const o=e,s={};if(!n)return void(t.properties.collideBoxIndex=s);let a=0,l=n[0],h=0,u=o[l],c=1;i&&(c=i[n[h]]);for(let f=0;f<=n.length;f+=lr)l=n[f],o[l]===u&&f!==n.length||(s[u]=[h,f,(f-h)/(c*lr),a++],u=o[l],h=f,i&&(c=i[n[h]]));t.properties.collideBoxIndex=s}createMesh(t,e,n,i){const o=this.isEnableCollision(),s=this.layer,{geometry:a,symbolIndex:l}=t;a.properties.symbolIndex=l;const h=this.getSymbolDef(l),u=this.getSymbol(l),c=this.getFnTypeConfig(l),f=[];if(this.yr(a)){const d=function(p,g,m,y,x,v,_,w){if(g.isDisposed()||g.data.aPosition.length===0)return null;const b=g.properties.iconAtlas;if(!b&&!g.properties.isEmpty)return null;const A={flipY:0,tileResolution:g.properties.tileResolution,tileRatio:g.properties.tileRatio};//!geometry.properties.aShape 以避免重复创建collision数据
if(!g.properties.aShape){const{aPosition:k,aShape:O}=g.data,I=g.data.aPosition.length/g.desc.positionSize,D=new Uint8Array(I);w&&D.fill(255,0),g.data.aOpacity={usage:"dynamic",data:D},g.properties.aOpacity=new Uint8Array(I),w&&g.properties.aOpacity.fill(255,0),g.properties.aAnchor=k,g.properties.aShape=O}g.properties.visElemts||(g.properties.elements=g.elements,g.properties.visElemts=new g.elements.constructor(g.elements.length));const[T,S]=tP(g);ue(A,"markerOpacity",x,"markerOpacity",1),ue(A,"markerPerspectiveRatio",x,"markerPerspectiveRatio",x.markerTextFit?0:1),ue(A,"markerWidth",x,"markerWidth",T||15),ue(A,"markerHeight",x,"markerHeight",S||15),ue(A,"markerDx",x,"markerDx",0),ue(A,"markerDy",x,"markerDy",0),ue(A,"markerRotation",x,"markerRotation",0,k=>k*Math.PI/180),ue(A,"pitchWithMap",x,"markerPitchAlignment",0,k=>k==="map"?1:0),ue(A,"rotateWithMap",x,"markerRotationAlignment",0,k=>k==="map"?1:0),A.iconTex=b?Ku(p,b,!1):null,A.texSize=b?[b.width,b.height]:[0,0],g.generateBuffers(p,{excludeElementsInVAO:!0});const M=new Gr(A),E=new nn(g,M,{disableVAO:!0,transparent:!0,castShadow:!1,picking:!0}),P={};return _&&(P.ENABLE_COLLISION=1),g.data.aMarkerWidth&&(P.HAS_MARKER_WIDTH=1),g.data.aMarkerHeight&&(P.HAS_MARKER_HEIGHT=1),g.data.aColorOpacity&&(P.HAS_OPACITY=1),g.data.aMarkerDx&&(P.HAS_MARKER_DX=1),g.data.aMarkerDy&&(P.HAS_MARKER_DY=1),g.data.aPitchAlign&&(P.HAS_PITCH_ALIGN=1),g.data.aRotationAlign&&(P.HAS_ROTATION_ALIGN=1),g.data.aRotation&&(P.HAS_ROTATION=1),g.data.aPadOffsetX&&(P.HAS_PAD_OFFSET=1),g.data.aAltitude&&(P.HAS_ALTITUDE=1),E.setDefines(P),E.setUniform("alphaTest",Bv),E.setLocalTransform(m),E.properties.symbolIndex=g.properties.symbolIndex,E}(this.regl,a,e,0,u,c.icon,s.options.collision,!o,this.isEnableUniquePlacement());d&&(d.positionMatrix=this.getAltitudeOffsetMatrix(),delete d.geometry.properties.glyphAtlas,f.push(d))}else if(this.gr(a)){const d=uP.call(this,this.regl,a,e,h,u,c.text,s.options.collision,!o,this.isEnableUniquePlacement());d.length&&(d.forEach(p=>{p.positionMatrix=this.getAltitudeOffsetMatrix(),delete p.geometry.properties.iconAtlas}),f.push(...d))}return a.properties.markerPlacement==="line"&&this.vr(a,i),a.properties.markerPlacement==="line"&&f.forEach(d=>d.properties.isLinePlacement=!0),this.prepareCollideIndex(a),f}vr(t,e){const n=this.layer instanceof En,{collideIds:i}=t.properties,o=new Uint16Array(i.length);if(this.yr(t)){let s=0;for(let a=0;a<i.length;a+=qi)o.fill(s++,a,a+qi);t.properties.collideIds=o,t.properties.uniqueCollideIds=tp(o,!n),e.markerCollideMap={old:i,new:o}}else if(this.gr(t)){const{collideIds:s,aCount:a}=t.properties;if(!a)return;if(e.markerCollideMap){const{markerCollideMap:l}=e;let h=l.new[l.new.length-1],u=0,c=s[0],f=e.markerCollideMap.old.indexOf(c),d=a[0];for(let p=0;p<s.length;){const g=s[p];c!==g&&(c=g,f=e.markerCollideMap.old.indexOf(c),u=0);const m=f===-1?++h:e.markerCollideMap.new[f+u*qi],y=p+d*qi;s.fill(m,p,y),p+=d*qi,u++,y<s.length&&(d=a[y])}t.properties.uniqueCollideIds=tp(s,!n)}else{let l=0,h=a[0];for(let u=0;u<s.length;){const c=u+h*qi;s.fill(l++,u,c),u+=h*qi,c<s.length&&(h=a[c])}t.properties.uniqueCollideIds=tp(s,!n)}}}addMesh(t){if(this.isEnableCollision()&&t.length>0){const n=new sp(t);n.properties.uniqueCollideIds=t[0].geometry.properties.uniqueCollideIds,n.properties.meshKey=t[0].properties.meshKey,n.properties.level=t[0].properties.level,this.pr.push(n)}for(let n=0;n<t.length;n++){if(!this.isMeshIterable(t[n]))continue;const i=t[n].geometry,{symbolIndex:o}=i.properties;Yu(this.getSymbolDef(o))&&mP.call(this,this.getMap(),i)}const e=this.getMap().getZoom();for(let n=0;n<t.length;n++){if(!this.isMeshIterable(t[n]))continue;const i=t[n].geometry,{symbolIndex:o}=i.properties,s=this.getSymbolDef(o),a=this.getFnTypeConfig(o);$C(this.regl,s,o.type===0?a.icon:a.text,t[n],e);const{aMarkerWidth:l,aMarkerHeight:h,aPadOffsetX:u,aPadOffsetY:c}=i.properties;l&&l.dirty&&(i.updateData("aMarkerWidth",l),l.dirty=!1),h&&h.dirty&&(i.updateData("aMarkerHeight",h),h.dirty=!1),u&&u.dirty&&(i.updateData("aPadOffsetX",u),u.dirty=!1),c&&c.dirty&&(i.updateData("aPadOffsetY",c),c.dirty=!1)}super.addMesh(...arguments)}updateCollision(t){if(!this.isEnableCollision())return;super.updateCollision(t);const e=this.scene.getMeshes();e&&e.length?(this.br(t.timestamp),this.pr=[],this.xi()):this.xi()}callCurrentTileShader(t,e){this.shader.filter=e.sceneFilter?[this.hr,e.sceneFilter]:this.hr,this.callRenderer(this.shader,t,e),this.Ar.filter=e.sceneFilter?[this.cr,e.sceneFilter]:this.cr,this.callRenderer(this.Ar,t,e)}callBackgroundTileShader(t,e){this.shader.filter=e.sceneFilter?[this.ur,e.sceneFilter]:this.ur,this.callRenderer(this.shader,t,e),this.Ar.filter=e.sceneFilter?[this.dr,e.sceneFilter]:this.dr,this.callRenderer(this.Ar,t,e)}isMeshIterable(t){return t&&t.geometry&&!t.geometry.properties.isEmpty&&t.material&&!t.material.get("isHalo")&&this.isMeshVisible(t)&&!(this.shouldIgnoreBackground()&&!this.layer.getRenderer().isForeground(t))}br(){if(!this.isEnableCollision())return;let t=this.pr;t&&t.length&&this.wr(t)}_r(t,e,n,i){return this.updateBoxCollisionFading(!0,t,e,n,i)}isEnableUniquePlacement(){return this.isEnableCollision()&&this.sceneConfig.uniquePlacement===!0}wr(t){const e=this.layer.getRenderer();t=t.sort(Ej);for(let n=0;n<t.length;n++){const i=t[n];if(!i||!i.meshes.length)continue;let o=!1;if(i.meshes.length===1)o=this.isMeshIterable(i.meshes[0]);else for(let l=0;l<i.meshes.length;l++)if(this.isMeshIterable(i.meshes[l])){o=!0;break}if(!o)continue;const s=e.isForeground(i.meshes[0]);if(this.shouldIgnoreBackground()&&!s)continue;const a=i.properties.meshKey;this.startMeshCollision(i),this.Sr(i),this.forEachBox(i,this._r),this.Mr(i),this.endMeshCollision(a);for(let l=0;l<i.meshes.length;l++)this.Tr(i.meshes[l])}}Tr(t){const e=t&&t.geometry&&t.geometry.properties.aOpacity;e&&e.dirty&&(t.geometry.updateData("aOpacity",e),e.dirty=!1)}forEachBox(t,e){const n=t.properties.uniqueCollideIds;if(!n)return;const i={boxIndex:0},o=n.length;for(let s=0;s<o;s++)this.Pr(t,n[s],e,i)}Pr(t,e,n,i){const o=this.getMap(),{collideBoxIndex:s}=t.meshes[0].geometry.properties;if(!(s&&s[e]))return!1;const a=qt(Mj,o.projViewMatrix,t.meshes[0].localTransform);let l,h=!1;const u=t.meshes;let c=0;for(let d=0;d<u.length;d++){if(!this.isMeshIterable(u[d]))continue;const{collideBoxIndex:p}=u[d].geometry.properties;p[e]&&c++}if(!c)return!1;l=this.ir(c);let f=0;for(let d=0;d<u.length;d++){const p=u[d];if(!this.isMeshIterable(p))continue;h=!0;const g=u[d].geometry.properties,{elements:m,aCount:y,collideBoxIndex:x}=g,v=x[e];if(!v)continue;const[_,w,b]=v;let A=1;y&&(A=y[m[_]]);const T=_+0*A*lr;l[f].mesh=u[d],l[f].start=T,l[f].end=w,l[f].boxCount=g.glyphAtlas?A:b,l[f].allElements=m,f++}return h?(n.call(this,t,l,a,i.boxIndex++)&&this.kr(t,e),!0):!1}Sr(t){const e=t.meshes;for(let n=0;n<e.length;n++){const i=e[n],o=i&&i.geometry;o&&(o.properties.visElemts.count=0)}}kr(t,e){const n=t.meshes;for(let i=0;i<n.length;i++){const o=n[i];if(o.properties.isHalo)continue;const s=o&&o.geometry;if(!s||s.properties.isEmpty)continue;const{collideBoxIndex:a,elements:l,visElemts:h}=s.properties,u=a[e];if(!u)continue;const[c,f]=u;let d=h.count;for(let p=c;p<f;p++)h[d++]=l[p];h.count=d}}Mr(t){const e=t.meshes;for(let n=0;n<e.length;n++){const i=e[n],o=i&&i.geometry;if(!o)continue;const{visElemts:s}=o.properties;o.setElements(s,s.count)}}isBoxCollides(t,e,n,i,o,s){if(this.gr(t.geometry))return Wv.call(this,0,t,e,n,i,o,s);if(t.geometry.properties.isEmpty)return yP;const{aTerrainAltitude:a}=t.geometry.properties;if(a&&a[2*e[i]]===Gl)return yP;const l=this.getMap(),{boxes:h,collision:u}=this.nr(t,i);let c=0,f=0,d=0;for(let p=i;p<o;p+=lr){const g=h[d]=h[d]||[];d++;const m=hj.call(this,g,t,e[p],s,l);if(!c){const y=this.isCollides(m);y===1?c=1:y===-1&&f++}}return f===n&&(c=-1),u.collides=c,u}deleteMesh(t,e){t&&(t instanceof sp&&(t=t.meshes),e&&(Array.isArray(t)?t.forEach(n=>{n&&n.material&&delete n.material.uniforms.iconTex}):t.material&&delete t.material.uniforms.iconTex),super.deleteMesh(t,e))}isBloom(t){const e=t&&t.material&&!wn(t.material.get("markerOpacity")),n=this.getSymbol(t.properties.symbolIndex);return!!(e?n.markerBloom:n.textBloom)}isUniqueStencilRefPerTile(){return!1}init(){const t=this.regl,e=this.canvas;this.renderer=new un(t);const n={viewport:{x:(a,l)=>l.viewport?l.viewport.x:0,y:(a,l)=>l.viewport?l.viewport.y:0,width:(a,l)=>l.viewport?l.viewport.width:e?e.width:1,height:(a,l)=>l.viewport?l.viewport.height:e?e.height:1},stencil:{enable:!0,func:{cmp:"<=",ref:(a,l)=>l.stencilRef},op:{fail:"keep",zfail:"keep",zpass:"replace"}},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},depth:{enable:!0,range:()=>this.sceneConfig.depthRange||[0,1],func:()=>this.sceneConfig.depthFunc||"always",mask:!!wn(this.sceneConfig.depthMask)||this.sceneConfig.depthMask},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}};this.shader=new Ye({vert:lP,frag:`#define SHADER_NAME MARKER
#define HAS_HIGHLIGHT_COLOR_POINT 1
precision mediump float;
#include <gl2_frag>
uniform float alphaTest;
uniform sampler2D iconTex;
uniform lowp float markerOpacity;
uniform lowp float blendSrcIsOne;
uniform float layerOpacity;
#include <highlight_frag>
varying vec2 vTexCoord;
varying float vOpacity;
void main() {
  vec4 c = texture2D(iconTex, vTexCoord) * markerOpacity * vOpacity * layerOpacity;
  if(c.a < .05) {
    discard;
  }
  glFragColor = c;
  glFragColor = highlight_blendColor(glFragColor);
  if(glFragColor.a < alphaTest) {
    discard;
  }
  glFragColor = highlight_blendColor(glFragColor);
#if __VERSION__ == 100
gl_FragColor = glFragColor;
#endif
}`,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(a,l){return qt([],l.projViewMatrix,l.modelMatrix)}},{name:"zoomScale",type:"function",fn:function(a,l){return l.tileResolution/l.resolution}}],extraCommandProps:n}),this.shader.version=300;const{uniforms:i,extraCommandProps:o}=fP.call(this,e,this.sceneConfig),s=this.mr||{};if(this.Ar=new Ye({vert:gp,frag:Xv,uniforms:i,extraCommandProps:o,defines:s}),this.pickingFBO){const a=new Pi(this.renderer,{vert:`#define PICKING_MODE 1
`+lP,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(h,u){return qt([],u.projViewMatrix,u.modelMatrix)}},{name:"zoomScale",type:"function",fn:function(h,u){return u.tileResolution/u.resolution}}],extraCommandProps:n},this.pickingFBO,this.getMap());a.filter=h=>!!h.geometry.properties.iconAtlas;const l=new Pi(this.renderer,{vert:`#define PICKING_MODE 1
`+gp,uniforms:i,extraCommandProps:o},this.pickingFBO,this.getMap());l.filter=h=>!!h.geometry.properties.glyphAtlas,this.picking=[a,l]}}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin,i=this.layer.getTileSize().width,o=n?Cj:t.projViewMatrix,s=t.cameraToCenterDistance,a=Pe(Pj,t.width,t.height);n&&Pe(a,i,i);const l=this.getBlendFunc(),h=Jr.isFunction(l.src)?l.src():l.src;return{layerScale:this.layer.options.styleScale||1,mapPitch:t.getPitch()*Math.PI/180,mapRotation:t.getBearing()*Math.PI/180,projViewMatrix:o,cameraToCenterDistance:s,canvasSize:a,iconSize:Sj,resolution:t.getResolution(),glyphSize:dp,gammaScale:1,blendSrcIsOne:+!(h!=="one"&&h!==1),viewport:n&&e&&e.viewport,isRenderingTerrain:+!!n}}getUniqueEntryKey(t,e){if(!this.gr(t.geometry))return null;const{elements:n}=t.geometry.properties;return pP(t,n[e])}yr(t){const{symbolIndex:e}=t.properties;return e.type===0}gr(t){const{symbolIndex:e}=t.properties;return e.type===1}}function Ej(r,t){return r.properties.level-t.properties.level||r.properties.meshKey-t.properties.meshKey}const Oj=[],kj=[],Ij=[];function Yv(r,t,e,n,i,o,s,a,l,h,u,c,f){const{aGlyphOffset:d,aSegment:p,aTextDx:g,aTextDy:m,symbolIndex:y}=t.geometry.properties,x=this.getSymbol(y),v=g?g[i]:x.textDx,_=m?m[i]:x.textDy,w=Pe(Ij,v||0,_||0),b=Pe(Oj,d[2*i],d[2*i+1]),A=ie(kj,p[3*i],p[3*i+1],p[3*i+2]);return function(S,M,E,P,k,O,I,D,z,L,$,Z,j,st,lt,rt,Rt,Ht){lt||(lt=P);const ee=M.geometry.properties.line,nt=O[0]*Z,Dt=j?nt-I:nt+I;let Vt=Dt>0?1:-1,Ct=0;j&&(Vt*=-1,Ct=Math.PI),Vt<0&&(Ct+=Math.PI);const _e=L+$,Ie=Math.abs(Dt);let Jt=Vt>0?z:z+1,Ne=ip.convert(P),ce=ip.convert(P),ke=ip.convert(k),qe=ip.convert(k),Re=0,Je=0;for(;Re+Je<=Ie;){if(Jt+=Vt,Jt<L||Jt>=_e)return null;ce.x=Ne.x,ce.y=Ne.y,qe.x=ke.x,qe.y=ke.y,Ne.x=E[3*Jt],Ne.y=E[3*Jt+1],ke.x=ee[3*Jt],ke.y=ee[3*Jt+1],Re+=Je,Je=ce.dist(Ne)/st}const Le=(Ie-Re)/Je,pn=rt&&rt.getRenderer(),Tn=pn&&pn.getTerrainHelper(),nr=M.properties.tile.terrainTileInfos;if(!Ht&&Tn){const{extent:we}=M.properties.tile,Ze=rt.getTileSize().width/we,yn=rt.getMap();let rn=ke.sub(qe).mult(Le).rn(qe);Ne=Ov(kB,yn,M,ke,Ze,rt,Rt,nr),ce=Ov(IB,yn,M,qe,Ze,rt,Rt,nr),rn=Ov(RB,yn,M,rn,Ze,rt,Rt,nr);const vr=Ct+Math.atan2(Ne[1]-ce[1],Ne[0]-ce[0]);return S[0]=(rn[0]-lt[0])/st,S[1]=(rn[1]-lt[1])/st,S[2]=vr,S}const ln=Ne.sub(ce),qn=ln.mult(Le).rn(ce);qn.rn(ln.mn().yn().hn(D*Vt));const hn=Ct+Math.atan2(Ne.y-ce.y,Ne.x-ce.x);return S[0]=(qn.x-P[0])/st,S[1]=(qn.y-P[1])/st,S[2]=hn,S}(r,t,n,o,s,b,w[0],w[1],A[0],A[1],A[2],e/24,l,a,h,u,c,f)}const As=[],Ts=[];function Rj(r,t,e,n,i,o,s,a,l,h,u,c){const{aVertical:f}=e.geometry.properties,d=f[o];let p,g,m=Yv.call(this,As,e,n,i,o,a,l,h,!1);if(!m||(Ar(r,m),m=Yv.call(this,Ts,e,n,i,s,a,l,h,!1),!m))return null;if(Ar(t,m),c&&(Ui(As,As,c),Ui(Ts,Ts,c)),d){const y=Math.abs(Ts[1]-As[1]),x=Math.abs(Ts[0]-As[0])*u;g=As[0]>Ts[0]?1:0,y>x?(p=1,g=As[1]<Ts[1]?0:1):p=0}else p=0,g=As[0]>Ts[0]?1:0;return 2*g+p}var xP=`#define SHADER_NAME TEXT_LINE
#ifdef HAS_ALTITUDE
attribute vec2 aPosition;
attribute float aAltitude;
#else
attribute vec3 aPosition;
#endif
attribute vec2 aTexCoord;
#ifdef HAS_OFFSET_Z
attribute vec3 aOffset;
uniform float altitudeScale;
#else
attribute vec2 aOffset;
#endif
#ifdef ENABLE_COLLISION
attribute float aOpacity;
#endif
#ifdef HAS_OPACITY
attribute float aColorOpacity;
#endif
#ifdef HAS_TEXT_SIZE
attribute float aTextSize;
#else
uniform float textSize;
#endif
#ifdef HAS_TEXT_DX
attribute float aTextDx;
#else
uniform float textDx;
#endif
#ifdef HAS_TEXT_DY
attribute float aTextDy;
#else
uniform float textDy;
#endif
#if defined(HAS_PITCH_ALIGN)
attribute float aPitchAlign;
#else
uniform float pitchWithMap;
#endif
uniform float zoomScale;
uniform float cameraToCenterDistance;
uniform mat4 projViewModelMatrix;
uniform float textPerspectiveRatio;
uniform float mapPitch;
uniform vec2 texSize;
uniform vec2 canvasSize;
uniform float tileRatio;
uniform float layerScale;
uniform float isRenderingTerrain;
uniform float textPitchFilter;
#ifndef PICKING_MODE
varying vec2 vTexCoord;
varying float vGammaScale;
varying float vSize;
varying float vOpacity;
#ifdef HAS_TEXT_FILL
attribute vec4 aTextFill;
varying vec4 vTextFill;
#endif
#ifdef HAS_TEXT_HALO_FILL
attribute vec4 aTextHaloFill;
varying vec4 vTextHaloFill;
#endif
#ifdef HAS_TEXT_HALO_RADIUS
attribute float aTextHaloRadius;
varying float vTextHaloRadius;
#endif
#ifdef HAS_TEXT_HALO_OPACITY
attribute float aTextHaloOpacity;
varying float vTextHaloOpacity;
#endif
#include <highlight_vert>
#else
#include <fbo_picking_vert>
#endif
#include <vt_position_vert>
void main() {
  vec3 c = unpackVTPosition();
#ifdef HAS_TEXT_DX
float d = aTextDx;
#else
float d = textDx;
#endif
#ifdef HAS_TEXT_DY
float e = aTextDy;
#else
float e = textDy;
#endif
#ifdef HAS_TEXT_SIZE
float f = aTextSize * layerScale;
#else
float f = textSize * layerScale;
#endif
#ifdef HAS_PITCH_ALIGN
float h = aPitchAlign;
#else
float h = pitchWithMap;
#endif
gl_Position = projViewModelMatrix * vec4(c, 1.);
  float i = gl_Position.w;
  float j = i / cameraToCenterDistance;
  float k;
  if(isRenderingTerrain == 1.) {
    k = 1.;
  } else {
    float l = (1. - cameraToCenterDistance / i) * textPerspectiveRatio;
    k = clamp(.5 + .5 * (1. - l), .0, 4.);
  }
#ifdef HAS_OFFSET_Z
vec3 m = aOffset / 10.0;
  m[2] /= altitudeScale;
#else
vec3 m = vec3(aOffset / 10.0, .0);
#endif
vec2 n = aTexCoord;
  if(h == 1.) {
    float o;
    if(isRenderingTerrain == 1.) {
      o = tileRatio;
    } else {
      o = tileRatio / zoomScale * j * k;
    }
    m.xy *= o;
    gl_Position = projViewModelMatrix * vec4(c + m, 1.);
  } else {
    gl_Position.xy += m.xy * 2. / canvasSize * k * i;
  }
  gl_Position.xy += vec2(d, -e) * 2. / canvasSize * i;
  if(textPitchFilter > .0) {
    if(textPitchFilter == 1. && h == .0 || textPitchFilter == 2. && h == 1.) {
      gl_Position = vec4(-9999., -9999., .0, 1.);
    }
  }
#ifndef PICKING_MODE
if(h == 1.) {
    vGammaScale = j + mapPitch / 4.;
  } else {
    vGammaScale = mix(1., j, textPerspectiveRatio);
  }
  vGammaScale = clamp(vGammaScale, .0, 1.);
  vTexCoord = n / texSize;
  vSize = f;
#ifdef ENABLE_COLLISION
vOpacity = aOpacity / 255.;
#else
vOpacity = 1.;
#endif
#ifdef HAS_OPACITY
vOpacity *= aColorOpacity / 255.;
#endif
#ifdef HAS_TEXT_FILL
vTextFill = aTextFill / 255.;
#endif
#ifdef HAS_TEXT_HALO_FILL
vTextHaloFill = aTextHaloFill / 255.;
#endif
#ifdef HAS_TEXT_HALO_RADIUS
vTextHaloRadius = aTextHaloRadius;
#endif
#ifdef HAS_TEXT_HALO_OPACITY
vTextHaloOpacity = aTextHaloOpacity;
#endif
highlight_setVarying();
#else
#ifdef ENABLE_COLLISION
bool u = aOpacity == 255.;
#else
bool u = true;
#endif
fbo_picking_setData(gl_Position.w, u);
#endif
}`;const Dj=function(r){const t=this.layer.getRenderer();return!this.sr(r)&&t.isTileNearCamera(r)&&r.geometry.properties.textPlacement!=="line"},Fj=function(r){const t=this.layer.getRenderer();return!this.sr(r)&&!t.isForeground(r)&&r.geometry.properties.textPlacement!=="line"},Lj=function(r){const t=this.layer.getRenderer();return!this.sr(r)&&t.isTileNearCamera(r)&&r.geometry.properties.textPlacement==="line"},zj=function(r){const t=this.layer.getRenderer(),e=r.properties.tile.z,n=t.getCurrentTileZoom();return!this.sr(r)&&!t.isForeground(r)&&r.geometry.properties.textPlacement==="line"&&e<n},Hj=[0,0,3],_P=[],Nj=[],Bj=[],yp=[],jj=[],Vj=[],Go=[],go=[],bP=[1,-1],Uo=new Int16Array(3),Gj=[],wP=[],qv=[],Jv=[],Uj=[],AP=[],TP=[],MP={},SP={},$j={},Wj=[],Zj=[],Xj=mn([]),CP=[];class Kv extends aP{static getBloomSymbol(){return["textBloom"]}constructor(t,e,n,i,o,s){super(t,e,n,i,o,s),this.propAllowOverlap="textAllowOverlap",this.propIgnorePlacement="textIgnorePlacement",this.colorCache={},this.Ir=Dj.bind(this),this.Or=Fj.bind(this),this.Cr=Lj.bind(this),this.Fr=zj.bind(this),this.isLabelCollides=Wv.bind(this),this.Er()}prepareRender(...t){super.prepareRender(...t);const e=this.scene.getMeshes();if(e&&e.length)for(let n=0;n<e.length;n++){if(e[n].properties.isHalo)continue;const{haloMesh:i}=e[n].properties;i.dirtyDefines&&e[n].setDefines(i.defines)}}updateSymbol(...t){this.Dr=void 0,this.Lr=void 0;const e=super.updateSymbol(...t);return this.Er(),e}isTerrainVector(){if(!super.isTerrainSkin())return!1;if(this.Dr!==void 0)return this.Dr;for(let t=0;t<this.symbolDef.length;t++)if(this.symbolDef[t].textPitchAlignment!=="map")return this.Dr=!0,!0;return this.Dr=!1,!1}isTerrainSkin(){if(!super.isTerrainSkin())return!1;if(this.Lr!==void 0)return this.Lr;for(let t=0;t<this.symbolDef.length;t++){const e=this.symbolDef[t].textPitchAlignment;if(e==="map"||Ft(e)||Lu.isExpression(e))return this.Lr=!0,!0}return this.Lr=!1,!1}Er(){this.zr=[];for(let t=0;t<this.symbolDef.length;t++){const e=this.symbolDef[t];if(Lu.isExpression(e.textName)){const n=Lu.createExpression(e.textName,"string");this.zr[t]=(i,o)=>{let s;MP.zoom=i,SP.properties=o;try{s=n.evaluateWithoutErrorHandling(MP,SP,$j,null,Wj)}catch{s=null}return s}}else Ft(e.textName)&&(this.zr[t]=le(e.textName))}}shouldDeleteMeshOnUpdateSymbol(t){if(!Array.isArray(t))return(t.textHaloRadius===0||this.symbolDef[0].textHaloRadius===0)&&t.textHaloRadius!==this.symbolDef[0].textHaloRadius;for(let e=0;e<t.length;e++)if(t[e]&&(t[e].textHaloRadius===0||this.symbolDef[e].textHaloRadius===0)&&t[e].textHaloRadius!==this.symbolDef[e].textHaloRadius)return!0;return!1}createFnTypeConfig(t,e){return dP(t,e)}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex)[Kv.getBloomSymbol()[0]]}createGeometry(t,e,n){const i=t;if(!i.glyphAtlas)return null;const o=super.createGeometry(i,e);if(!o||!o.geometry)return null;const{geometry:s}=o;return s.properties.glyphAtlas&&this.drawDebugAtlas(s.properties.glyphAtlas),s&&i.lineVertex&&(s.properties.line=i.lineVertex,s.properties.line.id=n),o}createMesh(t,e,{tileVectorTransform:n}){const i=this.isEnableCollision(),o=this.isEnableUniquePlacement(),{geometry:s,symbolIndex:a}=t;s.properties.symbolIndex=a;const l=this.getSymbol(a),h=this.getSymbolDef(a),u=this.getFnTypeConfig(a),c=uP.call(this,this.regl,s,e,h,l,u,this.layer.options.collision,!i,o);return c.length&&(s.properties.textPlacement==="line"?this.Rr=!0:this.Hr=!0),c.forEach(f=>{f.positionMatrix=this.getAltitudeOffsetMatrix(),f.properties.tileVectorTransform=n}),c}updateCollision(t){super.updateCollision(t);const e=this.scene.getMeshes();e&&e.length?(this.Nr={},this.Vr(t.timestamp),this.xi()):this.xi()}callCurrentTileShader(t,e){this.shader.filter=e.sceneFilter?[this.Ir,e.sceneFilter]:this.Ir,this.callRenderer(this.shader,t,e),this.jr.filter=e.sceneFilter?[this.Cr,e.sceneFilter]:this.Cr,this.callRenderer(this.jr,t,e)}callBackgroundTileShader(t,e){this.shader.filter=e.sceneFilter?[this.Or,e.sceneFilter]:this.Or,this.callRenderer(this.shader,t,e),this.jr.filter=e.sceneFilter?[this.Fr,e.sceneFilter]:this.Fr,this.callRenderer(this.jr,t,e)}callRenderer(t,e,n){n&&n.isRenderingTerrain&&Ft(this.symbolDef.textPitchAlignment)&&(n.isRenderingTerrainSkin?e.textPitchFilter=1:e.textPitchFilter=2),super.callRenderer(t,e,n)}Vr(){let t=this.scene.getMeshes();if(!t||!t.length)return;const e=-this.getMap().getBearing()*Math.PI/180,n=NR(Bj,e),i=(a,l,h,u)=>{const{start:c,end:f,mesh:d,allElements:p}=l[0];if(this.updateBoxCollisionFading(!0,d,l,h,u)){let g=a.count;for(let m=c;m<f;m++)a[g++]=p[m];a.count=g}},o=this.isEnableCollision(),s=this.layer.getRenderer();t=t.sort(Yj);for(let a=0;a<t.length;a++){const l=t[a];if(!this.isMeshIterable(l))continue;if(!s.isTileNearCamera(l)){const{visElemts:f}=l.geometry.properties;f&&(f.count=0),l.geometry.setElements(f,0);continue}const h=l.geometry,u=this.getSymbol(l.properties.symbolIndex);l.properties.textHaloRadius=wn(u.textHaloRadius)?yr.textHaloRadius:u.textHaloRadius;const c=l.properties.meshKey;if(h.properties.textPlacement==="line"){if(!h.properties.line)continue;o&&this.startMeshCollision(l),this.Ur(l,n);const{aOffset:f,aOpacity:d}=h.properties;f.dirty&&(h.updateData("aOffset",f),f.dirty=!1),d&&d.dirty&&(h.updateData("aOpacity",d),d.dirty=!1),o&&this.endMeshCollision(c)}else if(o){this.startMeshCollision(l);const{elements:f,aOpacity:d,visElemts:p}=h.properties;p.count=0,this.forEachBox(l,(y,x,v,_,w)=>{i(p,x,v,_)}),d&&d.dirty&&h.updateData("aOpacity",d);const g=p.count===f.length&&h.count===f.length,m=!p.count&&!h.count;g||m||h.setElements(p,p.count),this.endMeshCollision(c)}}}isMeshIterable(t){return t.isValid()&&t.material&&!t.material.get("isHalo")&&!(this.shouldIgnoreBackground()&&!this.layer.getRenderer().isForeground(t))}isMeshUniquePlaced(t){return this.isMeshIterable(t)?this.getSymbol(t.properties.symbolIndex).textPlacement!=="line":!1}getUniqueEntryKey(t,e){return pP(t,e)}Ur(t,e){const n=this.getMap(),i=t.geometry,o=i.properties;let s=o.line;if(!s)return;const a=n.getPitch(),l=n.getBearing(),{lineTextPitch:h,lineTextBearing:u}=t.properties,c=t.material.uniforms.pitchWithMap===1,f=o.elements;if(!c){const x=qt(_P,n.projViewMatrix,t.localTransform),v=s.id+"-"+x.join();let _;this.Nr[v]?s=this.Nr[v]:(_=o.projectedLine=o.projectedLine||new Array(s.length),s=this.Gr(_,s,x,n.width,n.height),this.Nr[v]=_)}const d=this.isEnableCollision(),p=i.properties.visElemts=i.properties.visElemts||new f.constructor(f.length),g=i.properties.visCache=i.properties.visCache||[];d&&(p.count=0);const m=h===void 0||!n.isInteracting()||Math.abs(a-h)>2||Math.abs(l-u)>2;m&&(this.li=!0),this.forEachBox(t,(x,v,_,w)=>{const{start:b,end:A}=v[0];let T=g[w];if((T===void 0||m)&&(T=this.Wr(x,f,b,A,s,_,c?e:null,w)),g[w]=T,d&&(T=this.updateBoxCollisionFading(T,x,v,_,w),T)){let S=p.count;for(let M=b;M<A;M++)p[S++]=f[M];p.count=S}}),m&&(t.properties.lineTextPitch=a,t.properties.lineTextBearing=l);const y=t.geometry.properties.aAltitude;y&&y.dirty&&(i.updateData("aAltitude",y),y.dirty=!1),!d||p.count===f.length&&i.count===p.count||i.setElements(p,p.count)}Gr(t,e,n,i,o){return function(a,l,h,u,c){for(let f=0;f<l.length;f+=3)Tr(ri,l[f],l[f+1],l[f+2],1),po(ri,ri,h,u,c),a[f]=ri[0],a[f+1]=ri[1],a[f+2]=l[f+2];return a}(t,e,n,i,o)}forEachBox(t,e){const n=this.getMap(),i=qt(_P,n.projViewMatrix,t.properties.tileVectorTransform),{collideIds:o,aCount:s,features:a,elements:l}=t.geometry.properties,h=o;if(!h)return;const u=this.isEnableUniquePlacement(),c=this.ir(1);c[0].allElements=l,c[0].mesh=t;let f=0,d=l[0],p=0,g=h[d];for(let m=0;m<=l.length;m+=6)if(d=l[m],h[d]!==g||m===l.length){const y=a[g]&&a[g].feature;if(u&&this.isMeshUniquePlaced(t)&&y&&!y.label){const _=y.properties||{},{symbolIndex:w}=t.properties,b=w&&this.zr[w.index]?this.zr[w.index](t.properties.z,_):this.getSymbol(t.properties.symbolIndex).textName,A=PN.resolveText(b,_);y.label=A}const x=m,v=s[l[p]];for(let _=p;_<x;_+=6*v)c[0].start=_,c[0].end=_+6*v,c[0].boxCount=v,e.call(this,t,c,i,f++);g=h[d],p=m}}Wr(t,e,n,i,o,s,a){const l=this.layer.getRenderer(),h=t.material.uniforms,u=h.pitchWithMap===1,c=!u&&l.getTerrainHelper&&l.getTerrainHelper(),f=this.isEnableCollision(),d=this.getMap(),p=t.geometry,g=p.desc.positionSize,{aShape:m,aOffset:y,aAnchor:x,aAltitude:v,aPitchRotation:_}=p.properties;let{aProjectedAnchor:w}=p.properties;w||(w=p.properties.aProjectedAnchor=new Array(x.length/g*3));const b=p.properties.aTextSize,A=!a,T=e[n],S=T*g;let M;M=p.data.aAltitude?ie(yp,x[S],x[S+1],v[T]):Lr.unpackPosition(yp,x[S],x[S+1],x[S+2]);const E=po(jj,M,s,d.width,d.height),P=p.properties.aTerrainAltitude;let k;if(P){const rt=P[T];if(rt===Gl)return w[3*T]=ua,w[3*T+1]=ua,w[3*T+2]=ua,!1;rt?(k=ie(Zj,...M),k[2]=100*rt,k=po(k,k,s,d.width,d.height)):k=E}else k=E;const O=d.getDevicePixelRatio();if(Jh(CP,k,1/O),d.isOffscreen(CP))return f||Qv(y,e,n,i),w[3*T]=ua,w[3*T+1]=ua,w[3*T+2]=ua,!1;A&&(M=E),w[3*T]=k[0],w[3*T+1]=k[1],w[3*T+2]=k[2];const I=A?1:p.properties.tileExtent/this.layer.getTileSize().width;let D=!0;const z=e[n],L=e[i-1],$=b?b[z]:t.properties.textSize,Z=this.Yr(t,$,o,z,L,M,yp,I,a);if(Z===null)return Qv(y,e,n,i),!1;const j=L-z<=3,st=Math.floor(Z/2),lt=Z%2;for(let rt=n;rt<i;rt+=6){const Rt=e[rt];let Ht;if(Ht=st||rt!==n||j||c?st||rt!==i-6||j||c?Yv.call(this,Nj,t,$,o,Rt,M,yp,I,st,k,this.layer,s,u):TP:AP,!Ht){D=!1,f||Qv(y,e,n,i);break}let ee=Ht[2];lt&&(ee-=Math.PI/2);const nt=Nv(Vj,ee,0,h.rotateWithMap,h.pitchWithMap),Dt=y.length>m.length;let Vt;if(Dt){ie(Jv,_[3*Rt],_[3*Rt+1],0);const Ct=Za(Jv,Jv),_e=-_[3*Rt+2];if(_e){const Ie=tw(Gj,Ct,_e);qh(wP,Hj),Zb(qv,Ie),Vt=qt(qv,qv,wP)}}for(let Ct=0;Ct<4;Ct++){const _e=2*(Rt+Ct);Pe(Go,m[_e]/10,m[_e+1]/10),fi(Go,Go,$/24),Ui(Go,Go,nt),u?(hr(Go,Go,bP),iw(go,Go,Ht),Dt&&(go[2]=0,Vt&&Xa(go,go,Vt))):(hr(go,Ht,bP),iw(go,Go,go)),Uo[0]=10*go[0],Uo[1]=10*go[1],Dt&&(Uo[2]=10*go[2]);const Ie=(Dt?3:2)*(Rt+Ct);(y[Ie]!==Uo[0]||y[Ie+1]!==Uo[1]||Dt&&y[Ie+2]!==Uo[2])&&(y.dirty=!0,y[Ie]=Uo[0],y[Ie+1]=Uo[1],Dt&&(y[Ie+2]=Uo[2]))}}return D}Yr(t,e,n,i,o,s,a,l,h){const u=o-i<=3,c=this.getMap();return u?0:Rj.call(this,AP,TP,t,e,n,i,o,s,a,l,c.width/c.height,h)}isBoxCollides(t,e,n,i,o,s){return this.isLabelCollides(0,t,e,n,i,o,s)}deleteMesh(t,e){t&&(e&&(Array.isArray(t)?t.forEach(n=>{n&&n.material&&delete n.material.uniforms.texture}):t.material&&delete t.material.uniforms.texture),super.deleteMesh(t,e))}delete(){super.delete(),this.jr.dispose(),delete this.Nr,this.Br&&this.Br.dispose()}isUniqueStencilRefPerTile(){return!1}isEnableTileStencil(){return!this.layer.getRenderer().isEnableWorkAround("win-intel-gpu-crash")}init(){const t=this.regl;this.renderer=new un(t);const{uniforms:e,extraCommandProps:n}=fP.call(this,this.canvas,this.sceneConfig),i=this.canvas,o={x:(a,l)=>l.viewport?l.viewport.x:0,y:(a,l)=>l.viewport?l.viewport.y:0,width:(a,l)=>l.viewport?l.viewport.width:i?i.width:1,height:(a,l)=>l.viewport?l.viewport.height:i?i.height:1};n.viewport=o,this.shader=new Ye({vert:gp,frag:Xv,uniforms:e,extraCommandProps:n});let s=n;if(this.layer.getRenderer().isEnableWorkAround("win-intel-gpu-crash")&&(s=jn({},n),s.stencil=jn({},n.stencil),s.stencil.enable=!0,s.stencil.func.cmp="<",s.stencil.func.ref=(a,l)=>2*l.level+(l.isHalo||0)+1),this.jr=new Ye({vert:xP,frag:Xv,uniforms:e,extraCommandProps:s}),this.pickingFBO){const a=new Pi(this.renderer,{vert:`#define PICKING_MODE 1
`+gp,uniforms:e,extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap());a.filter=h=>{const u=h.properties.symbolIndex;return this.getSymbol(u).textPlacement!=="line"};const l=new Pi(this.renderer,{vert:`#define PICKING_MODE 1
`+xP,uniforms:e,extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap());l.filter=h=>h.geometry.properties.textPlacement==="line",this.picking=[a,l]}}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin,i=this.layer.getTileSize().width,o=n?Xj:t.projViewMatrix,s=t.cameraToCenterDistance,a=Pe(Uj,t.width,t.height);n&&Pe(a,i,i);const l=Vl(t.getResolution(),t);return{layerScale:this.layer.options.styleScale||1,mapPitch:t.getPitch()*Math.PI/180,mapRotation:t.getBearing()*Math.PI/180,projViewMatrix:o,viewMatrix:t.viewMatrix,cameraToCenterDistance:s,canvasSize:a,glyphSize:dp,gammaScale:1*(this.layer.options.textGamma||1),resolution:t.getResolution(),altitudeScale:l,viewport:n&&e&&e.viewport,textPitchFilter:0,isRenderingTerrain:+!!n}}}function Qv(r,t,e,n){for(let i=e;i<n;i+=6){const o=t[i];for(let s=0;s<4;s++){const a=3*(o+s);(r[a]||r[a+1]||r[a+2])&&(r.dirty=!0,r[a]=0,r[a+1]=0,r[a+2]=0)}}}function Yj(r,t){const e=r.properties.level-t.properties.level;return e===0?r.properties.meshKey-t.properties.meshKey:e}var PP=`#define SHADER_NAME NATIVE_POINT
#include <gl2_vert>
#ifdef HAS_ALTITUDE
attribute vec2 aPosition;
attribute float aAltitude;
#else
attribute vec3 aPosition;
#endif
#ifdef HAS_COLOR
attribute vec4 aColor;
varying vec4 vColor;
#endif
uniform mat4 positionMatrix;
uniform mat4 projViewModelMatrix;
uniform float markerSize;
#ifdef PICKING_MODE
#include <fbo_picking_vert>
#endif
#include <vt_position_vert>
void main() {
  vec3 c = unpackVTPosition();
  gl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);
  gl_PointSize = markerSize;
#ifdef HAS_COLOR
vColor = aColor / 255.;
#endif
#ifdef PICKING_MODE
fbo_picking_setData(gl_Position.w, true);
#endif
}`;const qj={markerFill:[0,0,0],markerOpacity:1,markerSize:10};class Jj extends _s{getPrimitive(){return"points"}isTerrainSkin(){return!1}isTerrainVector(){return this.layer.options.awareOfTerrain}isUniqueStencilRefPerTile(){return!1}createMesh(t,e){const{geometry:n,symbolIndex:i,ref:o}=t,s=this.getSymbol(i);o===void 0&&(Vo(n,this.getSymbolDef(i),this.getFnTypeConfig(i)),n.generateBuffers(this.regl));const a={};ue(a,"markerOpacity",s,"markerOpacity",1),ue(a,"markerSize",s,"markerSize",10),ue(a,"markerFill",s,"markerFill","#000",xi(this.colorCache,3));const l=new Gr(a,qj);l.createDefines=()=>s.markerType!=="square"?{USE_CIRCLE:1}:null,l.appendDefines=c=>(s.markerType!=="square"&&(c.USE_CIRCLE=1),c);const h=new nn(n,l,{castShadow:!1,picking:!0}),u={};return h.geometry.data.aAltitude&&(u.HAS_ALTITUDE=1),n.data.aColor&&(u.HAS_COLOR=1),h.setDefines(u),h.positionMatrix=this.getAltitudeOffsetMatrix(),h.setLocalTransform(e),h.properties.symbolIndex=i,h}createFnTypeConfig(t,e){const n=cn(e.markerFill);return[{attrName:"aColor",symbolName:"markerFill",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(i,o)=>{let s=n(t.getZoom(),i);return Ft(s)&&(s=this.evaluateInFnTypeConfig(s,o,t,i,!0)),Array.isArray(s)||(s=this.colorCache[s]=this.colorCache[s]||Wi(s).unitArray()),s=fa(s),s}}]}init(){const t=this.regl;this.renderer=new un(t);const e=[],n={vert:PP,frag:`#define SHADER_NAME NATIVE_POINT
precision mediump float;
#include <gl2_frag>
#ifdef USE_CIRCLE
#if __VERSION__ == 100
#ifdef GL_OES_standard_derivatives
#define STANDARD_DERIVATIVES_ENABLED 1
#extension GL_OES_standard_derivatives : enable
#endif
#else
#define STANDARD_DERIVATIVES_ENABLED 1
#endif
#endif
#ifdef HAS_COLOR
varying vec4 vColor;
#else
uniform vec3 markerFill;
#endif
uniform float markerOpacity;
uniform float layerOpacity;
void main() {
  float c = 1.;
#ifdef USE_CIRCLE
float r = .0, d = .0;
  vec2 e = 2. * gl_PointCoord - 1.;
  r = dot(e, e);
  if(r > 1.) {
    discard;
  }
#ifdef STANDARD_DERIVATIVES_ENABLED
d = fwidth(r);
  c = 1. - smoothstep(1. - d, 1. + d, r);
#endif
#endif
#ifdef HAS_COLOR
vec4 f = vColor;
#else
vec4 f = vec4(markerFill, 1.);
#endif
glFragColor = f * markerOpacity * c * layerOpacity;
#if __VERSION__ == 100
gl_FragColor = glFragColor;
#endif
}`,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(i,o){return qt(e,o.projViewMatrix,o.modelMatrix),e}}],defines:null,extraCommandProps:{viewport:{x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},depth:{enable:!0,mask:!1,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"always"},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"}}};if(this.shader=new Ye(n),this.shader.version=300,this.pickingFBO){const i=[];this.picking=[new Pi(this.renderer,{vert:`#define PICKING_MODE 1
`+PP,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(o,s){return qt(i,s.projViewMatrix,s.modelMatrix),i}}],extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap())]}}getUniformValues(t){return{projViewMatrix:t.projViewMatrix}}}var EP=`#define SHADER_NAME NATIVE_LINE
#ifdef HAS_ALTITUDE
attribute vec2 aPosition;
attribute float aAltitude;
#else
attribute vec3 aPosition;
#endif
uniform mat4 projViewModelMatrix;
#ifndef PICKING_MODE
#if defined(HAS_COLOR)
attribute vec4 aColor;
varying vec4 vColor;
#endif
#else
#include <fbo_picking_vert>
#endif
#include <vt_position_vert>
void main() {
  vec3 c = unpackVTPosition();
  gl_Position = projViewModelMatrix * vec4(c, 1.);
#ifndef PICKING_MODE
#if defined(HAS_COLOR)
vColor = aColor / 255.;
#endif
#else
fbo_picking_setData(gl_Position.w, true);
#endif
}`;const Kj=mn([]);class Qj extends _s{constructor(t,e,n,i,o,s){if(super(t,e,n,i,o,s),this.primitive="lines",Ft(this.symbolDef.lineColor)){const a=e.getMap(),l=cn(this.symbolDef.lineColor);this.colorSymbol=h=>l(a.getZoom(),h)}}needPolygonOffset(){return!0}createMesh(t,e){const{geometry:n,symbolIndex:i,ref:o}=t,s=this.getSymbol(i),a=this.getMeshUniforms(n,s);o===void 0&&n.generateBuffers(this.regl);const l=new Gr(a),h=new nn(n,l,{castShadow:!1,picking:!0});h.setLocalTransform(e),h.properties.symbolIndex=i;const u={};return h.geometry.data.aAltitude&&(u.HAS_ALTITUDE=1),h.setDefines(u),h}getMeshUniforms(t,e){const n={};return ue(n,"lineColor",e,"lineColor","#000",xi(this.colorCache)),ue(n,"lineOpacity",e,"lineOpacity",1),n}isEnableTileStencil(t){return!(t&&t.isRenderingTerrain&&this.isTerrainSkin())}init(t){const e=this.regl;this.renderer=new un(e);const n=this.canvas,i={x:(l,h)=>h.viewport?h.viewport.x:0,y:(l,h)=>h.viewport?h.viewport.y:0,width:(l,h)=>h.viewport?h.viewport.width:n?n.width:1,height:(l,h)=>h.viewport?h.viewport.height:n?n.height:1},o=[{name:"projViewModelMatrix",type:"function",fn:function(l,h){const u=[];return qt(u,h.projViewMatrix,h.modelMatrix),u}}],s=this.sceneConfig.depthRange,a={vert:EP,frag:`#define SHADER_NAME NATIVE_LINE
precision mediump float;
uniform float lineOpacity;
uniform vec4 lineColor;
uniform float layerOpacity;
#if defined(HAS_COLOR)
varying vec4 vColor;
#endif
void main() {
  gl_FragColor = lineColor * lineOpacity;
#if defined(HAS_COLOR)
gl_FragColor *= vColor;
#endif
gl_FragColor *= layerOpacity;
}`,uniforms:o,defines:null,extraCommandProps:{viewport:i,stencil:{enable:()=>this.isEnableTileStencil(t),mask:255,func:{cmp:()=>this.isOnly2D()?"=":"<=",ref:(l,h)=>h.stencilRef,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:s||[0,1],func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}};this.shader=new Ye(a),this.pickingFBO&&(this.picking=[new Pi(this.renderer,{vert:`#define PICKING_MODE 1
`+EP,uniforms:o,extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap())])}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin;return{projViewMatrix:n?Kj:t.projViewMatrix,viewport:n&&e&&e.viewport}}getPrimitive(){return"lines"}}const vp=[1,1,1],t1=[1,1,1,1],OP=[0,0],tV=[1,1],eV=[],kP=new at(0,0),e1=new at(0,0),nV=[],rV=[];class IP extends kv{supportRenderMode(t){return this.isAnimating()?t==="fxaa"||t==="fxaaAfterTaa":t==="taa"||t==="fxaa"}isTerrainSkin(){return!1}isTerrainVector(){return this.layer.options.awareOfTerrain}isAnimating(){return!1}createMesh(t,e,{tilePoint:n}){if(!this.material)return this.setToRedraw(),null;const{geometry:i,symbolIndex:o}=t,s=this.layer instanceof En,a=new nn(i,this.material);if(this.sceneConfig.animation){vp[2]=.01;const w=[];Ws(w,vp),qt(w,e,w),e=w}const l=this.getSymbolDef(o),h=this.getFnTypeConfig(o);Vo(i,l,h);const u=this.getShader(),c=u.getGeometryDefines?u.getGeometryDefines(i):{},f=this.getSymbol(o),d=xi(this.colorCache);if(i.data.aExtrude){c.IS_LINE_EXTRUSION=1;const{tileResolution:w,tileRatio:b}=i.properties,A=this.getMap();Object.defineProperty(a.uniforms,"linePixelScale",{enumerable:!0,get:function(){return b*A.getResolution()/w}}),ue(a.uniforms,"lineWidth",f,"lineWidth",4),ue(a.uniforms,"lineOpacity",f,"lineOpacity",1),ue(a.uniforms,"lineColor",f,"lineColor","#fff",d),Object.defineProperty(a.uniforms,"lineHeight",{enumerable:!0,get:()=>{const T=this.dataConfig.defaultAltitude*(this.dataConfig.altitudeScale||1);return _v(T)?T:0}})}else{ue(a.uniforms,"polygonFill",f,"polygonFill",t1,d),ue(a.uniforms,"polygonOpacity",f,"polygonOpacity",1);const w=[];Object.defineProperty(a.uniforms,"vertexColorsOfType",{enumerable:!0,get:()=>{const b=d(f.bottomPolygonFill||t1),A=d(f.topPolygonFill||t1);w[0]=b[0],w[1]=b[1],w[2]=b[2],w[3]=b[3],w[4]=A[0],w[5]=A[1],w[6]=A[2],w[7]=A[3];const T=a.geometry.properties.vertexColors;if(T){let S=8;w.length=8+T.length;for(let M=0;M<T.length;M++)w[S++]=T[M][0],w[S++]=T[M][1],w[S++]=T[M][2],w[S++]=T[M][3]}return w}})}if(i.data.aColor&&(c.HAS_COLOR=1),i.data.aOpacity&&(c.HAS_OPACITY=1),i.data.aLineWidth&&(c.HAS_LINE_WIDTH=1),i.data.aLineHeight&&(c.HAS_LINE_HEIGHT=1),i.data.aTerrainAltitude&&(c.HAS_TERRAIN_ALTITUDE=1),i.data.aVertexColorType){const w=a.geometry.properties.vertexColors;let b=2;w&&(b+=w.length),c.VERTEX_TYPES_COUNT=b}if(i.data.aOpacity){const w=i.data.aOpacity;for(let b=0;b<w.length;b++)if(w[b]<255){i.properties.hasAlpha=!0;break}}c.HAS_MIN_ALTITUDE=1,c.HAS_LAYER_OPACITY=1,i.generateBuffers(this.regl),a.setDefines(c),a.setPositionMatrix(this.getAltitudeOffsetMatrix()),a.setLocalTransform(e),(i.properties.maxAltitude<=0||a.properties.level>=3)&&(a.castShadow=!1),a.setUniform("maxAltitude",a.geometry.properties.maxAltitude),Object.defineProperty(a.uniforms,"minAltitude",{enumerable:!0,get:()=>this.layer.options.altitude||0});const{tileResolution:p}=i.properties,g=this.getMap(),m=this.layer.getRenderer(),y=g.pointAtResToCoord(new W(n),p),x=function(w,b,A,T,S){return w.pointAtResToDistance(b,0,T,A)}(g,1,y,p),v=[];Object.defineProperty(a.uniforms,"uvOrigin",{enumerable:!0,get:()=>this.Xr(v,o,n,p,x,s)}),a.setUniform("uvOffset",[0,0]),Object.defineProperty(a.uniforms,"hasAlpha",{enumerable:!0,get:()=>{const w=this.getSymbol(o);return i.properties.hasAlpha||w.polygonOpacity<1||w.lineOpacity<1||a.material&&(a.material.uniforms.baseColorTexture||a.material.uniforms.emissiveTexture)}});const _=this.layer.getMap().getMaxNativeZoom();return Object.defineProperty(a.uniforms,"stencilRef",{enumerable:!0,get:()=>m.isForeground(a)?0:_-a.properties.tile.z}),a.properties.symbolIndex=o,a}Xr(t,e,n,i,o,s){if(this.dataConfig.topUVMode===1)return t[0]=0,t[1]=0,t;const a=this.getMap(),l=this.getSymbol(e).material;let h=n;!this.dataConfig.side&&l&&l.textureOrigin&&(kP.set(l.textureOrigin[0],l.textureOrigin[1]),a.coordToPointAtRes(kP,i,e1),h=Pe(nV,n[0]-e1.x,n[1]-e1.y));const u=!!l&&l.uvOffsetInMeter;let c=l&&l.uvOffset||OP;const f=this.getUVOffsetAnim();f&&(c=this.getUVOffset(f));const d=l&&l.uvScale||tV;let p=this.dataConfig.side?0:h[0],g=this.dataConfig.side?0:h[1];const m=l&&l.textureWidth||mC,y=m*d[1]/d[0];u&&(p+=c[0]/o,g+=c[1]/o);const x=u?0:c[0],v=u?0:c[1],_=Pe(t,p*o*d[0]/m+x,g*o*d[1]/y+v);return s||(_[1]*=-1),_}callShader(t,e){const n=this.sceneConfig.cullFace;this.sceneConfig.cullFace="front",this.callBackgroundTileShader(t,e),n===void 0?delete this.sceneConfig.cullFace:this.sceneConfig.cullFace=n,super.callShader(t,e)}getShadowMeshes(){if(!this.isVisible())return eV;this.shadowCount=this.scene.getMeshes().length;const t=this.scene.getMeshes().filter(e=>e.properties.level===0);for(let e=0;e<t.length;e++){const n=t[e];n.material!==this.material&&n.setMaterial(this.material)}return t}getUVOffsetAnim(){const t=this.getSymbols()[0];return t.material&&t.material.uvOffsetAnim}getUVOffset(t){const e=this.getSymbols()[0],n=e.material&&e.material.uvOffset||OP,i=!!e.material&&e.material.uvOffsetInMeter,o=performance.now()/1e3,s=Pe(rV,n[0],n[1]);return s[0]=o*t[0],s[1]=o*t[0],i||(s[0]%=1,s[1]%=1),s}needPolygonOffset(){return this.$r}startFrame(...t){return delete this.$r,super.startFrame(...t)}addMesh(t,e){t.forEach(n=>{this.ni(n,e)}),super.addMesh(...arguments)}ni(t,e){if(e!==null){const n=t.localTransform;e===0&&(e=.01),vp[2]=e,Ws(n,vp),qt(n,t.properties.tileTransform,n),t.setLocalTransform(n)}else t.setLocalTransform(t.properties.tileTransform);t.material!==this.material&&t.setMaterial(this.material),t.geometry.properties.maxAltitude<=0&&(this.$r=!0),this.getSymbol(t.properties.symbolIndex).ssr?t.ssr=1:t.ssr=0}deleteMaterial(){this.material&&(this.material.dispose(),delete this.material)}deleteMesh(t,e){if(t)if(this.scene.removeMesh(t),Array.isArray(t))for(let n=0;n<t.length;n++)e||(t[n].geometry.dispose(),delete t[n].geometry.properties.layer),t[n].dispose();else e||(t.geometry.dispose(),delete t.geometry.properties.layer),t.dispose()}updateDataConfig(t,e){return!(this.dataConfig.type==="line-extrusion"&&!t.altitudeProperty&&!e.altitudeProperty)}createFnTypeConfig(t,e){const n=cn(e.polygonFill||e.lineColor),i=le(e.polygonOpacity||e.lineOpacity),o=le(e.lineWidth),s=new Uint8Array(1),a=new Uint16Array(1),l=e.polygonFill?"polygonFill":e.lineColor?"lineColor":"polygonFill",h=e.polygonOpacity?"polygonOpacity":e.lineOpacity?"lineOpacity":"polygonOpacity";return[{attrName:"aColor",type:Uint8Array,width:4,symbolName:l,define:"HAS_COLOR",evaluate:(u,c)=>{let f=n(t.getZoom(),u);return Ft(f)&&(f=this.evaluateInFnTypeConfig(f,c,t,u,!0)),Array.isArray(f)||(f=this.colorCache[f]=this.colorCache[f]||Wi(f).unitArray()),f=fa(f),f}},{attrName:"aOpacity",type:Uint8Array,width:1,symbolName:h,evaluate:(u,c)=>{let f=i(t.getZoom(),u);return Ft(f)&&(f=this.evaluateInFnTypeConfig(f,c,t,u,!1)),s[0]=255*f,s[0]<255&&(c.properties.hasAlpha=!0),s[0]}},{attrName:"aLineWidth",type:Uint8Array,width:1,symbolName:"lineWidth",define:"HAS_LINE_WIDTH",evaluate:u=>{const c=o(t.getZoom(),u);return a[0]=Math.round(2*c),a[0]}}]}updateSymbol(t,e){let n=!1;t&&t.material&&(n=function(o,s){for(const a in s)if(iV[a]&&s[a]!==o[a]&&(!o[a]||!s[a]))return!0;return!1}(this.symbolDef[0].material||{},t.material));const i=super.updateSymbol(t,e);return t&&t.material&&this.qr(t.material),n||i}zn(t,e){return RP(t)!==RP(e)}}function RP(r){if(!r||!r.material)return!1;for(const t in r.material)if(t.indexOf("Texture")>0&&r.material[t])return!0;return!1}const iV={normalTexture:1,bumpTexture:1};class DP extends IP{createGeometry(t){const e=t.data,n=this.getSymbols()[0];if(n.material&&n.material.extrusionOpacity){const o=new Uint8Array(e.aPosition.length/3);for(let s=0;s<e.aPosition.length;s+=3)e.aPosition[s+2]>0?o[s/3]=0:o[s/3]=1;e.aExtrusionOpacity=o}const i=new ar(e,t.indices);return jn(i.properties,t.properties),this.Bn(i,t),{geometry:i,symbolIndex:{index:0}}}updateSceneConfig(t){let e;if(this.sceneConfig.cullFace!==t.cullFace&&(e=!0),jn(this.sceneConfig,t),e){const n=this.getShaderConfig();this.shader.dispose(),this.shader=new Qw(n)}this.setToRedraw()}getShader(){return this.shader}delete(t){this.getMap().off("updatelights",this.Kr,this),super.delete(t),this.material.dispose()}init(){this.getMap().on("updatelights",this.Kr,this);const t=this.regl;this.renderer=new un(t);const e=this.getShaderConfig();this.shader=new Qw(e),this.qr();const n={vert:this.getPickingVert(),uniforms:["projViewMatrix","modelMatrix","positionMatrix",{name:"projViewModelMatrix",type:"function",fn:function(i,o){return qt([],o.projViewMatrix,o.modelMatrix)}}],extraCommandProps:{viewport:this.pickingViewport}};this.picking=[new Pi(this.renderer,n,this.layer.getRenderer().pickingFBO,this.getMap())]}Kr(){this.setToRedraw()}getShaderConfig(){const t=this.canvas,e={x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1};return{extraCommandProps:{cull:{enable:()=>this.sceneConfig.cullFace===void 0||!!this.sceneConfig.cullFace,face:()=>{let n=this.sceneConfig.cullFace;return n===!0&&(n="back"),n||"back"}},stencil:{enable:!0,func:{cmp:"<=",ref:(n,i)=>i.level},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},viewport:e,polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}}qr(){this.material&&this.material.dispose();const t=this.layer instanceof En,e=this.getSymbols()[0].material,n={};for(const i in e)Qd(e,i)&&(n[i]=e[i],i==="uvRotation"&&(n[i]=n[i]*Math.PI/180,t||(n[i]*=-1)));this.material=new p0(n)}getUniformValues(t,e){const n=t.viewMatrix,i=t.projMatrix,o=t.cameraPosition,s=this.Jr(),a=jn({viewMatrix:n,projMatrix:i,cameraPosition:o,projViewMatrix:t.projViewMatrix},s);e&&e.jitter?a.halton=e.jitter:a.halton=[0,0];const l=this.layer.getRenderer().canvas;return a.outSize=[l.width,l.height],a}getPickingVert(){return`
            attribute vec3 aPosition;
            uniform mat4 projViewModelMatrix;
            uniform mat4 modelMatrix;
            uniform mat4 positionMatrix;
            //引入fbo picking的vert相关函数
            #include <fbo_picking_vert>
            #include <get_output>
            void main()
            {
                mat4 localPositionMatrix = getPositionMatrix();
                vec4 localPosition = getPosition(aPosition);

                gl_Position = projViewModelMatrix * localPositionMatrix * localPosition;
                //传入gl_Position的depth值
                fbo_picking_setData(gl_Position.w, true);
            }
        `}Jr(){const t=this.getMap().getLightManager(),e=t&&t.getAmbientLight()||{},n=t&&t.getDirectionalLight()||{};return{ambientColor:e.color||[.2,.2,.2],light0_diffuse:[...n.color||[.1,.1,.1],1],lightSpecular:n.specular||[.8,.8,.8],light0_viewDirection:n.direction||[1,1,-1]}}}const xp=[1,1,1];class oV extends kv{createGeometry(t){const{data:e,indices:n}=t,i=new ar(e,n,0,{primitive:"lines"});return i.generateBuffers(this.regl),{geometry:i,symbolIndex:{index:0}}}createMesh(t,e){const{geometry:n}=t,i=new nn(n);if(i.castShadow=!1,this.sceneConfig.animation){xp[2]=.01;const o=[];Ws(o,xp),qt(o,e,o),e=o}return i.setLocalTransform(e),i.properties.symbolIndex={index:0},i}addMesh(t,e){if(!t.length)return this;let n;e!==null?(e===0&&(e=.01),n=t[0].localTransform,xp[2]=e,Ws(n,xp),qt(n,t[0].properties.tileTransform,n)):n=t[0].properties.tileTransform;for(let i=0;i<t.length;i++)t[i].setLocalTransform(n);return this.scene.addMesh(t),this}init(){const t=this.regl;this.scene=new ur,this.renderer=new un(t);const e={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},n={vert:`
    attribute vec3 aPosition;
    attribute vec4 aColor;

    uniform mat4 projViewModelMatrix;
    uniform vec2 outSize;

    varying vec4 vColor;

    void main()
    {
        gl_Position = projViewModelMatrix * vec4(aPosition, 1.0);
        vColor = aColor / 255.0;
    }
`,frag:`
    #ifdef GL_ES
        precision lowp float;
    #endif

    uniform float opacity;

    varying vec4 vColor;

    void main()
    {
        gl_FragColor = vColor * opacity;
    }
`,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(i,o){const s=[];return qt(s,o.projViewMatrix,o.modelMatrix),s}}],extraCommandProps:{stencil:{enable:!0,func:{cmp:"<=",ref:(i,o)=>o.level},op:{fail:"keep",zfail:"keep",zpass:"replace"}},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},viewport:e}};this.shader=new Ye(n)}getUniformValues(t){const e=this.sceneConfig.opacity||.3,n=this.layer.getRenderer().canvas;return{projViewMatrix:t.projViewMatrix,outSize:[n.width,n.height],opacity:e}}}const{getPBRUniforms:sV}=Qn.PBRUtils;class n1 extends IP{constructor(...t){super(...t),this.Zr=new Of(null,this.layer.getURLModifier()),this.scene.sortFunction=this.sortByCommandKey}supportRenderMode(t){return this.getSymbols()[0].ssr?t==="fxaa"||t==="fxaaAfterTaa":super.supportRenderMode(t)}isAnimating(){const t=this.Qr();if(t&&(t[0]||t[1]))return!0}needToRedraw(){const t=this.Qr();return!(!t||!t[0]&&!t[1])||super.needToRedraw()}Qr(){const t=this.getSymbols()[0];return t.material&&t.material.uvOffsetAnim}createGeometry(t){if(!t.data||!t.data.aPosition||!t.data.aPosition.length)return null;const e={uv0Attribute:"aTexCoord0"};t.aAltitude&&(e.altitudeAttribute="aAltitude");const n=new ar(t.data,t.indices,0,e);return jn(n.properties,t.properties),t.vertexColors&&(n.properties.vertexColors=t.vertexColors),this.material.uniforms.normalTexture&&!n.data[n.desc.tangentAttribute]&&n.data[n.desc.uv0Attribute]&&(n.data[n.desc.normalAttribute]||n.createNormal(),n.createTangent()),this.Bn(n,t),{geometry:n,symbolIndex:{index:0}}}paint(t){const e=!!t.shadow;t.states&&t.states.includesChanged&&(this.shader.dispose(),delete this.shader,this.ts.dispose(),delete this.ts,this.Qn(t));let n=!!t.ssr&&this.getSymbols()[0].ssr;const i=this.shader,o=i.shaderDefines;if(n){const s=jn({},o,t.ssr.defines);i.shaderDefines=s}if(t.onlyUpdateDepthInTaa&&(this.shader=this.ts,!n&&this.es&&(this.shader=i,this.setToRedraw(!0))),this.updateIBLDefines(i),super.paint(t),this.shadowCount!==void 0&&e){const s=this.scene.getMeshes().length;this.shadowCount!==s&&this.setToRedraw()}this.shader=i,n&&(i.shaderDefines=o),delete this.shadowCount,this.es=n}updateSceneConfig(t){jn(this.sceneConfig,t),this.setToRedraw()}delete(){super.delete(),this.disposeIBLTextures(),this.material.dispose(),this.ts&&(this.ts.dispose(),delete this.ts)}init(t){this.getMap().on("updatelights",this.ns,this),this.createIBLTextures(),this.ii=this.ii||t;const e=this.regl;this.renderer=new un(e),this.rs=this.ss.bind(this),this.os=this.disposeCachedTexture.bind(this),this.ls=this.hs.bind(this),this.qr(),this.Qn(t);const n={vert:`
                #include <gl2_vert>
                attribute vec3 aPosition;
                uniform mat4 projViewModelMatrix;
                uniform mat4 positionMatrix;
                //引入fbo picking的vert相关函数
                #include <line_extrusion_vert>
                #include <get_output>
                #include <fbo_picking_vert>
                void main() {
                    mat4 localPositionMatrix = getPositionMatrix();
                    #ifdef IS_LINE_EXTRUSION
                        vec3 linePosition = getLineExtrudePosition(aPosition);
                        vec4 localVertex = getPosition(linePosition);
                    #else
                        vec4 localVertex = getPosition(aPosition);
                    #endif

                    gl_Position = projViewModelMatrix * localPositionMatrix * localVertex;
                    fbo_picking_setData(gl_Position.w, true);
                }
            `,uniforms:[{name:"projViewModelMatrix",type:"function",fn:(i,o)=>qt([],o.projViewMatrix,o.modelMatrix)}],extraCommandProps:{viewport:this.pickingViewport,depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<=",mask:!!wn(this.sceneConfig.depthMask)||this.sceneConfig.depthMask}}};this.picking=[new Pi(this.renderer,n,this.layer.getRenderer().pickingFBO,this.getMap())]}Qn(t){const e={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},n={},i=[];i.push(...Lf.getUniformDeclares()),this.fillIncludes(n,i,t);const o={cull:{enable:()=>this.sceneConfig.cullFace===void 0||!!this.sceneConfig.cullFace,face:()=>this.sceneConfig.cullFace||"back"},stencil:{enable:(a,l)=>l.hasAlpha===void 0||!!l.hasAlpha,func:{cmp:"<=",ref:(a,l)=>l.stencilRef},op:{fail:"keep",zfail:"keep",zpass:"replace"}},viewport:e,depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<="},blend:{enable:(a,l)=>l.hasAlpha===void 0||!!l.hasAlpha,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}},s={uniforms:i,defines:this.us(n),extraCommandProps:o};this.shader=new Qn.StandardShader(s),s.frag=`
            precision mediump float;
            #include <gl2_frag>
            void main() {
                glFragColor = vec4(0.0);
                #if __VERSION__ == 100
                    gl_FragColor = glFragColor;
                #endif
            }
        `,this.ts=new Qn.StandardShader(s)}ss({resources:t}){for(let e=0;e<t.length;e++)this.addCachedTexture(t[e].url,t[e].data);this.setToRedraw(!0)}hs(){this.setToRedraw(!0)}qr(t){if(t){const a=this.getSymbols()[0].material;a&&jn(a,t)}const e=this.layer instanceof En,n=this.dataConfig,i=t||this.getSymbols()[0].material,o={};let s=!1;for(const a in i)if(Qd(i,a))if(a.indexOf("Texture")>0){let l=i[a];if(!l){o[a]=void 0;continue}const h=typeof l=="string"?l:l.url,u=this.getCachedTexture(h);u?u.then?h===l?l={promise:u,wrap:"repeat"}:l.promise=u:h===l?l={data:u,wrap:"repeat"}:l.data=u:h===l&&(l={url:h,wrap:"repeat"}),l.flipY=!n.upsideUpTexture,l.min="linear mipmap linear",l.mag="linear",o[a]=new If(l,this.Zr),o[a].once("complete",this.rs),o[a].once("disposed",this.os),o[a].promise&&this.addCachedTexture(h,o[a].promise),s=!0}else o[a]=i[a],a==="uvRotation"&&(o[a]=Math.PI*o[a]/180,e||(o[a]*=-1));if(o.alphaTest===void 0&&this.getMaterialClazz&&(o.alphaTest=.05),this.material){for(let a in o)this.material.set(a,o[a]);this.setToRedraw(!0)}else this.material=new Qn.StandardMaterial(o),this.material.once("complete",this.ls);s||this.hs()}getShader(){return this.shader}getUniformValues(t,e){const{iblTexes:n,dfgLUT:i}=this.getIBLRes(),o=sV(t,n,i,e&&e.ssr,e&&e.jitter);return this.setIncludeUniformValues(o,e),o}us(t){return this.hasIBL()?t.HAS_IBL_LIGHTING=1:delete t.HAS_IBL_LIGHTING,t}ns(){if(!this.shader)return;const t=this.shader.shaderDefines;this.us(t),this.shader.shaderDefines=t}}var FP=`#include <gl2_vert>
#define EXTRUDE_SCALE 63.0
#define EXTRUDE_MOD 64.0
#define MAX_LINE_DISTANCE 65535.0
uniform mat4 projViewModelMatrix;
uniform vec2 centiMeterToLocal;
#ifdef HAS_ALTITUDE
attribute vec2 aPosition;
attribute float aAltitude;
#else
attribute vec3 aPosition;
#endif
attribute vec4 aTubeNormal;
#ifdef HAS_LINE_WIDTH
attribute float aLineWidth;
#else
uniform float lineWidth;
#endif
#include <vt_position_vert>
#ifdef PICKING_MODE
#include <fbo_picking_vert>
#else
uniform mat4 modelViewMatrix;
uniform mat3 modelNormalMatrix;
uniform mat4 modelMatrix;
#if defined(HAS_PATTERN)
uniform float resolution;
uniform float tileResolution;
uniform float tileRatio;
attribute float aLinesofar;
varying highp float vLinesofar;
attribute vec4 aTexInfo;
varying vec4 vTexInfo;
varying float vNormalY;
varying float vPatternHeight;
attribute float aNormalDistance;
#if defined(HAS_PATTERN_ANIM)
attribute float aLinePatternAnimSpeed;
varying float vLinePatternAnimSpeed;
#endif
#if defined(HAS_PATTERN_GAP)
attribute float aLinePatternGap;
varying float vLinePatternGap;
#endif
#endif
#ifdef HAS_COLOR
attribute vec4 aColor;
varying vec4 vColor;
#endif
#ifdef HAS_OPACITY
attribute float aOpacity;
#endif
varying float vOpacity;
varying vec3 vModelNormal;
varying vec4 vViewVertex;
varying vec3 vModelVertex;
#endif
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
#include <vsm_shadow_vert>
#endif
#include <highlight_vert>
void main() {
  
#ifdef HAS_LINE_WIDTH
float c = aLineWidth;
#else
float c = lineWidth;
#endif
float d = c / 2.;
  vec3 e = aTubeNormal.xyz / EXTRUDE_SCALE;
  vec3 f = unpackVTPosition();
  vec4 h = vec4(f, 1.);
  h.xy += e.xy * d * centiMeterToLocal;
  h.z += e.z * d;
  gl_Position = projViewModelMatrix * h;
#ifdef PICKING_MODE
fbo_picking_setData(gl_Position.w, true);
#else
vViewVertex = modelViewMatrix * h;
  vec3 i = normalize(e);
  vModelNormal = modelNormalMatrix * i;
  vModelVertex = (modelMatrix * h).xyz;
#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)
shadow_computeShadowPars(h);
#endif
#ifdef HAS_COLOR
vColor = aColor / 255.;
#endif
#ifdef HAS_OPACITY
vOpacity = aOpacity / 255.;
#else
vOpacity = 1.;
#endif
#ifdef HAS_PATTERN
float j = tileResolution / resolution;
  float k = aLinesofar - d * centiMeterToLocal.y * aNormalDistance / EXTRUDE_SCALE;
  vLinesofar = k / tileRatio * j;
  vTexInfo = vec4(aTexInfo.xy, aTexInfo.zw + 1.);
  vPatternHeight = c * centiMeterToLocal.x / tileRatio * j;
  vNormalY = aTubeNormal.w / EXTRUDE_SCALE;
#if defined(HAS_PATTERN_ANIM)
vLinePatternAnimSpeed = aLinePatternAnimSpeed / 127.;
#endif
#if defined(HAS_PATTERN_GAP)
vLinePatternGap = aLinePatternGap / 10.0;
#endif
#endif
highlight_setVarying();
#endif
}`;const{getPBRUniforms:aV}=Qn.PBRUtils;class LP extends _s{needToRedraw(){return super.needToRedraw()||this.isAnimating()}isTerrainSkin(){return!1}isTerrainVector(){return!0}isUniqueStencilRefPerTile(){return!1}supportRenderMode(t){return this.isAnimating()?t==="fxaa"||t==="fxaaAfterTaa":t==="taa"||t==="fxaa"}isAnimating(){if(this.ti)return!0;const t=this.getSymbols();for(let e=0;e<t.length;e++)if(t[e].linePatternFile&&t[e].linePatternAnimSpeed)return!0;return!1}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex).lineBloom}createMesh(t,e){if(!t.geometry)return null;const n=this.getMap(),{geometry:i,symbolIndex:o,ref:s}=t,a=this.getSymbolDef(o);s===void 0&&Vo(i,a,this.getFnTypeConfig(o));const l=this.getSymbol(o),{tileResolution:h,tileRatio:u}=i.properties,c={tileResolution:h,tileRatio:u};ue(c,"lineColor",l,"lineColor","#fff",xi(this.colorCache)),ue(c,"linePatternGapColor",l,"linePatternGapColor",[1,1,1,1],xi(this.colorCache)),ue(c,"lineWidth",l,"lineWidth",2,v=>Ml.getTubeSizeScale(this.dataConfig.metric)*v),ue(c,"lineOpacity",l,"lineOpacity",1),ue(c,"linePatternAnimSpeed",l,"linePatternAnimSpeed",0),ue(c,"linePatternGap",l,"linePatternGap",0),ue(c,"metallicFactor",l,"metallicFactor",0),ue(c,"roughnessFactor",l,"roughnessFactor",.4),ue(c,"emissiveFactor",l,"emissiveFactor",[0,0,0]),ue(c,"uvScale",l,"uvScale",[1,1]);const f=i.properties.iconAtlas,d=this.layer instanceof En;f&&(c.linePatternFile=Ku(this.regl,f,!1),c.atlasSize=f?[f.width,f.height]:[0,0],c.flipY=d?-1:1,this.drawDebugAtlas(f)),s===void 0&&i.generateBuffers(this.regl),c.alphaTest=-1;const p=new Qn.StandardMaterial(c),g=new nn(i,p,{castShadow:!1,picking:!0}),m=n.distanceToPointAtRes(100,100,i.properties.tileResolution)._multi(u/1e4).toArray();g.setUniform("centiMeterToLocal",m);const y=n.getResolution(n.getMaxNativeZoom());g.setUniform("animSpeedScale",h/y),g.setLocalTransform(e);const x={IS_LINE_EXTRUSION:1,HAS_LAYER_OPACITY:1};return this.dataConfig.type==="square-tube"&&(x.IS_SQUARE_TUBE=1),f&&(x.HAS_PATTERN=1),g.properties.symbolIndex=o,i.data.aColor&&(x.HAS_COLOR=1),this.setMeshDefines(x,i,a),i.data.aAltitude&&(x.HAS_ALTITUDE=1),g.setDefines(x),g}setMeshDefines(t,e,n){e.data.aOpacity&&(t.HAS_OPACITY=1),e.data.aLineWidth&&(t.HAS_LINE_WIDTH=1),fo(n.linePatternAnimSpeed)&&(t.HAS_PATTERN_ANIM=1),fo(n.linePatternGap)&&(t.HAS_PATTERN_GAP=1)}paint(t){t.states&&t.states.includesChanged.shadow&&(this.shader.dispose(),this.createShader(t)),super.paint(t)}init(t){this.getMap().on("updatelights",this.ns,this),this.createIBLTextures();const e=this.regl;if(this.renderer=new un(e),this.createShader(t),this.pickingFBO){const n=[];this.picking=[new Pi(this.renderer,{vert:`#define PICKING_MODE 1
`+FP,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(i,o){const s=[];return qt(s,o.projViewMatrix,o.modelMatrix),s}},{name:"modelNormalMatrix",type:"function",fn:(i,o)=>Yh(n,o.modelMatrix)}],extraCommandProps:this.getExtraCommandProps()},this.pickingFBO,this.getMap())]}}createShader(t){this.ii=t;const e=[],n={};this.fillIncludes(n,e,t),e.push({name:"projViewModelMatrix",type:"function",fn:function(i,o){const s=[];return qt(s,o.projViewMatrix,o.modelMatrix),s}}),this.shader=new Qn.StandardShader({vert:FP,uniforms:e,defines:this.us(n),extraCommandProps:this.getExtraCommandProps()})}getExtraCommandProps(){const t=this.canvas,e={x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1},n=this.sceneConfig.depthRange;return{viewport:e,stencil:{enable:!0,func:{cmp:()=>"<=",ref:(i,o)=>o.level},op:{fail:"keep",zfail:"keep",zpass:"replace"}},cull:{enable:()=>!!this.sceneConfig.cullFace,face:this.sceneConfig.cullFace||"back"},depth:{enable:!0,range:n||[0,1],mask:this.sceneConfig.depthMask||!0,func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}getUniformValues(t,e){const{iblTexes:n,dfgLUT:i}=this.getIBLRes(),o=aV(t,n,i,null,e&&e.jitter),s=t.projViewMatrix,a=t.viewMatrix;return o.projViewMatrix=s,o.viewMatrix=a,o.resolution=t.getResolution(),o.currentTime=this.layer.getRenderer().getFrameTimestamp()||0,this.setIncludeUniformValues(o,e),o}createFnTypeConfig(t,e){const n=cn(e.lineColor),i=cn(e.aLinePatternAnimSpeed),o=cn(e.aLinePatternGap),s=this.createShapeFnTypeConfigs(t,e),a=new Int8Array(2);return[{attrName:"aColor",symbolName:"lineColor",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(l,h)=>{let u=n(t.getZoom(),l);return Ft(u)&&(u=this.evaluateInFnTypeConfig(u,h,t,l,!0)),Array.isArray(u)||(u=this.colorCache[u]=this.colorCache[u]||Wi(u).unitArray()),u=fa(u),u}},{attrName:"aLinePattern",symbolName:"linePatternAnimSpeed",type:Int8Array,width:2,related:["linePatternGap"],define:"HAS_LINE_PATTERN",evaluate:(l,h,u,c)=>{let f=i(t.getZoom(),l);return wn(f)&&(f=0),f!==0&&(h.properties.hasPatternAnim=1),a[0]=f/127,a[1]=u[c+1],a}},{attrName:"aLinePattern",symbolName:"linePatternGap",type:Int8Array,width:2,related:["linePatternAnimSpeed"],define:"HAS_LINE_PATTERN",evaluate:(l,h,u,c)=>{let f=o(t.getZoom(),l);return wn(f)&&(f=0),a[1]=10*f,a[0]=u[c],a}}].concat(s)}createShapeFnTypeConfigs(t,e){const n=le(e.lineWidth),i=le(e.lineOpacity),o=new Uint16Array(1);return[{attrName:"aLineWidth",symbolName:"lineWidth",type:Uint8Array,width:1,define:"HAS_LINE_WIDTH",evaluate:(s,a)=>{let l=n(t.getZoom(),s);return Ft(l)&&(l=this.evaluateInFnTypeConfig(l,a,t,s)),o[0]=Math.round(2*l),o[0]}},{attrName:"aOpacity",symbolName:"lineOpacity",type:Uint8Array,width:1,define:"HAS_OPACITY",evaluate:(s,a)=>{let l=i(t.getZoom(),s);return Ft(l)&&(l=this.evaluateInFnTypeConfig(l,a,t,s)),o[0]=255*l,o[0]}}]}us(t){return this.hasIBL()?t.HAS_IBL_LIGHTING=1:delete t.HAS_IBL_LIGHTING,t}ns(){if(!this.shader)return;const t=this.shader.shaderDefines;this.us(t),this.shader.shaderDefines=t}delete(){super.delete(),this.disposeIBLTextures(),this.shader&&(this.shader.dispose(),delete this.shader)}}const _p=[],lV=[],hV=[],uV=[],cV=[],fV=[0,0,0],dV=[0,0,0],pV=[1,1,1],zP=[],gV=[1,1,1,1],Ms=[],HP=[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1],NP=r=>class extends r{constructor(t,e,n,i,o,s){super(t,e,n,i,o,s),this.cs=!1,this.scene.sortFunction=this.sortByCommandKey;const a=i.fetchOptions||{};a.referrer=window&&window.location.href,this.fs=new fF(t,{fetchOptions:a,urlModifier:l=>{const h=e.getURLModifier();return h&&h(l)||l}}),this.ds(),this.ps()}isUniqueStencilRefPerTile(){return!1}isAnimating(){const t=this.getSymbols();for(let e=0;e<t.length;e++)if(t[e]&&this.ys[e]&&this.gs(e))return!0;return!1}createGeometry(t,e){const{data:n,positionSize:i}=t;return{geometry:{properties:jn({},t.properties),data:n,positionSize:i,features:e},symbolIndex:t.symbolIndex}}getFnTypeConfig(){return zP}createMesh(t,e,{tileTranslationMatrix:n,tileExtent:i},{timestamp:o}){if(!this.cs)return null;const s=this.getMap(),{geometry:a}=t,{positionSize:l,features:h}=a,{aPosition:u,aPickingId:c,aXYRotation:f,aZRotation:d,aAltitude:p}=a.data,g=u.length/l;if(g===0)return null;const m={instance_vectorA:new Float32Array(4*g),instance_vectorB:new Float32Array(4*g),instance_vectorC:new Float32Array(4*g),aPickingId:[]},y=this.xs(m,n,i,a.properties.z,u,p,f,d,l,c,h);a.data.aTerrainAltitude&&(m.aTerrainAltitude=a.data.aTerrainAltitude);const x={};for(const T in m)x[T]={buffer:this.regl.buffer({dimension:m[T].length/g,data:m[T]}),divisor:1};const v=this.vs(),_=this.bs(),w=mn([]);so(w,w,[_,_,_]);const b=[],A=this.getSymbols();for(let T=0;T<A.length;T++){const S=A[T],M=this.As[T];if(!M)continue;const E=this.ys[T][0],{fixSizeOnZoom:P}=S;let k=mn([]);v||(k=this.ws(k));let O=0;M.forEach(z=>{const{geometry:L,nodeMatrix:$}=z;qt(Ms,HP,$),qt(Ms,k,Ms);const Z=qt(Ms,w,Ms),j=L.boundingBox.copy();j.transform(Z);const st=this._s(j,S);Math.abs(st)>Math.abs(O)&&(O=st)});const I=[0,0,O],D=M.map((z,L)=>{const{geometry:$,materialInfo:Z,morphWeights:j,extraInfo:st,nodeIndex:lt}=z;S.alphaTest&&(Z.alphaTest=S.alphaTest);const rt=new(this.getMaterialClazz(Z))(Z),Rt={},Ht=new Zw(x,g,$,rt,{transparent:!1,picking:!0});if(E.hasSkinAnimation()){const Ct=this.Ss(Ht,T,0)[lt];Ht.setUniform("jointTexture",Ct.jointTexture),Ht.setUniform("jointTextureSize",Ct.jointTextureSize),Ht.setUniform("numJoints",Ct.numJoints),Ht.setUniform("skinAnimation",+this.gs(T)),Ht.properties.startTime=o,Rt.HAS_SKIN=1}j&&(Ht.setUniform("morphWeights",j),Rt.HAS_MORPH=1),Ht.setUniform("hasAlpha",st.alphaMode&&st.alphaMode.toUpperCase()==="BLEND"),ue(Ht.uniforms,"polygonFill",S,"markerFill",gV,xi(this.colorCache)),ue(Ht.uniforms,"polygonOpacity",S,"markerOpacity",1);const ee=[];Ht.setPositionMatrix(()=>{const Ct=this.Ms(T,L,lt);qt(ee,HP,Ct),qt(ee,k,ee),qt(ee,w,ee);const _e=mn(Ms);if(O!==0&&(qh(_e,I),qt(ee,_e,ee)),_v(P)){const Ie=s.getGLScale()/s.getGLScale(P);return ie(_p,Ie,Ie,Ie),Ws(_e,_p),qt(_e,_e,ee)}return ee});const nt=this.layer.getRenderer().getZScale(),Dt=[],Vt=[];return Ht.setLocalTransform(()=>{const Ct=this.layer.options.altitude||0;return Ar(Vt,y),Vt[2]+=100*Ct*nt,oo(Dt,n,Vt),Dt}),$.generateBuffers(this.regl,{excludeElementsInVAO:!0}),m.instance_color&&(Rt.HAS_INSTANCE_COLOR=1),m.aTerrainAltitude&&(Rt.HAS_INSTANCE_TERRAIN_ALTITUDE=1,Ht.setUniform("terrainAltitudeScale",100*this.layer.getRenderer().getZScale())),Rt.HAS_LAYER_OPACITY=1,jn(Ht.properties,a.properties),Ht.setDefines(Rt),Ht.properties.symbolIndex={index:T},Ht});b.push(...D)}return b.insContext={instanceData:m,tileTranslationMatrix:n,tileExtent:i,aPosition:u,positionSize:l},b}Ms(t,e,n){const i=t,o=this.As[i][e];return this.gs(t)&&this.Ts&&this.Ts[n]||o.nodeMatrix}Ss(t,e,n){if(!this.ys)return;const i=this.ys[e][0];this.Ps||(this.Ps={}),this.Ts={},this.Ps[t.uuid]||(this.Ps[t.uuid]={});const o=this.getSymbols()[e],s=this.ks[e],{loop:a,speed:l,animationName:h}=o,u=h||s.animations[0].name;return i.updateAnimation(n,a||!1,l||1,u,t.properties.startTime||0,this.Ts,this.Ps[t.uuid]),this.Ps[t.uuid]}_s(t,e){const n=e.anchorZ||"center";let i=0;const o=t.max[2]-t.min[2];return n==="bottom"?i=o/2:n==="top"&&(i=-o/2),i}addMesh(t,e,n){if(!t||t[0].properties.level>2)return null;const i=n.timestamp;for(let o=0;o<t.length;o++){if(!t[o]||!t[o].geometry)continue;t[o].instancedData.aTerrainAltitude&&this.Mn(t[o],t[o].instancedData,t[o].properties,3,n);const s=t[o].properties.symbolIndex.index,a=this.gs(s);a&&this.Ss(t[o],s,i),t[o].setUniform("skinAnimation",+a)}return this.scene.addMesh(t),this}$n(t,e){t&&t.updateInstancedData&&t.updateInstancedData("aTerrainAltitude",e)}prepareRender(t){const e=this.getSymbols();let n=!1;for(let i=0;i<e.length;i++)if(!(!e[i]||!this.ys[i])&&this.gs(i)&&this.ys[i]&&!n){n=!0;break}n&&this.setToRedraw(!0),super.prepareRender(t)}getShadowMeshes(){return this.isVisible()?(this.shadowCount=this.scene.getMeshes().length,this.scene.getMeshes().filter(t=>t.properties.level===0)):zP}gs(t){const e=this.getSymbols()[t];return!!(e&&e.animation&&this.ys[t]&&this.ys[t][0]&&this.ys[t][0].hasSkinAnimation())}xs(t,e,n,i,o,s,a,l,h,u,c){function f(I,D,z,L){t[I][4*D]=z[L],t[I][4*D+1]=z[L+4],t[I][4*D+2]=z[L+8],t[I][4*D+3]=z[L+12]}const d=o.length/h,p=this.layer.getTileSize().width/n*this.layer.getRenderer().getTileGLScale(i),g=this.layer.getRenderer().getZScale(),m=100*(this.dataConfig.altitudeOffset||0);let y=1/0,x=1/0,v=1/0,_=-1/0,w=-1/0,b=-1/0;const A=[],T=[];for(let I=0;I<d;I++){s?ie(T,o[I*h],o[I*h+1],s[I]):Lr.unpackPosition(T,o[I*h],o[I*h+1],o[I*h+2]);const D=ie(A,T[0]*p,-T[1]*p,(T[2]+m)*g);D[0]<y&&(y=D[0]),D[0]>_&&(_=D[0]),D[1]<x&&(x=D[1]),D[1]>w&&(w=D[1]),D[2]<v&&(v=D[2]),D[2]>b&&(b=D[2])}const S=(y+_)/2,M=(x+w)/2,E=(v+b)/2,P=[],k=this.vs(),O=[0,0,1];for(let I=0;I<d;I++){s?ie(T,o[I*h],o[I*h+1],s[I]):Lr.unpackPosition(T,o[I*h],o[I*h+1],o[I*h+2]);const D=T[0],z=T[1],L=ie(A,D*p-S,-z*p-M,(T[2]+m)*g-E),$=a&&a[I]||0,Z=l&&l[I]||0;if($||Z){GR(P,Z,O);const j=ie(_p,D,z,0),st=Za(j,Ys(j,j,O));VR(P,P,$,st);const lt=qh(Ms,L);qt(P,lt,P)}else qh(P,L);if(k){const j=this.ws(Ms,c,u,I);qt(P,P,j)}f("instance_vectorA",I,P,0),f("instance_vectorB",I,P,1),f("instance_vectorC",I,P,2),t.aPickingId[I]=I}return ie(A,S,M,E),A}bs(){if(!this.Is){const t=this.getMap();this.Is=100*Vl(t.getGLRes(),t)}return this.Is}ws(t,e,n,i){const o=this.getMap(),s=this.symbolDef[0],a=this.bs();let l=s.translationX||0,h=s.translationY||0,u=s.translationZ||0,c=s.rotationX||0,f=s.rotationY||0,d=s.rotationZ||0,p=s.scaleX||1,g=s.scaleY||1,m=s.scaleZ||1;const y=n&&n[i],x=e&&e[y],v=o.getZoom(),_=x&&x.feature&&x.feature.properties,w=this.Os(v,_);this.Cs&&(l=this.Cs(v,_)),this.Fs&&(h=this.Fs(v,_)),this.Es&&(u=this.Es(v,_));const b=ie(lV,l*a,h*a,u*a);this.Ds&&(c=this.Ds(v,_)),this.Ls&&(f=this.Ls(v,_)),this.zs&&(d=this.zs(v,_));const A=ie(hV,c,f,d);this.Rs&&(p=this.Rs(v,_)),this.Hs&&(g=this.Hs(v,_)),this.Ns&&(m=this.Ns(v,_));const T=ie(uV,p*w,g*w,m*w);return this.Vs(t,b,A,T)}Os(t,e){const n=this.symbolDef[0];let i=this.js?this.js(t,e):n.modelHeight;if(er(i))return 1;const o=this.Us[0];return i/Math.abs(o.max[1]-o.min[1])}getShaderConfig(){const t=super.getShaderConfig();return t.positionAttribute="POSITION",t.normalAttribute="NORMAL",t}init(t){super.init(t),this.ps()}ds(){const t=this.symbolDef[0];Ft(t.modelHeight)&&(this.js=le(t.modelHeight)),Ft(t.translationX)&&(this.Cs=le(t.translationX)),Ft(t.translationY)&&(this.Fs=le(t.translationY)),Ft(t.translationZ)&&(this.Es=le(t.translationZ)),Ft(t.rotationX)&&(this.Ds=le(t.rotationX)),Ft(t.rotationY)&&(this.Ls=le(t.rotationY)),Ft(t.rotationZ)&&(this.zs=le(t.rotationZ)),Ft(t.scaleX)&&(this.Rs=le(t.scaleX)),Ft(t.scaleY)&&(this.Hs=le(t.scaleY)),Ft(t.scaleZ)&&(this.Ns=le(t.scaleZ))}vs(){return!!(this.js&&!this.js.isFeatureConstant||this.Cs&&!this.Cs.isFeatureConstant||this.Fs&&!this.Fs.isFeatureConstant||this.Es&&!this.Es.isFeatureConstant||this.Ds&&!this.Ds.isFeatureConstant||this.Ls&&!this.Ls.isFeatureConstant||this.zs&&!this.zs.isFeatureConstant||this.Rs&&!this.Rs.isFeatureConstant||this.Hs&&!this.Hs.isFeatureConstant||this.Ns&&!this.Ns.isFeatureConstant)}ps(){if(this.ys)return;this.ys=[],this.ks=[],this.Us=[],this.As=[];const t=this.getSymbols();this.Gs=0;for(let e=0;e<t.length;e++){const n=t[e].url||"pyramid";this.fs.loginGLTF(n);const i=this.fs.getGLTF(n);if(i.then)i.then(o=>{if(!o.gltfPack)return this.Gs++,void(this.Gs>=t.length&&(this.cs=!0,this.setToRedraw(!0)));const{gltfPack:s,json:a,bbox:l}=o;this.ys[e]=[s],this.As[e]=s.getMeshesInfo(),this.ks[e]=a,this.Us[e]=l,this.Gs++,this.Gs>=t.length&&(this.cs=!0),this.setToRedraw(!0)});else{const{gltfPack:o,json:s,bbox:a}=i;o&&(this.ys[e]=[o],this.As[e]=o.getMeshesInfo(),this.ks[e]=s,this.Us[e]=a,this.Gs++)}}this.Gs>=t.length&&(this.cs=!0)}getPickingVert(){return`
    attribute vec3 aPosition;
    uniform mat4 projViewModelMatrix;
    uniform mat4 modelMatrix;
    uniform mat4 positionMatrix;
    //引入fbo picking的vert相关函数
    #include <fbo_picking_vert>
    #include <get_output>
    void main()
    {
        mat4 localPositionMatrix = getPositionMatrix();
        vec4 localPosition = getPosition(aPosition);

        gl_Position = projViewModelMatrix * localPositionMatrix * localPosition;
        //传入gl_Position的depth值
        fbo_picking_setData(gl_Position.w, true);
    }`}deleteMesh(t){if(t){this.scene.removeMesh(t);for(let e=0;e<t.length;e++){const n=this.Ps&&this.Ps[t[e].uuid];if(n){for(const i in n)n[i].jointTexture&&n[i].jointTexture.destroy();delete this.Ps[t[e].uuid]}t[e].disposeInstancedData(),t[e].dispose()}}}delete(){super.delete();const t=this.getSymbols();for(let e=0;e<t.length;e++){const n=t[e].url||"pyramid";this.fs.logoutGLTF(n)}if(this.Ps){for(const e in this.Ps){const n=this.Ps[e];for(const i in n)n[i].jointTexture&&n[i].jointTexture.destroy()}delete this.Ps}delete this.Ts}Vs(t,e,n,i){const o=ie(_p,...e||fV),s=n||dV,a=i||pV,l=qs(cV,s[0],s[1],s[2]);return $a(t,l,o,a)}};class mV extends NP(DP){getMaterialClazz(t){return t.diffuseFactor?gD:p0}}class yV extends NP(n1){getMaterialClazz(t){return t.specularGlossinessTexture||t.diffuseTexture?Qn.StandardSpecularGlossinessMaterial:Qn.StandardMaterial}}const{getPBRUniforms:vV}=Qn.PBRUtils,BP={color:[2.0303,2.028,2.028],direction:[0,-.2717,-1]},r1=.3737,nc={index:0},xV=[0,0,0],bp=[2,2];class jP extends _s{supportRenderMode(t){return t==="fxaa"||t==="fxaaBeforeTaa"}needPolygonOffset(){return!0}isTerrainSkin(){return!1}isTerrainVector(){return!0}needToRedraw(){return super.needToRedraw()?!0:this.getSymbol(nc).animation}createMesh(t,e){const{geometry:n}=t;n.generateBuffers(this.regl);const i=new nn(n,null,{castShadow:!1,picking:!0});return i.properties.symbolIndex=nc,i.setLocalTransform(e),i}callShader(t,e){super.callShader(t,e),this.transformWater();const n=this.Ws(this.getMap(),e);this.Pn+=this.renderer.render(this.Ys,n,this.Bs,this.getRenderFBO(e))}addMesh(t,e){this.ni(t,e),super.addMesh(...arguments)}ni(t){const e=this.getSymbol(nc).ssr;for(let n=0;n<t.length;n++)t[n].ssr=e?1:0}paint(t){t.states&&t.states.includesChanged&&(this.shader.dispose(),this.Ys.dispose(),this.Qn(t));const e=!!t.ssr&&this.getSymbol(nc).ssr,n=this.Ys,i=n.shaderDefines;if(e){const o=jn({},i,t.ssr.defines);n.shaderDefines=o}this.updateIBLDefines(n),this.Xs.ssr=e?1:0,super.paint(t),e&&(n.shaderDefines=i)}isEnableTileStencil(){return!1}init(t){this.createIBLTextures();const e=this.regl;this.renderer=new un(e),this.createGround(),this.Qn(t),this.pickingFBO&&(this.picking=[new Pi(this.renderer,{vert:QC,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(n,i){const o=[];return qt(o,i.projViewMatrix,i.modelMatrix),o}}],extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap())]),this.$s()}$s(){const t=this.regl;this.qs||(this.qs=t.texture(2));const e=this.layer.getURLModifier(),n=this.getSymbol({index:0}),i=n.texWaveNormal,o=this.getCachedTexture(i),s=this;if(o)this.Ks||(o.isLoading?setTimeout(()=>{this.shader&&this.$s()},20):this.Ks=this.Js(t,o));else{const h=new Image;h.isLoading=!0,h.onload=function(){delete this.isLoading,s.Ks=s.Js(t,this),s.setToRedraw()},h.onerror=()=>{console.error("invalid water wave normal texture:"+i)},this.addCachedTexture(i,h),h.src=e&&e(i)||i}const a=n.texWavePerturbation,l=this.getCachedTexture(a);if(l)this.Zs||(l.isLoading?setTimeout(()=>{this.$s(),this.shader},20):this.Zs=this.Js(t,l));else{const h=new Image;h.isLoading=!0,h.onload=function(){delete this.isLoading,s.Zs=s.Js(t,this),s.setToRedraw()},h.onerror=()=>{console.error("invalid water wave perturbation texture:"+a)},this.addCachedTexture(a,h),h.src=e&&e(a)||a}}Js(t,e){return this.qs?t.texture({width:e.width,height:e.height,mag:"linear",min:"linear mipmap linear",wrapS:"repeat",wrapT:"repeat",flipY:!0,data:e}):null}Qn(t){const e=this.canvas,n=[],i=[{name:"projViewModelMatrix",type:"function",fn:function(h,u){const c=[];return qt(c,u.projViewMatrix,u.modelMatrix),c}},{name:"modelViewNormalMatrix",type:"function",fn:(h,u)=>{const c=qt([],u.viewMatrix,u.modelMatrix),f=$s(c,c),d=$b(f,f);return Yh([],d)}},{name:"modelViewMatrix",type:"function",fn:(h,u)=>qt([],u.viewMatrix,u.modelMatrix)},{name:"environmentTransform",type:"function",fn:(h,u)=>{const c=u.environmentOrientation||0;return Bm(n,Math.PI*c/180)}}],o={TIME_NOISE_TEXTURE_REPEAT:r1};this.fillIncludes(o,i,t);const s={x:0,y:0,width:()=>e?e.width:1,height:()=>e?e.height:1},a=this.sceneConfig.depthRange;this.shader=new Ye({vert:`
                attribute vec3 aPosition;

                uniform mat4 projViewModelMatrix;

                void main() {
                    gl_Position = projViewModelMatrix * vec4(aPosition, 1.);
                }
            `,frag:`
    #define SHADER_NAME WATER_STENCIL
    precision mediump float;
    void main() {
        gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);
    }
`,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(h,u){const c=[];return qt(c,u.projViewMatrix,u.modelMatrix),c}}],extraCommandProps:{viewport:s,colorMask:[!1,!1,!1,!1],stencil:{enable:!0,mask:255,func:{cmp:"<=",ref:254,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:a||[0,1],func:this.sceneConfig.depthFunc||"<="},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}});const l={viewport:s,stencil:{enable:!0,mask:255,func:{cmp:"==",ref:254,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!1}};i.push(...Lf.getUniformDeclares()),this.Ys=new Ye({vert:`#define SHADER_NAME WATER
uniform mat4 modelMatrix;
uniform mat4 projViewModelMatrix;
attribute vec3 aPosition;
attribute vec2 aTexCoord;
uniform vec2 uvOffset;
uniform vec2 noiseUvOffset;
uniform vec2 uvScale;
varying vec2 vUv;
varying vec2 vNoiseUv;
varying vec3 vPos;
varying mat3 vTbnMatrix;
#ifdef HAS_SSR
uniform mat4 modelViewMatrix;
varying vec4 vViewVertex;
#endif
#include <highlight_vert>
mat3 c(in vec3 d) {
  vec3 t = normalize(cross(d, vec3(.0, 1., .0)));
  vec3 e = normalize(cross(d, t));
  return mat3(t, e, d);
}
#if defined(HAS_SHADOWING)
#include <vsm_shadow_vert>
#endif
const vec3 f = vec3(0., 0., 1.);
void main(void) {
  vec4 h = vec4(aPosition, 1.);
  vec4 i = modelMatrix * h;
  vPos = i.xyz;
  vTbnMatrix = c(f);
  gl_Position = projViewModelMatrix * h;
  vUv = aTexCoord * uvScale + uvOffset;
  vNoiseUv = aTexCoord * uvScale * TIME_NOISE_TEXTURE_REPEAT + noiseUvOffset;
#ifdef HAS_SSR
vec4 j = modelViewMatrix * h;
  vViewVertex = j;
#endif
#if defined(HAS_SHADOWING)
shadow_computeShadowPars(h);
#endif
highlight_setVarying();
}`,frag:`#define SHADER_NAME WATER
precision highp float;
precision highp sampler2D;
#include <hsv_frag>
uniform vec3 hsv;
uniform float contrast;
uniform float layerOpacity;
#if defined(HAS_SHADOWING)
#include <vsm_shadow_frag>
#endif
#include <highlight_frag>
#if defined(HAS_IBL_LIGHTING)
uniform vec3 hdrHSV;
uniform samplerCube prefilterMap;
uniform sampler2D brdfLUT;
uniform float rgbmRange;
uniform mat3 environmentTransform;
uniform vec3 diffuseSPH[9];
vec3 c(const in vec3 d) {
  vec3 e = environmentTransform * d;
  float x = e.x;
  float y = e.y;
  float z = e.z;
  vec3 f = (diffuseSPH[0] + diffuseSPH[1] * x + diffuseSPH[2] * y + diffuseSPH[3] * z + diffuseSPH[4] * z * x + diffuseSPH[5] * y * z + diffuseSPH[6] * y * x + diffuseSPH[7] * (3. * z * z - 1.) + diffuseSPH[8] * (x * x - y * y));
  if(length(hdrHSV) > .0) {
    f = hsv_apply(f, hdrHSV);
  }
  return max(f, vec3(.0));
}
vec3 h(const in vec3 i, const in float j, const in float k, const in float l) {
  vec4 rgba = texture2D(brdfLUT, vec2(k, j));
  float b = (rgba[3] * 65280.0 + rgba[2] * 255.);
  float a = (rgba[1] * 65280.0 + rgba[0] * 255.);
  const float m = 1. / 65535.;
  return (i * a + b * l) * m;
}
#else
uniform vec3 ambientColor;
#endif
struct PBRShadingWater {
  float NdotL;
  float NdotV;
  float NdotH;
  float VdotH;
  float LdotH;
  float VdotN;
};
vec3 o(const in vec4 u, const in float v) {
  if(v <= .0)
    return u.rgb;
  return v * u.rgb * u.a;
}
#ifdef HAS_SSR
varying vec4 vViewVertex;
uniform mat3 modelViewNormalMatrix;
uniform sampler2D TextureDepth;
uniform highp vec2 outSize;
uniform float ssrFactor;
uniform float ssrQuality;
uniform sampler2D TextureReflected;
uniform highp mat4 projMatrix;
uniform mat4 invProjMatrix;
uniform vec4 outputFovInfo[2];
uniform mat4 reprojViewProjMatrix;
uniform vec2 cameraNearFar;
float A(const in vec4 B) {
  return B.r + B.g / 255.;
}
float C(const in vec2 D, const in float E) {
  vec3 F = vec3(.06711056, .00583715, 52.9829189);
  return fract(F.z * fract(dot(D.xy + E * vec2(47., 17.) * .695, F.xy))) * .5;
}
vec3 G(const in float H, const in float I, const in vec2 J) {
  float K = min(I - .01, H);
  float L = floor(K);
  float M = min(I, L + 1.);
  float N = pow(2., M);
  vec2 O = 2. * N / J;
  if(K - L > .5)
    N *= 2.;
  return vec3(O, N);
}
vec2 P(const in vec2 Q, const in vec3 R) {
  vec2 S = max(R.xy, min(1. - R.xy, Q));
  return vec2(2. * S.x, R.z - 1. - S.y) / R.z;
}
vec3 T(const in mat4 U, const in vec3 V) {
  vec4 W = U * vec4(V, 1.);
  return vec3(.5 + .5 * W.xy / W.w, W.w);
}
vec3 X(const in float Y, const in vec2 S) {
  return texture2D(TextureReflected, S).rgb;
}
float Z(float ba) {
  highp mat4 U = projMatrix;
  highp float z = ba * 2. - 1.;
  return -U[3].z / (z + U[2].z);
}
float bb(const vec2 S) {
  float ba = A(texture2D(TextureDepth, S));
  return ba;
}
vec3 bc(const in float E, const in vec3 bd, const in vec3 be, const in vec3 bf, const in vec3 bg, const in float bh) {
  vec2 bi;
  bi.x = C(gl_FragCoord.yx, E);
  bi.y = fract(bi.x * 52.9829189);
  bi.y = mix(bi.y, 1., .7);
  float bj = 2. * 3.14159 * bi.x;
  float bk = pow(max(bi.y, .000001), bh / (2. - bh));
  float bl = sqrt(1. - bk * bk);
  vec3 bm = vec3(bl * cos(bj), bl * sin(bj), bk);
  bm = bm.x * bd + bm.y * be + bm.z * bf;
  return normalize((2. * dot(bg, bm)) * bm - bg);
}
float bn(const in float E) {
  return (C(gl_FragCoord.xy, E) - .5);
}
vec3 bo(const in vec3 bp, const in float bq, const in vec3 br) {
  vec3 bs = T(projMatrix, vViewVertex.xyz + br * bq);
  bs.z = 1. / bs.z;
  bs -= bp;
  float bt = min(1., .99 * (1. - bp.x) / max(1e-5, bs.x));
  float bu = min(1., .99 * (1. - bp.y) / max(1e-5, bs.y));
  float bv = min(1., .99 * bp.x / max(1e-5, -bs.x));
  float bw = min(1., .99 * bp.y / max(1e-5, -bs.y));
  return bs * min(bt, bu) * min(bv, bw);
}
float bx(const in vec3 bp, const in vec3 bs, inout float by, inout float bz) {
  float bA = (bz + by) * .5;
  vec3 bB = bp + bs * bA;
  float z = bb(bB.xy);
  float ba = Z(z);
  float bC = -1. / bB.z;
  by = ba > bC ? by : bA;
  bz = ba > bC ? bA : bz;
  return bA;
}
vec4 bD(const in vec3 bp, const in float bq, in float bE, const in vec3 br, const in float j, const in float E) {
  const int bF = 20;
  float bG = 1. / float(bF);
  bE *= bG;
  vec3 bs = bo(bp, bq, br);
  float bH = bG;
  vec3 bI = vec3(.0, bH, 1.);
  vec3 bB;
  float z, ba, bC, bJ, bK, bL;
  bool bM;
  float bN = 1.;
  float bA;
  for(int bO = 0; bO < bF; bO++) {
    bB = bp + bs * bI.y;
    z = bb(bB.xy);
    ba = Z(z);
    bC = -1. / bB.z;
    bJ = bC - ba;
    bJ *= clamp(sign(abs(bJ) - bq * bG * bG), .0, 1.);
    bM = abs(bJ + bE) < bE;
    bK = clamp(bI.x / (bI.x - bJ), .0, 1.);
    bL = bM ? bI.y + bK * bG - bG : 1.;
    bI.z = min(bI.z, bL);
    bI.x = bJ;
    if(bM) {
      float by = bI.y - bG;
      float bz = bI.y;
      bA = bx(bp, bs, by, bz);
      bA = bx(bp, bs, by, bz);
      bA = bx(bp, bs, by, bz);
      bN = bA;
      break;
    }
    bI.y += bG;
  }
  return vec4(bp + bs * bN, 1. - bN);
}
vec3 bP(in vec4 bQ, const in float bR, const in vec3 bS, const in vec3 bT, const in float j) {
  vec4 bU = mix(outputFovInfo[0], outputFovInfo[1], bQ.x);
  bQ.xyz = vec3(mix(bU.xy, bU.zw, bQ.y), 1.) * -1. / bQ.z;
  bQ.xyz = (reprojViewProjMatrix * vec4(bQ.xyz, 1.)).xyw;
  bQ.xy /= bQ.z;
  float bV = clamp(6. - 6. * max(abs(bQ.x), abs(bQ.y)), .0, 1.);
  bQ.xy = .5 + .5 * bQ.xy;
  return vec3(bQ.xy, 1.);
}
vec3 ssr(const in vec3 bS, const in vec3 bT, const in float j, const in vec3 d, const in vec3 bg) {
  float bW = .0;
  vec4 f = vec4(.0);
  float bh = j * j;
  bh = bh * bh;
  vec3 bX = abs(d.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);
  vec3 bd = normalize(cross(bX, d));
  vec3 be = cross(d, bd);
  float bR = ssrFactor * clamp(-4. * dot(bg, d) + 3.8, .0, 1.);
  bR *= clamp(4.7 - j * 5., .0, 1.);
  vec3 bp = T(projMatrix, vViewVertex.xyz);
  bp.z = 1. / bp.z;
  vec3 br = bc(bW, bd, be, d, bg, bh);
  float bq = mix(cameraNearFar.y + vViewVertex.z, -vViewVertex.z - cameraNearFar.x, br.z * .5 + .5);
  float bE = .5 * bq;
  vec4 bQ;
  if(dot(br, d) > .001 && bR > .0) {
    bQ = bD(bp, bq, bE, br, j, bW);
    if(bQ.w > .0)
      return bP(bQ, bR, bS, bT, j);
    
  }
  return vec3(.0);
}
#endif
const vec3 bY = vec3(0., 0., 1.);
uniform mat4 viewMatrix;
uniform sampler2D normalTexture;
uniform sampler2D heightTexture;
uniform vec4 waveParams;
uniform vec2 waterDir;
uniform vec4 waterBaseColor;
uniform vec3 lightDirection;
uniform vec3 lightColor;
uniform vec3 camPos;
uniform float timeElapsed;
varying vec2 vUv;
varying vec2 vNoiseUv;
varying vec3 vPos;
varying mat3 vTbnMatrix;
float bZ(vec3 e, float ca) {
  float cb = max(.015, ca);
  return max((e.x + e.y) * .3303545 / cb + .3303545, .0);
}
const vec2 cc = vec2(6. / 25., 5. / 24.);
vec2 cd(sampler2D ce, vec2 S) {
  return 2. * texture2D(ce, S).rg - 1.;
}
float cf(vec2 S) {
  return texture2D(heightTexture, S).b;
}
vec3 cg(sampler2D ce, vec2 S) {
  return 2. * texture2D(ce, S).rgb - 1.;
}
float ch(vec2 S, float ci) {
  return fract(ci);
}
float cj(vec2 S, float ci) {
  float ck = ch(S, ci);
  return 1. - abs(1. - 2. * ck);
}
vec3 cl(sampler2D cm, vec2 S, float ci, float cn) {
  float co = waveParams[2];
  float cp = waveParams[3];
  vec2 cq = cd(cm, S) * co;
  float ck = ch(S, ci + cn);
  float cr = cj(S, ci + cn);
  vec2 f = S;
  f -= cq * (ck + cp);
  f += cn;
  f += (ci - ck) * cc;
  return vec3(f, cr);
}
const float cs = 7.77;
vec3 ct(sampler2D cu, sampler2D cv, vec2 cw, vec2 cx, float ci) {
  float ca = waveParams[0];
  vec2 cy = ci * -cx;
  float cz = cf(vNoiseUv) * cs;
  vec3 cA = cl(cv, cw + cy, ci + cz, .0);
  vec3 cB = cl(cv, cw + cy, ci + cz, .5);
  vec3 cC = cg(cu, cA.xy) * cA.z;
  vec3 cD = cg(cu, cB.xy) * cB.z;
  vec3 cE = normalize(cC + cD);
  cE.xy *= ca;
  cE.z = sqrt(1. - dot(cE.xy, cE.xy));
  return cE;
}
vec4 cF(vec2 cw, float cG) {
  float cH = waveParams[1];
  vec3 d = ct(normalTexture, heightTexture, cw * cH, waterDir, cG);
  float cI = bZ(d, waveParams[0]);
  return vec4(d, cI);
}
const float cJ = 3.141592653589793;
const float cK = 1. / cJ;
const float cL = .3183098861837907;
const float cM = 1.570796326794897;
const float cN = .4;
float cO = 2.2;
vec3 cP(float cQ, vec3 cR, float l) {
  return cR + (l - cR) * pow(1. - cQ, 5.);
}
float cS(float cT, float j) {
  float cU = j * j;
  float cV = cT * cT;
  float cW = pow((cV * (cU - 1.) + 1.), cO) * cJ;
  return cU / cW;
}
float cX(float cY) {
  return .25 / (cY * cY);
}
vec3 cZ(const vec3 x) {
  return (x * (2.51 * x + .03)) / (x * (2.43 * x + .59) + .14);
}
const float da = 2.2;
const float db = .4545454545;
vec4 dc(vec4 u) {
  return vec4(pow(u.rgb, vec3(db)), u.w);
}
vec3 dd(vec3 u) {
  return pow(u, vec3(da));
}
const vec3 de = vec3(.02, 1., 5.);
const vec2 df = vec2(.02, .1);
const float j = .06;
const float dg = 1.7;
const vec3 dh = vec3(0, .6, .9);
const vec3 di = vec3(.72, .92, 1.);
const float dj = .65;
const float dk = 300000.0;
const float dl = 500000.0;
const float dm = .775;
const float dn = .8;
PBRShadingWater dp;
vec3 dq(in PBRShadingWater dr, float j, vec3 ds, float dt) {
  vec3 du = cP(dr.VdotH, ds, dt);
  float dv = cS(dr.NdotH, j);
  float dw = cX(dr.LdotH);
  float dx = mix(j + .045, j + .385, 1. - dr.VdotH);
  float dy = 1.2;
  float dz = cS(dr.NdotH, dx) * dy;
  return ((dv + dz) * dw) * du;
}
vec3 dA(float dg, float dB, vec3 dh, float dC) {
  return dg * (.075 * dh * pow(dB, 4.) + 50. * pow(dB, 23.)) * dC;
}
vec3 dD(in float bk, in vec3 dE, in vec3 dF) {
  float dG = pow((1. - bk), de[2]);
  return mix(dF, dE, dG);
}
vec3 dH(in vec3 e, in vec3 dI, in float dJ, in float j) {
  
#ifdef HAS_IBL_LIGHTING
vec3 dK = reflect(-dI, e);
  vec4 dL = textureCube(prefilterMap, environmentTransform * dK);
  float dM = clamp(1. + dot(dK, e), .0, 1.);
  dL *= dM * dM;
  vec3 i = o(dL, rgbmRange);
  vec3 dN = c(e);
  float l = clamp(50.0 * waterBaseColor.g, .0, 1.);
  vec3 dO = h(waterBaseColor.rgb, j, dot(e, dI), l);
  return i * dO + dN;
#else
vec3 dP = dd(di);
  vec3 dQ = dd(dh);
  vec3 di = dD(dJ, dP, dQ);
  return di;
#endif
}
vec3 dR(in vec3 e, in vec3 dI, in vec3 dS, vec3 u, in vec3 dT, in vec3 dU, in float dV, float dW, vec3 dX) {
  float dY = 0.;
  vec3 dZ = dd(u);
  vec3 bm = normalize(dS + dI);
  dp.NdotL = clamp(dot(e, dS), .0, 1.);
  dp.NdotV = clamp(dot(e, dI), .001, 1.);
  dp.VdotN = clamp(dot(dI, e), .001, 1.);
  dp.NdotH = clamp(dot(e, bm), .0, 1.);
  dp.VdotH = clamp(dot(dI, bm), .0, 1.);
  dp.LdotH = clamp(dot(dS, bm), .0, 1.);
  float dJ = max(dot(dU, dI), .0);
  vec3 di = dH(e, dI, dJ, j);
  float ea = max(dot(dU, dS), .0);
  float eb = .1 + ea * .9;
  di *= eb;
  float ec = clamp(dV, .8, 1.);
  vec3 ed = cP(dp.VdotN, vec3(de[0]), de[1]);
  vec3 ee = ed * di * ec;
  vec3 ef = dZ * mix(di, ea * dT * cK, 2. / 3.) * ec;
  vec3 i = vec3(.0);
  if(dJ > .0 && ea > .0) {
    vec3 eg = dq(dp, j, vec3(df[0]), df[1]);
    vec3 eh = dT * cK * dV;
    i = dp.NdotL * eh * eg;
  }
  vec3 cI = vec3(.0);
  if(dJ > .0) {
    cI = dA(dg, dW, dh, eb);
  }
  vec3 ei = vec3(.0);
#ifdef HAS_SSR
float ej = smoothstep(dl, dk, -dX.z);
  mat4 ek = viewMatrix;
  vec4 el = vec4(dX.xyz, 1.);
  vec3 em = normalize(el.xyz);
  vec4 en = ek * vec4(e, .0);
  vec3 eo = normalize(en.xyz);
  vec4 ep = ek * vec4(dU, .0);
  float eq = pow(max(dot(-em, ep.xyz), .0), cN);
  vec3 er = mix(ep.xyz, eo, eq);
  vec3 es = ssr(vec3(.0), vec3(1.), j, normalize(er), -normalize(vViewVertex.xyz));
  if(es.z > .0) {
    vec2 et = smoothstep(.3, .6, abs(vec2(.5) - es.xy));
    dY = dm * clamp(1. - 1.3 * et.y, .0, 1.) * ej;
    vec3 eu = X(.0, es.xy);
    ei = dd(eu) * dY * ed.y * dj;
  }
#endif
float ev = mix(dn, dn * .5, dY);
  return cZ((1. - dY) * ee + ei + ef * ev + i + cI);
}
void main() {
  vec3 dU = bY;
  vec4 ew = cF(vUv, timeElapsed);
  vec3 e = normalize(vTbnMatrix * ew.xyz);
  vec3 dI = -normalize(vPos - camPos);
  vec3 dS = normalize(-lightDirection);
#if defined(HAS_SHADOWING)
float dV = shadow_computeShadow();
#else
float dV = 1.;
#endif
vec4 ex = viewMatrix * vec4(vPos, 1.);
  vec4 ey = vec4(dR(e, dI, dS, waterBaseColor.rgb, lightColor, dU, dV, ew.w, ex.xyz), waterBaseColor.a);
  gl_FragColor = dc(ey);
  if(contrast != 1.) {
    gl_FragColor = contrastMatrix(contrast) * gl_FragColor;
  }
  if(length(hsv) > .0) {
    gl_FragColor = hsv_apply(gl_FragColor, hsv);
  }
  gl_FragColor = highlight_blendColor(gl_FragColor) * layerOpacity;
}`,defines:o,uniforms:i,extraCommandProps:l})}getUniformValues(t){return{projViewMatrix:t.projViewMatrix}}Ws(t,e){const{iblTexes:n,dfgLUT:i}=this.getIBLRes(),o=vV(t,n,i,e&&e.ssr,e&&e.jitter),s=t.getLightManager();let a=s&&s.getDirectionalLight()||{};const l=s&&s.getAmbientLight()||{},h=this.getSymbol(nc),u=this.Qs=this.Qs||[],c=this.eo=this.eo||[];Tr(c,.09,h.uvScale||3,.03,-.5),jn(o,{ambientColor:l.color||[.2,.2,.2],viewMatrix:t.viewMatrix,lightDirection:a.direction||BP.direction,lightColor:a.color||BP.color,camPos:t.cameraPosition,timeElapsed:h.animation?(this.layer.getRenderer().getFrameTimestamp()||0)/(1/(h.waterSpeed||1)*1e4):0,normalTexture:this.Ks||this.qs,heightTexture:this.Zs||this.qs,waveParams:c,waterDir:_V(u,h.waterDirection||0),waterBaseColor:h.waterBaseColor||[.1451,.2588,.4863,1],contrast:h.contrast||1,hsv:h.hsv||xV});const f=this.layer.getRenderer();return o.layerOpacity=f.ue(),this.setIncludeUniformValues(o,e),e&&e.ssr&&e.ssr.renderUniforms&&jn(o,e.ssr.renderUniforms),o}delete(){super.delete(),this.qs&&(this.qs.destroy(),delete this.qs),this.Ks&&this.Ks.destroy(),this.Zs&&this.Zs.destroy(),this.shader&&(this.shader.dispose(),delete this.shader),this.Ys&&this.Ys.dispose(),this.Xs&&(this.Xs.geometry.dispose(),this.Xs.material&&this.Xs.material.dispose(),this.Xs.dispose(),delete this.Xs),this.disposeIBLTextures()}createGround(){const t=new Rf;t.data.aTexCoord=new Uint8Array([0,1,1,1,0,0,1,0]),t.generateBuffers(this.renderer.regl),this.Xs=new nn(t,null,{castShadow:!1}),this.Bs=new ur([this.Xs])}transformWater(){const t=this.getMap(),e=ed.getGroundTransform(this.Xs.localTransform,t);this.Xs.setLocalTransform(e);const n=t._get2DExtentAtRes(t.getGLRes()),i=n.getWidth(),o=n.getHeight(),s=t.cameraLookAt,a=s[0]-i,l=s[1]+o,h=a/bp[0],u=l/bp[1],c=h%1,f=u%1,d=h*r1%1,p=u*r1%1,g=i/bp[0]*2,m=o/bp[1]*2;this.Xs.setUniform("uvOffset",[c,f]),this.Xs.setUniform("noiseUvOffset",[d,p]),this.Xs.setUniform("uvScale",[g,-m])}}function _V(r,t){var e;return e=t,t=Math.PI*e/180,r[0]=Math.sin(t),r[1]=Math.cos(t),r}$r("fill",op).registerAt(dn),$r("line",tc).registerAt(dn),$r("line-gradient",rP).registerAt(dn),$r("icon",vP).registerAt(dn),$r("text",Kv).registerAt(dn),$r("native-line",Qj).registerAt(dn),$r("native-point",Jj).registerAt(dn),$r("phong",DP).registerAt(dn),$r("wireframe",oV).registerAt(dn),$r("lit",n1).registerAt(dn),$r("tube",LP).registerAt(dn),$r("gltf-phong",mV).registerAt(dn),$r("gltf-lit",yV).registerAt(dn),$r("heatmap",class extends _s{createFnTypeConfig(r,t){const e=le(t.heatmapWeight),n=new Int16Array(1);return[{attrName:"aWeight",symbolName:"heatmapWeight",type:Int16Array,width:1,define:"HAS_HEAT_WEIGHT",evaluate:i=>{const o=e(r.getZoom(),i);return n[0]=255*o,n[0]}}]}createMesh(r,t){const{geometry:e,symbolIndex:n,ref:i}=r;i===void 0&&Vo(e,this.getSymbolDef(n),this.getFnTypeConfig(n));const o=this.getSymbol(n),s={tileRatio:e.properties.tileRatio,dataResolution:e.properties.tileResolution};ue(s,"heatmapIntensity",o,"heatmapIntensity",1),ue(s,"heatmapRadius",o,"heatmapRadius",6),ue(s,"heatmapWeight",o,"heatmapWeight",1),ue(s,"heatmapOpacity",o,"heatmapOpacity",1),e.generateBuffers(this.regl);const a=new Gr(s),l=new nn(e,a,{transparent:!0,castShadow:!1,picking:!0}),h={};return e.data.aWeight&&(h.HAS_HEAT_WEIGHT=1),l.setDefines(h),l.setLocalTransform(t),l.properties.symbolIndex=n,l}callRenderer(r,t,e){const n=this.getRenderFBO(e);this.Pn+=this.no.render(this.scene,t,n)}getUniformValues(r){const t=this.getSymbol({index:0}),{projViewMatrix:e}=r;return{glScale:1/r.getGLScale(),resolution:r.getResolution(),projViewMatrix:e,heatmapOpacity:t.heatmapOpacity}}getHeatmapMeshes(){return this.scene.getMeshes()}delete(){super.delete(...arguments),this.no.dispose(),delete this.no}init(){const r=this.regl;this.renderer=new un(r);const t=this.getPolygonOffset(),e=this.getSymbols()[0];this.no=new lz(this.regl,this.sceneConfig,this.layer,e.heatmapColor,null,t)}}).registerAt(dn),$r("water",jP).registerAt(dn),Xn.registerPainter("lit",n1),Xn.registerPainter("icon",vP),Xn.registerPainter("fill",op),Xn.registerPainter("line",tc),Xn.registerPainter("line-gradient",rP),Xn.registerPainter("water",jP),Xn.registerPainter("tube",LP);class i1 extends dn{getTileUrl(t,e,n){const i=this.getMap().getResolution(n);return super.getTileUrl(t,e,function(o){return 19-Math.log(o/bV)/Math.LN2}(i))}static fromJSON(t){return t&&t.type==="MapboxVectorTileLayer"?new i1(t.id,t.options):null}}i1.registerJSONType("MapboxVectorTileLayer");const bV=12756274*Math.PI/(256*Math.pow(2,20));class wp extends dn{constructor(t,e){(e=e||{urlTemplate:null}).spatialReference=null,super(t,e),this.setData(e.data)}onAdd(){this.de()}de(){const t=this.getMap(),e=t.getMaxNativeZoom(),n=t.getProjection(),i=n.code==="EPSG:4326"||n.code==="EPSG:4490";var o;i&&(this.options.tileSystem=[1,-1,-180,90]),this.options.spatialReference=i?function(s,a){return{projection:a,fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){const l=[];for(let h=0;h<=s+1;h++)l[h]=90/(128*Math.pow(2,h));return l}()}}(e,n.code):(o=e,{projection:"EPSG:3857",resolutions:function(){const s=[],a=6378137*Math.PI;for(let l=0;l<=o+1;l++)s[l]=a/(256*Math.pow(2,l));return s}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}})}getWorkerOptions(){const t=super.getWorkerOptions();let e=this.options.data;return Bo(e)||e&&e.url?(e.url&&(e=JSON.parse(JSON.stringify(e))),e=GP(e,this.getURLModifier())):e=this.features,t.data=e,t.tileBuffer=this.options.tileBuffer,t.extent=this.options.extent,t.hasAltitude=this.options.enableAltitude,t.simplifyTolerance=this.options.simplifyTolerance,t.projection=this.getSpatialReference().getProjection().code,t.generateOMBB=this.options.generateOMBB,t.convertFn=this.options.convertFn?this.options.convertFn+"":null,t}setData(t){return this.options.data=t,t&&(Bo(t)||t.url)?(this.getRenderer()&&this.io(),this):(this.ro(t),this.io(),this)}ro(t){return this.options.convertFn&&(t=new Function("data",this.options.convertFn+`
return convert(data)`)(t)),this.features=t,this.so(),this}io(){const t=this.getRenderer();if(t){const e=t.getWorkerConnection();if(e){let n=this.options.data;Bo(n)||n&&n.url?(n.url&&(n=JSON.parse(JSON.stringify(n))),n=GP(n,this.getURLModifier())):n=this.features,e.setData(n,(i,o)=>{t.clear(),this.onWorkerReady(null,o),t.setToRedraw(),setTimeout(()=>{t.setToRedraw()},500)})}}}getExtent(){return this.oo}onWorkerReady(t,e){t?this.fire("dataerror",{error:t}):(e&&(e.extent&&this.ao(e.extent),e.idMap&&(this.lo=e.idMap)),this.fire("dataload",{extent:e&&e.extent}))}ao(t){this.oo=new gn(...t)}ho(t,e){Bo(t)?xs.getJSON(t,e):xs.getJSON(t.url,t,e)}getData(){return this.features||null}getTileUrl(t,e,n){return this.getId()+","+t+","+e+","+n}getFeature(t){return this.lo[t]}static fromJSON(t){return t&&t.type==="GeoJSONVectorTileLayer"?new wp(t.id,t.options):null}so(){if(!this.features||(this.features=JSON.parse(JSON.stringify(this.features)),!this.features))return;let t=0;this.lo={};const e=this.options.featureIdProperty,n=this.features;Array.isArray(n)?n.forEach(i=>{if(i){if(Bl(i.id)||(i.id=t++),e){let o=e;Zu(e)&&(o=e[i.layer||"0"]),i.id=i.properties[o]}this.lo[i.id]=i}}):n.features&&n.features.forEach(i=>{if(i){if(Bl(i.id)||(i.id=t++),e){let o=e;Zu(e)&&(o=e[i.layer||"0"]),i.id=i.properties[o]}this.lo[i.id]=i}})}}function VP(r){let t=document.createElement("a");return t.href=r,r=t.href,t=null,r}function GP(r,t){return r.url?r.url=t?t(r.url):VP(r.url):r=t?t(r):VP(r),r}wp.registerJSONType("GeoJSONVectorTileLayer"),wp.mergeOptions({features:"id",tileBuffer:64,extent:8192,pyramidMode:1,simplifyTolerance:3,tileStackDepth:0,generateOMBB:!0});const wV={markerFile:{type:"identity",default:null,property:"_symbol_markerFile"},markerWidth:{type:"identity",default:null,property:"_symbol_markerWidth"},markerHeight:{type:"identity",default:null,property:"_symbol_markerHeight"},markerPathWidth:{type:"identity",default:20,property:"_symbol_markerPathWidth"},markerPathHeight:{type:"identity",default:20,property:"_symbol_markerPathHeight"},markerDx:{type:"identity",default:null,property:"_symbol_markerDx"},markerDy:{type:"identity",default:null,property:"_symbol_markerDy"},markerType:{type:"identity",default:null,property:"_symbol_markerType"},markerPath:{type:"identity",default:null,property:"_symbol_markerPath"},markerFill:{type:"identity",default:null,property:"_symbol_markerFill"},markerFillPatternFile:{type:"identity",default:null,property:"_symbol_markerFillPatternFile"},markerFillOpacity:{type:"identity",default:null,property:"_symbol_markerFillOpacity"},markerLineColor:{type:"identity",default:null,property:"_symbol_markerLineColor"},markerLineWidth:{type:"identity",default:null,property:"_symbol_markerLineWidth"},markerLineOpacity:{type:"identity",default:null,property:"_symbol_markerLineOpacity"},markerLineDasharray:{type:"identity",default:null,property:"_symbol_markerLineDasharray"},markerLinePatternFile:{type:"identity",default:null,property:"_symbol_markerLinePatternFile"},markerVerticalAlignment:{type:"identity",default:"top",property:"_symbol_markerVerticalAlignment"},markerHorizontalAlignment:{type:"identity",default:"middle",property:"_symbol_markerHorizontalAlignment"},markerOpacity:{type:"identity",default:1,property:"_symbol_markerOpacity"},markerPitchAlignment:{type:"identity",default:"viewport",property:"_symbol_markerPitchAlignment"},markerRotationAlignment:{type:"identity",default:"viewport",property:"_symbol_markerRotationAlignment"},markerRotation:{type:"identity",default:0,property:"_symbol_markerRotation"},markerAllowOverlap:{type:"identity",default:0,property:"_symbol_markerAllowOverlap"},markerIgnorePlacement:{type:"identity",default:0,property:"_symbol_markerIgnorePlacement"},markerTextFit:{type:"identity",default:null,property:"_symbol_markerTextFit"},markerSpacing:{type:"identity",default:250,property:"_symbol_markerSpacing"},markerTextFitPadding:{type:"identity",default:null,property:"_symbol_markerTextFitPadding"},markerPlacement:{type:"identity",default:"point",property:"_symbol_markerPlacement"}},AV={textName:{type:"identity",default:null,property:"_symbol_textName"},textFaceName:{type:"identity",default:null,property:"_symbol_textFaceName"},textWrapWidth:{type:"identity",default:null,property:"_symbol_textWrapWidth"},textHorizontalAlignment:{type:"identity",default:null,property:"_symbol_textHorizontalAlignment"},textVerticalAlignment:{type:"identity",default:null,property:"_symbol_textVerticalAlignment"},textFill:{type:"identity",default:null,property:"_symbol_textFill"},textSize:{type:"identity",default:null,property:"_symbol_textSize"},textHaloRadius:{type:"identity",default:null,property:"_symbol_textHaloRadius"},textHaloFill:{type:"identity",default:null,property:"_symbol_textHaloFill"},textHaloOpacity:{type:"identity",default:1,property:"_symbol_textHaloOpacity"},textDx:{type:"identity",default:0,property:"_symbol_textDx"},textDy:{type:"identity",default:0,property:"_symbol_textDy"},textOpacity:{type:"identity",default:1,property:"_symbol_textOpacity"},textPitchAlignment:{type:"identity",default:"viewport",property:"_symbol_textPitchAlignment"},textRotationAlignment:{type:"identity",default:"viewport",property:"_symbol_textRotationAlignment"},textRotation:{type:"identity",default:0,property:"_symbol_textRotation"},textAllowOverlap:{type:"identity",default:0,property:"_symbol_textAllowOverlap"},textIgnorePlacement:{type:"identity",default:0,property:"_symbol_textIgnorePlacement"},textSpacing:{type:"identity",default:250,property:"_symbol_textSpacing"},textPlacement:{type:"identity",default:"point",property:"_symbol_textPlacement"}},Ap={lineWidth:{type:"identity",default:2,property:"_symbol_lineWidth"},lineStrokeWidth:{type:"identity",default:0,property:"_symbol_lineStrokeWidth"},lineColor:{type:"identity",default:[1,1,1,1],property:"_symbol_lineColor"},lineStrokeColor:{type:"identity",default:[0,0,0,0],property:"_symbol_lineStrokeColor"},lineDx:{type:"identity",default:0,property:"_symbol_lineDx"},lineDy:{type:"identity",default:0,property:"_symbol_lineDy"},linePatternFile:{type:"identity",default:null,property:"_symbol_linePatternFile"},linePatternAnimSpeed:{type:"identity",default:0,property:"_symbol_linePatternAnimSpeed"},linePatternGap:{type:"identity",default:0,property:"_symbol_linePatternGap"},lineOpacity:{type:"identity",default:1,property:"_symbol_lineOpacity"},lineJoin:{type:"identity",default:null,property:"_symbol_lineJoin"},lineCap:{type:"identity",default:null,property:"_symbol_lineCap"},lineDasharray:{type:"identity",default:null,property:"_symbol_lineDasharray"},lineDashColor:{type:"identity",default:null,property:"_symbol_lineDashColor"}},o1="_line_gradient_property",Ii=new W(0,0),Yn="_vector3dlayer_id",TV=(o1+"").trim();function UP(r,t,e){const n=(Yd+"").trim(),i=r.getMap(),o=i.getGLRes();let s=r.getCoordinates();const a=[],l=[];let h=1;if(r instanceof bn||r instanceof Hs){r instanceof bn&&(s=[s]);for(let g=0;g<s.length;g++)i.coordToPointAtRes(s[g],o,Ii),a.push([Ii.x,Ii.y,s[g].z||0]),l.push([s[g].x,s[g].y])}else if(r instanceof Pn||r instanceof Ns){h=2,r instanceof Pn&&(s=[s]);for(let g=0;g<s.length;g++){a[g]=[],l[g]=[];for(let m=0;m<s[g].length;m++)i.coordToPointAtRes(s[g][m],o,Ii),a[g].push([Ii.x,Ii.y,s[g][m].z||0]),l[g].push([s[g][m].x,s[g][m].y])}}else if(r instanceof _n||r instanceof Bs){h=3,r instanceof Ti||r instanceof js||r instanceof no||r instanceof Vs?s=[[r.getShell()]]:r instanceof _n&&(s=[s]);let g=0;for(let m=0;m<s.length;m++){let y=!1;for(let x=0;x<s[m].length;x++){if(a[g]=[],l[g]=[],y)for(let v=s[m][x].length-1;v>=0;v--)i.coordToPointAtRes(s[m][x][v],o,Ii),a[g].push([Ii.x,Ii.y,s[m][x][v].z||0]),l[g].push([s[m][x][v].x,s[m][x][v].y]);else for(let v=0;v<s[m][x].length;v++)i.coordToPointAtRes(s[m][x][v],o,Ii),a[g].push([Ii.x,Ii.y,s[m][x][v].z||0]),l[g].push([s[m][x][v].x,s[m][x][v].y]);x===0&&(y=Lr.calculateSignedArea(a[g])<0,y&&(a[g]=a[g].reverse(),l[g]=l[g].reverse())),g++}}}const u=r.getProperties()?Object.assign({},r.getProperties()):{},c=r._getInternalSymbol()||function(g){if(g instanceof bn||g instanceof Hs)return{markerType:"ellipse",markerWidth:8,markerHeight:0,markerFill:"#000"};if(g instanceof Pn||g instanceof Ns)return{lineColor:"#000",lineWidth:1};if(g instanceof _n||g instanceof Bs)return{polygonFill:"#fff",lineColor:"#000",lineWidth:1}}(r),f=e?Array.isArray(e)?e[0].id:e.id:t.id++;if(Array.isArray(c)&&c.length){const g=[],m=c.length;for(let y=0;y<m;y++){const x=y===m-1?u:Oe({},u),v=$P(c[y],x);for(const b in c[y])jl(c[y],b)&&(x[("_symbol_"+b).trim()]=c[y][b]);v&&(c[y].lineGradientProperty=v);const _=e&&e[y]?e[y][n]:t.pickingId++,w={type:h,id:f,properties:x,visible:r.isVisible(),geometry:a,coordinates:l,extent:1/0};w[n]=_,g.push(w)}return g}if(c){const g=$P(c,u);for(const m in c)jl(c,m)&&(u[("_symbol_"+m).trim()]=c[m]);g&&(c.lineGradientProperty=g)}const d=e?e.id:t.pickingId++,p={type:h,id:f,properties:u,visible:r.isVisible(),geometry:a,coordinates:l,extent:1/0};return p[n]=d,p}function $P(r,t){const e=r.lineGradientProperty;return e&&(t[TV]=t[e],t.mapbox_clip_start=0,t.mapbox_clip_end=1,delete t[e]),e}let MV=1;const $o="_symbol_".trim(),mo=(Yd+"").trim();let Tp=new Float32Array(1);const SV=[];class s1 extends So.CanvasRenderer{constructor(...t){super(...t),this.features={},this.uo={},this.j=0,this.co={},this.fo={},this.do={},this.po={},this.mo={},this.yo=!0,this.xo={id:0,pickingId:0},this.vo={}}setURLModifier(t){this.fe=t}getURLModifier(){return this.fe}hasNoAARendering(){return!0}needToRedraw(){return super.needToRedraw()||this.painter&&this.painter.needToRedraw()||this.bo&&this.bo.needToRedraw()||this.Ao&&this.Ao.needToRedraw()}getAnalysisMeshes(){return this.painter&&this.painter.getAnalysisMeshes()||SV}getRayCastData(){return null}draw(t,e){this._t=t;const n=this.layer;this.prepareCanvas(),this.St=this.Mt(this.getMap().getGLRes()),this.Tt=e||{};const i=this.Tt.renderMode,o=this.wo();if(this.Pt(o,i),this.yo)this.buildMesh(),this._o(),this.So(),this.vo={},this.Mo=!1,this.yo=!1,this.To=!1;else if(this.Mo){const h=this.atlas,u=this.Po,c=this.ko;delete this.atlas,delete this.Po,delete this.ko,this.buildMesh(h),this._o(u),this.So(c),this.Mo=!1,this.To=!1}else if(this.To){const h=this.ko;delete this.ko,this.So(h),this.To=!1}if(!this.meshes&&!this.Io&&!this.Oo)return void this.completeRender();this.Co&&(this.Fo(),this.Co=!1),this.Eo();const s=!i||i==="default";let a=0;this.layer.options.meshRenderOrder===0&&this.Do(o,a,i);let l=0;if(this.Oo&&(s||this.Ao.supportRenderMode(i))){this.Ao.startFrame(o),this.Ao.addMesh(this.Oo,null,{bloom:this.Tt.bloom}),this.Ao.prepareRender(o);const h=o.polygonOffsetIndex||0;a=this.meshes&&this.meshes.length?a-1:a,o.polygonOffsetIndex=(o.polygonOffsetIndex||0)+a,l=this.Ao.render(o).drawCount,o.polygonOffsetIndex=h}if(this.layer.options.meshRenderOrder===1&&this.Do(o,l?a-1:a,i),this.Io&&(s||this.bo.supportRenderMode(i))){const h=!this.Tt.timestamp||this.Tt.isFinalRender,u=!this.Lo||this.Lo!==t;n.options.collision&&u&&n.clearCollisionIndex();const c=this.layer.options.sceneConfig;this.bo.sceneConfig.collision=!c||!!er(c.collision)||c.collision,this.bo.startFrame(o),this.bo.addMesh(this.Io,null,{bloom:this.Tt.bloom}),this.bo.prepareRender(o),n.options.collision&&u&&(this.bo.updateCollision(o),h&&(this.Lo=t)),this.bo.render(o)}(s||e&&e.isFinalRender)&&(this.completeRender(),this.layer.fire("canvasisdirty"))}Pt(t,e){const n=!e||e==="default";this.painter&&(n||this.painter.supportRenderMode(e))&&this.painter.startFrame(t)}Do(t,e,n){const i=!n||n==="default";return this.painter&&this.meshes&&(i||this.painter.supportRenderMode(n))?(this.painter.addMesh(this.meshes,null,{bloom:t&&t.bloom}),this.painter.prepareRender(t),t.polygonOffsetIndex=(t.polygonOffsetIndex||0)+e,this.painter.render(t)):{redraw:!1,drawCount:0}}supportRenderMode(){return!0}isForeground(){return!0}wo(){const t={regl:this.regl,layer:this.layer,symbol:this.zo,gl:this.gl,sceneConfig:this.layer.options.sceneConfig,pluginIndex:0,cameraPosition:this.getMap().cameraPosition,timestamp:this.getFrameTimestamp()};return this.Tt&&Oe(t,this.Tt),t}drawOnInteracting(t,e,n){this.draw(e,n)}getFrameTimestamp(){return this._t}Ro(t,e){(t=t||e)===e&&(e=null);const n=[],i=[0,0,0,0];this.layer._sortGeometries();const o=this.layer.getGeometries();for(let s=0;s<o.length;s++){const a=o[s][Yn];if(!this.features[a])continue;const l=this.features[a];if(Array.isArray(l))for(let h=0;h<l.length;h++){const u=l[h],c=u[mo];(!t||t[c]||e&&(!e||e[c]))&&(u.visible||(this.Co=!0),this.Ho(u.geometry,i,u.coordinates),n.push(u))}else{l.visible||(this.Co=!0);const h=l[mo];if(t&&!t[h]&&(!e||e&&!e[h]))continue;this.Ho(l.geometry,i,l.coordinates),n.push(l)}}if(n.length||(this.meshes&&this.painter&&(this.painter.deleteMesh(this.meshes),delete this.meshes),this.Io&&(this.bo.deleteMesh(this.Io),delete this.Io),this.Oo&&(this.Ao.deleteMesh(this.Oo),delete this.Oo)),i[3]&&(i[0]/=i[3],i[1]/=i[3]),isNaN(i[0])||isNaN(i[1]))throw new Error(`invalid geometry coordinates for ${this.layer.getJSONType()}`);return{features:n,center:i}}buildMesh(){}createVectorPacks(t,e,n,i,o,s){return!t||!i||!i.length?Promise.resolve(null):new e(i,n,{zoom:this.getMap().getZoom(),EXTENT:1/0,requestor:this.requestor,atlas:o,center:s,positionType:Float32Array}).load()}createMesh(t,e,n,i,o,s){return this.createVectorPacks(t,e,n,i,o,s).then(a=>this.No(a,t,e,n,i,o,s))}No(t,e,n,i,o,s,a){if(!t)return null;const l=e.createGeometries([t.data],FC(o,null,0,i,this.layer));for(let c=0;c<l.length;c++)l[c]&&this.$e(l[c].geometry);const h=mn([]);oo(h,h,ie([],a[0],a[1],0)),so(h,h,ie([],1,1,this.St));const u=e.createMeshes(l,h,{tilePoint:[a[0],a[1]]});for(let c=0;c<u.length;c++){const f=u[c];f.properties.level=0,f.properties.tileTransform=h;const d=f.defines;d.ENABLE_TILE_STENCIL=1,f.setDefines(d),f.properties.meshKey=this.layer.getId()}return{meshes:u,atlas:{iconAtlas:t.data.iconAtlas}}}Ho(t,e,n){for(let i=0;i<t.length;i++)if(Array.isArray(t[i][0]))for(let o=0;o<t[i].length;o++)if(Array.isArray(t[i][o][0]))for(let s=0;s<t[i][o].length;s++)isNaN(+t[i][o][s][0])||isNaN(+t[i][o][s][1])||this.Vo(e,t[i][o][s][0],t[i][o][s][1],t[i][o][s][2],1,n[i][o][s]);else isNaN(+t[i][o][0])||isNaN(+t[i][o][1])||this.Vo(e,t[i][o][0],t[i][o][1],t[i][o][2],1,n[i][o]);else isNaN(+t[i][0])||isNaN(+t[i][1])||this.Vo(e,t[i][0],t[i][1],t[i][2],1,n[i])}Vo(t,e,n,i,o,s){const a=this.getMap().getProjection().isSphere();let l=!1;(s[0]>180||s[0]<-180)&&(l=!0,a&&console.warn(`Layer(${this.layer.getId()}) has invalid longitude value: ${s[0]}`)),(s[1]>90||s[1]<-90)&&(l=!0,a&&console.warn(`Layer(${this.layer.getId()}) has invalid latitude value: ${s[1]}`)),l||(t[0]+=e,t[1]+=n,t[2]+=i||0,t[3]+=o)}$e(t){const e=this.getMap(),n=t.properties;Object.defineProperty(n,"tileResolution",{enumerable:!0,get:function(){return e.getGLRes()}}),n.tileRatio=1,n.z=1,n.tileExtent=1,n.elements=t.elements,n.aPickingId=t.data.aPickingId}jo(t){return t==="win-intel-gpu-crash"&&this.layer.options.workarounds["win-intel-gpu-crash"]&&WP(this.gl)}prepareRequestors(){if(this.A)return;const t=this.layer;this.A=new hC({iconErrorUrl:t.options.iconErrorUrl,urlModifier:n=>{const i=t.getURLModifier();return i&&i(n)||n}});const e=!this.jo("win-intel-gpu-crash");this._=new lC(n=>{t.getMap().getRenderer().callInNextFrame(n)},t.options.glyphSdfLimitPerFrame,e),this.requestor=this.Uo.bind(this),this.Go=this.Wo.bind(this)}Uo(t,e,n){const i=[];this.A.getIcons(t,(o,s)=>{if(o)throw o;s.buffers&&i.push(...s.buffers),n(null,{icons:s.icons},i)})}Wo(t,e,n){this._.getGlyphs(e,(i,o)=>{if(i)throw i;const s=o.buffers||[];this.A.getIcons(t,(a,l)=>{if(a)throw a;l.buffers&&l.buffers.length&&s.push(...l.buffers),n(null,{icons:l.icons,glyphs:o.glyphs},s)})})}_o(t){const e=Object.keys(this.do),n=Object.keys(this.po);if(!e.length&&!n.length)return void(this.Io&&(this.bo.deleteMesh(this.Io),delete this.Io));const{features:i,center:o}=this.Ro(this.do,this.po),s=[],a=[];for(let f=0;f<i.length;f++){const d=i[f][mo];this.do[d]&&s.push(i[f]),this.po[d]&&a.push(i[f])}if(!s.length&&!a.length)return void(this.Io&&(this.bo.deleteMesh(this.Io),delete this.Io));const l=this.Co;this.Yo=o;const h=this.Bo(s,a,t,o);this.Po={};const u=[],c=[];this.Xo=!0,Promise.all(h).then(f=>{if(this.Io&&(this.bo.deleteMesh(this.Io),delete this.Io),!f||!f.length)return void this.setToRedraw();const d=this.bo.createGeometries(f.map(x=>(x&&x.data&&(x.data.isIdUnique=!0),x&&x.data)),this.co);for(let x=0;x<d.length;x++)this.$e(d[x].geometry,f[x]&&f[x].data);const p=f[0]&&f[0].data.iconAtlas,g=f[0]&&f[0].data.glyphAtlas||f[1]&&f[1].data.glyphAtlas;p&&(this.Po.iconAtlas=p),g&&(this.Po.glyphAtlas=g);const m=mn([]);oo(m,m,ie(c,o[0],o[1],0)),so(m,m,ie(u,1,1,this.St));const y=this.bo.createMeshes(d,m);for(let x=0;x<y.length;x++)y[x].geometry.properties.originElements=y[x].geometry.properties.elements.slice(),y[x].properties.level=0,y[x].material.set("flipY",1),y[x].properties.meshKey=MV++;this.Io=y,l&&(this.Co=!0),this.Xo=!1,this.setToRedraw(),this.layer.fire("buildmarkermesh")})}Fo(){if(this.Io&&(this.$o(this.Io[0],this.do),this.$o(this.Io[1],this.po),this.Io[0]&&this.bo.prepareCollideIndex(this.Io[0].geometry),this.Io[1]&&this.bo.prepareCollideIndex(this.Io[1].geometry)),this.Oo)for(let t=0;t<this.Oo.length;t++)this.$o(this.Oo[t],this.mo);if(this.meshes)for(let t=0;t<this.meshes.length;t++)this.$o(this.meshes[t],this.co)}$o(t,e){if(!t)return;const{aPickingId:n,originElements:i}=t.geometry.properties,o=[];for(let a=0;a<i.length;a++){const l=n[i[a]];e[l]&&e[l].feature.visible&&o.push(i[a])}const s=t.geometry.properties.elements=new i.constructor(o);t.geometry.setElements(s)}Bo(t,e,n,i){const o={zoom:this.getMap().getZoom(),EXTENT:1/0,requestor:this.Go,atlas:n,center:i,positionType:Float32Array,defaultAltitude:0,forceAltitudeAttribute:!0,markerWidthType:Uint16Array,markerHeightType:Uint16Array},s=Oe({},o);return o.allowEmptyPack=1,av.splitPointSymbol(this.qo).map((a,l)=>new av(l===0?t:e,a,l===0?o:s).load())}updateMesh(){}Ko(t){const e=t._getInternalSymbol(),n={zoom:this.getMap().getZoom(),isVector3D:!0},i=this.Jo(t);if(!this.Io)return!1;let o=this.features[i];Array.isArray(o)||(o=[o]);const s=[],a=[],l=[],h=this.getMap().getZoom();let u,c;u=Array.isArray(e)?e.map(g=>g&&yu(g,()=>(s[0]=h,s))):yu(e,()=>(s[0]=h,s)),c=Array.isArray(e)?e.map(g=>g&&la.genFnTypes(g)):la.genFnTypes(e);for(let g=0;g<o.length;g++){if(!o[g])continue;const m=Array.isArray(e)?e[g]:e,y=Array.isArray(u)?u[g]:u,x=Array.isArray(c)?c[g]:c,v=new GS(o,m,y,x,n).getIconAndGlyph();if(!this.Po||!av.isAtlasLoaded(v,this.Po))return this.Zo(),this.setToRedraw(),!1}for(let g=0;g<o.length;g++){const m=o[g][mo];this.do[m]&&a.push(o[g]),this.po[m]&&l.push(o[g])}const f=o[0].id,d=this.Bo(a,l,this.Po,this.Yo),p=this.Io;return Promise.all(d).then(g=>{for(let m=0;m<g.length;m++){if(!g[m])continue;g[m].data&&(g[m].data.isIdUnique=!0);const y=p[m],x=y.geometry.properties.aFeaIds.indexOf(f);if(x<0)continue;const v=g[m].data.featureIds.length,_=g[m].data.dynamicAttributes;for(const w in g[m].data.data){if(w==="aPickingId"||_[w])continue;const b=g[m].data.data[w];b&&y.geometry.updateSubData(w,b,x*b.length/v)}}this.setToRedraw()}),!0}Qo(t){return this.ta(t,this.Oo,this.ko,this.ea,this.Ao,Hd,Ap,this.na)}ta(t,e,n,i,o,s,a,l){if(!e)return!1;if(!n)return this.Zo(),this.setToRedraw(),!1;const h=t._getInternalSymbol(),u={zoom:this.getMap().getZoom()},c=t[Yn];let f=this.features[c];Array.isArray(f)||(f=[f]);const d=[];for(let x=0;x<f.length;x++){const v=f[x];if(!v)continue;const _=Array.isArray(h)?h[x]:h,w=la.genFnTypes(_),b=new xd(f,_,w,u),A=s===Hd?b.getLineResource():b.getPolygonResource();if(!la.isAtlasLoaded(A,n[x]))return this.Zo(),this.setToRedraw(),!1;d.push(v)}const p=f[0].id,g=l.call(this,d);for(let x=0;x<g.length;x++)if(g[x].length){const v=e.filter(_=>_.feaGroupIndex===x);if(!v.length)return this.Zo(),this.setToRedraw(),!1;if(v[0].geometry.properties.aFeaIds.indexOf(p)<0)return this.Zo(),this.setToRedraw(),!1}const m=Oe({},a),y=g.map(x=>this.createVectorPacks(o,s,m,x,n[0],i));return Promise.all(y).then(x=>{for(let v=0;v<x.length;v++){let _;if(Array.isArray(e)){for(let w=0;w<e.length;w++)if(e[w].feaGroupIndex===v){_=e[w];break}}else _=e;_&&this.ia(_,p,x[v])}}),!0}ia(t,e,n){const i=t.geometry.properties.aFeaIds,o=i.indexOf(e);if(!(o<0)){if(n){const s=n.data.dynamicAttributes,a=n.data.featureIds.length,l=n.data.data;for(const h in l)if(!s[h]&&jl(l,h)&&l[h]){const u=l[h];t.geometry.updateSubData(h,u,o*u.length/a)}}else{let s=o+1;for(;i[s]===e;)s++;const a=s-o,l=t.geometry.desc.positionSize;Tp.length!==3*a&&(Tp=new Float32Array(a*l),Tp.fill(-1/0,0)),t.geometry.updateSubData(t.geometry.desc.positionAttribute,Tp,o*l)}this.layer.fire("updatemesh"),this.setToRedraw()}}So(t){if(!Object.keys(this.mo).length)return void(this.Oo&&(this.Ao.deleteMesh(this.Oo),delete this.Oo));const{features:e,center:n}=this.Ro(this.mo);if(!e.length)return;const i=this.Co;this.ea=n;const o=this.na(e),s=Oe({},Ap),a=o.map((l,h)=>this.createMesh(this.Ao,Hd,s,l,t&&t[h],n));this.ra=!0,Promise.all(a).then(l=>{this.Oo&&this.Ao.deleteMesh(this.Oo);const h=[],u=[];for(let c=0;c<l.length;c++){const f=l[c]&&l[c].meshes;if(f){for(let d=0;d<f.length;d++){const p=f[d];p.feaGroupIndex=c,h.push(p),p.geometry.properties.originElements=p.geometry.properties.elements.slice()}u[c]=l[c].atlas}}this.Oo=h,this.ko=u,i&&(this.Co=i),this.ra=!1,this.setToRedraw(),this.layer.fire("buildlinemesh")})}na(t){const e=($o+"lineDasharray").trim(),n=($o+"linePatternFile").trim(),i=[],o=[],s=[];for(let a=0;a<t.length;a++){const l=t[a],h=l.properties&&l.properties[e];h&&EV(h)?s.push(l):l.properties&&l.properties[n]?o.push(l):i.push(l)}return[i,o,s]}sa(){this.Mo=!0,this.setToRedraw()}Zo(){this.yo=!0,this.setToRedraw()}oa(t){const e=this.layer.getId();for(let n=0;n<t.length;n++){const i=t[n];let o=!1;for(let s=0;s<this.GeometryTypes.length;s++)if(i instanceof this.GeometryTypes[s]){o=!0;break}if(!o)throw new Error(`${i.getJSONType()} can't be added to ${this.layer.getJSONType()}(id:${e}).`);this.Jo(i)}}Jo(t){t[Yn]===void 0&&(t[Yn]=this.j++);const e=t[Yn];this.features[e]&&this.aa(e),this.features[e]=UP(t,this.xo,this.features[e]);const n=this.features[e];return this.la(n,e),this.uo[e]=t,e}la(t,e){if(!t)return;const n=Array.isArray(t)?t[0].id:t.id;if(this.fo[n]=t,Array.isArray(t))for(let i=0;i<t.length;i++){const o=t[i][mo];if(t[i][Yn]=e,this.co[o]={feature:t[i]},this.co[o][Yn]=e,!this.needCheckPointLineSymbols())continue;const s={feature:t[i]};(ZP(t[i])||Mp(t[i]))&&(this.do[o]=s),Mp(t[i])&&(this.po[o]=s),XP(t[i])&&(this.mo[o]=s)}else{t[Yn]=e;const i={feature:t},o=t[mo];if(this.co[o]=i,!this.needCheckPointLineSymbols())return;(ZP(t)||Mp(t))&&(this.do[o]=i),Mp(t)&&(this.po[o]=i),XP(t)&&(this.mo[o]=i)}}needCheckPointLineSymbols(){return!0}aa(t){const e=this.features[t];if(e)if(Array.isArray(e))for(let n=0;n<e.length;n++){const i=e[n][mo],o=e[n].id;delete this.fo[o],delete this.co[i],delete this.do[i],delete this.po[i],delete this.mo[i]}else{const n=e[mo],i=e.id;delete this.fo[i],delete this.co[n],delete this.do[n],delete this.po[n],delete this.mo[n]}}pick(t,e,n){const i=[];return this.layer.isVisible()&&[this.painter,this.bo,this.Ao].forEach(o=>{if(!o)return;const s=o.pick(t,e,n.tolerance);if(s&&s.data&&s.data.feature){const a=s.data.feature,l=this.uo[a[Yn]];n&&n.includeInternals?i.push(l):(s.geometry=l,delete s.plugin,delete s.data,delete s.point,i.push(s))}}),i}ha(t){const e=t[Yn],n=this.features[e];return Array.isArray(n)?n[0][mo]:n[mo]}Eo(){let t=!1;for(const e in this.vo){const n=this.vo[e],i=this.ha(n);if(!this.Xo&&(this.do[i]||this.po[i])){const o=this.Ko(n);t=t||o}if(!this.ra&&this.mo[i]){const o=this.Qo(n);t=t||o}if(!this.ua){const o=this.updateMesh(n);t=t||o}}this.vo={},t&&(Ss(this),this.layer.fire("partialupdate"))}ca(t){this.Jo(t),this.Zo(),Ss(this)}onGeometryAdd(t){this.setToRedraw(),this.canvas&&t&&t.length&&(this.oa(t),this.Zo(),Ss(this))}onGeometryRemove(t){if(t&&t.length){for(let e=0;e<t.length;e++){const n=t[e][Yn];n!==void 0&&(delete this.uo[n],this.aa(n),delete this.features[n])}this.Zo(),Ss(this)}}onGeometrySymbolChange(t){const e=t.target._getParent()||t.target,n=e[Yn];if(n===void 0)return;let i=t.properties;if(Array.isArray(i)){const a={};for(let l=0;l<i.length;l++)i[l]&&Oe(a,i[l]);i=a}else if(i&&i[0]!==void 0){const a={};for(const l in i)i[l]&&Oe(a,i[l]);i=a}for(const a in i)if(jl(i,a)&&xC[a])return void this.ca(e);const o=e._getInternalSymbol(),s=this.features[n];if(this.Jo(e),s)if(function(a,l){return Array.isArray(a)?!!Array.isArray(l)&&a.length===l.length:!Array.isArray(l)}(o,s)){if(Array.isArray(o)){for(let a=0;a<o.length;a++)if(!YP(o[a],s[a]))return void this.ca(e)}else if(!YP(o,s))return void this.ca(e);this.onGeometryPositionChange(t)}else this.ca(e);else this.ca(e)}onGeometryShapeChange(t){const e=t.target._getParent()||t.target;e[Yn]!==void 0&&(this.oa([e]),this.sa(),Ss(this))}onGeometryPositionChange(t){const e=t.target._getParent()||t.target,n=e[Yn];n!==void 0&&(this.oa([e]),this.vo[n]=e,Ss(this))}onGeometryZIndexChange(t){(t.target._getParent()||t.target)[Yn]!==void 0&&this.Zo()}onGeometryShow(t){(t.target._getParent()||t.target)[Yn]!==void 0&&this.fa(t)}onGeometryHide(t){(t.target._getParent()||t.target)[Yn]!==void 0&&this.fa(t)}fa(t){const e=t.target._getParent()||t.target,n=e[Yn],i=this.features[n];if(i){const o=e.isVisible();if(Array.isArray(i)){if(o===i[0].visible)return;for(let s=0;s<i.length;s++)i[s].visible=o}else{if(o===i.visible)return;i.visible=o}this.da(),Ss(this)}}da(){this.Co=!0}onGeometryPropertiesChange(t){const e=t.target._getParent()||t.target,n=e[Yn];n!==void 0&&(this.features[n]=UP(e,this.xo),this.la(this.features[n],n),this.Zo(),Ss(this))}createContext(){const t=this.canvas.gl&&this.canvas.gl.wrap;t?(this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl):this.yt(),t&&(this.canvas.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height)),this.prepareRequestors(),this.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height),this.painter=this.createPainter();const e=Xn.get3DPainterClass("icon");let n=e.getBloomSymbol();const i=Oe({},wV,AV);i.markerPerspectiveRatio=this.layer.options.markerPerspectiveRatio||0,this.pa(i,n),this.qo=i;const o=Oe({},OC,this.layer.options.sceneConfig||{});this.bo=new e(this.regl,this.layer,i,o,0),this.bo.setTextShaderDefines({REVERSE_MAP_ROTATION_ON_PITCH:1});const s=Xn.get3DPainterClass("line"),a=Oe({},Ap);n=s.getBloomSymbol(),this.pa(a,n),this.ma=a;const l=Oe({},this.layer.options.sceneConfig||{});l.depthMask===void 0&&(l.depthMask=!0),this.Ao=new s(this.regl,this.layer,a,l,0),this.layer.getGeometries()&&this.onGeometryAdd(this.layer.getGeometries())}dt(){return!!(this.canvas&&this.canvas.gl&&this.canvas.gl.wrap)}pa(t,e){for(let n=0;n<e.length;n++)t[e[n]]=this.layer.options.enableBloom}updateBloom(t){this.bo&&this.ya(this.bo,this.qo,t),this.Ao&&this.ya(this.Ao,this.ma,t),this.painter&&this.ya(this.painter,this.painterSymbol,t)}ya(t,e,n){const i=t.constructor.getBloomSymbol().reduce((o,s)=>(o[s]=n,e[s]=n,o),{});t.updateSymbol(i,e)}createPainter(){}yt(){const t=this.layer.options.glOptions||{alpha:!0,depth:!0,stencil:!0,antialias:!1};t.preserveDrawingBuffer=!0,t.stencil=!0,this.glOptions=t,this.gl=this.gl||this.vt(this.canvas,t),this.regl=Xh({gl:this.gl,attributes:t,extensions:Lw.WEBGL_EXTENSIONS,optionalExtensions:Lw.WEBGL_OPTIONAL_EXTENSIONS})}vt(t,e){const n=["webgl","experimental-webgl"];let i=null;for(let o=0;o<n.length;++o){try{i=t.getContext(n[o],e)}catch{}if(i)break}return i}clearCanvas(){super.clearCanvas(),this.regl&&this.regl.clear({color:[0,0,0,0],depth:1,stencil:255})}resizeCanvas(t){super.resizeCanvas(t);const e=this.canvas;e&&(!this.pickingFBO||this.pickingFBO.width===e.width&&this.pickingFBO.height===e.height||this.pickingFBO.resize(e.width,e.height),this.painter&&this.painter.resize(e.width,e.height))}onRemove(){super.onRemove(),this.painter&&(this.painter.delete(),delete this.painter),this.bo&&(this.bo.delete(),delete this.bo),this.Ao&&(this.Ao.delete(),delete this.Ao)}drawOutline(t){if(this.Et&&(this.painter&&this.painter.outlineAll(t),this.bo.outlineAll(t),this.Ao.outlineAll(t)),this.ga)for(let e=0;e<this.ga.length;e++)this.painter&&this.painter.outline(t,this.ga[e]),this.bo.outline(t,this.ga[e]),this.Ao.outline(t,this.ga[e])}outlineAll(){this.Et=!0,this.setToRedraw()}outline(t){this.ga||(this.ga=[]);const e=[];for(let n=0;n<t.length;n++){const i=this.layer.getGeometryById(t[n]);if(i){const o=this.features[i[Yn]];if(Array.isArray(o))for(let s=0;s<o.length;s++)e.push(o[s].id);else e.push(o.id)}}this.ga.push(e),this.setToRedraw()}cancelOutline(){delete this.Et,delete this.ga,this.setToRedraw()}isEnableWorkAround(t){return t==="win-intel-gpu-crash"&&this.layer.options.workarounds["win-intel-gpu-crash"]&&WP(this.gl)}Mt(t){return Vl(t,this.getMap())}je(){const t=this.layer.getGeometries();t&&this.oa(t),this.Zo()}ue(){const t=this.layer.options.opacity;return this.dt()?er(t)?1:t:1}}function Ss(r){r.setToRedraw()}function WP(r){const t=r.getExtension("WEBGL_debug_renderer_info");if(t&&typeof navigator<"u"){const e=r.getParameter(t.UNMASKED_RENDERER_WEBGL),n=navigator.platform==="Win32"||navigator.platform==="Win64";if(e&&e.toLowerCase().indexOf("intel")>=0&&n)return!0}return!1}function ZP({properties:r}){const t=($o+"markerFile").trim(),e=($o+"markerType").trim();return r[t]||r[e]}function Mp({properties:r}){return r[($o+"textName").trim()]}const CV=($o+"lineWidth").trim(),PV=(o1+"").trim();function XP(r){return r.type===2&&!r.properties[PV]||r.type===3&&r.properties[CV]!==void 0}function EV(r){if(!Array.isArray(r))return 0;let t=0;for(let e=0;e<r.length;e++)t+=r[e];return t}function YP(r,t){if(Object.keys(r).sort().join()!==Object.keys(t.properties||{}).filter(e=>e.indexOf($o)===0).map(e=>e.substring($o.length)).sort().join())return!1;for(const e in r)if(jl(r,e)){const n=($o+e).trim();if(Ft(r[e])!==Ft(t.properties[n]))return!1}return!0}function Sp(r,t,e){if(!r||r.type!==t)return null;const n=new e(r.id,r.options),i=r.geometries,o=[];for(let s=0;s<i.length;s++){const a=en.fromJSON(i[s]);a&&o.push(a)}return n.addGeometry(o),n}class eh extends Xn{static fromJSON(t){return Sp(t,"PointLayer",eh)}constructor(...t){super(...t),this.options.sceneConfig||(this.options.sceneConfig=Oe({},OC))}getPolygonOffsetCount(){return 0}getPolygonOffset(){return 0}}eh.mergeOptions({glyphSdfLimitPerFrame:15,iconErrorUrl:null,workarounds:{"win-intel-gpu-crash":!0},collision:!1,collisionFrameLimit:1}),eh.registerJSONType("PointLayer"),eh.registerRenderer("canvas",null),eh.registerRenderer("gl",class extends s1{constructor(...r){super(...r),this.GeometryTypes=[bn,Hs]}onGeometryAdd(r){r&&(Array.isArray(r)?r.forEach(t=>{t.options.maxMarkerWidth=t.options.maxMarkerHeight=255}):r.options.maxMarkerWidth=r.options.maxMarkerHeight=255,super.onGeometryAdd(r))}});class nh extends Xn{static fromJSON(t){return Sp(t,"LineStringLayer",nh)}}nh.mergeOptions({meshRenderOrder:1}),nh.registerJSONType("LineStringLayer");const qP=(o1+"").trim();nh.registerRenderer("gl",class extends s1{constructor(...r){super(...r),this.GeometryTypes=[Pn,Ns]}createPainter(){const r=Xn.get3DPainterClass("line-gradient");this.painterSymbol=Oe({},{lineGradientProperty:qP},Ap),this.pa(this.painterSymbol,r.getBloomSymbol());const t=Oe({},this.layer.options.sceneConfig||{});return t.depthMask===void 0&&(t.depthMask=!0),new r(this.regl,this.layer,this.painterSymbol,t,0)}buildMesh(){let{features:r,center:t}=this.Ro();if(r=r.filter(o=>!!o.properties[qP]),!r.length)return;const e=this.Co;this.xa=t;const n=Oe({},this.painterSymbol),i=this.createMesh(this.painter,Hd,n,r,null,t);this.ua=!0,i.then(o=>{this.meshes&&this.painter.deleteMesh(this.meshes);const s=[],a=o&&o.meshes;if(a){s.push(...a);for(let l=0;l<a.length;l++)a[l].feaGroupIndex=0,a[l].geometry.properties.originElements=a[l].geometry.properties.elements.slice()}this.meshes=s,e&&(this.Co=e),this.ua=!1,this.setToRedraw()})}}),nh.registerRenderer("canvas",null);class rc extends Xn{static fromJSON(t){return Sp(t,"PolygonLayer",rc)}}rc.registerJSONType("PolygonLayer");const a1={polygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_polygonFill"},polygonPatternFile:{type:"identity",default:void 0,property:"_symbol_polygonPatternFile"},polygonOpacity:{type:"identity",default:1,property:"_symbol_polygonOpacity"},uvScale:{type:"identity",default:[1,1],property:"_symbol_uvScale"},uvOffset:{type:"identity",default:[0,0],property:"_symbol_uvOffset"},uvOffsetInMeter:{type:"identity",default:!1,property:"_symbol_uvOffsetInMeter"},polygonPatternFileWidth:{type:"identity",default:void 0,property:"_symbol_polygonPatternFileWidth"},polygonPatternFileHeight:{type:"identity",default:void 0,property:"_symbol_polygonPatternFileHeight"},polygonPatternFileOrigin:{type:"identity",default:void 0,property:"_symbol_polygonPatternFileOrigin"},polygonPatternUV:{type:"identity",default:void 0,property:"_symbol_polygonPatternUV"}};class JP extends s1{constructor(){super(...arguments),this.GeometryTypes=[_n,Bs]}getPolygonOffsetCount(){return this.options.altitude>0?0:2}buildMesh(t){const{features:e,center:n}=this.Ro();if(!e.length)return;const i=this.Co;this.xa=n;const o=this.va(e),s=Oe({},a1),a=o.map((l,h)=>this.createMesh(this.painter,nC,s,l,t&&t[h],n));this.ua=!0,Promise.all(a).then(l=>{this.meshes&&this.painter.deleteMesh(this.meshes),l=function(c){const f=[];for(let d=0;d<c.length;d++)Array.isArray(c[d])?f.push(...c[d]):f.push(c[d]);return f}(l);const h=[],u=[];for(let c=0;c<l.length;c++){const f=l[c]&&l[c].meshes;if(f){h.push(...f);for(let d=0;d<f.length;d++)f[d].feaGroupIndex=c,f[d].geometry.properties.originElements=f[d].geometry.properties.elements.slice(),c===1&&(f[d].transparent=!0);u[c]=l[c].atlas}}this.meshes=h,this.atlas=u,i&&(this.Co=i),this.ua=!1,this.setToRedraw(),this.layer.fire("buildmesh")})}getRayCastData(t,e){const n=this.painter.getRayCastData(t,e);if(!n||!n.feature)return null;const i=n.feature[Yn];return this.uo[i]}va(t){const e=[],n=[];for(let i=0;i<t.length;i++){const o=t[i];o.properties&&o.properties._symbol_polygonOpacity<1?n.push(o):e.push(o)}return[e,n]}createPainter(){const t=Xn.get3DPainterClass("fill"),e=this.painterSymbol=Oe({},a1);return this.pa(e,t.getBloomSymbol()),new t(this.regl,this.layer,e,this.layer.options.sceneConfig,0)}updateMesh(t){return this.ta(t,this.meshes,this.atlas,this.xa,this.painter,nC,a1,this.va)}}function OV(r,t,e,n,i,o,s){const a=e&&Array.isArray(e[0]);for(let l=0,h=e.length;l<h;l++){r[t]=(a?e[l][0]:e[l].x)*n,r[t+1]=(a?e[l][1]:e[l].y)*n,s!==Float32Array&&(r[t]=Math.round(r[t]),r[t+1]=Math.round(r[t+1]));let u=i||0;Array.isArray(i)&&(u=i[l]),u=u?Math.round(n*u):0,r[t+2]=u,t+=3}return r.trySetLength&&r.trySetLength(t),t}rc.registerRenderer("gl",JP),rc.registerRenderer("canvas",null);const KP=Math.PI/180,QP=6378137*Math.PI/180,kV=85.0511287798;function t3(r,t,e){return function(n,i){const o=kV,s=i[0],a=Math.max(Math.min(o,i[1]),-o);let l;return l=a===0?0:Math.log(Math.tan((90+a)*KP/2))/KP,n[0]=s*QP,n[1]=l*QP,n}(r,t)}function IV(r,t,e,n,i,o,s,a,l,h,u,c,f,d,p){r===0?function(g,m,y,x,v,_,w,b,A,T){const S=1/(100*_[0]),M=1/(100*_[1]),E=T&&T[0]||0,P=T&&T[1]||0,k=[0,0];for(let O=g;O<m;O+=3){const I=O/3*2,D=x[O]-E,z=x[O+1]-P;y[I]=k[0]+D/w*S/b,y[I+1]=k[1]-z/w*M/A}}(t,e,n,i,0,s,a,l,h,p):r===1&&function(g,m,y,x,v,_,w,b,A,T,S){if(!g)return;let M,E,P,k;g[4]===0?(M=g[0],E=g[1],P=g[2],k=g[3]):(M=g[1],E=g[2],P=g[3],k=g[0]);const O=mf(M,E),I=mf(E,P),D=[],z=[],L=[];for(let $=m;$<y;$+=3){const Z=$/3*2,j=(_.x/A+v[$]/w)*b,st=_.y/A*b+(S?v[$+1]:-v[$+1])/w*b;Pe(D,j,st),T!=="EPSG:4326"&&T!=="EPSG:4490"||t3(D,D),e3(z,D,M,E),e3(L,D,k,M),x[Z]=mf(M,z)/O,x[Z+1]=mf(M,L)/I}}(u,t,e,n,i,o,a,c,f,d,!!p)}function e3(r,t,e,n){const i=e[0]-n[0],o=e[1]-n[1];let s=(t[0]-e[0])*(e[0]-n[0])+(t[1]-e[1])*(e[1]-n[1]);return s/=i*i+o*o,r[0]=e[0]+s*i,r[1]=e[1]+s*o,r}function n3(r,t,e,n,i){const o=3*t[e-1],s=3*t[e-1]+1,a=r[o],l=r[s];return h=n,u=i,c=a,f=l,Math.sqrt((c-h)*(c-h)+(f-u)*(f-u));var h,u,c,f}function r3(r,t,e,n,i,o,s,a,l,h,u,c,f,d,p,g,m){const y=t.getLength(),x=i/3;for(let _=2,w=y;_<w;_+=3)r[i+_-2]=t[_-2],r[i+_-1]=t[_-1],r[i+_-0]=t[_]-s;i+=y;for(let _=2,w=y;_<w;_+=3)r[i+_-2]=t[_-2],r[i+_-1]=t[_-1],r[i+_-0]=t[_]-a;i+=y,r.trySetLength(i+y),r.copyWithin(i,i-2*y,i-y),i+=y,r.trySetLength(i+y),r.copyWithin(i,i-2*y,i-y),i+=y,(e=e||[]).push(y/3);const v=e.getLength();for(let _=0;_<v;_++)RV(x+(e[_-1]||0),x+e[_],r,y/3,l,n,h,u,c,f,o,d,p,g,m);return i}function RV(r,t,e,n,i,o,s,a,l,h,u,c,f,d,p){const g=o.getLength();let m,y;for(let x=r,v=t;x<v-1;x++)if(m=x,y=x+1,i===1/0&&((x-r)%2==1&&(m+=2*n,y+=2*n),p)){let _=o.currentIndex;o[_++]=m+n,o[_++]=y,o[_++]=m,o[_++]=y+n,o[_++]=y,o[_++]=m+n,o.currentIndex=_}s&&function(x,v,_,w,b,A,T,S,M,E,P,k){let O,I=0,D=0,z=0,L=0;const $=[1,3,4];for(let Z=A.getLength()-1;Z>=T;Z--){const j=A[Z],st=3*j+1,lt=3*j+2,rt=b[3*j],Rt=b[st],Ht=b[lt];I||D||(I=Math.max(b[lt],b[3*A[Z-3]+2]),D=Math.min(b[lt],b[3*A[Z-3]+2]),O=I-D);let ee=z;const nt=Z%6;x===0?(nt===5&&(L=n3(b,A,Z,rt,Rt)),ee=nt===$[0]||nt===$[1]||nt===$[2]?z:z+L):x===1&&(nt===$[0]||nt===$[1]||nt===$[2]?ee=0:(nt===5&&(L=n3(b,A,Z,rt,Rt)),ee=L));const Dt=ee/E*(1/(100*P))/S;let Vt;Vt=v===1?Ht===I?1:0:_==="bottom"?Ht===I?O/100/M:0:Ht===I?0:-O/100/M,w[2*j]=Dt,w[2*j+1]=Vt,nt===0&&(z+=L)}}(a,l,h,u,e,o,g,c[0],c[1],f,d)}function DV(r){const t=[r[0]];let e=r[0];for(let n=1;n<r.length;n++)Array.isArray(r[n])?r[n][0]===e[0]&&r[n][1]===e[1]&&r[n][2]===e[2]||t.push(r[n]):r[n].x===e.x&&r[n].y===e.y&&r[n].z===e.z||t.push(r[n]),e=r[n];return t}const Cp=Ur.getInstance();function FV(r,t,e,n,i,o,s,a,l,h,u,c,f,d,p,g){t.top===void 0&&(t.top=!0),t.side===void 0&&(t.side=!0),Cp.reset();const{altitudeScale:m,altitudeProperty:y,defaultAltitude:x,heightProperty:v,minHeightProperty:_,defaultHeight:w,tangent:b,uv:A,topUVMode:T,sideUVMode:S,sideVerticalUVMode:M,top:E,side:P,textureYOrigin:k,topThickness:O}=t,I=!!g,D=function(Dt,Vt,{altitudeScale:Ct,altitudeProperty:_e,defaultAltitude:Ie,heightProperty:Jt,minHeightProperty:Ne,defaultHeight:ce},{center:ke,side:qe,top:Re,topThickness:Je,uvOrigin:Le,uv:pn,uvSize:Tn,topUVMode:nr,sideUVMode:ln,sideVerticalUVMode:qn,textureYOrigin:hn,tileRatio:we,centimeterToPoint:Ze,verticalCentimeterToPoint:yn,positionType:rn,res:vr,glScale:ii,projectionCode:Jn},Mn,Dn){let Zr=Vt/Dt[0].extent;Zr=1;const Xr=Vt===1/0,Vn=Dn.get(),Yr=Dn.get(),Ji=Dn.get(),xr=Dn.getProxy(),rr=Dn.get(),Sn=Dn.get(),On=Dn.get(),Wo=!!pn,Zo=!!Re,vo=!!qe,Hr=Wo?Dn.get():null;function xo(mt,ot,vt,Ot,Pt,Wt){let St=ot;if(Zo){const Bt=md(xr,vt,3);if(Bt.length===0)return ot;let Q=xr.getLength(),ht=rr.currentIndex;for(let ct=0;ct<Q;ct++)rr[ht++]=xr[ct];if(rr.currentIndex=ht,ot+=xr.getLength(),Wt)for(let ct=2,bt=Bt.length;ct<bt;ct+=3)Bt[ct]+=mt/3,Bt[ct-1]+=mt/3,Bt[ct-2]+=mt/3;Q=Bt.length,ht=Sn.currentIndex;for(let ct=0;ct<Q;ct++)Sn[ht++]=Bt[ct];Sn.currentIndex=ht,Wo&&IV(nr||0,mt,ot,Hr,rr,Le,Ze,we,Tn[0],Tn[1],Pt,vr,ii,Jn,ke),Je>0&&!vo&&(ot=r3(rr,xr,vt,Sn,ot,Hr,0,Je,Vt,Wo,ln||0,qn||0,hn,Tn,we,yn,Wt)),On.setLength(ot/3),On.fill(1,St/3,ot/3)}if(vo){Zo&&(Je=0),St=ot,ot=r3(rr,xr,vt,Sn,ot,Hr,Je,Ot,Vt,Wo,ln||0,qn||0,hn,Tn,we,yn,Wt),On.setLength(ot/3);const Bt=xr.getLength()/3;On.fill(1,St/3,St/3+Bt),On.fill(0,St/3+Bt,St/3+2*Bt),On.fill(1,St/3+2*Bt,St/3+3*Bt),On.fill(0,St/3+3*Bt,ot/3)}return ot}let oi=0,Pr=0,Ki=0,ac=Dt.length;Bl(Mn)&&(Ki=Mn,ac=Mn+1);let pa=0,Op=!1;const C=Dn.getProxy();for(;Ki<ac;Ki++){const mt=Dt[Ki],ot=mt.id;Bl(ot)&&(Math.abs(ot)>pa&&(pa=Math.abs(ot)),ot<0&&(Op=!0));const vt=mt.geometry,Ot=mt.properties[qd];let Pt=Array.isArray(Ot&&Ot[0]&&Ot[0][0])?Ot[0]:Ot;const{altitude:Wt,height:St}=Lr.getFeaAltitudeAndHeight(mt,Ct,_e,Ie,Jt,ce,Ne);oi=Math.max(Math.abs(Wt),oi);const Bt=rr.getLength();let Q=0,ht=Pr;C.setLength(0),xr.setLength(0);const ct=Lr.calculateSignedArea(vt[0])<0;for(let gt=0,Y=vt.length;gt<Y;gt++){let dt=vt[gt];ct&&(dt=dt.reverse()),dt=DV(dt);const _t=Lr.calculateSignedArea(dt)<0;if(!_t&&gt>0&&(Q++,Pt=Ot&&Ot[Q],Pr=xo(ht,Pr,C,St*Zr,Pt,Xr),xr.setLength(0),C.setLength(0),ht=Pr),!dt.length){gt===Y-1&&(Pr=xo(ht,Pr,C,St*Zr,Pt,Xr));continue}const yt=dt.length;if(Array.isArray(dt[0])?dt[0][0]===dt[yt-1][0]&&dt[0][1]===dt[yt-1][1]||dt.push([dt[0][0],dt[0][1]]):dt[0].x===dt[yt-1].x&&dt[0].y===dt[yt-1].y||dt.push(dt[0]),_t){let ae=C.currentIndex;C[ae++]=xr.getLength()/3,C.currentIndex=ae}OV(xr,xr.getLength(),dt,Zr,Wt,0,rn),gt===Y-1&&(Pr=xo(ht,Pr,C,St*Zr,Pt,Xr))}const bt=rr.getLength()-Bt,ft=(Yd+"").trim();for(let gt=0;gt<bt/3;gt++){let Y=Yr.currentIndex;Yr[Y++]=mt[ft]===void 0?Ki:mt[ft],Yr.currentIndex=Y,Y=Vn.currentIndex,Vn[Y++]=Ki,Vn.currentIndex=Y,Bl(ot)&&(Y=Ji.currentIndex,Ji[Y++]=ot,Ji.currentIndex=Y)}}const V=Lr.getUnsignedArrayType(Yr.getLength()?Yr[Yr.getLength()-1]:0),J={maxAltitude:oi,vertices:rr,verticeTypes:On,indices:Sn,pickingIds:Ur.createTypedArray(Yr,V),featureIndexes:Vn};if(Ji.getLength()){const mt=Op?Lr.getPosArrayType(pa):Lr.getUnsignedArrayType(pa);J.featureIds=Ur.createTypedArray(Ji,mt)}else J.featureIds=[];return Hr&&(Hr.setLength(rr.getLength()/3*2),J.uvs=Hr),J}(r,e,{altitudeScale:m,altitudeProperty:y,defaultAltitude:x||0,heightProperty:v,minHeightProperty:_,defaultHeight:w||0},{center:g,top:E,side:P,topThickness:10*O||0,uv:A||b,uvSize:[i,i],uvOrigin:n,topUVMode:T,sideUVMode:S,sideVerticalUVMode:M,textureYOrigin:k,tileRatio:a,centimeterToPoint:l,verticalCentimeterToPoint:h,positionType:p,res:o,glScale:s,projectionCode:f},d,Cp),z=[],L=D.vertices.getLength()/3,$=Lr.getIndexArrayType(L),Z=Ur.createTypedArray(D.indices,$);delete D.indices,z.push(Z.buffer,D.pickingIds.buffer);const j=p||Lr.getPosArrayType(Math.max(512,D.maxAltitude));D.vertices=Ur.createTypedArray(D.vertices,j);const st=b?Cp.getProxy():new Float32Array(3*L);st.setLength&&st.setLength(3*L);const lt=Sw(D.vertices,Z,st);let rt=!0;const Rt=lt.getLength?lt.getLength():lt.length;for(let Dt=0;Dt<Rt;Dt++){I||(lt[Dt]=-lt[Dt]);const Vt=lt[Dt]%1;1-Math.abs(Vt)>1e-6?rt=!1:Vt!==0&&(lt[Dt]=Math.round(lt[Dt]))}if(D.normals=lt,b){let Dt=Cp.get();Dt.setLength(4*L),Dt=Ow(D.vertices,D.normals,D.uvs,Z,Dt),Dt=function(Vt,Ct){const _e=Ct.getLength(),Ie=new Float32Array(_e),Jt=[],Ne=[],ce=[];for(let ke=0;ke<_e;ke+=4){const qe=ke/4*3;ie(Ne,Vt[qe]||0,Vt[qe+1]||0,Vt[qe+2]||0),Tr(Jt,Ct[ke]||0,Ct[ke+1]||0,Ct[ke+2]||0,Ct[ke+3]||0),Mw(ce,Ne,Jt),pf(Ie.subarray(ke,ke+4),ce)}return Ie}(D.normals,Dt),D.tangents=Dt,z.push(Dt.buffer),delete D.normals}if(D.normals&&(rt&&(D.normals=Ur.createTypedArray(D.normals,Int8Array)),z.push(D.normals.buffer)),D.uvs){const Dt=D.uvs;D.uvs=Ur.createTypedArray(Dt,Float32Array),z.push(D.uvs.buffer)}if(g){const Dt=D.vertices,Vt=Dt.length;for(let Ct=0;Ct<Vt;Ct+=3)Dt[Ct]-=g[0],Dt[Ct+1]-=g[1]}const Ht=function(Dt,Vt,Ct,_e){const Ie={},Jt={},Ne=_e.getLength();if(Xd(Vt.polygonFill)){let ce=cn(Vt.polygonFill);const ke=new Uint8Array(4*Ne);ke.fill(255);for(let qe=0;qe<Ne;qe++){const Re=Dt[_e[qe]],Je=Re.properties||{};Je.$layer=Re.layer,Je.$type=Re.type;let Le=ce(Ct,Je);Ft(Le)&&(Ie.aColor=1,ce=cn(Le),Le=ce(Ct,Je)),delete Je.$layer,delete Je.$type,Ml.normalizeColor(yo,Le),ke[4*qe]=yo[0],ke[4*qe+1]=yo[1],ke[4*qe+2]=yo[2],ke[4*qe+3]=yo[3]}Jt.aColor=ke}if(Xd(Vt.polygonOpacity)){let ce=le(Vt.polygonOpacity);const ke=new Uint8Array(Ne);ke.fill(255);for(let qe=0;qe<Ne;qe++){const Re=Dt[_e[qe]],Je=Re.properties||{};Je.$layer=Re.layer,Je.$type=Re.type;let Le=ce(Ct,Je);Ft(Le)&&(Ie.aOpacity=1,ce=cn(Le),Le=ce(Ct,Je)),delete Je.$layer,delete Je.$type,ke[qe]=255*Le}Jt.aOpacity=ke}return Jt.dynamicAttributes=Ie,Jt}(r,u,c,D.featureIndexes),ee=function(Dt,Vt,Ct,_e,Ie){const Jt=[[],[]],Ne=Xd(_e.topPolygonFill),ce=Xd(_e.bottomPolygonFill),ke=[255,255,255,255],qe=Vt.getLength();if(Ne||ce){let Re=Ne&&cn(_e.topPolygonFill),Je=ce&&cn(_e.bottomPolygonFill),Le=null,pn=null,Tn=null,nr=null;for(let ln=0;ln<qe;ln++){if(Dt[ln]===1&&!Ne||Dt[ln]===0&&!ce)continue;const qn=Dt[ln]===1;if(qn&&Vt[ln]===Le){Dt[ln]=Tn;continue}if(!qn&&Vt[ln]===pn){Dt[ln]=nr;continue}const hn=Ct[Vt[ln]],we=hn.properties||{};we.$layer=hn.layer,we.$type=hn.type;let Ze=qn?Re:Je,yn=Ze(Ie,we);Ft(yn)&&(Ze=cn(yn),yn=Ze(Ie,we)),delete we.$layer,delete we.$type,Ml.normalizeColor(yo,yn),e4(yo,yo,ke);let rn=LV(Jt,yo);rn<0&&(rn=Jt.length,Jt.push(pf([],yo))),Dt[ln]=rn,qn?(Le=Vt[ln],Tn=rn):(pn=Vt[ln],nr=rn)}}return Jt.slice(2)}(D.verticeTypes,D.featureIndexes,r,u,c),nt={data:{data:{aVertexColorType:ee.length<=252?Ur.createTypedArray(D.verticeTypes,Uint8Array):Ur.createTypedArray(D.verticeTypes,Uint16Array),aPosition:D.vertices,aNormal:D.normals,aTexCoord0:D.uvs,aTangent:D.tangents,aPickingId:D.pickingIds},indices:Z,properties:{maxAltitude:D.maxAltitude},dynamicAttributes:Ht.dynamicAttributes,vertexColors:ee},buffers:z};return D.featureIds.length?(nt.data.featureIds=D.featureIds,z.push(nt.data.featureIds.buffer)):nt.data.featureIds=[],Ht.aColor&&(nt.data.data.aColor=Ht.aColor,nt.buffers.push(Ht.aColor.buffer)),Ht.aOpacity&&(nt.data.data.aOpacity=Ht.aOpacity,nt.buffers.push(Ht.aOpacity.buffer)),nt.buffers.push(nt.data.data.aPosition.buffer),nt.data.pickingIdIndiceMap=Lr.generatePickingIndiceIndex(nt.data.data.aPickingId,nt.data.indices),nt}const yo=[];function LV(r,t){for(let e=0;e<r.length;e++)if(r4(t,r[e]))return e;return-1}class zV{constructor(t=[],e=HV){if(this.data=t,this.length=this.data.length,this.compare=e,this.length>0)for(let n=(this.length>>1)-1;n>=0;n--)this.ba(n)}push(t){this.data.push(t),this.length++,this.Aa(this.length-1)}pop(){if(this.length===0)return;const t=this.data[0],e=this.data.pop();return this.length--,this.length>0&&(this.data[0]=e,this.ba(0)),t}peek(){return this.data[0]}Aa(t){const{data:e,compare:n}=this,i=e[t];for(;t>0;){const o=t-1>>1,s=e[o];if(n(i,s)>=0)break;e[t]=s,t=o}e[t]=i}ba(t){const{data:e,compare:n}=this,i=this.length>>1,o=e[t];for(;t<i;){let s=1+(t<<1),a=e[s];const l=s+1;if(l<this.length&&n(e[l],a)<0&&(s=l,a=e[l]),n(a,o)>=0)break;e[t]=a,t=s}e[t]=o}}function HV(r,t){return r<t?-1:r>t?1:0}var l1={exports:{}},i3=function(r,t,e,n){var i=r[0],o=r[1],s=!1;e===void 0&&(e=0),n===void 0&&(n=t.length);for(var a=(n-e)/2,l=0,h=a-1;l<a;h=l++){var u=t[e+2*l+0],c=t[e+2*l+1],f=t[e+2*h+0],d=t[e+2*h+1];c>o!=d>o&&i<(f-u)*(o-c)/(d-c)+u&&(s=!s)}return s},o3=function(r,t,e,n){var i=r[0],o=r[1],s=!1;e===void 0&&(e=0),n===void 0&&(n=t.length);for(var a=n-e,l=0,h=a-1;l<a;h=l++){var u=t[l+e][0],c=t[l+e][1],f=t[h+e][0],d=t[h+e][1];c>o!=d>o&&i<(f-u)*(o-c)/(d-c)+u&&(s=!s)}return s};l1.exports=function(r,t,e,n){return t.length>0&&Array.isArray(t[0])?o3(r,t,e,n):i3(r,t,e,n)};var NV=l1.exports.nested=o3;l1.exports.flat=i3;const s3=11102230246251565e-32,zr=134217729,BV=(3+8*s3)*s3;function h1(r,t,e,n,i){let o,s,a,l,h=t[0],u=n[0],c=0,f=0;u>h==u>-h?(o=h,h=t[++c]):(o=u,u=n[++f]);let d=0;if(c<r&&f<e)for(u>h==u>-h?(s=h+o,a=o-(s-h),h=t[++c]):(s=u+o,a=o-(s-u),u=n[++f]),o=s,a!==0&&(i[d++]=a);c<r&&f<e;)u>h==u>-h?(s=o+h,l=s-o,a=o-(s-l)+(h-l),h=t[++c]):(s=o+u,l=s-o,a=o-(s-l)+(u-l),u=n[++f]),o=s,a!==0&&(i[d++]=a);for(;c<r;)s=o+h,l=s-o,a=o-(s-l)+(h-l),h=t[++c],o=s,a!==0&&(i[d++]=a);for(;f<e;)s=o+u,l=s-o,a=o-(s-l)+(u-l),u=n[++f],o=s,a!==0&&(i[d++]=a);return o===0&&d!==0||(i[d++]=o),d}function ic(r){return new Float64Array(r)}const jV=33306690738754716e-32,VV=22204460492503146e-32,GV=11093356479670487e-47,rh=ic(4),a3=ic(8),l3=ic(12),h3=ic(16),Wr=ic(4);function UV(r,t,e,n,i,o){const s=(t-o)*(e-i),a=(r-i)*(n-o),l=s-a;if(s===0||a===0||s>0!=a>0)return l;const h=Math.abs(s+a);return Math.abs(l)>=jV*h?l:-function(u,c,f,d,p,g,m){let y,x,v,_,w,b,A,T,S,M,E,P,k,O,I,D,z,L;const $=u-p,Z=f-p,j=c-g,st=d-g;O=$*st,b=zr*$,A=b-(b-$),T=$-A,b=zr*st,S=b-(b-st),M=st-S,I=T*M-(O-A*S-T*S-A*M),D=j*Z,b=zr*j,A=b-(b-j),T=j-A,b=zr*Z,S=b-(b-Z),M=Z-S,z=T*M-(D-A*S-T*S-A*M),E=I-z,w=I-E,rh[0]=I-(E+w)+(w-z),P=O+E,w=P-O,k=O-(P-w)+(E-w),E=k-D,w=k-E,rh[1]=k-(E+w)+(w-D),L=P+E,w=L-P,rh[2]=P-(L-w)+(E-w),rh[3]=L;let lt=function(nt,Dt){let Vt=Dt[0];for(let Ct=1;Ct<nt;Ct++)Vt+=Dt[Ct];return Vt}(4,rh),rt=VV*m;if(lt>=rt||-lt>=rt||(w=u-$,y=u-($+w)+(w-p),w=f-Z,v=f-(Z+w)+(w-p),w=c-j,x=c-(j+w)+(w-g),w=d-st,_=d-(st+w)+(w-g),y===0&&x===0&&v===0&&_===0)||(rt=GV*m+BV*Math.abs(lt),lt+=$*_+st*y-(j*v+Z*x),lt>=rt||-lt>=rt))return lt;O=y*st,b=zr*y,A=b-(b-y),T=y-A,b=zr*st,S=b-(b-st),M=st-S,I=T*M-(O-A*S-T*S-A*M),D=x*Z,b=zr*x,A=b-(b-x),T=x-A,b=zr*Z,S=b-(b-Z),M=Z-S,z=T*M-(D-A*S-T*S-A*M),E=I-z,w=I-E,Wr[0]=I-(E+w)+(w-z),P=O+E,w=P-O,k=O-(P-w)+(E-w),E=k-D,w=k-E,Wr[1]=k-(E+w)+(w-D),L=P+E,w=L-P,Wr[2]=P-(L-w)+(E-w),Wr[3]=L;const Rt=h1(4,rh,4,Wr,a3);O=$*_,b=zr*$,A=b-(b-$),T=$-A,b=zr*_,S=b-(b-_),M=_-S,I=T*M-(O-A*S-T*S-A*M),D=j*v,b=zr*j,A=b-(b-j),T=j-A,b=zr*v,S=b-(b-v),M=v-S,z=T*M-(D-A*S-T*S-A*M),E=I-z,w=I-E,Wr[0]=I-(E+w)+(w-z),P=O+E,w=P-O,k=O-(P-w)+(E-w),E=k-D,w=k-E,Wr[1]=k-(E+w)+(w-D),L=P+E,w=L-P,Wr[2]=P-(L-w)+(E-w),Wr[3]=L;const Ht=h1(Rt,a3,4,Wr,l3);O=y*_,b=zr*y,A=b-(b-y),T=y-A,b=zr*_,S=b-(b-_),M=_-S,I=T*M-(O-A*S-T*S-A*M),D=x*v,b=zr*x,A=b-(b-x),T=x-A,b=zr*v,S=b-(b-v),M=v-S,z=T*M-(D-A*S-T*S-A*M),E=I-z,w=I-E,Wr[0]=I-(E+w)+(w-z),P=O+E,w=P-O,k=O-(P-w)+(E-w),E=k-D,w=k-E,Wr[1]=k-(E+w)+(w-D),L=P+E,w=L-P,Wr[2]=P-(L-w)+(E-w),Wr[3]=L;const ee=h1(Ht,l3,4,Wr,h3);return h3[ee-1]}(r,t,e,n,i,o,h)}function $V(r,t,e){t=Math.max(0,t===void 0?2:t),e=e||0;var n=function(x){for(var v=x[0],_=x[0],w=x[0],b=x[0],A=0;A<x.length;A++){var T=x[A];T[0]<v[0]&&(v=T),T[0]>w[0]&&(w=T),T[1]<_[1]&&(_=T),T[1]>b[1]&&(b=T)}var S=[v,_,w,b],M=S.slice();for(A=0;A<x.length;A++)NV(x[A],S)||M.push(x[A]);return function(E){E.sort(YV);for(var P=[],k=0;k<E.length;k++){for(;P.length>=2&&ih(P[P.length-2],P[P.length-1],E[k])<=0;)P.pop();P.push(E[k])}for(var O=[],I=E.length-1;I>=0;I--){for(;O.length>=2&&ih(O[O.length-2],O[O.length-1],E[I])<=0;)O.pop();O.push(E[I])}return O.pop(),P.pop(),P.concat(O)}(M)}(r),i=new SC(16);i.toBBox=function(x){return{minX:x[0],minY:x[1],maxX:x[0],maxY:x[1]}},i.compareMinX=function(x,v){return x[0]-v[0]},i.compareMinY=function(x,v){return x[1]-v[1]},i.load(r);for(var o,s=[],a=0;a<n.length;a++){var l=n[a];i.remove(l),o=f3(l,o),s.push(o)}var h=new SC(16);for(a=0;a<s.length;a++)h.insert(u1(s[a]));for(var u=t*t,c=e*e;s.length;){var f=s.shift(),d=f.p,p=f.next.p,g=c1(d,p);if(!(g<c)){var m=g/u;(l=WV(i,f.prev.p,d,p,f.next.next.p,m,h))&&Math.min(c1(l,d),c1(l,p))<=m&&(s.push(f),s.push(f3(l,f)),i.remove(l),h.remove(f),h.insert(u1(f)),h.insert(u1(f.next)))}}f=o;var y=[];do y.push(f.p),f=f.next;while(f!==o);return y.push(f.p),y}function WV(r,t,e,n,i,o,s){for(var a=new zV([],ZV),l=r.data;l;){for(var h=0;h<l.children.length;h++){var u=l.children[h],c=l.leaf?f1(u,e,n):XV(e,n,u);c>o||a.push({node:u,dist:c})}for(;a.length&&!a.peek().node.children;){var f=a.pop(),d=f.node,p=f1(d,t,e),g=f1(d,n,i);if(f.dist<p&&f.dist<g&&c3(e,d,s)&&c3(n,d,s))return d}(l=a.pop())&&(l=l.node)}return null}function ZV(r,t){return r.dist-t.dist}function XV(r,t,e){if(u3(r,e)||u3(t,e))return 0;var n=Pp(r[0],r[1],t[0],t[1],e.minX,e.minY,e.maxX,e.minY);if(n===0)return 0;var i=Pp(r[0],r[1],t[0],t[1],e.minX,e.minY,e.minX,e.maxY);if(i===0)return 0;var o=Pp(r[0],r[1],t[0],t[1],e.maxX,e.minY,e.maxX,e.maxY);if(o===0)return 0;var s=Pp(r[0],r[1],t[0],t[1],e.minX,e.maxY,e.maxX,e.maxY);return s===0?0:Math.min(n,i,o,s)}function u3(r,t){return r[0]>=t.minX&&r[0]<=t.maxX&&r[1]>=t.minY&&r[1]<=t.maxY}function c3(r,t,e){for(var n,i,o,s,a=Math.min(r[0],t[0]),l=Math.min(r[1],t[1]),h=Math.max(r[0],t[0]),u=Math.max(r[1],t[1]),c=e.search({minX:a,minY:l,maxX:h,maxY:u}),f=0;f<c.length;f++)if(n=c[f].p,i=c[f].next.p,o=r,n!==(s=t)&&i!==o&&ih(n,i,o)>0!=ih(n,i,s)>0&&ih(o,s,n)>0!=ih(o,s,i)>0)return!1;return!0}function ih(r,t,e){return UV(r[0],r[1],t[0],t[1],e[0],e[1])}function u1(r){var t=r.p,e=r.next.p;return r.minX=Math.min(t[0],e[0]),r.minY=Math.min(t[1],e[1]),r.maxX=Math.max(t[0],e[0]),r.maxY=Math.max(t[1],e[1]),r}function f3(r,t){var e={p:r,prev:null,next:null,minX:0,minY:0,maxX:0,maxY:0};return t?(e.next=t.next,e.prev=t,t.next.prev=e,t.next=e):(e.prev=e,e.next=e),e}function c1(r,t){var e=r[0]-t[0],n=r[1]-t[1];return e*e+n*n}function f1(r,t,e){var n=t[0],i=t[1],o=e[0]-n,s=e[1]-i;if(o!==0||s!==0){var a=((r[0]-n)*o+(r[1]-i)*s)/(o*o+s*s);a>1?(n=e[0],i=e[1]):a>0&&(n+=o*a,i+=s*a)}return(o=r[0]-n)*o+(s=r[1]-i)*s}function Pp(r,t,e,n,i,o,s,a){var l,h,u,c,f=e-r,d=n-t,p=s-i,g=a-o,m=r-i,y=t-o,x=f*f+d*d,v=f*p+d*g,_=p*p+g*g,w=f*m+d*y,b=p*m+g*y,A=x*_-v*v,T=A,S=A;A===0?(h=0,T=1,c=b,S=_):(c=x*b-v*w,(h=v*b-_*w)<0?(h=0,c=b,S=_):h>T&&(h=T,c=b+v,S=_)),c<0?(c=0,-w<0?h=0:-w>x?h=T:(h=-w,T=x)):c>S&&(c=S,-w+v<0?h=0:-w+v>x?h=T:(h=-w+v,T=x));var M=(1-(u=c===0?0:c/S))*i+u*s-((1-(l=h===0?0:h/T))*r+l*e),E=(1-u)*o+u*a-((1-l)*t+l*n);return M*M+E*E}function YV(r,t){return r[0]===t[0]?r[1]-t[1]:r[0]-t[0]}class Ri{constructor(t,e){this.x=t,this.y=e}clone(){return new Ri(this.x,this.y)}normalize(){const t=this.length();this.x/=t,this.y/=t}negate(){this.x=-this.x,this.y=-this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}diff(t){return new Ri(this.x-t.x,this.y-t.y)}distance(t){const e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)}dot(t){return this.x*t.x+this.y*t.y}equals(t){return this.x===t.x&&this.y===t.y}orthogonal(){return new Ri(this.y,-this.x)}}function Ep(r,t,e,n){const i=t.x*n.y-t.y*n.x,o=e.x-r.x,s=e.y-r.y,a=(o*n.y-s*n.x)/i;return new Ri(r.x+a*t.x,r.y+a*t.y)}const oc=[],sc=[];function d3(r){if(Bl(r[0]&&r[0].x)){const t=[];let e=0;for(let n=0;n<r.length;n++)sc[e]?(sc[e][0]=r[n].x,sc[e][1]=r[n].y):sc[e]=[r[n].x,r[n].y],t.push(sc[e]),e++;r=t}try{const t=$V(r,1/0);let e=[1/0,1/0],n=[-1/0,-1/0];for(let c=0;c<t.length;c++)t[c][0]<e[0]&&(e[0]=t[c][0]),t[c][0]>n[0]&&(n[0]=t[c][0]),t[c][1]<e[1]&&(e[1]=t[c][1]),t[c][1]>n[1]&&(n[1]=t[c][1]);const i=[];let o=[],s=0;for(let c=0;c<t.length;c++)c===t.length-1&&t[c][0]===t[0][0]&&t[c][1]===t[0][1]||(t3(i,t[c]),oc[s]?(oc[s].x=i[0],oc[s].y=i[1]):oc[s]=new Ri(i[0],i[1]),o.push(oc[s]),s++);Lr.calculateSignedArea(o)<0&&(o=o.reverse());const a=function(c){let f,d=Number.MAX_VALUE;const p=function(P,k,O,I,D,z,L,$){var Z=Ep(P,k,D,z),j=Ep(O,I,D,z),st=Ep(L,$,P,k),lt=Ep(L,$,O,I),rt=Z.distance(j)*Z.distance(st);rt!==0&&rt<d&&(f=[Z,st,lt,j],d=rt)};var g=[];for(let P=0;P<c.length;P++)g.push(c[(P+1)%c.length].diff(c[P])),g[P].normalize();var m,y,x,v,_=new Ri(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),w=new Ri(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let P=0;P<c.length;P++){var b=c[P];b.x<_.x&&(_.x=b.x,m=P),b.x>w.x&&(w.x=b.x,y=P),b.y<_.y&&(_.y=b.y,v=P),b.y>w.y&&(w.y=b.y,x=P)}var A=new Ri(0,-1),T=new Ri(0,1),S=new Ri(-1,0),M=new Ri(1,0);for(let P=0;P<c.length;P++){var E=[Math.acos(A.dot(g[m])),Math.acos(T.dot(g[y])),Math.acos(S.dot(g[x])),Math.acos(M.dot(g[v]))];switch(E.indexOf(Math.min.apply(Math,E))){case 0:(T=(A=g[m].clone()).clone()).negate(),(M=(S=A.orthogonal()).clone()).negate(),m=(m+1)%c.length;break;case 1:(A=(T=g[y].clone()).clone()).negate(),(M=(S=A.orthogonal()).clone()).negate(),y=(y+1)%c.length;break;case 2:(M=(S=g[x].clone()).clone()).negate(),(T=(A=M.orthogonal()).clone()).negate(),x=(x+1)%c.length;break;case 3:(S=(M=g[v].clone()).clone()).negate(),(T=(A=M.orthogonal()).clone()).negate(),v=(v+1)%c.length}p(c[m],A,c[y],T,c[x],S,c[v],M)}return f}(o);if(!a||a.length!==4)return null;const l=a[0].distance(a[1]),h=a[1].distance(a[2]),u=a.map(c=>[c.x,c.y]);return u.push(+(h>l)),u}catch{return null}}class oh extends Xn{static fromJSON(t){return Sp(t,"ExtrudePolygonLayer",oh)}getPolygonOffsetCount(){return 0}getPolygonOffset(){return 0}onConfig(t){const e=this.getRenderer();return e&&e.onConfig(t),super.onConfig(t)}updateMaterial(t){this.options.material||(this.options.material={}),t?Oe(this.options.material,t):this.options.material=null;const e=this.getRenderer();return e&&e.updateMaterial(t),this}updateSideMaterial(t){let e=!1;this.options.sideMaterial||(this.options.sideMaterial={},e=!0),t?Oe(this.options.sideMaterial,t):this.options.sideMaterial=null;const n=this.getRenderer();return n&&(e&&n.wa(),n.updateSideMaterial(t)),this}updateDataConfig(t){if(!t)return this;this.options.dataConfig||(this.options.dataConfig={});const e=JSON.parse(JSON.stringify(this.options.dataConfig));Oe(this.options.dataConfig,t);const n=this.getRenderer();return n&&n.updateDataConfig(t,e),this}}oh.registerJSONType("ExtrudePolygonLayer"),oh.mergeOptions({cullFace:!1,castShadow:!0});const d1={polygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_polygonFill"},polygonOpacity:{type:"identity",default:1,property:"_symbol_polygonOpacity"},topPolygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_topPolygonFill"},bottomPolygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_bottomPolygonFill"}},p3={defaultAltitude:20},g3=r=>r.properties.top===1;if(oh.registerRenderer("gl",class extends JP{constructor(...r){super(...r),this.GeometryTypes=[_n,Bs]}va(r){return[r]}onConfig(r){this.painter&&(er(r.cullFace)||this.painter.updateSceneConfig({cullFace:r.cullFace}))}updateMaterial(r){this.painter&&(this.painter.qr(r),this.layer.options.sideMaterial||this.sidePainter.qr(r),this.setToRedraw())}wa(){this.sidePainter&&this.sidePainter.deleteMaterial()}updateSideMaterial(r){this.sidePainter&&(r?this.sidePainter.qr(r):(this.sidePainter.deleteMaterial(),this.sidePainter.qr(this.layer.options.material)),this.setToRedraw())}updateDataConfig(r,t){this.painter&&(this.painter.updateDataConfig(r,t),this.Zo())}updateBloom(r){super.updateBloom(r),this.sidePainter&&this.ya(this.sidePainter,this.sidePainterSymbol,r)}needCheckPointLineSymbols(){return!1}draw(r,t){return super.draw(r,t)}createPainter(){const r=Xn.get3DPainterClass("lit");this.painterSymbol=Oe({},d1),this.sidePainterSymbol=Oe({},d1),this.pa(this.painterSymbol,r.getBloomSymbol());const t=this.layer,e=Oe({},p3,t.options.dataConfig||{});t.options.material&&(this.painterSymbol.material=t.options.material),t.options.sideMaterial?this.sidePainterSymbol.material=t.options.sideMaterial:this.sidePainterSymbol.material=t.options.material;const n={cullFace:t.options.cullFace};Object.defineProperty(n,"castShadow",{enumerable:!0,get:()=>t.options.castShadow}),Object.defineProperty(n,"depthMask",{enumerable:!0,get:()=>t.options.depthMask});const i=Oe({},e);i.upsideUpTexture=!0;const o=new r(this.regl,t,this.painterSymbol,n,0,i);return this.sidePainter=new r(this.regl,t,this.sidePainterSymbol,n,0,e),o}Pt(...r){super.Pt(...r);const t=this.painter;this.painter=this.sidePainter,super.Pt(...r),this.painter=t}Do(...r){const t=r[0],e=t.sceneFilter;t.sceneFilter=s=>(!e||e(s))&&g3(s);const n=super.Do(...r);t.sceneFilter=s=>(!e||e(s))&&g3(s);const i=this.painter;this.painter=this.sidePainter;const o=t.sceneFilter=s=>(!e||e(s))&&(a=>a.properties.side===1)(s);return super.Do(...r),this.painter=i,t.sceneFilter=e,{redraw:n.redraw||o.redraw,drawCount:(n.drawCount||0)+(o.drawCount||0)}}createMesh(r,t,e,n,i,o){const s=[];this._a=o;const a=this.Sa(n,e,!0,!1),l=this.Sa(n,e,!1,!0);if(a){const h=this.No(a,r,t,e,n,null,o);h.meshes[0].properties.top=1,s.push(h)}if(l){const h=this.No(l,r,t,e,n,null,o);h.meshes[0].properties.side=1,s.push(h)}return s}Sa(r,t,e,n){const i=this.getMap();t=d1;const o=this._a,s=1/0,a=i.getZoom(),l=new W(0,0),h=new at(0,0),u=Oe({},p3,this.layer.options.dataConfig);if(u.uv=!0,u.top&&(u.top=e),u.side&&(u.side=n),u.top===!1&&u.side===!1||!r.length)return null;const c=i.getGLRes(),f=i.getProjection().code,d=e?this.painterSymbol&&this.painterSymbol.material:this.sidePainterSymbol&&this.sidePainterSymbol.material,p=d&&d.textureWidth||mC,g=[co(i,1,h,c)/100,co(i,1,h,c,1)/100];return FV(r,u,s,l,p,i.getGLRes(),1,1,g,this.St,t,a,f,void 0,Float32Array,o)}updateMesh(r){const t=r[Yn];let e=this.features[t];if(!e||!this.meshes)return;const n=this.Sa([e],this.painterSymbol,!0,!1);let i=0;n&&n.data&&this.ia(this.meshes[i++],e.id,n);const o=this.Sa([e],this.painterSymbol,!1,!0);o&&o.data&&this.ia(this.meshes[i++],e.id,o)}Jo(r){if(r.getProperties()||r.setProperties({}),!r.getProperties()[qd]){const t=r.getCoordinates();if(r instanceof Bs){const e=[];for(let n=0;n<t.length;n++){const i=t[n]&&t[n][0];e[n]=d3(i)}r.getProperties()[qd]=e}else{const e=d3(t[0]);r.getProperties()[qd]=e}}return super.Jo(r)}resizeCanvas(r){super.resizeCanvas(r),this.sidePainter&&this.sidePainter.resize(this.canvas.width,this.canvas.height)}onRemove(){super.onRemove(),this.sidePainter&&(this.sidePainter.delete(),delete this.sidePainter)}drawOutline(r){if(super.drawOutline(r),this.Et&&this.sidePainter&&this.sidePainter.outlineAll(r),this.ga)for(let t=0;t<this.ga.length;t++)this.sidePainter&&this.sidePainter.outline(r,this.ga[t])}getShadowMeshes(){return this.painter?this.painter.getShadowMeshes():[]}}),oh.registerRenderer("canvas",null),Df.register("vt_position_vert",`#ifdef HAS_TERRAIN_ALTITUDE
    attribute float aTerrainAltitude;
#endif
uniform float minAltitude;
#ifdef HAS_ALTITUDE
    vec3 unpackVTPosition() {
        float altitude = aAltitude;
        #ifdef HAS_TERRAIN_ALTITUDE
            altitude += aTerrainAltitude * 100.0;
        #endif
        altitude += minAltitude * 100.0;
        return vec3(aPosition, altitude);
    }
#else
    float position_modValue = 16384.0;
    float position_delta = 0.00001;
    vec3 unpackVTPosition() {
        float z = aPosition.z;
        vec2 pos = sign(aPosition.xy + position_delta) * mod(abs(aPosition.xy), position_modValue);
        vec2 highs = floor(abs(aPosition.xy) / position_modValue);
        float altitude = sign(z + position_delta) * (highs.x * 2.0 + highs.y) * pow(2.0, 15.0) + z;
        #ifdef HAS_TERRAIN_ALTITUDE
            altitude += aTerrainAltitude * 100.0;
        #endif
        altitude += minAltitude * 100.0;
        return vec3(pos, altitude);
    }
#endif`),jR(),ds){const r=xe.VERSION;if(r.indexOf("1.0.0-beta")>=0||r.indexOf("1.0.0-alpha")>=0){const t=ds.inject(yv);Rs("@maptalks/vt",t)}else Rs("@maptalks/vt",function(){return ds.inject(yv)})}else Rs("@maptalks/vt",yv);typeof console<"u"&&console.log("@maptalks/vt v0.96.4");const qV=xe,JV=En,KV=bn,QV=Pn,tG=ro,p1=Symbol("map-injection"),m3=Symbol("map-event"),g1=Symbol("map-server"),eG=Symbol("map-methods");var y3={exports:{}};(function(r){var t=Object.prototype.hasOwnProperty,e="~";function n(){}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(e=!1));function i(l,h,u){this.fn=l,this.context=h,this.once=u||!1}function o(l,h,u,c,f){if(typeof u!="function")throw new TypeError("The listener must be a function");var d=new i(u,c||l,f),p=e?e+h:h;return l._events[p]?l._events[p].fn?l._events[p]=[l._events[p],d]:l._events[p].push(d):(l._events[p]=d,l._eventsCount++),l}function s(l,h){--l._eventsCount===0?l._events=new n:delete l._events[h]}function a(){this._events=new n,this._eventsCount=0}a.prototype.eventNames=function(){var h=[],u,c;if(this._eventsCount===0)return h;for(c in u=this._events)t.call(u,c)&&h.push(e?c.slice(1):c);return Object.getOwnPropertySymbols?h.concat(Object.getOwnPropertySymbols(u)):h},a.prototype.listeners=function(h){var u=e?e+h:h,c=this._events[u];if(!c)return[];if(c.fn)return[c.fn];for(var f=0,d=c.length,p=new Array(d);f<d;f++)p[f]=c[f].fn;return p},a.prototype.listenerCount=function(h){var u=e?e+h:h,c=this._events[u];return c?c.fn?1:c.length:0},a.prototype.emit=function(h,u,c,f,d,p){var g=e?e+h:h;if(!this._events[g])return!1;var m=this._events[g],y=arguments.length,x,v;if(m.fn){switch(m.once&&this.removeListener(h,m.fn,void 0,!0),y){case 1:return m.fn.call(m.context),!0;case 2:return m.fn.call(m.context,u),!0;case 3:return m.fn.call(m.context,u,c),!0;case 4:return m.fn.call(m.context,u,c,f),!0;case 5:return m.fn.call(m.context,u,c,f,d),!0;case 6:return m.fn.call(m.context,u,c,f,d,p),!0}for(v=1,x=new Array(y-1);v<y;v++)x[v-1]=arguments[v];m.fn.apply(m.context,x)}else{var _=m.length,w;for(v=0;v<_;v++)switch(m[v].once&&this.removeListener(h,m[v].fn,void 0,!0),y){case 1:m[v].fn.call(m[v].context);break;case 2:m[v].fn.call(m[v].context,u);break;case 3:m[v].fn.call(m[v].context,u,c);break;case 4:m[v].fn.call(m[v].context,u,c,f);break;default:if(!x)for(w=1,x=new Array(y-1);w<y;w++)x[w-1]=arguments[w];m[v].fn.apply(m[v].context,x)}}return!0},a.prototype.on=function(h,u,c){return o(this,h,u,c,!1)},a.prototype.once=function(h,u,c){return o(this,h,u,c,!0)},a.prototype.removeListener=function(h,u,c,f){var d=e?e+h:h;if(!this._events[d])return this;if(!u)return s(this,d),this;var p=this._events[d];if(p.fn)p.fn===u&&(!f||p.once)&&(!c||p.context===c)&&s(this,d);else{for(var g=0,m=[],y=p.length;g<y;g++)(p[g].fn!==u||f&&!p[g].once||c&&p[g].context!==c)&&m.push(p[g]);m.length?this._events[d]=m.length===1?m[0]:m:s(this,d)}return this},a.prototype.removeAllListeners=function(h){var u;return h?(u=e?e+h:h,this._events[u]&&s(this,u)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=e,a.EventEmitter=a,r.exports=a})(y3);var nG=y3.exports;const rG=Us(nG),iG={class:"w-full h-full relative"},oG=Fe.createElementVNode("div",{id:"homemap",class:"w-full h-full relative"},null,-1),sG={__name:"VMap",props:{server:String,center:Array,zoom:Number},emits:["update:center","update:zoom","moveend","click"],setup(r,{emit:t}){const e=r,n=t,i=Fe.ref(),o=new rG,s=Fe.computed(()=>e.server),a=Fe.ref(!1);let l;function h(u){return l==null?void 0:l.addLayer(u)}return Fe.onMounted(()=>{l=new qV("homemap",{center:e.center,zoom:e.zoom}),l.on("click",u=>{const{coordinate:c}=u;o.emit("click",c),n("click",{coordinate:[c.x,c.y]})}),l.on("moveend",u=>{const{coordinate:c}=u;n("update:center",[c.x,c.y])}),i.value=l,a.value=!0}),Fe.watch(()=>e.center,u=>{l==null||l.setCenter(u)}),Fe.provide(p1,i),Fe.provide(m3,o),Fe.provide(g1,s),Fe.provide(eG,{addLayer:h}),(u,c)=>(Fe.openBlock(),Fe.createElementBlock("div",iG,[oG,a.value?Fe.renderSlot(u.$slots,"default",{key:0}):Fe.createCommentVNode("",!0)]))}};function aG(r){return r?JSON.parse(r):[]}function lG(r){const{markerFileType:t,markerFile:e,markerFileProp:n,markerFilePropList:i,...o}=r;return t==="rule"?{markerFile:{type:"categorical",property:n,stops:aG(i),default:e},...o}:{markerFile:e,...o}}function hG(r){return lG(r)}function uG({url:r,method:t,data:e}){return new Promise((n,i)=>{let o=null;e?o={...e}:o={};const s={method:t,headers:{"Content-Type":"application/json"}};t==="POST"&&o&&(s.body=JSON.stringify(o)),fetch(r,s).then(a=>a.json()).then(a=>{n(a)}).catch(a=>{i(a)})})}function v3(r){const t=Fe.ref(!1),e=Fe.ref(!1),n=Fe.inject(g1),i=Fe.ref(null);function o(){t.value=!1,e.value=!0,uG({url:`${n.value}${r.value}`,method:"GET"}).then(s=>{t.value=!0,e.value=!1,s.code===200&&s.data?i.value=s.data:i.value=null})}return{isFinished:t,isFetching:e,execute:o,data:i}}function cG(r){const t=Fe.inject(g1),e=Fe.ref(),n=Fe.ref(),{execute:i,data:o}=v3(e),{isFinished:s,execute:a,data:l}=v3(n),h=Fe.computed(()=>{var d;if((d=o.value)!=null&&d.style){const{symbol:p,filter:g,...m}=o.value.style;let y=g;return r.value instanceof Array&&r.value.length>0&&(y=r.value),{symbol:hG(p),filter:y,...m}}return null}),u=Fe.computed(()=>{if(o.value&&t.value){const{urlTemplate:d,zindex:p,...g}=o.value;return{features:!0,urlTemplate:`${t.value}${d}`,zIndex:p||1,...g}}return null});async function c(d){e.value=`/style/get/${d}`,i(),n.value=`/wfs/get/${d}`,a()}const f=Fe.computed(()=>h.value&&u.value?{...u.value,style:h.value}:null);return{queryLayer:c,layerOptions:f}}function x3(){const r=Fe.inject(p1),t=window.crypto.randomUUID();let e;function n(i){e||(e=new tG(t),r.value.addLayer(e)),i.addTo(e)}return{addVector:n}}function _3(){const r=Fe.inject(p1);function t(e){e&&r.value.addLayer(e)}return{addLayer:t}}const fG={name:"VVectorTileLayer",props:{id:{type:String,required:!0},urlTemplate:{type:String,required:!0},zIndex:{type:Number,default:1},style:{type:Object,default:()=>({})}},setup(r,t){const e=Fe.inject(m3),{addLayer:n}=_3();let i;function o(){r.id&&r.urlTemplate&&(i=new dn(r.id,{urlTemplate:r.urlTemplate,zIndex:r.zIndex,style:r.style,features:!0}),n(i))}function s(){i&&i.remove&&i.remove()}return Fe.onMounted(()=>{console.log(r),s(),o()}),Fe.onBeforeUnmount(()=>{s()}),Fe.watch(()=>r.style,a=>{i?i.setStyle(a):o()}),Fe.watch(()=>r.zIndex,a=>{i?i.setZIndex(a):o()}),e.on("click",a=>{if(i){const l=i.identify(a);l instanceof Array&&l.length>0&&t.emit("click",l)}}),()=>null}},dG={name:"VPubLayer",props:{id:String,filter:{type:Array,default:()=>[]}},setup(r,t){const e=Fe.computed(()=>r.filter),{queryLayer:n,layerOptions:i}=cG(e);Fe.onMounted(async()=>{await n(r.id)});function o(s){t.emit("click",s)}return()=>i.value?Fe.createVNode(fG,{id:r.id,urlTemplate:i.value.urlTemplate,zIndex:i.value.zIndex,style:i.value.style,onCreated:o},null):null}};function pG(r){return r?Object.keys(r).map(t=>`${t}=${r[t]}`).join("&"):""}const gG=["0","1","2","3","4","5","6","7"];function mG(r){const{layer:t,tileMatrixSet:e,tk:n,...i}=r;return`https://t{s}.tianditu.gov.cn/${t}_${e}/wmts?${pG({SERVICE:"WMTS",REQUEST:"GetTile",VERSION:"1.0.0",STYLE:"default",FORMAT:"tiles",TILEMATRIX:"{z}",TILECOL:"{x}",TILEROW:"{y}",tk:n,LAYER:t,TILEMATRIXSET:e,...i})}`}const yG={name:"VTiandituLayer",props:{type:String,tk:String,zIndex:Number},setup(r){const{addLayer:t}=_3();let e;const n=Fe.computed(()=>({type:r.type,tk:r.tk}));function i(){e&&(e.remove(),e=null)}function o(s){i(),e=new JV(`tianditu-${s.type}`,{urlTemplate:mG({layer:s.type,tileMatrixSet:"w",tk:s.tk}),subdomains:gG,zIndex:r.zIndex||0}),t(e)}return Fe.onMounted(()=>{o(n.value)}),Fe.onBeforeUnmount(()=>{e.remove()}),Fe.watch(n,s=>{o(s)}),Fe.watch(()=>r.zIndex,s=>{e==null||e.setZIndex(s)}),()=>null}},vG={name:"VMarker",props:{coor:Array,symbol:Object,properties:Object},setup(r,t){const{addVector:e}=x3();let n;return Fe.onMounted(()=>{n=new KV(r.coor,{symbol:r.symbol,properties:r.properties}),n.on("click",i=>{t.emit("click",i)}),e(n)}),Fe.onBeforeUnmount(()=>{n.remove()}),()=>null}},xG={name:"VLine",props:{coor:Array,symbol:Object},setup(r,t){const{addVector:e}=x3();let n;return Fe.onMounted(()=>{n=new QV(r.coor,{symbol:r.symbol}),n.on("click",i=>{t.emit("click",i)}),e(n)}),Fe.onBeforeUnmount(()=>{n.remove()}),()=>null}};Fi.VLine=xG,Fi.VMap=sG,Fi.VMarker=vG,Fi.VPubLayer=dG,Fi.VTiandituLayer=yG,Object.defineProperty(Fi,Symbol.toStringTag,{value:"Module"})});
